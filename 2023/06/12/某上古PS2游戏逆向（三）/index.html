<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"srpopty.github.io","root":"/","scheme":"Muse","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="一个Web狗针对某上古时期的PlayStation2游戏的逆向以及资源提取记录。">
<meta property="og:type" content="article">
<meta property="og:title" content="某上古 PS2 游戏逆向（三）游戏脚本初步分析与反编译">
<meta property="og:url" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/index.html">
<meta property="og:site_name" content="Shadow Gallery">
<meta property="og:description" content="一个Web狗针对某上古时期的PlayStation2游戏的逆向以及资源提取记录。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/17.jpg">
<meta property="og:image" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/19.jpg">
<meta property="og:image" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/20.jpg">
<meta property="og:image" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/21.jpg">
<meta property="og:image" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/22.jpg">
<meta property="og:image" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/31.jpg">
<meta property="og:image" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/29.jpg">
<meta property="og:image" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/30.jpg">
<meta property="og:image" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/32.jpg">
<meta property="og:image" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/33.jpg">
<meta property="og:image" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/34.jpg">
<meta property="og:image" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/35.jpg">
<meta property="og:image" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/36.jpg">
<meta property="og:image" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/37.jpg">
<meta property="og:image" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/38.jpg">
<meta property="og:image" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/40.jpg">
<meta property="og:image" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/41.jpg">
<meta property="og:image" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/42.jpg">
<meta property="article:published_time" content="2023-06-12T05:02:36.000Z">
<meta property="article:modified_time" content="2023-06-12T05:02:36.000Z">
<meta property="article:author" content="Srpopty">
<meta property="article:tag" content="ReverseEngineering">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/17.jpg">

<link rel="canonical" href="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>某上古 PS2 游戏逆向（三）游戏脚本初步分析与反编译 | Shadow Gallery</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Shadow Gallery" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Shadow Gallery</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Live in the shadow</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-knowledge">

    <a href="/knowledge/" rel="section"><i class="fa fa-fw fa-book"></i>知识库</a>

  </li>
        <li class="menu-item menu-item-life">

    <a href="/life/" rel="section"><i class="fa fa-fw fa-rocket"></i>随想</a>

  </li>
        <li class="menu-item menu-item-ctf">

    <a href="/ctf/" rel="section"><i class="fa fa-fw fa-flag"></i>ctf</a>

  </li>
        <li class="menu-item menu-item-vulnerabilities">

    <a href="/vulnerabilities/" rel="section"><i class="fa fa-fw fa-eye"></i>漏洞</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-fw fa-sitemap"></i>站点地图</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="search-pop-overlay">
  <div class="popup search-popup">
      <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

  </div>
</div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://srpopty.github.io/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Srpopty">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shadow Gallery">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          某上古 PS2 游戏逆向（三）游戏脚本初步分析与反编译
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-06-12 13:02:36" itemprop="dateCreated datePublished" datetime="2023-06-12T13:02:36+08:00">2023-06-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hack/" itemprop="url" rel="index"><span itemprop="name">Hack</span></a>
                </span>
            </span>

          
            <div class="post-description">一个Web狗针对某上古时期的PlayStation2游戏的逆向以及资源提取记录。</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="脚本代码分析"><a href="# 脚本代码分析" class="headerlink" title="脚本代码分析"></a>脚本代码分析 </h1><p> 接下来就是要提取出每个声音所对应的文本，当然文本也不是凭空冒出来的，一定在某个文件中保存着文本，并且需要靠程序逻辑判断哪个文本播放哪个音频。</p>
<p>游戏中主要在以下几个地方存在执行逻辑：主程序在 CD 根目录 <code>SLPS_258.97</code> 中，位于扩展库 <code>IOP</code> 目录下的各个 <code>.IRX</code> 中，这两个都是 32 位的 MIPS，就算用 Ghidra 反编译也不太好逆，此外在提取 <code>SYSTEM.BIN</code> 的时候发现里面存在某种脚本语言的代码，并且用 Shift-JIS 编码写日语注释，相较于二进制文件，先看一看从 <code>SYSTEM.BIN</code> 中提取的脚本都干了什么。利用前文中的提取脚本，提取出了以下几个文件：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">/Users/xxxxx/Desktop/xxxxx/SYSTEM_extracted</span><br><span class="line">├── 0_0_131e.dat</span><br><span class="line">├── 10_1f000_0.dat</span><br><span class="line">├── 11_1f000_8c5.dat</span><br><span class="line">├── 12_20000_1a60.dat</span><br><span class="line">├── 13_22000_1f01.dat</span><br><span class="line">├── 14_24000_56d1.dat</span><br><span class="line">├── 15_29800_306.dat</span><br><span class="line">├── 16_2a000_111d.dat</span><br><span class="line">├── 17_2b800_2dc.dat</span><br><span class="line">├── 18_2c000_1296.dat</span><br><span class="line">├── 19_2d800_4083.dat</span><br><span class="line">├── 1_1800_15e4.dat</span><br><span class="line">├── 20_32000_b12.dat</span><br><span class="line">├── 21_33000_4faa.dat</span><br><span class="line">├── 22_38000_114f.dat</span><br><span class="line">├── 23_39800_650.dat</span><br><span class="line">├── 24_3a000_f02.dat</span><br><span class="line">├── 25_3b000_8f7.dat</span><br><span class="line">├── 26_3c000_126e.dat</span><br><span class="line">├── 27_3d800_56f6.dat</span><br><span class="line">├── 28_43000_d330.dat</span><br><span class="line">├── 29_50800_288a.dat</span><br><span class="line">├── 2_3000_6f4.dat</span><br><span class="line">├── 30_53800_60e4.dat</span><br><span class="line">├── 31_5a000_c69.dat</span><br><span class="line">├── 32_5b000_8688.dat</span><br><span class="line">├── 33_63800_9d29.dat</span><br><span class="line">├── 34_6d800_796.dat</span><br><span class="line">├── 35_6e000_2821.dat</span><br><span class="line">├── 36_71000_527f6.dat</span><br><span class="line">├── 37_c3800_11bf5.dat</span><br><span class="line">├── 38_d5800_72ed.dat</span><br><span class="line">├── 39_dd000_21d0.dat</span><br><span class="line">├── 3_3800_4e02.dat</span><br><span class="line">├── 40_df800_22b8.dat</span><br><span class="line">├── 41_e2000_36f.dat</span><br><span class="line">├── 4_8800_7736.dat</span><br><span class="line">├── 5_10000_416e.dat</span><br><span class="line">├── 6_14800_1540.dat</span><br><span class="line">├── 7_16000_50ce.dat</span><br><span class="line">├── 8_1b800_27ed.dat</span><br><span class="line">└── 9_1e000_946.dat</span><br><span class="line"></span><br><span class="line">1 directory, 42 files</span><br></pre></td></tr></table></figure>

<p>首先看看 <code>0_0_131e.dat</code> 中的脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line">// XXX 画面サイズ定義</span><br><span class="line">SCWIDTH  &lt;- 640;</span><br><span class="line">SCHEIGHT &lt;- 448;</span><br><span class="line"></span><br><span class="line">EMPTY &lt;- &#123;&#125;; // 空の辞書</span><br><span class="line"></span><br><span class="line">savef &lt;- null; // ゲーム変数セーブ処理用</span><br><span class="line">f     &lt;- &#123;&#125;; // ゲーム変数</span><br><span class="line">sf    &lt;- &#123;&#125;; // システム変数</span><br><span class="line">tf    &lt;- &#123;&#125;; // テンポラリ変数</span><br><span class="line"></span><br><span class="line">variables    &lt;- null; // 変数情報</span><br><span class="line">voiceConfigs &lt;- null; // ボイスコンフィグ情報</span><br><span class="line">vconfigs &lt;- null;</span><br><span class="line"></span><br><span class="line">VAR_GAME   &lt;- 0;</span><br><span class="line">VAR_SYSTEM &lt;- 1;</span><br><span class="line">VAR_TEMP   &lt;- 2;</span><br><span class="line">VAR_SYSTEMWORK &lt;- 3;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 変数の初期化</span><br><span class="line"> * @param variables 変数情報</span><br><span class="line"> * @param zone 0: ゲーム変数 1: システム変数 2: テンポラリ</span><br><span class="line"> */</span><br><span class="line">function initVariables(variables, zone)</span><br><span class="line">&#123;</span><br><span class="line">    for (local i=0;i&lt;variables.len();i++) &#123;</span><br><span class="line">        local info = variables[i];</span><br><span class="line">        if (info.zone == zone) &#123;</span><br><span class="line">            switch (info.zone) &#123;</span><br><span class="line">            case VAR_SYSTEM:</span><br><span class="line">                sf[info.name] &lt;- 0;</span><br><span class="line">                break;</span><br><span class="line">            case VAR_TEMP:</span><br><span class="line">                tf[info.name] &lt;- 0;</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                f[info.name] &lt;- 0;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    savef = clone f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function storeVariables(variables, zone, ...)</span><br><span class="line">&#123;</span><br><span class="line">    local no = 0;</span><br><span class="line">    local store = null;</span><br><span class="line">    if (vargc &gt; 0) &#123;</span><br><span class="line">        no = vargv[0];</span><br><span class="line">        if (vargc &gt; 1) &#123;</span><br><span class="line">            store = vargv[1];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    initFlag(zone, no);</span><br><span class="line">    if (zone == VAR_SYSTEMWORK) &#123;</span><br><span class="line">        zone = VAR_SYSTEM;</span><br><span class="line">    &#125;</span><br><span class="line">    for (local i=0;i&lt;variables.len();i++) &#123;</span><br><span class="line">        local info = variables[i];</span><br><span class="line">        if (info.zone == zone) &#123;</span><br><span class="line">            local var;</span><br><span class="line">            switch (zone) &#123;</span><br><span class="line">            case VAR_GAME:</span><br><span class="line">                var = savef[info.name];</span><br><span class="line">                break;</span><br><span class="line">            case VAR_SYSTEM:</span><br><span class="line">                var = sf[info.name];</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            if (store != null) &#123;</span><br><span class="line">                store[info.name] &lt;- var;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                switch(info.type) &#123;</span><br><span class="line">                case 0: // 数値</span><br><span class="line">                    if (var != null) &#123;</span><br><span class="line">                        dm(&quot; セーブパラメータ：&quot; + info.name);</span><br><span class="line">                        setIntFlag(var.tointeger());</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        setIntFlag(0);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case 1: // 数値 2</span><br><span class="line">                    if (var != null) &#123;</span><br><span class="line">                        setFloatFlag(var.tofloat());</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        setFloatFlag(0);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case 2: // 文字列</span><br><span class="line">                    if (var != null) &#123;</span><br><span class="line">                        setStringFlag(var.tostring(), info.size);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        setStringFlag(&quot;&quot;, info.size);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function restoreVariables(variables, zone, ...)</span><br><span class="line">&#123;</span><br><span class="line">    local no = 0;</span><br><span class="line">    local store = null;</span><br><span class="line">    if (vargc &gt; 0) &#123;</span><br><span class="line">        no = vargv[0];</span><br><span class="line">        if (vargc &gt; 1) &#123;</span><br><span class="line">            store = vargv[1];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    initFlag(zone, no);</span><br><span class="line">    if (zone == VAR_SYSTEMWORK) &#123;</span><br><span class="line">        zone = VAR_SYSTEM;</span><br><span class="line">    &#125;</span><br><span class="line">    for (local i=0;i&lt;variables.len();i++) &#123;</span><br><span class="line">        local info = variables[i];</span><br><span class="line">        if (info.zone == zone) &#123;</span><br><span class="line">            local var;</span><br><span class="line">            switch(info.type) &#123;</span><br><span class="line">            case 0: // 数値</span><br><span class="line">                var = getIntFlag();</span><br><span class="line">                break;</span><br><span class="line">            case 1: // 数値 2</span><br><span class="line">                var = getFloatFlag();</span><br><span class="line">                break;</span><br><span class="line">            case 2: // 数値</span><br><span class="line">                var = getStringFlag(info.size);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            if (store != null) &#123;</span><br><span class="line">                store[info.name] &lt;- var;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                switch (zone) &#123;</span><br><span class="line">                case 0:</span><br><span class="line">                    savef[info.name] &lt;- var;</span><br><span class="line">                    break;</span><br><span class="line">                case 1:</span><br><span class="line">                    sf[info.name] &lt;- var;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function showVariables(variables, zone)</span><br><span class="line">&#123;</span><br><span class="line">    for (local i=0;i&lt;variables.len();i++) &#123;</span><br><span class="line">        local info = variables[i];</span><br><span class="line">        if (info.zone == zone) &#123;</span><br><span class="line">            local var;</span><br><span class="line">            switch (info.zone) &#123;</span><br><span class="line">            case VAR_GAME:</span><br><span class="line">                var = f[info.name];</span><br><span class="line">                break;</span><br><span class="line">            case VAR_SYSTEM:</span><br><span class="line">                var = sf[info.name];</span><br><span class="line">                break;</span><br><span class="line">            case VAR_TEMP:</span><br><span class="line">                var = tf[info.name];</span><br><span class="line">            &#125;</span><br><span class="line">            dm(&quot; 名前:&quot; + info.name + &quot; 値:&quot; + var);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// システムボイス情報</span><br><span class="line">sysvoices &lt;- dofile(&quot;sysvoices.nut&quot;);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * システムボイスの再生</span><br><span class="line"> */</span><br><span class="line">function systemVoice(name) &#123;</span><br><span class="line">    if (name in sysvoices) &#123;</span><br><span class="line">        Talk(0, sysvoices[name]);</span><br><span class="line">        return TalkLength(0);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function systemVoiceStop() &#123;</span><br><span class="line">    TalkStop(0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 初期化処理</span><br><span class="line">dofile(&quot;util.nut&quot;, true);</span><br><span class="line">dofile(&quot;Object.nut&quot;, true);</span><br><span class="line">dofile(&quot;BasicLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;msgwindow.nut&quot;, true);</span><br><span class="line">dofile(&quot;translayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;TEXTLAYER.NUT&quot;, true);</span><br><span class="line"></span><br><span class="line">dofile(&quot;action.nut&quot;, true);</span><br><span class="line">dofile(&quot;player.nut&quot;, true);</span><br><span class="line"></span><br><span class="line">dofile(&quot;GraphicLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;GamePlayer.nut&quot;, true);</span><br><span class="line"></span><br><span class="line">dofile(&quot;buttonlayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;dialogwindow.nut&quot;, true);</span><br><span class="line">dofile(&quot;selectwindow.nut&quot;, true);</span><br><span class="line"></span><br><span class="line">dofile(&quot;EnvObject.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvBase.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvImage.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvLevelLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvBackLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvStageLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvEventLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvSimpleLayer.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvCharacter.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvBGM.nut&quot;, true);</span><br><span class="line">dofile(&quot;EnvSE.nut&quot;, true);</span><br><span class="line">dofile(&quot;Environment.nut&quot;, true);</span><br><span class="line">dofile(&quot;ScenePlayer.nut&quot;, true);</span><br><span class="line"></span><br><span class="line">dofile(&quot;main.nut&quot;, true);</span><br><span class="line">dofile(&quot;game.nut&quot;, true);</span><br><span class="line">dofile(&quot;override.nut&quot;, true); // ゲーム個別の初期化処理を登録する</span><br><span class="line"></span><br><span class="line">function showGlobalInfos() &#123;</span><br><span class="line">    dm(&quot;------- スクリプト側でキャッシュされてる LAYER の画像情報 ------&quot;);</span><br><span class="line">    foreach (name,value in images) &#123;</span><br><span class="line">        dm(&quot;name:&quot; + name + &quot; value:&quot; + value);</span><br><span class="line">    &#125;</span><br><span class="line">    dm(&quot;------- アニメ情報一覧 -----------&quot;);</span><br><span class="line">    foreach (name,value in animeList) &#123;</span><br><span class="line">        dm(&quot;name:&quot; + name + &quot; value:&quot; + value);</span><br><span class="line">    &#125;</span><br><span class="line">    showMemoryInfo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有一串非常显眼的 <code>dofile</code>，并且参数包含了大量 <code>.nut</code> 结尾的文件，稍微 Google 一下可以发现这是 <code>Squirrel</code> 脚本。<code>Squirrel</code> 是一种面向对象的轻量级脚本语言，类似 Lua，常被用在游戏中。<code>Squirrel</code> 语言程序有两类，一类是 <code>.nut</code> 结尾的明文代码，另一类以 <code>.cnut</code> 结尾，类似 Python 的 <code>pyc</code> 文件，保存字节码，不过在 <code>Squirrel</code> 中这个操作不被称为“编译”，而被称为“序列化”，但是可惜的是 <code>Squirrel</code> 并没有提供反序列化这个操作，换句话说我们还是需要自己想办法将 <code>.cnut</code> 恢复成 <code>.nut</code> 文件。</p>
<p>基于此，我们将提取出的文件后缀改文 <code>.nut</code>。从 <code>SYSTEM.BIN</code> 中一共提取了 42 个文件，但是其中前 32 个都是明文代码，从第 33 个文件（32_5b000_8688.nut）到最后发现并不是明文，而是包含了大量二进制数据，其中夹杂着部分明文字符串。</p>
<p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/17.jpg" alt="Not Found"></p>
<p>实际上根据曾经逆向 <code>.pyc</code> 的经验，可以猜出这可能就是 <code>.cnut</code> 字节码文件，里面保存着一些符号。连续打开好几个这类文件，都可以看到很明显的特征：</p>
<ol>
<li><code>\xfa\xfaRIQS</code> 开头</li>
<li>包含了大量的 <code>TRAP</code> 字符串</li>
<li>开头会出现一个路径 <code>DataMake/xxx/xxx.nut</code></li>
</ol>
<p>根据这些特征也可以推断出这就是 <code>.cnut</code> 字节码文件。实际上 <code>.cnut</code> 是用小端存储的，<code>RIQS</code> 也就是 <code>SQIR</code> 是 <code>Squirrel</code> 的缩写，<code>TRAP</code> 也就是 <code>PART</code>，顾名思义是作为分隔符。</p>
<p>暂时先不管这些字节码，我们的目标是找到角色的语音文本，看了前 32 个脚本，在 <code>14_24000_56d1.nut</code> 中发现有一个 <code>playVoice</code> 函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * ボイス再生</span><br><span class="line"> * @param name キャラ名</span><br><span class="line"> * @param voicefile 再生ファイル</span><br><span class="line"> */</span><br><span class="line">function playVoice(name, voicefile) &#123;</span><br><span class="line">    if (isSkip() || !voiceenable) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    // ボイス情報取得</span><br><span class="line">    local configName = &quot;etc&quot;;</span><br><span class="line">    if (name in voiceConfigs) &#123;</span><br><span class="line">        configName = voiceConfigs[name];</span><br><span class="line">    &#125;</span><br><span class="line">    if (!getVoiceOn(configName)) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // ボリューム調整</span><br><span class="line">    // volume = getVoiceVolume(configName);</span><br><span class="line">    if (typeof voicefile == &quot;integer&quot;) &#123;</span><br><span class="line">        // ボイス再生処理</span><br><span class="line">        dm(&quot; ボイス再生:&quot; + voicefile);</span><br><span class="line">        Talk(0, voicefile);</span><br><span class="line">        talkVoiceLength = TalkLength(0);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        dm(&quot; ボイスが再生できない（コンバート時に存在していない）&quot; + voicefile);</span><br><span class="line">    &#125;</span><br><span class="line">    // 時間を返す</span><br><span class="line">    return talkVoiceLength;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中调用 <code>Talk(0, voicefile)</code> 猜测可能是让角色讲话，而 <code>voicefile</code> 是一个 int，应该就是从 <code>VOICE_ID.bin</code> 中提取出的声音文件的 id，<code>0</code> 代表什么暂时未知。可惜的是，在其他几个明文脚本中均未找到 <code>Talk</code> 函数的定义。根据 <code>playVoice</code> 函数注释（的翻译），<code>name</code> 参数表示角色名，<code>voicefile</code> 参数表示要播放的文件，但是最后影响 <code>Tlak</code> 函数的仅有 <code>voicefile</code>，而 <code>name</code> 仅用来判断该角色是否存在于 <code>voiceConfigs</code>。</p>
<p>首先我们先看一下 <code>playVoice</code> 从哪里会被调用，发现主要是在 <code>28_43000_d330.nut</code> 文件的 <code>playVoices</code> 中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 複数ボイスを鳴らす</span><br><span class="line"> * @return 最長のボイス再生時間</span><br><span class="line"> */</span><br><span class="line">function playVoices(voices) &#123;</span><br><span class="line">    local ret = null;</span><br><span class="line">    if (!isJump() &amp;&amp; voices != null) &#123;</span><br><span class="line">        foreach (name, info in voices) &#123;</span><br><span class="line">            local r;</span><br><span class="line">            // デフォルト名の場合の処理</span><br><span class="line">            if (isDefaultName() &amp;&amp; info.voicen != null) &#123;</span><br><span class="line">                r = playVoice(name, info.voicen);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                r = playVoice(name, info.voice);</span><br><span class="line">            &#125;</span><br><span class="line">            if (ret == null || r != null &amp;&amp; r &gt; ret) &#123;</span><br><span class="line">                    ret = r;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>playVoice</code> 中的 <code>voicefile</code> 来自 <code>playVoices</code> 中的 <code>voices</code>字典，也就是其参数，保存了多个 <code>(name, voicefile)</code> 键值对。这个函数仅在该文件中的 <code>playNextVoice</code> 被调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * ボイス再生実行</span><br><span class="line"> */</span><br><span class="line">function playNextVoice() &#123;</span><br><span class="line">    if (nextvoices != null) &#123;</span><br><span class="line">        local ret = playVoices(nextvoices);</span><br><span class="line">        clearNextVoice();</span><br><span class="line">        return ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>playVoices</code> 中的 <code>voices</code> 字典来自全局变量 <code>nexvoices</code>。接下来再找找 <code>nextvoices</code> 的写值操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// 次回再生するボイス情報</span><br><span class="line">// キー: キャラクタ名</span><br><span class="line">// 値: ボイス</span><br><span class="line">nextvoices = null;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 次回同時に鳴らすボイスの追加</span><br><span class="line"> * @param name キャラ名</span><br><span class="line"> * @param voice  ボイス指定</span><br><span class="line"> * @param voicen 非デフォルト時ボイス指定</span><br><span class="line"> */</span><br><span class="line">function entryNextVoice(name, voice, voicen) &#123;</span><br><span class="line">    if (name != null &amp;&amp; voice != null) &#123;</span><br><span class="line">        if (nextvoices == null) &#123;</span><br><span class="line">            nextvoices = &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        nextvoices[name] &lt;- &#123;voice=voice, voicen=voicen&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 次回鳴らすボイスの情報をクリア</span><br><span class="line"> */</span><br><span class="line">function clearNextVoice() &#123;</span><br><span class="line">    nextvoices = null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据注释，<code>nextvoices</code> 的作用是保存“下次播放的声音信息”，键为“角色名”，值为“声音”，并且仅在 <code>entryNextVoice</code> 中被写入，同时写入了 <code>voice</code> 也就是“语音指定”以及 <code>voicen</code> 也就是“非默认语音指定”两个信息，那么再找找哪里调用该函数写入接下来要播放的声音信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * ボイス追加</span><br><span class="line"> */</span><br><span class="line">function tag_entryvoice(elm) &#123;</span><br><span class="line">    entryNextVoice(elm.name, elm.voice, getval(elm, &quot;voicen&quot;));</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 名前表示</span><br><span class="line"> */</span><br><span class="line">function tag_dispname(elm) &#123;</span><br><span class="line">    // ...</span><br><span class="line">    </span><br><span class="line">    //dm(&quot; 名前表示ハンドラ &quot;);</span><br><span class="line">    if (elm == null || !(&quot;name&quot; in elm)  || elm.name == &quot;&quot;) &#123;</span><br><span class="line">        // ...</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        </span><br><span class="line">        local name = getval(elm, &quot;name&quot;);</span><br><span class="line">        local disp = getval(elm, &quot;disp&quot;);</span><br><span class="line">        </span><br><span class="line">        local ch = env.getCharacter(name, null);</span><br><span class="line">        env.currentNameTarget = ch;</span><br><span class="line">        if (&quot;voice&quot; in elm) &#123;</span><br><span class="line">            entryNextVoice(name, elm.voice, getval(elm, &quot;voicen&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">        // 名前の決定</span><br><span class="line">        // ...</span><br><span class="line">        </span><br><span class="line">        // 名前加工処理</span><br><span class="line">        // ...</span><br><span class="line">        </span><br><span class="line">        // 表情判定</span><br><span class="line">        // ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 名前表示</span><br><span class="line">    // ...</span><br><span class="line">    </span><br><span class="line">    // ボイス再生</span><br><span class="line">    if (nextvoices != null) &#123;</span><br><span class="line">        local ret = playNextVoice();</span><br><span class="line">        if (ret &gt; 0) &#123;</span><br><span class="line">            addAutoWait(ret);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样在 <code>28_43000_d330.nut</code> 文件中，有两个 <code>tag</code> 开头的函数：<code>tag_entryvoice</code> 以及 <code>tag_dispname</code>。可以看到 <code>name</code>，<code>voice</code> 以及 <code>voicen</code> 主要来自 <code>elm</code> 参数。</p>
<p>根据注释以及代码逻辑，<code>tag_entryvoice</code> 的作用是在某个时刻追加要播放的声音，而主要播放逻辑在 <code>tag_dispname</code> 中，首先调用 <code>entryNextVoice</code> 从 <code>elm</code> 中获取所有接下来要播放的声音添加到全局变量 <code>nextvoices</code> 中，之后以此处理名称，名称前缀以及表情等，最后再调用 <code>palyNextVoice</code> 播放这些声音，并且阻塞等待播放完毕。</p>
<p>这些 <code>tag</code> 开头的函数作为回调函数保存在同文件的 <code>getHandlers</code> 函数中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function getHandlers()</span><br><span class="line">&#123;</span><br><span class="line">    return &#123; // 辞書配列オブジェクト</span><br><span class="line">        // ...</span><br><span class="line">        //----------------------------------------------- ボイス制御</span><br><span class="line">        </span><br><span class="line">        entryvoice    = tag_entryvoice,</span><br><span class="line">        // ...</span><br><span class="line">        dispname      = tag_dispname,</span><br><span class="line">        // ...</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来找找哪里获取并调用了这几个回调函数。同样仅在 <code>28_43000_d330.nut</code> 中 <code>ScenePlayer</code> 类的构造函数 <code>constructor</code> 调用 <code>getHandlers</code> 获取所有回调函数保存在 <code>handlers</code> 中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * シーン再生プレイヤー</span><br><span class="line"> * ・シーンの再生機能</span><br><span class="line"> * ・シーンのセーブとロード</span><br><span class="line"> */</span><br><span class="line">class ScenePlayer extends GamePlayer</span><br><span class="line">&#123;</span><br><span class="line">    // ...</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * コンストラクタ</span><br><span class="line">     */</span><br><span class="line">    constructor() &#123;</span><br><span class="line">        ::GamePlayer.constructor();</span><br><span class="line">        pendings = [];</span><br><span class="line">        branches = [];</span><br><span class="line">        targetBranches = [];</span><br><span class="line">        env = Environment(this, SCWIDTH, SCHEIGHT);</span><br><span class="line">        if (&quot;nameImageMap&quot; in env.envinfo) &#123;</span><br><span class="line">            setNameImageMap(env.envinfo.nameImageMap);</span><br><span class="line">        &#125;</span><br><span class="line">        sceneInfos = dofile(&quot;scenes.nut&quot;);</span><br><span class="line">        handlers = getHandlers();</span><br><span class="line">        historyInit();</span><br><span class="line">        selectOption = &#123;&#125;;</span><br><span class="line">        caches = &#123;&#125;;</span><br><span class="line">        particles = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据注释，这个类是一个“场景再生播放器”，负责“场景的再生功能”以及“场景的保存和载入”，在日语中“再生”就是重放的意思，那么肯定是在这个类中根据场景的变换，播放文本以及对应的音频。实际上 <code>28_43000_d330.nut</code> 文件中的函数以及全局变量（类的静态变量）都属于这个类，包括 <code>playVoices</code>，<code>playNextVoice</code>，<code>nexvoices</code>，<code>entryNextVoice</code>，<code>tag_entryvoice</code>，<code>tag_dispname</code>，<code>getHandlers</code> 以及下面的 <code>onTag</code>。再找找哪里使用了 <code>handlers</code>，发现主要是在同文件同类下的 <code>onTag</code> 中。 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * タグの処理</span><br><span class="line"> */</span><br><span class="line">function onTag(elm) &#123;</span><br><span class="line">    local tagname = elm.tagname;</span><br><span class="line">    //dm(&quot; シーンタグ:&quot; + tagname);</span><br><span class="line">    if (tagname in handlers) &#123;</span><br><span class="line">        local handler = handlers[tagname];</span><br><span class="line">        local ret = handler(elm);</span><br><span class="line">        lastTagName = tagname;</span><br><span class="line">        return ret;</span><br><span class="line">    &#125;</span><br><span class="line">    // 無効なタグ</span><br><span class="line">    local ret = env.unknown(tagname, elm);</span><br><span class="line">    if (ret == null) &#123;</span><br><span class="line">        local msg = &quot; タグ / マクロ \&quot;&quot; + tagname + &quot;\&quot; は存在しません &quot;;</span><br><span class="line">        errorCmd(msg);</span><br><span class="line">        return 0;</span><br><span class="line">        //throw new Exception(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 <code>onTag</code> 可以发现 <code>elm</code> 中会保存 <code>tagname</code>，也就是对应的回调函数名称，而这个函数则就是调用 <code>elm</code> 指定的回调函数，并且回调参数固定为 <code>elm</code>。接下来再找找哪里调用了 <code>onTag</code>，也许就可以找到哪里给 <code>elm</code> 指定了回调函数，发现同样是在同文件同类下的一个非常大的函数 <code>run</code> 中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * メインロジック</span><br><span class="line"> */</span><br><span class="line">function run()    &#123;</span><br><span class="line">    local obj;</span><br><span class="line">    for(;;)    &#123;</span><br><span class="line"></span><br><span class="line">        // ロード復帰処理</span><br><span class="line">        if (targetPage != null) &#123;</span><br><span class="line">            // ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (pendings.len() &gt; 0) &#123;</span><br><span class="line">            // 後回しにされたタグがある場合</span><br><span class="line">            obj = pendings[0];</span><br><span class="line">            pendings.remove(0);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // 表示テキストがある場合の処理</span><br><span class="line">            if (currentText.len() &gt; 0) &#123;</span><br><span class="line">//                    if (isSkip()) &#123;</span><br><span class="line">//                        obj = &#123;tagname=&quot;ch2&quot;, text=currentText&#125;;</span><br><span class="line">//                        currentText = &quot;&quot;;</span><br><span class="line">//                    &#125; else &#123;</span><br><span class="line">                    if (iskanji(currentText)) &#123;</span><br><span class="line">                        local ch = currentText.slice(0,2);</span><br><span class="line">                        currentText = currentText.slice(2);</span><br><span class="line">                        obj = &#123;tagname=&quot;ch2&quot;, text=ch&#125;;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        local ch = currentText.slice(0,1);</span><br><span class="line">                        currentText = currentText.slice(1);</span><br><span class="line">                        obj = &#123;tagname=&quot;ch2&quot;, text=ch&#125;;</span><br><span class="line">                    &#125;</span><br><span class="line">//                    &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (cur &lt; lines.len()) &#123;</span><br><span class="line">                    obj = lines[cur++];</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    obj = null;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (obj == null) &#123;</span><br><span class="line">            // シナリオ終了</span><br><span class="line">            //dm(&quot; シナリオ終了 cur:&quot; + curStorage + &quot; next:&quot; + nextStorage) ;</span><br><span class="line">            local next = nextStorage;</span><br><span class="line">            if (next == null || next == 0) &#123;</span><br><span class="line">                next = getNextScene(curStorage);</span><br><span class="line">            &#125;                    </span><br><span class="line">            dm(&quot;next:&quot; + next);</span><br><span class="line">            if (next != null &amp;&amp; next != &quot;&quot; &amp;&amp; next != 0) &#123;</span><br><span class="line">                goToNext(next);</span><br><span class="line">                continue;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                status = STOP;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (obj.tagname == &quot;label&quot;) &#123; // ラベル処理</span><br><span class="line">            if (targetPage != null) &#123;</span><br><span class="line">                if (targetBranches.len() &gt; 0) &#123;</span><br><span class="line">                    if (obj.count != targetBranches[0]) &#123;</span><br><span class="line">                        goToCount(targetBranches[0]);</span><br><span class="line">                        continue;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        targetBranches.remove(0);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    // XXX ロード失敗</span><br><span class="line">                    dm(&quot; ロード失敗: ラベルの整合不良 &quot;);</span><br><span class="line">                    status = STOP;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            setReaded(curPage);    // 次のラベルに進む前に最後の行の既読をたてる</span><br><span class="line">            curCount = obj.count;</span><br><span class="line">            branches.append(curCount);</span><br><span class="line">            curPage = 0;</span><br><span class="line">            savePrepare();</span><br><span class="line">            continue;</span><br><span class="line">        &#125; else if (obj.tagname == &quot;begintrans&quot;) &#123;</span><br><span class="line">            //dm(&quot; 全体トランジションを処理 &quot;);</span><br><span class="line">            obj = null;</span><br><span class="line">            while (cur &lt; lines.len() &amp;&amp; (obj = lines[cur++]) != null &amp;&amp; obj.tagname != &quot;endtrans&quot;) &#123;</span><br><span class="line">                if (obj.tagname == &quot;begintrans&quot;) &#123;</span><br><span class="line">                    throw &quot;begintrans は入れ子にできません &quot;;</span><br><span class="line">                &#125;</span><br><span class="line">                pendings.append(obj);</span><br><span class="line">            &#125;</span><br><span class="line">            if (obj == null) &#123;</span><br><span class="line">                throw &quot;begintrans に対応する endtrans がありません &quot;;</span><br><span class="line">            &#125;</span><br><span class="line">            if (!isJump()) &#123;</span><br><span class="line">                local trans = null;</span><br><span class="line">                foreach (cmd, param in obj) &#123;</span><br><span class="line">                    if (cmd == &quot;tagname&quot;) &#123;</span><br><span class="line">                        // ignore</span><br><span class="line">                    &#125; else if (cmd == &quot;trans&quot;) &#123;</span><br><span class="line">                        local tr = getTrans(param, obj);</span><br><span class="line">                        if (tr != null) &#123;</span><br><span class="line">                            trans = tr;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; else if (cmd == &quot;fade&quot;) &#123;</span><br><span class="line">                        local time = param.tointeger();</span><br><span class="line">                        trans = &#123;</span><br><span class="line">                            method = &quot;crossfade&quot;,</span><br><span class="line">                            time = time &gt; 1 ? time : env.getFadeValue(),</span><br><span class="line">                        &#125;;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        local tr = getTrans(cmd, obj);</span><br><span class="line">                        if (tr != null) &#123;</span><br><span class="line">                            trans = tr;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                if (trans != null &amp;&amp; &quot;msgoff&quot; in trans) &#123;</span><br><span class="line">                    insertTag(&quot;msgoff&quot;, null);</span><br><span class="line">                &#125;</span><br><span class="line">                if (trans != null &amp;&amp; getval(trans, &quot;method&quot;) == &quot;layer&quot;) &#123;</span><br><span class="line">                    insertTag(&quot;_beginlt&quot;, trans);</span><br><span class="line">                    local e = &#123;&#125;;</span><br><span class="line">                    if (&quot;transwait&quot; in trans) &#123;</span><br><span class="line">                        e.wait &lt;- getint(trans, &quot;transwait&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (&quot;endtime&quot; in trans) &#123;</span><br><span class="line">                        e.time &lt;- getint(trans, &quot;endtime&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (&quot;endtype&quot; in trans) &#123;</span><br><span class="line">                        e.type &lt;- getval(trans, &quot;endtype&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (&quot;endrule&quot; in trans) &#123;</span><br><span class="line">                        e.rule &lt;- getval(trans, &quot;endrule&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    addTag(&quot;_endlt&quot;, e);</span><br><span class="line">                &#125; else if (trans != null) &#123;</span><br><span class="line">                    insertTag(&quot;_begintrans&quot;, null);</span><br><span class="line">                    addTag(&quot;_endtrans&quot;, &#123;trans=trans&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            continue;</span><br><span class="line">        &#125; else if (obj.tagname == &quot;ch&quot;) &#123;</span><br><span class="line">            doText(obj.text);</span><br><span class="line">            continue;</span><br><span class="line">        &#125; else if (obj.tagname == &quot;embex&quot;) &#123; // 変数埋め込みの参照</span><br><span class="line">            if (&quot;exp&quot; in obj) &#123;</span><br><span class="line">                local text = ::eval(obj.exp);</span><br><span class="line">                if (typeof text == &quot;string&quot;) &#123;</span><br><span class="line">                    doText(text);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            continue;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // その他のコマンド</span><br><span class="line">            </span><br><span class="line">            // 実行時判定される cond</span><br><span class="line">            if (&quot;condex&quot; in obj) &#123;</span><br><span class="line">                if (!::eval(obj.condex)) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                //delete obj.condex;</span><br><span class="line">            &#125; else if (&quot;if&quot; in obj) &#123;</span><br><span class="line">                if (!::eval(obj[&quot;if&quot;])) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                //delete obj[&quot;if&quot;];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // onTag を呼ぶ</span><br><span class="line">            local step = onTag(obj);</span><br><span class="line">            if (step == null) &#123;</span><br><span class="line">                throw &quot;onTag が null を返しました (&quot; + obj.tagname + &quot;)&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">            step = step.tointeger(); // step を数値に</span><br><span class="line">            //dm(obj.tagname + &quot; タグ戻り値:&quot; + step);</span><br><span class="line">            </span><br><span class="line">            if (step == 0) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            if (step &lt; 0) &#123;</span><br><span class="line">                switch(step) &#123;</span><br><span class="line">                case -5: // いったんイベントを処理(現在のタグは後回し)</span><br><span class="line">                    pendings.insert(0, obj);</span><br><span class="line">                    return;</span><br><span class="line">                case -4: // いったんイベントを処理</span><br><span class="line">                    return;</span><br><span class="line">                case -3: // 後回ししてブレーク</span><br><span class="line">                    pendings.insert(0, obj);</span><br><span class="line">                    updateBeforeCh = 1;</span><br><span class="line">                    return;</span><br><span class="line">                case -2: // ブレーク</span><br><span class="line">                    updateBeforeCh = 1;</span><br><span class="line">                    return;</span><br><span class="line">                case -1: // シナリオ終了</span><br><span class="line">                    status = STOP;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                waitTime(step, false);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数是一个巨大的无限循环 <code>for(;;)</code>，但是看起来循环存在多种退出逻辑，因此不一定是游戏主循环，根据类以及函数注释，该函数很有可能是一个场景下的的主要处理逻辑。</p>
<p>分析一下这个函数的逻辑，主要从 <code>onTag</code> 那一行开始看起，<code>onTag</code> 的参数 <code>elm</code> 也就是该函数中的 <code>obj</code>，在调用 <code>onTag</code> 前都是在生成 <code>obj</code>，之后调用 <code>onTag</code> 处理 <code>obj</code>，之后返回一个 <code>step</code> 来决定循环是否继续或者直接退出。</p>
<p>在大循环中，首先判断了一下 <code>targetPage</code>，根据游戏经验以及注释，这个 if 分支可能是快速推进剧本到 <code>targetPage</code>，也就是实现快进功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// ロード復帰処理</span><br><span class="line">if (targetPage != null) &#123;</span><br><span class="line">    if (targetBranches.len() == 0 &amp;&amp; curPage &gt;= targetPage) &#123;</span><br><span class="line">        dm(&quot; ジャンプ終了 &quot;);</span><br><span class="line">        savePrepare();</span><br><span class="line">        showVariables(variables, VAR_GAME);</span><br><span class="line">        targetPage = null;</span><br><span class="line">        // 画面復帰処理</span><br><span class="line">        insertTag(&quot;_endlt&quot;, &#123;time=1000&#125;);</span><br><span class="line">        insertTag(&quot;_sync&quot;, null);</span><br><span class="line">        // すぐマスク</span><br><span class="line">        beginLayerTrans(&#123;time=0&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后就是 <code>obj</code> 的生成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">if (pendings.len() &gt; 0) &#123;</span><br><span class="line">    // 後回しにされたタグがある場合</span><br><span class="line">    obj = pendings[0];</span><br><span class="line">    pendings.remove(0);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    // 表示テキストがある場合の処理</span><br><span class="line">    if (currentText.len() &gt; 0) &#123;</span><br><span class="line">//        if (isSkip()) &#123;</span><br><span class="line">//            obj = &#123;tagname=&quot;ch2&quot;, text=currentText&#125;;</span><br><span class="line">//            currentText = &quot;&quot;;</span><br><span class="line">//        &#125; else &#123;</span><br><span class="line">            if (iskanji(currentText)) &#123;</span><br><span class="line">                local ch = currentText.slice(0,2);</span><br><span class="line">                currentText = currentText.slice(2);</span><br><span class="line">                obj = &#123;tagname=&quot;ch2&quot;, text=ch&#125;;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                local ch = currentText.slice(0,1);</span><br><span class="line">                currentText = currentText.slice(1);</span><br><span class="line">                obj = &#123;tagname=&quot;ch2&quot;, text=ch&#125;;</span><br><span class="line">            &#125;</span><br><span class="line">//        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (cur &lt; lines.len()) &#123;</span><br><span class="line">            obj = lines[cur++];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            obj = null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果 <code>pendings</code> 队列非空则直接获取队首，否则生成新的，这里我们先关注生成。首先判断了 <code>currentText</code> 是否有值，根据变量名猜测这个可能就是当前要播放的文字，注释说该 if 分支表示“有显示文本时的处理”，在游戏大部分时候肯定都是有文字显示，那么进入该分支的频率可能会非常高。</p>
<p>如果 <code>currentText</code> 有值，则先判断 <code>iskanji</code>，日语中 kanji 是汉字的意思，实际上这里就是判断是否需要采用双字节编码。不管是否属于汉字，都将 <code>currentText</code> 的第一个字符切下来保存在 <code>obj.text</code> 中，<code>currentText</code> 保存剩下的，而此时 <code>tagname</code> 为 <code>ch2</code>也就是回调函数 <code>tag_ch</code>，很明显这不是我们想要的回调函数。如果 <code>currentText</code> 没有值，那么 <code>obj</code> 就可能会在 else 分支中来自 <code>lines</code> 数组，或者为 <code>null</code>。</p>
<p>看一下 <code>iskanji</code> 函数发现其实这里是将前一个句子结尾的标点符号截取出来，因此这里 <code>obj</code> 仅是为了处理一个标点字符而生成。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">// 行頭禁則</span><br><span class="line">kinsokuText &lt;- &#123;</span><br><span class="line">    [&quot;。&quot;] = true,</span><br><span class="line">    [&quot;，&quot;] = true,</span><br><span class="line">    [&quot;、&quot;] = true,</span><br><span class="line">    [&quot;．&quot;] = true,</span><br><span class="line">    [&quot;：&quot;] = true,</span><br><span class="line">    [&quot;；&quot;] = true,</span><br><span class="line">    [&quot; ゛ &quot;] = true,</span><br><span class="line">    [&quot; ゜ &quot;] = true,</span><br><span class="line">    [&quot; ヽ &quot;] = true,</span><br><span class="line">    [&quot; ヾ &quot;] = true,</span><br><span class="line">    [&quot; ゝ &quot;] = true,</span><br><span class="line">    [&quot; ゞ &quot;] = true,</span><br><span class="line">    [&quot;々&quot;] = true,</span><br><span class="line">    [&quot;’&quot;] = true,</span><br><span class="line">    [&quot;”&quot;] = true,</span><br><span class="line">    [&quot;）&quot;] = true,</span><br><span class="line">    [&quot;〕&quot;] = true,</span><br><span class="line">    [&quot;］&quot;] = true,</span><br><span class="line">    [&quot;｝&quot;] = true,</span><br><span class="line">    [&quot;〉&quot;] = true,</span><br><span class="line">    [&quot;》&quot;] = true,</span><br><span class="line">    [&quot;」&quot;] = true,</span><br><span class="line">    [&quot;』&quot;] = true,</span><br><span class="line">    [&quot;】&quot;] = true,</span><br><span class="line">    [&quot;°&quot;] = true,</span><br><span class="line">    [&quot;′&quot;] = true,</span><br><span class="line">    [&quot;″&quot;] = true,</span><br><span class="line">    [&quot;℃&quot;] = true,</span><br><span class="line">    [&quot;￠&quot;] = true,</span><br><span class="line">    [&quot;％&quot;] = true,</span><br><span class="line">    [&quot;‰&quot;] = true,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">function isKinsoku(ch)</span><br><span class="line">&#123;</span><br><span class="line">    return ch in kinsokuText;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着往下看 <code>obj</code> 为 <code>null</code> 会被如何处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">if (obj == null) &#123;</span><br><span class="line">    // シナリオ終了</span><br><span class="line">    //dm(&quot; シナリオ終了 cur:&quot; + curStorage + &quot; next:&quot; + nextStorage) ;</span><br><span class="line">    local next = nextStorage;</span><br><span class="line">    if (next == null || next == 0) &#123;</span><br><span class="line">        next = getNextScene(curStorage);</span><br><span class="line">    &#125;                    </span><br><span class="line">    dm(&quot;next:&quot; + next);</span><br><span class="line">    if (next != null &amp;&amp; next != &quot;&quot; &amp;&amp; next != 0) &#123;</span><br><span class="line">        goToNext(next);</span><br><span class="line">        continue;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        status = STOP;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据注释，如果 <code>obj</code> 为 <code>null</code>，那么代表剧本结束，进入下一个场景，因此当需要播放声音时，<code>obj</code> 不应该为 <code>null</code>。在往下看 obj 如何被处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">if (obj.tagname == &quot;label&quot;) &#123; // ラベル処理</span><br><span class="line">    // ...</span><br><span class="line">&#125; else if (obj.tagname == &quot;begintrans&quot;) &#123;</span><br><span class="line">    // ...</span><br><span class="line">&#125; else if (obj.tagname == &quot;ch&quot;) &#123;</span><br><span class="line">    doText(obj.text);</span><br><span class="line">    continue;</span><br><span class="line">&#125; else if (obj.tagname == &quot;embex&quot;) &#123; // 変数埋め込みの参照</span><br><span class="line">    if (&quot;exp&quot; in obj) &#123;</span><br><span class="line">        local text = ::eval(obj.exp);</span><br><span class="line">        if (typeof text == &quot;string&quot;) &#123;</span><br><span class="line">            doText(text);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    continue;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    // その他のコマンド</span><br><span class="line">    </span><br><span class="line">    // 実行時判定される cond</span><br><span class="line">    if (&quot;condex&quot; in obj) &#123;</span><br><span class="line">        if (!::eval(obj.condex)) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        //delete obj.condex;</span><br><span class="line">    &#125; else if (&quot;if&quot; in obj) &#123;</span><br><span class="line">        if (!::eval(obj[&quot;if&quot;])) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        //delete obj[&quot;if&quot;];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // onTag を呼ぶ</span><br><span class="line">    local step = onTag(obj);</span><br><span class="line">    if (step == null) &#123;</span><br><span class="line">        throw &quot;onTag が null を返しました (&quot; + obj.tagname + &quot;)&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    step = step.tointeger(); // step を数値に</span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后在调用 <code>onTag</code> 前并没有生成新的 <code>obj</code>，那么到此为止生成的 <code>obj</code> 只是为了处理 <code>currentText</code> 开头的标点，则其他的 <code>obj</code> 只能来自类的静态变量 <code>pendings</code> 队列或者 <code>lines</code> 数组。首先看看 <code>pendings</code> 从哪里来</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * タグ割り込み処理</span><br><span class="line"> */</span><br><span class="line">function addTag(name, elm) &#123;</span><br><span class="line">    local e;</span><br><span class="line">    if (elm != null) &#123;</span><br><span class="line">        e = clone elm;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        e = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    if (name != null) &#123;</span><br><span class="line">        e.tagname &lt;- name;</span><br><span class="line">    &#125;</span><br><span class="line">    pendings.append(e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * タグ割り込み処理</span><br><span class="line"> */</span><br><span class="line">function insertTag(name, elm) &#123;</span><br><span class="line">    local e;</span><br><span class="line">    if (elm != null) &#123;</span><br><span class="line">        e = clone elm;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        e = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    if (name != null) &#123;</span><br><span class="line">        e.tagname &lt;- name;</span><br><span class="line">    &#125;</span><br><span class="line">    pendings.insert(0, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>run</code> 循环中的 <code>pendings</code> 主要添加的是已有的 <code>obj</code>，因此 <code>pendings</code> 的其他值只能通过函数 <code>addTag</code> 以及 <code>insertTag</code> 添加。这两个函数都会添加一个 <code>elm</code>，也就是 <code>obj</code>，并且将 <code>name</code> 作为 <code>tagname</code>，所以接下来找找哪些地方调用了这些函数。</p>
<p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/19.jpg" alt="Not Found"></p>
<p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/20.jpg" alt="Not Found"></p>
<p>很可惜，在所有的搜索结果中，没有找到调用 <code>entryvoice</code> 以及 <code>dispname</code> 的代码，因此 <code>pendings</code> 并不是我们的目标，那么来看看 <code>lines</code>。</p>
<p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/21.jpg" alt="Not Found"></p>
<p><code>lines</code>并没有写值操作，但是有赋值操作 <code>lines = getScene(curStorage)</code>，都是在 <code>28_43000_d330.nut</code> 中.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 実行開始</span><br><span class="line"> * @param storage 開始シナリオ</span><br><span class="line"> * @param option パース用オプション</span><br><span class="line"> */</span><br><span class="line">function start(storage) &#123;</span><br><span class="line">    dm(&quot; シーン再生開始 &quot;);</span><br><span class="line">    clearForStart();</span><br><span class="line">    curStorage = storage;</span><br><span class="line">    lines = getScene(curStorage);</span><br><span class="line">    </span><br><span class="line">    prevSkipMode = null;</span><br><span class="line">    currentText = &quot;&quot;;</span><br><span class="line">    status = RUN;</span><br><span class="line">    // 初期変数保存</span><br><span class="line">    savef = clone f;</span><br><span class="line">    savePrepare();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * ロード処理</span><br><span class="line"> * ゲーム変数からシナリオ状態変数を読み込んでから実行開始</span><br><span class="line"> */</span><br><span class="line">function load() &#123;</span><br><span class="line">    dm(&quot; シーンロード開始 &quot;);</span><br><span class="line">    clearForStart();</span><br><span class="line">    </span><br><span class="line">    if (savef.storage != &quot;&quot;) &#123;</span><br><span class="line">        dm(&quot; ロード対象:&quot; + savef.storage);</span><br><span class="line">        dm(&quot; ロードまでの分岐数:&quot; + savef.branchCount);</span><br><span class="line">        dm(&quot; ロード先:&quot; + savef.targetPage);</span><br><span class="line">        curStorage = savef.storage;</span><br><span class="line">        lines = getScene(curStorage);</span><br><span class="line">        if (lines == null) &#123;</span><br><span class="line">            dm(&quot; ロード失敗 &quot;);</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        // 分岐情報復帰</span><br><span class="line">        for (local i=0;i&lt;savef.branchCount;i++) &#123;</span><br><span class="line">            targetBranches.append(savef[&quot;branch&quot;+i]);</span><br><span class="line">            //dm(&quot; 分岐:&quot; + savef[&quot;branch&quot;+i]);</span><br><span class="line">        &#125;</span><br><span class="line">        // ページ番号復帰</span><br><span class="line">        targetPage = savef.targetPage;</span><br><span class="line">        // 変数復帰</span><br><span class="line">        f = clone savef;</span><br><span class="line">        // 時間復帰</span><br><span class="line">        currentTick = savef.time;</span><br><span class="line">        prevSkipMode = null;</span><br><span class="line">        currentText = &quot;&quot;;</span><br><span class="line">        status = RUN;</span><br><span class="line">        return true;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        dm(&quot; ロード失敗 &quot;);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 次のシナリオに接続</span><br><span class="line"> */</span><br><span class="line">function goToNext(next) &#123;</span><br><span class="line">    clearInfo();</span><br><span class="line">    curStorage = next;</span><br><span class="line">    lines = getScene(curStorage);</span><br><span class="line">    savef = clone f;</span><br><span class="line">    savePrepare();</span><br><span class="line">    status = RUN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据这三个函数名以及注释，连蒙带猜可能 <code>lines</code> 在每次加载新场景时，该场景内部所有的对话被 <code>getScene</code> 统一读入 <code>lines</code> 中。看看位于同一文件的 <code>getScene</code> 函数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * シーンファイルを変換してデータとして取得する</span><br><span class="line"> * @param name シーン名</span><br><span class="line"> */</span><br><span class="line">function getScene(name) &#123;</span><br><span class="line">    // グローバルのシーン取得関数を使う</span><br><span class="line">    try &#123; </span><br><span class="line">        return ::getScene(name)();</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">        dm(&quot;error in loading:&quot; + e);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数 <code>name</code> 是场景名，很有可能是字符串。根据注释“转换场景文件作为数据获取”，证明我们的猜测可能是正确的。在 <code>Squirrel</code> 中函数或变量名前的 <code>::</code> 代表调用的全局空间的函数而不是类函数，因此调用的是全局空间的同名函数。该全局函数返回值也是一个可调用的对象，可能也是回调函数。</p>
<blockquote>
<p>Global variables are stored in a table called the root table. Usually in the global scope the environment object is the root table, but to explicitly access the closure root of the function from another scope, the slot name must be prefixed with ‘::’</p>
</blockquote>
<p>然而在所有的明文脚本代码中并没有找到任何全局 <code>getScene</code> 的定义。很明显这个函数不是标准库函数，实际上脚本中出现了不少类似调用没有定义的函数，例如前文的 <code>Talk</code>，这类函数甚至在字节码中也找不到符号，推测这些函数可能定义在二进制程序中，测试一下</p>
<p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/22.jpg" alt="Not Found"></p>
<p>果然，在游戏主程序 <code>SLPS_258.97</code> 中，除了调用字符串，还出现了单独的符号，那么接下来就是针对 32 位 MIPS 程序 <code>SLPS_258.97</code> 的逆向，不过还是得先看看剩下的几个 <code>.cnut</code> 字节码文件里有没有值得关注的信息，首先需要想办法反编译 <code>.cnt</code>。</p>
<h1 id="字节码反编译"><a href="# 字节码反编译" class="headerlink" title="字节码反编译"></a>字节码反编译 </h1><p> 对于反编译来说，Squirrel 是一个比较坑的语言，兼容性极差，甚至每个小版本的字节码都不一样，并且 <code>.cnut</code> 文件中没有标注是哪个版本的 Squirrel，因此反编译及其困难。</p>
<p>目前已经有的针对 Squirrel 的反编译器主要有以下 3 个：</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://www.mediafire.com/?ruulm32z36i5dff">NutCracker - DamianXVI</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/darknesswind/NutCracker">NutCracker - darknesswind</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/SydMontague/NutCracker">NutCracker - SydMontague</a></li>
</ol>
<p>其中的 2 和 3 都是基于 1 的改进，而 1 最初来源 <a target="_blank" rel="noopener" href="http://cheatengine.org/forum/viewtopic.php?p=5477214&sid=00a71666ea27fea14168c6d158f69724">CE 论坛</a>，仅支持 32 位的 Squirrel 2.2.4，不支持 unicode 编码。而 2 基于 1 实现了同版本 64 位的反编译，3 基于 1 实现了针对 Squirrel3 的反编译，同时支持 unicode 编码，此外还提供了一个 010 Editor 的模版供分析。很明显，在这个上古游戏的时代必不可能用 Squirrel3 开发，因此只能是 Squirrel2 的某个版本。查看一下 Squirrel2 的<a target="_blank" rel="noopener" href="https://sourceforge.net/projects/squirrel/files/squirrel2/"> 历史版本</a>，主要有以下 15 个稳定版本：<code>2.0</code>，<code>2.0.[1-5]</code>，<code>2.1</code>，<code>2.1.[1-2]</code>，<code>2.2</code>，<code>2.2.[1-5]</code>。</p>
<p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/31.jpg" alt="Not Found"></p>
<p>以上 3 个工具反编译我们提取出的字节码全部失败，那么我们就需要自己魔改其中的一个，由于 3 提供了 010 的模版，因此先用 3 来验证一下我们提取出的字节码是哪个版本。由于明文脚本中使用了大量双字节日语，因此为了避免干扰我们的分析，我们找一个最小的，没有出现日文的 <code>41_e2000_36f.nut</code> 用 010 分析一下。</p>
<p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/29.jpg" alt="Not Found"></p>
<p>不出意外，果然失败了，先分析一下为什么失败。模版是针对 Squirrel3 的字节码，因此看看模版里定义的结构和我们的文件有什么不同。</p>
<p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/30.jpg" alt="Not Found"></p>
<p>首先是 2 个字节的 <code>fafa</code>，然后是 4 个字节的 <code>RIQS</code>，然后是 4 个字节的 <code>sizeChar</code>，但是在模版中接下来就是用于分片的 <code>TRAP</code>，少了 <code>sizeInt</code> 以及 <code>sizeFloat</code>。考虑到这个游戏的发行年份，我们找一个 Squirrel 2.2.4 的源码分析一下 Squirrel 2 的 <code>.cnut</code> 字节码结构是什么样的。</p>
<p>首先找找字节码文件头 <code>0xfafa</code> 的定义，在 <code>squirrel/sqapi.cpp</code> 中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SQ_BYTECODE_STREAM_TAG    0xFAFA</span></span><br></pre></td></tr></table></figure>

<p>然后找找 <code>SQ_BYTECODE_STREAM_TAG</code> 的引用。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SQRESULT <span class="title">sq_readclosure</span><span class="params">(HSQUIRRELVM v,SQREADFUNC r,SQUserPointer up)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SQObjectPtr closure;</span><br><span class="line">    </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> tag;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">r</span>(up,&amp;tag,<span class="number">2</span>) != <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sq_throwerror</span>(v,_SC(<span class="string">&quot;io error&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span>(tag != SQ_BYTECODE_STREAM_TAG)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sq_throwerror</span>(v,_SC(<span class="string">&quot;invalid stream&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span>(!SQClosure::<span class="built_in">Load</span>(v,up,r,closure))</span><br><span class="line">        <span class="keyword">return</span> SQ_ERROR;</span><br><span class="line">    v-&gt;<span class="built_in">Push</span>(closure);</span><br><span class="line">    <span class="keyword">return</span> SQ_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>检查完文件头后进入 <code>squirrel/sqobject.cpp</code> 的 <code>SQClosure::Load</code> 加载字节码文件</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">SQClosure::Load</span><span class="params">(SQVM *v,SQUserPointer up,SQREADFUNC read,SQObjectPtr &amp;ret)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_HEAD));</span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,<span class="built_in">sizeof</span>(SQChar)));</span><br><span class="line">    SQObjectPtr func;</span><br><span class="line">    _CHECK_IO(SQFunctionProto::<span class="built_in">Load</span>(v,up,read,func));</span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_TAIL));</span><br><span class="line">    ret = SQClosure::<span class="built_in">Create</span>(_ss(v),_funcproto(func));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SQ_CLOSURESTREAM_HEAD</code> 就是小端的 <code>SQIR</code>，检查完后读取 4 个字节的 <code>sizeof(SQChar)</code>，因此在 Squirrel2 中没有 <code>sizeInt</code> 以及 <code>sizeFloat</code>，读取完后进入 <code>SQFunctionProto::Load</code>，看名字应该是读函数。那么我们先修改模版，注释掉 <code>NutHeader</code> 的 <code>sizeInt</code> 以及 <code>sizeFloat</code> 看看解析结果。</p>
<p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/32.jpg" alt="Not Found"></p>
<p>果然又失败了，看看报错原因发现是没有匹配到 <code>TRAP</code>，那么代表肯定在模版中多了几个字节。</p>
<p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/33.jpg" alt="Not Found"></p>
<p>通过核对数据，发现这里匹配失败，<code>TRAP</code> 被解析成了 <code>nFunctions</code>，那么再看看模版中 <code>NutFunction</code> 结构。</p>
<p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/34.jpg" alt="Not Found"></p>
<p>其中的 <code>ConfirmOnPart</code> 就是读取 4 个字节检查是否是 <code>TRAP</code>。很明显，<code>nFunctions</code>前面多了 4 个字节才导致识别错位到下一个 <code>TRAP</code>，继续看看 <code>Squirrel 2.2.4</code> 的源码中定义的结构。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">SQFunctionProto::Load</span><span class="params">(SQVM *v,SQUserPointer up,SQREADFUNC read,SQObjectPtr &amp;ret)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SQInteger i, nliterals,nparameters;</span><br><span class="line">    SQInteger noutervalues ,nlocalvarinfos ;</span><br><span class="line">    SQInteger nlineinfos,ninstructions ,nfunctions,ndefaultparams ;</span><br><span class="line">    SQObjectPtr sourcename, name;</span><br><span class="line">    SQObjectPtr o;</span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_PART));</span><br><span class="line">    _CHECK_IO(<span class="built_in">ReadObject</span>(v, up, read, sourcename));</span><br><span class="line">    _CHECK_IO(<span class="built_in">ReadObject</span>(v, up, read, name));</span><br><span class="line">    </span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_PART));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nliterals, <span class="built_in">sizeof</span>(nliterals)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nparameters, <span class="built_in">sizeof</span>(nparameters)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;noutervalues, <span class="built_in">sizeof</span>(noutervalues)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nlocalvarinfos, <span class="built_in">sizeof</span>(nlocalvarinfos)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nlineinfos, <span class="built_in">sizeof</span>(nlineinfos)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;ndefaultparams, <span class="built_in">sizeof</span>(ndefaultparams)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;ninstructions, <span class="built_in">sizeof</span>(ninstructions)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nfunctions, <span class="built_in">sizeof</span>(nfunctions)));</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现这里的结构和模版中一样，那么可以证明我们需要的 Squirrel2 版本一定小于 2.2.4，可以进一步缩小我们的目标范围。那么继续分析 2.2.4 之前的版本，最后在 2.1.2 中发现缺少了 <code>ndefaultparams</code>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">SQFunctionProto::Load</span><span class="params">(SQVM *v,SQUserPointer up,SQREADFUNC read,SQObjectPtr &amp;ret)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SQInteger i, nliterals,nparameters;</span><br><span class="line">    SQInteger noutervalues ,nlocalvarinfos ;</span><br><span class="line">    SQInteger nlineinfos,ninstructions ,nfunctions ;</span><br><span class="line">    SQObjectPtr sourcename, name;</span><br><span class="line">    SQObjectPtr o;</span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_PART));</span><br><span class="line">    _CHECK_IO(<span class="built_in">ReadObject</span>(v, up, read, sourcename));</span><br><span class="line">    _CHECK_IO(<span class="built_in">ReadObject</span>(v, up, read, name));</span><br><span class="line">    </span><br><span class="line">    _CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_PART));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nliterals, <span class="built_in">sizeof</span>(nliterals)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nparameters, <span class="built_in">sizeof</span>(nparameters)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;noutervalues, <span class="built_in">sizeof</span>(noutervalues)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nlocalvarinfos, <span class="built_in">sizeof</span>(nlocalvarinfos)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nlineinfos, <span class="built_in">sizeof</span>(nlineinfos)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;ninstructions, <span class="built_in">sizeof</span>(ninstructions)));</span><br><span class="line">    _CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;nfunctions, <span class="built_in">sizeof</span>(nfunctions)));</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 010 的模版中注释掉下面的代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> nDefaultParams</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> (!ConfirmOnPart()) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">if</span> (nDefaultParams)</span><br><span class="line">    DefaultParams <span class="title function_">m_DefaultParams</span><span class="params">(nDefaultParams)</span>;</span><br></pre></td></tr></table></figure>

<p>继续运行模版，报了新的错</p>
<p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/35.jpg" alt="Not Found"></p>
<p>这次是模版本身报错，原因是文件解析完毕后没有找到最后的 <code>LIAT</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NutEnd</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> magicTAIL[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">if</span> (magicTAIL != <span class="string">&quot;LIAT&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Warning(<span class="string">&quot;Confirm End Failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>验证一下，果然把文件中最后的 <code>LIAT</code> 解析成了 <code>m_VarParams</code>。</p>
<p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/36.jpg" alt="Not Found"></p>
<p>既然没有报 <code>TRAP</code> 的错，那么就表示在 <code>nFunctions</code> 后出现了问题，看一下模版，在 <code>nFunctions</code> 后主要有三个数据</p>
<p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/37.jpg" alt="Not Found"></p>
<p>还是再回到 Squirrel 2.1.2 的源码中，看看结构最后是不是有这三个数据。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">_CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_PART));</span><br><span class="line">_CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, f-&gt;_instructions, <span class="built_in">sizeof</span>(SQInstruction)*ninstructions));</span><br><span class="line"></span><br><span class="line">_CHECK_IO(<span class="built_in">CheckTag</span>(v,read,up,SQ_CLOSURESTREAM_PART));</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nfunctions; i++)&#123;</span><br><span class="line">    _CHECK_IO(_funcproto(o)-&gt;<span class="built_in">Load</span>(v, up, read, o));</span><br><span class="line">    f-&gt;_functions[i] = o;</span><br><span class="line">&#125;</span><br><span class="line">_CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;f-&gt;_stacksize, <span class="built_in">sizeof</span>(f-&gt;_stacksize)));</span><br><span class="line">_CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;f-&gt;_bgenerator, <span class="built_in">sizeof</span>(f-&gt;_bgenerator)));</span><br><span class="line">_CHECK_IO(<span class="built_in">SafeRead</span>(v,read,up, &amp;f-&gt;_varparams, <span class="built_in">sizeof</span>(f-&gt;_varparams)));</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>居然都有，那么再看看这三个数据的大小。在 <code>squirrel/sqfuncproto.h</code> 中找到这三个数据的定义</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SQInteger _stacksize;</span><br><span class="line"><span class="type">bool</span> _bgenerator;</span><br><span class="line"><span class="type">bool</span> _varparams;</span><br></pre></td></tr></table></figure>

<p>这时候就看出来问题了，在模版中最后的 <code>m_VarParams</code> 是 4 个字节的 int，但是在源码中却是 1 个字节的 bool，修改模版将 <code>int m_VarParams</code> 改成 <code>char m_VarParams</code> 后再次运行，这次就执行成功了，代表我们的修改全部都是正确的，并且 Squirrel 的版本一定小于等于 2.1.2。</p>
<p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/38.jpg" alt="Not Found"></p>
<p>确定了大致的版本以后，由于版本 2.1.2 太过古老，我们先尝试修改第一个最初的 <a target="_blank" rel="noopener" href="http://www.mediafire.com/?ruulm32z36i5dff">NutCracker - DamianXVI</a> 来使其兼容 Squirrel 2.1.2，NutCracker 用 Visual Studio 开发，为了避免不必要的麻烦还是在 VS 下编辑运行最好，同时需要在项目 - 属性里设置 Windows SDK 版本以及平台工具集。</p>
<p>首先按照我们在 010 模版中修改的步骤，在 NutCracker 修改文件格式相关的代码。在 <code>nutcracker/NutScript.cpp</code> 的 <code>NutFunction::Load</code> 中注释以下代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="type">int</span> nDefaultParams = reader.<span class="built_in">ReadInt32</span>();</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">reader.<span class="built_in">ConfirmOnPart</span>();</span><br><span class="line"></span><br><span class="line">m_DefaultParams.<span class="built_in">resize</span>(nDefaultParams);</span><br><span class="line"><span class="keyword">if</span> (nDefaultParams)</span><br><span class="line">&#123;</span><br><span class="line">    reader.<span class="built_in">Read</span>(&amp;(m_DefaultParams.<span class="built_in">at</span>(<span class="number">0</span>)), nDefaultParams * <span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>之后编译运行一下是否可以反编译。</p>
<p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/40.jpg" alt="Not Found"></p>
<p>反编译成功，但是缺点是不支持类似 Shift-JIS 的双字节编码</p>
<p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/41.jpg" alt="Not Found"></p>
<p>写个脚本转换一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># =======================================================</span></span><br><span class="line"><span class="comment"># Author: Srpopty</span></span><br><span class="line"><span class="comment"># Email: srpopty@outlook.com</span></span><br><span class="line"><span class="comment"># FileName: transfor.py</span></span><br><span class="line"><span class="comment"># Description:</span></span><br><span class="line"><span class="comment">#   Convert string in double qoute to ja_jp.shiftjis.</span></span><br><span class="line"><span class="comment"># ========================================================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line"></span><br><span class="line">    invisible = [<span class="number">0</span>, <span class="number">0xFF</span>, <span class="number">0xFE</span>]</span><br><span class="line">    filename = filename.split(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">    ext = filename[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;&quot;</span>.join(filename[:-<span class="number">1</span>]) + <span class="string">&quot;_shiftjis.&quot;</span> + ext, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        length = <span class="built_in">len</span>(data)</span><br><span class="line">        <span class="keyword">while</span> i &lt; length:</span><br><span class="line">            c = data[i]</span><br><span class="line">            <span class="keyword">if</span> c <span class="keyword">not</span> <span class="keyword">in</span> invisible:</span><br><span class="line">                <span class="keyword">if</span> c == <span class="number">0x22</span>:</span><br><span class="line">                    j = i + <span class="number">1</span></span><br><span class="line">                    string = <span class="string">&quot;&quot;</span></span><br><span class="line">                    <span class="keyword">while</span> data[j] != <span class="number">0x22</span>:</span><br><span class="line">                        cc = data[j]</span><br><span class="line">                        <span class="keyword">if</span> cc <span class="keyword">not</span> <span class="keyword">in</span> invisible:</span><br><span class="line">                            string += <span class="built_in">chr</span>(cc)</span><br><span class="line">                        j += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&quot;\\x00&quot;</span> <span class="keyword">in</span> string:</span><br><span class="line">                        string = <span class="built_in">eval</span>(</span><br><span class="line">                            <span class="string">&#x27;b&quot;&#x27;</span> + string.replace(<span class="string">&quot;\\x00&quot;</span>, <span class="string">&quot;\\x&quot;</span>) + <span class="string">&#x27;&quot;&#x27;</span></span><br><span class="line">                        ).decode(<span class="string">&quot;shift-jis&quot;</span>)</span><br><span class="line">                        string = string.replace(<span class="string">&quot;\r&quot;</span>, <span class="string">&quot;\\r&quot;</span>).replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;\\n&quot;</span>)</span><br><span class="line">                    f.write(<span class="string">b&#x27;&quot;%s&quot;&#x27;</span> % string.encode())</span><br><span class="line">                    i = j</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    f.write(<span class="built_in">chr</span>(c).encode())</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main(sys.argv[<span class="number">1</span>])</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>批量转换</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> 3[2-9]*.nut | xargs -I &#123;&#125; python3 ./transfor.py &#123;&#125;</span><br><span class="line">python3 ./transfor.py 41.nut</span><br></pre></td></tr></table></figure>

<p>最后终于正确反编译了全部 10 个 <code>.cnut</code></p>
<p><img src="/2023/06/12/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%B8%89%EF%BC%89/42.jpg" alt="Not Found"></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ReverseEngineering/" rel="tag"># ReverseEngineering</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/06/11/%E6%9F%90%E4%B8%8A%E5%8F%A4PS2%E6%B8%B8%E6%88%8F%E9%80%86%E5%90%91%EF%BC%88%E4%BA%8C%EF%BC%89/" rel="prev" title="某上古 PS2 游戏逆向（二）音频分析">
      <i class="fa fa-chevron-left"></i> 某上古 PS2 游戏逆向（二）音频分析
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%84%9A%E6%9C%AC%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">脚本代码分析 </span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E5%8F%8D%E7%BC%96%E8%AF%91"><span class="nav-number">2.</span> <span class="nav-text">字节码反编译 </span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Srpopty</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">45</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Srpopty" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Srpopty" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:srpopty@outlook.com" title="E-Mail → mailto:srpopty@outlook.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Srpopty</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'fb9b672afa74e328fbe8',
      clientSecret: '7b3efe103d7e694008b943a67e5273ad36ee14a0',
      repo        : 'srpopty.github.io',
      owner       : 'Srpopty',
      admin       : ['Srpopty'],
      id          : '41f1d65c19f615d8d2faa07fb95459e6',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</body>
</html>
